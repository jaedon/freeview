(function e$$0(S,ba,t){function f(A,b){if(!ba[A]){if(!S[A]){var e="function"==typeof require&&require;if(!b&&e)return e(A,!0);if(z)return z(A,!0);e=Error("Cannot find module '"+A+"'");throw e.code="MODULE_NOT_FOUND",e;}e=ba[A]={exports:{}};S[A][0].call(e.exports,function(a){var b=S[A][1][a];return f(b?b:a)},e,e.exports,e$$0,S,ba,t)}return ba[A].exports}for(var z="function"==typeof require&&require,A=0;A<t.length;A++)f(t[A]);return f})({1:[function(D,S,ba){(function(){(function(){this.setTimeout||
(this.setTimeout=function(t,f){return nrdp.gibbon.setTimeout(t,f||0)});this.clearTimeout||(this.clearTimeout=function(t){nrdp.gibbon.clearTimeout(t)});this.setInterval||(this.setInterval=function(t,f){return nrdp.gibbon.setTimeout(t,f||0,!1)});this.clearInterval||(this.clearInterval=function(t){nrdp.gibbon.clearTimeout(t)})})();nrdp.js={};nrdp.js.init=function(t){t&&t()}})();(function(){function t(a){this.name="NasVerifyFailedError";this.message=a}function f(){nrdp.boot||(nrdp.boot={addEventListener:function(a,
b){nrdp._addEventListener(this,a,b)},removeEventListener:function(a,b){nrdp._removeEventListener(this,a,b)},sendBIEPNotification:function(a){nrdp._callEventListeners(this,{type:"appreloadfailed",errorparams:a})},makeAppbootRequest:a})}function z(){if(!(ca||nrdp.storage.transientData||T)){var a=nrdp.device,b={appid:nrdp.log.appid,nrdlib_version:""+a.SDKVersion.components.nrdlib,nrdapp_version:""+a.SDKVersion.components.nrdapp,mdxlib_version:""+a.SDKVersion.components.mdxlib,sdk_version:""+a.SDKVersion.components.sdk,
timeElapsed:""+(nrdp.mono()-nrdp.started)},a=a.startupTags;if(w.isObject(a))for(var e in a)a.hasOwnProperty(e)&&(b[e]=a[e]);nrdp.log.info("","BOOT","startup",b,!0,!0)}}function A(a){var b=ja||nrdp.options.appboot_url;"/"!=b[b.length-1]&&(b+="/");a&&(b+=encodeURIComponent(nrdp.device.ESNPrefix));return b}function xa(a){var b,e={},c=va.appboot_extra_params;e.url=a.url;if(!e.url)throw Error('"ui" element is missing "url"');nrdp.options.ui_request&&nrdp.options.ui_request.url?(e.url=nrdp.options.ui_request.url,
e.headers=nrdp.options.ui_request.headers):nrdp.options.ui_url?e.url=nrdp.options.ui_url:(b=a.hashvalue||"",a=a.hashalgorithm||"",0!==b.length&&0!==a.length&&"xasfa43r23552"!=b&&(e.headers={"X-Gibbon-Hash":a+"="+b}));c&&(e.url+=(0<e.url.indexOf("?")?"&":"?")+decodeURIComponent(c));return e}function b(a){return a&&200<=a.statusCode&&300>a.statusCode&&a.data&&(a.data.byteLength||/^file:/.test(a.finalURL))}function e(a){var b,e=nrdp.started,c=nrdp.device.SDKVersion.components.platform,f,z,aa,A;try{w.isArray(a)?
(b=a.filter(function(a){return a.sendtoichnaea}),0===b.length?O.info("No critical messages to send to Ichnaea"):(O.trace("Have "+b.length+" message(s) for Ichnaea: "+JSON.stringify(b)),f=b.map(function(a){try{return{version:a.platformVersion,elapsedTime:a.monotime-(a.basemonotime||e),msg:a.msg,tags:a.tags}}catch(b){return{msg:"Failed to construct milestone: "+(b.toString?b.toString():b)}}}),z=JSON.stringify({events:[{name:"nrdp",data:{source:"netflixApp",type:"milestone",esn:nrdp.device.ESN,platformVersion:c.platformVersion,
softwareVersion:nrdp.device.softwareVersion,elapsedTime:nrdp.mono()-e,appid:nrdp.log.appid,milestones:f}}]}),O.trace("Sending to Ichnaea: "+z),A=va.appboot_milestone_timeout,aa={url:va.appboot_milestone_url,headers:{"X-Netflix.Ichnaea.Request.Type":"IchnaeaRequest","X-Gibbon-Cache-Control":"no-cache"},body:z,async:!0,timeout:A},O.trace("Ichnaea request: "+JSON.stringify(aa)),nrdp.gibbon.load(aa,function(a){var c=a?a.statusCode:0;O.log("Ichnaea response: "+JSON.stringify(a));200<=c&&300>c&&(O.log("Ichnaea success, deleting "+
b.length+" critical message(s)"),nrdp.log.deleteCriticalMessages(b))}))):O.error("Critical messages are not an array : "+typeof a)}catch(p){O.error("Failed to send milestones to Ichnaea : "+p)}}function a(){function ba(b){var c=nrdp.storage;b&&(ja=b);ca++;c.removeItem(c.NO_DEVICE_ACCOUNT,"AppbootUserId");ca<=za?(b=1E3*ca,O.warn("Retrying AppBoot request in "+b+" ms..."),nrdp.gibbon.setTimeout(a,b)):(b=x.ERROR_DESCRIPTION,x.ERROR_DESCRIPTION=b?"Retry Count Exceeded, last error: "+b:"Retry Count Exceeded",
Ua(),x.ERROR_STAGE=0)}function Ua(){e(ea);W=ca=0;f();nrdp.js.options||(nrdp.js.options=va);Z&&!b(Z.response)&&(O.trace("Discarding previous SD"),Z=null);var a="http://localcontrol.netflix.com/js/error.js",c="?",G,z;z=nrdp.storage;var aa;aa=z.secureStoreSize;var K=z.getUsedSecureStoreSize(),E=aa-K;O.info("Secure store size = "+aa+" : used = "+K+" : free = "+E);5E3<=E?(aa=z.getItem(z.NO_DEVICE_ACCOUNT,"AppbootErrors")||[],aa.push({description:x.ERROR_DESCRIPTION,stage:x.ERROR_STAGE,appid:nrdp.log.appid,
clienttime:Date().toString(),url:A(!0)}),z.setItem(z.NO_DEVICE_ACCOUNT,"AppbootErrors",aa)):O.warn("Not enough storage left to save more errors  : secure store size = "+aa+" : used = "+K+" : free = "+E);x.ERROR_DESCRIPTION="Error loading UI";O.warn("Error parameters for BIEP:\n"+JSON.stringify(x,null,"  "));if(T)O.trace("Notifying BIEP"),nrdp.boot.sendBIEPNotification(x);else{T=!0;O.log("Loading BIEP");for(G in x)z=x[G],w.isString(z)&&(z=z.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/"/g,'\\"').replace(/\n/g,
"\\n")),a+=c+G+"="+encodeURIComponent(z),c="&";nrdp.gibbon.loadScript({url:a})}}function Ma(a,c){var e=a.url,w=a.headers;ua.attempt(function(){return a.response?a.response:(new ua(function(a){O.info("Starting UI download with:\nurl:        "+e+"\nheaders:    "+JSON.stringify(w)+"\nUI tries:   "+W+"\nAB retries: "+ca);++W;nrdp.gibbon.load({url:e,headers:w,format:"arraybuffer"},a)})).delay(va.appboot_ui_delay).then(function(a){var c;c="Finished UI download with:\nrequest url:  "+e+"\nresponse url: "+
a.url+"\nfinal url:    "+a.finalURL+"\nstate:        "+a.state+"\nstatus:       "+a.statusCode+"\nsource:       "+!!a.data+"\nUI tries:     "+W+"\nAB retries:   "+ca;b(a)?O.info(c):(O.warn(c),c={appid:nrdp.log.appid,url:e,errorCode:a.errorcode,errorGroup:a.errorGroup,nativeErrorCode:a.nativeerrorCode,serverIp:a.serverIp,statusCode:a.statusCode,retryCount:""+W,timeElapsed:""+(nrdp.mono()-nrdp.started)},nrdp.log.error("UI download failed","BOOT","networkerror",c,!0,!0));return a})}).then(function(a){return c?
c(a):a}).then(function(a){var c=!T;c&&va.appboot_no_reuse&&(c=!1);if(a){if(!b(a))throw a;W=ca=0;delete nrdp.js;delete nrdp.boot;nrdp._init=!1;var p=a.finalURL;e!=a.url&&(O.warn("Using request URL because finalURL points to a cached response"),p=e);O.info("Really, truly setting location now with reuse="+c+' to "'+p+'"');nrdp.gibbon.location={url:p,headers:w,source:a.data,reuse:c}}}).fail(function(a){if(6<=W+ca)throw O.warn("Maximum total retries exceeded, going to error page"),a;a=1E3*(ca+W);O.warn("Retrying UI download in "+
a+" ms...");setTimeout(function(){Ma({url:e,headers:w})},a)}).fail(function(a){x.ERROR_CATEGORY="Network";x.ERROR_DESCRIPTION="AppBoot client failed to download UI";x.ERROR_URL=a.url;x.ERROR_CODE=a.errorcode;x.ERROR_GROUP=a.errorgroup;x.NATIVE_ERROR_CODE=a.nativeerrorCode;x.ERROR_FRAME_URL=a.finalURL;x.SERVER_IP=a.serverIp;x.ERROR_STATUS_CODE=a.statusCode;Ua()})}function c(){var a;va.appboot_no_speculative_ui?O.trace("SD is turned off"):Z?O.trace("Already have an SD"):(a=nrdp.storage.getItem("s",
"appbootui"))?(Z=xa(a),O.trace("Beginning SD"),Ma(Z,function(a){if(Z)if(b(a)||Z.setLocation){if(O.trace("SD status code is "+a.statusCode),Z.response=a,Z.setLocation)return O.info("Now really setting location to SD data"),a}else O.warn("SD failed"),Z=null;else O.trace("SD finished but was discarded")})):O.trace("No previous URL found for SD")}var x={ERROR_CATEGORY:"AppBoot",ERROR_FRAME_URL:"",ERROR_DESCRIPTION:"",ERROR_STATUS_CODE:"",ERROR_GROUP:"",ERROR_CODE:"",NATIVE_ERROR_CODE:"",ERROR_URL:"",
ERROR_ACTIONID:"",ERROR_TEXT:"",ERROR_BCP47:"",ERROR_STAGE:""},ea=[],Na=[],ib=!1;O||(O=new Oa("BOOT","ui|gibbon"));O.trace("Making app boot request"+(T?" from BIEP":""));ua.attempt(function(){x.ERROR_STAGE=1;return new ua(function(a){nrdp.gibbon.init(a)})}).then(function(){var a=nrdp.storage;nrdp.gibbon._loadSplash(a.getItem("s","appsplash"));O.warn("BOOT version",D("./version")());va=D("./config-loader");za||(za=va.appboot_max_retries);c();x.ERROR_STAGE++;x.ERROR_FRAME_URL=nrdp.gibbon.location;try{delete a.transientData.appboot.msltruststore,
O.trace("Deleted previous MSL trust store")}catch(b){O.trace("No previous MSL trust store")}z();a=new ua(function(a){nrdp.log.addEventListener("criticalMsgsReady",function Aa(b){nrdp.log.removeEventListener("criticalMsgsReady",Aa);ea=b.data;O.trace("Got "+ea.length+" critical messages");a()});nrdp.log.getCriticalMessages()});return[S(va),a]}).all().spread(function(a){x.ERROR_STAGE++;var b=nrdp.device,c=nrdp.options,e=nrdp.storage,f=A(!0),z=!!f.match(/^https:/),E,aa=b.UILanguages,K={aid:nrdp.log.appid,
client_info:{certification_version:""+b.certificationVersion,nrdlib_version:""+b.SDKVersion.components.nrdlib,nrdapp_version:""+b.SDKVersion.components.nrdapp,mdxlib_version:""+b.SDKVersion.components.mdxlib,sdk_version:""+b.SDKVersion.components.nrdlib,sw_version:""+b.softwareVersion,languages:0>aa.indexOf(b.language)?aa.concat(b.language):aa},ui:{app:"gibbontvui",query_params:{dw:""+c.ui_width,dh:""+c.ui_height,dar:""+c.ui_aspect_ratio,reg:""+b.registered,q:""+nrdp.uiQueryString}}};0<nrdp.gibbon.location.indexOf("?")&&
nrdp.gibbon.location.replace(/[^?]*\?/,"").split("&").forEach(function(a){a&&(a=a.split("="),K.ui.query_params[a[0]]=1<a.length?decodeURIComponent(a[1]):!0)});c.appboot_params.split(/[&,]/).forEach(function(a){a&&(a=a.split("="),K.ui.query_params[a[0]]=1<a.length?decodeURIComponent(a[1]):!0)});K.ui.cookies=nrdp.gibbon.cookie.split("; ").map(function(a){return a.split("=")}).reduce(function(a,b){a[b[0]]=b[1];return a},{});c=nrdp.trustStoreHash||"";K.ssltruststore=0===c.length?{}:{hash:c};K.msltruststore=
{};c=nrdp.nova&&nrdp.nova.wiiu&&nrdp.nova.wiiu.nasToken;if(ib=!(!w.isString(c)||!c.length))O.log("NAS token is",c),K.nas_token=c;E=[];var t=nrdp.device.SDKVersion.components.platform,z={level:"info",type:"appboot",esn:b.ESN,appid:nrdp.log.appid,msg:"appboot request made "+(z?"with":"without")+" SSL",ssl:z,clienttime:Date().toString(),app_uptime:""+(nrdp.mono()-nrdp.started),retrycount:ca};if(t)for(var d in t)"string"===typeof d&&"string"===typeof t[d]&&(z[d]=t[d]);E.push(z);(e.getItem(e.NO_DEVICE_ACCOUNT,
"AppbootErrors")||[]).forEach(function(a){a={level:"error",type:"networkerror",esn:b.ESN,appid:a.appid,msg:"Appboot displayed BIEP",description:a.description,stage:a.stage,clienttime:a.clienttime,url:a.url,device:a.device};if(t)for(var c in t)"string"===typeof c&&"string"===typeof t[c]&&(a[c]=t[c]);E.push(a)});ea.forEach(function(a){if(a.sendtoappboot){O.log("Adding critical message to appboot logblob");if(t&&!a.sendtoichnaea)for(var b in t)"string"!==typeof b||"string"!==typeof t[b]||a[b]||(a[b]=
t[b]);a.sendtoichnaea&&"milestone"===a.logtype&&(a.type="milestone",a.level="info",a.tags&&a.tags.appid&&(a.appid=a.tags.appid));E.push(a);Na.push(a)}});O.log("criticalmessage length "+ea.length);K.log=E;K.responseparams="loglevel retrycontrol loginterval maxlogsize testdriveripaddr instrumentationparams".split(" ");O.log("Sending AppBoot request to "+f+"\n"+JSON.stringify(K,null," "));e=e.getItem(e.NO_DEVICE_ACCOUNT,"AppbootUserId")||null;O.log("making appboot request with userId "+e);return a.request(f,
e,JSON.stringify(K),2E4)}).then(function(a){x.ERROR_STAGE++;var b;b=nrdp.storage;var c=b.transientData||{};a=JSON.parse(nrdp.utf8toa(a.body));O.log("AppBoot response is\n"+JSON.stringify(a,null," "));c.appboot=a;b.transientData=c;b.removeItem(b.NO_DEVICE_ACCOUNT,"AppbootErrors");nrdp.log.deleteCriticalMessages(Na);ea=[];Na=[];if(b=a.error)switch(b.actionid){case 7:x.ERROR_DESCRIPTION="toplevel: Redirect to "+b.appbootendpoint;x.ERROR_ACTIONID=b.actionid;ba(b.appbootendpoint);break;case 2:x.ERROR_DESCRIPTION=
"toplevel: Error 2";x.ERROR_ACTIONID=b.actionid;ba();break;case 13:x.ERROR_ACTIONID=b.actionid;nrdp.device.factoryReset(function(){nrdp.log.error("appboot factory reset device due to actionid 13","BOOT","appboot",void 0,!0,!0);nrdp.gibbon.location=nrdp.bootURL});break;default:throw x.ERROR_ACTIONID=b.actionid,b.usertextgroup&&(x.ERROR_TEXT=b.usertextgroup.text,x.ERROR_BCP47=b.usertextgroup.bcp47),Error("AID "+b.actionid);}else{if(ib)if(va.appboot_fail_nas_verify&&(O.error("Synthetic failure of NAS token verification"),
a.nas_token_response={success:!1,reason:"Synthetic failure from command line"}),(b=a.nas_token_response)&&w.isObject(b)&&b.success)O.info("NAS token verified");else throw O.error("NAS token was not verified, response was",b),c=nrdp.nova&&nrdp.nova.wiiu&&nrdp.nova.wiiu.nasVerifyFailed,w.isFunction(c)&&c(),new t("Response was: "+JSON.stringify(b));return ua.attempt(function(){var b=a.servertime_seconds,c=Math.floor(nrdp.now()/1E3),e=Math.floor(Date.now()/1E3);w.isNumber(b)&&(O.info("AppBoot server time "+
b),O.info("nrdp.now            "+c+" : "+(c-b)),O.info("Date.now            "+e+" : "+(e-b)),nrdp.setServerTime(b))}).then(function(){var b=a.responseparams.loglevel,c=a.responseparams.testdriveripaddr,e=a.responseparams.instrumentationparams,f=a.responseparams.retrycontrol;w.isNumber(b)?nrdp.log.level=b:w.isString(b)&&(nrdp.log.level=nrdp.log.levels[b]);c&&nrdp.setTestDriverIpAddress(c);e&&nrdp.instrumentation.setParams(e.enabled,e.events);w.isNumber(f)&&(za=f)}).then(function(){var b,c=a.ssltruststore;
c&&((b=c.error)?O.error('AppBoot server returned an error for "ssltruststore" : '+JSON.stringify(b)):(O.info("Updating app trust store"),nrdp.setTrustStore(c.data)))}).then(function(){x.ERROR_STAGE++;var b;b=a.msltruststore;if(!b)throw Error('response is missing "msltruststore"');if(b=b.error)throw O.error('AppBoot server returned an error for "msltruststore" : '+JSON.stringify(b)),Error(JSON.stringify(b));O.info("Updating MSL trust store")}).then(function(){x.ERROR_STAGE++;var b,c;c=a.ui;if(!c)throw Error('"ui" element is missing from AppBoot response');
if(b=c.error){if(2==b){x.ERROR_DESCRIPTION="ui: Error 2";ba();return}throw Error('"ui" response includes an error : '+JSON.stringify(b));}b=xa(c);c.splash&&(nrdp.storage.setItem("s","appsplash",c.splash),delete c.splash);nrdp.storage.setItem("s","appbootui",c);Z&&b.url==Z.url?(O.trace("Remembered ui is the same, using SD data"),Z.response?(O.trace("SD is already complete, setting location now"),Ma(Z)):(O.trace("SD still in progress, deferring setting location"),Z.setLocation=!0)):(O.trace('Unusable SD data, loading UI from "'+
b.url+'"'),Ma(b))})}}).fail(function(a){var b,c=!1,e;e=a.cause?" (caused by "+a.cause.toString()+")":"";O.error("App boot failed:"+e,a);x.ERROR_DESCRIPTION=e;if(a instanceof da)x.ERROR_CATEGORY="Network",x.ERROR_DESCRIPTION=a.mesg,x.ERROR_URL=a.url,x.ERROR_CODE=a.errorCode,x.ERROR_GROUP=a.errorGroup,x.NATIVE_ERROR_CODE=a.nativeerrorCode,x.ERROR_FRAME_URL=a.finalUrl,x.SERVER_IP=a.serverIp,x.ERROR_STATUS_CODE=a.httpCode,(a.errorCode===nrdp.network.ERRORCODE.TIMEOUTERROR||"TIMED_OUT_ERROR"===a.mesg)&&
0<ca?O.warn("Second timeout - will not retry"):(b=A(),/^http:/.test(b)?(O.warn("Retrying using SSL"),c=!0,b=b.replace(/^http:/,"https:")):/^https:/.test(b)&&(O.warn("Retrying without SSL"),c=!0,b=b.replace(/^https:/,"http:")));else if(a instanceof aa)c=!0;else if(a instanceof ra)ca||(c=!0);else if(a instanceof ka&&a.error)switch(x.MSL_RESPONSE_CODE=a.error.responseCode,x.MSL_INTERNAL_CODE=a.error.internalCode,x.MSL_MESSAGE=a.error.message,a.error.responseCode){case K.TRANSIENT_FAILURE:c=!0}else if(a instanceof
t)return;c?ba(b):Ua()}).done()}var ua=D("nf-promise"),w=D("nf-underscore"),Oa=D("nf-console"),S=D("nf-gibbon-mslclient"),ra=S.TimeoutError,ka=S.MslException,aa=S.MslEncodingException,da=S.MslIoException,K=S.MslConstants$ResponseCode,ja,ca=0,Z,W=0,T=!1,za,O,va;t.prototype=Error();t.prototype.constructor=t;"object"==typeof application&&application&&application.isErrorPage?(T=!0,f()):a()})()},{"./config-loader":3,"./version":16,"nf-console":6,"nf-gibbon-mslclient":10,"nf-promise":12,"nf-underscore":13}],
2:[function(D,S,ba){S.exports={ase:[["ase","useJsAse"],!0],br:[["br","bladerunner"],!0],debug:["debug",function(){return!(!nrdp.debug&&!nrdp.log.haveTracing)}],tturl:["tturl",""],useLicenseCache:[["uselc","useLicenseCache"],!0],lc_use_std:["lc_use_std",!1],ldl_expiration_ms:[["ldl_expiration_ms","licenseCacheExpirationMs"],6E5],ldl_purge_percent:["ldl_purge_percent",25],manual_licenses:["manual_licenses",!1],std_license_force_ldl:["std_license_force_ldl",!1],std_license_delay:["std_license_delay",
0],check_instr:["check_instr",!1],nologcheck:["nologcheck",!1],hblog:["hblog",!1],usehc:[["usehc","useHeaderCache"],!1],usehcd:[["usehcd","useHeaderCacheData"],!1],brlogs:[["brlogs","bladerunner-logs"],!1],brping:[["brping","bladerunner-ping"],!1],logblob_post_url:["logblob_post_url",""],npticket_interval:["npticket_interval",144E5],nopbr:["nopbr",!1],log64:["log64",!1],nccp_post_url:["nccp_post_url",""],license_offset:["license_offset",0],swex:["swex",!1],awex:["awex",!1],noss:["noss",!1],trace_msl_requests:["trace_msl_requests",
!1],trace_msl_service_tokens:["trace_msl_service_tokens",!1],trace_msl_store:["trace_msl_store",!1],mslFallbackTimer:["mslFallbackTimer",!0],noverify:["noverify",!1],unauth:["unauth",!1],compress:["compress",""],nccp_version:["nccp_version","3.1"],nccp_url:["nccp_url",""],apiHost:["apiHost",""],appboot_key:["appboot_key",""],appboot_extra_params:["appboot_extra_params",""],appboot_milestone_timeout:["appboot_milestone_timeout",2E4],appboot_milestone_url:["appboot_milestone_url","http://ichnaea.netflix.com/log"],
appboot_ui_delay:["appboot_ui_delay",0],appboot_no_reuse:["appboot_no_reuse",!1],appboot_no_speculative_ui:["appboot_no_speculative_ui",!1],appboot_max_retries:["appboot_max_retries",5],appboot_fail_nas_verify:["appboot_fail_nas_verify",!1]}},{}],3:[function(D,S,ba){function t(){function b(a){var e=a.name;a=a.data;var z="streaming"===e,t=a&&a.configRestored,D=0;f.dump('NRDP "'+e+'" config changed',a);z&&(D+=A.set(a,!0,f),D+=A.override({haveStreamingConfig:!0},!1,f));D&&A.dump(f,!1);!t&&A.persistConfig&&
(t=nrdp.registration.currentDeviceAccount)&&(f.trace("Saving config for device account",t),z=nrdp.storage.getItem(t,"_config_")||{},z[e]=a,nrdp.storage.setItem(t,"_config_",z))}if(nrdp.registration){nrdp.registration.on("getConfigList",function(a){a=a.dak;var b=nrdp.storage.getItem(a,"_config_"),e;f.dump("Saved config for device account",a,"is",b);b?z.isObject(b)?A.persistConfig?z.each(b,function(a,b){a&&b&&z.isObject(a)&&z.isString(b)?(f.trace('Restoring saved config "'+b+'"'),a.configRestored=!0,
nrdp.setConfigData(b,a)):(f.log("Skipping bad entry in saved config"),e||(e="has a bad entry"))}):e="persistConfig is false":e="it is not an object":f.trace("No saved config");e&&(f.warn("Deleting saved config :",e),nrdp.storage.removeItem(a,"_config_"))});var a=nrdp.device.SDKVersion&&nrdp.device.SDKVersion.components&&nrdp.device.SDKVersion.components.nrdapp;if("string"===typeof a&&0===a.indexOf("2014.1")){f.warn("NRDAPP version is",a,': overriding nrdp.setConfigData because there is no "configChanged" event');
var t=nrdp.setConfigData.bind(nrdp);nrdp.setConfigData=function(a,f){t(a,f);b({name:a,data:f})}}else nrdp.addEventListener("configChanged",b)}}var f=new (D("nf-console"))("CONFIG"),z=D("nf-underscore"),A=D("nf-config"),xa=D("./command-line-options");A.declare({haveStreamingConfig:["haveStreamingConfig",!1],persistConfig:["persistConfig",!0],configRestored:["configRestored",!1]});var b;S.exports=function(){var e;if(b)return f.trace("Config loader already initialized"),A;if(nrdp.isReady){b=!0;A.declare(xa);
if(e=nrdp.options.js_opts)f.trace('Setting command-line overrides using : "'+e+'"'),A.override(e,!0,f);t();A.dump(f,!1);return A}f.fatal("Cannot initialize config when NRDP is not ready")}()},{"./command-line-options":2,"nf-config":5,"nf-console":6,"nf-underscore":13}],4:[function(D,S,ba){function t(){if(!A){A=!0;for(var f,b=z.length;b;){f=z;z=[];for(var e=-1;++e<b;)f[e]();b=z.length}A=!1}}function f(){}D=S.exports={};var z=[],A=!1;D.nextTick=function(f){z.push(f);A||setTimeout(t,0)};D.title="browser";
D.browser=!0;D.env={};D.argv=[];D.version="";D.versions={};D.on=f;D.addListener=f;D.once=f;D.off=f;D.removeListener=f;D.removeAllListeners=f;D.emit=f;D.binding=function(f){throw Error("process.binding is not supported");};D.cwd=function(){return"/"};D.chdir=function(f){throw Error("process.chdir is not supported");};D.umask=function(){return 0}},{}],5:[function(D,S,ba){function t(a){return a.split(",").reduce(function(a,b){var e=b.split("="),f=e[0],e=e.slice(1).join("=");f&&f.length&&(a[f]=e||!0);
return a},{})}function f(a){return a&&"object"===typeof a?JSON.stringify(a):"string"===typeof a?'"'+a+'"':""+a}function z(a,b,K){if("string"===typeof a)return z.call(this,t(a),b,K);var A=0;Object.keys(a).forEach(function(z){var t=Oa[z],D=a[z],T;if(t){if(T=jb[z]||ka[typeof e[t]])try{D=T(D)}catch(xa){K&&K.error("Failed to convert value '"+D+"' for config '"+z+"' : "+xa.toString());return}T=w[t];this[t]=D;w[t]!==T&&(K&&K.trace("Config changed for '"+z+"' from "+f(T)+" ("+typeof T+") to "+f(D)+" ("+typeof D+
")"),++A)}else b?(t=(t=ra[z])?t.filter(function(a){return a[0]!==this},this):[],t.push([this,D]),ra[z]=t):K&&K.error("Attempt to change undeclared config option '"+z+"'")},this);A&&w.emit("changed");return A}function A(){return Object.keys(Oa).reduce(function(a,b){var e=Oa[b],f=a[e];f?(f.push(b),a[e]=f.sort(function(a,b){return b.length-a.length})):a[e]=[b];return a},{})}function xa(a,b){return a.hasOwnProperty(b)?f(a[b]):void 0}function b(a,b){return"undefined"===typeof a?b:a}ba=D("nf-mixin");D=
D("nf-events").EventEmitter;var e={},a=Object.create(e),ua=Object.create(a),w=Object.create(ua),Oa={},jb={},ra={};w.declare=function(a){Object.keys(a).forEach(function(b){var f=a[b],w=f[0],t=f[1],A=f[2];if(e.hasOwnProperty(b))throw Error("The local configuraion key '"+b+"' is already in use");"string"===typeof w&&(w=[w]);w.forEach(function(a){var f;if(Oa.hasOwnProperty(a))throw Error("The configuration value '"+a+"' has been declared more than once");e.hasOwnProperty(b)||("function"===typeof t&&(t=
t()),e[b]=t);Oa[a]=b;"function"===typeof A&&(jb[a]=A);if(f=ra[a])f.forEach(function(b){var e=b[0],f={};f[a]=b[1];z.call(e,f,!1)}),delete ra[a]})});return w};var ka={object:function(a){return"object"==typeof a?a:JSON.parse(""+a)},"boolean":function(a){return"boolean"==typeof a?a:!("0"===""+a||"false"===(""+a).toLowerCase())},number:function(a){if("number"==typeof a)return a;a=parseFloat(""+a);if(isNaN(a))throw Error("parseFloat returned NaN");return a}};w.set=z.bind(a);w.override=z.bind(ua);w.dump=
function(z,t){function K(){W&&z&&z.log("===========================================")}var D=Object.keys(ra).sort(),S={},Z=A(),W;t=b(t,!0);Object.keys(Oa).sort().forEach(function(A){A=Oa[A];var D,O,ka;!S[A]&&(S[A]=!0,O=xa(a,A),ka=xa(ua,A),t||"undefined"!==typeof O||"undefined"!==typeof ka)&&(D=Z[A].join(","),D+=" = "+f(w[A])+" ("+typeof w[A]+") [",D+=b(ka,"<unset>")+",",D+=b(O,"<unset>")+",",D+=xa(e,A)+"]",W||(W=!0,z&&z.log("Current config values"),K()),z&&z.log(D))});(t||D.length)&&z&&z.log("<undeclared> :",
D);K()};w.persistent=function(){var b=A();return Object.getOwnPropertyNames(a).reduce(function(e,f){e[b[f][0]]=a[f];return e},{})};w._listeners={};ba(D,w);S.exports=Object.freeze(w)},{"nf-events":9,"nf-mixin":11}],6:[function(D,S,ba){function t(a,b){var e=[];return JSON.stringify(a,function(a,b){if("object"===typeof b&&null!==b){if(-1!==e.indexOf(b))return"<cycle>";e.push(b)}return b},b?" ":void 0)}function f(a,b,e){var f=b.length,z=a?""+a+" ":"",A=e?"":z,D;for(a=0;a<f;++a)if(D=b[a],a&&A.length&&
(A+=" "),"object"===typeof D)if(null===D)A+="null";else if(D instanceof Error)A+=D.toString()+(D.stack?"\n"+D.stack:"")+"\n";else try{A=e?A+("\n"+JSON.stringify(D,null,"  ")):A+JSON.stringify(D)}catch(xa){A=e?A+("\n"+t(D,!0)):A+t(D)}else A+=D;e&&(b=A.split("\n"),A="",b.forEach(function(a){A+=z+a+"\n"}));return A}function z(b,f,z,A){this._traceArea=b||"CONSOLE";this._logger=A||a||e;this._prefix=z;"function"===typeof this._logger.createArea&&(this._groups=f=f?f+"|nrdjs":"nrdjs",this._logger.createArea(this._traceArea,
f))}var A,xa=!1,b=!0;D=function(){};var e={info:D,warn:D,error:D,trace:D},a;"undefined"!==typeof nrdp&&(a={trace:nrdp.log.trace.bind(nrdp.log),log:nrdp.log.debug.bind(nrdp.log),info:nrdp.log.info.bind(nrdp.log),warn:nrdp.log.warn.bind(nrdp.log),error:nrdp.log.error.bind(nrdp.log),fatal:nrdp.log.fatal.bind(nrdp.log)},A=function(){!xa&&nrdp.isReady&&(xa=!0,b=nrdp.debug||nrdp.log.haveTracing,A=null)});z.setDebug=function(a){b=!!a;A=null};z.isDebug=function(){A&&A();return b};z.prototype.info=function(){this._logger.info(f(this._prefix,
arguments),this._traceArea)};z.prototype.error=function(){this._logger.error(f(this._prefix,arguments),this._traceArea)};z.prototype.warn=function(){this._logger.warn(f(this._prefix,arguments),this._traceArea)};z.prototype.trace=function(){A&&A();b&&this._logger.trace(f(this._prefix,arguments),this._traceArea)};z.prototype.log=function(){var a=this._logger;a.log&&(A&&A(),b&&a.log(f(this._prefix,arguments),this._traceArea))};z.prototype.debug=z.prototype.log;z.prototype.fatal=function(){var a=this._logger;
a.fatal&&a.fatal(f(this._prefix,arguments),this._traceArea)};z.prototype.dump=function(){A&&A();b&&this._logger.trace(f(this._prefix,arguments,!0),this._traceArea)};z.prototype.createSubConsole=function(a){return new z(this._traceArea,this._groups,this._prefix+a,this._logger)};S.exports=z},{}],7:[function(D,S,ba){function t(f,A){var t;if(void 0===A||"function"!==typeof A||"string"!==typeof f)throw new TypeError("EventEmitter: addEventListener requires a string and a function as arguments");if(void 0===
this._listeners)return this._listeners={},this._listeners[f]=[A],!0;t=this._listeners[f];return void 0===t?(this._listeners[f]=[A],!0):0>t.indexOf(A)?(t.push(A),!0):!1}function f(f,A){var t=this._listeners?this._listeners[f]:void 0;if(!t)return!1;t.forEach(function(b){b(A)});return!0}S.exports={addEventListener:t,on:t,removeEventListener:function(f,A){var t,b;if(void 0===A||"function"!==typeof A||"string"!==typeof f)throw new TypeError("EventEmitter: removeEventListener requires a string and a function as arguments");
if(void 0===this._listeners)return!1;b=this._listeners[f];if(void 0===b)return!1;t=b.indexOf(A);if(0>t)return!1;if(1===b.length)return delete this._listeners[f],!0;b.splice(t,1);return!0},callEventListeners:f,emit:f,removeAllListeners:function(f){this._listeners&&(void 0===f?delete this._listeners:delete this._listeners[f]);return this}}},{}],8:[function(D,S,ba){function t(){this.listeners=[]}t.prototype.constructor=t;t.prototype.addEventListener=function(f,z,t,D){t=D?t.bind(D):t;D=!1;f&&(D=f.addEventListener(z,
t),this.listeners.push([f,z,t]));return D};t.prototype.on=t.prototype.addEventListener;t.prototype.clear=function(){this.listeners.forEach(function(f){f[0].removeEventListener(f[1],f[2])});this.listeners=[]};S.exports=t},{}],9:[function(D,S,ba){S.exports={EventEmitter:D("./event_emitter.js"),EventListenerGroup:D("./event_listener_group.js")}},{"./event_emitter.js":7,"./event_listener_group.js":8}],10:[function(D,S,ba){var t;function f(a,b){if(a===b)return!0;if(!a||!b||a.length!=b.length)return!1;
for(var c=0;c<a.length;++c)if(a[c]!=b[c])return!1;return!0}function z(a){if(!(a&&a.constructor==Uint8Array||Array.isArray(a)))throw new TypeError("Cannot compute the hash code of "+a);for(var b=1,c=0;c<a.length;++c){var d=a[c];if("number"!==typeof d)throw new TypeError("Cannot compute the hash code over non-numeric elements: "+d);b=31*b+d&4294967295}return b}function A(a,b){if(a===b)return!0;if(!a||!b)return!1;b instanceof Array||(b=[b]);for(var c=0;c<b.length;++c){for(var d=b[c],e=!1,h=0;h<a.length;++h){var f=
a[h];if(d.equals&&"function"===typeof d.equals&&d.equals(f)||d==f){e=!0;break}}if(!e)return!1}return!0}function xa(a,b){return A(a,b)&&(a.length==b.length||A(b,a))}function b(a,b,c){var d;c&&(d=c);if("object"!==typeof a||"function"!==typeof a.result||"function"!==typeof a.error)throw new TypeError("callback must be an object with function properties 'result' and 'error'.");try{var e=b.call(d,a);void 0!==e&&a.result(e)}catch(h){try{a.error(h)}catch(f){}}}function e(a,c,d){if("object"!==typeof a||"function"!==
typeof a.timeout)throw new TypeError("callback must be an object with function properties 'result', 'timeout', and 'error'.");b(a,c,d)}function a(a,b,c){1E5>a&&(a=1E5+a);Object.defineProperties(this,{internalCode:{value:a,writable:!1,configurable:!1},responseCode:{value:b,writable:!1,configurable:!1},message:{value:c,writable:!1,configurable:!1}})}function ua(a){this.name="TimeoutError";this.message=a||"Operation timed out";this.errorCode=nrdp.network.ERRORCODE.TIMEOUTERROR;this.mesg="TIMED_OUT_ERROR";
try{throw Error();}catch(b){this.stack=b.stack}}setTimeout=function(a,b){return nrdp.gibbon.setTimeout(a,b||0)};clearTimeout=function(a){nrdp.gibbon.clearTimeout(a)};setInterval=function(a,b){return nrdp.gibbon.setTimeout(a,b||0,!1)};clearInterval=function(a){nrdp.gibbon.clearTimeout(a)};var w=nrdp.btoa,Oa=nrdp.atob,jb=nrdp.utf8toa,ra=nrdp.atoutf8,ka=D("nf-promise"),aa=D("nf-underscore"),da;(function(){function a(b,g){function l(a){a.hash&&!a.params&&(a.params={hash:a.hash.name})}if(102==b)return{process:function(a,
b,g){k.exportKey(b.key,b.format,g)}};if(106==b)return{process:function(a,b,g){"raw"==b.format?k.aesUnwrap(b.buffer,b.algorithm,b.key,b.usages,g):k.unwrapJwe(b.buffer,b.key,b.algorithm,b.extractable,b.usages,g)}};if(105==b)return{process:function(a,b,g){k.wrapJwe(b.wrappingKey,b.key,b.algorithm,k.A128GCM,g)}};if(101==b)return{process:function(a,b,g){k.importKey(b.buffer,b.format,b.algorithm,b.extractable,b.usages,g)}};if(500==b)return{process:function(a,b,g){k.getKeyByName(b.name,g)}};if(600==b)return{process:function(a,
b,g){k.getKeyInfo(b.handle,g)}};switch(g.toUpperCase()){case "AES-CBC":return{process:function(a,b,g){switch(a){case 2:a=b.algorithm.params?b.algorithm.params.iv:b.algorithm.iv;k.aesEncrypt(b.key,a,b.buffer,g);break;case 3:a=b.algorithm.params?b.algorithm.params.iv:b.algorithm.iv;k.aesDecrypt(b.key,a,b.buffer,g);break;case 103:k.symKeyGen(b.algorithm,b.extractable,b.usages,g);break;default:throw new c;}}};case "SHA-1":case "SHA-224":case "SHA-256":case "SHA-384":case "SHA-512":return{process:function(a,
b,g){switch(a){case 1:k.digest(b.buffer,b.algorithm,g);break;default:throw new c;}}};case "RSASSA-PKCS1-V1_5":return{process:function(a,b,g){switch(a){case 4:l(b.algorithm);k.rsaSign(b.key,b.buffer,b.algorithm,g);break;case 5:l(b.algorithm);k.rsaVerify(b.key,b.buffer,b.algorithm,b.signature,g);break;case 103:k.rsaKeyGen(b.algorithm,b.extractable,b.usages,g);break;default:throw new c;}}};case "RSA-OAEP":case "RSAES-PKCS1-V1_5":return{process:function(a,b,g){switch(a){case 2:k.rsaEncrypt(b.key,b.buffer,
g);break;case 3:k.rsaDecrypt(b.key,b.buffer,g);break;case 103:k.rsaKeyGen(b.algorithm,b.extractable,b.usages,g);break;default:throw new c;}}};case "HMAC":return{process:function(a,b,g){switch(a){case 4:l(b.algorithm);k.hmac(b.key,b.buffer,b.algorithm,g);break;case 5:l(b.algorithm);k.hmacVerify(b.key,b.buffer,b.algorithm,b.signature,g);break;case 103:k.symKeyGen(b.algorithm,b.extractable,b.usages,g);break;default:throw new c;}}};case "DH":return{process:function(a,b,g){switch(a){case 103:k.dhKeyGen(b.algorithm,
b.extractable,b.usages,g);break;case 104:k.dhDerive(b.key,b.algorithm.params["public"],b.derivedAlgorithm,b.extractable,b.usages,g);break;default:throw new c;}}};case "NFLX-DH":return{process:function(a,b,g){switch(a){case 103:k.dhKeyGen(b.algorithm,b.extractable,b.usages,g);break;case 104:if(!k.nflxDhDerive)throw new c;k.nflxDhDerive(b.key,b.algorithm.params["public"],p(b.algorithm.params.kd),g);break;default:throw new c;}}};case "AES-KW":return{process:function(a,b,g){switch(a){case 103:k.symKeyGen(b.algorithm,
b.extractable,b.usages,g);break;default:throw new c;}}};case "NFLX-CDM-WIDEVINE":case "NFLX-CDM-JWELE":return{process:function(a,b,g){switch(a){case 103:k.symKeyGen(b.algorithm,b.extractable,b.usages,g);break;case 104:if(!k.cdmDerive)throw new c;k.cdmDerive(b.key,b.algorithm.params.cdmProvisionResponseData,b.algorithm.params.keKeyId,b.algorithm.params.khKeyId,g);break;default:throw new c;}}};case "ECC":return{process:function(a,b,g){switch(a){case 4:if(!k.eccSign)throw u.error("Platform WebCrypto missing eccSign"),
new c;l(b.algorithm);k.eccSign(b.key,b.buffer,b.algorithm,g);break;default:throw new c;}}}}}function b(a){this.name="InvalidAlgorithmError";this.message=a||"Invalid algorithm"}function c(a){this.name="NotSupportedError";this.message=a||"Not supported"}function d(a){this.name="NotImplementedError";this.message=a||"Not implemented yet"}function e(k,g){var l,m,v;if("string"==typeof g)return e(k,{name:g});if(g&&"object"==typeof g){l=g.name;if("string"!=typeof l)throw new b("Algorithm has bad or missing name");
m=a(k,l);if(!m)throw u.error("Invalid WebCrypto algorithm",l),new b('Invalid algorithm "'+g.name+'"');v=g.params;if(void 0!==v&&(null===v||"object"!=typeof v))throw new b('Invalid algorithm parameters for "'+g.name+'", expecting undefined or an object');return{algorithm:{name:l,params:v},process:m.process}}throw new b("Invalid algorithm : "+JSON.stringify(g));}function h(a){var b=v[a];if(void 0===b)throw new SyntaxError('Invalid key format "'+a+'"');return b}function f(a){return Array.isArray(a)?
a.map(function(a){var b=H[a];if(void 0===b)throw new SyntaxError('Invalid key usage "'+a+'"');return b}):[]}function p(a){if(a&&"object"==typeof a&&1<=a.handle)return a.handle;throw new SyntaxError("Invalid key");}function Ia(a){if("string"==typeof a&&0<=a.length||a&&"object"==typeof a&&a.buffer&&0<=a.byteLength)return a;throw new SyntaxError("Invalid buffer or key data");}function Ea(a,b,k,g){a._listeners=[];a._result=null;a._operation=b;a._args=k;a._info=g;switch(b){case 1:a._name="DIGEST";break;
case 2:a._name="ENCRYPT";break;case 3:a._name="DECRYPT";break;case 4:a._name="SIGN";break;case 5:a._name="VERIFY";break;case 101:a._name="IMPORT_KEY";break;case 102:a._name="EXPORT_KEY";break;case 103:a._name="GENERATE_KEY";break;case 104:a._name="DERIVE_KEY";break;case 105:a._name="WRAP_KEY";break;case 106:a._name="UNWRAP_KEY";break;case 500:a._name="GET_KEY";break;case 600:a._name="KEY_INFO"}}function la(a,b,k){Ea(this,a,b,k)}function L(a,b,k){Ea(this,a,b,k)}function l(a){function b(a,k){return"object"==
typeof k&&k&&k.byteLength?"["+k.byteLength+" bytes]":"string"==typeof k&&"data"==a?"["+k.length+" chars]":k}function l(b,k){var g,m=a._listeners.slice(0),u=m.length,v;for(g=0;g<u;++g)v=m[g],v.type==b&&v.callback(k)}function v(a){var b={handle:a.handle,extractable:a.extractable,algorithm:a.algorithm,name:a.name};switch(a.type){case k.SECRET:b.type="secret";break;case k.PUBLIC:b.type="public";break;case k.PRIVATE:b.type="private"}b.keyUsage=a.usage.map(function(a){switch(a){case k.ENCRYPT:return"encrypt";
case k.DECRYPT:return"decrypt";case k.SIGN:return"sign";case k.VERIFY:return"verify";case k.DERIVE:return"derive";case k.WRAP:return"wrap";case k.UNWRAP:return"unwrap"}});b.keyUsages=b.keyUsage;return b}function c(a){switch(H){case 1:case 2:case 3:case 4:case 102:case 105:return a.data instanceof ArrayBuffer?new Uint8Array(a.data):g(a.data,!0);case 5:return a.verified?!0:!1;case 101:case 106:case 103:case 104:return a.key?v(a.key):a.encryptionKey&&a.hmacKey?{encryptionKey:v(a.encryptionKey),hmacKey:v(a.hmacKey),
wrappingKey:a.wrappingKey?v(a.wrappingKey):void 0}:{publicKey:v(a.publickey),privateKey:v(a.privatekey)};case 500:case 600:return a.key?v(a.key):null;default:throw new d;}}function L(a){u.error("FAILED "+B+"\n"+a);e.error=a;l("error",e)}var B=a._name,H=a._operation,M=a._info,r=a._args,e={target:a},q=nrdp.mono();m&&(m=!1,k.setBinary&&k.setBinary(!0));DEBUG&&u.trace("STARTING "+B+": "+JSON.stringify(r,b));a._result=null;try{M.process(H,r,function(k){try{u.trace("FINISHED "+B+" IN "+(nrdp.mono()-q)+
" ms: ");DEBUG&&u.trace(JSON.stringify(k,b));if(!k.success)throw Error("WebCrypto operation "+B+" failed");a._result=c(k);DEBUG&&u.trace("RESULT: "+JSON.stringify(a._result,b));l("complete",e)}catch(g){L(g)}})}catch(Va){setTimeout(function(){L(Va)},0)}return a}var k=nrdp.webcrypto,g=nrdp.atob,u=new (D("nf-console"))("CRYPTO"),m=!0,v={raw:k.RAW,pkcs8:k.PKCS8,spki:k.SPKI,jwk:k.JWK},H={encrypt:k.ENCRYPT,decrypt:k.DECRYPT,sign:k.SIGN,verify:k.VERIFY,derive:k.DERIVE,deriveKey:k.DERIVE,wrap:k.WRAP,unwrap:k.UNWRAP};
b.prototype=Error();b.prototype.constructor=b;c.prototype=Error();c.prototype.constructor=c;d.prototype=Error();d.prototype.constructor=d;la.prototype.constructor=la;la.prototype.addEventListener=function(a,b){this._listeners.push({type:a,callback:b})};la.prototype.removeEventListener=function(a,b){this._listeners=this._listeners.filter(function(k){return!(k.type==a&&k.callback==b)})};Object.defineProperties(la.prototype,{result:{enumerable:!0,get:function(){return this._result}},onerror:{enumerable:!0,
configurable:!1,set:function(a){this.addEventListener("error",a)}},oncomplete:{enumerable:!0,configurable:!0,set:function(a){this.addEventListener("complete",a)}}});L.prototype=new la;L.prototype.constructor=L;L.prototype.process=function(a){throw new d("process not supported on CryptoOperation");};L.prototype.finish=function(){throw new d("finish not supported on CryptoOperation");};L.prototype.abort=function(){throw new d("abort not supported on CryptoOperation");};Object.defineProperties(L.prototype,
{algorithm:{enumerable:!0,get:function(){return this._args.algorithm}},key:{enumerable:!0,get:function(){return this._args.key||null}},onabort:{enumerable:!0,configurable:!1,set:function(a){this.addEventListener("abort",a)}},onprogress:{enumerable:!0,configurable:!1,set:function(a){this.addEventListener("progress",a)}}});da={getRandomValues:function(a){nrdp.random(a);return a},getKeyByName:function(b){var k=a(500);return l(new la(500,{name:b},k))},getKeyInfo:function(b){var k=a(600);return l(new la(600,
{handle:b},k))},digest:function(a,b){var k=e(1,a),g={algorithm:a,buffer:Ia(b)};return l(new L(1,g,k))},encrypt:function(a,b,k){var g=e(2,a);a={algorithm:a,key:p(b),buffer:Ia(k)};return l(new L(2,a,g))},decrypt:function(a,b,k){var g=e(3,a);a={algorithm:a,key:p(b),buffer:Ia(k)};return l(new L(3,a,g))},sign:function(a,b,k){var g=e(4,a);a={algorithm:a,key:p(b),buffer:Ia(k)};return l(new L(4,a,g))},verify:function(a,b,k,g){var m=e(5,a);a={algorithm:a,key:p(b),signature:Ia(k),buffer:Ia(g)};return l(new L(5,
a,m))},importKey:function(a,b,k,g,m){var u=e(101,k);a={format:h(a),buffer:Ia(b),algorithm:k,extractable:g?!0:!1,usages:f(m)};return l(new la(101,a,u))},exportKey:function(b,k){var g=a(102),m={format:h(b),key:p(k)};return l(new la(102,m,g))},generateKey:function(a,b,k){var g=e(103,a);a={algorithm:a,extractable:b?!0:!1,usages:f(k)};return l(new la(103,a,g))},deriveKey:function(a,b,k,g,m){var u=e(104,a);a={algorithm:a,key:p(b),derivedAlgorithm:k,extractable:g,usages:f(m)};return l(new la(104,a,u))},
wrapKey:function(a,b,k){var g=e(105,k);a={algorithm:k,key:p(a),wrappingKey:p(b)};return l(new la(105,a,g))},unwrapKey:function(b,k,g,m,u,v){var c=a(106);b={algorithm:k,buffer:Ia(b),key:p(g),extractable:m?!0:!1,usages:f(u),format:v};return l(new la(106,b,c))}};da.subtle=da})();var K=function(a){return Oa(a,!0)},ja=da.subtle,ca=function(a,b){if(!b||"utf-8"===b)return jb(a);throw Error("unsupported encoding");},Z=function(a,b){if(!b||"utf-8"===b)return ra(a);throw Error("unsupported encoding");},W,T,
za,O,va,Ob,Ua,Ma,c;(function(){W="utf-8";T=9007199254740992;var a=za={GZIP:"GZIP",LZW:"LZW"};Object.freeze(za);O=function(b){for(var c=[a.GZIP,a.LZW],d=0;d<c.length&&0<b.length;++d)for(var e=c[d],h=0;h<b.length;++h)if(b[h]==e)return e;return null};var b=va={AES_CBC_PKCS5Padding:"AES/CBC/PKCS5Padding",AESWrap:"AESWrap",RSA_ECB_PKCS1Padding:"RSA/ECB/PKCS1Padding"};Object.freeze(va);Ob=function(a){return b.AES_CBC_PKCS5Padding==a?b.AES_CBC_PKCS5Padding:b.RSA_ECB_PKCS1Padding==a?b.RSA_ECB_PKCS1Padding:
b[a]};var d=Ua={HmacSHA256:"HmacSHA256",SHA256withRSA:"SHA256withRSA"};Object.freeze(Ua);Ma=function(a){return d[a]};c={FAIL:1,TRANSIENT_FAILURE:2,ENTITY_REAUTH:3,USER_REAUTH:4,KEYX_REQUIRED:5,ENTITYDATA_REAUTH:6,USERDATA_REAUTH:7,EXPIRED:8,REPLAYED:9,SSOTOKEN_REJECTED:10};Object.freeze(c)})();var x={isObjectLiteral:function(a){return null!==a&&"object"===typeof a&&a.constructor===Object},extendDeep:function(){var a=arguments[0],b=1,c=arguments.length,d=!1,e,h,f,p;"boolean"===typeof a&&(d=a,a=arguments[1],
b=2);for(;b<c;b++)if(null!=(e=arguments[b]))for(h in e)d&&h in a||(p=e[h],a!==p&&void 0!==p&&(f=a[h],a[h]=null!==f&&null!==p&&"object"===typeof f&&"object"===typeof p?x.extendDeep(d,{},f,p):p));return a}};(function(){function a(b,c){return function(){var a=b.base,L;b.base=c;L=b.apply(this,arguments);b.base=a;return L}}function b(c,d,e){var L,l,k,g;e=e||p;g=!!e.extendAll;for(L in d)l=d.__lookupGetter__(L),k=d.__lookupSetter__(L),l||k?(l&&c.__defineGetter__(L,l),k&&c.__defineSetter__(L,k)):(l=d[L],
k=c[L],"function"===typeof l&&"function"===typeof k&&l!==k?(l.base!==Function.prototype.base&&(l=a(l,k)),l.base=k):(g||e[L])&&x.isObjectLiteral(l)&&x.isObjectLiteral(k)&&(l=x.extendDeep({},k,l)),c[L]=l)}function c(){var a=Array.prototype.slice,b=a.call(arguments,1);return this.extend({init:function L(){var l=a.call(arguments,0);L.base.apply(this,b.concat(l))}})}function d(a,c){var e=new this(f);b(e,a,c);return h(e)}function e(a,c){b(this.prototype,a,c);return this}function h(a){var b=function(){var a=
this.init;a&&arguments[0]!==f&&a.apply(this,arguments)};a&&(b.prototype=a);b.prototype.constructor=b;b.extend=d;b.bind=c;b.mixin=e;return b}var f={},p={actions:!0};Function.prototype.base=function(){};x.Class={create:h,mixin:b,extend:function(a,b){var c=h();c.prototype=new a;return c.extend(b)}};x.mixin=function(){x.log&&x.log.warn("util.mixin is deprecated.  Please change your code to use util.Class.mixin()");b.apply(null,arguments)}})();var ea;(function(){function a(b){return b==T?1:b+1}function b(c){if(0===
Object.keys(c._waiters).length)return 0;for(var d=a(c._nextWaiter);!c._waiters[d];)d=a(d);return d}ea=x.Class.create({init:function(){Object.defineProperties(this,{_queue:{value:[],writable:!1,enumerable:!1,configurable:!1},_waiters:{value:{},writable:!1,enumerable:!1,configurable:!1},_nextWaiter:{value:0,writable:!0,enumerable:!1,configurable:!1},_lastWaiter:{value:0,writable:!0,enumerable:!1,configurable:!1}})},cancel:function(a){if(this._waiters[a]){var c=this._waiters[a];delete this._waiters[a];
a==this._nextWaiter&&(this._nextWaiter=b(this));c.call(this,void 0)}},cancelAll:function(){for(;0!==this._nextWaiter;)this.cancel(this._nextWaiter)},poll:function(c,d){var h=this,f=a(this._lastWaiter);this._lastWaiter=f;e(d,function(){if(0<this._queue.length){var a=this._queue.shift();setTimeout(function(){d.result(a)},0)}else{var e;-1!=c&&(e=setTimeout(function(){delete h._waiters[f];f==h._nextWaiter&&(h._nextWaiter=b(h));d.timeout()},c));this._waiters[f]=function(a){clearTimeout(e);setTimeout(function(){d.result(a)},
0)};this._nextWaiter||(this._nextWaiter=f)}},h);return f},add:function(a){if(this._nextWaiter){var c=this._waiters[this._nextWaiter];delete this._waiters[this._nextWaiter];this._nextWaiter=b(this);c.call(this,a)}else this._queue.push(a)}})})();var Na;(function(){var a=0-T;Na=x.Class.create({nextBoolean:function(){var a=new Uint8Array(1);da.getRandomValues(a);return a[0]&1?!0:!1},nextInt:function(a){if(null!==a&&void 0!==a){if("number"!==typeof a)throw new TypeError("n must be of type number");if(1>
a)throw new RangeError("n must be greater than zero");--a;var b=new Uint8Array(4);da.getRandomValues(b);return Math.floor(((b[3]&127)<<24|b[2]<<16|b[1]<<8|b[0])/2147483648*(a-0+1)+0)}a=new Uint8Array(4);da.getRandomValues(a);b=(a[3]&127)<<24|a[2]<<16|a[1]<<8|a[0];return a[3]&128?-b:b},nextLong:function(){for(var b=a;b==a;){b=new Uint8Array(7);da.getRandomValues(b);var c=16777216*((b[6]&31)<<24|b[5]<<16|b[4]<<8|b[3])+(b[2]<<16|b[1]<<8|b[0]),b=b[6]&128?-c-1:c}return b},nextBytes:function(a){da.getRandomValues(a)}})})();
var ib;(function(){function a(b){return b==T?1:b+1}function b(c){if(0===Object.keys(c._waitingReaders).length)return 0;for(var d=a(c._nextReader);!c._waitingReaders[d];)d=a(d);return d}function c(b){if(0===Object.keys(b._waitingWriters).length)return 0;for(var d=a(b._nextWriter);!b._waitingWriters[d];)d=a(d);return d}ib=x.Class.create({init:function(){Object.defineProperties(this,{_readers:{value:{},writable:!1,enumerable:!1,configurable:!1},_waitingReaders:{value:{},writable:!1,enumerable:!1,configurable:!1},
_writer:{value:null,writable:!0,enumerable:!1,configurable:!1},_waitingWriters:{value:{},writable:!1,enumerable:!1,configurable:!1},_nextReader:{value:0,writable:!0,enumerable:!1,configurable:!1},_nextWriter:{value:0,writable:!0,enumerable:!1,configurable:!1},_lastNumber:{value:0,writable:!0,enumerable:!1,configurable:!1}})},cancel:function(a){if(this._waitingReaders[a]){var d=this._waitingReaders[a];delete this._waitingReaders[a];a==this._nextReader&&(this._nextReader=b(this));d.call(this,!0)}this._waitingWriters[a]&&
(d=this._waitingWriters[a],delete this._waitingWriters[a],a==this._nextWriter&&(this._nextWriter=c(this)),d.call(this,!0))},cancelAll:function(){for(;0!==this._nextWriter;)this.cancel(this._nextWriter);for(;0!==this._nextReader;)this.cancel(this._nextReader)},readLock:function(c,d){var h=this,f=a(this._lastNumber);this._lastNumber=f;e(d,function(){if(!this._writer&&0===Object.keys(this._waitingWriters).length)return this._readers[f]=!0,f;var a;-1!=c&&(a=setTimeout(function(){delete h._waitingReaders[f];
f==h._nextReader&&(h._nextReader=b(h));d.timeout()},c));this._waitingReaders[f]=function(b){clearTimeout(a);b?setTimeout(function(){d.result(void 0)},0):(h._readers[f]=!0,setTimeout(function(){d.result(f)},0))};this._nextReader||(this._nextReader=f)},h);return f},writeLock:function(b,d){var h=this,f=a(this._lastNumber);this._lastNumber=f;e(d,function(){if(0===Object.keys(this._readers).length&&0===Object.keys(this._waitingReaders).length&&!this._writer)return this._writer=f;var a;-1!=b&&(a=setTimeout(function(){delete h._waitingWriters[f];
f==h._nextWriter&&(h._nextWriter=c(h));d.timeout()},b));this._waitingWriters[f]=function(b){clearTimeout(a);b?setTimeout(function(){d.result(void 0)},0):(h._writer=f,setTimeout(function(){d.result(f)},0))};this._nextWriter||(this._nextWriter=f)},h);return f},unlock:function(b){if(b==this._writer)this._writer=null;else{if(!this._readers[b])throw new E("There is no reader or writer with ticket number "+b+".");delete this._readers[b]}if(this._nextWriter)0<Object.keys(this._readers).length||(b=this._waitingWriters[this._nextWriter],
delete this._waitingWriters[this._nextWriter],this._nextWriter=c(this),b.call(this,!1));else{for(var d=this._nextReader;0<Object.keys(this._waitingReaders).length;d=a(d))this._waitingReaders[d]&&(b=this._waitingReaders[d],delete this._waitingReaders[d],b.call(this,!1));this._nextReader=0}}})})();x.Class.mixin(a,{JSON_PARSE_ERROR:new a(0,c.FAIL,"Error parsing JSON."),JSON_ENCODE_ERROR:new a(1,c.FAIL,"Error encoding JSON."),ENVELOPE_HASH_MISMATCH:new a(2,c.FAIL,"Computed hash does not match envelope hash."),
INVALID_PUBLIC_KEY:new a(3,c.FAIL,"Invalid public key provided."),INVALID_PRIVATE_KEY:new a(4,c.FAIL,"Invalid private key provided."),PLAINTEXT_ILLEGAL_BLOCK_SIZE:new a(5,c.FAIL,"Plaintext is not a multiple of the block size."),PLAINTEXT_BAD_PADDING:new a(6,c.FAIL,"Plaintext contains incorrect padding."),CIPHERTEXT_ILLEGAL_BLOCK_SIZE:new a(7,c.FAIL,"Ciphertext is not a multiple of the block size."),CIPHERTEXT_BAD_PADDING:new a(8,c.FAIL,"Ciphertext contains incorrect padding."),ENCRYPT_NOT_SUPPORTED:new a(9,
c.FAIL,"Encryption not supported."),DECRYPT_NOT_SUPPORTED:new a(10,c.FAIL,"Decryption not supported."),ENVELOPE_KEY_ID_MISMATCH:new a(11,c.FAIL,"Encryption envelope key ID does not match crypto context key ID."),CIPHERTEXT_ENVELOPE_PARSE_ERROR:new a(12,c.FAIL,"Error parsing ciphertext envelope."),CIPHERTEXT_ENVELOPE_ENCODE_ERROR:new a(13,c.FAIL,"Error encoding ciphertext envelope."),SIGN_NOT_SUPPORTED:new a(14,c.FAIL,"Sign not supported."),VERIFY_NOT_SUPPORTED:new a(15,c.FAIL,"Verify not suppoprted."),
SIGNATURE_ERROR:new a(16,c.FAIL,"Signature not initialized or unable to process data/signature."),HMAC_ERROR:new a(17,c.FAIL,"Error computing HMAC."),ENCRYPT_ERROR:new a(18,c.FAIL,"Error encrypting plaintext."),DECRYPT_ERROR:new a(19,c.FAIL,"Error decrypting ciphertext."),INSUFFICIENT_CIPHERTEXT:new a(20,c.FAIL,"Insufficient ciphertext for decryption."),SESSION_KEY_CREATION_FAILURE:new a(21,c.FAIL,"Error when creating session keys."),INVALID_SYMMETRIC_KEY:new a(24,c.FAIL,"Invalid symmetric key provided."),
INVALID_ENCRYPTION_KEY:new a(25,c.FAIL,"Invalid encryption key."),INVALID_HMAC_KEY:new a(26,c.FAIL,"Invalid HMAC key."),WRAP_NOT_SUPPORTED:new a(27,c.FAIL,"Wrap not supported."),UNWRAP_NOT_SUPPORTED:new a(28,c.FAIL,"Unwrap not supported."),UNIDENTIFIED_JWK_TYPE:new a(29,c.FAIL,"Unidentified JSON web key type."),UNIDENTIFIED_JWK_USAGE:new a(30,c.FAIL,"Unidentified JSON web key usage."),UNIDENTIFIED_JWK_ALGORITHM:new a(31,c.FAIL,"Unidentified JSON web key algorithm."),WRAP_ERROR:new a(32,c.FAIL,"Error wrapping plaintext."),
UNWRAP_ERROR:new a(33,c.FAIL,"Error unwrapping ciphertext."),INVALID_JWK:new a(34,c.FAIL,"Invalid JSON web key."),INVALID_JWK_KEYDATA:new a(35,c.FAIL,"Invalid JSON web key keydata."),UNSUPPORTED_JWK_ALGORITHM:new a(36,c.FAIL,"Unsupported JSON web key algorithm."),WRAP_KEY_CREATION_FAILURE:new a(37,c.FAIL,"Error when creating wrapping key."),INVALID_WRAP_CIPHERTEXT:new a(38,c.FAIL,"Invalid wrap ciphertext."),UNSUPPORTED_JWE_ALGORITHM:new a(39,c.FAIL,"Unsupported JSON web encryption algorithm."),JWE_ENCODE_ERROR:new a(40,
c.FAIL,"Error encoding JSON web encryption header."),JWE_PARSE_ERROR:new a(41,c.FAIL,"Error parsing JSON web encryption header."),INVALID_ALGORITHM_PARAMS:new a(42,c.FAIL,"Invalid algorithm parameters."),JWE_ALGORITHM_MISMATCH:new a(43,c.FAIL,"JSON web encryption header algorithms mismatch."),KEY_IMPORT_ERROR:new a(44,c.FAIL,"Error importing key."),KEY_EXPORT_ERROR:new a(45,c.FAIL,"Error exporting key."),DIGEST_ERROR:new a(46,c.FAIL,"Error in digest."),UNSUPPORTED_KEY:new a(47,c.FAIL,"Unsupported key type or algorithm."),
UNSUPPORTED_JWE_SERIALIZATION:new a(48,c.FAIL,"Unsupported JSON web encryption serialization."),INVALID_WRAPPING_KEY:new a(51,c.FAIL,"Invalid wrapping key."),UNIDENTIFIED_CIPHERTEXT_ENVELOPE:new a(52,c.FAIL,"Unidentified ciphertext envelope version."),UNIDENTIFIED_SIGNATURE_ENVELOPE:new a(53,c.FAIL,"Unidentified signature envelope version."),UNSUPPORTED_CIPHERTEXT_ENVELOPE:new a(54,c.FAIL,"Unsupported ciphertext envelope version."),UNSUPPORTED_SIGNATURE_ENVELOPE:new a(55,c.FAIL,"Unsupported signature envelope version."),
UNIDENTIFIED_CIPHERSPEC:new a(56,c.FAIL,"Unidentified cipher specification."),UNIDENTIFIED_ALGORITHM:new a(57,c.FAIL,"Unidentified algorithm."),SIGNATURE_ENVELOPE_PARSE_ERROR:new a(58,c.FAIL,"Error parsing signature envelope."),SIGNATURE_ENVELOPE_ENCODE_ERROR:new a(59,c.FAIL,"Error encoding signature envelope."),INVALID_SIGNATURE:new a(60,c.FAIL,"Invalid signature."),DERIVEKEY_ERROR:new a(61,c.FAIL,"Error deriving key."),UNIDENTIFIED_JWK_KEYOP:new a(62,c.FAIL,"Unidentified JSON web key key operation."),
GENERATEKEY_ERROR:new a(63,c.FAIL,"Error generating key."),INVALID_IV:new a(64,c.FAIL,"Invalid initialization vector."),INVALID_CIPHERTEXT:new a(65,c.FAIL,"Invalid ciphertext."),MASTERTOKEN_UNTRUSTED:new a(1E3,c.ENTITY_REAUTH,"Master token is not trusted."),MASTERTOKEN_KEY_CREATION_ERROR:new a(1001,c.ENTITY_REAUTH,"Unable to construct symmetric keys from master token."),MASTERTOKEN_EXPIRES_BEFORE_RENEWAL:new a(1002,c.ENTITY_REAUTH,"Master token expiration timestamp is before the renewal window opens."),
MASTERTOKEN_SESSIONDATA_MISSING:new a(1003,c.ENTITY_REAUTH,"No master token session data found."),MASTERTOKEN_SEQUENCE_NUMBER_OUT_OF_RANGE:new a(1004,c.ENTITY_REAUTH,"Master token sequence number is out of range."),MASTERTOKEN_SERIAL_NUMBER_OUT_OF_RANGE:new a(1005,c.ENTITY_REAUTH,"Master token serial number is out of range."),MASTERTOKEN_TOKENDATA_INVALID:new a(1006,c.ENTITY_REAUTH,"Invalid master token data."),MASTERTOKEN_SIGNATURE_INVALID:new a(1007,c.ENTITY_REAUTH,"Invalid master token signature."),
MASTERTOKEN_SESSIONDATA_INVALID:new a(1008,c.ENTITY_REAUTH,"Invalid master token session data."),MASTERTOKEN_SEQUENCE_NUMBER_OUT_OF_SYNC:new a(1009,c.ENTITY_REAUTH,"Master token sequence number does not have the expected value."),MASTERTOKEN_TOKENDATA_MISSING:new a(1010,c.ENTITY_REAUTH,"No master token data found."),MASTERTOKEN_TOKENDATA_PARSE_ERROR:new a(1011,c.ENTITY_REAUTH,"Error parsing master token data."),MASTERTOKEN_SESSIONDATA_PARSE_ERROR:new a(1012,c.ENTITY_REAUTH,"Error parsing master token session data."),
MASTERTOKEN_IDENTITY_REVOKED:new a(1013,c.ENTITY_REAUTH,"Master token entity identity is revoked."),MASTERTOKEN_REJECTED_BY_APP:new a(1014,c.ENTITY_REAUTH,"Master token is rejected by the application."),USERIDTOKEN_MASTERTOKEN_MISMATCH:new a(2E3,c.USER_REAUTH,"User ID token master token serial number does not match master token serial number."),USERIDTOKEN_NOT_DECRYPTED:new a(2001,c.USER_REAUTH,"User ID token is not decrypted or verified."),USERIDTOKEN_MASTERTOKEN_NULL:new a(2002,c.USER_REAUTH,"User ID token requires a master token."),
USERIDTOKEN_EXPIRES_BEFORE_RENEWAL:new a(2003,c.USER_REAUTH,"User ID token expiration timestamp is before the renewal window opens."),USERIDTOKEN_USERDATA_MISSING:new a(2004,c.USER_REAUTH,"No user ID token user data found."),USERIDTOKEN_MASTERTOKEN_NOT_FOUND:new a(2005,c.USER_REAUTH,"User ID token is bound to an unknown master token."),USERIDTOKEN_MASTERTOKEN_SERIAL_NUMBER_OUT_OF_RANGE:new a(2006,c.USER_REAUTH,"User ID token master token serial number is out of range."),USERIDTOKEN_SERIAL_NUMBER_OUT_OF_RANGE:new a(2007,
c.USER_REAUTH,"User ID token serial number is out of range."),USERIDTOKEN_TOKENDATA_INVALID:new a(2008,c.USER_REAUTH,"Invalid user ID token data."),USERIDTOKEN_SIGNATURE_INVALID:new a(2009,c.USER_REAUTH,"Invalid user ID token signature."),USERIDTOKEN_USERDATA_INVALID:new a(2010,c.USER_REAUTH,"Invalid user ID token user data."),USERIDTOKEN_IDENTITY_INVALID:new a(2011,c.USER_REAUTH,"Invalid user ID token user identity."),RESERVED_2012:new a(2012,c.USER_REAUTH,"The entity is not associated with the user."),
USERIDTOKEN_IDENTITY_NOT_FOUND:new a(2013,c.USER_REAUTH,"The user identity was not found."),USERIDTOKEN_PASSWORD_VERSION_CHANGED:new a(2014,c.USER_REAUTH,"The user identity must be reauthenticated because the password version changed."),USERIDTOKEN_USERAUTH_DATA_MISMATCH:new a(2015,c.USER_REAUTH,"The user ID token and user authentication data user identities do not match."),USERIDTOKEN_TOKENDATA_MISSING:new a(2016,c.USER_REAUTH,"No user ID token data found."),USERIDTOKEN_TOKENDATA_PARSE_ERROR:new a(2017,
c.USER_REAUTH,"Error parsing user ID token data."),USERIDTOKEN_USERDATA_PARSE_ERROR:new a(2018,c.USER_REAUTH,"Error parsing user ID token user data."),USERIDTOKEN_REVOKED:new a(2019,c.USER_REAUTH,"User ID token is revoked."),USERIDTOKEN_REJECTED_BY_APP:new a(2020,c.USERDATA_REAUTH,"User ID token is rejected by the application."),SERVICETOKEN_MASTERTOKEN_MISMATCH:new a(3E3,c.FAIL,"Service token master token serial number does not match master token serial number."),SERVICETOKEN_USERIDTOKEN_MISMATCH:new a(3001,
c.FAIL,"Service token user ID token serial number does not match user ID token serial number."),SERVICETOKEN_SERVICEDATA_INVALID:new a(3002,c.FAIL,"Service token data invalid."),SERVICETOKEN_MASTERTOKEN_NOT_FOUND:new a(3003,c.FAIL,"Service token is bound to an unknown master token."),SERVICETOKEN_USERIDTOKEN_NOT_FOUND:new a(3004,c.FAIL,"Service token is bound to an unknown user ID token."),SERVICETOKEN_MASTERTOKEN_SERIAL_NUMBER_OUT_OF_RANGE:new a(3005,c.FAIL,"Service token master token serial number is out of range."),
SERVICETOKEN_USERIDTOKEN_SERIAL_NUMBER_OUT_OF_RANGE:new a(3006,c.FAIL,"Service token user ID token serial number is out of range."),SERVICETOKEN_TOKENDATA_INVALID:new a(3007,c.FAIL,"Invalid service token data."),SERVICETOKEN_SIGNATURE_INVALID:new a(3008,c.FAIL,"Invalid service token signature."),SERVICETOKEN_TOKENDATA_MISSING:new a(3009,c.FAIL,"No service token data found."),UNIDENTIFIED_ENTITYAUTH_SCHEME:new a(4E3,c.FAIL,"Unable to identify entity authentication scheme."),ENTITYAUTH_FACTORY_NOT_FOUND:new a(4001,
c.FAIL,"No factory registered for entity authentication scheme."),X509CERT_PARSE_ERROR:new a(4002,c.ENTITYDATA_REAUTH,"Error parsing X.509 certificate data."),X509CERT_ENCODE_ERROR:new a(4003,c.ENTITYDATA_REAUTH,"Error encoding X.509 certificate data."),X509CERT_VERIFICATION_FAILED:new a(4004,c.ENTITYDATA_REAUTH,"X.509 certificate verification failed."),ENTITY_NOT_FOUND:new a(4005,c.FAIL,"Entity not recognized."),INCORRECT_ENTITYAUTH_DATA:new a(4006,c.FAIL,"Entity used incorrect entity authentication data type."),
RSA_PUBLICKEY_NOT_FOUND:new a(4007,c.ENTITYDATA_REAUTH,"RSA public key not found."),UNSUPPORTED_ENTITYAUTH_DATA:new a(4023,c.FAIL,"Unsupported entity authentication data."),ENTITY_REVOKED:new a(4025,c.FAIL,"Entity is revoked."),ENTITY_REJECTED_BY_APP:new a(4026,c.ENTITYDATA_REAUTH,"Entity is rejected by the application."),X509CERT_EXPIRED:new a(4028,c.ENTITYDATA_REAUTH,"X.509 certificate is expired."),X509CERT_NOT_YET_VALID:new a(4029,c.ENTITYDATA_REAUTH,"X.509 certificate is not yet valid."),X509CERT_INVALID:new a(4030,
c.ENTITYDATA_REAUTH,"X.509 certificate is invalid."),RSA_PRIVATEKEY_NOT_FOUND:new a(4031,c.ENTITYDATA_REAUTH,"RSA private key not found."),UNIDENTIFIED_USERAUTH_SCHEME:new a(5003,c.FAIL,"Unable to identify user authentication scheme."),USERAUTH_FACTORY_NOT_FOUND:new a(5004,c.FAIL,"No factory registered for user authentication scheme."),EMAILPASSWORD_BLANK:new a(5005,c.USERDATA_REAUTH,"Email or password is blank."),EMAILPASSWORD_INCORRECT:new a(5007,c.USERDATA_REAUTH,"Email or password is incorrect."),
UNSUPPORTED_USERAUTH_DATA:new a(5008,c.FAIL,"Unsupported user authentication data."),USERAUTH_USERIDTOKEN_INVALID:new a(5011,c.USERDATA_REAUTH,"User authentication data user ID token is invalid."),UNIDENTIFIED_USERAUTH_MECHANISM:new a(5013,c.FAIL,"Unable to identify user authentication mechanism."),UNSUPPORTED_USERAUTH_MECHANISM:new a(5014,c.FAIL,"Unsupported user authentication mechanism."),USERAUTH_MASTERTOKEN_MISSING:new a(5016,c.USERDATA_REAUTH,"User authentication required master token is missing."),
USERAUTH_USERIDTOKEN_NOT_DECRYPTED:new a(5021,c.USERDATA_REAUTH,"User authentication data user ID token is not decrypted or verified."),USERAUTH_MASTERTOKEN_INVALID:new a(5024,c.USERDATA_REAUTH,"User authentication data master token is invalid."),USERAUTH_MASTERTOKEN_NOT_DECRYPTED:new a(5025,c.USERDATA_REAUTH,"User authentication data master token is not decrypted or verified."),USERAUTH_USERIDTOKEN_MISSING:new a(5030,c.USERDATA_REAUTH,"User authentication required user ID token is missing."),USERAUTH_ENTITY_MISMATCH:new a(5032,
c.USERDATA_REAUTH,"User authentication data does not match entity identity."),USERAUTH_INCORRECT_DATA:new a(5033,c.FAIL,"Entity used incorrect user authentication data type."),USER_REJECTED_BY_APP:new a(5037,c.USERDATA_REAUTH,"User is rejected by the application."),USERIDTOKEN_IDENTITY_NOT_ASSOCIATED_WITH_ENTITY:new a(5040,c.USER_REAUTH,"The entity is not associated with the user."),UNSUPPORTED_COMPRESSION:new a(6E3,c.FAIL,"Unsupported compression algorithm."),COMPRESSION_ERROR:new a(6001,c.FAIL,
"Error compressing data."),UNCOMPRESSION_ERROR:new a(6002,c.FAIL,"Error uncompressing data."),MESSAGE_ENTITY_NOT_FOUND:new a(6003,c.FAIL,"Message header entity authentication data or master token not found."),PAYLOAD_MESSAGE_ID_MISMATCH:new a(6004,c.FAIL,"Payload chunk message ID does not match header message ID ."),PAYLOAD_SEQUENCE_NUMBER_MISMATCH:new a(6005,c.FAIL,"Payload chunk sequence number does not match expected sequence number."),PAYLOAD_VERIFICATION_FAILED:new a(6006,c.FAIL,"Payload chunk payload signature verification failed."),
MESSAGE_DATA_MISSING:new a(6007,c.FAIL,"No message data found."),MESSAGE_FORMAT_ERROR:new a(6008,c.FAIL,"Malformed message data."),MESSAGE_VERIFICATION_FAILED:new a(6009,c.FAIL,"Message header/error data signature verification failed."),HEADER_DATA_MISSING:new a(6010,c.FAIL,"No header data found."),PAYLOAD_DATA_MISSING:new a(6011,c.FAIL,"No payload data found in non-EOM payload chunk."),PAYLOAD_DATA_CORRUPT:new a(6012,c.FAIL,"Corrupt payload data found in non-EOM payload chunk."),UNIDENTIFIED_COMPRESSION:new a(6013,
c.FAIL,"Unidentified compression algorithm."),MESSAGE_EXPIRED:new a(6014,c.EXPIRED,"Message expired and not renewable. Rejected."),MESSAGE_ID_OUT_OF_RANGE:new a(6015,c.FAIL,"Message ID is out of range."),INTERNAL_CODE_NEGATIVE:new a(6016,c.FAIL,"Error header internal code is negative."),UNEXPECTED_RESPONSE_MESSAGE_ID:new a(6017,c.FAIL,"Unexpected response message ID. Possible replay."),RESPONSE_REQUIRES_ENCRYPTION:new a(6018,c.KEYX_REQUIRED,"Message response requires encryption."),PAYLOAD_SEQUENCE_NUMBER_OUT_OF_RANGE:new a(6019,
c.FAIL,"Payload chunk sequence number is out of range."),PAYLOAD_MESSAGE_ID_OUT_OF_RANGE:new a(6020,c.FAIL,"Payload chunk message ID is out of range."),MESSAGE_REPLAYED:new a(6021,c.REPLAYED,"Non-replayable message replayed."),INCOMPLETE_NONREPLAYABLE_MESSAGE:new a(6022,c.FAIL,"Non-replayable message sent non-renewable or without key request data or without a master token."),HEADER_SIGNATURE_INVALID:new a(6023,c.FAIL,"Invalid Header signature."),HEADER_DATA_INVALID:new a(6024,c.FAIL,"Invalid header data."),
PAYLOAD_INVALID:new a(6025,c.FAIL,"Invalid payload."),PAYLOAD_SIGNATURE_INVALID:new a(6026,c.FAIL,"Invalid payload signature."),RESPONSE_REQUIRES_MASTERTOKEN:new a(6027,c.KEYX_REQUIRED,"Message response requires a master token."),RESPONSE_REQUIRES_USERIDTOKEN:new a(6028,c.USER_REAUTH,"Message response requires a user ID token."),REQUEST_REQUIRES_USERAUTHDATA:new a(6029,c.FAIL,"User-associated message requires user authentication data."),UNEXPECTED_MESSAGE_SENDER:new a(6030,c.FAIL,"Message sender is equal to the local entity or not the master token entity."),
NONREPLAYABLE_MESSAGE_REQUIRES_MASTERTOKEN:new a(6031,c.FAIL,"Non-replayable message requires a master token."),NONREPLAYABLE_ID_OUT_OF_RANGE:new a(6032,c.FAIL,"Non-replayable message non-replayable ID is out of range."),MESSAGE_SERVICETOKEN_MISMATCH:new a(6033,c.FAIL,"Service token master token or user ID token serial number does not match the message token serial numbers."),MESSAGE_PEER_SERVICETOKEN_MISMATCH:new a(6034,c.FAIL,"Peer service token master token or user ID token serial number does not match the message peer token serial numbers."),
RESPONSE_REQUIRES_INTEGRITY_PROTECTION:new a(6035,c.KEYX_REQUIRED,"Message response requires integrity protection."),HANDSHAKE_DATA_MISSING:new a(6036,c.FAIL,"Handshake message is not renewable or does not contain key request data."),MESSAGE_RECIPIENT_MISMATCH:new a(6037,c.FAIL,"Message recipient does not match local identity."),MESSAGE_ENTITYDATABASED_VERIFICATION_FAILED:new a(6038,c.ENTITYDATA_REAUTH,"Message header entity-based signature verification failed."),MESSAGE_MASTERTOKENBASED_VERIFICATION_FAILED:new a(6039,
c.ENTITY_REAUTH,"Message header master token-based signature verification failed."),UNIDENTIFIED_KEYX_SCHEME:new a(7E3,c.FAIL,"Unable to identify key exchange scheme."),KEYX_FACTORY_NOT_FOUND:new a(7001,c.FAIL,"No factory registered for key exchange scheme."),KEYX_REQUEST_NOT_FOUND:new a(7002,c.FAIL,"No key request found matching header key response data."),UNIDENTIFIED_KEYX_KEY_ID:new a(7003,c.FAIL,"Unable to identify key exchange key ID."),UNSUPPORTED_KEYX_KEY_ID:new a(7004,c.FAIL,"Unsupported key exchange key ID."),
UNIDENTIFIED_KEYX_MECHANISM:new a(7005,c.FAIL,"Unable to identify key exchange mechanism."),UNSUPPORTED_KEYX_MECHANISM:new a(7006,c.FAIL,"Unsupported key exchange mechanism."),KEYX_RESPONSE_REQUEST_MISMATCH:new a(7007,c.FAIL,"Key exchange response does not match request."),KEYX_PRIVATE_KEY_MISSING:new a(7008,c.FAIL,"Key exchange private key missing."),UNKNOWN_KEYX_PARAMETERS_ID:new a(7009,c.FAIL,"Key exchange parameters ID unknown or invalid."),KEYX_MASTER_TOKEN_MISSING:new a(7010,c.FAIL,"Master token required for key exchange is missing."),
KEYX_INVALID_PUBLIC_KEY:new a(7011,c.FAIL,"Key exchange public key is invalid."),KEYX_PUBLIC_KEY_MISSING:new a(7012,c.FAIL,"Key exchange public key missing."),KEYX_WRAPPING_KEY_MISSING:new a(7013,c.FAIL,"Key exchange wrapping key missing."),KEYX_WRAPPING_KEY_ID_MISSING:new a(7014,c.FAIL,"Key exchange wrapping key ID missing."),KEYX_INVALID_WRAPPING_KEY:new a(7015,c.FAIL,"Key exchange wrapping key is invalid."),KEYX_INCORRECT_DATA:new a(7016,c.FAIL,"Entity used incorrect key exchange data type."),
KEYX_INCORRECT_MECHANISM:new a(7017,c.FAIL,"Entity used incorrect key exchange mecahnism."),KEYX_DERIVATION_KEY_MISSING:new a(7018,c.FAIL,"Key exchange derivation key missing."),KEYX_INVALID_ENCRYPTION_KEY:new a(7019,c.FAIL,"Key exchange encryption key is invalid."),KEYX_INVALID_HMAC_KEY:new a(7020,c.FAIL,"Key exchange HMAC key is invalid."),KEYX_INVALID_WRAPDATA:new a(7021,c.FAIL,"Key exchange wrap data is invalid."),INTERNAL_EXCEPTION:new a(9E3,c.TRANSIENT_FAILURE,"Internal exception."),MSL_COMMS_FAILURE:new a(9001,
c.FAIL,"Error communicating with MSL entity."),NONE:new a(9999,c.FAIL,"Special unit test error.")});Object.freeze(a);var p;(function(){p=x.Class.create(Error());p.mixin({init:function(a,b,c){function d(){if(h)return h;if(this.cause&&this.cause instanceof p)return this.cause.messageId}Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor);var e=a.message;b&&(e+=" ["+b+"]");var h,f=this.stack;Object.defineProperties(this,{message:{value:e,writable:!1,configurable:!0},error:{value:a,
writable:!1,configurable:!0},cause:{value:c,writable:!1,configurable:!0},name:{value:"MslException",writable:!1,configurable:!0},masterToken:{value:null,writable:!0,configurable:!1},entityAuthenticationData:{value:null,writable:!0,configurable:!1},userIdToken:{value:null,writable:!0,configurable:!1},userAuthenticationData:{value:null,writable:!0,configurable:!1},messageId:{get:d,set:function(a){if(0>a||a>T)throw new RangeError("Message ID "+a+" is outside the valid range.");d()||(h=a)},configurable:!0},
stack:{get:function(){var a=this.toString();f&&(a+="\n"+f);c&&c.stack&&(a+="\nCaused by "+c.stack);return a},configurable:!0}})},setEntity:function(a){!a||this.masterToken||this.entityAuthenticationData||(a instanceof ya?this.masterToken=a:a instanceof Wa&&(this.entityAuthenticationData=a));return this},setUser:function(a){!a||this.userIdToken||this.userAuthenticationData||(a instanceof yb?this.userIdToken=a:a instanceof kb&&(this.userAuthenticationData=a));return this},setMessageId:function(a){this.messageId=
a;return this},toString:function(){return this.name+": "+this.message}})})();var F=p.extend({init:function Rd(a,b,c){Rd.base.call(this,a,b,c);Object.defineProperties(this,{name:{value:"MslCryptoException",writable:!1,configurable:!0}})}}),G=p.extend({init:function Sd(a,b,c){Sd.base.call(this,a,b,c);Object.defineProperties(this,{name:{value:"MslEncodingException",writable:!1,configurable:!0}})}}),Ha=p.extend({init:function Td(a,b,c){Td.base.call(this,a,b,c);Object.defineProperties(this,{name:{value:"MslEntityAuthException",
writable:!1,configurable:!0}})}}),Aa;(function(){Aa=x.Class.create(Error());Aa.mixin({init:function(a,b,c){Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor);var d=this.stack;Object.defineProperties(this,{message:{value:a,writable:!1,configurable:!1},cause:{value:b,writable:!1,configurable:!1},requestCause:{value:c,writable:!1,configurable:!1},name:{value:"MslErrorResponseException",writable:!1,configurable:!0},stack:{get:function(){var a=this.toString();d&&(a+="\n"+d);b&&b.stack&&
(a+="\nCaused by "+b.stack);return a},configurable:!0}})},toString:function(){return this.name+": "+this.message}})})();var ha;(function(){ha=x.Class.create(Error());ha.mixin({init:function(a,b){Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor);var c=this.stack;Object.defineProperties(this,{message:{value:a,writable:!1,configurable:!1},cause:{value:b,writable:!1,configurable:!1},name:{value:"MslIoException",writable:!1,configurable:!0},stack:{get:function(){var a=this.toString();
c&&(a+="\n"+c);b&&b.stack&&(a+="\nCaused by "+b.stack);return a},configurable:!0}})},toString:function(){return this.name+": "+this.message}})})();var E;(function(){E=x.Class.create(Error());E.mixin({init:function(a,b){Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor);var c=this.stack;Object.defineProperties(this,{message:{value:a,writable:!1,configurable:!1},cause:{value:b,writable:!1,configurable:!1},name:{value:"MslInternalException",writable:!1,configurable:!0},stack:{get:function(){var a=
this.toString();c&&(a+="\n"+c);b&&b.stack&&(a+="\nCaused by "+b.stack);return a},configurable:!0}})},toString:function(){return this.name+": "+this.message}})})();var V=p.extend({init:function Ud(a,b,c){Ud.base.call(this,a,b,c);Object.defineProperties(this,{name:{value:"MslKeyExchangeException",writable:!1,configurable:!0}})}}),wa=p.extend({init:function Vd(a,b){Vd.base.call(this,a);Object.defineProperties(this,{masterToken:{value:b,writable:!1,configurable:!1},name:{value:"MslMasterTokenException",
writable:!1,configurable:!0}})}}),X=p.extend({init:function Wd(a,b,c){Wd.base.call(this,a,b,c);Object.defineProperties(this,{name:{value:"MslMessageException",writable:!1,configurable:!0}})}}),d=p.extend({init:function Xd(a,b,c){Xd.base.call(this,a,b,c);Object.defineProperties(this,{name:{value:"MslUserAuthException",writable:!1,configurable:!0}})}}),h;(function(){h=x.Class.create(Error());h.mixin({init:function(a,b){Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor);var c=this.stack;
Object.defineProperties(this,{message:{value:a,writable:!1,configurable:!1},cause:{value:b,writable:!1,configurable:!1},name:{value:"MslInterruptedException",writable:!1,configurable:!0},stack:{get:function(){var a=this.toString();c&&(a+="\n"+c);b&&b.stack&&(a+="\nCaused by "+b.stack);return a},configurable:!0}})},toString:function(){return this.name+": "+this.message}})})();var y,sa,bc;(function(){function a(b){return"undefined"===typeof b?!1:b}function b(a){return a&&a.length?(sa===c.V2014_02&&
(a=a.map(function(a){return"wrap"==a?"wrapKey":"unwrap"==a?"unwrapKey":a})),a):sa===c.V2014_02?"encrypt decrypt sign verify deriveKey wrapKey unwrapKey".split(" "):"encrypt decrypt sign verify deriveKey wrap unwrap".split(" ")}var c=bc={LEGACY:1,V2014_01:2,V2014_02:3,LATEST:3};Object.freeze(bc);sa=c.LATEST;y={encrypt:function(a,b,l){switch(sa){case c.LEGACY:return new ka(function(k,g){var c=da.encrypt(a,b,l);c.oncomplete=function(a){k(a.target.result)};c.onerror=function(a){g(a)}});case c.V2014_01:case c.V2014_02:return ja.encrypt(a,
b,l);default:throw Error("Unsupported Web Crypto version "+WEB_CRYPTO_VERSION+".");}},decrypt:function(a,b,l){switch(sa){case c.LEGACY:return new ka(function(k,g){var c=da.decrypt(a,b,l);c.oncomplete=function(a){k(a.target.result)};c.onerror=function(a){g(a)}});case c.V2014_01:case c.V2014_02:return ja.decrypt(a,b,l);default:throw Error("Unsupported Web Crypto version "+WEB_CRYPTO_VERSION+".");}},sign:function(a,b,l){switch(sa){case c.LEGACY:return new ka(function(k,g){var c=da.sign(a,b,l);c.oncomplete=
function(a){k(a.target.result)};c.onerror=function(a){g(a)}});case c.V2014_01:case c.V2014_02:return ja.sign(a,b,l);default:throw Error("Unsupported Web Crypto version "+WEB_CRYPTO_VERSION+".");}},verify:function(a,b,l,k){switch(sa){case c.LEGACY:return new ka(function(g,c){var m=da.verify(a,b,l,k);m.oncomplete=function(a){g(a.target.result)};m.onerror=function(a){c(a)}});case c.V2014_01:case c.V2014_02:return ja.verify(a,b,l,k);default:throw Error("Unsupported Web Crypto version "+WEB_CRYPTO_VERSION+
".");}},digest:function(a,b){switch(sa){case c.LEGACY:return new ka(function(c,k){var g=ja.digest(a,b);g.oncomplete=function(a){c(a.target.result)};g.onerror=function(a){k(a)}});case c.V2014_01:case c.V2014_02:return ja.digest(a,b);default:throw Error("Unsupported Web Crypto version "+WEB_CRYPTO_VERSION+".");}},generateKey:function(d,L,l){var k=a(L),g=b(l);switch(sa){case c.LEGACY:return new ka(function(a,b){var c=da.generateKey(d,k,g);c.oncomplete=function(b){a(b.target.result)};c.onerror=function(a){b(a)}});
case c.V2014_01:case c.V2014_02:return ja.generateKey(d,k,g);default:throw Error("Unsupported Web Crypto version "+WEB_CRYPTO_VERSION+".");}},deriveKey:function(d,L,l,k,g){var u=a(k),m=b(g);switch(sa){case c.LEGACY:return new ka(function(a,b){var k=da.deriveKey(d,L,l,u,m);k.oncomplete=function(b){a(b.target.result)};k.onerror=function(a){b(a)}});case c.V2014_01:case c.V2014_02:return ja.deriveKey(d,L,l,u,m);default:throw Error("Unsupported Web Crypto version "+WEB_CRYPTO_VERSION+".");}},importKey:function(d,
L,l,k,g){var u=a(k),m=b(g);switch(sa){case c.LEGACY:return new ka(function(a,b){var k=da.importKey(d,L,l,u,m);k.oncomplete=function(b){a(b.target.result)};k.onerror=function(a){b(a)}});case c.V2014_01:case c.V2014_02:return ja.importKey(d,L,l,u,m);default:throw Error("Unsupported Web Crypto version "+WEB_CRYPTO_VERSION+".");}},exportKey:function(a,b){switch(sa){case c.LEGACY:return new ka(function(c,k){var g=da.exportKey(a,b);g.oncomplete=function(a){c(a.target.result)};g.onerror=function(a){k(a)}});
case c.V2014_01:case c.V2014_02:return ja.exportKey(a,b);default:throw Error("Unsupported Web Crypto version "+WEB_CRYPTO_VERSION+".");}},wrapKey:function(a,b,l,k){switch(sa){case c.LEGACY:return new ka(function(a,c){var m=ja.wrapKey(b,l,k);m.oncomplete=function(b){a(b.target.result)};m.onerror=function(a){c(a)}});case c.V2014_01:case c.V2014_02:return ja.wrapKey(a,b,l,k);default:throw Error("Unsupported Web Crypto version "+WEB_CRYPTO_VERSION+".");}},unwrapKey:function(d,L,l,k,g,u,m){switch(sa){case c.LEGACY:return new ka(function(a,
b){var g=ja.unwrapKey(L,k,l);g.oncomplete=function(b){a(b.target.result)};g.onerror=function(a){b(a)}});case c.V2014_01:case c.V2014_02:return ja.unwrapKey(d,L,l,k,g,a(u),b(m));default:throw Error("Unsupported Web Crypto version "+WEB_CRYPTO_VERSION+".");}}}})();var Xa=["encrypt","decrypt"],Qa=["wrap","unwrap"],Ya=["sign","verify"],Yd=["deriveKey"],Za={name:"AES-KW"},$a={name:"AES-CBC"},ab={name:"HMAC",hash:{name:"SHA-256"}},Pb={name:"RSA-OAEP",hash:{name:"SHA-1"}},cc={name:"RSAES-PKCS1-v1_5"},Hc=
{name:"RSASSA-PKCS1-v1_5"},Zd={name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},$d={name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-1"}},dc={name:"NFLX-DH"},ec,Ga,bb;(function(){ec=x.Class.create({init:function(c,d,e){function h(a){b(d,function(){var b=a?w(a):void 0;Object.defineProperties(L,{rawKey:{value:c,writable:!1,configurable:!1},keyData:{value:a,writable:!1,configurable:!1},keyDataB64:{value:b,writable:!1,configurable:!1}});return this},L)}var L=this;b(d,function(){if(!c||"object"!=typeof c)throw new F(a.INVALID_SYMMETRIC_KEY);
!e&&c.extractable?y.exportKey("raw",c).then(function(a){h(new Uint8Array(a))},function(b){d.error(new F(a.KEY_EXPORT_ERROR,"raw"))}):h(e)},L)},size:function(){return this.keyData.length},toByteArray:function(){return this.keyData},toBase64:function(){return this.keyDataB64}});Ga=function(a,b){new ec(a,b)};bb=function(c,d,e,h){b(h,function(){try{c="string"==typeof c?K(c):c}catch(b){throw new F(a.INVALID_SYMMETRIC_KEY,"keydata "+c,b);}y.importKey("raw",c,d,!0,e).then(function(a){new ec(a,h,c)},function(b){h.error(new F(a.INVALID_SYMMETRIC_KEY))})})}})();
var Qb,nb,fc;(function(){Qb=x.Class.create({init:function(c,d,e){function h(a){b(d,function(){Object.defineProperties(L,{rawKey:{value:c,writable:!1,configurable:!1},encoded:{value:a,writable:!1,configurable:!1}});return this},L)}var L=this;b(d,function(){if(!c||"object"!=typeof c||"public"!=c.type)throw new TypeError("Only original public crypto keys are supported.");!e&&c.extractable?y.exportKey("spki",c).then(function(a){h(new Uint8Array(a))},function(b){d.error(new F(a.KEY_EXPORT_ERROR,"spki"))}):
h(e)})},getEncoded:function(){return this.encoded}});nb=function(a,b){new Qb(a,b)};fc=function(c,d,e,h){b(h,function(){try{c="string"==typeof c?K(c):c}catch(b){throw new F(a.INVALID_PUBLIC_KEY,"spki "+c,b);}y.importKey("spki",c,d,!0,e).then(function(a){new Qb(a,h,c)},function(b){h.error(new F(a.INVALID_PUBLIC_KEY))})})}})();var gc,zb;(function(){gc=x.Class.create({init:function(c,d,e){function h(a){b(d,function(){Object.defineProperties(L,{rawKey:{value:c,writable:!1,configurable:!1},encoded:{value:a,
writable:!1,configurable:!1}});return this},L)}var L=this;b(d,function(){if(!c||"object"!=typeof c||"private"!=c.type)throw new TypeError("Only original private crypto keys are supported.");!e&&c.extractable?y.exportKey("pkcs8",c).then(function(a){h(new Uint8Array(a))},function(b){d.error(new F(a.KEY_EXPORT_ERROR,"pkcs8"))}):h(e)})},getEncoded:function(){return this.encoded}});zb=function(a,b){new gc(a,b)}})();var cb,Rb,hc,ic;(function(){var c=ic={V1:1,V2:2};cb=x.Class.create({init:function(a,b,d){var L;
switch(a){case c.V1:L=d;break;case c.V2:L={};L.version=a;L.algorithm=b;L.signature=w(d);L=Z(JSON.stringify(L),W);break;default:throw new E("Signature envelope version "+a+" encoding unsupported.");}Object.defineProperties(this,{version:{value:a,writable:!1,enumerable:!1,configurable:!1},algorithm:{value:b,writable:!1,configurable:!1},signature:{value:d,writable:!1,configurable:!1},bytes:{value:L,writable:!1,configurable:!1}})}});Rb=function(){var a,d,e,L;2==arguments.length?(a=c.V1,d=arguments[0],
e=null,L=arguments[1]):3==arguments.length&&(a=c.V2,e=arguments[0],d=arguments[1],L=arguments[2]);b(L,function(){return new cb(a,e,d)})};hc=function(d,e,h){b(h,function(){if(e)switch(e){case c.V1:return new cb(c.V1,null,d);case c.V2:try{var b=ca(d,W),l=JSON.parse(b),k=parseInt(l.version),g=l.algorithm,u=l.signature;if(!k||"number"!==typeof k||k!=k||"string"!==typeof g||"string"!==typeof u)throw new G(a.JSON_PARSE_ERROR,"signature envelope "+w(d));if(c.V2!=k)throw new F(a.UNSUPPORTED_SIGNATURE_ENVELOPE,
"signature envelope "+w(d));var m=Ma(g);if(!m)throw new F(a.UNIDENTIFIED_ALGORITHM,"signature envelope "+w(d));var v=K(u);if(!v)throw new F(a.INVALID_SIGNATURE,"signature envelope "+Base64Util.encode(d));return new cb(c.V2,m,v)}catch(H){if(H instanceof SyntaxError)throw new G(a.JSON_PARSE_ERROR,"signature envelope "+w(d),H);throw H;}default:throw new F(a.UNSUPPORTED_SIGNATURE_ENVELOPE,"signature envelope "+w(d));}try{b=ca(d,W),l=JSON.parse(b)}catch(n){l=null}if(l&&l.version){if(b=l.version,"number"!==
typeof b||b!==b)b=c.V1}else b=c.V1;switch(b){case c.V1:return new cb(b,null,d);case c.V2:m=l.algorithm;u=l.signature;if("string"!==typeof m||"string"!==typeof u)return new cb(c.V1,null,d);m=Ma(m);if(!m)return new cb(c.V1,null,d);try{v=K(u)}catch(I){return new cb(c.V1,null,d)}return new cb(b,m,v);default:throw new F(a.UNSUPPORTED_SIGNATURE_ENVELOPE,"signature envelope "+d);}})}})();var jc,kc,lc,mc;(function(){var c=mc={V1:1,V2:2};jc=x.Class.create({init:function(a,d,e,L){b(L,function(){var b=c.V1,
k=a,g=null,u;for(u in va)if(va[u]==a){b=c.V2;k=null;g=a;break}Object.defineProperties(this,{version:{value:b,writable:!1,enumerable:!1,configurable:!1},keyId:{value:k,writable:!1,configurable:!1},cipherSpec:{value:g,writable:!1,configurable:!1},iv:{value:d,writable:!1,configurable:!1},ciphertext:{value:e,writable:!1,configurable:!1}});return this},this)},toJSON:function(){var a={};switch(this.version){case c.V1:a.keyid=this.keyId;this.iv&&(a.iv=w(this.iv));a.ciphertext=w(this.ciphertext);a.sha256=
"AA==";break;case c.V2:a.version=this.version;a.cipherspec=this.cipherSpec;this.iv&&(a.iv=w(this.iv));a.ciphertext=w(this.ciphertext);break;default:throw new E("Ciphertext envelope version "+this.version+" encoding unsupported.");}return a}});kc=function(a,b,c,d){new jc(a,b,c,d)};lc=function(d,e,h){b(h,function(){var b=d.keyid,l=d.cipherspec,k=d.iv,g=d.ciphertext,u=d.sha256;if(!e)if((e=d.version)&&"number"===typeof e&&e===e){var m=!1,v;for(v in c)if(c[v]==e){m=!0;break}if(!m)throw new F(a.UNIDENTIFIED_CIPHERTEXT_ENVELOPE,
"ciphertext envelope "+JSON.stringify(d));}else e=c.V1;switch(e){case c.V1:if("string"!==typeof b||k&&"string"!==typeof k||"string"!==typeof g||"string"!==typeof u)throw new G(a.JSON_PARSE_ERROR,"ciphertext envelope "+JSON.stringify(d));break;case c.V2:v=d.version;if(v!=c.V2)throw new F(a.UNIDENTIFIED_CIPHERTEXT_ENVELOPE,"ciphertext envelope "+JSON.stringify(d));if("string"!==typeof l||k&&"string"!==typeof k||"string"!==typeof g)throw new G(a.JSON_PARSE_ERROR,"ciphertext envelope "+JSON.stringify(d));
l=Ob(l);if(!l)throw new F(a.UNIDENTIFIED_CIPHERSPEC,"ciphertext envelope "+JSON.stringify(d));b=l;break;default:throw new F(a.UNSUPPORTED_CIPHERTEXT_ENVELOPE,"ciphertext envelope "+JSON.stringify(d));}try{k&&(k=K(k)),g=K(g)}catch(H){throw new F(a.CIPHERTEXT_ENVELOPE_PARSE_ERROR,"encryption envelope "+JSON.stringify(d),H);}new jc(b,k,g,h)})}})();var lb=x.Class.create({encrypt:function(a,b){},decrypt:function(a,b){},wrap:function(a,b){},unwrap:function(a,b,c,d){},sign:function(a,b){},verify:function(a,
b,c){}}),Ab=lb.extend({encrypt:function(a,b){b.result(a)},decrypt:function(a,b){b.result(a)},wrap:function(a,b){b.result(a)},unwrap:function(a,b,c,d){d.result(a)},sign:function(a,b){b.result(new Uint8Array(0))},verify:function(a,b,c){c.result(!0)}}),Sb,Tb;(function(){var c=Tb={ENCRYPT_DECRYPT_OAEP:1,ENCRYPT_DECRYPT_PKCS1:2,WRAP_UNWRAP_OAEP:3,WRAP_UNWRAP_PKCS1:4,SIGN_VERIFY:5};Sb=lb.extend({init:function Ea(a,b,l,k,g){Ea.base.call(this);l&&(l=l.rawKey);k&&(k=k.rawKey);Object.defineProperties(this,
{id:{value:b,writable:!1,enumerable:!1,configurable:!1},privateKey:{value:l,writable:!1,enumerable:!1,configurable:!1},publicKey:{value:k,writable:!1,enumerable:!1,configurable:!1},transform:{value:g==c.ENCRYPT_DECRYPT_PKCS1?cc:g==c.ENCRYPT_DECRYPT_OAEP?Pb:"nullOp",writable:!1,enumerable:!1,configurable:!1},wrapTransform:{value:g==c.WRAP_UNWRAP_PKCS1?cc:g==c.WRAP_UNWRAP_OAEP?Pb:"nullOp",writable:!1,enumerable:!1,configurable:!1},algo:{value:g==c.SIGN_VERIFY?Zd:"nullOp",writable:!1,enumerable:!1,configurable:!1}})},
encrypt:function(c,d){var e=this;b(d,function(){if("nullOp"==this.transform)return c;if(!this.publicKey)throw new F(a.ENCRYPT_NOT_SUPPORTED,"no public key");if(0==c.length)return c;y.encrypt(e.transform,e.publicKey,c).then(function(b){kc(e.id,null,new Uint8Array(b),{result:function(b){try{var g=JSON.stringify(b);d.result(Z(g,W))}catch(c){d.error(new F(a.ENCRYPT_ERROR,null,c))}},error:function(b){b instanceof p||(b=new F(a.ENCRYPT_ERROR,null,b));d.error(b)}})},function(b){d.error(new F(a.ENCRYPT_ERROR))})},
this)},decrypt:function(c,d){var e=this;b(d,function(){if("nullOp"==this.transform)return c;if(!this.privateKey)throw new F(a.DECRYPT_NOT_SUPPORTED,"no private key");if(0==c.length)return c;var b;try{var k=ca(c,W);b=JSON.parse(k)}catch(g){if(g instanceof SyntaxError)throw new F(a.CIPHERTEXT_ENVELOPE_PARSE_ERROR,null,g);throw new F(a.DECRYPT_ERROR,null,g);}lc(b,mc.V1,{result:function(b){try{if(b.keyId!=e.id)throw new F(a.ENVELOPE_KEY_ID_MISMATCH);y.decrypt(e.transform,e.privateKey,b.ciphertext).then(function(a){d.result(new Uint8Array(a))},
function(b){d.error(new F(a.DECRYPT_ERROR))})}catch(k){k instanceof p?d.error(k):d.error(new F(a.DECRYPT_ERROR,null,k))}},error:function(b){b instanceof G&&(b=new F(a.CIPHERTEXT_ENVELOPE_ENCODE_ERROR,null,b));b instanceof p||(b=new F(a.DECRYPT_ERROR,null,b));d.error(b)}})},this)},wrap:function(c,d){b(d,function(){if("nullOp"==this.wrapTransform||!this.publicKey)throw new F(a.WRAP_NOT_SUPPORTED,"no public key");y.wrapKey("jwk",c.rawKey,this.publicKey,this.wrapTransform).then(function(a){d.result(new Uint8Array(a))},
function(b){d.error(new F(a.WRAP_ERROR))})},this)},unwrap:function(c,d,e,l){function k(k){b(l,function(){switch(k.type){case "secret":Ga(k,l);break;case "public":nb(k,l);break;case "private":zb(k,l);break;default:throw new F(a.UNSUPPORTED_KEY,"type: "+k.type);}})}b(l,function(){if("nullOp"==this.wrapTransform||!this.privateKey)throw new F(a.UNWRAP_NOT_SUPPORTED,"no private key");y.unwrapKey("jwk",c,this.privateKey,this.privateKey.algorithm,d,!1,e).then(k,function(b){l.error(new F(a.UNWRAP_ERROR))})},
this)},sign:function(c,d){b(d,function(){if("nullOp"==this.algo)return new Uint8Array(0);if(!this.privateKey)throw new F(a.SIGN_NOT_SUPPORTED,"no private key");y.sign(this.algo,this.privateKey,c).then(function(a){Rb(new Uint8Array(a),{result:function(a){d.result(a.bytes)},error:d.error})},function(b){d.error(new F(a.SIGNATURE_ERROR))})},this)},verify:function(c,d,e){var l=this;b(e,function(){if("nullOp"==this.algo)return!0;if(!this.publicKey)throw new F(a.VERIFY_NOT_SUPPORTED,"no public key");hc(d,
ic.V1,{result:function(k){b(e,function(){var b=e.result;y.verify(this.algo,this.publicKey,k.signature,c).then(b,function(b){e.error(new F(a.SIGNATURE_ERROR))})},l)},error:e.error})},this)}})})();var Ub;(function(){Ub=lb.extend({init:function Ia(a,b,c,l,k){Ia.base.call(this);c=c&&c.rawKey;l=l&&l.rawKey;k=k&&k.rawKey;Object.defineProperties(this,{ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},id:{value:b,writable:!1,enumerable:!1,configurable:!1},encryptionKey:{value:c,writable:!1,enumerable:!1,
configurable:!1},hmacKey:{value:l,writable:!1,enumerable:!1,configurable:!1},wrapKey:{value:k,writable:!1,enumerable:!1,configurable:!1}})},encrypt:function(c,d){var e=this;b(d,function(){if(!this.encryptionKey)throw new F(a.ENCRYPT_NOT_SUPPORTED,"no encryption/decryption key");if(0==c.length)return c;var b=new Uint8Array(16);this.ctx.getRandom().nextBytes(b);y.encrypt({name:$a.name,iv:b},e.encryptionKey,c).then(function(c){kc(e.id,b,new Uint8Array(c),{result:function(b){try{var c=JSON.stringify(b);
d.result(Z(c,W))}catch(l){d.error(new F(a.ENCRYPT_ERROR,null,l))}},error:function(b){b instanceof p||(b=new F(a.ENCRYPT_ERROR,null,b));d.error(b)}})},function(b){d.error(new F(a.ENCRYPT_ERROR))})},this)},decrypt:function(c,d){var e=this;b(d,function(){if(!this.encryptionKey)throw new F(a.DECRYPT_NOT_SUPPORTED,"no encryption/decryption key");if(0==c.length)return c;var b;try{var l=ca(c,W);b=JSON.parse(l)}catch(k){if(k instanceof SyntaxError)throw new F(a.CIPHERTEXT_ENVELOPE_PARSE_ERROR,null,k);throw new F(a.DECRYPT_ERROR,
null,k);}lc(b,mc.V1,{result:function(b){try{if(b.keyId!=e.id)throw new F(a.ENVELOPE_KEY_ID_MISMATCH);y.decrypt({name:$a.name,iv:b.iv},e.encryptionKey,b.ciphertext).then(function(a){d.result(new Uint8Array(a))},function(){d.error(new F(a.DECRYPT_ERROR))})}catch(c){c instanceof p?d.error(c):d.error(new F(a.DECRYPT_ERROR,null,c))}},error:function(b){b instanceof G&&(b=new F(a.CIPHERTEXT_ENVELOPE_ENCODE_ERROR,null,b));b instanceof p||(b=new F(a.DECRYPT_ERROR,null,b));d.error(b)}})},this)},wrap:function(c,
d){b(d,function(){if(!this.wrapKey)throw new F(a.WRAP_NOT_SUPPORTED,"no wrap/unwrap key");y.wrapKey("raw",c.rawKey,this.wrapKey,this.wrapKey.algorithm).then(function(a){d.result(new Uint8Array(a))},function(b){d.error(new F(a.WRAP_ERROR))})},this)},unwrap:function(c,d,e,L){function l(c){b(L,function(){switch(c.type){case "secret":Ga(c,L);break;case "public":nb(c,L);break;case "private":zb(c,L);break;default:throw new F(a.UNSUPPORTED_KEY,"type: "+c.type);}})}b(L,function(){if(!this.wrapKey)throw new F(a.UNWRAP_NOT_SUPPORTED,
"no wrap/unwrap key");y.unwrapKey("raw",c,this.wrapKey,this.wrapKey.algorithm,d,!1,e).then(function(a){l(a)},function(b){L.error(new F(a.UNWRAP_ERROR))})},this)},sign:function(c,d){var e=this;b(d,function(){if(!this.hmacKey)throw new F(a.SIGN_NOT_SUPPORTED,"no HMAC key.");y.sign(ab,this.hmacKey,c).then(function(a){b(d,function(){Rb(new Uint8Array(a),{result:function(a){d.result(a.bytes)},error:d.error})},e)},function(){d.error(new F(a.HMAC_ERROR))})},this)},verify:function(c,d,e){var L=this;b(e,function(){if(!this.hmacKey)throw new F(a.VERIFY_NOT_SUPPORTED,
"no HMAC key.");hc(d,ic.V1,{result:function(d){b(e,function(){var b=e.result;y.verify(ab,this.hmacKey,d.signature,c).then(b,function(b){e.error(new F(a.HMAC_ERROR))})},L)},error:e.error})},this)}})})();var na=Ub.extend({init:function Ia(b,c,d,l,k){if(d||l||k)Ia.base.call(this,b,d+"_"+c.sequenceNumber,l,k,null);else{if(!c.isDecrypted())throw new wa(a.MASTERTOKEN_UNTRUSTED,c);Ia.base.call(this,b,c.identity+"_"+c.sequenceNumber,c.encryptionKey,c.hmacKey,null)}}}),ae=lb.extend({encrypt:function(a,b){b.result(a)},
decrypt:function(a,b){b.result(a)},wrap:function(a,b){b.error(new E("Wrap is unsupported by the MSL token crypto context."))},unwrap:function(a,b,c,d){d.error(new E("Unwrap is unsupported by the MSL token crypto context."))},sign:function(a,b){b.result(new Uint8Array(0))},verify:function(a,b,c){c.result(!1)}}),db,eb;(function(){var c=eb={RSA_OAEP:Pb.name,A128KW:Za.name};t="A128GCM";db=x.Class.create({init:function(a,b,d,l,k){switch(b){case c.RSA_OAEP:k=k&&(k.rawKey||k);l=l&&(l.rawKey||l);break;case c.A128KW:k=
l=l&&(l.rawKey||l);break;default:throw new E("Unsupported algorithm: "+b);}Object.defineProperties(this,{_ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},_algo:{value:b,writable:!1,enumerable:!1,configurable:!1},_enc:{value:d,writable:!1,enumerable:!1,configurable:!1},_wrapKey:{value:k,writable:!1,enumerable:!1,configurable:!1},_unwrapKey:{value:l,writable:!1,enumerable:!1,configurable:!1}})},encrypt:function(b,c){c.error(new F(a.ENCRYPT_NOT_SUPPORTED))},decrypt:function(b,c){c.error(new F(a.DECRYPT_NOT_SUPPORTED))},
wrap:function(c,d){b(d,function(){y.wrapKey("jwe+jwk",c.rawKey,this._wrapKey,this._wrapKey.algorithm).then(function(a){d.result(new Uint8Array(a))},function(b){d.error(new F(a.WRAP_ERROR))})},this)},unwrap:function(c,d,e,l){function k(c){b(l,function(){switch(c.type){case "secret":Ga(c,l);break;case "public":nb(c,l);break;case "private":zb(c,l);break;default:throw new F(a.UNSUPPORTED_KEY,"type: "+c.type);}})}b(l,function(){y.unwrapKey("jwe+jwk",c,this._unwrapKey,this._unwrapKey.algorithm,d,!1,e).then(function(a){k(a)},
function(){l.error(new F(a.UNWRAP_ERROR))})},this)},sign:function(b,c){c.error(new F(a.SIGN_NOT_SUPPORTED))},verify:function(b,c,d){d.error(new F(a.VERIFY_NOT_SUPPORTED))}})})();var Ic;(function(){Ic=lb.extend({init:function Ea(a,b){Ea.base.call(this);Object.defineProperties(this,{privateKey:{value:b,writable:!1,enumerable:!1,configurable:!1}})},encrypt:function(a,c){b(c,function(){return a},this)},decrypt:function(c,d){b(d,function(){throw new F(a.WRAP_NOT_SUPPORTED,"ECC does not decrypt");},this)},
wrap:function(c,d){b(d,function(){throw new F(a.WRAP_NOT_SUPPORTED,"ECC does not wrap");},this)},unwrap:function(c,d,e,l){b(l,function(){throw new F(a.UNWRAP_NOT_SUPPORTED,"ECC does not unwrap");},this)},sign:function(c,d){b(d,function(){y.sign({name:"ECC",hash:"SHA-256"},this.privateKey,c).then(function(a){Rb(new Uint8Array(a),{result:function(a){d.result(a.bytes)},error:d.error})},function(b){d.error(new F(a.SIGNATURE_ERROR))})},this)},verify:function(c,d,e){b(e,function(){throw new F(a.VERIFY_NOT_SUPPORTED,
"ECC does not verify");},this)}})})();var ga,Jc;(function(){var a={};ga=function(b,c,d){Object.defineProperties(this,{name:{value:b,writable:!1,configurable:!1},encrypts:{value:c,writable:!1,configurable:!1},protectsIntegrity:{value:d,writable:!1,configurable:!1}});a[b]=this};x.Class.mixin(ga,{PSK:new ga("PSK",!0,!0),X509:new ga("X509",!1,!0),RSA:new ga("RSA",!1,!0),NONE:new ga("NONE",!1,!1)});Object.freeze(ga);Jc=function(b){return a[b]?a[b]:null}})();var Wa,Kc;(function(){Wa=x.Class.create({init:function(a){Object.defineProperties(this,
{scheme:{value:a,writable:!1,configurable:!1}})},getIdentity:function(){},getAuthData:function(){},equals:function(a){return this===a?!0:a instanceof Wa?this.scheme==a.scheme:!1},toJSON:function(){var a={};a.scheme=this.scheme.name;a.authdata=this.getAuthData();return a}});Kc=function(b,c){var d=c.scheme,e=c.authdata;if("string"!==typeof d||"object"!==typeof e)throw new G(a.JSON_PARSE_ERROR,"entityauthdata "+JSON.stringify(c));var l=Jc(d);if(!l)throw new Ha(a.UNIDENTIFIED_ENTITYAUTH_SCHEME,d);d=b.getEntityAuthenticationFactory(l);
if(!d)throw new Ha(a.ENTITYAUTH_FACTORY_NOT_FOUND,l.name);return d.createData(b,e)}})();var Ra,Lc;(function(){Ra=Wa.extend({init:function Ea(a){Ea.base.call(this,ga.PSK);Object.defineProperties(this,{identity:{value:a,writable:!1}})},getIdentity:function(){return this.identity},getAuthData:function(){var a={};a.identity=this.identity;return a},equals:function la(a){return this===a?!0:a instanceof Ra?la.base.call(this,this,a)&&this.identity==a.identity:!1}});Lc=function(b){var c=b.identity;if(!c)throw new G(a.JSON_PARSE_ERROR,
"psk authdata"+JSON.stringify(b));return new Ra(c)}})();var Vb,Mc;(function(){Vb=Wa.extend({init:function Ea(a,b){Ea.base.call(this,ga.RSA);Object.defineProperties(this,{identity:{value:a,writable:!1,configurable:!1},publicKeyId:{value:b,writable:!1,configurable:!1}})},getIdentity:function(){return this.identity},getAuthData:function(){var a={};a.identity=this.identity;a.pubkeyid=this.publicKeyId;return a},equals:function la(a){return this===a?!0:a instanceof Vb?la.base.call(this,this,a)&&this.identity==
a.identity&&this.publicKeyId==a.publicKeyId:!1}});Mc=function(b){var c=b.identity,d=b.pubkeyid;if(!c||"string"!==typeof c||!d||"string"!==typeof d)throw new G(a.JSON_PARSE_ERROR,"RSA authdata"+JSON.stringify(b));return new Vb(c,d)}})();var ob,Nc;(function(){ob=Wa.extend({init:function Ea(a){Ea.base.call(this,ga.NONE);Object.defineProperties(this,{identity:{value:a,writable:!1}})},getIdentity:function(){return this.identity},getAuthData:function(){var a={};a.identity=this.identity;return a},equals:function la(a){return this===
a?!0:a instanceof ob?la.base.call(this,this,a)&&this.identity==a.identity:!1}});Nc=function(b){var c=b.identity;if(!c)throw new G(a.JSON_PARSE_ERROR,"Unauthenticated authdata"+JSON.stringify(b));return new ob(c)}})();var Bb=x.Class.create({init:function(a){Object.defineProperties(this,{scheme:{value:a,writable:!1,configurable:!1}})},createData:function(a,b){},getCryptoContext:function(a,b){}}),Oc;Oc=Bb.extend({init:function Ea(a){Ea.base.call(this,ga.PSK);Object.defineProperties(this,{localIdentity:{value:a,
writable:!1,enumerable:!1,configurable:!1}})},createData:function(a,b){return Lc(b)},getCryptoContext:function(b,c){if(!(c instanceof Ra))throw new E("Incorrect authentication data type "+JSON.stringify(c)+".");if(c.getIdentity()!=this.localIdentity)throw(new Ha(a.ENTITY_NOT_FOUND,"psk "+c.identity)).setEntity(c);return new Ab}});var be=x.Class.create({init:function(){Object.defineProperties(this,{publicKeys:{value:{},writable:!0,enumerable:!1,configurable:!1},privateKeys:{value:{},writable:!0,enumerable:!1,
configurable:!1}})},getIdentities:function(){for(var a=Object.keys(this.publicKeys).concat(Object.keys(this.privateKeys)),b=0;b<a.length;++b)for(var c=0;c<a.length;++b)a[b]==a[c]&&a.splice(c--,1);return a},addPublicKey:function(a,b){if(!(b instanceof Qb))throw new E("Incorrect key data type "+b+".");this.publicKeys[a]=b},removePublicKey:function(a){delete this.publicKeys[a]},getPublicKey:function(a){return this.publicKeys[a]},addPrivateKey:function(a,b){if(!(b instanceof gc))throw new E("Incorrect key data type "+
b+".");this.privateKeys[a]=b},removePrivateKey:function(a){delete this.privateKeys[a]},getPrivateKey:function(a){return this.privateKeys[a]},clear:function(){this.publicKeys={};this.privateKeys={}}}),Pc=Bb.extend({init:function la(a,b){la.base.call(this,ga.RSA);Object.defineProperties(this,{keyPairId:{value:a,writable:!1,enumerable:!1,configurable:!1},store:{value:b,writable:!1,enumerable:!1,configurable:!1}})},createData:function(a,b){return Mc(b)},getCryptoContext:function(b,c){if(!(c instanceof
Vb))throw new E("Incorrect authentication data type "+c+".");var d=c.identity,k=c.publicKeyId,g=this.store.getPublicKey(k),u=this.store.getPrivateKey(k);if(k==this.keyPairId&&!u)throw(new Ha(a.RSA_PRIVATEKEY_NOT_FOUND,k)).setEntity(c);if(k!=this.keyPairId&&!g)throw(new Ha(a.RSA_PUBLICKEY_NOT_FOUND,k)).setEntity(c);return new Sb(b,d,u,g,Tb.SIGN_VERIFY)}}),Qc=Bb.extend({init:function L(){L.base.call(this,ga.NONE)},createData:function(a,b){return Nc(b)},getCryptoContext:function(a,b){if(!(b instanceof
ob))throw new E("Incorrect authentication data type "+JSON.stringify(b)+".");return new Ab}}),Wb;(function(){Wb=Wa.extend({init:function l(a,b,c){l.base.call(this,ga.X509);b&&(a=b.getSubjectString());Object.defineProperties(this,{identity:{value:a,writable:!1,configurable:!1},x509cert:{value:b,writable:!1,configurable:!1},x509chain:{value:c,writable:!1,configurable:!1}})},getIdentity:function(){return this.identity},getAuthData:function(){var a={};if(this.x509cert){var b=CryptoJS.enc.Hex.parse(this.x509cert.hex),
b=CryptoJS.enc.Base64.stringify(b);a.x509certificate=b}else this.x509chain&&(a.x509chain=this.x509chain);a.identity=this.identity;return a},equals:function k(a){return this===a?!0:a instanceof Wb?k.base.call(this,this,a)&&this.identity===a.identity&&this.x509cert===a.x509cert&&this.x509chain===a.x509chain:!1}})})();var Rc=x.Class.create({abort:function(){},close:function(a,b){},mark:function(){},reset:function(){},markSupported:function(){},read:function(a,b,c){}}),nc=x.Class.create({abort:function(){},
close:function(a,b){},write:function(a,b,c,g,d){},flush:function(a,b){}}),ce=x.Class.create({init:function(a){Object.defineProperties(this,{_data:{value:a,writable:!1,enumerable:!1,configurable:!1},_closed:{value:!1,writable:!0,enumerable:!1,configurable:!1},_currentPosition:{value:0,writable:!0,enumerable:!1,configurable:!1},_mark:{value:-1,writable:!0,enumerable:!1,configurable:!1}})},abort:function(){},close:function(){this._closed=!0},mark:function(){this._mark=this._currentPosition},reset:function(){if(-1==
this._mark)throw new ha("Stream has not been marked.");this._currentPosition=this._mark},markSupported:function(){return!0},read:function(a,b,c){e(c,function(){if(this._closed)throw new ha("Stream is already closed.");if(this._currentPosition==this._data.length)return null;-1==a&&(a=this._data.length-this._currentPosition);var b=this._data.subarray(this._currentPosition,this._currentPosition+a);this._currentPosition+=b.length;return b},this)}}),de=x.Class.create({init:function(){var a={_closed:{value:!1,
writable:!0,enumerable:!1,configurable:!1},_result:{value:new Uint8Array(0),writable:!0,enuemrable:!1,configurable:!1},_buffered:{value:[],writable:!1,enumerable:!1,configurable:!1}};Object.defineProperties(this,a)},abort:function(){},close:function(a,b){this._closed=!0;b.result(!0)},write:function(a,b,c,g,d){e(d,function(){if(this._closed)throw new ha("Stream is already closed.");if(0>b)throw new RangeError("Offset cannot be negative.");if(0>c)throw new RangeError("Length cannot be negative.");if(b+
c>a.length)throw new RangeError("Offset plus length cannot be greater than the array length.");var g=a.subarray(b,c);this._buffered.push(g);return g.length},this)},flush:function(a,b){for(;0<this._buffered.length;){var c=this._buffered.shift();if(this._result){var g=new Uint8Array(this._result.length+c.length);g.set(this._result);g.set(c,this._result.length);this._result=g}else this._result=new Uint8Array(c)}b.result(!0)},size:function(){this.flush(1,{result:function(){}});return this._result.length},
toByteArray:function(){this.flush(1,{result:function(){}});return this._result}}),Sc=function(a,b,c){(function(a,b,d){a.read(-1,b,{result:function(a){a&&a.length?d(null,a):d(null,null)},timeout:function(){c.timeout()},error:function(a){d(a,null)}})})(a,b,function(b,d){var m;if(b)c.error(b);else if(d){void 0!==a.getJSON&&"function"===typeof a.getJSON&&(m=a.getJSON());if(void 0===m){m=new ClarinetParser(ca(d,"utf-8"));var l=[],e;for(e=m.nextValue();void 0!==e;)l.push(e),e=m.nextValue();m=l}c.result(m)}else c.result(null)})},
Tc,ee=x.Class.create({getResponse:function(a,b,c){}});(function(){var a=nc.extend({init:function(a,b){var c={_httpLocation:{value:a,writable:!1,enumerable:!1,configurable:!1},_timeout:{value:b,writable:!0,enumerable:!1,configurable:!1},_buffer:{value:new de,writable:!1,enumerable:!1,configurable:!1},_response:{value:void 0,writable:!0,enumerable:!1,configurable:!1},_abortToken:{value:void 0,writable:!0,enumerable:!1,configurable:!1},_responseQueue:{value:new ea,writable:!0,enumerable:!1,configurable:!1},
_aborted:{value:!1,writable:!0,enumerable:!1,configurable:!1}};Object.defineProperties(this,c)},setTimeout:function(a){this._timeout=a},getResponse:function(a){var b=this;this._responseQueue.poll(-1,{result:function(c){e(a,function(){c&&this._responseQueue.add(c);return c},b)},timeout:function(){e(a,function(){this._response={isTimeout:!0};this._responseQueue.add(this._response);this.abort();a.timeout()},b)},error:function(c){e(a,function(){this._response={isError:!0};this._responseQueue.add(this._response);
throw c;},b)}})},abort:function(){this._abortToken&&this._abortToken.abort();this._aborted=!0},close:function(a,b){var c=this;e(b,function(){if(this._response||this._abortToken||this._aborted)return!0;var a=this._buffer.toByteArray();0<a.length&&(this._abortToken=this._httpLocation.getResponse({body:a},this._timeout,{result:function(a){c._response={response:a};c._responseQueue.add(c._response)},timeout:function(){c._response={isTimeout:!0};c._responseQueue.add(c._response)},error:function(a){c._response=
{isError:!0,error:a};c._responseQueue.add(c._response)}}));return!0},this)},write:function(a,b,c,d,l){e(l,function(){if(this._response)throw new ha("HttpOutputStream already closed.");this._buffer.write(a,b,c,d,l)},this)},flush:function(a,b){e(b,function(){if(this._response)return!0;this._buffer.flush(a,b)},this)}}),b=Rc.extend({init:function(a){Object.defineProperties(this,{_out:{value:a,writable:!1,enumerable:!1,configurable:!1},_buffer:{value:void 0,writable:!0,enumerable:!1,configurable:!1},_exception:{value:void 0,
writable:!0,enumerable:!1,configurable:!1},_timedout:{value:!1,writable:!0,enumerable:!1,configurable:!1},_aborted:{value:!1,writable:!0,enumerable:!1,configurable:!1},_json:{value:void 0,writable:!0,enumerable:!1,configurable:!1}})},abort:function(){this._out.abort()},close:function(a,b){e(b,function(){this._buffer&&this._buffer.close();return!0},this)},mark:function(){this._buffer||this._buffer.mark()},reset:function(){this._buffer&&this._buffer.reset()},markSupported:function(){if(this._buffer)return this._buffer.markSupported()},
getJSON:function(){return this._json},read:function(a,b,c){function d(m){e(c,function(){if(!m)return new Uint8Array(0);this._out.getResponse({result:function(d){e(c,function(){var m;if(d.isTimeout)this._timedout=!0,c.timeout();else{if(d.isError)throw this._exception=d.error||new ha("Unknown HTTP exception."),this._exception;if(!d.response)throw this._exception=new ha("Missing HTTP response."),this._exception;void 0!==d.response.json?(this._json=d.response.json,m=new Uint8Array([0])):m=d.response.content||
ra(d.response.body);this._buffer=new ce(m);this._buffer.read(a,b,c)}},l)},timeout:function(){c.timeout()},error:function(a){c.error(a)}})},l)}var l=this;e(c,function(){if(this._exception)throw this._exception;if(this._timedout)c.timeout();else{if(this._aborted)return new Uint8Array(0);this._buffer?this._buffer.read(a,b,c):this._out.close(b,{result:function(a){d(a)},timeout:function(){c.timeout()},error:function(a){c.error(a)}})}},l)}});Tc=x.Class.create({init:function(a,b){Object.defineProperties(this,
{_httpLocation:{value:a,writable:!1,enumerable:!1,configurable:!1},_timeout:{value:b,writable:!0,enumerable:!1,configurable:!1}})},setTimeout:function(a){this._timeout=a},openConnection:function(){var c=new a(this._httpLocation,this._timeout);return{input:new b(c),output:c}}})})();var qa,oc;(function(){var a={};qa=function(b){Object.defineProperties(this,{name:{value:b,writable:!1,configurable:!1}});a[b]=this};x.Class.mixin(qa,{ASYMMETRIC_WRAPPED:new qa("ASYMMETRIC_WRAPPED"),DIFFIE_HELLMAN:new qa("DIFFIE_HELLMAN"),
JWE_LADDER:new qa("JWE_LADDER"),JWK_LADDER:new qa("JWK_LADDER"),SYMMETRIC_WRAPPED:new qa("SYMMETRIC_WRAPPED")});Object.freeze(qa);oc=function(b){return a[b]?a[b]:null}})();var fb,Uc;(function(){fb=x.Class.create({init:function(a){Object.defineProperties(this,{keyExchangeScheme:{value:a,writable:!1,configurable:!1}})},getKeydata:function(){},toJSON:function(){var a={};a.scheme=this.keyExchangeScheme.name;a.keydata=this.getKeydata();return a},equals:function(a){return this===a?!0:a instanceof fb?this.keyExchangeScheme==
a.keyExchangeScheme:!1},uniqueKey:function(){return this.keyExchangeScheme}});Uc=function(c,d,k){b(k,function(){var b=d.scheme,e=d.keydata;if("string"!==typeof b||"object"!==typeof e)throw new G(a.JSON_PARSE_ERROR,"keyrequestdata "+JSON.stringify(d));var m=oc(b);if(!m)throw new V(a.UNIDENTIFIED_KEYX_SCHEME,b);b=c.getKeyExchangeFactory(m);if(!b)throw new V(a.KEYX_FACTORY_NOT_FOUND,m.name);b.createRequestData(c,e,k)})}})();var gb,Vc;(function(){gb=x.Class.create({init:function(a,b){Object.defineProperties(this,
{masterToken:{value:a,writable:!1,configurable:!1},keyExchangeScheme:{value:b,wrtiable:!1,configurable:!1}})},getKeydata:function(){},toJSON:function(){var a={};a.mastertoken=this.masterToken;a.scheme=this.keyExchangeScheme.name;a.keydata=this.getKeydata();return a},equals:function(a){return this===a?!0:a instanceof gb?this.masterToken.equals(a.masterToken)&&this.keyExchangeScheme==a.keyExchangeScheme:!1},uniqueKey:function(){return this.masterToken.uniqueKey()+":"+this.keyExchangeScheme}});Vc=function(c,
d,k){b(k,function(){var g=d.mastertoken,e=d.scheme,m=d.keydata;if("string"!==typeof e||"object"!==typeof g||"object"!==typeof m)throw new G(a.JSON_PARSE_ERROR,"keyresponsedata "+JSON.stringify(d));var v=oc(e);if(!v)throw new V(a.UNIDENTIFIED_KEYX_SCHEME,e);pb(c,g,{result:function(d){b(k,function(){var b=c.getKeyExchangeFactory(v);if(!b)throw new V(a.KEYX_FACTORY_NOT_FOUND,v.name);return b.createResponseData(c,d,m)})},error:function(a){k.error(a)}})})}})();var ta;(function(){var c=x.Class.create({init:function(a,
b){Object.defineProperties(this,{keyResponseData:{value:a,writable:!1,configurable:!1},cryptoContext:{value:b,writable:!1,configurable:!1}})}});ta=x.Class.create({init:function(a){Object.defineProperties(this,{scheme:{value:a,writable:!1,configurable:!1}})},createRequestData:function(a,b,c){},createResponseData:function(a,b,c){},generateResponse:function(a,b,c,d){},getCryptoContext:function(a,b,c,d,m){},generateSessionKeys:function(c,k){b(k,function(){var b=new Uint8Array(16),d=new Uint8Array(32);
c.getRandom().nextBytes(b);c.getRandom().nextBytes(d);bb(b,$a,Xa,{result:function(b){bb(d,ab,Ya,{result:function(a){k.result({encryptionKey:b,hmacKey:a})},error:function(b){k.error(new F(a.SESSION_KEY_CREATION_FAILURE,null,b))}})},error:function(b){k.error(new F(a.SESSION_KEY_CREATION_FAILURE,null,b))}})})},importSessionKeys:function(a,b,c){bb(a,$a,Xa,{result:function(a){bb(b,ab,Ya,{result:function(b){c.result({encryptionKey:a,hmacKey:b})},error:function(a){c.error(a)}})},error:function(a){c.error(a)}})}});
ta.KeyExchangeData=c})();var Gb,Wc,pc,Xc;(function(){function c(b,k,g,e,u){switch(g){case d.JWE_RSA:case d.JWEJS_RSA:return new db(b,eb.RSA_OAEP,t,e,u);case d.JWK_RSA:return new Sb(b,k,e,u,Tb.WRAP_UNWRAP_OAEP);case d.JWK_RSAES:return new Sb(b,k,e,u,Tb.WRAP_UNWRAP_PKCS1);default:throw new F(a.UNSUPPORTED_KEYX_MECHANISM,g);}}var d=Wc={RSA:"RSA",ECC:"ECC",JWE_RSA:"JWE_RSA",JWEJS_RSA:"JWEJS_RSA",JWK_RSA:"JWK_RSA",JWK_RSAES:"JWK_RSAES"},k=pc=fb.extend({init:function v(a,b,c,k){v.base.call(this,qa.ASYMMETRIC_WRAPPED);
Object.defineProperties(this,{keyPairId:{value:a,writable:!1,configurable:!1},mechanism:{value:b,writable:!1,configurable:!1},publicKey:{value:c,writable:!1,configurable:!1},privateKey:{value:k,writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.keypairid=this.keyPairId;a.mechanism=this.mechanism;a.publickey=w(this.publicKey.getEncoded());return a},equals:function H(a){if(a===this)return!0;if(!(a instanceof pc))return!1;var b=this.privateKey===a.privateKey||this.privateKey&&a.privateKey&&
f(this.privateKey.getEncoded(),a.privateKey.getEncoded());return H.base.call(this,a)&&this.keyPairId==a.keyPairId&&this.mechanism==a.mechanism&&f(this.publicKey.getEncoded(),a.publicKey.getEncoded())&&b},uniqueKey:function n(){var a=this.publicKey.getEncoded(),b=this.privateKey&&this.privateKey.getEncoded(),a=n.base.call(this)+":"+this.keyPairId+":"+this.mechanism+":"+z(a);b&&(a+=":"+z(b));return a}}),g=function(c,g){b(g,function(){var b=c.keypairid,e=c.mechanism,u=c.publickey;if(!b||"string"!==typeof b||
!e||!u||"string"!==typeof u)throw new G(a.JSON_PARSE_ERROR,"keydata "+JSON.stringify(c));if(!d[e])throw new V(a.UNIDENTIFIED_KEYX_MECHANISM,e);try{var h=K(u);switch(e){case d.JWE_RSA:case d.JWEJS_RSA:case d.JWK_RSA:fc(h,Pb,Qa,{result:function(a){g.result(new k(b,e,a,null))},error:function(a){g.error(a)}});break;case d.JWK_RSAES:fc(h,cc,Qa,{result:function(a){g.result(new k(b,e,a,null))},error:function(a){g.error(a)}});break;default:throw new F(a.UNSUPPORTED_KEYX_MECHANISM,e);}}catch(B){if(!(B instanceof
p))throw new F(a.INVALID_PUBLIC_KEY,"keydata "+JSON.stringify(c),B);throw B;}})},e=Xc=gb.extend({init:function I(a,b,c,k){I.base.call(this,a,qa.ASYMMETRIC_WRAPPED);Object.defineProperties(this,{keyPairId:{value:b,writable:!1,configurable:!1},encryptionKey:{value:c,writable:!1,configurable:!1},hmacKey:{value:k,writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.keypairid=this.keyPairId;a.encryptionkey=w(this.encryptionKey);a.hmackey=w(this.hmacKey);return a},equals:function N(a){return this===
a?!0:a instanceof Xc?N.base.call(this,a)&&this.keyPairId==a.keyPairId&&f(this.encryptionKey,a.encryptionKey)&&f(this.hmacKey,a.hmacKey):!1},uniqueKey:function Y(){return Y.base.call(this)+":"+this.keyPairId+":"+z(this.encryptionKey)+":"+z(this.hmacKey)}});Gb=ta.extend({init:function fa(){fa.base.call(this,qa.ASYMMETRIC_WRAPPED)},createRequestData:function(a,b,c){g(b,c)},createResponseData:function(b,c,k){b=k.keypairid;var d=k.encryptionkey,g=k.hmackey;if(!b||"string"!==typeof b||!d||"string"!==typeof d||
!g||"string"!==typeof g)throw new G(a.JSON_PARSE_ERROR,"keydata "+JSON.stringify(k));var l;try{l=K(d)}catch(h){throw new F(a.INVALID_ENCRYPTION_KEY,"keydata "+JSON.stringify(k),h);}var q;try{q=K(g)}catch(Va){throw new F(a.INVALID_HMAC_KEY,"keydata "+JSON.stringify(k),Va);}return new e(c,b,l,q)},generateResponse:function(a,d,g,l){function M(k,e){b(l,function(){var u=c(a,d.keyPairId,d.mechanism,null,d.publicKey);u.wrap(k,{result:function(a){b(l,function(){u.wrap(e,{result:function(b){r(k,a,e,b)},error:function(a){b(l,
function(){a instanceof p&&g instanceof ya&&a.setEntity(g);throw a;},h)}})},h)},error:function(a){b(l,function(){a instanceof p&&g instanceof ya&&a.setEntity(g);throw a;},h)}})},h)}function r(c,k,r,M){b(l,function(){var C=a.getTokenFactory();g instanceof ya?C.renewMasterToken(a,g,c,r,{result:function(c){b(l,function(){var b=new na(a,c),g=new e(c,d.keyPairId,k,M);return new ta.KeyExchangeData(g,b,l)},h)},error:function(a){b(l,function(){a instanceof p&&a.setEntity(g);throw a;},h)}}):C.createMasterToken(a,
g,c,r,{result:function(c){b(l,function(){var b=new na(a,c),g=new e(c,d.keyPairId,k,M);return new ta.KeyExchangeData(g,b,l)},h)},error:l.error})},h)}var h=this;b(l,function(){if(!(d instanceof k))throw new E("Key request data "+JSON.stringify(d)+" was not created by this factory.");this.generateSessionKeys(a,{result:function(a){M(a.encryptionKey,a.hmacKey)},error:function(a){b(l,function(){a instanceof p&&g instanceof ya&&a.setEntity(g);throw a;},h)}})},h)},getCryptoContext:function(d,g,l,h,M){var r=
this;b(M,function(){if(!(g instanceof k))throw new E("Key request data "+JSON.stringify(g)+" was not created by this factory.");if(!(l instanceof e))throw new E("Key response data "+JSON.stringify(l)+" was not created by this factory.");var R=g.keyPairId,q=l.keyPairId;if(R!=q)throw(new V(a.KEYX_RESPONSE_REQUEST_MISMATCH,"request "+R+"; response "+q)).setEntity(h);q=g.privateKey;if(!q)throw(new V(a.KEYX_PRIVATE_KEY_MISSING,"request Asymmetric private key")).setEntity(h);var Va=c(d,R,g.mechanism,q,
null);Va.unwrap(l.encryptionKey,$a,Xa,{result:function(a){Va.unwrap(l.hmacKey,ab,Ya,{result:function(c){d.getEntityAuthenticationData(null,{result:function(k){b(M,function(){var b=k.getIdentity();return new na(d,l.masterToken,b,a,c)},r)},error:function(a){b(M,function(){a instanceof p&&a.setEntity(h);throw a;},r)}})},error:function(a){b(M,function(){a instanceof p&&a.setEntity(h);throw a;},r)}})},error:function(a){b(M,function(){a instanceof p&&a.setEntity(h);throw a;},r)}})},r)}})})();var Yc,qc,
Zc,$c,ad,rc;(function(){var c=qc="entityauthdata",d=Zc="mastertoken",k=$c="headerdata",g=ad="errordata",e=rc="signature";Yc=function(m,v,H,n){b(n,function(){var b=v[c],h=v[d],Y=v[e];if(b&&"object"!==typeof b||h&&"object"!==typeof h||"string"!==typeof Y)throw new G(a.JSON_PARSE_ERROR,"header/errormsg "+JSON.stringify(v));var fa;try{fa=K(Y)}catch(U){throw new X(a.HEADER_SIGNATURE_INVALID,"header/errormsg "+JSON.stringify(v),U);}var B=null;b&&(B=Kc(m,b));var P=v[k];if(void 0!=P&&null!=P){if("string"!==
typeof P)throw new G(a.JSON_PARSE_ERROR,"header/errormsg "+JSON.stringify(v));h?pb(m,h,{result:function(a){sc(m,P,B,a,fa,H,n)},error:function(a){n.error(a)}}):sc(m,P,B,null,fa,H,n)}else if(b=v[g],void 0!=b&&null!=b){if("string"!==typeof b)throw new G(a.JSON_PARSE_ERROR,"header/errormsg "+JSON.stringify(v));bd(m,b,B,fa,n)}else throw new G(a.JSON_PARSE_ERROR,JSON.stringify(v));})}})();var qb,cd,bd;(function(){function d(a,b){this.errordata=a;this.signature=b}qb=x.Class.create({init:function(c,d,g,e,
m,v,h,n,I,N){var Y=this;b(N,function(){0>v&&(v=-1);if(0>e||e>T)throw new E("Message ID "+e+" is out of range.");if(!d)throw new X(a.MESSAGE_ENTITY_NOT_FOUND);if(I)return Object.defineProperties(this,{entityAuthenticationData:{value:d,writable:!1,configurable:!1},recipient:{value:g,writable:!1,configurable:!1},messageId:{value:e,writable:!1,configurable:!1},errorCode:{value:m,writable:!1,configurable:!1},internalCode:{value:v,writable:!1,configurable:!1},errorMessage:{value:h,writable:!1,configurable:!1},
userMessage:{value:n,writable:!1,configurable:!1},errordata:{value:I.errordata,writable:!1,enumerable:!1,configurable:!1},signature:{value:I.signature,writable:!1,enumerable:!1,configurable:!1}}),this;var fa={};g&&(fa.recipient=g);fa.messageid=e;fa.errorcode=m;0<v&&(fa.internalcode=v);h&&(fa.errormsg=h);n&&(fa.usermsg=n);var U;try{U=c.getEntityAuthenticationFactory(d.scheme).getCryptoContext(c,d)}catch(B){throw B instanceof p&&(B.setEntity(d),B.setMessageId(e)),B;}fa=Z(JSON.stringify(fa),W);U.encrypt(fa,
{result:function(a){b(N,function(){U.sign(a,{result:function(c){b(N,function(){Object.defineProperties(this,{entityAuthenticationData:{value:d,writable:!1,configurable:!1},recipient:{value:g,writable:!1,configurable:!1},messageId:{value:e,writable:!1,configurable:!1},errorCode:{value:m,writable:!1,configurable:!1},internalCode:{value:v,writable:!1,configurable:!1},errorMessage:{value:h,writable:!1,configurable:!1},userMessage:{value:n,writable:!1,configurable:!1},errordata:{value:a,writable:!1,enumerable:!1,
configurable:!1},signature:{value:c,writable:!1,enumerable:!1,configurable:!1}});return this},Y)},error:function(a){b(N,function(){a instanceof p&&(a.setEntity(d),a.setMessageId(e));throw a;},Y)}})},Y)},error:function(a){b(N,function(){a instanceof p&&(a.setEntity(d),a.setMessageId(e));throw a;},Y)}})},Y)},toJSON:function(){var a={};a[qc]=this.entityAuthenticationData;a[ad]=w(this.errordata);a[rc]=w(this.signature);return a}});cd=function(a,b,c,d,m,e,h,n,I){new qb(a,b,c,d,m,e,h,n,null,I)};bd=function(e,
k,g,u,m){b(m,function(){if(!g)throw new X(a.MESSAGE_ENTITY_NOT_FOUND);var v;try{var h=g.scheme,n=e.getEntityAuthenticationFactory(h);if(!n)throw new Ha(a.ENTITYAUTH_FACTORY_NOT_FOUND,h.name);v=n.getCryptoContext(e,g)}catch(I){throw I instanceof p&&I.setEntity(g),I;}try{k=K(k)}catch(N){throw(new X(a.HEADER_DATA_INVALID,k,N)).setEntity(g);}if(!k||0==k.length)throw(new X(a.HEADER_DATA_MISSING,k)).setEntity(g);v.verify(k,u,{result:function(n){b(m,function(){if(!n)throw(new F(a.MESSAGE_VERIFICATION_FAILED)).setEntity(g);
v.decrypt(k,{result:function(v){b(m,function(){var b=ca(v,W),n;try{n=JSON.parse(b)}catch(h){if(h instanceof SyntaxError)throw(new G(a.JSON_PARSE_ERROR,"errordata "+b,h)).setEntity(g);throw h;}var M=void 0!==n.recipient?n.recipient:null,r=parseInt(n.messageid),H=parseInt(n.errorcode),q=parseInt(n.internalcode),I=n.errormsg,N=n.usermsg;if(M&&"string"!==typeof M||!r||r!=r||!H||H!=H||n.internalcode&&q!=q||I&&"string"!==typeof I||N&&"string"!==typeof N)throw(new G(a.JSON_PARSE_ERROR,"errordata "+b)).setEntity(g);
if(0>r||r>T)throw(new X(a.MESSAGE_ID_OUT_OF_RANGE,"errordata "+b)).setEntity(g);n=!1;for(var Y in c)if(c[Y]==H){n=!0;break}n||(H=c.FAIL);if(q){if(0>q)throw(new X(a.INTERNAL_CODE_NEGATIVE,"errordata "+b)).setEntity(g).setMessageId(r);}else q=-1;b=new d(k,u);new qb(e,g,M,r,H,q,I,N,b,m)})},error:function(a){b(m,function(){a instanceof p&&a.setEntity(g);throw a;})}})})},error:function(a){b(m,function(){a instanceof p&&a.setEntity(g);throw a;})}})})}})();var fe=x.Class.create({getUserMessage:function(a,
b){}}),Hb,dd,tc;(function(){function b(a,c){var d={},e=[],m;for(m=0;m<a.length;++m)d[a[m]]=!0;for(m=0;m<c.length;++m)d[c[m]]&&e.push(c[m]);return e}tc=function(a,c){if(!a||!c)return null;var d=b(a.compressionAlgorithms,c.compressionAlgorithms),e=b(a.languages,c.languages);return new Hb(d,e)};Hb=x.Class.create({init:function(a,b){a||(a=[]);b||(b=[]);a.sort();Object.defineProperties(this,{compressionAlgorithms:{value:a,writable:!1,enumerable:!0,configurable:!1},languages:{value:b,writable:!1,enumerable:!0,
configurable:!1}})},toJSON:function(){var a={};a.compressionalgos=this.compressionAlgorithms;a.languages=this.languages;return a},equals:function(a){return this===a?!0:a instanceof Hb?xa(this.compressionAlgorithms,a.compressionAlgorithms)&&xa(this.languages,a.languages):!1},uniqueKey:function(){return this.compressionAlgorithms.join(":")+"|"+this.languages.join(":")}});dd=function(b){var c=b.compressionalgos,d=b.languages;if(c&&!(c instanceof Array)||d&&!(d instanceof Array))throw new G(a.JSON_PARSE_ERROR,
"capabilities "+JSON.stringify(b));b=[];for(var e=0;c&&e<c.length;++e){var m=c[e];za[m]&&b.push(m)}return new Hb(b,d)}})();var Cb,ed,sc,fd,gd;(function(){function c(a,b,d,k,g,m){this.user=a;this.sender=b;this.messageCryptoContext=d;this.headerdata=k;this.signature=g;this.nonReplayable=m}function e(a,b,c,d,k,g,m,l,v,n,u,h,C,Pa,Fa,H,oa,I,N,f,p,Ja,La){return{cryptoContext:{value:b,writable:!1,configurable:!1},user:{value:c,writable:!1,configurable:!1},entityAuthenticationData:{value:d,writable:!1,configurable:!1},
masterToken:{value:k,writable:!1,configurable:!1},sender:{value:g,writable:!1,configurable:!1},recipient:{value:m,writable:!1,configurable:!1},messageId:{value:l,writable:!1,configurable:!1},nonReplayableId:{value:oa,writable:!1,configurable:!1},keyRequestData:{value:v,writable:!1,configurable:!1},keyResponseData:{value:n,writable:!1,configurable:!1},userAuthenticationData:{value:u,writable:!1,configurable:!1},userIdToken:{value:h,writable:!1,configurable:!1},serviceTokens:{value:C,writable:!1,configurable:!1},
peerMasterToken:{value:Pa,writable:!1,configurable:!1},peerUserIdToken:{value:Fa,writable:!1,configurable:!1},peerServiceTokens:{value:H,writable:!1,configurable:!1},messageCapabilities:{value:p,writable:!1,configurable:!1},nonReplayable:{value:I,writable:!1,enumerable:!1,configurable:!1},renewable:{value:N,writable:!1,enumerable:!1,configurable:!1},handshake:{value:f,writable:!1,enumerable:!1,configurable:!1},headerdata:{value:Ja,writable:!1,enumerable:!1,configurable:!1},signature:{value:La,writable:!1,
enumerable:!1,configurable:!1}}}function k(b,c,d){if(d){if(c=b.getMslStore().getCryptoContext(d))return c;if(!d.isVerified()||!d.isDecrypted())throw new wa(a.MASTERTOKEN_UNTRUSTED,d);return new na(b,d)}d=c.scheme;var k=b.getEntityAuthenticationFactory(d);if(!k)throw new Ha(a.ENTITYAUTH_FACTORY_NOT_FOUND,d.name);return k.getCryptoContext(b,c)}function g(a,c,d){b(d,function(){if(c)Vc(a,c,d);else return null})}function u(a,c,d,k){b(k,function(){if(c)sb(a,c,d,k);else return null})}function m(a,c,d,k){b(k,
function(){if(d)hd(a,c,d,k);else return null})}function v(c,d,k,g,m,e,r){function l(d,r,n){if(r>=d.length){var C=[],u;for(u in v)C.push(v[u]);n.result(C)}else{C=d[r];if("object"!==typeof C)throw new G(a.JSON_PARSE_ERROR,"headerdata "+e);Xb(c,C,k,g,m,{result:function(a){b(n,function(){v[a.uniqueKey()]=a;l(d,r+1,n)})},error:function(a){n.error(a)}})}}var v={};b(r,function(){if(d){if(!(d instanceof Array))throw new G(a.JSON_PARSE_ERROR,"headerdata "+e);l(d,0,r)}else return[]})}function h(c,d,k,g,m,e){function r(c,
d,k){b(k,function(){var b=d.peermastertoken;if(b&&"object"!==typeof b)throw new G(a.JSON_PARSE_ERROR,"headerdata "+m);if(!b)return null;pb(c,b,k)})}function l(c,d,k,g){b(g,function(){var b=d.peeruseridtoken;if(b&&"object"!==typeof b)throw new G(a.JSON_PARSE_ERROR,"headerdata "+m);if(!b)return null;sb(c,b,k,g)})}b(e,function(){if(!c.isPeerToPeer())return{peerMasterToken:null,peerUserIdToken:null,peerServiceTokens:[]};r(c,d,{result:function(a){b(e,function(){var r=k?k.masterToken:a;l(c,d,r,{result:function(k){b(e,
function(){v(c,d.peerservicetokens,r,k,g,m,{result:function(c){b(e,function(){return{peerMasterToken:a,peerUserIdToken:k,peerServiceTokens:c}})},error:function(a){b(e,function(){a instanceof p&&(a.setEntity(r),a.setUser(k));throw a;})}})})},error:function(a){b(e,function(){a instanceof p&&a.setEntity(r);throw a;})}})})},error:e.error})})}function n(c,d,k,g){function m(a,d){b(g,function(){if(d>=a.length)return e;Uc(c,a[d],{result:function(c){b(g,function(){e.push(c);m(a,d+1)})},error:function(a){g.error(a)}})})}
var e=[];b(g,function(){var b=d.keyrequestdata;if(!b)return e;if(!(b instanceof Array))throw new G(a.JSON_PARSE_ERROR,"headerdata "+k);m(b,0)})}var I=fd=x.Class.create({init:function(a,b,c,d,k,g,m,e,l,v,n){Object.defineProperties(this,{recipient:{value:a,writable:!1,configurable:!1},messageId:{value:b,writable:!1,configurable:!1},nonReplayableId:{value:c,writable:!1,configurable:!1},renewable:{value:d,writable:!1,configurable:!1},handshake:{value:k,writable:!1,configurable:!1},capabilities:{value:g,
writable:!1,configurable:!1},keyRequestData:{value:m,writable:!1,configurable:!1},keyResponseData:{value:e,writable:!1,configurable:!1},userAuthData:{value:l,writable:!1,configurable:!1},userIdToken:{value:v,writable:!1,configurable:!1},serviceTokens:{value:n,writable:!1,configurable:!1}})}}),N=gd=x.Class.create({init:function(a,b,c){Object.defineProperties(this,{peerMasterToken:{value:a,writable:!1,configurable:!1},peerUserIdToken:{value:b,writable:!1,configurable:!1},peerServiceTokens:{value:c,
writable:!1,configurable:!1}})}});Cb=x.Class.create({init:function(a,c,d,g,m,v,r){function n(h){b(r,function(){c=d?null:c;var n=g.nonReplayableId,H=!1,C=g.renewable,Pa=g.handshake,Fa=g.capabilities,I=g.recipient,oa=g.messageId,N=g.keyRequestData?g.keyRequestData:[],Ka=g.keyResponseData,R=g.userAuthData,f=g.userIdToken,Ja=g.serviceTokens?g.serviceTokens:[],La,Sa,L;a.isPeerToPeer()?(La=m.peerMasterToken,Sa=m.peerUserIdToken,L=m.peerServiceTokens?m.peerServiceTokens:[]):(Sa=La=null,L=[]);if(0>oa||oa>
T)throw new E("Message ID "+oa+" is out of range.");if(!c&&!d)throw new E("Message entity authentication data or master token must be provided.");var y,w;Ka?a.isPeerToPeer()?(y=d,w=Ka.masterToken):(y=Ka.masterToken,w=La):(y=d,w=La);if(f&&(!y||!f.isBoundTo(y)))throw new E("User ID token must be bound to a master token.");if(Sa&&(!w||!Sa.isBoundTo(w)))throw new E("Peer user ID token must be bound to a peer master token.");Ja.forEach(function(a){if(a.isMasterTokenBound()&&(!y||!a.isBoundTo(y)))throw new E("Master token bound service tokens must be bound to the provided master token.");
if(a.isUserIdTokenBound()&&(!f||!a.isBoundTo(f)))throw new E("User ID token bound service tokens must be bound to the provided user ID token.");},this);L.forEach(function(a){if(a.isMasterTokenBound()&&(!w||!a.isBoundTo(w)))throw new E("Master token bound peer service tokens must be bound to the provided peer master token.");if(a.isUserIdTokenBound()&&(!Sa||!a.isBoundTo(Sa)))throw new E("User ID token bound peer service tokens must be bound to the provided peer user ID token.");},this);if(v){var z=
v.user,t=v.messageCryptoContext,x=v.headerdata,A=v.signature,H=v.nonReplayable,x=e(a,t,z,c,d,h,I,oa,N,Ka,R,f,Ja,La,Sa,L,n,H,C,Pa,Fa,x,A);Object.defineProperties(this,x);return this}var z=f?f.user:null,x={};h&&(x.sender=h);I&&(x.recipient=I);x.messageid=oa;x.nonreplayable=H;"number"===typeof n&&(x.nonreplayableid=n);x.renewable=C;x.handshake=Pa;Fa&&(x.capabilities=Fa);0<N.length&&(x.keyrequestdata=N);Ka&&(x.keyresponsedata=Ka);R&&(x.userauthdata=R);f&&(x.useridtoken=f);0<Ja.length&&(x.servicetokens=
Ja);La&&(x.peermastertoken=La);Sa&&(x.peeruseridtoken=Sa);0<L.length&&(x.peerservicetokens=L);var t;try{t=k(a,c,d)}catch(F){throw F instanceof p&&(F.setEntity(d),F.setEntity(c),F.setUser(f),F.setUser(R),F.setMessageId(oa)),F;}x=Z(JSON.stringify(x),W);t.encrypt(x,{result:function(k){b(r,function(){t.sign(k,{result:function(g){b(r,function(){var b=e(a,t,z,c,d,h,I,oa,N,Ka,R,f,Ja,La,Sa,L,n,H,C,Pa,Fa,k,g);Object.defineProperties(this,b);return this},u)},error:function(a){b(r,function(){a instanceof p&&
(a.setEntity(d),a.setEntity(c),a.setUser(f),a.setUser(R),a.setMessageId(oa));throw a;},u)}})},u)},error:function(a){b(r,function(){a instanceof p&&(a.setEntity(d),a.setEntity(c),a.setUser(f),a.setUser(R),a.setMessageId(oa));throw a;},u)}})},u)}var u=this;b(r,function(){v?n(v.sender):d?a.getEntityAuthenticationData(null,{result:function(a){a=a.getIdentity();n(a)},error:r.error}):n(null)},u)},isEncrypting:function(){return this.masterToken||this.entityAuthenticationData.scheme.encrypts},isNonReplayable:function(){return this.nonReplayable},
isRenewable:function(){return this.renewable},isHandshake:function(){return this.handshake},toJSON:function(){var a={};this.masterToken?a[Zc]=this.masterToken:a[qc]=this.entityAuthenticationData;a[$c]=w(this.headerdata);a[rc]=w(this.signature);return a}});ed=function(a,b,c,d,k,g){new Cb(a,b,c,d,k,null,g)};sc=function(e,l,f,B,P,M,r){function R(k,R){b(r,function(){var pa;try{pa=JSON.parse(R)}catch(Ba){if(Ba instanceof SyntaxError)throw(new G(a.JSON_PARSE_ERROR,"headerdata "+R,Ba)).setEntity(B).setEntity(f);
throw Ba;}var C=parseInt(pa.messageid);if(!C||C!=C)throw(new G(a.JSON_PARSE_ERROR,"headerdata "+R)).setEntity(B).setEntity(f);if(0>C||C>T)throw(new X(a.MESSAGE_ID_OUT_OF_RANGE,"headerdata "+R)).setEntity(B).setEntity(f);var Pa=B?pa.sender:null;if(B&&(!Pa||"string"!==typeof Pa))throw(new G(a.JSON_PARSE_ERROR,"headerdata "+R)).setEntity(B).setEntity(f).setMessageId(C);var Fa="undefined"!==pa.recipient?pa.recipient:null;if(Fa&&"string"!==typeof Fa)throw(new G(a.JSON_PARSE_ERROR,"headerdata "+R)).setEntity(B).setEntity(f).setMessageId(C);
var ma=pa.keyresponsedata;if(ma&&"object"!==typeof ma)throw(new G(a.JSON_PARSE_ERROR,"headerdata "+R)).setEntity(B).setEntity(f).setMessageId(C);var oa=r;r={result:function(a){oa.result(a)},error:function(a){a instanceof p&&(a.setEntity(B),a.setEntity(f),a.setMessageId(C));oa.error(a)}};g(e,ma,{result:function(g){b(r,function(){var oa=!e.isPeerToPeer()&&g?g.masterToken:B,ma=pa.useridtoken;if(ma&&"object"!==typeof ma)throw new G(a.JSON_PARSE_ERROR,"headerdata "+R);u(e,ma,oa,{result:function(u){b(r,
function(){var ma=pa.userauthdata;if(ma&&"object"!==typeof ma)throw new G(a.JSON_PARSE_ERROR,"headerdata "+R);m(e,oa,ma,{result:function(m){b(r,function(){var ma;if(m){var rb=m.scheme,Ba=e.getUserAuthenticationFactory(rb);if(!Ba)throw(new d(a.USERAUTH_FACTORY_NOT_FOUND,rb)).setUser(u).setUser(m);rb=B?B.identity:f.getIdentity();ma=Ba.authenticate(e,rb,m,u)}else ma=u?u.user:null;v(e,pa.servicetokens,oa,u,M,R,{result:function(d){b(r,function(){var v=void 0!==pa.nonreplayableid?parseInt(pa.nonreplayableid):
null,oa=void 0!==pa.nonreplayable?pa.nonreplayable:!1,Ka=pa.renewable,rb=void 0!==pa.handshake?pa.handshake:!1;if(v!=v||"boolean"!==typeof oa||"boolean"!==typeof Ka||"boolean"!==typeof rb)throw new G(a.JSON_PARSE_ERROR,"headerdata "+R);if(0>v||v>T)throw new X(a.NONREPLAYABLE_ID_OUT_OF_RANGE,"headerdata "+R);var Ba=null,Ja=pa.capabilities;if(Ja){if("object"!==typeof Ja)throw new G(a.JSON_PARSE_ERROR,"headerdata "+R);Ba=dd(Ja)}n(e,pa,R,{result:function(a){h(e,pa,g,M,R,{result:function(n){b(r,function(){var b=
n.peerMasterToken,h=n.peerUserIdToken,H=n.peerServiceTokens,R=new I(Fa,C,v,Ka,rb,Ba,a,g,m,u,d),b=new N(b,h,H),h=new c(ma,Pa,k,l,P,oa);new Cb(e,f,B,R,b,h,r)})},error:r.error})},error:function(a){b(r,function(){a instanceof p&&(a.setUser(u),a.setUser(m));throw a;})}})})},error:function(a){b(r,function(){a instanceof p&&(a.setEntity(oa),a.setUser(u),a.setUser(m));throw a;})}})})},error:r.error})})},error:r.error})})},error:r.error})})}b(r,function(){f=B?null:f;if(!f&&!B)throw new X(a.MESSAGE_ENTITY_NOT_FOUND);
var c=l;try{l=K(c)}catch(d){throw new X(a.HEADER_DATA_INVALID,c,d);}if(!l||0==l.length)throw new X(a.HEADER_DATA_MISSING,c);var g;try{g=k(e,f,B)}catch(m){throw m instanceof p&&(m.setEntity(B),m.setEntity(f)),m;}g.verify(l,P,{result:function(c){b(r,function(){if(!c){if(B)throw new F(a.MESSAGE_MASTERTOKENBASED_VERIFICATION_FAILED);throw new F(a.MESSAGE_ENTITYDATABASED_VERIFICATION_FAILED);}g.decrypt(l,{result:function(a){b(r,function(){var b=ca(a,W);R(g,b)})},error:function(a){r.error(a)}})})},error:function(a){r.error(a)}})})}})();
var uc,id,jd;(function(){function c(a,b){this.payload=a;this.signature=b}uc=x.Class.create({init:function(a,c,d,e,m,v,h,n){var I=this;b(n,function(){if(0>a||a>T)throw new E("Sequence number "+a+" is outside the valid range.");if(0>c||c>T)throw new E("Message ID "+c+" is outside the valid range.");if(h)return Object.defineProperties(this,{sequenceNumber:{value:a,writable:!1,configurable:!1},messageId:{value:c,writable:!1,configurable:!1},compressionAlgo:{value:e,writable:!1,configurable:!1},data:{value:m,
writable:!1,configurable:!1},endofmsg:{value:d,writable:!1,enumerable:!1,configurable:!1},payload:{value:h.payload,writable:!1,enumerable:!1,configurable:!1},signature:{value:h.signature,writable:!1,enumerable:!1,configurable:!1}}),this;var N;e?(N=vc(e,m),N||(e=null,N=m)):(e=null,N=m);var f={};f.sequencenumber=a;f.messageid=c;d&&(f.endofmsg=d);e&&(f.compressionalgo=e);f.data=w(N);N=Z(JSON.stringify(f),W);v.encrypt(N,{result:function(h){b(n,function(){v.sign(h,{result:function(v){b(n,function(){Object.defineProperties(this,
{sequenceNumber:{value:a,writable:!1,configurable:!1},messageId:{value:c,writable:!1,configurable:!1},compressionAlgo:{value:e,writable:!1,configurable:!1},data:{value:m,writable:!1,configurable:!1},endofmsg:{value:d,writable:!1,enumerable:!1,configurable:!1},payload:{value:h,writable:!1,enumerable:!1,configurable:!1},signature:{value:v,writable:!1,enumerable:!1,configurable:!1}});return this},I)},error:function(a){n.error(a)}})},I)},error:function(a){n.error(a)}})},I)},isEndOfMessage:function(){return this.endofmsg},
toJSON:function(){var a={};a.payload=w(this.payload);a.signature=w(this.signature);return a}});id=function(a,b,c,d,m,e,h){new uc(a,b,c,d,m,e,null,h)};jd=function(d,k,g){b(g,function(){var e=d.payload,m=d.signature;if(!e||"string"!==typeof e||"string"!==typeof m)throw new G(a.JSON_PARSE_ERROR,"payload chunk "+JSON.stringify(d));var v,h;try{v=K(e)}catch(n){throw new X(a.PAYLOAD_INVALID,"payload chunk "+JSON.stringify(d),n);}try{h=K(m)}catch(I){throw new X(a.PAYLOAD_SIGNATURE_INVALID,"payload chunk "+
JSON.stringify(d),I);}k.verify(v,h,{result:function(d){b(g,function(){if(!d)throw new F(a.PAYLOAD_VERIFICATION_FAILED);k.decrypt(v,{result:function(d){b(g,function(){var b=ca(d,W),m;try{m=JSON.parse(b)}catch(e){if(e instanceof SyntaxError)throw new G(a.JSON_PARSE_ERROR,"payload chunk payload "+b,e);throw e;}var n=parseInt(m.sequencenumber),l=parseInt(m.messageid),r=m.endofmsg,u=m.compressionalgo;m=m.data;if(!n||n!=n||!l||l!=l||r&&"boolean"!==typeof r||u&&"string"!==typeof u||"string"!==typeof m)throw new G(a.JSON_PARSE_ERROR,
"payload chunk payload "+b);if(0>n||n>T)throw new p(a.PAYLOAD_SEQUENCE_NUMBER_OUT_OF_RANGE,"payload chunk payload "+b);if(0>l||l>T)throw new p(a.PAYLOAD_MESSAGE_ID_OUT_OF_RANGE,"payload chunk payload "+b);r||(r=!1);if(u&&!za[u])throw new X(a.UNIDENTIFIED_COMPRESSION,u);var q;try{q=K(m)}catch(I){throw new X(a.PAYLOAD_DATA_CORRUPT,m,I);}if(q&&0!=q.length)b=u?Yb(u,q):q;else{if(0<m.length)throw new X(a.PAYLOAD_DATA_CORRUPT,m);if(r)b=new Uint8Array(0);else throw new X(a.PAYLOAD_DATA_MISSING,m);}q=new c(v,
h);new uc(n,l,r,u,b,k,q,g)})},error:function(a){g.error(a)}})})},error:function(a){g.error(a)}})})}})();var Zb,tb,Db,ub,kd,ld;(function(){function c(d,g,k,e,l){function u(){b(l,function(){f>=g.length&&(f=0,++h);if(h>=U.length){if(B)throw B;throw new V(a.KEYX_FACTORY_NOT_FOUND,JSON.stringify(g));}var c=U[h],k=g[f];c.scheme!=k.keyExchangeScheme?(++f,u()):c.generateResponse(d,k,P,{result:function(a){l.result(a)},error:function(a){b(l,function(){if(!(a instanceof p))throw a;B=a;++f;u()})}})})}var h=0,
f=0,U=d.getKeyExchangeFactories(),B,P=k?k:e;u()}function e(a,d,g,k,l){b(l,function(){var e=d.keyRequestData;if(d.isRenewable()&&0<e.length)k?k.isRenewable()||k.isExpired()||d.isNonReplayable()?c(a,e,k,null,l):a.getTokenFactory().isNewestMasterToken(a,k,{result:function(d){b(l,function(){if(d)return null;c(a,e,k,null,l)})},error:l.error}):c(a,e,null,g.getIdentity(),l);else return null})}function k(c,k,g,e){b(e,function(){var b=k.userIdToken,l=k.userAuthenticationData,u=k.messageId;if(b&&b.isVerified()){if(b.isRenewable()&&
k.isRenewable()||b.isExpired()||!b.isBoundTo(g)){l=c.getTokenFactory();l.renewUserIdToken(c,b,g,e);return}}else if(k.isRenewable()&&g&&l){b=k.user;if(!b){var b=l.scheme,h=c.getUserAuthenticationFactory(b);if(!h)throw(new d(a.USERAUTH_FACTORY_NOT_FOUND,b)).setEntity(g).setUser(l).setMessageId(u);b=h.authenticate(c,g.identity,l,null)}l=c.getTokenFactory();l.createUserIdToken(c,b,g,e);return}return b})}var g=new Uint8Array(0),u=tb=function(a){if(0>a||a>T)throw new E("Message ID "+a+" is outside the valid range.");
return a==T?0:a+1};Db=function(a){if(0>a||a>T)throw new E("Message ID "+a+" is outside the valid range.");return 0==a?T:a-1};ub=function(a,c,d,k,g,e){b(e,function(){if(void 0==g||null==g){var l=a.getRandom();do g=l.nextLong();while(0>g||g>T)}else if(0>g||g>T)throw new E("Message ID "+g+" is outside the valid range.");a.getEntityAuthenticationData(null,{result:function(l){b(e,function(){var b=a.getMessageCapabilities();return new Zb(a,k,g,b,l,c,d,null,null,null,null,null)})},error:function(a){e.error(a)}})})};
kd=function(a,c,d){b(d,function(){function g(a){b(d,function(){a instanceof p&&(a.setEntity(h),a.setEntity(f),a.setUser(Y),a.setUser(fa),a.setMessageId(B));throw a;})}var h=c.masterToken,f=c.entityAuthenticationData,Y=c.userIdToken,fa=c.userAuthenticationData,U=h?h.identity:f.getIdentity(),B=c.messageId,P=u(B);e(a,c,f,h,{result:function(e){b(d,function(){var l=e?e.keyResponseData.masterToken:l=h;a.getEntityAuthenticationData(null,{result:function(u){b(d,function(){k(a,c,l,{result:function(g){b(d,
function(){Y=g;var b=tc(c.messageCapabilities,a.getMessageCapabilities()),d=c.keyResponseData,k=c.serviceTokens;return a.isPeerToPeer()?new Zb(a,U,P,b,u,d?d.masterToken:c.peerMasterToken,c.peerUserIdToken,c.peerServiceTokens,h,Y,k,e):new Zb(a,U,P,b,u,d?d.masterToken:h,Y,k,null,null,null,e)})},error:g})})},error:g})})},error:g})})};ld=function(a,c,d,g,k,e){b(e,function(){a.getEntityAuthenticationData(null,{result:function(l){b(e,function(){var b;if(void 0!=d&&null!=d)b=u(d);else{var h=a.getRandom();
do b=h.nextInt();while(0>b||b>T)}cd(a,l,c,b,g.responseCode,g.internalCode,g.message,k,e)})},error:function(a){e.error(a)}})})};Zb=x.Class.create({init:function(a,b,c,d,g,k,e,l,h,u,f,M){if(!a.isPeerToPeer()&&(h||u))throw new E("Cannot set peer master token or peer user ID token when not in peer-to-peer mode.");var r;r=M&&!a.isPeerToPeer()?M.keyResponseData.masterToken:k;var R={};a.getMslStore().getServiceTokens(r,e).forEach(function(a){R[a.name]=a},this);l&&l.forEach(function(a){R[a.name]=a},this);
var q,Va,p={};a.isPeerToPeer()&&(q=h,Va=u,l=M?M.keyResponseData.masterToken:h,a.getMslStore().getServiceTokens(l,u).forEach(function(a){p[a.name]=a},this),f&&f.forEach(function(a){p[a.name]=a},this));Object.defineProperties(this,{_ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},_entityAuthData:{value:g,writable:!1,enumerable:!1,configurable:!1},_masterToken:{value:k,writable:!0,enumerable:!1,configurable:!1},_recipient:{value:b,writable:!1,enumerable:!1,configurable:!1},_messageId:{value:c,
writable:!1,enumerable:!1,configurable:!1},_capabilities:{value:d,writable:!1,enumerable:!1,configurable:!1},_keyExchangeData:{value:M,writable:!1,enumerable:!1,configurable:!1},_nonReplayable:{value:!1,writable:!0,enumerable:!1,configurable:!1},_handshake:{value:!1,writable:!0,enumerable:!1,configurable:!1},_renewable:{value:!1,writable:!0,enumerable:!1,configurable:!1},_keyRequestData:{value:{},writable:!1,enumerable:!1,configurable:!1},_userAuthData:{value:null,writable:!0,enumerable:!1,configurable:!1},
_userIdToken:{value:e,writable:!0,enumerable:!1,configurable:!1},_serviceTokens:{value:R,writable:!1,enumerable:!1,configurable:!1},_peerMasterToken:{value:q,writable:!0,enumerable:!1,configurable:!1},_peerUserIdToken:{value:Va,writable:!0,enumerable:!1,configurable:!1},_peerServiceTokens:{value:p,writable:!1,enumerable:!1,configurable:!1}})},getMessageId:function(){return this._messageId},getMasterToken:function(){return this._masterToken},getUserIdToken:function(){return this._userIdToken},getKeyExchangeData:function(){return this._keyExchangeData},
willEncryptHeader:function(){return this._masterToken||this._entityAuthData.scheme.encrypts},willEncryptPayloads:function(){return this._masterToken||!this._ctx.isPeerToPeer()&&this._keyExchangeData||this._entityAuthData.scheme.encrypts},willIntegrityProtectHeader:function(){return this._masterToken||this._entityAuthData.scheme.protectsIntegrity},willIntegrityProtectPayloads:function(){return this._masterToken||!this._ctx.isPeerToPeer()&&this._keyExchangeData||this._entityAuthData.scheme.protectsIntegrity},
getHeader:function(c){b(c,function(){var b=this._keyExchangeData?this._keyExchangeData.keyResponseData:null,d=[],g;for(g in this._serviceTokens)d.push(this._serviceTokens[g]);var k=[],e;for(e in this._keyRequestData)k.push(this._keyRequestData[e]);if(this._nonReplayable){if(!this._masterToken)throw new X(a.NONREPLAYABLE_MESSAGE_REQUIRES_MASTERTOKEN);e=this._ctx.getMslStore().getNonReplayableId(this._masterToken)}else e=null;b=new fd(this._recipient,this._messageId,e,this._renewable,this._handshake,
this._capabilities,k,b,this._userAuthData,this._userIdToken,d);d=[];for(g in this._peerServiceTokens)d.push(this._peerServiceTokens[g]);g=new gd(this._peerMasterToken,this._peerUserIdToken,d);ed(this._ctx,this._entityAuthData,this._masterToken,b,g,c)},this)},isNonReplayable:function(){return this._nonReplayable},setNonReplayable:function(a){if(this._nonReplayable=a)this._handshake=!1;return this},isRenewable:function(){return this._renewable},setRenewable:function(a){this._renewable=a;this._renewable||
(this._handshake=!1);return this},isHandshake:function(){return this._handshake},setHandshake:function(a){if(this._handshake=a)this._nonReplayable=!1,this._renewable=!0;return this},setAuthTokens:function(a,b){if(b&&!b.isBoundTo(a))throw new E("User ID token must be bound to master token.");if(this._keyExchangeData&&!this._ctx.isPeerToPeer())throw new E("Attempt to set message builder master token when key exchange data exists as a trusted network server.");var c;try{c=this._ctx.getMslStore().getServiceTokens(a,
b)}catch(d){if(d instanceof p)throw new E("Invalid master token and user ID token combination despite checking above.",d);throw d;}var g=[],k;for(k in this._serviceTokens)g.push(this._serviceTokens[k]);g.forEach(function(c){(c.isUserIdTokenBound()&&!c.isBoundTo(b)||c.isMasterTokenBound()&&!c.isBoundTo(a))&&delete this._serviceTokens[c.name]},this);c.forEach(function(a){this._serviceTokens[a.name]=a},this);this._masterToken=a;this._userIdToken=b},setUserAuthenticationData:function(a){this._userAuthData=
a;return this},setUser:function(a,c){var d=this;b(c,function(){if(!this._ctx.isPeerToPeer()&&null!=this._userIdToken||this._ctx.isPeerToPeer()&&null!=this._peerUserIdToken)throw new E("User ID token or peer user ID token already exists for the remote user.");var g;g=this._keyExchangeData?this._keyExchangeData.keyResponseData.masterToken:this._ctx.isPeerToPeer()?this._peerMasterToken:this._masterToken;if(!g)throw new E("User ID token or peer user ID token cannot be created because no corresponding master token exists.");
this._ctx.getTokenFactory().createUserIdToken(this._ctx,a,g,{result:function(a){b(c,function(){this._ctx.isPeerToPeer()?this._peerUserIdToken=a:(this._userIdToken=a,this._userAuthData=null);return!0},d)},error:function(a){c.error(a)}})},d)},addKeyRequestData:function(a){this._keyRequestData[a.uniqueKey()]=a;return this},removeKeyRequestData:function(a){delete this._keyRequestData[a.uniqueKey()];return this},addServiceToken:function(b){var c;c=this._keyExchangeData&&!this._ctx.isPeerToPeer()?this._keyExchangeData.keyResponseData.masterToken:
this._masterToken;if(b.isMasterTokenBound()&&!b.isBoundTo(c))throw(new X(a.SERVICETOKEN_MASTERTOKEN_MISMATCH,"st "+JSON.stringify(b)+"; mt "+JSON.stringify(c))).setEntity(c);if(b.isUserIdTokenBound()&&!b.isBoundTo(this._userIdToken))throw(new X(a.SERVICETOKEN_USERIDTOKEN_MISMATCH,"st "+JSON.stringify(b)+"; uit "+JSON.stringify(this._userIdToken))).setEntity(c).setUser(this._userIdToken);this._serviceTokens[b.name]=b;return this},addServiceTokenIfAbsent:function(a){this._serviceTokens[a.name]||this.addServiceToken(a);
return this},excludeServiceToken:function(a){delete this._serviceTokens[a];return this},deleteServiceToken:function(a,c){var d=this;b(c,function(){var k=this._serviceTokens[a];if(!k)return this;var e=k.isMasterTokenBound()?this._masterToken:null,k=k.isUserIdTokenBound()?this._userIdToken:null;hb(this._ctx,a,g,e,k,!1,null,new Ab,{result:function(a){b(c,function(){return this.addServiceToken(a)},d)},error:function(a){a instanceof p&&(a=new E("Failed to create and add empty service token to message.",
a));c.error(a)}})},d)},getServiceTokens:function(){var a=[],b;for(b in this._serviceTokens)a.push(this._serviceTokens[b]);return a},getPeerMasterToken:function(){return this._peerMasterToken},getPeerUserIdToken:function(){return this._peerUserIdToken},setPeerAuthTokens:function(b,c){if(!this._ctx.isPeerToPeer())throw new E("Cannot set peer master token or peer user ID token when not in peer-to-peer mode.");if(c&&!b)throw new E("Peer master token cannot be null when setting peer user ID token.");if(c&&
!c.isBoundTo(b))throw(new X(a.USERIDTOKEN_MASTERTOKEN_MISMATCH,"uit "+c+"; mt "+b)).setEntity(b).setUser(c);var d;try{d=this._ctx.getMslStore().getServiceTokens(b,c)}catch(g){if(g instanceof p)throw new E("Invalid peer master token and user ID token combination despite proper check.",g);throw g;}Object.keys(this._peerServiceTokens).forEach(function(a){var d=this._peerServiceTokens[a];d.isUserIdTokenBound()&&!d.isBoundTo(c)?delete this._peerServiceTokens[a]:d.isMasterTokenBound()&&!d.isBoundTo(b)&&
delete this._peerServiceTokens[a]},this);d.forEach(function(a){var b=a.name;this._peerServiceTokens[b]||(this._peerServiceTokens[b]=a)},this);this._peerUserIdToken=c;this._peerMasterToken=b;return this},addPeerServiceToken:function(b){if(!this._ctx.isPeerToPeer())throw new E("Cannot set peer service tokens when not in peer-to-peer mode.");if(b.isMasterTokenBound()&&!b.isBoundTo(this._peerMasterToken))throw(new X(a.SERVICETOKEN_MASTERTOKEN_MISMATCH,"st "+JSON.stringify(b)+"; mt "+JSON.stringify(this._peerMasterToken))).setEntity(this._peerMasterToken);
if(b.isUserIdTokenBound()&&!b.isBoundTo(this._peerUserIdToken))throw(new X(a.SERVICETOKEN_USERIDTOKEN_MISMATCH,"st "+JSON.stringify(b)+"; uit "+JSON.stringify(this._peerUserIdToken))).setEntity(this._peerMasterToken).setUser(this._peerUserIdToken);this._peerServiceTokens[b.name]=b;return this},addPeerServiceTokenIfAbsent:function(a){this._peerServiceTokens[a.name]||this.addPeerServiceToken(a);return this},excludePeerServiceToken:function(a){delete this._peerServiceTokens[a];return this},deletePeerServiceToken:function(a,
c){var d=this;b(c,function(){var k=this._peerServiceTokens[a];if(!k)return this;var e=k.isMasterTokenBound()?this._peerMasterToken:null,k=k.isUserIdTokenBound()?this._peerUserIdToken:null;hb(this._ctx,a,g,e,k,!1,null,new Ab,{result:function(a){b(c,function(){return this.addPeerServiceToken(a)},d)},error:function(a){a instanceof p&&(a=new E("Failed to create and add empty peer service token to message.",a));c.error(a)}})},d)},getPeerServiceTokens:function(){var a=[],b;for(b in this._peerServiceTokens)a.push(this._peerServiceTokens[b]);
return a}})})();var md;(function(){function a(b,c){return c[b]?c[b]:c[""]}function c(a){var b=a.builder.getKeyExchangeData();return b&&!a.ctx.isPeerToPeer()?b.keyResponseData.masterToken:a.builder.getMasterToken()}md=x.Class.create({init:function(a,b,c){a={ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},cryptoContexts:{value:b.getCryptoContexts(),writable:!1,enumerable:!1,configurable:!1},builder:{value:c,writable:!1,enumerable:!1,configurable:!1}};Object.defineProperties(this,a)},isPrimaryMasterTokenAvailable:function(){return c(this)?
!0:!1},isPrimaryUserIdTokenAvailable:function(){return this.builder.getUserIdToken()?!0:!1},isPeerMasterTokenAvailable:function(){return this.builder.getPeerMasterToken()?!0:!1},isPeerUserIdTokenAvailable:function(){return this.builder.getPeerUserIdToken()?!0:!1},getPrimaryServiceTokens:function(){return this.builder.getServiceTokens()},getPeerServiceTokens:function(){return this.builder.getPeerServiceTokens()},addPrimaryServiceToken:function(a){try{return this.builder.addServiceToken(a),!0}catch(b){if(b instanceof
X)return!1;throw b;}},addPeerServiceToken:function(a){try{return this.builder.addPeerServiceToken(a),!0}catch(b){if(b instanceof X)return!1;throw b;}},addUnboundPrimaryServiceToken:function(c,d,e,l,h){var f=this;b(h,function(){var n=a(c,this.cryptoContexts);if(!n)return!1;hb(this.ctx,c,d,null,null,e,l,n,{result:function(a){b(h,function(){try{this.builder.addServiceToken(a)}catch(b){if(b instanceof X)throw new E("Service token bound to incorrect authentication tokens despite being unbound.",b);throw b;
}return!0},f)},error:function(a){h.error(a)}})},f)},addUnboundPeerServiceToken:function(c,d,e,l,h){var f=this;b(h,function(){var n=a(c,this.cryptoContexts);if(!n)return!1;hb(this.ctx,c,d,null,null,e,l,n,{result:function(a){b(h,function(){try{this.builder.addPeerServiceToken(a)}catch(b){if(b instanceof X)throw new E("Service token bound to incorrect authentication tokens despite being unbound.",b);throw b;}return!0},f)},error:function(a){h.error(a)}})},f)},addMasterBoundPrimaryServiceToken:function(d,
g,e,m,h){var f=this;b(h,function(){var n=c(this);if(!n)return!1;var I=a(d,this.cryptoContexts);if(!I)return!1;hb(this.ctx,d,g,n,null,e,m,I,{result:function(a){b(h,function(){try{this.builder.addServiceToken(a)}catch(b){if(b instanceof X)throw new E("Service token bound to incorrect authentication tokens despite setting correct master token.",b);throw b;}return!0},f)},error:function(a){h.error(a)}})},f)},addMasterBoundPeerServiceToken:function(c,d,e,l,h){var f=this;b(h,function(){var n=this.builder.getPeerMasterToken();
if(!n)return!1;var I=a(c,this.cryptoContexts);if(!I)return!1;hb(this.ctx,c,d,n,null,e,l,I,{result:function(a){b(h,function(){try{this.builder.addPeerServiceToken(a)}catch(b){if(b instanceof X)throw new E("Service token bound to incorrect authentication tokens despite setting correct master token.",b);throw b;}return!0},f)},error:function(a){h.error(a)}})},f)},addUserBoundPrimaryServiceToken:function(d,g,e,m,h){var f=this;b(h,function(){var n=c(this);if(!n)return!1;var I=this.builder.getUserIdToken();
if(!I)return!1;var N=a(d,this.cryptoContexts);if(!N)return!1;hb(this.ctx,d,g,n,I,e,m,N,{result:function(a){b(h,function(){try{this.builder.addServiceToken(a)}catch(b){if(b instanceof X)throw new E("Service token bound to incorrect authentication tokens despite setting correct master token and user ID token.",b);throw b;}return!0},f)},error:function(a){h.error(a)}})},f)},addUserBoundPeerServiceToken:function(c,d,e,l,h){var f=this;b(h,function(){var n=this.builder.getPeerMasterToken();if(!n)return!1;
var I=this.builder.getPeerUserIdToken();if(!I)return!1;var N=a(c,this.cryptoContexts);if(!N)return!1;hb(this.ctx,c,d,n,I,e,l,N,{result:function(a){b(h,function(){try{this.builder.addPeerServiceToken(a)}catch(b){if(b instanceof X)throw new E("Service token bound to incorrect authentication tokens despite setting correct master token and user ID token.",b);throw b;}return!0},f)},error:function(a){h.error(a)}})},f)},excludePrimaryServiceToken:function(a){for(var b=this.builder.getServiceTokens(),c=0;c<
b.length;++c)if(b[c].name==a)return this.builder.excludeServiceToken(a),!0;return!1},excludePeerServiceToken:function(a){for(var b=this.builder.getPeerServiceTokens(),c=0;c<b.length;++c)if(b[c].name==a)return this.builder.excludePeerServiceToken(a),!0;return!1},deletePrimaryServiceToken:function(a,c){b(c,function(){for(var b=this.builder.getServiceTokens(),d=0;d<b.length;++d)if(b[d].name==a){this.builder.deleteServiceToken(a,{result:function(){c.result(!0)},error:function(a){c.error(a)}});return}return!1},
this)},deletePeerServiceToken:function(a,c){b(c,function(){for(var b=this.builder.getPeerServiceTokens(),d=0;d<b.length;++d)if(b[d].name==a){this.builder.deletePeerServiceToken(a,{result:function(){c.result(!0)},error:function(a){c.error(a)}});return}return!1},this)}})})();var nd,od;(function(){function c(d,k,g,e){b(e,function(){function c(){b(e,function(){if(Y>=g.length){if(N)throw N;throw new V(a.KEYX_RESPONSE_REQUEST_MISMATCH,JSON.stringify(g));}var k=g[Y];n!=k.keyExchangeScheme?(++Y,c()):I.getCryptoContext(d,
k,f,h,{result:e.result,error:function(a){b(e,function(){if(!(a instanceof p))throw a;N=a;++Y;c()})}})})}var h=k.masterToken,f=k.keyResponseData;if(!f)return null;var n=f.keyExchangeScheme,I=d.getKeyExchangeFactory(n);if(!I)throw new V(a.KEYX_FACTORY_NOT_FOUND,n);var N,Y=0;c()})}nd=Rc.extend({init:function(b,d,g,h,m,f,H){var n=this;e(H,function(){function e(){n._ready=!0;n._readyQueue.add(!0)}function H(a,b){try{var c=b.masterToken;a.getTokenFactory().isMasterTokenRevoked(a,c,{result:function(d){d?
(n._errored=(new wa(d,c)).setUser(b.userIdToken).setUser(b.userAuthenticationData).setMessageId(b.messageId),e()):Y(a,b)},error:function(a){a instanceof p&&(a.setEntity(b.masterToken),a.setUser(b.userIdToken),a.setUser(b.userAuthenticationData),a.setMessageId(b.messageId));n._errored=a;e()}})}catch(d){d instanceof p&&(d.setEntity(b.masterToken),d.setUser(b.userIdToken),d.setUser(b.userAuthenticationData),d.setMessageId(b.messageId)),n._errored=d,e()}}function Y(a,b){try{var c=b.masterToken,d=b.userIdToken;
d?a.getTokenFactory().isUserIdTokenRevoked(a,c,d,{result:function(g){g?(n._errored=(new MslUserIdTokenException(g,d)).setEntity(c).setUser(d).setMessageId(b.messageId),e()):fa(a,b)},error:function(a){a instanceof p&&(a.setEntity(b.masterToken),a.setUser(b.userIdToken),a.setUser(b.userAuthenticationData),a.setMessageId(b.messageId));n._errored=a;e()}}):fa(a,b)}catch(g){g instanceof p&&(g.setEntity(b.masterToken),g.setUser(b.userIdToken),g.setUser(b.userAuthenticationData),g.setMessageId(b.messageId)),
n._errored=g,e()}}function fa(b,c){try{var d=c.masterToken;d.isExpired()?c.isRenewable()&&0!=c.keyRequestData.length?b.getTokenFactory().isMasterTokenRenewable(b,d,{result:function(a){a?(n._errored=(new X(a,"Master token is expired and not renewable.")).setEntity(d).setUser(c.userIdToken).setUser(c.userAuthenticationData).setMessageId(c.messageId),e()):U(b,c)},error:function(a){a instanceof p&&(a.setEntity(c.masterToken),a.setUser(c.userIdToken),a.setUser(c.userAuthenticationData),a.setMessageId(c.messageId));
n._errored=a;e()}}):(n._errored=(new X(a.MESSAGE_EXPIRED,JSON.stringify(c))).setEntity(d).setUser(c.userIdToken).setUser(c.userAuthenticationData).setMessageId(c.messageId),e()):U(b,c)}catch(g){g instanceof p&&(g.setEntity(c.masterToken),g.setUser(c.userIdToken),g.setUser(c.userAuthenticationData),g.setMessageId(c.messageId)),n._errored=g,e()}}function U(b,c){try{var d=c.masterToken;c.isNonReplayable()?c.isRenewable()&&0!=c.keyRequestData.length&&d?b.getTokenFactory().isNewestMasterToken(b,d,{result:function(g){g?
B(b,c):(n._errored=(new X(a.MESSAGE_REPLAYED,JSON.stringify(c))).setEntity(d).setUser(c.userIdToken).setUser(c.userAuthenticationData).setMessageId(c.messageId),e())},error:function(a){a instanceof p&&(a.setEntity(d),a.setUser(c.userIdToken),a.setUser(c.userAuthenticationData),a.setMessageId(c.messageId));n._errored=a;e()}}):(n._errored=(new X(a.INCOMPLETE_NONREPLAYABLE_MESSAGE,JSON.stringify(c))).setEntity(d).setEntity(c.entityAuthenticationData).setUser(c.userIdToken).setUser(c.userAuthenticationData).setMessageId(c.messageId),
e()):B(b,c)}catch(g){g instanceof p&&(g.setEntity(c.masterToken),g.setEntity(c.entityAuthenticationData),g.setUser(c.userIdToken),g.setUser(c.userAuthenticationData),g.setMessageId(c.messageId)),n._errored=g,e()}}function B(b,c){try{var d=c.masterToken,g=c.nonReplayableId;"number"===typeof g?d?b.getTokenFactory().acceptNonReplayableId(b,d,g,{result:function(b){b||(n._errored=(new X(a.MESSAGE_REPLAYED,JSON.stringify(c))).setEntity(d).setUser(c.userIdToken).setUser(c.userAuthenticationData).setMessageId(c.messageId));
e()},error:function(a){a instanceof p&&(a.setEntity(d),a.setUser(c.userIdToken),a.setUser(c.userAuthenticationData),a.setMessageId(c.messageId));n._errored=a;e()}}):(n._errored=(new X(a.INCOMPLETE_NONREPLAYABLE_MESSAGE,JSON.stringify(c))).setEntity(c.entityAuthenticationData).setUser(c.userIdToken).setUser(c.userAuthenticationData).setMessageId(c.messageId),e()):e()}catch(k){k instanceof p&&(k.setEntity(c.masterToken),k.setEntity(c.entityAuthenticationData),k.setUser(c.userIdToken),k.setUser(c.userAuthenticationData),
k.setMessageId(c.messageId)),n._errored=k,e()}}var P={_source:{value:d,writable:!1,enumerable:!1,configurable:!1},_parser:{value:void 0,writable:!0,enumerable:!1,configurable:!1},_charset:{value:g,writable:!1,enumerable:!1,configurable:!1},_remainingData:{value:"",writable:!0,enumerable:!1,configurable:!1},_timeout:{value:f,writable:!1,enumerable:!1,configurable:!1},_header:{value:void 0,writable:!0,enumerable:!1,configurable:!1},_cryptoContext:{value:void 0,writable:!0,enumerable:!1,configurable:!1},
_keyxCryptoContext:{value:void 0,writable:!0,enumerable:!1,configurable:!1},_payloadSequenceNumber:{value:1,writable:!0,enuemrable:!1,configurable:!1},_eom:{value:!1,writable:!0,enumerable:!1,configurable:!1},_handshake:{value:null,writable:!0,enumerable:!1,configurable:!1},_closeSource:{value:!1,writable:!0,enumerable:!1,configurable:!1},_payloads:{value:[],writable:!0,enumerable:!1,configurable:!1},_payloadIndex:{value:-1,writable:!0,enumerable:!1,configurable:!1},_payloadOffset:{value:0,writable:!0,
enuemrable:!1,configurable:!1},_markOffset:{value:0,writable:!0,enumerable:!1,configurable:!1},_currentPayload:{value:null,writable:!0,enumerable:!1,configurable:!1},_readException:{value:null,writable:!0,enumerable:!1,configurable:!1},_ready:{value:!1,writable:!0,enumerable:!1,configurable:!1},_readyQueue:{value:new ea,writable:!1,enumerable:!1,configurable:!1},_aborted:{value:!1,writable:!0,enumerable:!1,configurable:!1},_timedout:{value:!1,writable:!0,enumerable:!1,configurable:!1},_errored:{value:null,
writable:!0,enumerable:!1,configurable:!1}};Object.defineProperties(this,P);Sc(n._source,f,{result:function(d){n._json=d;n._jsonIndex=0;null===n._json?(n._errored=new G(a.MESSAGE_DATA_MISSING),e()):Yc(b,n._json[n._jsonIndex++],m,{result:function(d){n._header=d;if(n._header instanceof qb)n._keyxCryptoContext=null,n._cryptoContext=null,e();else{var g=n._header;c(b,g,h,{result:function(c){try{n._keyxCryptoContext=c;b.isPeerToPeer()||!n._keyxCryptoContext?n._cryptoContext=g.cryptoContext:n._cryptoContext=
n._keyxCryptoContext;try{if(g.isHandshake()&&(!g.isRenewable()||0==g.keyRequestData.length))throw new X(a.HANDSHAKE_DATA_MISSING,JSON.stringify(g));try{var d=g.masterToken;d&&(b.isPeerToPeer()||d.isVerified())?H(b,g):U(b,g)}catch(k){k instanceof p&&(k.setEntity(g.masterToken),k.setUser(g.userIdToken),k.setUser(g.userAuthenticationData),k.setMessageId(g.messageId)),n._errored=k,e()}}catch(h){h instanceof p&&(h.setEntity(g.masterToken),h.setEntity(g.entityAuthenticationData),h.setUser(g.userIdToken),
h.setUser(g.userAuthenticationData),h.setMessageId(g.messageId)),n._errored=h,e()}}catch(C){C instanceof p&&(C.setEntity(g.masterToken),C.setEntity(g.entityAuthenticationData),C.setUser(g.userIdToken),C.setUser(g.userAuthenticationData),C.setMessageId(g.messageId)),n._errored=C,e()}},error:function(a){a instanceof p&&(a.setEntity(g.masterToken),a.setEntity(g.entityAuthenticationData),a.setUser(g.userIdToken),a.setUser(g.userAuthenticationData),a.setMessageId(g.messageId));n._errored=a;e()}})}},error:function(a){n._errored=
a;e()}})},timeout:function(){n._timedout=!0;e()},error:function(a){n._errored=a;e()}});return this},n)},nextData:function(b,c){var d=this;e(c,function(){function b(a){e(a,function(){var c;if(this._jsonIndex<this._json.length)return c=this._json[this._jsonIndex++];Sc(this._source,this._timeout,{result:function(c){c&&c.length&&0<c.length?(c.forEach(function(a){this._json.push(a)}),b(a)):(this._eom=!0,a.result(null))},timeout:a.timeout,error:a.error})},d)}var l=this.getMessageHeader();if(!l)throw new E("Read attempted with error message.");
if(-1!=this._payloadIndex&&this._payloadIndex<this._payloads.length)return this._payloads[this._payloadIndex++];if(this._eom)return null;b({result:function(b){e(c,function(){if(!b)return null;if("object"!==typeof b)throw new G(a.MESSAGE_FORMAT_ERROR);jd(b,this._cryptoContext,{result:function(b){e(c,function(){var c=l.masterToken,d=l.entityAuthenticationData,g=l.userIdToken,k=l.getUserAuthenticationData;if(b.messageId!=l.messageId)throw(new X(a.PAYLOAD_MESSAGE_ID_MISMATCH,"payload mid "+b.messageId+
" header mid "+l.messageId)).setEntity(c).setEntity(d).setUser(g).setUser(k);if(b.sequenceNumber!=this._payloadSequenceNumber)throw(new X(a.PAYLOAD_SEQUENCE_NUMBER_MISMATCH,"payload seqno "+b.sequenceNumber+" expected seqno "+this._payloadSequenceNumber)).setEntity(c).setEntity(d).setUser(g).setUser(k);++this._payloadSequenceNumber;null==this._handshake&&(this._handshake=l.isRenewable()&&0<l.keyRequestData.length&&b.isEndOfMessage()&&0==b.data.length);b.isEndOfMessage()&&(this._eom=!0);c=b.data;this._payloads.push(c);
this._payloadIndex=-1;return c},d)},error:function(b){b instanceof SyntaxError&&(b=new G(a.JSON_PARSE_ERROR,"payloadchunk",b));c.error(b)}})},d)},timeout:function(){c.timeout()},error:function(a){c.error(a)}})},d)},isReady:function(a){function b(){e(a,function(){if(this._aborted)return!1;if(this._timedout)a.timeout();else{if(this._errored)throw this._errored;return!0}},c)}var c=this;e(a,function(){this._ready?b():this._readyQueue.poll(-1,{result:function(d){e(a,function(){if(void 0===d)return!1;b()},
c)},timeout:function(){a.timeout()},error:function(b){a.error(b)}})},c)},isHandshake:function(a,b){var c=this;e(b,function(){var d=this.getMessageHeader();if(!d)return!1;if(d.isHandshake())return!0;if(null==this._handshake)this.nextData(a,{result:function(a){e(b,function(){if(!this._aborted)return this._currentPayload=a,this._payloadOffset=0,this._currentPayload||(this._handshake=!1),this._handshake},c)},timeout:b.timeout,error:function(a){e(b,function(){a instanceof p&&(this._readException=new ha("Error reading the payload chunk.",
a));throw a;},c)}});else return this._handshake},c)},getMessageHeader:function(){return this._header instanceof Cb?this._header:null},getErrorHeader:function(){return this._header instanceof qb?this._header:null},getIdentity:function(){var a=this.getMessageHeader();if(a){var b=a.masterToken;return b?b.identity:a.entityAuthenticationData.getIdentity()}return this.getErrorHeader().entityAuthenticationData.getIdentity()},getUser:function(){var a=this.getMessageHeader();return a?a.user:null},getPayloadCryptoContext:function(){return this._cryptoContext},
getKeyExchangeCryptoContext:function(){return this._keyxCryptoContext},closeSource:function(a){this._closeSource=a},abort:function(){this._aborted=!0;this._source.abort();this._readyQueue.cancelAll()},close:function(a,b){var c=this;e(b,function(){function d(){c.nextData(a,{result:function(a){a?d():b.result(!0)},timeout:b.timeout,error:function(){b.result(!0)}})}if(this._closeSource)this._source.close(a,b);else{if(!this.getMessageHeader())return!0;this.isHandshake(a,{result:function(a){a?b.result(!0):
d()},timeout:b.timeout,error:function(){b.result(!0)}})}},c)},mark:function(){if(this._currentPayload){for(;0<this._payloads.length&&this._payloads[0]!==this._currentPayload;)this._payloads.shift();this._payloadIndex=0;this._currentPayload=this._payloads[this._payloadIndex++];this._markOffset=this._payloadOffset}else this._payloadIndex=-1,this._payloads=[]},markSupported:function(){return!0},read:function(a,b,c){function d(){e(c,function(){if(this._aborted)return new Uint8Array(0);if(this._timedout)c.timeout(new Uint8Array(0));
else{if(this._errored)throw this._errored;if(null!=this._readException){var a=this._readException;this._readException=null;throw a;}this.isHandshake(b,{result:function(a){e(c,function(){if(void 0===a)return new Uint8Array(0);if(a)return null;h()},f)},timeout:c.timeout,error:function(a){e(c,function(){this._readException=null;throw new ha("Error reading the payload chunk.",a);},f)}})}},f)}function h(){e(c,function(){function d(c){e(c,function(){if(h&&u>=h.length)return h.subarray(0,u);var g=-1;if(this._currentPayload){var U=
this._currentPayload.length-this._payloadOffset;if(!h){var B=U;if(-1!=this._payloadIndex)for(var P=this._payloadIndex;P<this._payloads.length;++P)B+=this._payloads[P].length;0<B&&(h=new Uint8Array(B))}U=Math.min(U,h?h.length-u:0);0<U&&(g=this._currentPayload.subarray(this._payloadOffset,this._payloadOffset+U),h.set(g,m),g=U,m+=U,this._payloadOffset+=U)}-1!=g?(u+=g,d(c)):this.nextData(b,{result:function(b){e(c,function(){if(this._aborted)return h?h.subarray(0,u):new Uint8Array(0);this._currentPayload=
b;this._payloadOffset=0;if(this._currentPayload)d(c);else return 0==u&&0!=a?null:h?h.subarray(0,u):new Uint8Array(0)},f)},timeout:function(){c.timeout(h?h.subarray(0,u):new Uint8Array(0))},error:function(a){e(c,function(){a instanceof p&&(a=new ha("Error reading the payload chunk.",a));if(0<u)return f._readException=a,h.subarray(0,u);throw a;},f)}})},f)}var h=-1!=a?new Uint8Array(a):void 0,m=0,u=0;d(c)},f)}var f=this;e(c,function(){if(-1>a)throw new RangeError("read requested with illegal length "+
a);this._ready?d():this._readyQueue.poll(b,{result:function(a){void 0===a?c.result(!1):d()},timeout:function(){c.timeout(new Uint8Array(0))},error:function(a){c.error(a)}})},f)},reset:function(){this._payloadIndex=0;0<this._payloads.length?(this._currentPayload=this._payloads[this._payloadIndex++],this._payloadOffset=this._markOffset):this._currentPayload=null}});od=function(a,b,c,d,e,h,f){new nd(a,b,c,d,e,h,f)}})();var pd,wc;(function(){pd=nc.extend({init:function(a,b,c,d,h,m,f){var H=this;e(f,function(){function e(){H._ready=
!0;H._readyQueue.add(!0)}var f=tc(a.getMessageCapabilities(),d.messageCapabilities),v=null;f&&(v=O(f.compressionAlgorithms));f={_destination:{value:b,writable:!1,enumerable:!1,configurable:!1},_charset:{value:c,writable:!1,enumerable:!1,configurable:!1},_capabilities:{value:f,writable:!1,enumerable:!1,configurable:!1},_header:{value:d,writable:!1,enumerable:!1,configurable:!1},_compressionAlgo:{value:v,writable:!0,enumerable:!1,configurable:!1},_cryptoContext:{value:h,writable:!1,enumerable:!1,configurable:!1},
_payloadSequenceNumber:{value:1,writable:!0,enumerable:!1,configurable:!1},_currentPayload:{value:[],writable:!0,enumerable:!1,configurable:!1},_closed:{value:!1,writable:!0,enumerable:!1,configurable:!1},_closeDestination:{value:!1,writable:!0,enuemrable:!1,configurable:!1},_caching:{value:!0,writable:!0,enumerable:!1,configurable:!1},_payloads:{value:[],writable:!1,enumerable:!1,configurable:!1},_ready:{value:!1,writable:!0,enumerable:!1,configurable:!1},_readyQueue:{value:new ea,writable:!1,enumerable:!1,
configurable:!1},_aborted:{value:!1,writable:!0,enumerable:!1,configurable:!1},_timedout:{value:!1,writable:!0,enumerable:!1,configurable:!1},_errored:{value:null,writable:!0,enumerable:!1,configurable:!1}};Object.defineProperties(this,f);var p=Z(JSON.stringify(d),c);b.write(p,0,p.length,m,{result:function(a){try{H._aborted?e():a<p.length?(H._timedout=!0,e()):b.flush(m,{result:function(a){H._aborted||(H._timedout=!a);e()},timeout:function(){H._timedout=!0;e()},error:function(a){H._errored=a;e()}})}catch(c){H._errored=
c,e()}},timeout:function(){H._timedout=!0;e()},error:function(a){H._errored=a;e()}});return this},H)},setCompressionAlgorithm:function(a,b,c){function d(){h.flush(b,{result:function(b){e(c,function(){if(!b)throw new ha("flush() aborted");this._compressionAlgo=a;return!0},h)},timeout:function(){c.timeout()},error:function(a){c.error(a)}})}var h=this;e(c,function(){if(!this.getMessageHeader())throw new E("Cannot write payload data for an error message.");if(this._compressionAlgo==a)return!0;if(a){if(!this._capabilities)return!1;
for(var b=this._capabilities.compressionAlgorithms,c=0;c<b.length;++c)if(b[c]==a){d();return}return!1}d()},h)},getMessageHeader:function(){return this._header instanceof Cb?this._header:null},getErrorMessage:function(){return this._header instanceof qb?this._header:null},getPayloads:function(){return this._payloads},stopCaching:function(){this._caching=!1;this._payloads.length=0},abort:function(){this._aborted=!0;this._destination.abort();this._readyQueue.cancelAll()},closeDestination:function(a){this._closeDestination=
a},close:function(a,b){var c=this;e(b,function(){if(this._aborted)return!1;if(this._timedout)b.timeout();else{if(this._errored)throw this._errored;if(this._closed)return!0;this._closed=!0;this.flush(a,{result:function(d){e(b,function(){d&&(this._currentPayload=null);if(this._closeDestination)this._destination.close(a,b);else return d},c)},timeout:b.timeout,error:b.error})}},c)},flush:function(a,b){function c(){e(b,function(){if(this._aborted)return!1;if(this._timedout)b.timeout();else{if(this._errored)throw this._errored;
if(!this._currentPayload||!this._closed&&0==this._currentPayload.length)return!0;var c=this.getMessageHeader();if(!c||c.isHandshake())return!0;var k=0;this._currentPayload&&this._currentPayload.forEach(function(a){k+=a.length});for(var h=new Uint8Array(k),f=0,n=0;this._currentPayload&&n<this._currentPayload.length;++n){var I=this._currentPayload[n];h.set(I,f);f+=I.length}id(this._payloadSequenceNumber,c.messageId,this._closed,this._compressionAlgo,h,this._cryptoContext,{result:function(c){e(b,function(){this._caching&&
this._payloads.push(c);var k=Z(JSON.stringify(c),this._charset);this._destination.write(k,0,k.length,a,{result:function(k){e(b,function(){if(this._aborted)return!1;k<c.length?b.timeout():this._destination.flush(a,{result:function(a){e(b,function(){if(this._aborted)return!1;if(a)return++this._payloadSequenceNumber,this._currentPayload=this._closed?null:[],!0;b.timeout()},d)},timeout:function(){b.timeout()},error:function(a){a instanceof p&&(a=new ha("Error encoding payload chunk [sequence number "+
d._payloadSequenceNumber+"].",a));b.error(a)}})},d)},timeout:function(a){b.timeout()},error:function(a){a instanceof p&&(a=new ha("Error encoding payload chunk [sequence number "+d._payloadSequenceNumber+"].",a));b.error(a)}})},d)},error:function(a){a instanceof p&&(a=new ha("Error encoding payload chunk [sequence number "+d._payloadSequenceNumber+"].",a));b.error(a)}})}},d)}var d=this;e(b,function(){this._ready?c():this._readyQueue.poll(a,{result:function(a){void 0===a?b.result(!1):c()},timeout:function(){b.timeout()},
error:function(a){b.error(a)}})},d)},write:function(a,b,c,d,h){e(h,function(){if(this._aborted)return!1;if(this._timedout)h.timeout();else{if(this._errored)throw this._errored;if(this._closed)throw new ha("Message output stream already closed.");if(0>b)throw new RangeError("Offset cannot be negative.");if(0>c)throw new RangeError("Length cannot be negative.");if(b+c>a.length)throw new RangeError("Offset plus length cannot be greater than the array length.");var d=this.getMessageHeader();if(!d)throw new E("Cannot write payload data for an error message.");
if(d.isHandshake())throw new E("Cannot write payload data for a handshake message.");d=a.subarray(b,b+c);this._currentPayload.push(d);return d.length}},this)}});wc=function(a,b,c,d,e,h,f){new pd(a,b,c,d,e,h,f)}})();Object.freeze({USERDATA_REAUTH:c.USERDATA_REAUTH,SSOTOKEN_REJECTED:c.SSOTOKEN_REJECTED});var Ib=x.Class.create({getCryptoContexts:function(){},getRecipient:function(){},isEncrypted:function(){},isIntegrityProtected:function(){},isNonReplayable:function(){},isRequestingTokens:function(){},
getUserId:function(){},getUserAuthData:function(a,b,c,d){},getUser:function(){},getKeyRequestData:function(a){},updateServiceTokens:function(a,b,c){},write:function(a,b,c){},getDebugContext:function(){}}),se=x.Class.create({sentHeader:function(a){},receivedHeader:function(a){}});x.Class.create({getInputStream:function(a){},getOutputStream:function(a){}});var qd;(function(){function d(a){return function(){a.abort()}}function l(a,b){Object.defineProperties(this,{masterToken:{value:a,writable:!1,configurable:!1},
ticket:{value:b,writable:!1,configurable:!1}})}function k(a,b){Object.defineProperties(this,{builder:{value:a,writable:!1,configurable:!1},msgCtx:{value:b,writable:!1,configurable:!1}})}function g(a,b){Object.defineProperties(this,{request:{value:a,writable:!1,configurable:!1},handshake:{value:b,writable:!1,configurable:!1}})}function f(a,b){Object.defineProperties(this,{request:{value:b.request,writable:!1,configurable:!1},handshake:{value:b.handshake,writable:!1,configurable:!1},response:{value:a,
writable:!1,configurable:!1}})}function m(a){for(;a;){if(a instanceof h)return!0;a=a instanceof p?a.cause:void 0}return!1}function v(a){var b=a.masterToken;return b?b.identity:a.entityAuthenticationData.getIdentity()}function H(a,b,c,d,g,k,l,f,m,n){ld(b,d,g,k,l,{result:function(d){c&&c.sentHeader(d);wc(b,f,W,d,null,null,m,{result:function(b){a.setAbort(function(){b.abort()});b.close(m,{result:function(a){e(n,function(){if(!a)throw new h("sendError aborted.");return a})},timeout:function(){n.timeout()},
error:function(a){n.error(a)}})},timeout:function(){},error:function(a){n.error(a)}})},error:function(a){n.error(a)}})}var n=function(a,b){Object.defineProperties(this,{input:{value:a,writable:!1,configurable:!1},output:{value:b,writable:!1,configurable:!1}});return this};nc.extend({close:function(a,b){b.result(!0)},write:function(a,c,d,g,e){b(e,function(){return Math.min(a.length-c,d)})},flush:function(a,b){b.result(!0)}});var I=fe.extend({getUserMessage:function(a,b){return null}}),N=Ib.extend({init:function(a){Object.defineProperties(this,
{_appCtx:{value:a,writable:!1,enumerable:!1,configurable:!1}})},getCryptoContexts:function(){return this._appCtx.getCryptoContexts()},getRecipient:function(){return this._appCtx.getRecipient()},isEncrypted:function(){return this._appCtx.isEncrypted()},isIntegrityProtected:function(){return this._appCtx.isIntegrityProtected()},isNonReplayable:function(){return this._appCtx.isNonReplayable()},isRequestingTokens:function(){return this._appCtx.isRequestingTokens()},getUserId:function(){return this._appCtx.getUserId()},
getUserAuthData:function(a,b,c,d){this._appCtx.getUserAuthData(a,b,c,d)},getUser:function(){return this._appCtx.getUser()},getKeyRequestData:function(a){this._appCtx.getKeyRequestData(a)},updateServiceTokens:function(a,b,c){this._appCtx.updateServiceTokens(a,b,c)},write:function(a,b,c){this._appCtx.write(a,b,c)},getDebugContext:function(){return this._appCtx.getDebugContext()}}),Y=N.extend({init:function pa(a,b){pa.base.call(this,b);Object.defineProperties(this,{_payloads:{value:a,writable:!1,enumerable:!1,
configurable:!1}})},write:function Ba(a,b,c){function d(k){if(k==g._payloads.length)c.result(!0);else{var h=g._payloads[k];a.setCompressionAlgorithm(h.compressionAlgo,b,{result:function(l){a.write(h.data,0,h.data.length,b,{result:function(l){e(c,function(){h.isEndOfMessage()?a.close(b,{result:function(a){a?d(k+1):c.result(a)},timeout:c.timeout,error:c.error}):a.flush(b,{result:function(a){a?d(k+1):c.result(a)},timeout:c.timeout,error:c.error})},g)},timeout:c.timeout,error:c.error})},timeout:c.timeout,
error:c.error})}}var g=this;this._payloads?d(0):Ba.base.call(this,a,b,c)}}),y=N.extend({init:function C(a){C.base.call(this,a)},isEncrypted:function(){return!1},isIntegrityProtected:function(){return!1},isNonReplayable:function(){return!1},write:function(a,b,c){c.result(!0)}}),U={},B,P,M,r,R=x.Class.create({init:function(a){a||(a=new I);Object.defineProperties(this,{_filterFactory:{value:null,writable:!0,enumerable:!1,configurable:!1},_renewingContexts:{value:[],writable:!1,enumerable:!1,configurable:!1},
_masterTokenLocks:{value:{},writable:!1,enumerable:!1,configurable:!1},_messageRegistry:{value:a,writable:!1,enumerable:!1,configurable:!1}})},setFilterFactory:function(a){this._filterFactory=a},getNewestMasterToken:function(a,b,c,d){var g=this;e(d,function(){var k=b.getMslStore(),f=k.getMasterToken();if(!f)return null;var m=f.uniqueKey(),n=this._masterTokenLocks[m];n||(n=new ib,this._masterTokenLocks[m]=n);var u=n.readLock(c,{result:function(u){e(d,function(){if(void 0===u)throw new h("getNewestMasterToken aborted.");
var r=k.getMasterToken();if(f.equals(r))return new l(f,u);n.unlock(u);n.writeLock(c,{result:function(k){e(d,function(){if(void 0===k)throw new h("getNewestMasterToken aborted.");delete this._masterTokenLocks[m];n.unlock(k);return this.getNewestMasterToken(a,b,c,d)},g)},timeout:function(){d.timeout()},error:function(a){d.error(a)}})},g)},timeout:function(){d.timeout()},error:function(a){d.error(a)}});a.setAbort(function(){u&&(n.cancel(u),u=void 0)})},g)},deleteMasterToken:function(a,b){if(b){var c=
this;setTimeout(function(){var d=b.uniqueKey(),g=c._masterTokenLocks[d];g||(g=new ib,c._masterTokenLocks[d]=g);g.writeLock(-1,{result:function(e){a.getMslStore().removeCryptoContext(b);delete c._masterTokenLocks[d];g.unlock(e)},timeout:function(){throw new E("Unexpected timeout received.");},error:function(a){throw a;}})},0)}},releaseMasterToken:function(a){if(a&&a.masterToken){var b=a.masterToken.uniqueKey();(b=this._masterTokenLocks[b])&&b.unlock(a.ticket)}},updateOutgoingCryptoContexts:function(a,
b,c){var d=a.getMslStore();!a.isPeerToPeer()&&c&&(d.setCryptoContext(c.keyResponseData.masterToken,c.cryptoContext),this.deleteMasterToken(a,b.masterToken))},updateIncomingCryptoContexts:function(a,b,c){var d=c.getMessageHeader();if(d){var g=a.getMslStore();if(d=d.keyResponseData)g.setCryptoContext(d.masterToken,c.getKeyExchangeCryptoContext()),this.deleteMasterToken(a,b.masterToken)}},storeServiceTokens:function(a,b,c,d){a=a.getMslStore();for(var g=[],e=0;e<d.length;++e){var k=d[e];if(!k.isBoundTo(b)||
!b.isVerified()){var h=k.data;h&&0==h.length?a.removeServiceTokens(k.name,k.isMasterTokenBound()?b:null,k.isUserIdTokenBound()?c:null):g.push(k)}}0<g.length&&a.addServiceTokens(g)},buildRequest:function(a,c,d,g,e){var k=this;this.getNewestMasterToken(a,c,g,{result:function(a){b(e,function(){var g=a&&a.masterToken,h;if(g){h=d.getUserId();var C=c.getMslStore();h=(h=h?C.getUserIdToken(h):null)&&h.isBoundTo(g)?h:null}else h=null;C=d.getRecipient();ub(c,g,h,C,null,{result:function(c){b(e,function(){c.setNonReplayable(d.isNonReplayable());
return{builder:c,tokenTicket:a}})},error:function(c){b(e,function(){this.releaseMasterToken(a);c instanceof p&&(c=new E("User ID token not bound to master token despite internal check.",c));throw c;},k)}})},k)},timeout:function(){e.timeout()},error:function(a){e.error(a)}})},buildResponse:function(a,b,c,d,g,k){var h=this;kd(b,d,{result:function(f){e(k,function(){f.setNonReplayable(c.isNonReplayable());if(!b.isPeerToPeer()&&!d.keyResponseData)return{builder:f,tokenTicket:null};this.getNewestMasterToken(a,
b,g,{result:function(a){e(k,function(){var d=a&&a.masterToken,g;if(d){g=c.getUserId();var e=b.getMslStore();g=(g=g?e.getUserIdToken(g):null)&&g.isBoundTo(d)?g:null}else g=null;f.setAuthTokens(d,g);return{builder:f,tokenTicket:a}},h)},timeout:function(){k.timeout()},error:function(a){k.error(a)}})},h)},error:function(a){k.error(a)}})},buildErrorResponse:function(a,b,d,g,h,f,l){function m(a,c){e(l,function(){var g=tb(h.messageId),C=new Y(c,d),f=C.getRecipient();ub(b,null,null,f,g,{result:function(c){e(l,
function(){b.isPeerToPeer()&&c.setPeerAuthTokens(a.peerMasterToken,a.peerUserIdToken);c.setNonReplayable(C.isNonReplayable());return{errorResult:new k(c,C),tokenTicket:null}},u)},error:function(a){l.error(a)}})},u)}function n(c,g){u.getNewestMasterToken(a,b,f,{result:function(a){e(l,function(){var C=a&&a.masterToken,f=tb(h.messageId),m=new Y(g,d),n=m.getRecipient();ub(b,C,null,n,f,{result:function(d){e(l,function(){b.isPeerToPeer()&&d.setPeerAuthTokens(c.peerMasterToken,c.peerUserIdToken);d.setNonReplayable(m.isNonReplayable());
return{errorResult:new k(d,m),tokenTicket:a}},u)},error:function(a){l.error(a)}})},u)},timeout:function(){l.timeout()},error:function(a){l.error(a)}})}var u=this;e(l,function(){var r=g.request.getMessageHeader(),q=g.request.getPayloads(),v=h.errorCode;switch(v){case c.ENTITYDATA_REAUTH:case c.ENTITY_REAUTH:b.getEntityAuthenticationData(v,{result:function(a){e(l,function(){if(!a)return null;m(r,q)},u)},error:function(a){l.error(a)}});break;case c.USERDATA_REAUTH:case c.SSOTOKEN_REJECTED:d.getUserAuthData(v,
!1,!0,{result:function(a){e(l,function(){if(!a)return null;n(r,q)},u)},error:function(a){l.error(a)}});break;case c.USER_REAUTH:n(r,q);break;case c.KEYX_REQUIRED:var v=tb(h.messageId),B=new Y(q,d),P=B.getRecipient();ub(b,null,null,P,v,{result:function(a){e(l,function(){b.isPeerToPeer()&&a.setPeerAuthTokens(r.peerMasterToken,r.peerUserIdToken);a.setRenewable(!0);a.setNonReplayable(B.isNonReplayable());return{errorResult:new k(a,B),tokenTicket:null}},u)},error:function(a){l.error(a)}});break;case c.EXPIRED:this.getNewestMasterToken(a,
b,f,{result:function(a){e(l,function(){var c=a&&a.masterToken,g=r.userIdToken,C=tb(h.messageId),f=new Y(q,d),m=f.getRecipient();ub(b,c,g,m,C,{result:function(d){e(l,function(){b.isPeerToPeer()&&d.setPeerAuthTokens(r.peerMasterToken,r.peerUserIdToken);var g=r.masterToken;g&&!g.equals(c)||d.setRenewable(!0);d.setNonReplayable(f.isNonReplayable());return{errorResult:new k(d,f),tokenTicket:a}},u)},error:function(a){l.error(a)}},u)},u)},timeout:function(){l.timeout()},error:function(a){l.error(a)}});break;
case c.REPLAYED:this.getNewestMasterToken(a,b,f,{result:function(a){e(l,function(){var c=a&&a.masterToken,g=r.userIdToken,C=tb(h.messageId),f=new Y(q,d),m=f.getRecipient();ub(b,c,g,m,C,{result:function(d){e(l,function(){b.isPeerToPeer()&&d.setPeerAuthTokens(r.peerMasterToken,r.peerUserIdToken);var g=r.masterToken;!g||g.equals(c)?(d.setRenewable(!0),d.setNonReplayable(!1)):d.setNonReplayable(f.isNonReplayable());return{errorResult:new k(d,f),tokenTicket:a}},u)},error:function(a){l.error(a)}})},u)},
timeout:function(){l.timeout()},error:function(a){l.error(a)}});break;default:return null}},u)},cleanupContext:function(a,b,d){switch(d.errorCode){case c.ENTITY_REAUTH:this.deleteMasterToken(a,b.masterToken);break;case c.USER_REAUTH:d=b.userIdToken,b.masterToken&&d&&a.getMslStore().removeUserIdToken(d)}},send:function(a,b,c,d,k,l,f,m){function u(a,d,g){e(m,function(){var h=k.getPeerUserIdToken();!b.isPeerToPeer()&&!d||b.isPeerToPeer()&&!h?(h=c.getUser())?k.setUser(h,{result:function(b){e(m,function(){d=
k.getUserIdToken();n(a,d,g)},v)},error:function(a){m.error(a)}}):n(a,d,g):n(a,d,g)},v)}function n(a,b,d){e(m,function(){var g=!(!(d||c.isEncrypted()&&!k.willEncryptPayloads()||c.isIntegrityProtected()&&!k.willIntegrityProtectPayloads())&&(!c.isNonReplayable()||k.isNonReplayable()&&a));k.setHandshake(g);var h=[];k.isRenewable()&&(!a||a.isRenewable()||c.isNonReplayable())?c.getKeyRequestData({result:function(c){e(m,function(){for(var d=0;d<c.length;++d){var e=c[d];h.push(e);k.addKeyRequestData(e)}r(a,
b,g,h)},v)},error:function(a){m.error(a)}}):r(a,b,g,h)},v)}function r(g,n,u,B){e(m,function(){var r=new md(b,c,k);c.updateServiceTokens(r,u,{result:function(r){k.getHeader({result:function(r){e(m,function(){var B=c.getDebugContext();B&&B.sentHeader(r);B=k.getKeyExchangeData();this.updateOutgoingCryptoContexts(b,r,B);this.storeServiceTokens(b,g,n,r.serviceTokens);B=!b.isPeerToPeer()&&B?B.cryptoContext:r.cryptoContext;if(a.isAborted())throw new h("send aborted.");var P=null!=this._filterFactory?this._filterFactory.getOutputStream(d):
d;wc(b,P,W,r,B,f,{result:function(b){e(m,function(){a.setAbort(function(){b.abort()});b.closeDestination(l);q(b,u)},v)},timeout:function(){m.timeout()},error:function(a){m.error(a)}})},v)},timeout:function(){m.timeout()},error:function(a){m.error(a)}})},error:function(a){m.error(a)}})},v)}function q(b,d){d?e(m,function(){return new g(b,d)},v):c.write(b,f,{result:function(c){e(m,function(){if(a.isAborted())throw new h("MessageOutputStream write aborted.");return new g(b,d)},v)},timeout:function(){m.timeout()},
error:function(a){m.error(a)}})}var v=this;e(m,function(){var a=k.getMasterToken(),b=k.getUserIdToken(),d=!1;if(c.getUserId()){var g=!b;c.getUserAuthData(null,k.isRenewable(),g,{result:function(c){e(m,function(){c&&(k.willEncryptHeader()&&k.willIntegrityProtectHeader()?k.setUserAuthenticationData(c):d=!0);u(a,b,d)},v)},error:function(a){m.error(a)}})}else u(a,b,d)},v)},receive:function(b,d,g,k,m,l,f){var u=this;e(f,function(){if(b.isAborted())throw new h("receive aborted.");var n=[];m&&(n=m.keyRequestData.filter(function(){return!0}));
var r=g.getCryptoContexts(),q=this._filterFactory?this._filterFactory.getInputStream(k):k;od(d,q,W,n,r,l,{result:function(k){b.setAbort(function(){k.abort()});k.isReady({result:function(b){e(f,function(){if(!b)throw new h("MessageInputStream aborted.");var C=k.getMessageHeader(),l=k.getErrorHeader(),n=g.getDebugContext();n&&n.receivedHeader(C?C:l);var r,q,v;C?(n=C.masterToken,r=C.entityAuthenticationData,q=C.userIdToken,v=C.userAuthenticationData):(n=null,r=l.entityAuthenticationData,v=q=null);if(m){var B=
l?l.errorCode:null;if(C||B!=c.FAIL&&B!=c.TRANSIENT_FAILURE&&B!=c.ENTITY_REAUTH&&B!=c.ENTITYDATA_REAUTH){var B=C?C.messageId:l.messageId,ma=tb(m.messageId);if(B!=ma)throw(new X(a.UNEXPECTED_RESPONSE_MESSAGE_ID,"expected "+ma+"; received "+B)).setEntity(n).setEntity(r).setUser(q).setUser(v);}}d.getEntityAuthenticationData(null,{result:function(b){e(f,function(){var c=b.getIdentity(),e;try{if(C){var h=C.entityAuthenticationData,f=C.masterToken;e=f?C.sender:h.getIdentity();if(f&&f.isDecrypted()&&f.identity!=
e||c==e)throw new X(a.UNEXPECTED_MESSAGE_SENDER,e);var n=C.recipient;if(n&&n!=c)throw new X(a.MESSAGE_RECIPIENT_MISMATCH,n);m&&this.updateIncomingCryptoContexts(d,m,k);var u=C.keyResponseData,r,B,ma;d.isPeerToPeer()?(r=u?u.masterToken:C.peerMasterToken,B=C.peerUserIdToken,ma=C.peerServiceTokens):(r=u?u.masterToken:C.masterToken,B=C.userIdToken,ma=C.serviceTokens);var P=g.getUserId();P&&B&&!B.isVerified()&&d.getMslStore().addUserIdToken(P,B);this.storeServiceTokens(d,r,B,ma)}else if(e=l.entityAuthenticationData.getIdentity(),
c==e)throw new X(a.UNEXPECTED_MESSAGE_SENDER,e);}catch(mb){throw mb instanceof p&&(mb.setEntity(f),mb.setEntity(h),mb.setUser(q),mb.setUser(v)),mb;}return k},u)},error:f.error})},u)},timeout:function(){f.timeout()},error:function(a){f.error(a)}})},timeout:function(){f.timeout()},error:function(a){f.error(a)}})},u)},sendReceive:function(a,b,c,d,g,k,l,m,n,r){function q(k,h,v){e(r,function(){var q=k.builder,P=k.tokenTicket;q.setRenewable(v);this.send(a,b,c,g,q,m,n,{result:function(g){e(r,function(){var k=
g.request.getMessageHeader(),q=k.keyRequestData;l||g.handshake||!q.isEmpty()||k.isRenewable()&&k.masterToken&&k.userAuthenticationData?this.receive(a,b,c,d,k,n,{result:function(a){e(r,function(){v&&this.releaseRenewalLock(b,h,a);this.releaseMasterToken(P);a.closeSource(m);return new f(a,g)},B)},timeout:function(){e(r,function(){v&&this.releaseRenewalLock(b,h,null);this.releaseMasterToken(P);r.timeout()},B)},error:function(a){e(r,function(){v&&this.releaseRenewalLock(b,h,null);this.releaseMasterToken(P);
r.error(a)},B)}}):e(r,function(){v&&this.releaseRenewalLock(b,h,null);this.releaseMasterToken(P);return new f(null,g)},B)},B)},timeout:function(){e(r,function(){v&&this.releaseRenewalLock(b,h,null);this.releaseMasterToken(P);r.timeout()},B)},error:function(a){e(r,function(){v&&this.releaseRenewalLock(b,h,null);this.releaseMasterToken(P);r.error(a)},B)}})},B)}var B=this;e(r,function(){var d=new ea;this.acquireRenewalLock(a,b,c,d,k,n,{result:function(a){q(k,d,a)},timeout:function(){e(r,function(){this.releaseMasterToken(k.ticket);
r.timeout()},B)},error:function(a){e(r,function(){this.releaseMasterToken(k.ticket);if(a instanceof h)return null;r.error(a)},B)}})},B)},acquireRenewalLock:function(a,b,c,d,g,k,f){function m(c,n,r,q){e(f,function(){if(a.isAborted())throw new h("acquireRenewalLock aborted.");for(var B=null,v=0;v<this._renewingContexts.length;++v){var P=this._renewingContexts[v];if(P.ctx===b){B=P.queue;break}}if(!B)return this._renewingContexts.push({ctx:b,queue:d}),!0;var Fa=B.poll(k,{result:function(d){e(f,function(){if(void 0===
d)throw new h("acquireRenewalLock aborted.");B.add(d);if(d===U)m(c,n,r,q);else{var v=c;c.equals(d)?l(v,c,n,r,q):(this.releaseMasterToken(q),this.getNewestMasterToken(a,b,k,{result:function(a){e(f,function(){(c=(g.tokenTicket=a)&&a.masterToken)?l(v,c,n,r,a):m(c,n,r,a)},u)},timeout:f.timeout,error:f.error}))}},u)},timeout:f.timeout,error:f.error});a.setAbort(function(){Fa&&(B.cancel(Fa),Fa=void 0)})},u)}function l(a,d,g,k,h){e(f,function(){if(k&&!g||g&&!g.isBoundTo(d)){var e=b.getMslStore().getUserIdToken(k);
g=e&&e.isBoundTo(d)?e:null}builder.setAuthTokens(d,g);d.isExpired()?m(d,g,k,h):builder.isRenewable()&&d.equals(a)?m(d,g,k,h):c.isRequestingTokens()&&!g?m(d,g,k,h):n(d,g)},u)}function n(g,k){e(f,function(){if(a.isAborted())throw new h("acquireRenewalLock aborted.");if(!g||g.isRenewable()||!k&&c.getUserId()||k&&k.isRenewable()){for(var e=null,f=0;f<this._renewingContexts.length;++f){var m=this._renewingContexts[f];if(m.ctx===b){e=m.queue;break}}if(!e)return this._renewingContexts.push({ctx:b,queue:d}),
!0}return!1},u)}var u=this;e(f,function(){var a=g.builder,b=g.tokenTicket,d=a.getMasterToken(),k=a.getUserIdToken(),e=c.getUserId();c.isEncrypted()&&!a.willEncryptPayloads()||c.isIntegrityProtected()&&!a.willIntegrityProtectPayloads()||a.isRenewable()||!d&&c.isNonReplayable()||d&&d.isExpired()||!(k||!e||a.willEncryptHeader()&&a.willIntegrityProtectHeader())||c.isRequestingTokens()&&(!d||e&&!k)?m(d,k,e,b):n(d,k)},u)},releaseRenewalLock:function(a,b,c){for(var d,g,k=0;k<this._renewingContexts.length;++k){var e=
this._renewingContexts[k];if(e.ctx===a){d=k;g=e.queue;break}}if(g!==b)throw new E("Attempt to release renewal lock that is not owned by this queue.");c?(c=c.messageHeader)?(g=c.keyResponseData)?b.add(g.masterToken):(a=a.isPeerToPeer()?c.peerMasterToken:c.masterToken)?b.add(a):b.add(U):b.add(U):b.add(U);this._renewingContexts.splice(d,1)}});qd=x.Class.create({init:function(){var a={_impl:{value:new R,writable:!1,enumerable:!1,configurable:!1},_shutdown:{value:!1,writable:!1,enumerable:!1,configurable:!1}};
Object.defineProperties(this,a)},setFilterFactory:function(a){this._impl.setFilterFactory(a)},shutdown:function(){this._shutdown=!0},receive:function(a,b,c,g,k,e){if(this._shutdown)throw new p("MslControl is shutdown.");var h=new B(this._impl,a,b,c,g,k);setTimeout(function(){h.call(e)},0);return d(h)},respond:function(a,b,c,g,k,e,h){if(this._shutdown)throw new p("MslControl is shutdown.");var f=new P(this._impl,a,b,c,g,k,e);setTimeout(function(){f.call(h)},0);return d(f)},error:function(a,b,c,g,k,
e,h){if(this._shutdown)throw new p("MslControl is shutdown.");var f=new M(this._impl,a,b,c,g,k,e);setTimeout(function(){f.call(h)},0);return d(f)},request:function(a,b){if(this._shutdown)throw new p("MslControl is shutdown.");var c,g,k,e,h;if(5==arguments.length){if(c=arguments[2],k=g=null,e=arguments[3],h=arguments[4],a.isPeerToPeer()){h.error(new E("This method cannot be used in peer-to-peer mode."));return}}else if(6==arguments.length&&(c=null,g=arguments[2],k=arguments[3],e=arguments[4],h=arguments[5],
!a.isPeerToPeer())){h.error(new E("This method cannot be used in trusted network mode."));return}var f=new r(this._impl,a,b,c,g,k,null,0,e);setTimeout(function(){f.call(h)},0);return d(f)}});B=x.Class.create({init:function(a,b,c,d,g,k){Object.defineProperties(this,{_ctrl:{value:a,writable:!1,enumerable:!1,configurable:!1},_ctx:{value:b,writable:!1,enumerable:!1,configurable:!1},_msgCtx:{value:c,writable:!1,enumerable:!1,configurable:!1},_input:{value:d,writable:!1,enumerable:!1,configurable:!1},_output:{value:g,
writable:!1,enumerable:!1,configurable:!1},_timeout:{value:k,writable:!1,enumerable:!1,configurable:!1},_aborted:{value:!1,writable:!0,enumerable:!1,configurable:!1},_abortFunc:{value:void 0,writable:!0,enumerable:!1,configurable:!1}})},isAborted:function(){return this._aborted},abort:function(){this._aborted=!0;this._abortFunc&&this._abortFunc.call(this)},setAbort:function(a){this._abortFunc=a},call:function(b){function c(g){e(b,function(){var c=g.messageHeader;if(!c)return g;this.setAbort(function(){g.abort()});
g.isHandshake(this._timeout,{result:function(a){e(b,function(){if(void 0===a)return null;if(!a)return g;d(g)},k)},timeout:b.timeout,error:function(d){e(b,function(){if(m(d))return null;var h=g.getIdentity(),f=c?c.messageId:null,l=a.INTERNAL_EXCEPTION,n=new E("Error peeking into the message payloads.");H(this,this._ctx,this._msgCtx.getDebugContext(),h,f,l,null,this._output,this._timeout,{result:function(a){b.error(n)},timeout:function(){b.timeout()},error:function(a){e(b,function(){if(m(a))return null;
throw new Aa("Error peeking into the message payloads.",a,d);},k)}})},k)}})},k)}function d(c){e(b,function(){c.close();this._ctrl.buildResponse(this,this._ctx,this._msgCtx,c.messageHeader,this._timeout,{result:function(a){e(b,function(){var d=a.builder,k=a.tokenTicket,h=c.messageHeader,f=new y(this._msgCtx);if(this._ctx.isPeerToPeer()){var m=new r(this._ctrl,this._ctx,f,null,this._input,this._output,a,1,this._timeout);this.setAbort(function(){m.abort()});m.call({result:function(a){e(b,function(){return a?
a.input:null})},timeout:b.timeout,error:b.error})}else g(h,d,f,k)},k)},timeout:b.timeout,error:function(d){e(b,function(){if(m(d))return null;var g=c.getIdentity(),h,f,l,n;d instanceof p?(h=d.messageId,f=d.error,l=c.messageHeader.messageCapabilities,l=this._ctrl.messageRegistry.getUserMessage(f,l?l.languages:null),n=d):(h=requestHeader?requestHeader.messageId:null,f=a.INTERNAL_EXCEPTION,l=null,n=new E("Error creating an automatic handshake response.",d));H(this,this._ctx,this._msgCtx.getDebugContext(),
g,h,f,l,this._output,this._timeout,{result:function(a){b.error(n)},timeout:function(){b.timeout()},error:function(a){e(b,function(){if(m(a))return null;throw new Aa("Error creating an automatic handshake response.",a,d);},k)}})},k)}})},k)}function g(c,d,h,f){e(b,function(){d.setRenewable(!1);this._ctrl.send(this._ctx,h,this._output,d,!1,this._timeout,{result:function(a){e(b,function(){this._ctx.isPeerToPeer()&&this._ctrl.releaseMasterToken(f);return null},k)},timeout:function(){e(b,function(){this._ctx.isPeerToPeer()&&
this._ctrl.releaseMasterToken(f);b.timeout()},k)},error:function(d){e(b,function(){this._ctx.isPeerToPeer()&&this._ctrl.releaseMasterToken(f);if(m(d))return null;var g=request.getIdentity(),h,l,n,u;d instanceof p?(h=d.messageId,l=d.error,n=c?c.messageCapabilities:null,n=this._ctrl.messageRegistry.getUserMessage(l,n?n.languages:null),u=d):d instanceof ha?(h=c?c.messageId:null,l=a.MSL_COMMS_FAILURE,n=null,u=d):(h=c?c.messageId:null,l=a.INTERNAL_EXCEPTION,n=null,u=new E("Error sending an automatic handshake response.",
d));H(this,this._ctx,this._msgCtx.getDebugContext(),g,h,l,n,this._output,this._timeout,{result:function(a){b.error(u)},timeout:function(){b.timeout()},error:function(a){e(b,function(){if(m(a))return null;throw new Aa("Error sending an automatic handshake response.",a,d);},k)}})},k)}})},k)}var k=this;e(b,function(){this._ctrl.receive(this,this._ctx,this._msgCtx,this._input,null,this._timeout,{result:function(a){c(a)},timeout:function(){b.timeout()},error:function(c){e(b,function(){if(m(c))return null;
var d,g,h,f,l;c instanceof p?(d=c.masterToken,g=c.entityAuthenticationData,d=d?d.identity:g?g.getIdentity():null,g=c.messageId,h=c.error,f=this._ctrl.messageRegistry.getUserMessage(h,null),l=c):(g=d=null,h=a.INTERNAL_EXCEPTION,f=null,l=new E("Error receiving the message header.",c));H(this,this._ctx,this._msgCtx.getDebugContext(),d,g,h,f,this._output,this._timeout,{result:function(a){b.error(l)},timeout:function(){b.timeout()},error:function(a){e(b,function(){if(m(a))return null;throw new Aa("Error receiving the message header.",
a,c);},k)}})},k)}})},k)}});P=x.Class.create({init:function(a,b,c,d,g,k,e){Object.defineProperties(this,{_ctrl:{value:a,writable:!1,enumerable:!1,configurable:!1},_ctx:{value:b,writable:!1,enumerable:!1,configurable:!1},_msgCtx:{value:c,writable:!1,enumerable:!1,configurable:!1},_input:{value:d,writable:!1,enumerable:!1,configurable:!1},_output:{value:g,writable:!1,enumerable:!1,configurable:!1},_request:{value:k,writable:!1,enumerable:!1,configurable:!1},_timeout:{value:e,writable:!1,enumerable:!1,
configurable:!1},_aborted:{value:!1,writable:!0,enumerable:!1,configurable:!1},_abortFunc:{value:void 0,writable:!0,enumerable:!1,configurable:!1}})},isAborted:function(){return this._aborted},abort:function(){this._aborted=!0;this._abortFunc&&this._abortFunc.call(this)},setAbort:function(a){this._abortFunc=a},trustedNetworkExecute:function(b,c,d){var g=this;e(d,function(){try{var k=b.builder,h=b.tokenTicket;if(12<c+1)return this._ctrl.releaseMasterToken(h),null;var f;if(f=this._msgCtx.isIntegrityProtected()&&
!k.willIntegrityProtectHeader()?a.RESPONSE_REQUIRES_INTEGRITY_PROTECTION:this._msgCtx.isEncrypted()&&!k.willEncryptPayloads()?a.RESPONSE_REQUIRES_ENCRYPTION:null){var l=v(this._request),u=Db(k.getMessageId());H(this,this._ctx,this._msgCtx.getDebugContext(),l,u,f,null,this._output,this._timeout,{result:function(a){d.result(null)},timeout:d.timeout,error:function(a){e(d,function(){if(m(a))return null;throw new Aa("Response requires encryption or integrity protection but cannot be protected: "+f,a,null);
},g)}});this._ctrl.releaseMasterToken(h)}else!this._msgCtx.getUser()||k.getMasterToken()||k.getKeyExchangeData()?(k.setRenewable(!1),this._ctrl.send(this._ctx,this._msgCtx,this._output,k,!1,this._timeout,{result:function(a){e(d,function(){this._ctrl.releaseMasterToken(h);return new n(this._request,a.request)},g)},timeout:function(){e(d,function(){this._ctrl.releaseMasterToken(h);d.timeout()},g)},error:function(a){e(d,function(){this._ctrl.releaseMasterToken(h);d.error(a)},g)}})):(l=v(this._request),
u=Db(k.getMessageId()),H(this,this._ctx,this._msgCtx.getDebugContext(),l,u,a.RESPONSE_REQUIRES_MASTERTOKEN,null,this._output,this._timeout,{result:function(a){d.result(null)},timeout:d.timeout,error:function(a){e(d,function(){if(m(a))return null;throw new Aa("Response wishes to attach a user ID token but there is no master token.",a,null);},g)}}),this._ctrl.releaseMasterToken(h))}catch(r){throw this._ctrl.releaseMasterToken(h),r;}},g)},peerToPeerExecute:function(b,c,d,g){function k(a){e(g,function(){a.response.close(this._timeout,
{result:function(b){e(g,function(){if(!b)return null;h(a)},f)},timeout:function(){h(a)},error:function(b){e(g,function(){if(m(b))return null;h(a)},f)}})},f)}function h(a){e(g,function(){var c=response.getErrorHeader();this._ctrl.cleanupContext(this._ctx,a.request.getMessageHeader(),c);this._ctrl.buildErrorResponse(this,this._ctx,b,a,c,{result:function(a){e(g,function(){if(!a)return null;var b=a.errorResult;this.peerToPeerExecute(b.msgCtx,{builder:b.builder,tokenTicket:a.tokenTicket},d,g)},f)}})},
f)}var f=this;e(g,function(){var h=c.builder,l=c.tokenTicket;if(12<d+2)return this._ctrl.releaseMasterToken(l),null;null!=b.getUser()&&null==h.getPeerMasterToken()&&null==h.getKeyExchangeData()?(this._ctrl.releaseMasterToken(l),l=v(this._request),h=Db(h.getMessageId()),H(this,this._ctx,b.getDebugContext(),l,h,a.RESPONSE_REQUIRES_MASTERTOKEN,null,this._output,this._timeout,{result:function(a){g.result(null)},timeout:g.timeout,error:function(a){e(g,function(){if(m(a))return null;throw new Aa("Response wishes to attach a user ID token but there is no master token.",
re,null);},f)}})):this._ctrl.sendReceive(this._ctx,b,this._input,this._output,c,!1,!1,this._timeout,{result:function(a){e(g,function(){function c(){l.close(f._timeout,{result:function(a){e(g,function(){if(!a)return null;h()},f)},timeout:function(){h()},error:function(a){e(g,function(){if(m(a))return null;h()},f)}})}function h(){e(g,function(){var a=new Y(null,b);this._ctrl.buildResponse(this,this._ctx,a,u,this._timeout,{result:function(b){e(g,function(){this.peerToPeerExecute(a,b,d,g)},f)},timeout:g.timeout,
error:g.error})},f)}var l=a.response;d+=2;if(!l)return new n(this._request,a.request);var u=l.getMessageHeader();if(u)if(a.handshake)c();else return new n(a.response,a.request);else k(a)},f)},timeout:g.timeout,error:g.error})},f)},call:function(b){var c=this;e(b,function(){var d=this._request.getMessageHeader();this._ctrl.buildResponse(this,this._ctx,this._msgCtx,d,this._timeout,{result:function(d){e(b,function(){var g=d.builder;this._ctx.isPeerToPeer()?this.peerToPeerExecute(this._msgCtx,d,3,{result:function(a){e(b,
function(){a&&a.output.stopCaching();return a},c)},timeout:b.timeout,error:function(d){e(b,function(){if(m(d))return null;var k=v(this._request),h=Db(g.getMessageId()),f,l,n;d instanceof p?(f=d.error,l=this._request.messageCapabilities,l=this._ctrl.messageRegistry.getUserMessage(f,l?l.languages:null),n=d):d instanceof ha?(f=a.MSL_COMMS_FAILURE,l=null,n=d):(f=a.INTERNAL_EXCEPTION,l=null,n=new E("Error sending the response.",d));H(this,this._ctx,this._msgCtx.getDebugContext(),k,h,f,l,this._output,this._timeout,
{result:function(a){b.error(n)},timeout:function(){b.timeout()},error:function(a){e(b,function(){if(m(a))return!1;throw new Aa("Error sending the response.",a,null);},c)}})},c)}}):this.trustedNetworkExecute(d,3,{result:function(a){e(b,function(){a&&a.output.stopCaching();return a},c)},timeout:b.timeout,error:function(d){e(b,function(){if(m(d))return null;var k=v(this._request),h=Db(g.getMessageId()),f,l,n;d instanceof p?(f=d.error,l=messageHeader.messageCapabilities,l=this._ctrl.messageRegistry.getUserMessage(f,
l?l.languages:null),n=d):d instanceof ha?(f=a.MSL_COMMS_FAILURE,l=null,n=d):(f=a.INTERNAL_EXCEPTION,l=null,n=new E("Error sending the response.",d));H(this,this._ctx,this._msgCtx.getDebugContext(),k,h,f,l,this._output,this._timeout,{result:function(a){b.error(n)},timeout:function(){b.timeout()},error:function(a){e(b,function(){if(m(a))return null;throw new Aa("Error sending the response.",a,null);},c)}})},c)}})},c)},timeout:b.timeout,error:function(g){e(b,function(){if(m(g))return null;var k=v(this._request),
h,f,l,n;g instanceof p?(h=g.messageId,f=g.error,l=d.messageCapabilities,l=this._ctrl.messageRegistry.getUserMessage(f,l?l.languages:null),n=g):(h=null,f=a.INTERNAL_EXCEPTION,l=null,n=new E("Error building the response.",g));H(this,this._ctx,this._msgCtx.getDebugContext(),k,h,f,l,this._output,this._timeout,{result:function(a){b.error(n)},timeout:b.timeout,error:function(a){e(b,function(){if(m(a))return null;throw new Aa("Error building the response.",a,g);},c)}})},c)}})},c)}});M=x.Class.create({init:function(a,
b,c,d,g,k,e){Object.defineProperties(this,{_ctrl:{value:a,writable:!1,enumerable:!1,configurable:!1},_ctx:{value:b,writable:!1,enumerable:!1,configurable:!1},_msgCtx:{value:c,writable:!1,enumerable:!1,configurable:!1},_appError:{value:d,writable:!1,enumerable:!1,configurable:!1},_output:{value:output,writable:!1,enumerable:!1,configurable:!1},_request:{value:k,writable:!1,enumerable:!1,configurable:!1},_timeout:{value:e,writable:!1,enumerable:!1,configurable:!1},_aborted:{value:!1,writable:!0,enumerable:!1,
configurable:!1},_abortFunc:{value:void 0,writable:!0,enumerable:!1,configurable:!1}})},isAborted:function(){return this._aborted},abort:function(){this._aborted=!0;this._abortFunc&&this._abortFunc.call(this)},setAbort:function(a){this._abortFunc=a},call:function(b){var c=this;e(b,function(){var d;if(this._appError==ENTITY_REJECTED)d=this._request.masterToken?a.MASTERTOKEN_REJECTED_BY_APP:a.ENTITY_REJECTED_BY_APP;else if(this._appError==USER_REJECTED)d=this._request.userIdToken?a.USERIDTOKEN_REJECTED_BY_APP:
a.USER_REJECTED_BY_APP;else throw new E("Unhandled application error "+this._appError+".");var g=this._request.messageCapabilities,g=this._ctrl.messageRegistry.getUserMessage(d,g?g.languages:null);H(this,this._ctx,this._msgCtx.getDebugContext(),this._request.messageId,d,g,this._output,this._timeout,{result:function(a){b.result(a)},timeout:b.timeout,error:function(a){e(b,function(){if(m(a))return!1;a instanceof p&&b.error(a);throw new E("Error building the error response.",a);},c)}})},c)}});var q=
{result:function(){},timeout:function(){},error:function(){}};r=x.Class.create({init:function(a,b,c,d,g,k,e,h,f){var l;e?(l=e.builder,e=e.tokenTicket):e=l=null;Object.defineProperties(this,{_ctrl:{value:a,writable:!1,enumerable:!1,configurable:!1},_ctx:{value:b,writable:!1,enumerable:!1,configurable:!1},_msgCtx:{value:c,writable:!1,enumerable:!1,configurable:!1},_remoteEntity:{value:d,writable:!1,enumerable:!1,configurable:!1},_input:{value:g,writable:!0,enumerable:!1,configurable:!1},_output:{value:k,
writable:!0,enumerable:!1,configurable:!1},_openedStreams:{value:!1,writable:!0,enumerable:!1,configurable:!1},_builder:{value:l,writable:!0,enumerable:!1,configurable:!1},_tokenTicket:{value:e,writable:!0,enumerable:!1,configurable:!1},_timeout:{value:f,writable:!1,enumerable:!1,configurable:!1},_msgCount:{value:h,writable:!1,enumerable:!1,configurable:!1},_maxMessagesHit:{value:!1,writable:!0,enumerable:!1,configurable:!1},_aborted:{value:!1,writable:!0,enumerable:!1,configurable:!1},_abortFunc:{value:void 0,
writable:!0,enumerable:!1,configurable:!1}})},isAborted:function(){return this._aborted},abort:function(){this._aborted=!0;this._abortFunc&&this._abortFunc.call(this)},setAbort:function(a){this._abortFunc=a},execute:function(a,b,c,d,g){function k(a,b){a.request.close(q._timeout,{result:function(a){b.call(q,a)},timeout:function(){b.call(q,!0)},error:function(a){m(a)&&b.call(q,!1);b.call(q,!0)}})}function h(a,b){k(a,function(c){c?a.response.close(q._timeout,{result:function(a){b.call(q,a)},timeout:function(){b.call(q,
!0)},error:function(a){m(a)&&b.call(q,!1);b.call(q,!0)}}):b.call(q,!1)})}function f(a){e(g,function(){h(a,function(b){b?l(a):g.result(null)})},q)}function l(b){function k(a,b){e(g,function(){return this._maxMessagesHit||b&&!b.input?new n(a.response,null):b},q)}e(g,function(){var h=b.request,f=b.response,l=f.getErrorHeader();this._ctrl.cleanupContext(this._ctx,h.getMessageHeader(),l);this._ctrl.buildErrorResponse(this,this._ctx,a,b,l,c,{result:function(a){e(g,function(){if(!a)return new n(f,null);
var c=a.errorResult,h=a.tokenTicket,l={builder:c.builder,tokenTicket:h},c=c.msgCtx;if(this._ctx.isPeerToPeer())this.execute(c,l,this._timeout,d,{result:function(a){e(g,function(){this._ctrl.releaseMasterToken(h);k(b,a)},q)},timeout:function(){e(g,function(){this._ctrl.releaseMasterToken(h);g.timeout()},q)},error:function(a){e(g,function(){this._ctrl.releaseMasterToken(h);g.error(a)},q)}});else{var m=new r(this._ctrl,this._ctx,c,this._remoteEntity,null,null,l,d,this._timeout);this.setAbort(function(){m.abort()});
m.call({result:function(a){e(g,function(){this._maxMessagesHit=m._maxMessagesHit;k(b,a)},q)},timeout:g.timeout,error:g.error})}},q)},timeout:function(){g.timeout()},error:function(a){g.error(a)}})},q)}function u(b){e(g,function(){var f=b.request,l=b.response,m=l.getMessageHeader();if(this._ctx.isPeerToPeer())if(b.handshake)h(b,function(b){e(g,function(){if(!b)return null;var k=new Y(null,a);this._ctrl.buildResponse(this,this._ctx,a,m,c,{result:function(a){this.execute(k,a,this._timeout,d,g)},timeout:g.timeout,
error:g.error})},q)});else if(0<m.keyRequestData.length||m.isRenewable()&&m.masterToken&&m.userAuthenticationData){var u=new y(a);this._ctrl.buildResponse(this,this._ctx,u,m,c,{result:function(a){e(g,function(){var c=a.builder,f=a.tokenTicket;l.isHandshake(this._timeout,{result:function(a){e(g,function(){a?h(b,function(){e(g,function(){if(!success)return this._ctrl.releaseMasterToken(f),null;q.execute(u,c,this._timeout,d,{result:function(a){e(g,function(){this._ctrl.releaseMasterToken(f);return a},
q)},timeout:function(){e(g,function(){this._ctrl.releaseMasterToken(f);g.timeout()},q)},error:function(a){e(g,function(){this._ctrl.releaseMasterToken(f);g.error(a)},q)}})},q)}):k(b,function(a){e(g,function(){if(!a)return this._ctrl.releaseMasterToken(f),null;c.setRenewable(!1);this._ctrl.send(this,this._ctx,u,this._output,c,this._timeout,{result:function(a){e(g,function(){this._ctrl.releaseMasterToken(f);return new n(l,a.request)},q)},timeout:g.timeout,error:g.error})},q)})},q)},timeout:function(){e(g,
function(){this._ctrl.releaseMasterToken(f);g.timeout()},q)},error:function(a){e(g,function(){this._ctrl.releaseMasterToken(f);g.error(a)},q)}})},q)},timeout:g.timeout,error:g.error})}else return new n(l,f);else{if(!b.handshake)return new n(l,f);h(b,function(b){e(g,function(){if(!b)return null;var k=new Y(null,a);this._ctrl.buildResponse(this,this._ctx,a,m,c,{result:function(a){e(g,function(){var b=new r(this._ctrl,this._ctx,k,this._remoteEntity,null,null,a,d,this._timeout);this.setAbort(function(){b.abort()});
b.call(g)},q)},timeout:g.timeout,error:g.error})},q)})}},q)}var q=this;e(g,function(){if(12<d+2)return this._ctrl.releaseMasterToken(b.tokenTicket),this._maxMessagesHit=!0,null;this._ctrl.sendReceive(this,this._ctx,a,this._input,this._output,b,!0,this._openedStreams,c,{result:function(a){e(g,function(){if(!a)return null;var b=a.response;d+=2;b.getMessageHeader()?u(a):f(a)},q)},timeout:function(){g.timeout()},error:function(a){g.error(a)}})},q)},call:function(a){function b(d,g,k){e(a,function(){this.execute(this._msgCtx,
{builder:d,tokenTicket:g},k,this._msgCount,{result:function(b){e(a,function(){b&&b.output&&b.output.stopCaching();return b},c)},timeout:function(){e(a,function(){this._openedStreams&&(this._output.close(k,q),this._input.close(k,q));a.timeout()},c)},error:function(b){e(a,function(){this._openedStreams&&(this._output.close(k,q),this._input.close(k,q));if(m(b))return null;a.error(b)},c)}})},c)}var c=this;e(a,function(){var d=this._timeout;if(!this._input||!this._output)try{this._remoteEntity.setTimeout(this._timeout);
var g=Date.now(),k=this._remoteEntity.openConnection();this._output=k.output;this._input=k.input;-1!=d&&(d=this._timeout-(Date.now()-g));this._openedStreams=!0}catch(h){this._builder&&this._ctrl.releaseMasterToken(this._tokenTicket);this._output&&this._output.close(this._timeout,q);this._input&&this._input.close(this._timeout,q);if(m(h))return null;throw h;}this._builder?b(this._builder,this._tokenTicket,d):this._ctrl.buildRequest(this,this._ctx,this._msgCtx,this._timeout,{result:function(g){e(a,
function(){b(g.builder,g.tokenTicket,d)},c)},timeout:function(){e(a,function(){this._openedStreams&&(this._output.close(this._timeout,q),this._input.close(this._timeout,q));a.timeout()},c)},error:function(b){e(a,function(){this._openedStreams&&(this._output.close(this._timeout,q),this._input.close(this._timeout,q));if(m(b))return null;a.error(b)},c)}})},c)}})})();Ib.extend({isEncrypted:function(){return!0},isIntegrityProtected:function(){return!0},isNonReplayable:function(){return!0}});Ib.extend({isEncrypted:function(){return!1},
isIntegrityProtected:function(){return!0},isNonReplayable:function(){return!1}});Ib.extend({isEncrypted:function(){return!0},isIntegrityProtected:function(){return!0},isNonReplayable:function(){return!1}});x.Class.create({isNewestMasterToken:function(a,b,c){},isMasterTokenRevoked:function(a,b){},acceptNonReplayableId:function(a,b,c,d){},createMasterToken:function(a,b,c,d,e){},isMasterTokenRenewable:function(a,b,c){},renewMasterToken:function(a,b,c,d,e){},isUserIdTokenRevoked:function(a,b,c,d){},createUserIdToken:function(a,
b,c,d){},renewUserIdToken:function(a,b,c,d){},createUser:function(a,b,c){}});var ya,pb;(function(){function c(a,b,d,e){this.sessiondata=a;this.tokendata=b;this.signature=d;this.verified=e}ya=x.Class.create({init:function(a,c,d,e,h,f,H,n,I,p,y){var x=this;b(y,function(){if(d.getTime()<c.getTime())throw new E("Cannot construct a master token that expires before its renewal window opens.");if(0>e||e>T)throw new E("Sequence number "+e+" is outside the valid range.");if(0>h||h>T)throw new E("Serial number "+
h+" is outside the valid range.");var U=Math.floor(c.getTime()/1E3),B=Math.floor(d.getTime()/1E3),P;if(p)P=p.sessiondata;else{var M={};f&&(M.issuerdata=f);M.identity=H;M.encryptionkey=w(n.toByteArray());M.hmackey=w(I.toByteArray());P=Z(JSON.stringify(M),W)}if(p)return Object.defineProperties(this,{ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},renewalWindowSeconds:{value:U,writable:!1,enumerable:!1,configurable:!1},expirationSeconds:{value:B,writable:!1,enumerable:!1,configurable:!1},sequenceNumber:{value:e,
writable:!1,configurable:!1},serialNumber:{value:h,writable:!1,configurable:!1},issuerData:{value:f,writable:!1,configurable:!1},identity:{value:H,writable:!1,configurable:!1},encryptionKey:{value:n,writable:!1,configurable:!1},hmacKey:{value:I,writable:!1,configurable:!1},sessiondata:{value:P,writable:!1,enumerable:!1,configurable:!1},verified:{value:p.verified,writable:!1,enumerable:!1,configurable:!1},tokendata:{value:p.tokendata,writable:!1,enumerable:!1,configurable:!1},signature:{value:p.signature,
writable:!1,enumerable:!1,configurable:!1}}),this;var r=a.getMslCryptoContext();r.encrypt(P,{result:function(c){b(y,function(){var d={};d.renewalwindow=U;d.expiration=B;d.sequencenumber=e;d.serialnumber=h;d.sessiondata=w(c);var g=Z(JSON.stringify(d),W);r.sign(g,{result:function(c){b(y,function(){Object.defineProperties(this,{ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},renewalWindowSeconds:{value:U,writable:!1,enumerable:!1,configurable:!1},expirationSeconds:{value:B,writable:!1,enumerable:!1,
configurable:!1},sequenceNumber:{value:e,writable:!1,enumerable:!1,configurable:!1},serialNumber:{value:h,writable:!1,enumerable:!1,configurable:!1},issuerData:{value:f,writable:!1,configurable:!1},identity:{value:H,writable:!1,configurable:!1},encryptionKey:{value:n,writable:!1,configurable:!1},hmacKey:{value:I,writable:!1,configurable:!1},sessiondata:{value:P,writable:!1,enumerable:!1,configurable:!1},verified:{value:!0,writable:!1,enumerable:!1,configurable:!1},tokendata:{value:g,writable:!1,enumerable:!1,
configurable:!1},signature:{value:c,writable:!1,enumerable:!1,configurable:!1}});return this},x)},error:function(a){y.error(a)}})},x)},error:function(a){y.error(a)}})},this)},get renewalWindow(){return new Date(1E3*this.renewalWindowSeconds)},get expiration(){return new Date(1E3*this.expirationSeconds)},isDecrypted:function(){return this.sessiondata?!0:!1},isVerified:function(){return this.verified},isRenewable:function(a){return this.isVerified()?this.renewalWindow.getTime()<=this.ctx.getTime():
!0},isExpired:function(a){return this.isVerified()?this.expiration.getTime()<=this.ctx.getTime():!1},isNewerThan:function(a){if(this.sequenceNumber==a.sequenceNumber)return this.expiration>a.expiration;if(this.sequenceNumber>a.sequenceNumber){var b=this.sequenceNumber-T+127;return a.sequenceNumber>=b}b=a.sequenceNumber-T+127;return this.sequenceNumber<b},toJSON:function(){var a={};a.tokendata=w(this.tokendata);a.signature=w(this.signature);return a},equals:function(a){return this===a?!0:a instanceof
ya?this.serialNumber==a.serialNumber&&this.sequenceNumber==a.sequenceNumber&&this.expiration.getTime()==a.expiration.getTime():!1},uniqueKey:function(){return this.serialNumber+":"+this.sequenceNumber+this.expiration.getTime()}});pb=function(d,k,g){b(g,function(){var e=d.getMslCryptoContext(),h=k.tokendata,f=k.signature;if("string"!==typeof h||"string"!==typeof f)throw new G(a.JSON_PARSE_ERROR,"mastertoken "+JSON.stringify(k));var H,n;try{H=K(h)}catch(I){throw new p(a.MASTERTOKEN_TOKENDATA_INVALID,
"mastertoken "+JSON.stringify(k),I);}if(!H||0==H.length)throw new G(a.MASTERTOKEN_TOKENDATA_MISSING,"mastertoken "+JSON.stringify(k));try{n=K(f)}catch(N){throw new p(a.MASTERTOKEN_SIGNATURE_INVALID,"mastertoken "+JSON.stringify(k),N);}e.verify(H,n,{result:function(k){b(g,function(){var h,f,m,v,M,r=ca(H,W);try{var R=JSON.parse(r);h=parseInt(R.renewalwindow);f=parseInt(R.expiration);m=parseInt(R.sequencenumber);v=parseInt(R.serialnumber);M=R.sessiondata}catch(q){if(q instanceof SyntaxError)throw new G(a.MASTERTOKEN_TOKENDATA_PARSE_ERROR,
"mastertokendata "+r,q);throw q;}if(!h||h!=h||!f||f!=f||"number"!==typeof m||m!=m||"number"!==typeof v||v!=v||"string"!==typeof M)throw new G(a.MASTERTOKEN_TOKENDATA_PARSE_ERROR,"mastertokendata "+r);if(f<h)throw new p(a.MASTERTOKEN_EXPIRES_BEFORE_RENEWAL,"mastertokendata "+r);if(0>m||m>T)throw new p(a.MASTERTOKEN_SEQUENCE_NUMBER_OUT_OF_RANGE,"mastertokendata "+r);if(0>v||v>T)throw new p(a.MASTERTOKEN_SERIAL_NUMBER_OUT_OF_RANGE,"mastertokendata "+r);var I=new Date(1E3*h),N=new Date(1E3*f),y;try{y=
K(M)}catch(C){throw new p(a.MASTERTOKEN_SESSIONDATA_INVALID,M,C);}if(!y||0==y.length)throw new p(a.MASTERTOKEN_SESSIONDATA_MISSING,M);k?e.decrypt(y,{result:function(e){b(g,function(){var h,f,u,r,q=ca(e,W);try{var C=JSON.parse(q);h=C.issuerdata;f=C.identity;u=C.encryptionkey;r=C.hmackey}catch(M){if(M instanceof SyntaxError)throw new G(a.MASTERTOKEN_SESSIONDATA_PARSE_ERROR,"sessiondata "+q,M);throw M;}if(h&&"object"!==typeof h||!f||"string"!==typeof u||"string"!==typeof r)throw new G(a.MASTERTOKEN_SESSIONDATA_PARSE_ERROR,
"sessiondata "+q);bb(u,$a,Xa,{result:function(u){bb(r,ab,Ya,{result:function(a){b(g,function(){var b=new c(e,H,n,k);new ya(d,I,N,m,v,h,f,u,a,b,g)})},error:function(b){g.error(new F(a.MASTERTOKEN_KEY_CREATION_ERROR,b))}})},error:function(b){g.error(new F(a.MASTERTOKEN_KEY_CREATION_ERROR,b))}})})},error:function(a){g.error(a)}}):(h=new c(null,H,n,k),new ya(d,I,N,m,v,null,null,null,null,h,g))})},error:function(a){g.error(a)}})})}})();var yb,sb;(function(){function c(a,b,d){this.tokendata=a;this.signature=
b;this.verified=d}yb=x.Class.create({init:function(a,c,d,e,h,f,H,n,I){var N=this;b(I,function(){if(d.getTime()<c.getTime())throw new E("Cannot construct a user ID token that expires before its renewal window opens.");if(!e)throw new E("Cannot construct a user ID token without a master token.");if(0>h||h>T)throw new E("Serial number "+h+" is outside the valid range.");var y=Math.floor(c.getTime()/1E3),x=Math.floor(d.getTime()/1E3),U=e.serialNumber;if(n){var B=n.tokendata,P=n.signature,M=n.verified,
U=e.serialNumber;Object.defineProperties(this,{ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},renewalWindowSeconds:{value:y,writable:!1,enumerable:!1,configurable:!1},expirationSeconds:{value:x,writable:!1,enumerable:!1,configurable:!1},mtSerialNumber:{value:U,writable:!1,configurable:!1},serialNumber:{value:h,writable:!1,configurable:!1},issuerData:{value:f,writable:!1,configurable:!1},user:{value:H,writable:!1,configurable:!1},verified:{value:M,writable:!1,enumerable:!1,configurable:!1},
tokendata:{value:B,writable:!1,enumerable:!1,configurable:!1},signature:{value:P,writable:!1,enumerable:!1,configurable:!1}});return this}B={};f&&(B.issuerdata=f);B.identity=H.getEncoded();var B=Z(JSON.stringify(B),W),r=a.getMslCryptoContext();r.encrypt(B,{result:function(c){b(I,function(){var d={};d.renewalwindow=y;d.expiration=x;d.mtserialnumber=U;d.serialnumber=h;d.userdata=w(c);var g=Z(JSON.stringify(d),W);r.sign(g,{result:function(c){b(I,function(){Object.defineProperties(this,{ctx:{value:a,
writable:!1,enumerable:!1,configurable:!1},renewalWindowSeconds:{value:y,writable:!1,enumerable:!1,configurable:!1},expirationSeconds:{value:x,writable:!1,enumerable:!1,configurable:!1},mtSerialNumber:{value:e.serialNumber,writable:!1,configurable:!1},serialNumber:{value:h,writable:!1,configurable:!1},issuerData:{value:f,writable:!1,configurable:!1},user:{value:H,writable:!1,configurable:!1},verified:{value:!0,writable:!1,enumerable:!1,configurable:!1},tokendata:{value:g,writable:!1,enumerable:!1,
configurable:!1},signature:{value:c,writable:!1,enumerable:!1,configurable:!1}});return this},N)},error:function(a){b(I,function(){a instanceof p&&a.setEntity(e);throw a;},N)}})},N)},error:function(a){b(I,function(){a instanceof p&&a.setEntity(e);throw a;},N)}})},this)},get renewalWindow(){return new Date(1E3*this.renewalWindowSeconds)},get expiration(){return new Date(1E3*this.expirationSeconds)},isVerified:function(){return this.verified},isDecrypted:function(){return this.user?!0:!1},isRenewable:function(){return this.renewalWindow.getTime()<=
this.ctx.getTime()},isExpired:function(){return this.expiration.getTime()<=this.ctx.getTime()},isBoundTo:function(a){return a&&a.serialNumber==this.mtSerialNumber},toJSON:function(){var a={};a.tokendata=w(this.tokendata);a.signature=w(this.signature);return a},equals:function(a){return this===a?!0:a instanceof yb?this.serialNumber==a.serialNumber&&this.mtSerialNumber==a.mtSerialNumber:!1},uniqueKey:function(){return this.serialNumber+":"+this.mtSerialNumber}});sb=function(d,k,g,e){b(e,function(){var h=
d.getMslCryptoContext(),f=k.tokendata,H=k.signature;if("string"!==typeof f||"string"!==typeof H)throw(new G(a.JSON_PARSE_ERROR,"useridtoken "+JSON.stringify(k))).setEntity(g);var n,I;try{n=K(f)}catch(N){throw(new p(a.USERIDTOKEN_TOKENDATA_INVALID,"useridtoken "+JSON.stringify(k),N)).setEntity(g);}if(!n||0==n.length)throw(new G(a.USERIDTOKEN_TOKENDATA_MISSING,"useridtoken "+JSON.stringify(k))).setEntity(g);try{I=K(H)}catch(y){throw(new p(a.USERIDTOKEN_TOKENDATA_INVALID,"useridtoken "+JSON.stringify(k),
y)).setEntity(g);}h.verify(n,I,{result:function(k){b(e,function(){var f,B,v,M,r,H=ca(n,W);try{var q=JSON.parse(H);f=parseInt(q.renewalwindow);B=parseInt(q.expiration);v=parseInt(q.mtserialnumber);M=parseInt(q.serialnumber);r=q.userdata}catch(N){if(N instanceof SyntaxError)throw(new G(a.USERIDTOKEN_TOKENDATA_PARSE_ERROR,"usertokendata "+H,N)).setEntity(g);throw N;}if(!f||f!=f||!B||B!=B||"number"!==typeof v||v!=v||"number"!==typeof M||M!=M||"string"!==typeof r)throw(new G(a.USERIDTOKEN_TOKENDATA_PARSE_ERROR,
"usertokendata "+H)).setEntity(g);if(B<f)throw(new p(a.USERIDTOKEN_EXPIRES_BEFORE_RENEWAL,"mastertokendata "+H)).setEntity(g);if(0>v||v>T)throw(new p(a.USERIDTOKEN_MASTERTOKEN_SERIAL_NUMBER_OUT_OF_RANGE,"usertokendata "+H)).setEntity(g);if(0>M||M>T)throw(new p(a.USERIDTOKEN_SERIAL_NUMBER_OUT_OF_RANGE,"usertokendata "+H)).setEntity(g);var y=new Date(1E3*f),w=new Date(1E3*B);if(!g||v!=g.serialNumber)throw(new p(a.USERIDTOKEN_MASTERTOKEN_MISMATCH,"uit mtserialnumber "+v+"; mt "+JSON.stringify(g))).setEntity(g);
var C;try{C=K(r)}catch(Pa){throw(new p(a.USERIDTOKEN_USERDATA_INVALID,r,Pa)).setEntity(g);}if(!C||0==C.length)throw(new p(a.USERIDTOKEN_USERDATA_MISSING,r)).setEntity(g);k?h.decrypt(C,{result:function(h){b(e,function(){var f,m,r=ca(h,W);try{var q=JSON.parse(r);f=q.issuerdata;m=q.identity}catch(v){if(v instanceof SyntaxError)throw(new G(a.USERIDTOKEN_USERDATA_PARSE_ERROR,"userdata "+r)).setEntity(g);throw v;}if(f&&"object"!==typeof f||"string"!==typeof m)throw(new G(a.USERIDTOKEN_USERDATA_PARSE_ERROR,
"userdata "+r)).setEntity(g);if(!m||0==m.length)throw(new p(a.USERIDTOKEN_IDENTITY_INVALID,"userdata "+r)).setEntity(g);d.getTokenFactory().createUser(d,m,{result:function(a){b(e,function(){if(!a)throw new E("TokenFactory.createUser() returned null in violation of the interface contract.");var b=new c(n,I,k);new yb(d,y,w,g,M,f,a,b,e)})},error:function(a){b(e,function(){a instanceof p&&a.setEntity(g);throw a;})}})})},error:function(a){b(e,function(){a instanceof p&&a.setEntity(g);throw a;})}}):(f=
new c(n,I,k),new yb(d,y,w,g,M,null,null,f,e))})},error:function(a){b(e,function(){a instanceof p&&a.setEntity(g);throw a;})}})})}})();var vb,hb,Xb;(function(){function c(b,d){var e=b.tokendata;if("string"!==typeof e)throw new G(a.JSON_PARSE_ERROR,"servicetoken "+JSON.stringify(b));var h;try{h=K(e)}catch(f){throw new p(a.SERVICETOKEN_TOKENDATA_INVALID,"servicetoken "+JSON.stringify(b),f);}if(!h||0==h.length)throw new G(a.SERVICETOKEN_TOKENDATA_MISSING,"servicetoken "+JSON.stringify(b));var l;try{l=
JSON.parse(ca(h,W)).name}catch(n){if(n instanceof SyntaxError)throw new G(a.JSON_PARSE_ERROR,"servicetoken "+JSON.stringify(b),n);throw n;}if(!l)throw new G(a.JSON_PARSE_ERROR,"servicetoken "+JSON.stringify(b));return d[l]?d[l]:d[""]}function d(a,b,c){this.tokendata=a;this.signature=b;this.verified=c}vb=x.Class.create({init:function(a,c,d,e,h,f,l,I,N,y){var x=this;b(y,function(){if(e&&h&&!h.isBoundTo(e))throw new E("Cannot construct a service token bound to a master token and user ID token where the user ID token is not bound to the same master token.");
var U=e?e.serialNumber:-1,B=h?h.serialNumber:-1;if(N)return r=N.tokendata,Object.defineProperties(this,{ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},name:{value:c,writable:!1,configurable:!1},mtSerialNumber:{value:U,writable:!1,configurable:!1},uitSerialNumber:{value:B,writable:!1,configurable:!1},data:{value:d,writable:!1,configurable:!1},encrypted:{value:f,writable:!1,enumerable:!1,configurable:!1},compressionAlgo:{value:l,writable:!1,configurable:!1},verified:{value:N.verified,writable:!1,
enumerable:!1,configurable:!1},tokendata:{value:r,writable:!1,enumerable:!1,configurable:!1},signature:{value:N.signature,writable:!1,enumerable:!1,configurable:!1}}),this;var P;l?(P=vc(l,d),P.length<d.length||(l=null,P=d)):(l=null,P=d);var M={};M.name=c;-1!=U&&(M.mtserialnumber=U);-1!=B&&(M.uitserialnumber=B);M.encrypted=f;l&&(M.compressionalgo=l);if(f&&0<P.length)I.encrypt(P,{result:function(r){b(y,function(){M.servicedata=w(r);var q=Z(JSON.stringify(M),W);I.sign(q,{result:function(e){b(y,function(){Object.defineProperties(this,
{ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},name:{value:c,writable:!1,configurable:!1},mtSerialNumber:{value:U,writable:!1,configurable:!1},uitSerialNumber:{value:B,writable:!1,configurable:!1},data:{value:d,writable:!1,configurable:!1},encrypted:{value:f,writable:!1,enumerable:!1,configurable:!1},compressionAlgo:{value:l,writable:!1,configurable:!1},verified:{value:!0,writable:!1,enumerable:!1,configurable:!1},tokendata:{value:q,writable:!1,enumerable:!1,configurable:!1},signature:{value:e,
writable:!1,enumerable:!1,configurable:!1}});return this},x)},error:function(a){b(y,function(){a instanceof p&&(a.setEntity(e),a.setUser(h));throw a;})}})},x)},error:function(a){b(y,function(){a instanceof p&&(a.setEntity(e),a.setUser(h));throw a;})}});else{M.servicedata=w(P);var r=Z(JSON.stringify(M),W);I.sign(r,{result:function(e){b(y,function(){Object.defineProperties(this,{ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},name:{value:c,writable:!1,configurable:!1},mtSerialNumber:{value:U,
writable:!1,configurable:!1},uitSerialNumber:{value:B,writable:!1,configurable:!1},data:{value:d,writable:!1,configurable:!1},encrypted:{value:f,writable:!1,enumerable:!1,configurable:!1},compressionAlgo:{value:l,writable:!1,configurable:!1},verified:{value:!0,writable:!1,enumerable:!1,configurable:!1},tokendata:{value:r,writable:!1,enumerable:!1,configurable:!1},signature:{value:e,writable:!1,enumerable:!1,configurable:!1}});return this},x)},error:function(a){b(y,function(){a instanceof p&&(a.setEntity(e),
a.setUser(h));throw a;})}})}},this)},isEncrypted:function(){return this.encrypted},isVerified:function(){return this.verified},isDecrypted:function(){return this.data?!0:!1},isDeleted:function(){return this.data&&0==this.data.length},isMasterTokenBound:function(){return-1!=this.mtSerialNumber},isBoundTo:function(a){return a?a instanceof ya?a.serialNumber==this.mtSerialNumber:a instanceof yb?a.serialNumber==this.uitSerialNumber:!1:!1},isUserIdTokenBound:function(){return-1!=this.uitSerialNumber},isUnbound:function(){return-1==
this.mtSerialNumber&&-1==this.uitSerialNumber},toJSON:function(){var a={};a.tokendata=w(this.tokendata);a.signature=w(this.signature);return a},equals:function(a){return this===a?!0:a instanceof vb?this.name==a.name&&this.mtSerialNumber==a.mtSerialNumber&&this.uitSerialNumber==a.uitSerialNumber:!1},uniqueKey:function(){return this.name+":"+this.mtSerialNumber+":"+this.uitSerialNumber}});hb=function(a,b,c,d,e,h,f,l,p){new vb(a,b,c,d,e,h,f,l,null,p)};Xb=function(e,g,h,f,v,H){b(H,function(){!v||v instanceof
lb||(v=c(g,v));var n=g.tokendata,I=g.signature;if("string"!==typeof n||"string"!==typeof I)throw(new G(a.JSON_PARSE_ERROR,"servicetoken "+JSON.stringify(g))).setEntity(h).setEntity(f);var y,w;try{y=K(n)}catch(x){throw(new p(a.SERVICETOKEN_TOKENDATA_INVALID,"servicetoken "+JSON.stringify(g),x)).setEntity(h).setEntity(f);}if(!y||0==y.length)throw(new G(a.SERVICETOKEN_TOKENDATA_MISSING,"servicetoken "+JSON.stringify(g))).setEntity(h).setEntity(f);try{w=K(I)}catch(U){throw(new p(a.SERVICETOKEN_SIGNATURE_INVALID,
"servicetoken "+JSON.stringify(g),U)).setEntity(h).setEntity(f);}var B,P,M,r,R,q,z=ca(y,W);try{var t=JSON.parse(z);B=t.name;P=t.mtserialnumber?parseInt(t.mtserialnumber):-1;M=t.uitserialnumber?parseInt(t.uitserialnumber):-1;r=t.encrypted;R=t.compressionalgo;q=t.servicedata}catch(Ba){if(Ba instanceof SyntaxError)throw(new G(a.JSON_PARSE_ERROR,"servicetokendata "+z,Ba)).setEntity(h).setEntity(f);throw Ba;}if(!B||"number"!==typeof P||P!=P||"number"!==typeof M||M!=M||"boolean"!==typeof r||R&&"string"!==
typeof R||"string"!==typeof q)throw(new G(a.JSON_PARSE_ERROR,"servicetokendata "+z)).setEntity(h).setEntity(f);if(t.mtserialnumber&&0>P||P>T)throw(new p(a.SERVICETOKEN_MASTERTOKEN_SERIAL_NUMBER_OUT_OF_RANGE,"servicetokendata "+z)).setEntity(h).setEntity(f);if(t.uitserialnumber&&0>M||M>T)throw(new p(a.SERVICETOKEN_USERIDTOKEN_SERIAL_NUMBER_OUT_OF_RANGE,"servicetokendata "+z)).setEntity(h).setEntity(f);if(-1!=P&&(!h||P!=h.serialNumber))throw(new p(a.SERVICETOKEN_MASTERTOKEN_MISMATCH,"st mtserialnumber "+
P+"; mt "+h)).setEntity(h).setEntity(f);if(-1!=M&&(!f||M!=f.serialNumber))throw(new p(a.SERVICETOKEN_USERIDTOKEN_MISMATCH,"st uitserialnumber "+M+"; uit "+f)).setEntity(h).setEntity(f);r=!0===r;var C;if(R){if(!za[R])throw new p(a.UNIDENTIFIED_COMPRESSION,R);C=R}else C=null;v?v.verify(y,w,{result:function(c){b(H,function(){if(c){var g;try{g=K(q)}catch(n){throw(new p(a.SERVICETOKEN_SERVICEDATA_INVALID,"servicetokendata "+z,n)).setEntity(h).setEntity(f);}if(!g||0!=q.length&&0==g.length)throw(new p(a.SERVICETOKEN_SERVICEDATA_INVALID,
"servicetokendata "+z)).setEntity(h).setEntity(f);if(r&&0<g.length)v.decrypt(g,{result:function(a){b(H,function(){var b=C?Yb(C,a):a,g=new d(y,w,c);new vb(e,B,b,-1!=P?h:null,-1!=M?f:null,r,C,v,g,H)})},error:function(a){b(H,function(){a instanceof p&&(a.setEntity(h),a.setUser(f));throw a;})}});else{g=C?Yb(C,g):g;var I=new d(y,w,c);new vb(e,B,g,-1!=P?h:null,-1!=M?f:null,r,C,v,I,H)}}else g=""==q?new Uint8Array(0):null,I=new d(y,w,c),new vb(e,B,g,-1!=P?h:null,-1!=M?f:null,r,C,v,I,H)})},error:function(a){b(H,
function(){a instanceof p&&(a.setEntity(h),a.setUser(f));throw a;})}}):(n=""==q?new Uint8Array(0):null,I=new d(y,w,!1),new vb(e,B,n,-1!=P?h:null,-1!=M?f:null,r,C,v,I,H))})}})();var wb,rd;(function(){var a={};wb=function(b){Object.defineProperties(this,{name:{value:b,writable:!1,configurable:!1}});a[b]=this};x.Class.mixin(wb,{EMAIL_PASSWORD:new wb("EMAIL_PASSWORD")});Object.freeze(wb);rd=function(b){return a[b]?a[b]:null}})();var kb,hd;(function(){kb=x.Class.create({init:function(a){Object.defineProperties(this,
{scheme:{value:a,writable:!1,configurable:!1}})},getAuthData:function(){},equals:function(a){return this===a?!0:a instanceof kb?this.scheme==a.scheme:!1},toJSON:function(){var a={};a.scheme=this.scheme.name;a.authdata=this.getAuthData();return a}});hd=function(c,e,k,g){b(g,function(){var b=k.scheme,h=k.authdata;if("string"!==typeof b||"object"!==typeof h)throw new G(a.JSON_PARSE_ERROR,"userauthdata "+JSON.stringify(k));var f=rd(b);if(!f)throw new d(a.UNIDENTIFIED_USERAUTH_SCHEME,b);b=c.getUserAuthenticationFactory(f);
if(!b)throw new d(a.USERAUTH_FACTORY_NOT_FOUND,f.name);b.createData(c,e,h,g)})}})();var Jb=x.Class.create({init:function(a){Object.defineProperties(this,{scheme:{value:a,writable:!1,configurable:!1}})},createData:function(a,b,c,d){},authenticate:function(a,b,c,d){}}),Kb,sd;(function(){Kb=kb.extend({init:function l(a,b){l.base.call(this,wb.EMAIL_PASSWORD);Object.defineProperties(this,{email:{value:a,writable:!1,configurable:!1},password:{value:b,writable:!1,configurable:!1}})},getAuthData:function(){var a=
{};a.email=this.email;a.password=this.password;return a},equals:function k(a){return this===a?!0:a instanceof Kb?k.base.call(this,this,a)&&this.email==a.email&&this.password==a.password:!1}});sd=function(b){var c=b.email,d=b.password;if("string"!==typeof c||"string"!==typeof d)throw new G(a.JSON_PARSE_ERROR,"email/password authdata "+JSON.stringify(b));return new Kb(c,d)}})();Jb.extend({init:function l(a){l.base.call(this,wb.EMAIL_PASSWORD);Object.defineProperties(this,{_store:{value:a,writable:!1,
enumerable:!1,configurable:!1}})},createData:function(a,c,d,e){b(e,function(){return sd(d)})},authenticate:function(b,c,g,e){if(!(g instanceof Kb))throw new E("Incorrect authentication data type "+g+".");b=g.email;c=g.password;if(!b||0==b.trim().length||!c||0==c.trim().length)throw(new d(a.EMAILPASSWORD_BLANK)).setUser(g);b=this._store.isUser(b,c);if(null==b)throw(new d(a.EMAILPASSWORD_INCORRECT)).setUser(g);if(e&&(e=e.user,!b.equals(e)))throw(new d(a.USERIDTOKEN_USERAUTH_DATA_MISMATCH,"uad user "+
b+"; uit user "+e)).setUser(g);return b}});Object.freeze({ENTITY_REAUTH:c.ENTITY_REAUTH,ENTITYDATA_REAUTH:c.ENTITYDATA_REAUTH});var te=x.Class.create({getTime:function(){},getRandom:function(){},isPeerToPeer:function(){},getMessageCapabilities:function(){},getEntityAuthenticationData:function(a,b){},getMslCryptoContext:function(){},getEntityAuthenticationFactory:function(a){},getUserAuthenticationFactory:function(a){},getTokenFactory:function(){},getKeyExchangeFactory:function(a){},getKeyExchangeFactories:function(){},
getMslStore:function(){}}),ue=x.Class.create({setCryptoContext:function(a,b){},getMasterToken:function(){},getNonReplayableId:function(a){},getCryptoContext:function(a){},removeCryptoContext:function(a){},clearCryptoContexts:function(){},addUserIdToken:function(a,b){},getUserIdToken:function(a){},removeUserIdToken:function(a){},clearUserIdTokens:function(){},addServiceTokens:function(a){},getServiceTokens:function(a,b){},removeServiceTokens:function(a,b,c){},clearServiceTokens:function(){}}),td;(function(){td=
ue.extend({init:function k(){k.base.call(this);Object.defineProperties(this,{masterTokens:{value:{},writable:!1,enumerable:!1,configurable:!1},cryptoContexts:{value:{},writable:!1,enumerable:!1,configurable:!1},userIdTokens:{value:{},writable:!1,enumerable:!1,configurable:!1},nonReplayableIds:{value:{},writable:!1,enumerable:!1,configurable:!1},unboundServiceTokens:{value:{},writable:!1,enumerable:!1,configurable:!1},mtServiceTokens:{value:{},writable:!1,enumerable:!1,configurable:!1},uitServiceTokens:{value:{},
writable:!1,enumerable:!1,configurable:!1}})},setCryptoContext:function(a,b){if(b){var c=a.uniqueKey();this.masterTokens[c]=a;this.cryptoContexts[c]=b}else this.removeCryptoContext(a)},getMasterToken:function(){var a=null,b;for(b in this.masterTokens){var c=this.masterTokens[b];if(!a||c.isNewerThan(a))a=c}return a},getNonReplayableId:function(a){a=a.serialNumber;var b;b=void 0!==this.nonReplayableIds[a]?this.nonReplayableIds[a]:0;if(0>b||b>T)throw new E("Non-replayable ID "+b+" is outside the valid range.");
b=b==T?0:b+1;return this.nonReplayableIds[a]=b},getCryptoContext:function(a){return this.cryptoContexts[a.uniqueKey()]},removeCryptoContext:function(a){var b=a.uniqueKey();if(this.masterTokens[b]){delete this.masterTokens[b];delete this.cryptoContexts[b];var b=a.serialNumber,c;for(c in this.masterTokens)if(this.masterTokens[c].serialNumber==b)return;delete this.nonReplayableIds[b];Object.keys(this.userIdTokens).forEach(function(b){b=this.userIdTokens[b];b.isBoundTo(a)&&this.removeUserIdToken(b)},
this);try{this.removeServiceTokens(null,a,null)}catch(d){if(d instanceof p)throw new E("Unexpected exception while removing master token bound service tokens.",d);throw d;}}},clearCryptoContexts:function(){[this.masterTokens,this.cryptoContexts,this.nonReplayableIds,this.userIdTokens,this.uitServiceTokens,this.mtServiceTokens].forEach(function(a){for(var b in a)delete a[b]},this)},addUserIdToken:function(b,c){var d=!1,e;for(e in this.masterTokens)if(c.isBoundTo(this.masterTokens[e])){d=!0;break}if(!d)throw new p(a.USERIDTOKEN_MASTERTOKEN_NOT_FOUND,
"uit mtserialnumber "+c.mtSerialNumber);this.userIdTokens[b]=c},getUserIdToken:function(a){return this.userIdTokens[a]},removeUserIdToken:function(a){var b=null,c;for(c in this.masterTokens){var d=this.masterTokens[c];if(a.isBoundTo(d)){b=d;break}}Object.keys(this.userIdTokens).forEach(function(c){if(this.userIdTokens[c].equals(a)){delete this.userIdTokens[c];try{this.removeServiceTokens(null,b,a)}catch(d){if(d instanceof p)throw new E("Unexpected exception while removing user ID token bound service tokens.",
d);throw d;}}},this)},clearUserIdTokens:function(){for(var a in this.userIdTokens){var b=this.userIdTokens[a];try{this.removeServiceTokens(null,null,b)}catch(c){if(c instanceof p)throw new E("Unexpected exception while removing user ID token bound service tokens.",c);throw c;}delete this.userIdTokens[a]}},addServiceTokens:function(b){b.forEach(function(b){if(b.isUnbound())this.unboundServiceTokens[b.uniqueKey()]=b;else{if(b.isMasterTokenBound()){var c=!1,d;for(d in this.masterTokens)if(b.isBoundTo(this.masterTokens[d])){c=
!0;break}if(!c)throw new p(a.SERVICETOKEN_MASTERTOKEN_NOT_FOUND,"st mtserialnumber "+b.mtSerialNumber);}if(b.isUserIdTokenBound()){var c=!1,e;for(e in this.userIdTokens)if(b.isBoundTo(this.userIdTokens[e])){c=!0;break}if(!c)throw new p(a.SERVICETOKEN_USERIDTOKEN_NOT_FOUND,"st uitserialnumber "+b.uitSerialNumber);}b.isMasterTokenBound()&&((e=this.mtServiceTokens[b.mtSerialNumber])||(e={}),e[b.uniqueKey()]=b,this.mtServiceTokens[b.mtSerialNumber]=e);b.isUserIdTokenBound()&&((e=this.uitServiceTokens[b.uitSerialNumber])||
(e={}),e[b.uniqueKey()]=b,this.uitServiceTokens[b.uitSerialNumber]=e)}},this)},getServiceTokens:function(b,c){if(c){if(!b)throw new p(a.USERIDTOKEN_MASTERTOKEN_NULL);if(!c.isBoundTo(b))throw new p(a.USERIDTOKEN_MASTERTOKEN_MISMATCH,"uit mtserialnumber "+c.mtSerialNumber+"; mt "+b.serialNumber);}var d={},e;for(e in this.unboundServiceTokens){var h=this.unboundServiceTokens[e];d[h.uniqueKey()]=h}if(b&&(h=this.mtServiceTokens[b.serialNumber]))for(e in h){var f=h[e];f.isUserIdTokenBound()||(d[e]=f)}if(c&&
(h=this.uitServiceTokens[c.serialNumber]))for(e in h)f=h[e],f.isBoundTo(b)&&(d[e]=f);h=[];for(e in d)h.push(d[e]);return h},removeServiceTokens:function(b,c,d){if(d&&c&&!d.isBoundTo(c))throw new p(a.USERIDTOKEN_MASTERTOKEN_MISMATCH,"uit mtserialnumber "+d.mtSerialNumber+"; mt "+c.serialNumber);if(b&&!c&&!d){Object.keys(this.unboundServiceTokens).forEach(function(a){this.unboundServiceTokens[a].name==b&&delete this.unboundServiceTokens[a]},this);for(var e in this.mtServiceTokens){var h=this.mtServiceTokens[e],
f=Object.keys(h);f.forEach(function(a){h[a].name==b&&delete h[a]},this);this.mtServiceTokens[e]=h}for(var n in this.uitServiceTokens)h=this.uitServiceTokens[n],e=Object.keys(h),e.forEach(function(a){h[a].name==b&&delete h[a]},this),this.uitServiceTokens[n]=h}if(c&&!d){if(h=this.mtServiceTokens[c.serialNumber])f=Object.keys(h),f.forEach(function(a){var c=h[a];b&&c.name!=b||delete h[a]},this),this.mtServiceTokens[c.serialNumber]=h;for(n in this.uitServiceTokens){var I=this.uitServiceTokens[n];e=Object.keys(I);
e.forEach(function(a){var d=I[a];b&&d.name!=b||d.isBoundTo(c)&&delete I[a]},this);this.uitServiceTokens[n]=I}}d&&(h=this.uitServiceTokens[d.serialNumber])&&(e=Object.keys(h),e.forEach(function(a){var d=h[a];b&&d.name!=b||c&&!d.isBoundTo(c)||delete h[a]},this),this.uitServiceTokens[d.serialNumber]=h)},clearServiceTokens:function(){[this.unboundServiceTokens,this.mtServiceTokens,this.uitServiceTokens].forEach(function(a){for(var b in a)delete a[b]},this)}})})();var vc,Yb;(function(){var b=za;vc=function(c,
d){switch(c){case b.LZW:return nrdp.compress(d,"lzw",!0);case b.GZIP:return nrdp.compress(d,"gzip",!0);default:throw new p(a.UNSUPPORTED_COMPRESSION,c);}};Yb=function(c,d,e){switch(c){case b.LZW:return nrdp.uncompress(d,"lzw",!0);case b.GZIP:return nrdp.uncompress(d,"gzip",!0);default:throw new p(a.UNSUPPORTED_COMPRESSION,c.name());}}})();var J;(function(){J=function(b,c,d){a.call(this,2E5+b,c,d)}})();x.Class.mixin(J,{ASN1_PARSE_ERROR:new J(22,c.FAIL,"Error parsing ASN.1."),ASN1_ENCODE_ERROR:new J(23,
c.FAIL,"Error encoding ASN.1."),XML_PARSE_ERROR:new J(49,c.FAIL,"Error parsing XML."),XML_ENCODE_ERROR:new J(50,c.FAIL,"Error encoding XML."),MASTERTOKEN_SEQUENCE_NUMBER_OUT_OF_SYNC:new J(1009,c.ENTITY_REAUTH,"Master token sequence number does not have the expected value."),MASTERTOKEN_IDENTITY_REVOKED:new J(1013,c.ENTITY_REAUTH,"Master token entity identity is revoked."),USERIDTOKEN_IDENTITY_NOT_FOUND:new J(2013,c.USER_REAUTH,"The user identity was not found."),USERIDTOKEN_PASSWORD_VERSION_CHANGED:new J(2014,
c.USER_REAUTH,"The user identity must be reauthenticated because the password version changed."),USERIDTOKEN_INCORRECT_MSLUSER:new J(2015,c.FAIL,"The user ID token MSL user type is incorrect."),USERIDTOKEN_INVALID_MSLUSER:new J(2016,c.USER_REAUTH,"The user ID token MSL user is invalid."),NPTICKET_GRACE_PERIOD_EXCEEDED:new J(4008,c.ENTITYDATA_REAUTH,"Fake NP-Tickets cannot be used after the grace period when the Playstation Network is up."),NPTICKET_SERVICE_ID_MISSING:new J(4009,c.ENTITYDATA_REAUTH,
"NP-Ticket service ID is missing."),NPTICKET_SERVICE_ID_DISALLOWED:new J(4010,c.ENTITYDATA_REAUTH,"NP-Ticket service ID is not allowed."),NPTICKET_NOT_YET_VALID:new J(4011,c.ENTITYDATA_REAUTH,"NP-Ticket issuance date is in the future."),NPTICKET_EXPIRED:new J(4012,c.ENTITYDATA_REAUTH,"NP-Ticket has expired."),NPTICKET_PRIVATE_KEY_NOT_FOUND:new J(4013,c.ENTITYDATA_REAUTH,"No private key found for NP-Ticket GUID."),NPTICKET_COOKIE_VERIFICATION_FAILED:new J(4014,c.ENTITYDATA_REAUTH,"NP-Ticket cookie signature verification failed."),
NPTICKET_INCORRECT_COOKIE_VERSION:new J(4015,c.ENTITYDATA_REAUTH,"Incorrect NP-Ticket cookie version."),NPTICKET_BROKEN:new J(4016,c.ENTITYDATA_REAUTH,"NP-Ticket broken."),NPTICKET_VERIFICATION_FAILED:new J(4017,c.ENTITYDATA_REAUTH,"NP-Ticket signature verification failed."),NPTICKET_ERROR:new J(4018,c.ENTITYDATA_REAUTH,"Unknown NP-Ticket TCM error."),NPTICKET_CIPHER_INFO_NOT_FOUND:new J(4019,c.ENTITYDATA_REAUTH,"No cipher information found for NP-Ticket."),NPTICKET_INVALID_CIPHER_INFO:new J(4020,
c.ENTITYDATA_REAUTH,"Cipher information for NP-Ticket is invalid."),NPTICKET_UNSUPPORTED_VERSION:new J(4021,c.ENTITYDATA_REAUTH,"Unsupported NP-Ticket version."),NPTICKET_INCORRECT_KEY_LENGTH:new J(4022,c.ENTITYDATA_REAUTH,"Incorrect NP-Ticket public key length."),CRYPTEX_RSA_KEY_SET_NOT_FOUND:new J(4024,c.FAIL,"Cryptex RSA key set not found."),NPTICKET_COOKIE_PARSE_ERROR:new J(4027,c.ENTITYDATA_REAUTH,"Error parsing NP-Ticket cookie."),FORCE_LOGIN:new J(5E3,c.USERDATA_REAUTH,"User must login again."),
NETFLIXID_COOKIES_EXPIRED:new J(5001,c.USERDATA_REAUTH,"Netflix ID cookie identity has expired."),NETFLIXID_COOKIES_BLANK:new J(5002,c.USERDATA_REAUTH,"Netflix ID or Secure Netflix ID cookie is blank."),AUTHMGR_COMMS_FAILURE:new J(5006,c.TRANSIENT_FAILURE,"Error communicating with authentication manager."),SSOTOKEN_BLANK:new J(5009,c.SSOTOKEN_REJECTED,"SSO token is blank."),SSOTOKEN_NOT_ASSOCIATED:new J(5010,c.USERDATA_REAUTH,"SSO token is not associated with a Netflix user."),PROFILEGUID_BLANK:new J(5012,
c.USERDATA_REAUTH,"Profile GUID is blank."),SSOTOKEN_INVALID:new J(5015,c.SSOTOKEN_REJECTED,"SSO token invalid."),ACCTMGR_COMMS_FAILURE:new J(5017,c.TRANSIENT_FAILURE,"Error communicating with the account manager."),SSO_ASSOCIATION_FAILURE:new J(5018,c.TRANSIENT_FAILURE,"SSO user association failed."),SSO_DISASSOCIATION_FAILURE:new J(5019,c.TRANSIENT_FAILURE,"SSO user disassociation failed."),MDX_USERAUTH_VERIFICATION_FAILED:new J(5020,c.USERDATA_REAUTH,"MDX user authentication data verification failed."),
MDX_USERAUTH_ACTION_INVALID:new J(5022,c.USERDATA_REAUTH,"MDX user authentication data action is invalid."),CTICKET_DECRYPT_ERROR:new J(5023,c.USERDATA_REAUTH,"CTicket decryption failed."),CTICKET_CRYPTOCONTEXT_ERROR:new J(5026,c.USERDATA_REAUTH,"Error creating CTicket crypto context."),MDX_PIN_BLANK:new J(5027,c.USERDATA_REAUTH,"MDX controller or target PIN is blank."),MDX_PIN_MISMATCH:new J(5028,c.USERDATA_REAUTH,"MDX controller and target PIN mismatch."),MDX_USER_UNKNOWN:new J(5029,c.USERDATA_REAUTH,
"MDX controller user ID token or CTicket is not decrypted or verified."),MDX_CONTROLLERDATA_INVALID:new J(5031,c.USERDATA_REAUTH,"MDX controller authentication data is invalid."),SSO_ASSOCIATION_WITH_NONMEMBER:new J(5034,c.USERDATA_REAUTH,"SSO user association failed because the customer is not a member."),SSO_ASSOCIATION_WITH_FORMERMEMBER:new J(5035,c.USERDATA_REAUTH,"SSO user association failed because the customer is a former member."),SSO_ASSOCIATION_CONFLICT:new J(5036,c.USERDATA_REAUTH,"SSO user association failed because the token identifies a different member."),
PROFILE_SWITCH_DISALLOWED:new J(5038,c.TRANSIENT_FAILURE,"Unable to switch user profile."),MEMBERSHIPCLIENT_COMMS_FAILURE:new J(5039,c.TRANSIENT_FAILURE,"Error communicating with the membership manager."),USERIDTOKEN_IDENTITY_NOT_ASSOCIATED_WITH_ENTITY:new J(5040,c.USERDATA_REAUTH,"The entity is not associated with the user."),INCORRECT_MSLUSER:new J(5041,c.FAIL,"The MSL user type is incorrect."),NONREPLAYABLE_ID_OUT_OF_RANGE:new J(6032,c.FAIL,"Non-replayable message non-replayable ID is out of range."),
CRYPTEX_ENCRYPTION_ERROR:new J(8E3,c.FAIL,"Error encrypting data with cryptex."),CRYPTEX_DECRYPTION_ERROR:new J(8001,c.FAIL,"Error decrypting data with cryptex."),CRYPTEX_MAC_ERROR:new J(8002,c.FAIL,"Error computing MAC with cryptex."),CRYPTEX_VERIFY_ERROR:new J(8003,c.FAIL,"Error verifying MAC or signature with cryptex."),CRYPTEX_CONTEXT_CREATION_FAILURE:new J(8004,c.FAIL,"Error creating cryptex cipher or MAC context."),DATAMODEL_DEVICE_ACCESS_ERROR:new J(8005,c.TRANSIENT_FAILURE,"Error accessing data model device."),
DATAMODEL_DEVICETYPE_NOT_FOUND:new J(8006,c.FAIL,"Data model device type not found."),CRYPTEX_KEYSET_UNSUPPORTED:new J(8007,c.FAIL,"Cryptex key set not supported."),CRYPTEX_PRIVILEGE_EXCEPTION:new J(8008,c.FAIL,"Insufficient privileges for cryptex operation."),CRYPTEX_WRAP_ERROR:new J(8009,c.FAIL,"Error wrapping data with cryptex."),CRYPTEX_UNWRAP_ERROR:new J(8010,c.FAIL,"Error unwrapping data with cryptex."),CRYPTEX_COMMS_FAILURE:new J(8011,c.TRANSIENT_FAILURE,"Error comunicating with cryptex."),
CRYPTEX_SIGN_ERROR:new J(8012,c.FAIL,"Error computing signature with cryptex."),CRYPTEX_FINGERPRINT_ERROR:new J(8013,c.FAIL,"Error computing key fingerprint with cryptex.")});Object.freeze(J);var ud;(function(){ud=lb.extend({init:function k(a,b,c){k.base.call(this);Object.defineProperties(this,{id:{value:b,writable:!1,enumerable:!1,configurable:!1},privateKey:{value:c,writable:!1,enumerable:!1,configurable:!1}})},encrypt:function(a,b){b.result(a)},decrypt:function(a,b){b.result(a)},wrap:function(b,
c){c.error(new F(a.WRAP_NOT_SUPPORTED))},unwrap:function(b,c,d){d.error(new F(a.UNWRAP_NOT_SUPPORTED))},sign:function(c,d){b(d,function(){if(!this.privateKey)throw new F(a.SIGN_NOT_SUPPORTED,"no private key");var b=ja.sign($d,this.privateKey,c);b.oncomplete=function(){d.result(b.result)};b.onerror=function(){d.error(new F(a.SIGNATURE_ERROR))}},this)},verify:function(a,b,c){c.result(a)}})})();var Ta,vd;(function(){Ta=Wa.extend({init:function k(a){k.base.call(this,ia.MGK);Object.defineProperties(this,
{identity:{value:a,writable:!1,configurable:!1}})},getIdentity:function(){return this.identity},getAuthData:function(){var a={};a.identity=this.identity;return a},equals:function g(a){return this===a?!0:a instanceof Ta?g.base.call(this,this,a)&&this.identity==a.identity:!1}});vd=function(b){var c=b.identity;if(!c)throw new G(a.JSON_PARSE_ERROR,"mgk authdata"+JSON.stringify(b));return new Ta(c)}})();var ve=Bb.extend({init:function k(a){k.base.call(this,ia.MGK);Object.defineProperties(this,{localIdentity:{value:a,
writable:!1,enumerable:!1,configurable:!1}})},createData:function(a,b){return vd(b)},getCryptoContext:function(b,c){if(!(c instanceof Ta))throw new E("Incorrect authentication data type "+JSON.stringify(c)+".");if(c.identity!=this.localIdentity)throw(new Ha(a.ENTITY_NOT_FOUND,"mgk "+c.identity)).setEntity(c);return new Ab}}),Eb,wd;(function(){Eb=Wa.extend({init:function g(a,b){g.base.call(this,ia.NPTICKET);var c=b.algorithm.npTicketExpiration,d=b.algorithm.npTicket,e=b.algorithm.npTicketIssue,h=b.algorithm.npTicketFake;
if(c<e)throw new E("Cannot construct an NP-Ticket that expires before it was issued.");Object.defineProperties(this,{identity:{value:a,writable:!1,configurable:!1},privateKey:{value:b,writable:!1,configurable:!1},npticket:{value:d,writable:!1,enumerable:!0,configuration:!1},issuance:{value:e,writable:!1,configurable:!1},expiration:{value:c,writable:!1,configurable:!1},fake:{value:h,writable:!1,configurable:!1}})},isNetflixGenerated:function(){return this.fake},isValid:function(a){return Date.now()+
a>=1E3*this.issuance},isExpired:function(a){return Date.now()-a>1E3*this.expiration},getIssuance:function(){return new Date(1E3*this.issuance)},getExpiration:function(){return new Date(1E3*this.expiration)},getAuthData:function(){var a={};a.npticket=this.npticket;return a},equals:function u(a){return this===a?!0:a instanceof Eb?u.base.call(this,this,a)&&f(this.npticket,a.npticket):!1},getIdentity:function(){return this.identity},getPrivateKey:function(){return this.privateKey}});wd=function(){throw new Ha(a.UNSUPPORTED_ENTITY_AUTH,
"npticket");}})();var we=Bb.extend({init:function g(a){g.base.call(this,ia.NPTICKET)},createData:function(a,b){return wd(b)},getCryptoContext:function(b,c){if(!(c instanceof Eb))throw new E("Incorrect authentication data type "+c+".");var d=c.getIdentity(),e=c.getPrivateKey();if(!d)throw(new Ha(a.ENTITY_NOT_FOUND,"npticket "+d)).setEntity(c);if(!e)throw(new Ha(a.NPTICKET_PRIVATE_KEY_NOT_FOUND,"npticket "+d)).setEntity(c);return new ud(b,d,e)}}),ia;(function(){ia=function(a,b,c){ga.call(this,a,b,c)};
x.Class.mixin(ia,{MGK:new ia("MGK",!0,!0),NPTICKET:new ia("NPTICKET",!1,!0),ECC:new ia("ECC",!1,!0)});Object.freeze(ia)})();var xd,xc,yc,yd,zd;(function(){function c(a){var b=a,d,e;b&&b.length&&b[0]&&(b=new Uint8Array(a.length+1),b[0]=0,b.set(a,1));if(b&&128>b.length){e=new Uint8Array(128);d=128-b.length;for(a=0;a<d;++a)e[a]=0;e.set(b,d);b=e}return b}function d(a,c,e,g){b(g,function(){Ga(a,{result:function(a){Ga(c,{result:function(b){Ga(e,{result:function(c){g.result({encryptionKey:a,hmacKey:b,wrappingKey:c})},
error:g.error})},error:g.error})},error:g.error})})}var e=xc={PSK:"PSK",MGK:"MGK",WRAP:"WRAP"};zd=x.Class.create({addDerivationKey:function(a,b){},getDerivationKey:function(a){},removeDerivationKey:function(a){}});var h=yc=fb.extend({init:function I(a,b,d,h,f){I.base.call(this,Ca.AUTHENTICATED_DH);switch(a){case e.WRAP:if(!f)throw new E("Previous wrapping key based key exchange requires the previous wrapping key data and ID.");break;default:f=null}var v={};v.mechanism=a;v.publickey=w(c(d));v.parametersid=
b;f&&(v.wrapdata=w(f));Object.defineProperties(this,{mechanism:{value:a,writable:!1,configurable:!1},wrapdata:{value:f,writable:!1,configurable:!1},parametersId:{value:b,writable:!1,configurable:!1},publicKey:{value:d,writable:!1,configurable:!1},privateKey:{value:h,writable:!1,configurable:!1},keyData:{value:v,writable:!1,configurable:!1}})},getKeydata:function(){return this.keyData},equals:function N(a){if(a===this)return!0;if(!(a instanceof yc))return!1;var b=this.privateKey===a.privateKey||this.privateKey&&
a.privateKey&&f(this.privateKey.getEncoded(),a.privateKey.getEncoded());return N.base.call(this,a)&&this.mechanism==a.mechanism&&this.parametersId==a.parametersId&&f(this.publicKey,a.publicKey)&&f(this.wrapdata,a.wrapdata)&&b},uniqueKey:function Y(){var a=Y.base.call(this)+":"+this.mechanism+":"+this.parametersId+":"+z(this.publicKey);this.wrapdata&&(a+=":"+z(this.wrapdata));return a}}),H=yd=gb.extend({init:function fa(a,b,c,d){fa.base.call(this,a,Ca.AUTHENTICATED_DH);Object.defineProperties(this,
{parametersId:{value:b,writable:!1,configurable:!1},publicKey:{value:c,writable:!1,configurable:!1},wrapdata:{value:d,writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.parametersid=this.parametersId;a.wrapdata=w(this.wrapdata);var b=c(this.publicKey);a.publickey=w(b);return a},equals:function U(a){return this===a?!0:a instanceof yd?U.base.call(this,a)&&this.parametersId==a.parametersId&&f(this.publicKey,a.publicKey)&&f(this.wrapdata,a.wrapdata):!1},uniqueKey:function B(){return B.base.call(this)+
":"+this.parametersId+":"+z(this.publicKey)+":"+z(this.wrapdata)}});xd=ta.extend({init:function P(a,b){P.base.call(this,Ca.AUTHENTICATED_DH);Object.defineProperties(this,{repository:{value:a,writable:!1,enumerable:!1,configurable:!1},params:{value:b,writable:!1,enumerable:!1,configurable:!1}})},createRequestData:function(a,c,d){b(d,function(){return RequestData$parse(c)})},createResponseData:function(b,d,e){b=e.wrapdata;var h=e.parametersid,f=e.publickey;if("string"!==typeof b||"string"!==typeof h||
"string"!==typeof f)throw new G(a.JSON_PARSE_ERROR,"keydata "+JSON.stringify(e));var m;try{m=K(b)}catch(v){throw new V(a.KEYX_WRAPPING_KEY_MISSING,"keydata "+e.toString(),v);}if(!m||0==m.length)throw new V(a.KEYX_WRAPPING_KEY_MISSING,"keydata "+e.toString());var u;try{var C=K(f);u=c(C)}catch(p){throw new V(a.KEYX_INVALID_PUBLIC_KEY,"keydata "+JSON.stringify(e),p);}if(!u||0==u.length)throw new V(a.KEYX_INVALID_PUBLIC_KEY,"keydata "+JSON.stringify(e));return new H(d,h,u,m)},generateResponse:function(c,
g,f,R){function q(c,g,h){b(R,function(){var b=request.mechanism,c=request.wrapdata,f=request.publicKey;switch(b){case e.PSK:case e.MGK:c=this.repository.getDerivationKey();if(!c)throw new V(a.UNSUPPORTED_KEYX_MECHANISM,b);break;case e.WRAP:c=this.repository.getDerivationKey(c);if(!c)throw new V(a.KEYX_DERIVATION_KEY_MISSING,w(requestWrapdata));break;default:throw new V(a.UNSUPPORTED_KEYX_MECHANISM,b);}y.deriveKey({name:dc.name,params:{"public":f,kd:c}},h).then(function(a){d(a.encryptionKey,a.hmacKey,
a.wrappingKey,{result:function(a){x(g,a)},error:R.error})},function(b){R.error(new F(a.DERIVEKEY_ERROR,"",b))})},t)}function x(a,d){b(R,function(){var e=request.parametersId;c.getMslCryptoContext().wrap(d.derivationKey,{result:function(g){g=c.getTokenFactory();f instanceof ya?g.renewMasterToken(c,f,d.encryptionKey,d.hmacKey,{result:function(d){b(R,function(){var b=new na(c,d),g=new H(d,e,a);return new ta.KeyExchangeData(g,b)},t)},error:function(a){b(R,function(){a instanceof p&&a.setEntity(f);throw a;
},t)}}):g.createMasterToken(c,f,d.encryptionKey,d.hmacKey,{result:function(d){b(R,function(){var b=new na(c,d),g=new H(d,e,a);return new ta.KeyExchangeData(g,b)},t)},error:R.error})},error:R.error})},t)}var t=this;b(R,function(){if(!(g instanceof h))throw new E("Key request data "+JSON.stringify(g)+" was not created by this factory.");var b;if(f instanceof ya){if(!masterToken.isVerified())throw new wa(a.MASTERTOKEN_UNTRUSTED,masterToken);b=masterToken.identity}else b=f;var c=this.params.getParameterSpec(g.parametersId);
y.generateKey({name:dc,prime:c.p,generator:c.g},!1,Yd).then(function(a){q(b,a.publicKey,a.privateKey)},function(b){R.error(new F(a.GENERATEKEY_ERROR,"Error generating Diffie-Hellman key pair.",b))})},t)},getCryptoContext:function(c,g,f,R,q){function x(e,g,h,f){b(q,function(){y.deriveKey({name:dc.name,params:{"public":h.publicKey,kd:f.rawKey}},g.privateKey).then(function(a){d(a.encryptionKey,a.hmacKey,a.wrappingKey,{result:function(a){b(q,function(){this.repository.addDerivationKey(h.wrapdata,a.derivationKey);
g.wrapdata&&this.repository.removeDerivationKey(g.wrapdata);var b=h.masterToken,d=e.getIdentity();return new na(c,b,d,a.encryptionKey,a.hmacKey)},t)},error:function(a){b(q,function(){a instanceof p&&a.setEntity(e);throw a;})}})},function(b){q.error((new F(a.DERIVEKEY_ERROR,"",b)).setEntity(e))})},t)}var t=this;b(q,function(){if(!(g instanceof h))throw new E("Key request data "+JSON.stringify(g)+" was not created by this factory.");if(!(f instanceof H))throw new E("Key response data "+JSON.stringify(f)+
" was not created by this factory.");var d=g.parametersId,C=f.parametersId;if(d!=C)throw(new V(a.KEYX_RESPONSE_REQUEST_MISMATCH,"request "+d+"; response "+C)).setEntity(R);var u=g.mechanism,p=g.wrapdata;c.getEntityAuthenticationData(null,{result:function(c){b(q,function(){var b;switch(u){case e.WRAP:b=this.repository.getDerivationKey(p);if(!b)throw new V(a.KEYX_DERIVATION_KEY_MISSING,w(p));break;case e.PSK:case e.MGK:b=this.repository.getDerivationKey();if(!b)throw new V(a.UNSUPPORTED_KEYX_MECHANISM,
u);break;default:throw new E("Key request data mechanism "+u+" is not supported but it should be.");}x(c,g,f,b)},t)},error:q.error})},t)}})})();var Ad,zc,Ac,Bd,Cd;(function(){function c(e,g,h,f,m){b(m,function(){switch(g){case d.PSK:var c=new Ra(f),v=e.getEntityAuthenticationFactory(ga.PSK);if(!v)throw new V(a.UNSUPPORTED_KEYX_MECHANISM,g);c=v.getCryptoContext(e,c);return new db(e,eb.A128KW,t,v._kw);case d.MGK:c=new Ta(f);v=e.getEntityAuthenticationFactory(ia.MGK);if(!v)throw new V(a.UNSUPPORTED_KEYX_MECHANISM,
g);c=v.getCryptoContext(e,c);return new db(e,eb.A128KW,t,v._kw);case d.WRAP:c=e.getMslCryptoContext();c.unwrap(h,Za,Qa,{result:function(a){b(m,function(){return new db(e,eb.A128KW,t,a)})},error:m.error});break;default:throw new V(a.UNSUPPORTED_KEYX_MECHANISM,g);}})}var d=zc={PSK:"PSK",MGK:"MGK",WRAP:"WRAP"},e=Ac=fb.extend({init:function n(a,b){n.base.call(this,qa.JWE_LADDER);switch(a){case d.WRAP:if(!b)throw new E("Previous wrapping key based key exchange requires the previous wrapping key data and ID.");
break;default:b=null}Object.defineProperties(this,{mechanism:{value:a,writable:!1,configurable:!1},wrapdata:{value:b,writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.mechanism=this.mechanism;this.wrapdata&&(a.wrapdata=w(this.wrapdata));return a},equals:function I(a){return a===this?!0:a instanceof Ac?I.base.call(this,a)&&this.mechanism==a.mechanism&&f(this.wrapdata,a.wrapdata):!1},uniqueKey:function N(){var a=N.base.call(this)+":"+this.mechanism;this.wrapdata&&(a+=":"+z(this.wrapdata));
return a}}),h=Bd=gb.extend({init:function Y(a,b,c,d,e){Y.base.call(this,a,qa.JWE_LADDER);Object.defineProperties(this,{wrapKey:{value:b,writable:!1,configurable:!1},wrapdata:{value:c,writable:!1,configurable:!1},encryptionKey:{value:d,writable:!1,configurable:!1},hmacKey:{value:e,writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.wrapkey=w(this.wrapKey);a.wrapdata=w(this.wrapdata);a.encryptionkey=w(this.encryptionKey);a.hmackey=w(this.hmacKey);return a},equals:function fa(a){return this===
a?!0:a instanceof Bd?fa.base.call(this,a)&&f(this.wrapKey,a.wrapKey)&&f(this.wrapdata,a.wrapdata)&&f(this.encryptionKey,a.encryptionKey)&&f(this.hmacKey,a.hmacKey):!1},uniqueKey:function U(){return U.base.call(this)+":"+z(this.wrapKey)+":"+z(this.wrapdata)+":"+z(this.encryptionKey)+":"+z(this.hmacKey)}});Cd=x.Class.create({addCryptoContext:function(a,b){},getCryptoContext:function(a){},removeCryptoContext:function(a){}});Ad=ta.extend({init:function B(a){B.base.call(this,qa.JWE_LADDER);Object.defineProperties(this,
{repository:{value:a,writable:!1,enumerable:!1,configurable:!1}})},createRequestData:function(c,g,h){b(h,function(){var b=g.mechanism,c=g.wrapdata;if(!b||b==d.WRAP&&(!c||"string"!==typeof c))throw new G(a.JSON_PARSE_ERROR,"keydata "+JSON.stringify(g));if(!d[b])throw new V(a.UNIDENTIFIED_KEYX_MECHANISM,b);var h;switch(b){case d.WRAP:try{h=K(c)}catch(f){throw new V(a.KEYX_WRAPPING_KEY_MISSING,"keydata "+g.toString());}if(null==h||0==h.length)throw new V(a.KEYX_WRAPPING_KEY_MISSING,"keydata "+g.toString());
break;default:h=null}return new e(b,h)})},createResponseData:function(b,c,d){b=d.wrapkey;var e=d.wrapdata,g=d.encryptionkey,f=d.hmackey;if(!(b&&"string"===typeof b&&e&&"string"===typeof e&&g&&"string"===typeof g&&f)||"string"!==typeof f)throw new G(a.JSON_PARSE_ERROR,"keydata "+JSON.stringify(d));var m,u,p,C;try{m=K(b),u=K(e)}catch(y){throw new F(a.INVALID_SYMMETRIC_KEY,"keydata "+JSON.stringify(d),y);}try{p=K(g)}catch(w){throw new F(a.INVALID_ENCRYPTION_KEY,"keydata "+JSON.stringify(d),w);}try{C=
K(f)}catch(t){throw new F(a.INVALID_HMAC_KEY,"keydata "+JSON.stringify(d),t);}return new h(c,m,u,p,C)},generateResponse:function(d,f,u,r){function y(a,c,e){z.generateSessionKeys(d,{result:function(d){b(r,function(){q(a,c,e,d.encryptionKey,d.hmacKey)},z)},error:function(a){b(r,function(){a instanceof p&&a.setEntity(C);throw a;})}})}function q(a,e,h,q,m){b(r,function(){c(d,f.mechanism,f.wrapdata,a,{result:function(a){a.wrap(e,{result:function(a){w(e,h,q,m,a)},error:function(a){b(r,function(){a instanceof
p&&a.setEntity(C);throw a;})}})},error:function(a){b(r,function(){a instanceof p&&a.setEntity(C);throw a;})}})},z)}function w(a,c,e,g,h){b(r,function(){var f=new db(d,eb.A128KW,t,a);f.wrap(e,{result:function(a){f.wrap(g,{result:function(b){x(c,h,e,a,g,b)},error:function(a){b(r,function(){a instanceof p&&a.setEntity(C);throw a;})}})},error:function(a){b(r,function(){a instanceof p&&a.setEntity(C);throw a;})}})},z)}function x(a,c,e,g,f,q){b(r,function(){var m=d.getTokenFactory();C?m.renewMasterToken(d,
C,e,f,{result:function(e){b(r,function(){var b=new na(d,e),f=new h(e,c,a,g,q);return new ta.KeyExchangeData(f,b,r)},z)},error:function(a){b(r,function(){a instanceof p&&a.setEntity(C);throw a;})}}):m.createMasterToken(d,u,e,f,{result:function(e){b(r,function(){var b=new na(d,e),f=new h(e,c,a,g,q);return new ta.KeyExchangeData(f,b,r)},z)},error:r.error})},z)}var z=this,C;b(r,function(){if(!(f instanceof e))throw new E("Key request data "+JSON.stringify(f)+" was not created by this factory.");var c=
u;if(u instanceof ya){if(!u.isVerified())throw new wa(a.MASTERTOKEN_UNTRUSTED,u);C=u;c=u.identity}var g=new Uint8Array(16);d.getRandom().nextBytes(g);bb(g,Za,Qa,{result:function(a){b(r,function(){d.getMslCryptoContext().wrap(a,{result:function(b){y(c,a,b)},error:function(a){b(r,function(){a instanceof p&&a.setEntity(C);throw a;},z)}})},z)},error:function(c){b(r,function(){throw(new F(a.WRAP_KEY_CREATION_FAILURE,null,c)).setEntity(C);},z)}})},z)},getCryptoContext:function(c,g,f,r,y){function q(a,d,
e,g,h){b(y,function(){var f=new db(c,eb.A128KW,t,h);f.unwrap(d.encryptionKey,$a,Xa,{result:function(h){f.unwrap(d.hmacKey,ab,Ya,{result:function(a){b(y,function(){this.repository.addCryptoContext(d.wrapdata,f);this.repository.removeCryptoContext(e);return new na(c,d.masterToken,g,h,a)},x)},error:function(c){b(y,function(){c instanceof p&&c.setEntity(a);throw c;})}})},error:function(c){b(y,function(){c instanceof p&&c.setEntity(a);throw c;})}})},x)}var x=this;b(y,function(){if(!(g instanceof e))throw new E("Key request data "+
JSON.stringify(g)+" was not created by this factory.");if(!(f instanceof h))throw new E("Key response data "+JSON.stringify(f)+" was not created by this factory.");var r=g.mechanism,z=g.wrapdata;c.getEntityAuthenticationData(null,{result:function(e){b(y,function(){var g=e.getIdentity(),h;switch(r){case d.PSK:h=new Ra(g);var m=c.getEntityAuthenticationFactory(ga.PSK);if(!m)throw(new V(a.UNSUPPORTED_KEYX_MECHANISM,r)).setEntity(e);m.getCryptoContext(c,h);h=new db(c,eb.A128KW,t,m._kw);break;case d.MGK:h=
new Ta(g);m=c.getEntityAuthenticationFactory(ia.MGK);if(!m)throw(new V(a.UNSUPPORTED_KEYX_MECHANISM,r)).setEntity(e);m.getCryptoContext(c,h);h=new db(c,eb.A128KW,t,m._kw);break;case d.WRAP:h=this.repository.getCryptoContext(z);if(!h)throw(new V(a.KEYX_WRAPPING_KEY_MISSING,w(z))).setEntity(e);break;default:throw(new V(a.UNSUPPORTED_KEYX_MECHANISM,r)).setEntity(e);}h.unwrap(f.wrapKey,Za,Qa,{result:function(a){q(e,f,z,g,a)},error:function(a){b(y,function(){a instanceof p&&a.setEntity(e);throw a;})}})},
x)},error:y.error})},x)}})})();var Dd,Ed;(function(){function c(e,g,h,f,m){b(m,function(){switch(g){case d.PSK:var c=new Ra(f),B=e.getEntityAuthenticationFactory(ga.PSK);if(!B)throw new V(a.UNSUPPORTED_KEYX_MECHANISM,g);c=B.getCryptoContext(e,c);return new H(void 0);case d.MGK:c=new Ta(f);B=e.getEntityAuthenticationFactory(ia.MGK);if(!B)throw new V(a.UNSUPPORTED_KEYX_MECHANISM,g);c=B.getCryptoContext(e,c);return new H(void 0);case d.WRAP:c=e.getMslCryptoContext();c.unwrap(h,Za,Qa,{result:function(a){b(m,
function(){return new H(a)})},error:m.error});break;default:throw new V(a.UNSUPPORTED_KEYX_MECHANISM,g);}})}var d={PSK:"PSK",MGK:"MGK",WRAP:"WRAP"},e=Dd=fb.extend({init:function I(a,b){I.base.call(this,qa.JWK_LADDER);switch(a){case d.WRAP:if(!b)throw new E("Previous wrapping key based key exchange requires the previous wrapping key data and ID.");break;default:b=null}Object.defineProperties(this,{mechanism:{value:a,writable:!1,configurable:!1},wrapdata:{value:b,writable:!1,configurable:!1}})},getKeydata:function(){var a=
{};a.mechanism=this.mechanism;this.wrapdata&&(a.wrapdata=w(this.wrapdata));return a},equals:function N(a){return a===this?!0:a instanceof Dd?N.base.call(this,a)&&this.mechanism==a.mechanism&&f(this.wrapdata,a.wrapdata):!1},uniqueKey:function Y(){var a=Y.base.call(this)+":"+this.mechanism;this.wrapdata&&(a+=":"+z(this.wrapdata));return a}}),h=Ed=gb.extend({init:function fa(a,b,c,d,e){fa.base.call(this,a,qa.JWK_LADDER);Object.defineProperties(this,{wrapKey:{value:b,writable:!1,configurable:!1},wrapdata:{value:c,
writable:!1,configurable:!1},encryptionKey:{value:d,writable:!1,configurable:!1},hmacKey:{value:e,writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.wrapkey=w(this.wrapKey);a.wrapdata=w(this.wrapdata);a.encryptionkey=w(this.encryptionKey);a.hmackey=w(this.hmacKey);return a},equals:function U(a){return this===a?!0:a instanceof Ed?U.base.call(this,a)&&f(this.wrapKey,a.wrapKey)&&f(this.wrapdata,a.wrapdata)&&f(this.encryptionKey,a.encryptionKey)&&f(this.hmacKey,a.hmacKey):!1},uniqueKey:function B(){return B.base.call(this)+
":"+z(this.wrapKey)+":"+z(this.wrapdata)+":"+z(this.encryptionKey)+":"+z(this.hmacKey)}}),H=lb.extend({init:function(a){a&&(a=a.rawKey);Object.defineProperties(this,{_wrapKey:{value:a,writable:!1,enumerable:!1,configurable:!1}})},encrypt:function(b,c){c.error(new F(a.ENCRYPT_NOT_SUPPORTED))},decrypt:function(b,c){c.error(new F(a.DECRYPT_NOT_SUPPORTED))},wrap:function(c,d){b(d,function(){y.wrapKey("jwk",c.rawKey,this._wrapKey,Za).then(function(a){d.result(a)},function(b){d.error(new F(a.WRAP_ERROR))})},
this)},unwrap:function(c,d,e,g){function h(c){b(g,function(){switch(c.type){case "secret":Ga(c,g);break;case "public":nb(c,g);break;case "private":zb(c,g);break;default:throw new F(a.UNSUPPORTED_KEY,"type: "+c.type);}})}b(g,function(){y.unwrapKey("jwk",c,this._wrapKey,Za,d,!1,e).then(function(a){h(a)},function(b){g.error(new F(a.UNWRAP_ERROR))})},this)},sign:function(b,c){c.error(new F(a.SIGN_NOT_SUPPORTED))},verify:function(b,c,d){d.error(new F(a.VERIFY_NOT_SUPPORTED))}});ta.extend({init:function P(a){P.base.call(this,
qa.JWK_LADDER);Object.defineProperties(this,{repository:{value:a,writable:!1,enumerable:!1,configurable:!1}})},createRequestData:function(c,g,h){b(h,function(){var b=g.mechanism,c=g.wrapdata;if(!b||b==d.WRAP&&(!c||"string"!==typeof c))throw new G(a.JSON_PARSE_ERROR,"keydata "+JSON.stringify(g));if(!d[b])throw new V(a.UNIDENTIFIED_KEYX_MECHANISM,b);var h;switch(b){case d.WRAP:try{h=K(c)}catch(f){throw new V(a.KEYX_WRAPPING_KEY_MISSING,"keydata "+g.toString());}if(null==h||0==h.length)throw new V(a.KEYX_WRAPPING_KEY_MISSING,
"keydata "+g.toString());break;default:h=null}return new e(b,h)})},createResponseData:function(b,c,d){b=d.wrapkey;var e=d.wrapdata,g=d.encryptionkey,f=d.hmackey;if(!(b&&"string"===typeof b&&e&&"string"===typeof e&&g&&"string"===typeof g&&f)||"string"!==typeof f)throw new G(a.JSON_PARSE_ERROR,"keydata "+JSON.stringify(d));var m,u,C,p;try{m=K(b),u=K(e)}catch(y){throw new F(a.INVALID_SYMMETRIC_KEY,"keydata "+JSON.stringify(d),y);}try{C=K(g)}catch(H){throw new F(a.INVALID_ENCRYPTION_KEY,"keydata "+JSON.stringify(d),
H);}try{p=K(f)}catch(w){throw new F(a.INVALID_HMAC_KEY,"keydata "+JSON.stringify(d),w);}return new h(c,m,u,C,p)},generateResponse:function(d,f,r,u){function q(a,c,e){C.generateSessionKeys(d,{result:function(d){b(u,function(){y(a,c,e,d.encryptionKey,d.hmacKey)},C)},error:function(a){b(u,function(){a instanceof p&&a.setEntity(t);throw a;})}})}function y(a,e,h,m,q){b(u,function(){c(d,f.mechanism,f.wrapdata,a,{result:function(a){a.wrap(e,{result:function(a){w(e,h,m,q,a)},error:function(a){b(u,function(){a instanceof
p&&a.setEntity(t);throw a;})}})},error:function(a){b(u,function(){a instanceof p&&a.setEntity(t);throw a;})}})},C)}function w(a,c,d,e,g){b(u,function(){var h=new H(a);h.wrap(d,{result:function(a){h.wrap(e,{result:function(b){x(c,g,d,a,e,b)},error:function(a){b(u,function(){a instanceof p&&a.setEntity(t);throw a;})}})},error:function(a){b(u,function(){a instanceof p&&a.setEntity(t);throw a;})}})},C)}function x(a,c,e,g,f,m){b(u,function(){var q=d.getTokenFactory();t?q.renewMasterToken(d,t,e,f,{result:function(e){b(u,
function(){var b=new na(d,e),f=new h(e,c,a,g,m);return new ta.KeyExchangeData(f,b,u)},C)},error:function(a){b(u,function(){a instanceof p&&a.setEntity(t);throw a;})}}):q.createMasterToken(d,r,e,f,{result:function(e){b(u,function(){var b=new na(d,e),f=new h(e,c,a,g,m);return new ta.KeyExchangeData(f,b,u)},C)},error:u.error})},C)}var C=this,t;b(u,function(){if(!(f instanceof e))throw new E("Key request data "+JSON.stringify(f)+" was not created by this factory.");var c=r;if(r instanceof ya){if(!r.isVerified())throw new wa(a.MASTERTOKEN_UNTRUSTED,
r);t=r;c=r.identity}var g=new Uint8Array(16);d.getRandom().nextBytes(g);bb(g,Za,Qa,{result:function(a){b(u,function(){d.getMslCryptoContext().wrap(a,{result:function(b){q(c,a,b)},error:function(a){b(u,function(){a instanceof p&&a.setEntity(t);throw a;},C)}})},C)},error:function(c){b(u,function(){throw(new F(a.WRAP_KEY_CREATION_FAILURE,null,c)).setEntity(t);},C)}})},C)},getCryptoContext:function(c,g,f,y,q){function t(a,d,e,g,h){b(q,function(){var f=new H(h);f.unwrap(d.encryptionKey,$a,Xa,{result:function(h){f.unwrap(d.hmacKey,
ab,Ya,{result:function(a){b(q,function(){this.repository.addCryptoContext(d.wrapdata,f);this.repository.removeCryptoContext(e);return new na(c,d.masterToken,g,h,a)},x)},error:function(c){b(q,function(){c instanceof p&&c.setEntity(a);throw c;})}})},error:function(c){b(q,function(){c instanceof p&&c.setEntity(a);throw c;})}})},x)}var x=this;b(q,function(){if(!(g instanceof e))throw new E("Key request data "+JSON.stringify(g)+" was not created by this factory.");if(!(f instanceof h))throw new E("Key response data "+
JSON.stringify(f)+" was not created by this factory.");var y=g.mechanism,C=g.wrapdata;c.getEntityAuthenticationData(null,{result:function(e){b(q,function(){var g=e.getIdentity(),h;switch(y){case d.PSK:h=new Ra(g);var m=c.getEntityAuthenticationFactory(ga.PSK);if(!m)throw(new V(a.UNSUPPORTED_KEYX_MECHANISM,y)).setEntity(e);m.getCryptoContext(c,h);h=new H(void 0);break;case d.MGK:h=new Ta(g);m=c.getEntityAuthenticationFactory(ia.MGK);if(!m)throw(new V(a.UNSUPPORTED_KEYX_MECHANISM,y)).setEntity(e);m.getCryptoContext(c,
h);h=new H(void 0);break;case d.WRAP:h=this.repository.getCryptoContext(C);if(!h)throw(new V(a.KEYX_WRAPPING_KEY_MISSING,w(C))).setEntity(e);break;default:throw(new V(a.UNSUPPORTED_KEYX_MECHANISM,y)).setEntity(e);}h.unwrap(f.wrapKey,Za,Qa,{result:function(a){t(e,f,C,g,a)},error:function(a){b(q,function(){a instanceof p&&a.setEntity(e);throw a;})}})},x)},error:q.error})},x)}})})();var Fd,Bc,Gd;(function(){function c(e,g,h,f,m){b(m,function(){switch(g){case d.SESSION:if(!h)throw new V(a.KEYX_MASTER_TOKEN_MISSING,
g);var b=e.getMslStore().getCryptoContext(h);if(b)return b;if(!h.isDecrypted())throw new wa(a.MASTERTOKEN_UNTRUSTED,h);return new na(e,h);case d.PSK:var b=new Ra(f),c=e.getEntityAuthenticationFactory(ga.PSK);if(!c)throw new V(a.UNSUPPORTED_KEYX_KEY_ID,g);return c.getCryptoContext(e,b);case d.MGK:b=new Ta(f);c=e.getEntityAuthenticationFactory(ia.MGK);if(!c)throw new V(a.UNSUPPORTED_KEYX_KEY_ID,g);return c.getCryptoContext(e,b);default:throw new V(a.UNSUPPORTED_KEYX_KEY_ID,g);}})}var d={PSK:"PSK",MGK:"MGK",
SESSION:"SESSION"},e=Bc=fb.extend({init:function n(a){n.base.call(this,qa.SYMMETRIC_WRAPPED);Object.defineProperties(this,{keyId:{value:a,writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.keyid=this.keyId;return a},equals:function I(a){return this===a?!0:a instanceof Bc?I.base.call(this,a)&&this.keyId==a.keyId:!1},uniqueKey:function N(){return N.base.call(this)+":"+this.keyId}}),h=Gd=gb.extend({init:function Y(a,b,c,d){Y.base.call(this,a,qa.SYMMETRIC_WRAPPED);Object.defineProperties(this,
{keyId:{value:b,writable:!1,configurable:!1},encryptionKey:{value:c,writable:!1,configurable:!1},hmacKey:{value:d,writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.keyid=this.keyId;a.encryptionkey=w(this.encryptionKey);a.hmackey=w(this.hmacKey);return a},equals:function fa(a){return this===a?!0:a instanceof Gd?fa.base.call(this,a)&&this.keyId==a.keyId&&f(this.encryptionKey,a.encryptionKey)&&f(this.hmacKey,a.hmacKey):!1},uniqueKey:function U(){return U.base.call(this)+":"+this.keyId+
":"+z(this.encryptionKey)+":"+z(this.hmacKey)}});Fd=ta.extend({init:function B(){B.base.call(this,qa.SYMMETRIC_WRAPPED)},createRequestData:function(c,g,h){b(h,function(){var b=g.keyid;if(!b||"string"!==typeof b)throw new G(a.JSON_PARSE_ERROR,"keydata "+JSON.stringify(g));if(!d[b])throw new V(a.UNIDENTIFIED_KEYX_KEY_ID,b);return new e(b)},this)},createResponseData:function(b,c,e){b=e.keyid;var g=e.encryptionkey,f=e.hmackey;if(!b||"string"!==typeof b||!g||"string"!==typeof g||!f||"string"!==typeof f)throw new G(a.JSON_PARSE_ERROR,
"keydata "+JSON.stringify(e));if(!d[b])throw new V(a.UNIDENTIFIED_KEYX_KEY_ID,b);var m;try{m=K(g)}catch(y){throw new F(a.INVALID_ENCRYPTION_KEY,"keydata "+JSON.stringify(e),y);}var p;try{p=K(f)}catch(t){throw new F(a.INVALID_HMAC_KEY,"keydata "+JSON.stringify(e),t);}return new h(c,b,m,p)},generateResponse:function(d,f,u,r){function y(e,h){b(r,function(){var m,v;if("string"!==typeof u){if(!u.isVerified())throw new wa(a.MASTERTOKEN_UNTRUSTED,u);m=u;v=m.identity}else m=null,v=u;c(d,f.keyId,m,v,{result:function(a){a.wrap(e,
{result:function(c){a.wrap(h,{result:function(a){q(e,c,h,a)},error:function(a){b(r,function(){a instanceof p&&a.setEntity(m);throw a;},t)}})},error:function(a){b(r,function(){a instanceof p&&a.setEntity(m);throw a;},t)}})},error:function(a){b(r,function(){a instanceof p&&a.setEntity(m);throw a;},t)}})},t)}function q(a,c,e,g){b(r,function(){var m=d.getTokenFactory();u instanceof ya?m.renewMasterToken(d,u,a,e,{result:function(a){b(r,function(){var b;try{b=new na(d,a)}catch(e){if(e instanceof wa)throw new E("Master token constructed by token factory is not trusted.",
e);e instanceof p&&e.setEntity(u);throw e;}var m=new h(a,f.keyId,c,g);return new ta.KeyExchangeData(m,b)},t)},error:function(a){b(r,function(){a instanceof p&&a.setEntity(u);throw a;},t)}}):m.createMasterToken(d,u,a,e,{result:function(a){b(r,function(){var b;try{b=new na(d,a)}catch(e){if(e instanceof wa)throw new E("Master token constructed by token factory is not trusted.",e);throw e;}var m=new h(a,f.keyId,c,g);return new ta.KeyExchangeData(m,b)},t)},error:r.error})},t)}var t=this;b(r,function(){if(!(f instanceof
e))throw new E("Key request data "+JSON.stringify(f)+" was not created by this factory.");this.generateSessionKeys(d,{result:function(a){y(a.encryptionKey,a.hmacKey)},error:function(a){b(r,function(){a instanceof p&&u instanceof ya&&a.setEntity(u);throw a;},t)}})},t)},getCryptoContext:function(d,f,u,r,y){function q(a){b(y,function(){a instanceof p&&(a.setEntity(r),a.setEntity(w));throw a;},t)}var t=this,w;b(y,function(){if(!(f instanceof e))throw new E("Key request data "+JSON.stringify(f)+" was not created by this factory.");
if(!(u instanceof h))throw new E("Key response data "+JSON.stringify(u)+" was not created by this factory.");var p=f.keyId,C=u.keyId;if(p!=C)throw(new V(a.KEYX_RESPONSE_REQUEST_MISMATCH,"request "+p+"; response "+C)).setEntity(r);d.getEntityAuthenticationData(null,{result:function(a){b(y,function(){w=a;var e=w.getIdentity();c(d,C,r,e,{result:function(a){a.unwrap(u.encryptionKey,$a,Xa,{result:function(c){a.unwrap(u.hmacKey,ab,Ya,{result:function(a){d.getEntityAuthenticationData(null,{result:function(e){b(y,
function(){var b=e.getIdentity();return new na(d,u.masterToken,b,c,a)},t)},error:q})},error:q})},error:q})},error:q})},t)},error:q})},t)}})})();var Ca;(function(){Ca=function(a){qa.call(this,a)};x.Class.mixin(Ca,{AUTHENTICATED_DH:new Ca("AUTHENTICATED_DH"),WIDEVINE:new Ca("WIDEVINE"),CDM:new Ca("CDM")});Object.freeze(Ca)})();var Hd,Cc,Id;(function(){function c(a,d,e){b(e,function(){Ga(a,{result:function(a){Ga(d,{result:function(b){e.result({encryptionKey:a,hmacKey:b})},error:e.error})},error:e.error})})}
var d=Cc=fb.extend({init:function H(a,b){H.base.call(this,Ca.WIDEVINE);if(!b)throw new E("Key request missing key request data.");Object.defineProperties(this,{baseKey:{value:a,writable:!1,configurable:!1},keyRequest:{value:w(b),writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.keyrequest=this.keyRequest;return a},equals:function n(a){return a===this?!0:a instanceof Cc?n.base.call(this,a)&&this.baseKey===a.baseKey&&this.keyRequest===a.keyRequest:!1},uniqueKey:function I(){return I.base.call(this)+
":"+this.baseKey+":"+this.keyRequest}}),e=Id=gb.extend({init:function N(a,b,c,d){N.base.call(this,a,Ca.WIDEVINE);Object.defineProperties(this,{keyResponse:{value:b,writable:!1,configurable:!1},encryptionKeyId:{value:c,writable:!1,configurable:!1},hmacKeyId:{value:d,writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.cdmkeyresponse=this.keyResponse;a.encryptionkeyid=this.encryptionKeyId;a.hmackeyid=this.hmacKeyId;return a},equals:function Y(a){return this===a?!0:a instanceof Id?Y.base.call(this,
a)&&this.keyResponse===a.keyResponse&&this.encryptionKeyId==a.encryptionKeyId&&this.hmacKeyId==a.hmacKeyId:!1},uniqueKey:function fa(){return fa.base.call(this)+":"+this.keyResponse+":"+this.encryptionKeyId+":"+this.hmacKeyId}});Hd=ta.extend({init:function U(){U.base.call(this,Ca.WIDEVINE)},createRequestData:function(a,b,c){throw new E("WidevineExchange::createRequestData not implemented.");},createResponseData:function(b,c,d){b=d.cdmkeyresponse;var g=d.encryptionkeyid,h=d.hmackeyid;if("string"!==
typeof b||"string"!==typeof g||"string"!==typeof h)throw new G(a.JSON_PARSE_ERROR,"keydata "+JSON.stringify(d));return new e(c,b,g,h)},generateResponse:function(a,b,c,d){throw new E("WidevineExchange::generateResponse not implemented.");},getCryptoContext:function(h,f,t,w,r){function x(d,e,f){b(r,function(){y.deriveKey({name:"NFLX-CDM-WIDEVINE",params:{cdmProvisionResponseData:f.keyResponse,keKeyId:f.encryptionKeyId,khKeyId:f.hmacKeyId}},e.baseKey).then(function(a){c(a.encryptionKey,a.hmacKey,{result:function(a){b(r,
function(){var b=f.masterToken,c=d.getIdentity();return new na(h,b,c,a.encryptionKey,a.hmacKey)},q)},error:function(a){b(r,function(){a instanceof p&&a.setEntity(d);throw a;})}})},function(b){r.error((new F(a.DERIVEKEY_ERROR,"",b)).setEntity(d))})},q)}var q=this;b(r,function(){if(!(f instanceof d))throw new E("Key request data "+JSON.stringify(f)+" was not created by this factory.");if(!(t instanceof e))throw new E("Key response data "+JSON.stringify(t)+" was not created by this factory.");h.getEntityAuthenticationData(null,
{result:function(a){b(r,function(){x(a,f,t)},q)},error:r.error})},q)}})})();var Jd,Dc,Kd;(function(){function c(a,d,e){b(e,function(){Ga(a,{result:function(a){Ga(d,{result:function(b){e.result({encryptionKey:a,hmacKey:b})},error:e.error})},error:e.error})})}var d=Dc=fb.extend({init:function H(a,b,c){H.base.call(this,Ca.CDM);if(!c)throw new E("Key request missing key request data.");Object.defineProperties(this,{mechanism:{value:a,writable:!1,configurable:!1},baseKey:{value:b,writable:!1,configurable:!1},
keyRequest:{value:w(c),writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.mechanism=this.mechanism;a.keyrequest=this.keyRequest;return a},equals:function n(a){return a===this?!0:a instanceof Dc?n.base.call(this,a)&&this.baseKey===a.baseKey&&this.mechanism===a.mechanism&&this.keyRequest===a.keyRequest:!1},uniqueKey:function I(){return I.base.call(this)+":"+this.baseKey+":"+this.mechanism+":"+this.keyRequest}}),e=Kd=gb.extend({init:function N(a,b,c,d){N.base.call(this,a,Ca.CDM);Object.defineProperties(this,
{keyResponse:{value:b,writable:!1,configurable:!1},encryptionKeyId:{value:c,writable:!1,configurable:!1},hmacKeyId:{value:d,writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.cdmkeyresponse=this.keyResponse;a.encryptionkeyid=this.encryptionKeyId;a.hmackeyid=this.hmacKeyId;return a},equals:function Y(a){return this===a?!0:a instanceof Kd?Y.base.call(this,a)&&this.keyResponse===a.keyResponse&&this.encryptionKeyId==a.encryptionKeyId&&this.hmacKeyId==a.hmacKeyId:!1},uniqueKey:function fa(){return fa.base.call(this)+
":"+this.keyResponse+":"+this.encryptionKeyId+":"+this.hmacKeyId}});Jd=ta.extend({init:function U(){U.base.call(this,Ca.CDM)},createRequestData:function(a,b,c){throw new E("CdmExchange::createRequestData not implemented.");},createResponseData:function(b,c,d){b=d.cdmkeyresponse;var g=d.encryptionkeyid,h=d.hmackeyid;if("string"!==typeof b||"string"!==typeof g||"string"!==typeof h)throw new G(a.JSON_PARSE_ERROR,"keydata "+JSON.stringify(d));return new e(c,b,g,h)},generateResponse:function(a,b,c,d){throw new E("CdmExchange::generateResponse not implemented.");
},getCryptoContext:function(h,f,t,w,r){function x(d,e,f){b(r,function(){y.deriveKey({name:"NFLX-CDM-JWELE",params:{cdmProvisionResponseData:f.keyResponse,keKeyId:f.encryptionKeyId,khKeyId:f.hmacKeyId}},e.baseKey).then(function(a){c(a.encryptionKey,a.hmacKey,{result:function(a){b(r,function(){var b=f.masterToken,c=d.getIdentity();return new na(h,b,c,a.encryptionKey,a.hmacKey)},q)},error:function(a){b(r,function(){a instanceof p&&a.setEntity(d);throw a;})}})},function(b){r.error((new F(a.DERIVEKEY_ERROR,
"",b)).setEntity(d))})},q)}var q=this;b(r,function(){if(!(f instanceof d))throw new E("Key request data "+JSON.stringify(f)+" was not created by this factory.");if(!(t instanceof e))throw new E("Key response data "+JSON.stringify(t)+" was not created by this factory.");h.getEntityAuthenticationData(null,{result:function(a){b(r,function(){x(a,f,t)},q)},error:r.error})},q)}})})();var Fb,Ld,$b,Ec,Lb,Fc;(function(){function c(a,b){return"<"+a+">"+b+"</"+a+">"}function e(a){return a.replace(/[<>&"']/g,
function(a){return z[a]})}function h(a){return encodeURIComponent(a).replace("%20","+").replace(/[!'()]/g,escape).replace(/\*/g,"%2A")}var v=$b={MSL:"MSL",NTBA:"NTBA",MSL_LEGACY:"MSL_LEGACY"},y=x.Class.create({getAction:function(){},getNonce:function(){},getPin:function(){},getSignature:function(){},getEncoding:function(){},equals:function(){}}),n=Ec=y.extend({init:function(c,d,e,g,h,f,m){function n(g){b(m,function(){var b;try{var f={};f.useridtoken=c;f.action=d;f.nonce=e;f.pin=w(g);b=Z(JSON.stringify(f),
W)}catch(n){throw new G(a.JSON_ENCODE_ERROR,"MSL-based MDX authdata",n);}h.sign(b,{result:function(a){u(b,a)},error:m.error})},C)}function u(a,h){b(m,function(){Object.defineProperties(this,{_userIdToken:{value:c,writable:!1,enumerable:!1,configurable:!1},_action:{value:d,writable:!1,enumerable:!1,configurable:!1},_nonce:{value:e,writable:!1,enumerable:!1,configurable:!1},_pin:{value:g,writable:!1,enumerable:!1,configurable:!1},_encoding:{value:a,writable:!1,enumerable:!1,configurable:!1},_signature:{value:h,
writable:!1,enumerable:!1,configurable:!1}});return this},C)}var C=this;b(m,function(){f?u(f.encoding,f.signature):h.encrypt(Z(g,W),{result:function(a){n(a)},error:m.error})},C)},getUserIdToken:function(){return this._userIdToken},getAction:function(){return this._action},getNonce:function(){return this._nonce},getPin:function(){return this._pin},getSignature:function(){return this._signature},getEncoding:function(){return this._encoding},equals:function(a){return this===a?!0:a instanceof n?this._action==
a._action&&this._nonce==a._nonce&&this._pin==a._pin&&this._userIdToken.equals(a._userIdToken):!1}});Ec.ACTION="userauth";var t=function(c,e,g,h,f){function m(h){b(f,function(){var m=ca(g,W),n,q,r,v;try{var y=JSON.parse(m);n=y.useridtoken;q=y.action;r=y.nonce;v=y.pin}catch(t){if(t instanceof SyntaxError)throw new G(a.JSON_PARSE_ERROR,"MDX authdata "+m,t);throw t;}if(!(n&&"object"===typeof n&&q&&"string"===typeof q&&r&&"number"===typeof r&&v)||"string"!==typeof v)throw new G(a.JSON_PARSE_ERROR,"MDX authdata "+
m);sb(c,n,e,{result:function(c){b(f,function(){if(!c.isDecrypted())throw new d(a.USERAUTH_USERIDTOKEN_NOT_DECRYPTED,"MDX authdata "+m);u(h,c,q,r,v)})},error:function(c){b(f,function(){if(c instanceof p)throw new d(a.USERAUTH_USERIDTOKEN_INVALID,"MDX authdata "+m,c);throw c;})}})})}function u(a,c,d,e,m){b(f,function(){var q=K(m);a.decrypt(q,{result:function(a){b(f,function(){var b=ca(a,W);new n(c,d,e,b,null,{encoding:g,signature:h},f)})},error:f.error})})}b(f,function(){var n;try{var u=c.getMslStore().getCryptoContext(e);
n=u?u:new na(c,e)}catch(v){if(v instanceof wa)throw new d(a.USERAUTH_MASTERTOKEN_NOT_DECRYPTED,"MDX authdata "+w(g));throw v;}n.verify(g,h,{result:function(a){b(f,function(){if(!a)throw new F(J.MDX_USERAUTH_VERIFICATION_FAILED,"MDX authdata "+w(g));m(n)})},error:f.error})})},z={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&apos;"},A=Lb=y.extend({init:function(a,b,d,h){var f=c("action",e(a)),m=c("nonce",b.toString());d=c("pin",d);f=c("registerdata",f+m+d);f=Z(f,"utf-8");Object.defineProperties(this,
{_action:{value:a,writable:!1,enumerable:!1,configurable:!1},_nonce:{value:b,writable:!1,enumerable:!1,configurable:!1},_pin:{value:null,writable:!1,enumerable:!1,configurable:!1},_encoding:{value:f,writable:!1,enumerable:!1,configurable:!1},_signature:{value:h,writable:!1,enumerable:!1,configurable:!1}})},getAction:function(){return this._action},getNonce:function(){return this._nonce},getPin:function(){return this._pin},getSignature:function(){return this._signature},getEncoding:function(){return this._encoding},
equals:function(a){return this===a?!0:a instanceof A?this._action==a._action&&this._nonce==a._nonce&&this._pin==a._pin:!1}});Lb.ACTION="regpairrequest";var D=Fc=y.extend({init:function(a,d,f,n,v,q){function y(f){b(q,function(){var b=w(f),v=c("action",e(a)),y=c("nonce",d.toString()),t=c("pin",b),v=c("registerdata",v+y+t),x=Z(v,"utf-8"),b="action="+h(a)+"&nonce="+h(d.toString())+"&pin="+h(b);n.sign(Z(b,"utf-8"),{result:function(a){p(x,a)},error:q.error})},t)}function p(c,e){b(q,function(){Object.defineProperties(this,
{_action:{value:a,writable:!1,enumerable:!1,configurable:!1},_nonce:{value:d,writable:!1,enumerable:!1,configurable:!1},_pin:{value:f,writable:!1,enumerable:!1,configurable:!1},_encoding:{value:c,writable:!1,enumerable:!1,configurable:!1},_signature:{value:e,writable:!1,enumerable:!1,configurable:!1}});return this},t)}var t=this;b(q,function(){v?p(v.encoding,v.signature):n.encrypt(Z(f,"utf-8"),{result:function(a){y(a)},error:q.error})},t)},getAction:function(){return this._action},getNonce:function(){return this._nonce},
getPin:function(){return this._pin},getSignature:function(){return this._signature},getEncoding:function(){return this._encoding},equals:function(a){return this===a?!0:a instanceof D?this._action==a._action&&this._nonce==a._nonce&&this._pin==a._pin:!1}});Fc.ACTION=Lb.ACTION;var sa=function(a,c,d,e,g){b(g,function(){var f=a.getMslStore().getCryptoContext(c),n=f?f:new na(a,c),f=ca(d,"utf-8"),u=(new DOMParser).parseFromString(f,"application/xml"),f=u.getElementsByTagName("action"),v=u.getElementsByTagName("nonce"),
u=u.getElementsByTagName("pin"),y=f&&1==f.length&&f[0].firstChild?f[0].firstChild.nodeValue:null,p=v&&1==v.length&&v[0].firstChild?parseInt(v[0].firstChild.nodeValue):null,t=u&&1==u.length&&u[0].firstChild?u[0].firstChild.nodeValue:null;if(!y||!p||!t)throw new G(J.XML_PARSE_ERROR,"MDX authdata "+w(d));f="action="+h(y)+"&nonce="+h(p.toString())+"&pin="+h(t);n.verify(Z(f,"utf-8"),e,{result:function(a){b(g,function(){if(!a)throw new F(J.MDX_USERAUTH_VERIFICATION_FAILED,"MDX authdata "+w(d));var c=K(t);
n.decrypt(c,{result:function(a){b(g,function(){var b=ca(a,"utf-8");new D(y,p,b,null,{encoding:d,signature:e},g)})},error:g.error})})},error:g.error})})};Fb=kb.extend({init:function P(a,b,c,d,e,g){P.base.call(this,Da.MDX);var h=null,f=null,m=null;if("string"===typeof c)a=v.MSL_LEGACY,m=c;else if(c instanceof Uint8Array)a=v.NTBA,f=c;else if(c instanceof ya)a=v.MSL,h=c;else throw new TypeError("Controller token "+c+" is not a master token, encrypted CTicket, or MSL token construct.");var u=c=null,y=
null,p=null;if(g){var t=g.controllerAuthData;c=t.getAction();u=t.getPin();y=g.userIdToken;t instanceof n?p=t.getUserIdToken().user:y&&(p=y.user)}Object.defineProperties(this,{mechanism:{value:a,writable:!1,configurable:!1},action:{value:c,writable:!1,configurable:!1},targetPin:{value:b,writable:!1,configurable:!1},controllerPin:{value:u,writable:!1,configurable:!1},user:{value:p,writable:!1,configurable:!1},_masterToken:{value:h,writable:!1,enumerable:!1,configurable:!1},_encryptedCTicket:{value:f,
writable:!1,enumerable:!1,configurable:!1},_mslTokens:{value:m,writable:!1,enumerable:!1,configurable:!1},_controllerEncoding:{value:d,writable:!1,enumerable:!1,configurable:!1},_signature:{value:e,writable:!1,enumerable:!1,configurable:!1}})},getAuthData:function(){var a={};switch(this.mechanism){case v.MSL:var b=JSON.parse(JSON.stringify(this._masterToken));a.mastertoken=b;break;case v.NTBA:b=ca(this._encryptedCTicket,"utf-8");a.cticket=b;break;case v.MSL_LEGACY:a.cticket=this._mslTokens;break;
default:throw new E("Unsupported MDX mechanism.");}a.pin=this.targetPin;a.mdxauthdata=w(this._controllerEncoding);a.signature=w(this._signature);return a},equals:function M(a){return this===a?!0:a instanceof Fb?M.base.call(this,a)&&(this._masterToken==a._masterToken||this._masterToken&&this._masterToken.equals(a._masterToken))&&(this._encryptedCTicket==a._encryptedCTicket||this._encryptedCTicket&&f(this._encryptedCTicket,a._encryptedCTicket))&&this._mslTokens==a._mslTokens&&f(this._controllerEncoding,
a._controllerEncoding)&&f(this._signature,a._signature):!1}});Ld=function(c,e,g){function h(f,m,n,q){pb(c,m,{result:function(h){b(g,function(){if(!h.isDecrypted())throw new d(a.USERAUTH_MASTERTOKEN_NOT_DECRYPTED,"MDX authdata "+e.toString());t(c,h,n,q,{result:function(a){b(g,function(){var b=a.getEncoding(),d=a.getSignature();return new Fb(c,f,h,b,d,{controllerAuthData:a,userIdToken:null})})},error:g.error})})},error:function(c){b(g,function(){if(c instanceof p)throw new d(a.USERAUTH_MASTERTOKEN_INVALID,
"MDX authdata "+JSON.stringify(e),c);throw c;})}})}function f(c,e,h,m){b(g,function(){throw new d(a.UNSUPPORTED_USERAUTH_MECHANISM,"NtbaControllerData$parse");})}function m(h,f,n,q){function u(g,h){b(h,function(){var f;try{f=K(g)}catch(m){throw new d(a.USERAUTH_MASTERTOKEN_INVALID,"MDX authdata "+JSON.stringify(e),m);}if(!f||0==f.length)throw new d(a.USERAUTH_MASTERTOKEN_MISSING,"MDX authdata "+JSON.stringify(e));try{var n=JSON.parse(ca(f,"utf-8"));pb(c,n,{result:function(c){b(h,function(){if(!c.isDecrypted())throw new d(a.USERAUTH_MASTERTOKEN_NOT_DECRYPTED,
"MDX authdata "+e.toString());return c})},error:function(c){b(h,function(){if(c instanceof p)throw new d(a.USERAUTH_MASTERTOKEN_INVALID,"MDX authdata "+JSON.stringify(e),c);throw c;})}})}catch(q){if(q instanceof SyntaxError)throw new G(a.JSON_PARSE_ERROR,"MDX authdata "+JSON.stringify(e),q);throw q;}})}function v(g,h,f){b(f,function(){var m;try{m=K(g)}catch(n){throw new d(a.USERAUTH_USERIDTOKEN_INVALID,"MDX authdata "+JSON.stringify(e),n);}if(!m||0==m.length)throw new d(a.USERAUTH_USERIDTOKEN_MISSING,
"MDX authdata "+JSON.stringify(e));try{var q=JSON.parse(ca(m,"utf-8"));sb(c,q,h,{result:function(c){b(f,function(){if(!c.isDecrypted())throw new d(a.USERAUTH_USERIDTOKEN_NOT_DECRYPTED,"MDX authdata "+JSON.stringify(e));return c})},error:function(c){b(f,function(){if(c instanceof p)throw new d(a.USERAUTH_USERIDTOKEN_INVALID,"MDX authdata "+JSON.stringify(e),c);throw c;})}})}catch(u){if(u instanceof SyntaxError)throw new G(a.JSON_PARSE_ERROR,"MDX authdata "+JSON.stringify(e),u);throw u;}})}b(g,function(){var m=
f.split(",");if(3!=m.length||"1"!=m[0])throw new d(a.UNIDENTIFIED_USERAUTH_MECHANISM,"MDX authdata "+JSON.stringify(e));u(m[1],{result:function(u){v(m[2],u,{result:function(m){sa(c,u,n,q,{result:function(a){b(g,function(){return new Fb(c,h,f,n,q,{controllerAuthData:a,userIdToken:m})})},error:function(c){b(g,function(){if(c instanceof wa)throw new d(a.USERAUTH_MASTERTOKEN_NOT_DECRYPTED,"MDX authdata "+JSON.stringify(e),c);throw c;})}})},error:g.error})},error:g.error})})}b(g,function(){var b=e.pin,
c=e.mdxauthdata,g=e.signature;if(!b||"string"!==typeof b||!c||"string"!==typeof c||!g||"string"!==typeof g)throw new G(a.JSON_PARSE_ERROR,"MDX authdata "+JSON.stringify(e));var n,u;try{n=K(c),u=K(g)}catch(v){throw new d(J.MDX_CONTROLLERDATA_INVALID,"MDX authdata "+JSON.stringify(e),v);}if(e.mastertoken){c=e.mastertoken;if(!c||"object"!==typeof c)throw new G(a.JSON_PARSE_ERROR,"MDX authdata "+JSON.stringify(e));h(b,c,n,u)}else if(e.cticket){c=e.cticket;if(!c||"string"!==typeof c)throw new G(a.JSON_PARSE_ERROR,
"MDX authdata "+JSON.stringify(e));-1==c.indexOf(",")?f(b,c,n,u):m(b,c,n,u)}else throw new d(a.UNIDENTIFIED_USERAUTH_MECHANISM,"MDX authdata "+JSON.stringify(e));})}})();(function(){var b=Ec.ACTION,c=Lb.ACTION,e=Fc.ACTION;Jb.extend({init:function H(){H.base.call(this,Da.MDX)},createData:function(a,b,c,d){Ld(a,c,d)},authenticate:function(h,f,y,p){if(!(y instanceof Fb))throw new E("Incorrect authentication data type "+y.getClass().getName()+".");h=y.action;switch(y.mechanism){case $b.MSL:if(b!=h)throw(new d(J.MDX_USERAUTH_ACTION_INVALID)).setUser(y);
break;case $b.NTBA:if(c!=h)throw(new d(J.MDX_USERAUTH_ACTION_INVALID)).setUser(y);break;case $b.MSL_LEGACY:if(e!=h)throw(new d(J.MDX_USERAUTH_ACTION_INVALID)).setUser(y);}h=y.controllerPin;f=y.targetPin;if(!h||!f)throw(new d(J.MDX_PIN_BLANK)).setUser(y);if(h!=f)throw(new d(J.MDX_PIN_MISMATCH)).setUser(y);h=y.user;if(!h)throw(new d(J.MDX_USER_UNKNOWN)).setUser(y);if(p&&(p=p.user,!h.equals(p)))throw(new d(a.USERIDTOKEN_USERAUTH_DATA_MISMATCH,"uad user "+h+"; uit user "+p)).setUser(y);return h}})})();
var Mb,Md;(function(){Mb=kb.extend({init:function u(a,b){u.base.call(this,Da.NETFLIXID);Object.defineProperties(this,{netflixId:{value:a,writable:!1,configurable:!1},secureNetflixId:{value:b,writable:!1,configurable:!1}})},getAuthData:function(){var a={};a.netflixid=this.netflixId;this.secureNetflixId&&(a.securenetflixid=this.secureNetflixId);return a},equals:function m(a){return this===a?!0:a instanceof Mb?m.base.call(this,a)&&this.netflixId==a.netflixId&&this.secureNetflixId==a.secureNetflixId:
!1}});Md=function(b){var c=b.netflixid,d=b.securenetflixid;if(!c)throw new G(a.JSON_PARSE_ERROR,"NetflixId authdata "+JSON.stringify(b));return new Mb(c,d)}})();Jb.extend({init:function u(){u.base.call(this,Da.NETFLIXID)},createData:function(a,c,d,e){b(e,function(){return Md(d)})},authenticate:function(b,c,e,h){if(!(e instanceof Mb))throw new E("Incorrect authentication data type "+e+".");b=e.secureNetflixId;if(!e.netflixId||!b)throw(new d(J.NETFLIXID_COOKIES_BLANK)).setUser(e);throw(new d(a.UNSUPPORTED_USERAUTH_DATA,
this.scheme)).setUser(e);}});var Da;(function(){Da=function(a){wb.call(this,a)};x.Class.mixin(Da,{NETFLIXID:new Da("NETFLIXID"),SSO:new Da("SSO"),SWITCH_PROFILE:new Da("SWITCH_PROFILE"),MDX:new Da("MDX")});Object.freeze(Da)})();var Nb,Nd,Gc,Od,Pd;(function(){var b=Gc={MICROSOFT_SAML:"MICROSOFT_SAML",SAMSUNG:"SAMSUNG",MICROSOFT_JWT:"MICROSOFT_JWT"},c=Od=x.Class.create({init:function(a,b){Object.defineProperties(this,{email:{value:a,writable:!1,enumerable:!0,configurable:!1},password:{value:b,writable:!1,
enumerable:!0,configurable:!1}})}}),e=Pd=x.Class.create({init:function(a,b){Object.defineProperties(this,{netflixId:{value:a,writable:!1,enumerable:!0,configurable:!1},secureNetflixId:{value:b,writable:!1,enumerable:!0,configurable:!1}})}});Nb=kb.extend({init:function n(a,b,d){n.base.call(this,Da.SSO);var h=null,f=null,u=null,y=null;d instanceof c?(h=d.email,f=d.password):d instanceof e&&(u=d.netflixId,y=d.secureNetflixId);Object.defineProperties(this,{mechanism:{value:a,writable:!1,configurable:!1},
token:{value:b,writable:!1,configurable:!1},email:{value:h,writable:!1,configurable:!1},password:{value:f,writable:!1,configurable:!1},netflixId:{value:u,writable:!1,configurable:!1},secureNetflixId:{value:y,writable:!1,configurable:!1}})},getAuthData:function(){var a={};a.mechanism=this.mechanism;a.token=w(this.token);this.email&&this.password?(a.email=this.email,a.password=this.password):this.netflixId&&this.secureNetflixId&&(a.netflixid=this.netflixId,a.securenetflixid=this.secureNetflixId);return a},
equals:function I(a){return this===a?!0:a instanceof Nb?I.base.call(this,a)&&this.mechanism==a.mechanism&&f(this.token,a.token)&&this.email==a.email&&this.password==a.password&&this.netflixId==a.netflixId&&this.secureNetflixId==a.secureNetflixId:!1}});Nd=function(h){var f=h.mechanism,y=h.token;if(!f||!y||"string"!==typeof y)throw new G(a.JSON_PARSE_ERROR,"SSO authdata "+JSON.stringify(h));if(!b[f])throw new d(a.UNIDENTIFIED_USERAUTH_MECHANISM,"SSO authdata "+JSON.stringify(h));var p=h.email,t=h.password,
w=h.netflixid,x=h.securenetflixid;if(p&&!t||!p&&t||w&&!x||!w&&x||p&&w)throw new G(a.JSON_PARSE_ERROR,"SSO authdata "+JSON.stringify(h));var z;try{z=K(y)}catch(r){throw new d(J.SSOTOKEN_INVALID,"SSO authdata "+JSON.stringify(h),r);}var E;p&&t?E=new c(p,t):w&&x&&(E=new e(w,x));return new Nb(f,z,E)}})();Jb.extend({init:function m(){m.base.call(this,Da.SSO)},createData:function(a,c,d,e){b(e,function(){return Nd(d)})},authenticate:function(b,c,e,h){if(!(e instanceof Nb))throw new E("Incorrect authentication data type "+
e+".");b=e.token;c=e.email;h=e.password;var f=e.netflixId,y=e.secureNetflixId;if(!b||0==b.length)throw new d(J.SSOTOKEN_BLANK);if(!(null===c&&null===h||c&&h))throw new d(a.EMAILPASSWORD_BLANK);if(!(null===f&&null===y||f&&y))throw(new d(J.NETFLIXID_COOKIES_BLANK)).setUser(e);throw(new d(a.UNSUPPORTED_USERAUTH_DATA,this.scheme)).setUser(e);}});var ac,Qd;(function(){ac=kb.extend({init:function v(a,b){v.base.call(this,Da.SWITCH_PROFILE);Object.defineProperties(this,{userIdToken:{value:a,writable:!1,configurable:!1},
profileGuid:{value:b,writable:!1,configurable:!1}})},getAuthData:function(){var a={};a.useridtoken=JSON.parse(JSON.stringify(this.userIdToken));a.profileguid=this.profileGuid;return a},equals:function H(a){return this==a?!0:a instanceof ac?H.base.call(this,a)&&this.userIdToken.equals(a.userIdToken)&&this.profileGuid==a.profileGuid:!1}});Qd=function(c,e,h,f){b(f,function(){if(!e)throw new d(a.USERAUTH_MASTERTOKEN_MISSING);var y=h.useridtoken,p=h.profileguid;if("object"!==typeof y||"string"!==typeof p)throw new G(a.JSON_PARSE_ERROR,
"switch profile authdata "+JSON.stringify(h));sb(c,y,e,{result:function(c){b(f,function(){if(!c.isDecrypted())throw new d(a.USERAUTH_USERIDTOKEN_NOT_DECRYPTED,"switch profile authdata "+JSON.stringify(h));return new ac(c,p)})},error:function(b){f.error(new d(a.USERAUTH_USERIDTOKEN_INVALID,"switch profile authdata "+JSON.stringify(h),b))}})})}})();Jb.extend({init:function v(){v.base.call(this,Da.SWITCH_PROFILE)},createData:function(a,b,c,d){Qd(a,b,c,d)},authenticate:function(b,c,e,h){if(!(e instanceof
ac))throw new E("Incorrect authentication data type "+e+".");b=e.userIdToken;if(!e.profileGuid)throw(new d(J.PROFILEGUID_BLANK)).setUser(e);if(h&&!h.equals(b))throw(new d(a.USERAUTH_USERIDTOKEN_INVALID)).setUser(e);if(!b.user)throw(new d(a.USERAUTH_USERIDTOKEN_NOT_DECRYPTED)).setUser(e);throw(new d(a.UNSUPPORTED_USERAUTH_DATA,this.scheme)).setUser(e);}});ua.prototype=Error();ua.prototype.constructor=ua;var xb;(function(){function b(a,c,d){for(var e=0,h=c?c.length:0;void 0!==a&&e<h;)a=a[c[e++]];return void 0===
a?d:a}function d(a){return new G(function(b,c){a.oncomplete=b;a.onerror=function(a){c(a.error)}})}function e(a){var b=this;this.promise=new G(function(c,d){b.result=aa.isUndefined(a)?c:function(b){c([b,a])};b.error=d;b.timeout=function(){d(new ua)}})}function h(a){if(a instanceof ua)return 1;if(a instanceof ha)return 2;if(a instanceof p&&a.error)switch(a.error.responseCode){case c.TRANSIENT_FAILURE:return 2;case c.USERDATA_REAUTH:return a.error.internalCode==J.NETFLIXID_COOKIES_EXPIRED.internalCode?
12:8;case c.SSOTOKEN_REJECTED:return 10}return 1}function f(a){return a?""+a.sequenceNumber+":"+a.serialNumber+":"+a.expiration.toISOString()+":"+a.renewalWindow.toISOString():"null"}function y(a){return a?""+a.serialNumber+":"+a.mtSerialNumber+":"+a.expiration.toISOString()+":"+a.renewalWindow.toISOString():"null"}function t(){return G.attempt(function(){q.info("Generating AsymmetricWrappedExchange RSA keys");var a={name:"RSA-OAEP",params:{modulusLength:1024,publicExponent:new Uint8Array([1,0,1])}};
return d(da.generateKey(a,!0))}).then(function(a){var b=new e,c=new e;zb(a.target.result.privateKey,b);nb(a.target.result.publicKey,c);return[b.promise,c.promise]}).spread(function(a,b){var c="RKPI"+Math.floor(nrdp.now()/1E3)+Math.floor(1E8*Math.random());return new pc(c,Wc.JWE_RSA,b,a)})}function x(){return G.attempt(function(){q.info("Generating Widevine CDM key");return d(da.generateKey({name:"NFLX-CDM-WIDEVINE"},!0))}).then(function(a){var b=a.target.result;q.log("Exporting CDM key request data");
return d(da.exportKey("raw",b)).then(function(a){return new Cc(b,a.target.result)})})}function z(){return G.attempt(function(){q.info("Generating Widevine CDM JWE key");return d(da.generateKey({name:"NFLX-CDM-JWELE"},!0))}).then(function(a){var b=a.target.result;q.log("Exporting CDM JWE key request data");return d(da.exportKey("raw",b)).then(function(a){return new Dc("JWELE",b,a.target.result)})})}function A(a,b){var c,h;switch(b){case ia.MGK:c=ve;h=Ta;break;case ga.PSK:c=Oc;h=Ra;break;default:q.error("Invalid entity authentication scheme :",
b);return}return G.attempt(function(){return["DKE","DKH","DKW"].map(function(a){return d(da.getKeyByName(a))})}).all().then(function(a){return a.map(function(a){var b;a=a.target.result;if(aa.isNull(a))throw Error("Failed to get device key by name");b=new e;Ga(a,b);return b.promise})}).spread(function(d,e,f){var n=c.extend({init:function Ja(a,b,c,d){Ja.base.call(this,a);Object.defineProperties(this,{_ke:{value:b,writable:!1,enumerable:!1,configurable:!1},_kh:{value:c,writable:!1,enumerable:!1,configurable:!1},
_kw:{value:d,writable:!1,enumerable:!1,configurable:!1}})},getCryptoContext:function La(a,b){return b instanceof h&&this.localIdentity==b.identity?new Ub(a,this.localIdentity,this._ke,this._kh,this._kw):La.base.call(this,a,b)}});q.info("Created",b.name,"entity auth factory");a._entityAuthFactories[b.name]=new n(a._deviceIdentity,d,e,f);a._entityAuthData=new h(a._deviceIdentity);return[d,e,f]})}function F(a,b,c,d){var e;switch(c){case ia.MGK:case ga.PSK:break;default:q.error("Invalid entity authentication scheme :",
c);return}if(a.swex)q.info("Using symmetric wrapped exchange"),b._keyRequestDataFactory=function(){return G.attempt(function(){return new Bc(c.name)})},b._keyExchangeFactories.push(new Fd);else if(a.awex)q.info("Using asymmetric wrapped exchange (JWE_RSA)"),b._keyExchangeFactories.push(new Gb),b._keyRequestDataFactory=t;else if(nrdp.webcrypto.nflxDhDerive){q.info("Using ADH exchange");switch(c){case ia.MGK:e=xc.MGK;break;case ga.PSK:e=xc.PSK}b._keyExchangeFactories.push(b._makeADHExchange(d));b._keyRequestDataFactory=
function(){return b._generateADHExchangeRequestData(e,d.rawKey)}}else{q.info("Using JWE ladder exchange");a=Cd.extend({init:function Ka(){Ka.base.call(this);Object.defineProperties(this,{_contextMap:{value:{},writable:!1,enumerable:!1,configurable:!1}})},addCryptoContext:function(a,b){b&&a&&a.length&&(this._contextMap[w(a)]=b)},getCryptoContext:function(a){return a&&a.length?this._contextMap[w(a)]||null:null},removeCryptoContext:function(a){a&&a.length&&delete this._contextMap[w(a)]}});switch(c){case ia.MGK:e=
zc.MGK;break;case ga.PSK:e=zc.PSK}b._keyExchangeFactories.push(new Ad(new a));b._keyRequestDataFactory=function(){return G.attempt(function(){return new Ac(e)})}}}function r(a){return d(da.getKeyByName("WIIU-ECC")).then(function(b){var c;b=b.target.result;if(aa.isNull(b))throw Error("Failed to find named key WIIU-ECC");q.log("Got","WIIU-ECC","key");c=b.algorithm.certificate;if(!aa.isString(c))throw Error("WIIU-ECC key missing 'certificate'");if(!c.length)throw Error("WIIU-ECC key has empty 'certificate'");
a._entityAuthData=new Wb(a._deviceIdentity,null,c);return b}).then(function(b){var c=ga.X509,d=Bb.extend({init:function mb(a){mb.base.call(this,c);Object.defineProperties(this,{_eccKey:{value:a,writable:!1,enumerable:!1,configurable:!1}})},getCryptoContext:function(a,b){if(!(b instanceof Wb))throw new E("Incorrect authentication data type "+JSON.stringify(b)+".");return new Ic(a,this._eccKey)}});a._entityAuthFactories[c.name]=new d(b)}).then(function(){q.info("Using asymmetric wrapped exchange (JWE_RSA)");
a._keyExchangeFactories.push(new Gb);a._keyRequestDataFactory=t})}function sa(w){function E(a,b,c,d,e){var h=[];c&&(h=c.slice(0));d&&(c=d.getMslStore(),d=c.getMasterToken())&&(h=h.concat(c.getServiceTokens(d,null)),e&&(e=e.getUserId())&&(e=c.getUserIdToken(e))&&(h=h.concat(c.getServiceTokens(d,e))));0===h.length?q.trace("No "+a+" service tokens for request ("+b.n+")"):h.forEach(function(c,d){c?(q.trace(a+" service token "+d+" for request ("+b.n+") : "+c.name),q.dump(c.toJSON())):q.error("st is undefined, wtf.")})}
var D=!1,J=!1,R=!1,T=1,V=nrdp.device.setRegistered||function(){},Xa=td.extend({init:function ge(a,b){ge.base.call(this);this._deviceIdentity=a;this._eventEmitter=b},_hasUserIdTokens:function(){return!!Object.keys(this.userIdTokens).length},_emit:function(a,b){this._eventEmitter&&this._eventEmitter.emit(a,b)},setCryptoContext:function ie(a,b){function c(a){return a?a.sequenceNumber+":"+a.serialNumber+":"+a.expiration.getTime():"<null>"}var d=this.getMasterToken();ie.base.call(this,a,b);this.markDirty("setCryptoContext ["+
c(d)+" TO "+c(a)+"]");this._emit("setCryptoContext",{masterToken:a,cryptoContext:b})},removeCryptoContext:function je(a){je.base.call(this,a);this.markDirty("removeCryptoContext");this._emit("removeCryptoContext",{masterToken:a})},clearCryptoContexts:function ke(){ke.base.call(this);this.markDirty("clearCryptoContexts");this._emit("clearCryptoContexts")},addUserIdToken:function le(a,b){le.base.call(this,a,b);this.markDirty("addUserIdToken");this._emit("addUserIdToken",{userId:a,userIdToken:b})},removeUserIdToken:function me(a){me.base.call(this,
a);this.markDirty("removeUserIdToken");this._emit("removeUserIdToken",{userIdToken:a})},clearUserIdTokens:function he(){he.base.call(this);this.markDirty("clearUserIdTokens");this._emit("clearUserIdTokens")},addServiceTokens:function ne(a){var b={"streaming.servicetokens.movie":!0,"streaming.servicetokens.license":!0};a=a.filter(function(a){return a&&!b[a.name]});0<a.length&&(ne.base.call(this,a),this.markDirty("addServiceTokens"),this._emit("addServiceTokens",{tokens:a}))},removeServiceTokens:function oe(a,
b,c){oe.base.call(this,a,b,c);this.markDirty("removeServiceTokens");this._emit("removeServiceTokens",{name:a,masterToken:b,userIdToken:c})},clearServiceTokens:function pe(){pe.base.call(this);this.markDirty("clearServiceTokens");this._emit("clearServiceTokens")},setNpTicket:function(a){if(a)this._npTicketWCKey=a;else{if(!this._npTicketWCKey)return;delete this._npTicketWCKey}this.markDirty("setNpTicket")},getNpTicket:function(){return this._npTicketWCKey},markDirty:function(a){this._loading||(q.log("MslStore dirty ("+
a+")"),this._dirty=!0)},load:function(a){var b=this,c,h;return G.attempt(function(){c=nrdp.storage.getItem(nrdp.storage.NO_DEVICE_ACCOUNT,"mslstore");q.log("Attempting to load MslStore");if(c)if(h=JSON.parse(c),q.log("Loaded MslStore"),R&&q.dump(h),h.di!==b._deviceIdentity)q.warn("MslStore is for a different device: "+h.di),nrdp.storage.removeItem(nrdp.storage.NO_DEVICE_ACCOUNT,"mslstore");else return G.attempt(function(){var c=h.mt,d;b._loading=!0;if(!c)throw Error("No master token found");d=new e;
pb(a,c,d);return d.promise}).then(function(c){switch(h.cc){case "symmetric":return G.resolve([h.ek,h.hk].map(function(a){return d(da.getKeyInfo(a))})).all().then(function(a){return a.map(function(a){var b=new e;Ga(a.target.result,b);return b.promise})}).all().spread(function(d,e){var h=new na(a,c,b._deviceIdentity,d,e);b.setCryptoContext(c,h)}).thenResolve(c);default:throw Error("Unable to load crypto context");}}).then(function(c){var d=h.uit;if(d)return q.log("Parsing user id tokens"),G.attempt(function(){return d.map(function(b){var d=
new e({id:b.id,st:b.st});sb(a,b.t,c,d);return d.promise})}).all().then(function(d){var h=[];d.forEach(function(d){var f=d[0],y=d[1].st;b.addUserIdToken(d[1].id,f);aa.isArray(y)&&y.forEach(function(b){var d=new e;Xb(a,b,c,f,null,d);h.push(d.promise.fail(function(a){q.warn("Failed to parse service token from store");return null}))})});return h}).all().then(function(a){a.forEach(function(a){if(a)try{b.addServiceTokens([a]),q.log("Added service token "+a.name)}catch(c){q.warn("Failed to add service token "+
a.name)}})})}).then(function(){var a=h.npk;if(a)if("npticket"!=nrdp.webcrypto.authenticationType)q.log("Ignoring saved NP Ticket");else return q.log("Loading NP Ticket..."),d(da.getKeyInfo(a)).then(function(a){(a=a.target.result)&&b.setNpTicket(a)})}).then(function(){q.log("Finished loading MslStore");b._lastSaved||(b._lastSaved=c)}).fin(function(){delete b._dirty;delete b._loading});else q.warn("No MslStore to load")}).fail(function(a){q.warn("Failed to load MslStore : "+a);nrdp.storage.removeItem(nrdp.storage.NO_DEVICE_ACCOUNT,
"mslstore")}).thenResolve()},save:function(a){var b=this,c=b.getMasterToken(),d,e=[],h,f=b._lastSaved;if(this._dirty){delete this._dirty;q.log("Saving MslStore..."+(a?"("+a+")":""));if(c){h={};h.di=b._deviceIdentity;h.mt=c.toJSON();d=[];Object.keys(b.userIdTokens).forEach(function(a){var e=b.getUserIdToken(a),h;e.isBoundTo(c)&&(h=b.getServiceTokens(c,e).map(function(a){return a.toJSON()}),d.push({id:a,t:e.toJSON(),st:h}))});h.uit=d;if(a=b.getCryptoContext(c))a instanceof Ub?([a.encryptionKey,a.hmacKey].forEach(function(a){a&&
e.push(a)}),h.cc="symmetric",h.ek=a.encryptionKey.handle,h.hk=a.hmacKey.handle):q.error("NrdpMslStore does not know how to persist this kind of CryptoContext");this._npTicketWCKey&&(e.push(this._npTicketWCKey),h.npk=this._npTicketWCKey.handle)}if(h){a=JSON.stringify(h);if(f&&f===a){q.log("Already saved this, skipping it");return}R&&(q.trace("This is what I will save:"),q.dump(h));nrdp.storage.setItem(nrdp.storage.NO_DEVICE_ACCOUNT,"mslstore",a);b._lastSaved=a;q.log("Finished saving MslStore")}else nrdp.storage.removeItem(nrdp.storage.NO_DEVICE_ACCOUNT,
"mslstore"),delete b._lastSaved;nrdp.webcrypto.persistKeys(e,function(a){a.success?q.log("Finished persisting MslStore keys"):q.warn("Failed to persist MslStore keys")});V(b._hasUserIdTokens())}}}),W=te.extend({init:function(a){this._client=a;this._entityAuthFactories={};this._keyRequestDataFactory=this._keyRequestData=null;this._keyExchangeFactories=[];this._mslCryptoContext=new ae;this._deviceIdentity=nrdp.device.ESN;q.warn("ESN: "+this._deviceIdentity);this._store=new Xa(this._deviceIdentity,a);
this._random=new Na;this._entityAuthData=new ob(this._deviceIdentity)},_generateNPTicket:function(){var a=this,b={name:"RSASSA-PKCS1-v1_5",params:{npticket:!0}};return G.attempt(function(){if(a._generatingNPTicket)throw Error("Already waiting for NP ticket generation, cannot make a new one now");q.log("Creating NP-Ticket");a._generatingNPTicket=!0;return d(da.generateKey(b,!0)).fin(function(){delete a._generatingNPTicket}).then(function(b){var c=b.target.result.privateKey;q.log("Created NP-Ticket: "+
JSON.stringify(b));if(c.algorithm.npTicketFake&&(b=a.getMslStore().getNpTicket())&&!b.algorithm.npTicketFake){var d=1E3*b.algorithm.npTicketExpiration,e=nrdp.now();if(d>e){q.log("Tried to get a new NP-Ticket, but got a fake one, and the old one was real and isn't expired yet, so I'm keeping it");a._entityAuthData||(a._entityAuthData=new Eb(a._deviceIdentity,b));return}}a.getMslStore().setNpTicket(c);a._entityAuthData=new Eb(a._deviceIdentity,c)})})},_generateADHExchangeRequestData:function(a,b){var c=
new Uint8Array([150,148,233,216,217,58,90,199,76,80,155,75,188,232,94,146,19,44,209,156,206,71,125,26,126,71,213,39,217,236,41,21,21,240,184,179,225,234,237,80,6,225,177,185,30,162,91,145,160,27,16,226,232,52,184,214,96,178,227,33,173,100,76,225,168,59,50,141,144,20,238,126,22,241,228,79,254,137,87,154,195,238,71,214,104,182,183,102,135,194,254,144,163,91,94,96,40,253,4,239,234,136,35,115,236,246,11,162,246,55,228,205,170,27,96,137,214,192,181,97,168,229,32,231,150,222,39,223]),e=new Uint8Array([5]);
q.log("Generating DH key");return d(da.generateKey({name:"NFLX-DH",params:{prime:c,generator:e}},!1,["derive"])).then(function(b){var c=b.target.result.publicKey,e=b.target.result.privateKey;q.log("Exporting DH public key");return d(da.exportKey("raw",c)).then(function(b){return new yc(a,"1",b.target.result,e,null)})})},_makeADHExchange:function(a){var b=zd.extend({getDerivationKey:function(b){if(!b)return a}});return new xd(new b)},prepare:function(){var a=this;q.info("Preparing MslContext...");
return G.resolve(a._store.load(a)).then(function(){var b=function(){q.log("Crypto context removed, dropping key request data");this._keyRequestData=null}.bind(a);a._client.addEventListener("removeCryptoContext",b);a._client.addEventListener("clearCryptoContexts",b);a._client.addEventListener("setCryptoContext",b)}).then(function(){var b,c;q.info("Server entity auth keys...");if(w.noverify)c=Pc.extend({getCryptoContext:function(a,b){this._cryptoContext||(this._cryptoContext=new Ab);return this._cryptoContext}}),
q.warn("Added NULL RSA auth factory because we are not verifying the server"),a._entityAuthFactories[ga.RSA.name]=new c;else{try{b=nrdp.storage.transientData.appboot.msltruststore.keys,c=Object.getOwnPropertyNames(b).map(function(a){return{identity:a,type:"downloaded",op:da.importKey("spki",b[a],Hc,!1,["verify"])}})}catch(d){c=w.appboot_key?[{identity:"APPBOOT",type:"overridden",op:da.importKey("spki",w.appboot_key,Hc,!1,["verify"])}]:[{identity:"APPBOOT",type:"baked in",op:da.getKeyByName("ABKP")}]}return G.all(c.map(function(a){return new G(function(b,
c){var d=a.op;q.info("Importing "+a.type+" key for "+a.identity);d.onerror=function(a){c(a.error)};d.oncomplete=function(c){b({identity:a.identity,key:c.target.result})}})})).then(function(a){return G.all(a.map(function(a){var b=new e,c;q.info("Creating MSL PublicKey for "+a.identity);c=b.result;b.result=function(b){c({identity:a.identity,key:b})};nb(a.key,b);return b.promise}))}).then(function(b){var c=new be;b.forEach(function(a){q.info("Adding key to RSA store "+a.identity);c.addPublicKey(a.identity,
a.key)});a._entityAuthFactories[ga.RSA.name]=new Pc(void 0,c)}).fail(function(a){q.error("Failed to set-up server entity auth keys : "+a.toString())})}}).then(function(){var b=w.unauth?"UNKNOWN":nrdp.webcrypto.authenticationType;q.info("Device authentication type is '"+b+"'");switch(b){case "PSK":return q.info("Device authentication using PSK"),A(a,ga.PSK).spread(function(b,c,d){F(w,a,ga.PSK,d)});case "MGK":return q.info("Device authentication using MGK"),A(a,ia.MGK).spread(function(b,c,d){F(w,a,
ia.MGK,d)});case "npticket":return q.info("Device authentication using NP-Ticket"),G.attempt(function(){var b=a.getMslStore().getNpTicket(),c,d,e;if(b)if(q.info("Checking saved NP-Ticket"),e=nrdp.now(),c=1E3*b.algorithm.npTicketIssue,d=1E3*b.algorithm.npTicketExpiration,c+w.npticket_interval<e)q.warn("NP-Ticket was issued more than 4 hours ago : issued="+c+"ms, now="+e+"ms, expiration="+d+"ms");else if(d<=e)q.warn("NP-Ticket is expired : issued="+c+"ms, now="+e+"ms, expiration="+d+"ms");else{q.info("Saved NP-Ticket seems good");
a._entityAuthData=new Eb(a._deviceIdentity,b);return}else q.info("No saved NP-Ticket, making a new one");return a._generateNPTicket()}).then(function(){a._entityAuthFactories[ia.NPTICKET.name]=new we;a._keyExchangeFactories.push(new Gb);a._keyRequestDataFactory=t});case "UNKNOWN":q.warn("Using unauthenticated auth factory - NOT using device keys");a._entityAuthFactories[ga.NONE.name]=new Qc;a._entityAuthData=new ob(a._deviceIdentity);a._keyExchangeFactories.push(new Gb);a._keyRequestDataFactory=t;
break;case "CDM":q.warn("Using unauthenticated auth factory - NOT using device keys");a._entityAuthFactories[ga.NONE.name]=new Qc;a._entityAuthData=new ob(a._deviceIdentity);if(!nrdp.webcrypto.cdmDerive)throw Error("Platform does not support CDM key exchange");a._keyExchangeFactories.push(new Hd);a._keyRequestDataFactory=x;break;case "CDM_JWE":q.info("Device authentication using MGK");if(!nrdp.webcrypto.cdmDerive)throw Error("Platform does not have cdmDerive");return A(a,ia.MGK).then(function(){a._keyExchangeFactories.push(new Jd);
a._keyRequestDataFactory=z});case "ecclink":q.info("Device authentication using ECC Ninentdo");if(!nrdp.webcrypto.eccSign)throw Error("Platform does not have eccSign");return r(a);default:throw Error('Unrecognized authentication type "'+nrdp.webcrypto.authenticationType+'" from nrdp.webcrypto.authenticationType');}})},getTime:function(){return clock$getTime()},getRandom:function(){return this._random},isPeerToPeer:function(){return!1},getMessageCapabilities:function(){var a=[],b=[];nrdp.registration&&
(b=nrdp.registration.UILanguages);b=b.concat(nrdp.device.language);"lzw"===w.compress&&a.push(za.LZW);"none"!==w.compress&&a.push(za.GZIP);return new Hb(a,b)},getEntityAuthenticationData:function(a,b){var c=this;G.attempt(function(){if(a&&(q.log("Entity re-auth"),"npticket"==nrdp.webcrypto.authenticationType))return c._generateNPTicket()}).then(function(){b.result(c._entityAuthData)},function(a){b.error(a)}).done()},getMslCryptoContext:function(){return this._mslCryptoContext},getEntityAuthenticationFactory:function(a){return this._entityAuthFactories[a.name]},
getUserAuthenticationFactory:function(a){return null},getTokenFactory:function(){return null},getKeyExchangeFactory:function(a){return this.getKeyExchangeFactories().filter(function(b){return b.scheme.name==a.name})[0]},getKeyExchangeFactories:function(){return this._keyExchangeFactories},getMslStore:function(){return this._store},getKeyRequestData:function(a){var b=this,c=b._keyRequestData;G.attempt(function(){if(c)return c;q.info("Don't have key request data, creating one...");if(!b._keyRequestDataFactory)throw Error("Missing a key request data factory");
return b._keyRequestDataFactory()}).then(function(c){if(!c)throw Error("Request data factory returned null");b._keyRequestData=c;a.result([c])}).fail(function(b){q.error("Failed to create key request data : "+b.toString());a.error(b)})}}),Ya=se.extend({init:function(a){this._requestInfo=a},sentHeader:function(a){try{var b=a.masterToken,c=a.userIdToken,d,e,h,n,r="-> ["+this._requestInfo.n+"."+ ++this._requestInfo.r+"] "+this._requestInfo.url,r=r+(" mid="+a.messageId+" mt="+f(b)),r=r+(" nrp="+!!a.nonReplayable+
" ren="+!!a.renewable),r=r+(" uit="+y(c));if(d=a.userAuthenticationData)r+=" uad="+d.scheme.name;if(n=a.entityAuthenticationData)r+=" ead="+JSON.stringify(n.toJSON());(e=a.serviceTokens)&&e.length&&(r+=" st=[",e.forEach(function(a,b){b&&(r+=",");r+=a.uniqueKey()}),r+="]");(h=a.keyRequestData)&&h.length&&(r+=" krd=[",h.forEach(function(a,b){b&&(r+=",");r+=JSON.stringify(a.toJSON())}),r+="]");q.log(r)}catch(p){}},receivedHeader:function(a){try{var b,c,d,e,h="<- ["+this._requestInfo.n+"."+this._requestInfo.r+
"] "+this._requestInfo.url;a instanceof qb?h+=" mid="+a.messageId+" error="+a.internalCode+" ["+a.errorCode+"] "+a.errorMessage:a instanceof Cb&&(b=a.masterToken,c=a.userIdToken,h+=" mid="+a.messageId+" mt="+f(b),h+=" nrp="+!!a.nonReplayable+" ren="+!!a.renewable,h+=" uit="+y(c),(d=a.serviceTokens)&&d.length&&(h+=" st=[",d.forEach(function(a,b){b&&(h+=",");h+=a.uniqueKey()}),h+="]"),e=a.keyResponseData)&&(b=e.masterToken,h+=" krd-mt="+f(b));q.log(h)}catch(n){}}}),X=Ib.extend({init:function(a,b,c,
d,e,h,f,n,y,r){var p=null,t=nrdp.registration;e=aa.isUndefined(e)||aa.isNull(e)?!0:!!e;h=aa.isUndefined(h)||aa.isNull(h)?!0:!!h;f=!!f||y;r&&(q.log("Using custom tokens that were passed in to the message context"),this.tokens=r);if(t)if(aa.isUndefined(c)){if(r=t.activationTokens,t.registered||r&&(r.NetflixId&&r.SecureNetflixId||r.email&&r.password||r.ssoService&&r.ssoToken))p={id:t.currentDeviceAccount,tokens:r}}else aa.isNull(c)||((r=t.deviceAccounts.filter(function(a){return a.accountKey==c}).reduce(function(a,
b){return b.tokens},void 0))?p={id:c,tokens:r}:q.warn("No tokens for user id '"+c+"', sending with no account"));else aa.isNull(c)||(p={id:c});Object.defineProperties(this,{_client:{value:a,writable:!1},_account:{value:p,writable:!1},_payload:{value:d,writable:!1},_encrypted:{value:e,writable:!1},_replayable:{value:h,writable:!1},_requestingTokens:{value:f,writable:!1},_serviceTokens:{value:n,writable:!1},_requestInfo:{value:b,writable:!1},_forceUserAuthData:{value:!!y,writable:!1}})},getCryptoContexts:function(){this._cryptoContexts||
(this._cryptoContexts={});return this._cryptoContexts},getRecipient:function(){},isEncrypted:function(){return this._encrypted},isIntegrityProtected:function(){return!0},isNonReplayable:function(){return!this._replayable},isRequestingTokens:function(){return this._requestingTokens},getUserId:function(){if(this._account)return this._account.id;q.log("No account associated with this request");return null},getUserAuthData:function(a,b,c,d){b=null;var e=this._account,h,f;e?a?q.error("Asked to reauth user auth data, need to log in again"):
this._forceUserAuthData||c||!this._client.getUserIdToken(e.id,!0)?(this._forceUserAuthData&&q.log("User auth data is being forced for this message"),c&&q.log("User auth data is required for this message"),a=this.tokens||e.tokens,a)?a.ssoService&&a.ssoToken?("xboxsaml"==a.ssoService.toLowerCase()?(f=Gc.MICROSOFT_SAML,q.log("Will use XBox SAML SSO user auth data")):"xboxjwt"==a.ssoService.toLowerCase()&&(f=Gc.MICROSOFT_JWT,q.log("Will use XBox JWT SSO user auth data")),f&&(a.email&&a.password?(q.log("Including SSO email/password user auth data for "+
e.id),h=new Od(a.email,a.password)):a.NetflixId&&a.SecureNetflixId&&(q.log("Including SSO netflix id user auth data for "+e.id),h=new Pd(a.NetflixId,a.SecureNetflixId)),b=new Nb(f,a.ssoToken,h))):a.email&&a.password?(q.log("Including email/password user auth data for "+e.id),b=new Kb(a.email,a.password)):a.NetflixId&&a.SecureNetflixId?(q.log("Including netflix id user auth data for "+e.id),b=new Mb(a.NetflixId,a.SecureNetflixId)):a.mdxControllerToken&&(q.log("Including mdx controller auth data"),
h=(new Lb("regpairrequest",a.mdxNonce,a.mdxEncryptedPinB64,a.mdxSignature)).getEncoding(),b=new Fb(void 0,a.mdxPin,a.mdxControllerToken,h,a.mdxSignature)):q.log("User id "+e.id+" does not have email/password or netflix"):q.log("Already have a user id token for "+e.id+" and this is not a reauth - will not send auth data"):q.log("No account associated with this request");d.result(b)},getUser:function(){return null},getKeyRequestData:function(a){this._client.getKeyRequestData(a)},updateServiceTokens:function(a,
b,c){var d=!0;b||this._serviceTokens&&this._serviceTokens.forEach(function(b){b?(q.log("Adding service token to outbound message : "+b.name),d=d&&a.addPrimaryServiceToken(b)):q.error(">>> MSL message has NULL service token <<<")});d?c.result(!0):c.error(Error("Failed to update all service tokens"))},write:function(a,b,c){var d=this._payload;G.attempt(function(){var c;switch(w.compress){case "none":break;default:return}c=new e;q.trace("Configuring output stream without compression");a.setCompressionAlgorithm(null,
b,c);return c.promise}).then(function(){var c,h=new e;aa.isObject(d)&&d.constructor==Uint8Array||(d=ra(d));c=d.length;a.write(d,0,c,b,h);return h.promise.then(function(d){var h=new e;if(d!==c)throw new ha("Message context did not write all bytes");a.close(b,h);return h.promise})}).then(function(){c.result(!0)}).fail(function(a){q.error("Exception writing : "+a);a instanceof ua?c.timeout():c.error(a)}).done()},getDebugContext:function(){return DEBUG?new Ya(this._requestInfo):null}}),S=ha.extend({init:function qe(a,
b){this.mesg=a;this.url=b.url;this.errorCode=b.errorcode;this.errorGroup=b.errorgroup;this.nativeerrorCode=b.nativeerrorCode;this.finalUrl=b.finalURL;this.serverIp=b.serverIp;this.httpCode=b.statusCode;qe.base.call(this,a)}}),Qa=ee.extend({init:function(a,b,c){this._client=a;this._url=b;this._info=c},getResponse:function(a,b,c){function d(a){z&&h.clearTimeout(z);if(x)q.warn("load callback was called again");else{x=!0;var b={dt:a.dnsTime||0,ct:a.connectTime||0,tt:a.transactionTime||0,du:a.duration||
0,serverIp:a.serverIp};nrdp.instrumentation.startInterval(nrdp.instrumentation.SWITCHED,"nrdjs.handle-msl-response/"+n.n);n.networkTime=nrdp.mono()-t;n.netStats=b;D&&q.dump(a);q.log("  HTTP took "+n.networkTime+" ms ("+v+","+a.size+" bytes) ["+b.dt+","+b.ct+","+b.tt+"="+b.du+" ("+(n.networkTime-b.du)+")] for request ("+n.n+") "+f);try{switch(a.reason){case h.SUCCESS:b={};if(200===a.statusCode){b.json=a.json||null;n.simnetOverride=a.simnetOverride;c.result(b);break}throw new S("HTTP status code "+
a.statusCode,a);case h.TIMEOUTERROR:throw new S("TIMED_OUT_ERROR",a);case h.NOTSECUREERROR:throw new S("NOT_SECURE_ERROR",a);case h.FILEACCESSERROR:throw new S("FILE_ACCESS_ERROR",a);case h.DATAURIERROR:throw new S("DATA_URI_ERROR",a);case h.DNS_ERROR:throw new S("DNS_ERROR",a);case h.CONNECT_ERROR:throw new S("CONNECT_ERROR",a);case h.SSLHANDSHAKEERROR:throw new S("SSL_HANDSHAKE_ERROR",a);case h.SSLCACERTERROR:throw new S("SSL_CA_CERT_ERROR",a);case h.SSLCACERTFILEERROR:throw new S("SSL_CA_CERT_FILE_ERROR",
a);case h.CERTSTATUSSSLERROR:throw new S("CERT_STATUS_ERROR",a);case h.CERTSTATUSREVOKED:throw new S("CERT_REVOKED_ERROR",a);case h.CERTSTATUSPEWREVOKED:throw new S("CERT_PEW_REVOKED_ERROR",a);case h.SENDERROR:throw new S("SEND_ERROR",a);case h.RECVERROR:throw new S("RECV_ERROR",a);case h.COMPRESSIONERROR:throw new S("COMPRESSION_ERROR",a);case h.SECURITYERROR:throw new S("SECURITY_ERROR",a);case h.NETWORKERROR:throw new S("NETWORK_ERROR",a);default:throw new S(200<a.statusCode?"HTTP_ERROR":"UNKNOWN ["+
a.reason+"]",a);}}catch(r){q.error("Request ("+n.n+") to "+f+" failed : "+r.mesg+" : "+JSON.stringify(r)),e._client.emit("requestError",{exception:r,response:a}),c.error(r)}}}var e=this,h=nrdp.gibbon,f=this._url,n=this._info,r=""+Math.floor(nrdp.now()/1E3)+Math.floor(1E8*Math.random()),y={url:f,headers:{"X-Gibbon-Cache-Control":"no-cache","X-AllowCompression":"true","X-Client-Request-Id":r},body:a.body,async:!0,secure:!0,timeout:b||void 0,connectTimeout:b/2||void 0,stallTimeout:b||void 0,format:"jsonstream"},
p,t=nrdp.mono(),v=a.body.length,x,z;nrdp.device.deviceModel&&(y.headers["X-DeviceModel"]=nrdp.device.deviceModel);w.noss&&(y.headers["X-Netflix.esn"]=nrdp.device.ESN);n.mslPayload&&(y.mslPayload=n.mslPayload);n.clientRequestId=r;q.log("  Making HTTP request ("+n.n+") ["+r+"] request body is "+a.body.length+" bytes "+f);D&&q.dump(y);nrdp.instrumentation.endInterval(nrdp.instrumentation.SWITCHED,"nrdjs.prepare-msl-request/"+n.n);p=h.load(y,d);w.mslFallbackTimer&&(z=setTimeout(function(){q.error("Failing request on artifical timeout of "+
(b+1E3)+" ms");h.stopLoad(p);z=null;d({reason:h.TIMEOUTERROR,size:0,url:f,finalURL:f,errorcode:nrdp.network.ERRORCODE.TIMEOUTERROR,errorgroup:nrdp.network.ERRORGROUP.CONNECTIVITY_ERROR,nativeerrorCode:0,serverIp:"",statusCode:0})},b+1E3));return{abort:function(){q.warn("Aborting request ("+n.n+") : ID "+p);h.stopLoad(p)}}}});this._prepare=function(){D=w.trace_msl_requests;J=w.trace_msl_service_tokens;R=w.trace_msl_store;q.info("Creating MslControl...");this._mslControl=new qd;q.info("Creating MslContext...");
this._mslContext=new W(this);return this._mslContext.prepare().thenResolve(this)};this.request=function(b,c,d,h,f,r,y,t,v,w,x,z){var B=this,C=nrdp.mono(),A={url:b,n:T++,r:0};nrdp.instrumentation.startInterval(nrdp.instrumentation.SWITCHED,"nrdjs.prepare-msl-request/"+A.n,{url:b,n:A.n});q.log("Making MSL request ("+A.n+") payload is "+(d.byteLength||d.length)+" bytes "+b);"undefined"!==typeof simnet&&(A.mslPayload=d);return G.attempt(function(){var a=new X(B,A,c,d,f,r,y,t,v,z),p=new e,C=new Tc(new Qa(B,
b,A));w&&(q.info("Getting new message context from message context factory"),a=w(B._mslContext,a)||a,nrdp.assert(aa.isObject(a)));J&&E("outbound",A,t,B._mslContext,a);x&&(q.info("Getting URL from URL factory"),C=x(B._mslContext,a,b,A,C)||C,nrdp.assert(aa.isObject(C)));B._mslControl.request(B._mslContext,a,C,h||-1,p);return p.promise}).then(function(a){if(!a)throw Error("No MSL channel returned");return a}).fail(function(a){q.log("<- ["+A.n+"."+A.r+"] "+A.url+" e="+a.toString());throw a;}).then(function(b){b=
b.input;var c=b.getErrorHeader(),d=b.getMessageHeader();if(c)throw q.error("MSL response has error header : "+c.internalCode+" ["+c.errorCode+"] "+c.errorMessage),new p(new a(c.internalCode,c.errorCode,c.errorMessage));c=d.serviceTokens;J&&E("inbound",A,c);d=new e;b.read(-1,h,d);return[d.promise,G.resolve(c)]}).spread(function(a,b){aa.isFunction(A.simnetOverride)&&(a=A.simnetOverride(a),delete A.simnetOverride);return{body:a||new Uint8Array,serviceTokens:b,requestInfo:A}}).fin(function(){B._mslContext.getMslStore().save("After a request");
q.log("  MSL took "+(nrdp.mono()-C-(A.networkTime||0))+" ms for request ("+A.n+") "+b);nrdp.instrumentation.endInterval(nrdp.instrumentation.SWITCHED,"nrdjs.handle-msl-response/"+A.n,{url:b,n:A.n})})};this.send=function(a,b){var d=this;G.attempt(function(){return d.request(a.url,a.userId,a.body,a.timeout,a.encrypted,a.replayable,a.requestingTokens,a.serviceTokens,a.forceUserAuthData,void 0,void 0,a.customTokens)}).then(function(a){try{q.trace("MSL networkstats:"+JSON.stringify(a.requestInfo.netStats)),
b({success:!0,body:jb(a.body),serviceTokens:a.serviceTokens,requestInfo:a.requestInfo})}catch(c){q.error("Exception in MSL callback : "+c.toString()+"\n"+c.stack)}}).fail(function(e){var f=nrdp.registration,n=a.userId,r,y,t={mslError:e,errorActionId:h(e),errorIsTimeout:"TIMED_OUT_ERROR"===e.mesg,errorSubCode:1300};q.error("MSL request failed : "+e.toString()+(e.cause&&e.cause.toString?" (caused by "+e.cause.toString()+")":"")+" : ACTION ID "+t.errorActionId+" : "+a.url);try{r="undefined"!==typeof f?
f.currentDeviceAccount:null,y="undefined"!==typeof n&&null!==n?n:r,e instanceof p&&e.error&&e.error.responseCode===c.USERDATA_REAUTH&&null!==r&&(f.deviceAccounts.filter(function(a){return y===a.accountKey}).forEach(function(a){q.log("Clearing device account tokens for user "+y);a.tokens={}}),q.log("Dropping user id token for user "+y),d.removeUserIdToken(y)),b(t)}catch(v){q.error("Exception in MSL error callback : "+v.toString()+"\n"+v.stack)}}).done()};this.sendWithRetries=function(a,b,c,d){var e=
this;d="number"===typeof d?d:0;e.send(a,function(h){"undefined"!==typeof h.mslError&&2==h.errorActionId&&d<b?(q.info("MSL request failed with retryable condition, will retry "+(b-d)+" more times : "+JSON.stringify(h)+" : "+a.url),h=1E3*Math.pow(2,d),q.info("will retry MSL request in "+h+"ms"),setTimeout(function(){e.sendWithRetries(a,b,c,d+1)},h)):(d===b&&(q.warn("MSL request failed with retryable condition, but we've already retried "+b+" times, so we'll report it as non-retryable"),h.errorActionId=
1,q.warn("responding with "+JSON.stringify(h))),c(h))})};this.getRandom=function(){return this._mslContext.getRandom()};this.getKeyRequestData=function(a){return this._mslContext.getKeyRequestData(a)};this.getMslStore=function(){return this._mslContext.getMslStore()};this.getUserIdToken=function(a,b){var c=this.getMslStore(),d=c.getUserIdToken(a);d&&b&&((c=c.getMasterToken())&&d.isBoundTo(c)||(d=null));return d};this.removeUserIdToken=function(a){var b=this.getMslStore();if(a=b.getUserIdToken(a))b.removeUserIdToken(a),
b.save()};this.clearUserIdTokens=function(){var a=this.getMslStore();a.clearUserIdTokens();a.save()};this.parseServiceToken=function(a,b,c){var d=this;G.attempt(function(){var c=d.getMslStore(),h=c.getMasterToken(),c=c.getUserIdToken(a),f;if(b&&h&&c)return f=new e,Xb(this._mslContext,b,h,c,null,f),f.promise}).fail(function(a){q.warn("Failed to parse service token",a)}).then(function(b){b?q.trace("Parsed service token "+b.name+" for account "+a):q.trace("Did not parse the service token for account "+
a);c(b)}).done()};this.getNpTicketCookie=function(){var a=this.getMslStore().getNpTicket();return b(a,["algorithm","npTicket"])};this.isNpTicketFake=function(){var a=this.getMslStore().getNpTicket();return b(a,["algorithm","npTicketFake"])};this.generateNpTicket=function(a,b){var c=this;G.attempt(function(){if("npticket"!=nrdp.webcrypto.authenticationType)throw Error("Not npticket authentication type");a&&(q.warn("Dropping existing NP-Ticket"),c.getMslStore().setNpTicket(null));return c._mslContext._generateNPTicket()}).then(function(){return c.getNpTicketCookie()},
function(a){q.error("Failed to make new NP-Ticket : "+a.toString())}).then(function(a){b&&b(a)}).done()};this.resetMslContext=function(){q.warn("MSL Context has been reset and it will no longer function properly");this._mslContext=new W(this)};K(O,this)}var q=new (D("nf-console"))("MSL"),G=D("nf-promise"),K=D("nf-mixin"),O=D("nf-events").EventEmitter;xb=function(a){return G.attempt(function(){DEBUG=nrdp.debug;return(new sa(a))._prepare()})}})();sa=bc.LEGACY;xb.TimeoutError=ua;xb.MslException=p;xb.MslEncodingException=
G;xb.MslIoException=ha;xb.MslConstants$ResponseCode=c;S.exports=xb},{"nf-console":6,"nf-events":9,"nf-mixin":11,"nf-promise":12,"nf-underscore":13}],11:[function(D,S,ba){S.exports=function(t,f){for(var z in t)t.hasOwnProperty(z)&&(f[z]=t[z]);return f}},{}],12:[function(D,S,ba){S.exports=function(){var t=D("q"),f=function(f){var A=t.defer(),D=A.resolve.bind(A),b=A.reject.bind(A);try{f(D,b)}catch(e){b(e)}return A.promise};f.attempt=function(f){return t.fcall(f)};f.resolve=function(f){return t(f)};f.reject=
function(f){return t.reject(f)};f.all=function(f){return t.all(f)};return f}()},{q:14}],13:[function(D,S,ba){var t={isNumber:function(f){return"number"===typeof f},isObject:function(f){return"object"===typeof f},isString:function(f){return"string"===typeof f},isUndefined:function(f){return"undefined"===typeof f},isBoolean:function(f){return"boolean"===typeof f},isFunction:function(f){return"function"===typeof f},isNull:function(f){return null===f},isArray:function(f){return"[object Array]"===Object.prototype.toString.call(f)},
isFinite:function(f){return isFinite(f)&&!isNaN(parseFloat(f))},has:function(f,t){return null!==f&&"undefined"!==typeof f&&Object.prototype.hasOwnProperty.call(f,t)},pairs:function(f){var z,A=[];if(!t.isObject(f))throw new TypeError("Object.pairs called on non-object");for(z in f)f.hasOwnProperty(z)&&A.push([z,f[z]]);return A}};t.each=t.forEach=function(f,z,A){if(null===f||"undefined"===typeof f)return f;if(f.length===+f.length)for(var D=0,b=f.length;D<b;D++)z.call(A,f[D],D,f);else for(D in f)t.has(f,
D)&&z.call(A,f[D],D,f);return f};t.stringifyCyclic=function(f){var t=[];f=JSON.stringify(f,function(f,D){if("object"===typeof D&&null!==D){if(-1!==t.indexOf(D))return"<cycle>";t.push(D)}return D}," ");t=void 0;return f};S.exports=t},{}],14:[function(D,S,ba){(function(t){(function(f){"function"===typeof bootstrap?bootstrap("promise",f):"object"===typeof ba?S.exports=f():"function"===typeof define&&define.amd?define(f):"undefined"!==typeof ses?ses.ok()&&(ses.makeQ=f):Q=f()})(function(){function f(a){return function(){return x.apply(a,
arguments)}}function z(a,b){if(O&&b.stack&&"object"===typeof a&&null!==a&&a.stack&&-1===a.stack.indexOf("From previous event:")){for(var c=[],e=b;e;e=e.source)e.stack&&c.unshift(e.stack);c.unshift(a.stack);for(var c=c.join("\nFrom previous event:\n").split("\n"),e=[],f=0;f<c.length;++f){var p=c[f],t;if(t=A(p)){var w=t[1];t=t[0]===Ua&&w>=Ob&&w<=X}else t=!1;t||(t=p,t=-1!==t.indexOf("(module.js:")||-1!==t.indexOf("(node.js:"));t||!p||e.push(p)}c=e.join("\n");a.stack=c}}function A(a){var b=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(a);
if(b||(b=/at ([^ ]+):(\d+):(?:\d+)$/.exec(a)))return[b[1],Number(b[2])];if(a=/.*@(.+):(\d+)$/.exec(a))return[a[1],Number(a[2])]}function D(){if(O)try{throw Error();}catch(a){var b=a.stack.split("\n"),b=0<b[0].indexOf("@")?b[1]:b[2];if(b=A(b))return Ua=b[0],b[1]}}function b(a){return ra(a)?a:ka(a)?ca(a):ja(a)}function e(){function a(b){p=b;x.source=b;Na(h,function(a,d){c(function(){b.promiseDispatch.apply(b,d)})},void 0);f=h=void 0}var h=[],f=[],p,t=F(e.prototype),x=F(w.prototype);x.promiseDispatch=
function(a,b,d){var e=ea(arguments);h?(h.push(e),"when"===b&&d[1]&&f.push(d[1])):c(function(){p.promiseDispatch.apply(p,e)})};x.valueOf=function(){if(h)return x;var a=jb(p);ra(a)&&(p=a);return a};x.inspect=function(){return p?p.inspect():{state:"pending"}};if(b.longStackSupport&&O)try{throw Error();}catch(z){x.stack=z.stack.substring(z.stack.indexOf("\n")+1)}t.promise=x;t.resolve=function(c){p||a(b(c))};t.fulfill=function(b){p||a(ja(b))};t.reject=function(b){p||a(K(b))};t.notify=function(a){p||Na(f,
function(b,d){c(function(){d(a)})},void 0)};return t}function a(a){if("function"!==typeof a)throw new TypeError("resolver must be a function.");var b=e();try{a(b.resolve,b.reject,b.notify)}catch(c){b.reject(c)}return b.promise}function S(c){return a(function(a,e){for(var f=0,p=c.length;f<p;f++)b(c[f]).then(a,e)})}function w(a,b,c){void 0===b&&(b=function(a){return K(Error("Promise does not support operation: "+a))});void 0===c&&(c=function(){return{state:"unknown"}});var e=F(w.prototype);e.promiseDispatch=
function(c,f,p){var y;try{y=a[f]?a[f].apply(e,p):b.call(e,f,p)}catch(t){y=K(t)}c&&c(y)};if(e.inspect=c){var f=c();"rejected"===f.state&&(e.exception=f.reason);e.valueOf=function(){var a=c();return"pending"===a.state||"rejected"===a.state?e:a.value}}return e}function ba(a,c,e,f){return b(a).then(c,e,f)}function jb(a){if(ra(a)){var b=a.inspect();if("fulfilled"===b.state)return b.value}return a}function ra(a){return a===Object(a)&&"function"===typeof a.promiseDispatch&&"function"===typeof a.inspect}
function ka(a){return a===Object(a)&&"function"===typeof a.then}function aa(){E.length=0;V.length=0;wa||(wa=!0)}function da(a,b){wa&&(V.push(a),b&&"undefined"!==typeof b.stack?E.push(b.stack):E.push("(no stack) "+b))}function K(a){var b=w({when:function(b){if(b&&wa){var c=ib(V,this);-1!==c&&(V.splice(c,1),E.splice(c,1))}return b?b(a):this}},function(){return this},function(){return{state:"rejected",reason:a}});da(b,a);return b}function ja(a){return w({when:function(){return a},get:function(b){return a[b]},
set:function(b,c){a[b]=c},"delete":function(b){delete a[b]},post:function(b,c){return null===b||void 0===b?a.apply(void 0,c):a[b].apply(a,c)},apply:function(b,c){return a.apply(b,c)},keys:function(){return Ha(a)}},void 0,function(){return{state:"fulfilled",value:a}})}function ca(a){var b=e();c(function(){try{a.then(b.resolve,b.reject,b.notify)}catch(c){b.reject(c)}});return b.promise}function Z(a,c,e){return b(a).spread(c,e)}function W(a,c,e){return b(a).dispatch(c,e)}function T(a){return ba(a,function(a){var b=
0,c=e();Na(a,function(d,e,f){var p;ra(e)&&"fulfilled"===(p=e.inspect()).state?a[f]=p.value:(++b,ba(e,function(d){a[f]=d;0===--b&&c.resolve(a)},c.reject,function(a){c.notify({index:f,value:a})}))},void 0);0===b&&c.resolve(a);return c.promise})}function za(a){return ba(a,function(a){a=p(a,b);return ba(T(p(a,function(a){return ba(a,Ma,Ma)})),function(){return a})})}var O=!1;try{throw Error();}catch(va){O=!!va.stack}var Ob=D(),Ua,Ma=function(){},c=function(){function a(){for(;b.next;){b=b.next;var c=
b.task;b.task=void 0;var e=b.domain;e&&(b.domain=void 0,e.enter());try{c()}catch(p){if(w)throw e&&e.exit(),setTimeout(a,0),e&&e.enter(),p;setTimeout(function(){throw p;},0)}e&&e.exit()}f=!1}var b={task:void 0,next:null},e=b,f=!1,p=void 0,w=!1;c=function(a){e=e.next={task:a,domain:w&&t.domain,next:null};f||(f=!0,p())};if("undefined"!==typeof t&&t.nextTick)w=!0,p=function(){t.nextTick(a)};else if("function"===typeof setImmediate)p="undefined"!==typeof window?setImmediate.bind(window,a):function(){setImmediate(a)};
else if("undefined"!==typeof MessageChannel){var x=new MessageChannel;x.port1.onmessage=function(){p=z;x.port1.onmessage=a;a()};var z=function(){x.port2.postMessage(0)},p=function(){setTimeout(a,0);z()}}else p=function(){setTimeout(a,0)};return c}(),x=Function.call,ea=f(Array.prototype.slice),Na=f(Array.prototype.reduce||function(a,b){var c=0,e=this.length;if(1===arguments.length){do{if(c in this){b=this[c++];break}if(++c>=e)throw new TypeError;}while(1)}for(;c<e;c++)c in this&&(b=a(b,this[c],c));
return b}),ib=f(Array.prototype.indexOf||function(a){for(var b=0;b<this.length;b++)if(this[b]===a)return b;return-1}),p=f(Array.prototype.map||function(a,b){var c=this,e=[];Na(c,function(f,p,t){e.push(a.call(b,p,t,c))},void 0);return e}),F=Object.create||function(a){function b(){}b.prototype=a;return new b},G=f(Object.prototype.hasOwnProperty),Ha=Object.keys||function(a){var b=[],c;for(c in a)G(a,c)&&b.push(c);return b},Aa=f(Object.prototype.toString),ha;ha="undefined"!==typeof ReturnValue?ReturnValue:
function(a){this.value=a};b.resolve=b;b.nextTick=c;b.longStackSupport=!1;b.defer=e;e.prototype.makeNodeResolver=function(){var a=this;return function(b,c){b?a.reject(b):2<arguments.length?a.resolve(ea(arguments,1)):a.resolve(c)}};b.Promise=a;b.promise=a;a.race=S;a.all=T;a.reject=K;a.resolve=b;b.passByCopy=function(a){return a};w.prototype.passByCopy=function(){return this};b.join=function(a,c){return b(a).join(c)};w.prototype.join=function(a){return b([this,a]).spread(function(a,b){if(a===b)return a;
throw Error("Can't join: not the same: "+a+" "+b);})};b.race=S;w.prototype.race=function(){return this.then(b.race)};b.makePromise=w;w.prototype.toString=function(){return"[object Promise]"};w.prototype.then=function(a,h,f){function p(b){try{return"function"===typeof a?a(b):b}catch(c){return K(c)}}function t(a){if("function"===typeof h){z(a,w);try{return h(a)}catch(b){return K(b)}}return K(a)}var w=this,x=e(),A=!1;c(function(){w.promiseDispatch(function(a){A||(A=!0,x.resolve(p(a)))},"when",[function(a){A||
(A=!0,x.resolve(t(a)))}])});w.promiseDispatch(void 0,"when",[void 0,function(a){var c,d=!1;try{c="function"===typeof f?f(a):a}catch(e){if(d=!0,b.onerror)b.onerror(e);else throw e;}d||x.notify(c)}]);return x.promise};b.when=ba;w.prototype.thenResolve=function(a){return this.then(function(){return a})};b.thenResolve=function(a,c){return b(a).thenResolve(c)};w.prototype.thenReject=function(a){return this.then(function(){throw a;})};b.thenReject=function(a,c){return b(a).thenReject(c)};b.nearer=jb;b.isPromise=
ra;b.isPromiseAlike=ka;b.isPending=function(a){return ra(a)&&"pending"===a.inspect().state};w.prototype.isPending=function(){return"pending"===this.inspect().state};b.isFulfilled=function(a){return!ra(a)||"fulfilled"===a.inspect().state};w.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state};b.isRejected=function(a){return ra(a)&&"rejected"===a.inspect().state};w.prototype.isRejected=function(){return"rejected"===this.inspect().state};var E=[],V=[],wa=!0;b.resetUnhandledRejections=
aa;b.getUnhandledReasons=function(){return E.slice()};b.stopUnhandledRejectionTracking=function(){aa();wa=!1};aa();b.reject=K;b.fulfill=ja;b.master=function(a){return w({isDef:function(){}},function(b,c){return W(a,b,c)},function(){return b(a).inspect()})};b.spread=Z;w.prototype.spread=function(a,b){return this.all().then(function(b){return a.apply(void 0,b)},b)};b.async=function(a){return function(){function b(a,d){var h;if("undefined"===typeof StopIteration){try{h=c[a](d)}catch(p){return K(p)}return h.done?
h.value:ba(h.value,e,f)}try{h=c[a](d)}catch(t){return"[object StopIteration]"===Aa(t)||t instanceof ha?t.value:K(t)}return ba(h,e,f)}var c=a.apply(this,arguments),e=b.bind(b,"next"),f=b.bind(b,"throw");return e()}};b.spawn=function(a){b.done(b.async(a)())};b["return"]=function(a){throw new ha(a);};b.promised=function(a){return function(){return Z([this,T(arguments)],function(b,c){return a.apply(b,c)})}};b.dispatch=W;w.prototype.dispatch=function(a,b){var f=this,p=e();c(function(){f.promiseDispatch(p.resolve,
a,b)});return p.promise};b.get=function(a,c){return b(a).dispatch("get",[c])};w.prototype.get=function(a){return this.dispatch("get",[a])};b.set=function(a,c,e){return b(a).dispatch("set",[c,e])};w.prototype.set=function(a,b){return this.dispatch("set",[a,b])};b.del=b["delete"]=function(a,c){return b(a).dispatch("delete",[c])};w.prototype.del=w.prototype["delete"]=function(a){return this.dispatch("delete",[a])};b.mapply=b.post=function(a,c,e){return b(a).dispatch("post",[c,e])};w.prototype.mapply=
w.prototype.post=function(a,b){return this.dispatch("post",[a,b])};b.send=b.mcall=b.invoke=function(a,c){return b(a).dispatch("post",[c,ea(arguments,2)])};w.prototype.send=w.prototype.mcall=w.prototype.invoke=function(a){return this.dispatch("post",[a,ea(arguments,1)])};b.fapply=function(a,c){return b(a).dispatch("apply",[void 0,c])};w.prototype.fapply=function(a){return this.dispatch("apply",[void 0,a])};b["try"]=b.fcall=function(a){return b(a).dispatch("apply",[void 0,ea(arguments,1)])};w.prototype.fcall=
function(){return this.dispatch("apply",[void 0,ea(arguments)])};b.fbind=function(a){var c=b(a),e=ea(arguments,1);return function(){return c.dispatch("apply",[this,e.concat(ea(arguments))])}};w.prototype.fbind=function(){var a=this,b=ea(arguments);return function(){return a.dispatch("apply",[this,b.concat(ea(arguments))])}};b.keys=function(a){return b(a).dispatch("keys",[])};w.prototype.keys=function(){return this.dispatch("keys",[])};b.all=T;w.prototype.all=function(){return T(this)};b.allResolved=
function(a,b,c){return function(){"undefined"!==typeof console&&"function"===typeof console.warn&&console.warn(b+" is deprecated, use "+c+" instead.",Error("").stack);return a.apply(a,arguments)}}(za,"allResolved","allSettled");w.prototype.allResolved=function(){return za(this)};b.allSettled=function(a){return b(a).allSettled()};w.prototype.allSettled=function(){return this.then(function(a){return T(p(a,function(a){function c(){return a.inspect()}a=b(a);return a.then(c,c)}))})};b.fail=b["catch"]=
function(a,c){return b(a).then(void 0,c)};w.prototype.fail=w.prototype["catch"]=function(a){return this.then(void 0,a)};b.progress=function(a,c){return b(a).then(void 0,void 0,c)};w.prototype.progress=function(a){return this.then(void 0,void 0,a)};b.fin=b["finally"]=function(a,c){return b(a)["finally"](c)};w.prototype.fin=w.prototype["finally"]=function(a){a=b(a);return this.then(function(b){return a.fcall().then(function(){return b})},function(b){return a.fcall().then(function(){throw b;})})};b.done=
function(a,c,e,f){return b(a).done(c,e,f)};w.prototype.done=function(a,e,f){var p=function(a){c(function(){z(a,w);if(b.onerror)b.onerror(a);else throw a;})},w=a||e||f?this.then(a,e,f):this;"object"===typeof t&&t&&t.domain&&(p=t.domain.bind(p));w.then(void 0,p)};b.timeout=function(a,c,e){return b(a).timeout(c,e)};w.prototype.timeout=function(a,b){var c=e(),f=setTimeout(function(){c.reject(Error(b||"Timed out after "+a+" ms"))},a);this.then(function(a){clearTimeout(f);c.resolve(a)},function(a){clearTimeout(f);
c.reject(a)},c.notify);return c.promise};b.delay=function(a,c){void 0===c&&(c=a,a=void 0);return b(a).delay(c)};w.prototype.delay=function(a){return this.then(function(b){var c=e();setTimeout(function(){c.resolve(b)},a);return c.promise})};b.nfapply=function(a,c){return b(a).nfapply(c)};w.prototype.nfapply=function(a){var b=e();a=ea(a);a.push(b.makeNodeResolver());this.fapply(a).fail(b.reject);return b.promise};b.nfcall=function(a){var c=ea(arguments,1);return b(a).nfapply(c)};w.prototype.nfcall=
function(){var a=ea(arguments),b=e();a.push(b.makeNodeResolver());this.fapply(a).fail(b.reject);return b.promise};b.nfbind=b.denodeify=function(a){var c=ea(arguments,1);return function(){var f=c.concat(ea(arguments)),p=e();f.push(p.makeNodeResolver());b(a).fapply(f).fail(p.reject);return p.promise}};w.prototype.nfbind=w.prototype.denodeify=function(){var a=ea(arguments);a.unshift(this);return b.denodeify.apply(void 0,a)};b.nbind=function(a,c){var f=ea(arguments,2);return function(){var p=f.concat(ea(arguments)),
t=e();p.push(t.makeNodeResolver());b(function(){return a.apply(c,arguments)}).fapply(p).fail(t.reject);return t.promise}};w.prototype.nbind=function(){var a=ea(arguments,0);a.unshift(this);return b.nbind.apply(void 0,a)};b.nmapply=b.npost=function(a,c,e){return b(a).npost(c,e)};w.prototype.nmapply=w.prototype.npost=function(a,b){var c=ea(b||[]),f=e();c.push(f.makeNodeResolver());this.dispatch("post",[a,c]).fail(f.reject);return f.promise};b.nsend=b.nmcall=b.ninvoke=function(a,c){var f=ea(arguments,
2),p=e();f.push(p.makeNodeResolver());b(a).dispatch("post",[c,f]).fail(p.reject);return p.promise};w.prototype.nsend=w.prototype.nmcall=w.prototype.ninvoke=function(a){var b=ea(arguments,1),c=e();b.push(c.makeNodeResolver());this.dispatch("post",[a,b]).fail(c.reject);return c.promise};b.nodeify=function(a,c){return b(a).nodeify(c)};w.prototype.nodeify=function(a){if(a)this.then(function(b){c(function(){a(null,b)})},function(b){c(function(){a(b)})});else return this};var X=D();return b})}).call(this,
D("_process"))},{_process:4}],15:[function(D,S,ba){S.exports={name:"nrdjs",version:"1.15.0",description:"Netflix Ready Device Platform, JavaScript middleware",repository:null,devDependencies:{browserify:"^9.0.8",grunt:"0.4.x","grunt-browserify":"^3.7.0","grunt-closure-tools":"~0.8.4","grunt-contrib-jshint":"^0.10.0","grunt-newer":"~0.6.0","grunt-shell":"~0.5.0","jasmine-node":"^1.14.5"},scripts:{test:"cd node_modules && jasmine-node nf-apiclient nf-csv nf-dfxp nf-events nf-mixin nf-filelist nf-underscore nf-console nf-config nf-ase/fragment.spec.js nf-serial-task-queue nf-heap nf-manifest-cache nf-time-tracker",
build:"node -e \"require('grunt').cli()\"",clean:"node -e \"var g = require('grunt'); g.cli.tasks = ['clean']; g.cli()\""},dependencies:{q:"~1.0.1"}}},{}],16:[function(D,S,ba){(function(t){D("./package.json");S.exports=function(){return"v1.15.0-54-g2408b14"}}).call(this,D("_process"))},{"./package.json":15,_process:4}]},{},[1]);
