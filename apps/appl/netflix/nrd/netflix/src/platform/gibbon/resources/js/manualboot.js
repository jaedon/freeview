(function(){var ya,ab,za,Aa,Gb,gc,hc;function ka(a,b){if(a===b)return!0;if(!a||!b||a.length!=b.length)return!1;for(var c=0;c<a.length;++c)if(a[c]!=b[c])return!1;return!0}function ta(a){if(!(a&&a.constructor==Uint8Array)&&!Array.isArray(a))throw new TypeError("Cannot compute the hash code of "+a);for(var b=1,c=0;c<a.length;++c){var d=a[c];if("number"!==typeof d)throw new TypeError("Cannot compute the hash code over non-numeric elements: "+d);b=31*b+d&4294967295}return b}function tb(a,b){if(a===b)return!0;
if(!a||!b)return!1;b instanceof Array||(b=[b]);for(var c=0;c<b.length;++c){for(var d=b[c],l=!1,o=0;o<a.length;++o){var bb=a[o];if(d.equals&&"function"===typeof d.equals&&d.equals(bb)||d==bb){l=!0;break}}if(!l)return!1}return!0}function c(a,b,c){var d;c&&(d=c);if("object"!==typeof a||"function"!==typeof a.result||"function"!==typeof a.error)throw new TypeError("callback must be an object with function properties 'result' and 'error'.");try{var l=b.call(d,a);void 0!==l&&a.result(l)}catch(o){try{a.error(o)}catch(bb){}}}
function d(a,b,d){if("object"!==typeof a||"function"!==typeof a.timeout)throw new TypeError("callback must be an object with function properties 'result', 'timeout', and 'error'.");c(a,b,d)}function a(a,b,c){Object.defineProperties(this,{internalCode:{value:1E6+a,writable:!1,configurable:!1},responseCode:{value:b,writable:!1,configurable:!1},message:{value:c,writable:!1,configurable:!1}})}function Hb(a){switch(a){case R.PSK:case R.MGK:return!0;default:return!1}}function Ra(a){this.name="TimeoutError";
this.message=a||"Operation timed out";this.errorCode=nrdp.network.ERRORCODE.TIMEOUTERROR;this.mesg="TIMED_OUT_ERROR"}if(!nrdp.js){nrdp.js={};var Sa=!0;nrdp.js.setDebug=function(a){Sa=a};var ia=function(a,b){return nrdp.gibbon.setTimeout(a,b||0)},cb=function(a){nrdp.gibbon.clearTimeout(a)},qd=nrdp.btoa,Ib=nrdp.atob,ub=nrdp.utf8toa,Jb=nrdp.atoutf8,$=function(a){this._traceArea=a||"NRDJS"};$.prototype=new $;$.prototype.constructor=$;$.prototype.log=function(){nrdp.log.debug(this.stringify(arguments),
this._traceArea)};$.prototype.debug=function(){nrdp.log.debug(this.stringify(arguments),this._traceArea)};$.prototype.trace=function(){nrdp.log.trace(this.stringify(arguments),this._traceArea)};$.prototype.info=function(){nrdp.log.info(this.stringify(arguments),this._traceArea)};$.prototype.warn=function(){nrdp.log.warn(this.stringify(arguments),this._traceArea)};$.prototype.error=function(){nrdp.log.error(this.stringify(arguments),this._traceArea)};$.prototype.fatal=function(){nrdp.log.fatal(this.stringify(arguments),
this._traceArea)};$.prototype.stringify=function(a){return Array.prototype.slice.call(a).reduce(function(a,b){var c=a;0<c.length&&(c+="\n");return c="object"==typeof b?null!==b&&/^\w*Error$/.test(b.name)?c+(b.toString()+"\n"+b.stack):c+("("+JSON.stringify(b)+")"):c+b},"")};$.prototype.dump=function(a){function b(a){return"string"==typeof a&&2<=a.length&&"{"==a[0]&&"}"==a[a.length-1]}function c(a){var b=a.split("}{");1<b.length&&(a="["+b.join("},{")+"]");return JSON.parse(a,l)}function d(a){var l;
if("string"==typeof a)try{l=Ib(a);if(b(l))return c(l);if("string"==typeof l&&2<=l.length&&"<"==l[0]&&">"==l[l.length-1])return l}catch(w){}}function l(a,b){var c=d(b);return c?c:b}this.trace("\n"+JSON.stringify(a,function(a,l){var w;"object"==typeof l&&l.constructor==Uint8Array&&(l=ub(l));return b(l)?c(l):(w=d(l))?w:l},"  "))};var la=new $,Y;(function(){function a(p,q){if(p==k)return{process:function(a,g,f){n.exportKey(g.key,g.format,f)}};if(p==m)return{process:function(a,g,f){"raw"==g.format?n.aesUnwrap(g.buffer,
g.algorithm,g.key,g.usages,f):n.unwrapJwe(g.buffer,g.key,g.algorithm,g.extractable,g.usages,f)}};if(p==G)return{process:function(a,g,f){n.wrapJwe(g.wrappingKey,g.key,g.algorithm,n.A128GCM,f)}};if(p==y)return{process:function(a,g,f){n.importKey(g.buffer,g.format,g.algorithm,g.extractable,g.usages,f)}};if(p==I)return{process:function(a,g,f){n.getKeyByName(g.name,f)}};if(p==t)return{process:function(a,g,f){n.getKeyInfo(g.handle,f)}};switch(q.toUpperCase()){case "AES-CBC":return{process:function(a,g,
v){switch(a){case j:n.aesEncrypt(g.key,g.algorithm.params.iv,g.buffer,v);break;case e:n.aesDecrypt(g.key,g.algorithm.params.iv,g.buffer,v);break;case f:n.symKeyGen(g.algorithm,g.extractable,g.usages,v);break;default:throw new c;}}};case "SHA-1":case "SHA-224":case "SHA-256":case "SHA-384":case "SHA-512":return{process:function(a,g,f){switch(a){case i:n.digest(g.buffer,g.algorithm,f);break;default:throw new c;}}};case "RSASSA-PKCS1-V1_5":return{process:function(a,e,v){switch(a){case g:n.rsaSign(e.key,
e.buffer,e.algorithm,v);break;case h:n.rsaVerify(e.key,e.buffer,e.algorithm,e.signature,v);break;case f:n.rsaKeyGen(e.algorithm,e.extractable,e.usages,v);break;default:throw new c;}}};case "RSA-OAEP":case "RSAES-PKCS1-V1_5":return{process:function(a,g,v){switch(a){case j:n.rsaEncrypt(g.key,g.buffer,v);break;case e:n.rsaDecrypt(g.key,g.buffer,v);break;case f:n.rsaKeyGen(g.algorithm,g.extractable,g.usages,v);break;default:throw new c;}}};case "HMAC":return{process:function(a,e,v){switch(a){case g:n.hmac(e.key,
e.buffer,e.algorithm,v);break;case h:n.hmacVerify(e.key,e.buffer,e.algorithm,e.signature,v);break;case f:n.symKeyGen(e.algorithm,e.extractable,e.usages,v);break;default:throw new c;}}};case "DH":return{process:function(a,g,e){switch(a){case f:n.dhKeyGen(g.algorithm,g.extractable,g.usages,e);break;case u:n.dhDerive(g.key,g.algorithm.params["public"],g.derivedAlgorithm,g.extractable,g.usages,e);break;default:throw new c;}}};case "AES-KW":return{process:function(a,g,e){switch(a){case f:n.symKeyGen(g.algorithm,
g.extractable,g.usages,e);break;default:throw new c;}}}}}function b(a){this.name="InvalidAlgorithmError";this.message=a||"Invalid algorithm"}function c(a){this.name="NotSupportedError";this.message=a||"Not supported"}function d(a){this.name="NotImplementedError";this.message=a||"Not implemented yet"}function l(g,f){var e,m,v;if("string"==typeof f)return l(g,{name:f});if(f&&"object"==typeof f){e=f.name;if("string"!=typeof e)throw new b("Algorithm has bad or missing name");m=a(g,e);if(void 0===m)throw new b('Invalid algorithm "'+
f.name+'"');v=f.params;if(void 0!==v&&(null===v||"object"!=typeof v))throw new b('Invalid algorithm parameters for "'+f.name+'", expecting undefined or an object');return{algorithm:{name:e,params:v},process:m.process}}throw new b("Invalid algorithm : "+JSON.stringify(f));}function o(a){var g=r[a];if(void 0===g)throw new SyntaxError('Invalid key format "'+a+'"');return g}function s(a){return!Array.isArray(a)?[]:a.map(function(a){var g=H[a];if(void 0===g)throw new SyntaxError('Invalid key usage "'+
a+'"');return g})}function w(a){if(a&&"object"==typeof a&&1<=a.handle)return a.handle;throw new SyntaxError("Invalid key");}function ba(a){if("string"==typeof a&&0<=a.length||a&&"object"==typeof a&&a.buffer&&0<=a.byteLength)return a;throw new SyntaxError("Invalid buffer or key data");}function D(a,p,q,n){a._listeners=[];a._result=null;a._operation=p;a._args=q;a._info=n;switch(p){case i:a._name="DIGEST";break;case j:a._name="ENCRYPT";break;case e:a._name="DECRYPT";break;case g:a._name="SIGN";break;
case h:a._name="VERIFY";break;case y:a._name="IMPORT_KEY";break;case k:a._name="EXPORT_KEY";break;case f:a._name="GENERATE_KEY";break;case u:a._name="DERIVE_KEY";break;case G:a._name="WRAP_KEY";break;case m:a._name="UNWRAP_KEY";break;case I:a._name="GET_KEY";break;case t:a._name="KEY_INFO"}}function z(a,g,f){D(this,a,g,f)}function q(a,g,f){D(this,a,g,f)}function F(a){function q(a,g){return"object"==typeof g&&g&&g.buffer&&g.byteLength?"["+g.byteLength+" bytes]":"string"==typeof g&&"data"==a?"["+g.length+
" chars]":g}function r(g,f){var e,v=a._listeners.slice(0),m=v.length,h;for(e=0;e<m;++e)h=v[e],h.type==g&&h.callback(f)}function z(a){var g={handle:a.handle,extractable:a.extractable,algorithm:a.algorithm,name:a.name};switch(a.type){case n.SECRET:g.type="secret";break;case n.PUBLIC:g.type="public";break;case n.PRIVATE:g.type="private"}g.keyUsage=a.usage.map(function(a){switch(a){case n.ENCRYPT:return"encrypt";case n.DECRYPT:return"decrypt";case n.SIGN:return"sign";case n.VERIFY:return"verify";case n.DERIVE:return"derive";
case n.WRAP:return"wrap";case n.UNWRAP:return"unwrap"}});g.keyUsages=g.keyUsage;return g}function v(a){switch(b){case i:case j:case e:case g:case k:case G:return a.data instanceof ArrayBuffer?a.data:Ib(a.data,!0);case h:return a.verified?!0:!1;case y:case m:case f:case u:return a.key?z(a.key):{publicKey:z(a.publickey),privateKey:z(a.privatekey)};case I:case t:return a.key?z(a.key):null;default:throw new d;}}function Ta(a){p.error("FAILED "+ja+"\n"+a);T.error=a;r("error",T)}var ja=a._name,b=a._operation,
J=a._info,ga=a._args,T={target:a},c=nrdp.mono();Sa&&p.trace("STARTING "+ja+": "+JSON.stringify(ga,q));a._result=null;try{J.process(b,ga,function(g){try{p.trace("FINISHED "+ja+" IN "+(nrdp.mono()-c)+" ms: ");Sa&&p.trace(JSON.stringify(g,q));if(!g.success)throw Error("WebCrypto operation "+ja+" failed");a._result=v(g);Sa&&p.trace("RESULT: "+JSON.stringify(a._result,q));r("complete",T)}catch(f){Ta(f)}})}catch(H){ia(function(){Ta(H)},0)}return a}var n=nrdp.webcrypto,p=new $("CRYPTO"),i=1,j=2,e=3,g=4,
h=5,y=101,k=102,f=103,u=104,G=105,m=106,I=500,t=600,r={raw:n.RAW,pkcs8:n.PKCS8,spki:n.SPKI,jwk:n.JWK},H={encrypt:n.ENCRYPT,decrypt:n.DECRYPT,sign:n.SIGN,verify:n.VERIFY,derive:n.DERIVE,wrap:n.WRAP,unwrap:n.UNWRAP};b.prototype=Error();b.prototype.constructor=b;c.prototype=Error();c.prototype.constructor=c;d.prototype=Error();d.prototype.constructor=d;z.prototype.constructor=z;z.prototype.addEventListener=function(a,g){this._listeners.push({type:a,callback:g})};z.prototype.removeEventListener=function(a,
g){this._listeners=this._listeners.filter(function(f){return!(f.type==a&&f.callback==g)})};Object.defineProperties(z.prototype,{result:{enumerable:!0,get:function(){return this._result}},onerror:{enumerable:!0,configurable:!1,set:function(a){this.addEventListener("error",a)}},oncomplete:{enumerable:!0,configurable:!0,set:function(a){this.addEventListener("complete",a)}}});q.prototype=new z;q.prototype.constructor=q;q.prototype.process=function(){throw new d("process not supported on CryptoOperation");
};q.prototype.finish=function(){throw new d("finish not supported on CryptoOperation");};q.prototype.abort=function(){throw new d("abort not supported on CryptoOperation");};Object.defineProperties(q.prototype,{algorithm:{enumerable:!0,get:function(){return this._args.algorithm}},key:{enumerable:!0,get:function(){return this._args.key||null}},onabort:{enumerable:!0,configurable:!1,set:function(a){this.addEventListener("abort",a)}},onprogress:{enumerable:!0,configurable:!1,set:function(a){this.addEventListener("progress",
a)}}});Y={getRandomValues:function(a){nrdp.random(a);return a},getKeyByName:function(g){var f=I,e=a(f);return F(new z(f,{name:g},e))},getKeyInfo:function(g){var f=t,e=a(f);return F(new z(f,{handle:g},e))},digest:function(a,g){var f=i,e=l(f,a),v={algorithm:a,buffer:ba(g)};return F(new q(f,v,e))},encrypt:function(a,g,f){var e=j,v=l(e,a),a={algorithm:a,key:w(g),buffer:ba(f)};return F(new q(e,a,v))},decrypt:function(a,g,f){var m=e,v=l(m,a),a={algorithm:a,key:w(g),buffer:ba(f)};return F(new q(m,a,v))},
sign:function(a,f,e){var m=g,v=l(m,a),a={algorithm:a,key:w(f),buffer:ba(e)};return F(new q(m,a,v))},verify:function(a,g,f,e){var v=h,m=l(v,a),a={algorithm:a,key:w(g),signature:ba(f),buffer:ba(e)};return F(new q(v,a,m))},importKey:function(a,g,f,e,m){var h=y,k=l(h,f),a={format:o(a),buffer:ba(g),algorithm:f,extractable:e?!0:!1,usages:s(m)};return F(new z(h,a,k))},exportKey:function(g,f){var e=k,m=a(e),v={format:o(g),key:w(f)};return F(new z(e,v,m))},generateKey:function(a,g,e){var m=f,v=l(m,a),a={algorithm:a,
extractable:g?!0:!1,usages:s(e)};return F(new z(m,a,v))},deriveKey:function(a,g,f,e,m){var h=u,k=l(h,a),a={algorithm:a,key:w(g),derivedAlgorithm:f,extractable:e,usages:s(m)};return F(new z(h,a,k))},wrapKey:function(a,g,f){var e=G,m=l(e,f),a={algorithm:f,key:w(a),wrappingKey:w(g)};return F(new z(e,a,m))},unwrapKey:function(g,f,e,h,v,k){var i=m,p=a(i),g={algorithm:f,buffer:ba(g),key:w(e),extractable:h?!0:!1,usages:s(v),format:k};return F(new z(i,g,p))}};Y.subtle=Y})();var C=qd,M=function(a){return Ib(a,
!0)},da=Y.subtle,aa=function(a,b){if(!b||"utf-8"===b)return ub(a);throw Error("unsupported encoding");},W=function(a,b){if(!b||"utf-8"===b)return Jb(a);throw Error("unsupported encoding");},ic,jc;(function(){function a(b,c){c||(c=b.length);return b.reduce(function(a,b,z){return z<c?a+String.fromCharCode(b):a},"")}for(var b={},c=0;256>c;++c){var d=a([c]);b[d]=c}for(var l=Object.keys(b).length,o=[],c=0;256>c;++c)o[c]=[c];ic=function(c){function w(a,g){for(;0<g;){if(p>=n.length)return!1;if(g>i){var e=
a,e=e>>>g-i;n[p]|=e&255;g-=i;i=8;++p}else g<=i&&(e=a,e<<=i-g,e&=255,e>>>=8-i,n[p]|=e&255,i-=g,g=0,0==i&&(i=8,++p))}return!0}var d={},D;for(D in b)d[D]=b[D];for(var z=l,q=[],F=8,n=new Uint8Array(c.length),p=0,i=8,j=0;j<c.length;++j){var e=c[j];q.push(e);D=a(q);var g=d[D];if(!g){q=a(q,q.length-1);if(!w(d[q],F))return null;0!=z>>F&&++F;d[D]=z++;q=[e]}}return 0<q.length&&(D=a(q),g=d[D],!w(g,F))?null:n.subarray(0,8>i?p+1:p)};jc=function(a){for(var b=o.slice(),c=0,D=0,z=8,q=new Uint8Array(Math.ceil(1.5*
a.length)),d=0,n=0,p=[];c<a.length&&!(8*(a.length-c)-D<z);){for(var i=n=0;i<z;){var j=Math.min(z-i,8-D),e=a[c],e=e<<D,e=e&255,e=e>>>8-j,i=i+j,D=D+j;8==D&&(D=0,++c);n|=(e&255)<<z-i}i=b[n];0==p.length?++z:(i?p.push(i[0]):p.push(p[0]),b[b.length]=p,p=[],b.length==1<<z&&++z,i||(i=b[n]));n=d+i.length;n>=q.length&&(j=new Uint8Array(Math.ceil(1.5*n)),j.set(q),q=j);q.set(i,d);d=n;p=p.concat(i)}return q.subarray(0,d)}})();var ha={};(function(){function a(z){if(!(this instanceof a))return new a(z);for(var q=
0,c=s.length;q<c;q++)this[s[q]]="";this.bufferCheckPosition=ha.MAX_BUFFER_LENGTH;this.q=this.c=this.p="";this.opt=z||{};this.closed=this.closedRoot=this.sawRoot=!1;this.tag=this.error=null;this.state=w.BEGIN;this.stack=new o;this.index=this.position=this.column=0;this.line=1;this.slashed=!1;this.unicodeI=0;this.unicodeS=null;b(this,"onready")}function b(a,q,c){if(a[q])a[q](c)}function c(a,q){var d=a.opt,n=a.textNode;d.trim&&(n=n.trim());d.normalize&&(n=n.replace(/\s+/g," "));a.textNode=n;a.textNode&&
b(a,q?q:"onvalue",a.textNode);a.textNode=""}function d(a,q){c(a);q+="\nLine: "+a.line+"\nColumn: "+a.column+"\nChar: "+a.c;q=Error(q);a.error=q;b(a,"onerror",q);return a}function l(z){z.state!==w.VALUE&&d(z,"Unexpected end");c(z);z.c="";z.closed=!0;b(z,"onend");a.call(z,z.opt);return z}var o=Array;ha.parser=function(b){return new a(b)};ha.CParser=a;ha.MAX_BUFFER_LENGTH=65536;ha.DEBUG=!1;ha.INFO=!1;ha.EVENTS="value,string,key,openobject,closeobject,openarray,closearray,error,end,ready".split(",");
var s=["textNode","numberNode"];ha.EVENTS.filter(function(a){return"error"!==a&&"end"!==a});var w=0;ha.STATE={BEGIN:w++,VALUE:w++,OPEN_OBJECT:w++,CLOSE_OBJECT:w++,OPEN_ARRAY:w++,CLOSE_ARRAY:w++,TEXT_ESCAPE:w++,STRING:w++,BACKSLASH:w++,END:w++,OPEN_KEY:w++,CLOSE_KEY:w++,TRUE:w++,TRUE2:w++,TRUE3:w++,FALSE:w++,FALSE2:w++,FALSE3:w++,FALSE4:w++,NULL:w++,NULL2:w++,NULL3:w++,NUMBER_DECIMAL_POINT:w++,NUMBER_DIGIT:w++};for(var ba in ha.STATE)ha.STATE[ha.STATE[ba]]=ba;w=ha.STATE;Object.getPrototypeOf||(Object.getPrototypeOf=
function(a){return a.__proto__});var D=/[\\"\n]/g;/*"*/a.prototype={end:function(){l(this)},write:function(a){if(this.error)throw this.error;if(this.closed)return d(this,"Cannot write after close. Assign an onready handler.");if(null===a)return l(this);for(var q=a[0],F=this.p;q;){F=q;this.c=q=a.charAt(this.index++);F!==q?this.p=F:F=this.p;if(!q)break;this.position++;"\n"===q?(this.line++,this.column=0):this.column++;switch(this.state){case w.BEGIN:"{"===q?this.state=w.OPEN_OBJECT:"["===q?this.state=w.OPEN_ARRAY:
"\r"!==q&&"\n"!==q&&" "!==q&&"\t"!==q&&d(this,"Non-whitespace before {[.");continue;case w.OPEN_KEY:case w.OPEN_OBJECT:if("\r"===q||"\n"===q||" "===q||"\t"===q)continue;if(this.state===w.OPEN_KEY)this.stack.push(w.CLOSE_KEY);else if("}"===q){b(this,"onopenobject");b(this,"oncloseobject");this.state=this.stack.pop()||w.VALUE;continue}else this.stack.push(w.CLOSE_OBJECT);'"'===q?this.state=w.STRING:d(this,'Malformed object key should start with "');continue;case w.CLOSE_KEY:case w.CLOSE_OBJECT:if("\r"===
q||"\n"===q||" "===q||"\t"===q)continue;":"===q?(this.state===w.CLOSE_OBJECT?(this.stack.push(w.CLOSE_OBJECT),c(this,"onopenobject")):c(this,"onkey"),this.state=w.VALUE):"}"===q?(c(this),b(this,"oncloseobject",void 0),this.state=this.stack.pop()||w.VALUE):","===q?(this.state===w.CLOSE_OBJECT&&this.stack.push(w.CLOSE_OBJECT),c(this),this.state=w.OPEN_KEY):d(this,"Bad object");continue;case w.OPEN_ARRAY:case w.VALUE:if("\r"===q||"\n"===q||" "===q||"\t"===q)continue;if(this.state===w.OPEN_ARRAY)if(b(this,
"onopenarray"),this.state=w.VALUE,"]"===q){b(this,"onclosearray");this.state=this.stack.pop()||w.VALUE;continue}else this.stack.push(w.CLOSE_ARRAY);'"'===q?this.state=w.STRING:"{"===q?this.state=w.OPEN_OBJECT:"["===q?this.state=w.OPEN_ARRAY:"t"===q?this.state=w.TRUE:"f"===q?this.state=w.FALSE:"n"===q?this.state=w.NULL:"-"===q?this.numberNode+=q:"0"===q?(this.numberNode+=q,this.state=w.NUMBER_DIGIT):-1!=="123456789".indexOf(q)?(this.numberNode+=q,this.state=w.NUMBER_DIGIT):d(this,"Bad value");continue;
case w.CLOSE_ARRAY:if(","===q)this.stack.push(w.CLOSE_ARRAY),c(this,"onvalue"),this.state=w.VALUE;else if("]"===q)c(this),b(this,"onclosearray",void 0),this.state=this.stack.pop()||w.VALUE;else if("\r"===q||"\n"===q||" "===q||"\t"===q)continue;else d(this,"Bad array");continue;case w.STRING:var F=this.index-1,n=this.slashed,p=this.unicodeI;a:for(;;){if(ha.DEBUG)for(;0<p;)if(this.unicodeS+=q,q=a.charAt(this.index++),4===p?(this.textNode+=String.fromCharCode(parseInt(this.unicodeS,16)),p=0,F=this.index-
1):p++,!q)break a;if('"'===q&&!n){this.state=this.stack.pop()||w.VALUE;(this.textNode+=a.substring(F,this.index-1))||b(this,"onvalue","");break}if("\\"===q&&!n&&(n=!0,this.textNode+=a.substring(F,this.index-1),q=a.charAt(this.index++),!q))break;if(n)if(n=!1,"n"===q?this.textNode+="\n":"r"===q?this.textNode+="\r":"t"===q?this.textNode+="\t":"f"===q?this.textNode+="\u000c":"b"===q?this.textNode+="\u0008":"u"===q?(p=1,this.unicodeS=""):this.textNode+=q,q=a.charAt(this.index++),F=this.index-1,q)continue;
else break;D.lastIndex=this.index;var i=D.exec(a);if(null===i){this.index=a.length+1;this.textNode+=a.substring(F,this.index-1);break}this.index=i.index+1;q=a.charAt(i.index);if(!q){this.textNode+=a.substring(F,this.index-1);break}}this.slashed=n;this.unicodeI=p;continue;case w.TRUE:if(""===q)continue;"r"===q?this.state=w.TRUE2:d(this,"Invalid true started with t"+q);continue;case w.TRUE2:if(""===q)continue;"u"===q?this.state=w.TRUE3:d(this,"Invalid true started with tr"+q);continue;case w.TRUE3:if(""===
q)continue;"e"===q?(b(this,"onvalue",!0),this.state=this.stack.pop()||w.VALUE):d(this,"Invalid true started with tru"+q);continue;case w.FALSE:if(""===q)continue;"a"===q?this.state=w.FALSE2:d(this,"Invalid false started with f"+q);continue;case w.FALSE2:if(""===q)continue;"l"===q?this.state=w.FALSE3:d(this,"Invalid false started with fa"+q);continue;case w.FALSE3:if(""===q)continue;"s"===q?this.state=w.FALSE4:d(this,"Invalid false started with fal"+q);continue;case w.FALSE4:if(""===q)continue;"e"===
q?(b(this,"onvalue",!1),this.state=this.stack.pop()||w.VALUE):d(this,"Invalid false started with fals"+q);continue;case w.NULL:if(""===q)continue;"u"===q?this.state=w.NULL2:d(this,"Invalid null started with n"+q);continue;case w.NULL2:if(""===q)continue;"l"===q?this.state=w.NULL3:d(this,"Invalid null started with nu"+q);continue;case w.NULL3:if(""===q)continue;"l"===q?(b(this,"onvalue",null),this.state=this.stack.pop()||w.VALUE):d(this,"Invalid null started with nul"+q);continue;case w.NUMBER_DECIMAL_POINT:"."===
q?(this.numberNode+=q,this.state=w.NUMBER_DIGIT):d(this,"Leading zero not followed by .");continue;case w.NUMBER_DIGIT:-1!=="0123456789".indexOf(q)?this.numberNode+=q:"."===q?(-1!==this.numberNode.indexOf(".")&&d(this,"Invalid number has two dots"),this.numberNode+=q):"e"===q||"E"===q?((-1!==this.numberNode.indexOf("e")||-1!==this.numberNode.indexOf("E"))&&d(this,"Invalid number has two exponential"),this.numberNode+=q):"+"===q||"-"===q?("e"===F||"E"===F||d(this,"Invalid symbol in number"),this.numberNode+=
q):(this.numberNode&&b(this,"onvalue",parseFloat(this.numberNode)),this.numberNode="",this.index--,this.state=this.stack.pop()||w.VALUE);continue;default:d(this,"Unknown state: "+this.state)}}if(this.position>=this.bufferCheckPosition){a=Math.max(ha.MAX_BUFFER_LENGTH,10);F=q=0;for(n=s.length;F<n;F++){p=this[s[F]].length;if(p>a)switch(s[F]){case "text":break;default:d(this,"Max buffer length exceeded: "+s[F])}q=Math.max(q,p)}this.bufferCheckPosition=ha.MAX_BUFFER_LENGTH-q+this.position}return this},
resume:function(){this.error=null;return this},close:function(){return this.write(null)}}})();var S="utf-8",P=9007199254740992,b={FAIL:1,TRANSIENT_FAILURE:2,ENTITY_REAUTH:3,USER_REAUTH:4,KEYX_REQUIRED:5,ENTITYDATA_REAUTH:6,USERDATA_REAUTH:7,EXPIRED:8,REPLAYED:9,SSOTOKEN_REJECTED:10};Object.freeze(b);var x={isObjectLiteral:function(a){return null!==a&&"object"===typeof a&&a.constructor===Object}};x.extendDeep=function(){var a=arguments[0],b=1,c=arguments.length,d=!1,l,o,s,w;"boolean"===typeof a&&(d=
a,a=arguments[1],b=2);for(;b<c;b++)if(null!=(l=arguments[b]))for(o in l)d&&o in a||(w=l[o],a!==w&&void 0!==w&&(s=a[o],a[o]=null!==s&&null!==w&&"object"===typeof s&&"object"===typeof w?x.extendDeep(d,{},s,w):w));return a};(function(){function a(b,c){return function(){var a=b.base,d;b.base=c;d=b.apply(this,arguments);b.base=a;return d}}function b(c,z,q){var d,n,p,i,q=q||w;i=!!q.extendAll;for(d in z)if(n=z.__lookupGetter__(d),p=z.__lookupSetter__(d),n||p)n&&c.__defineGetter__(d,n),p&&c.__defineSetter__(d,
p);else{n=z[d];p=c[d];if("function"===typeof n&&"function"===typeof p&&n!==p)n.base!==ba&&(n=a(n,p)),n.base=p;else if((i||q[d])&&x.isObjectLiteral(n)&&x.isObjectLiteral(p))n=x.extendDeep({},p,n);c[d]=n}}function c(){var a=Array.prototype.slice,b=a.call(arguments,1);return this.extend({init:function F(){var n=a.call(arguments,0);F.base.apply(this,b.concat(n))}})}function d(a,c){var q=new this(s);b(q,a,c);return o(q)}function l(a,c){b(this.prototype,a,c);return this}function o(a){var b=function(){var a=
this.init;a&&arguments[0]!==s&&a.apply(this,arguments)};a&&(b.prototype=a);b.prototype.constructor=b;b.extend=d;b.bind=c;b.mixin=l;return b}var s={},w={actions:!0},ba=function(){};Function.prototype.base=ba;x.Class={create:o,mixin:b,extend:function(a,b){var q=o();q.prototype=new a;return q.extend(b)}};x.mixin=function(){x.log&&x.log.warn("util.mixin is deprecated.  Please change your code to use util.Class.mixin()");b.apply(null,arguments)}})();(function(){function a(b,c){return function(){var a=
b.base,d;b.base=c;d=b.apply(this,arguments);b.base=a;return d}}function b(c,d,q){var F,n,p,i,q=q||w;i=!!q.extendAll;for(F in d)if(n=d.__lookupGetter__(F),p=d.__lookupSetter__(F),n||p)n&&c.__defineGetter__(F,n),p&&c.__defineSetter__(F,p);else{n=d[F];p=c[F];if("function"===typeof n&&"function"===typeof p&&n!==p)n.base!==ba&&(n=a(n,p)),n.base=p;else if((i||q[F])&&x.isObjectLiteral(n)&&x.isObjectLiteral(p))n=x.extendDeep({},p,n);c[F]=n}}function c(){var a=Array.prototype.slice,b=a.call(arguments,1);return this.extend({init:function F(){var n=
a.call(arguments,0);F.base.apply(this,b.concat(n))}})}function d(a,c){var q=new this(s);b(q,a,c);return o(q)}function l(a,c){b(this.prototype,a,c);return this}function o(a){var b=function(){var a=this.init;a&&arguments[0]!==s&&a.apply(this,arguments)};a&&(b.prototype=a);b.prototype.constructor=b;b.extend=d;b.bind=c;b.mixin=l;return b}var s={},w={actions:!0},ba=function(){};Function.prototype.base=ba;x.Class={create:o,mixin:b,extend:function(a,b){var q=o();q.prototype=new a;return q.extend(b)}};x.mixin=
function(){x.log&&x.log.warn("util.mixin is deprecated.  Please change your code to use util.Class.mixin()");b.apply(null,arguments)}})();var db;(function(){function a(b){if(0===Object.keys(b._waiters).length)return 0;for(var c=b._nextWaiter==P?1:b._nextWaiter+1;!b._waiters[c];)c=c==P?1:c+1;return c}db=x.Class.create({init:function(){Object.defineProperties(this,{_queue:{value:[],writable:!1,enumerable:!1,configurable:!1},_waiters:{value:{},writable:!1,enumerable:!1,configurable:!1},_nextWaiter:{value:0,
writable:!0,enumerable:!1,configurable:!1},_lastWaiter:{value:0,writable:!0,enumerable:!1,configurable:!1}})},cancel:function(b){if(this._waiters[b]){var c=this._waiters[b];delete this._waiters[b];b==this._nextWaiter&&(this._nextWaiter=a(this));c.call(this,void 0)}},cancelAll:function(){for(;0!==this._nextWaiter;)this.cancel(this._nextWaiter)},poll:function(b,c){var l=this,o=this._lastWaiter==P?1:this._lastWaiter+1;this._lastWaiter=o;d(c,function(){if(0<this._queue.length)return this._queue.unshift();
var d;-1!=b&&(d=ia(function(){delete l._waiters[o];o==l._nextWaiter&&(l._nextWaiter=a(l));c.timeout()},b));this._waiters[o]=function(a){cb(d);ia(function(){c.result(a)},0)};this._nextWaiter||(this._nextWaiter=o)},l);return o},add:function(b){if(this._nextWaiter){var c=this._waiters[this._nextWaiter];delete this._waiters[this._nextWaiter];this._nextWaiter=a(this);c.call(this,b)}else this._queue.push(b)}})})();var kc;(function(){var a=0-P;kc=x.Class.create({nextBoolean:function(){var a=new Uint8Array(1);
Y.getRandomValues(a);return a[0]&1?!0:!1},nextInt:function(a){if(null!==a&&void 0!==a){if("number"!==typeof a)throw new TypeError("n must be of type number");if(1>a)throw new RangeError("n must be greater than zero");var a=a-1,b=new Uint8Array(4);Y.getRandomValues(b);return Math.floor(((b[3]&127)<<24|b[2]<<16|b[1]<<8|b[0])/2147483648*(a-0+1)+0)}a=new Uint8Array(4);Y.getRandomValues(a);b=(a[3]&127)<<24|a[2]<<16|a[1]<<8|a[0];return a[3]&128?-b:b},nextLong:function(){for(var b=a;b==a;){b=new Uint8Array(7);
Y.getRandomValues(b);var c=16777216*((b[6]&31)<<24|b[5]<<16|b[4]<<8|b[3])+(b[2]<<16|b[1]<<8|b[0]),b=b[6]&128?-c-1:c}return b},nextBytes:function(a){Y.getRandomValues(a)}})})();var Kb;(function(){function a(b){return b==P?1:b+1}Kb=x.Class.create({init:function(){Object.defineProperties(this,{_readers:{value:{},writable:!1,enumerable:!1,configurable:!1},_waitingReaders:{value:{},writable:!1,enumerable:!1,configurable:!1},_writer:{value:null,writable:!0,enumerable:!1,configurable:!1},_waitingWriters:{value:{},
writable:!1,enumerable:!1,configurable:!1},_nextReader:{value:0,writable:!0,enumerable:!1,configurable:!1},_nextWriter:{value:0,writable:!0,enumerable:!1,configurable:!1},_lastNumber:{value:0,writable:!0,enumerable:!1,configurable:!1}})},cancel:function(b){var c;if(this._readers[b]&&(this._readers[b].call(this,void 0),delete this._readers[b],b==this._nextReader)){if(0===Object.keys(this._readers).length){this._nextReader=0;return}for(c=a(b);!this._readers[c];)c=a(c);this._nextReader=c}if(this._writers[b]&&
(this._writers[b].call(this,void 0),delete this._readers[b],b==this._nextWriter))if(0===Object.keys(this._writers).length)this._nextWriter=0;else{for(c=a(b);!this._writers[c];)c=a(c);this._nextWriter=c}},cancelAll:function(){for(;0!==this._nextWriter;)this.cancel(this._nextWriter);for(;0!==this._nextReader;)this.cancel(this._nextReader)},readLock:function(b,c){var l=this,o=a(this._lastNumber);this._lastNumber=o;d(c,function(){if(!this._writer&&0===Object.keys(this._waitingWriters).length)return this._readers[o]=
!0,o;var a;-1!=b&&(a=ia(function(){delete l._waitingReaders[o];c.timeout()},b));this._waitingReaders[o]=function(){cb(a);this._readers[o]=!0;ia(function(){c.result(o)},0)};this._nextReader||(this._nextReader=o)},l);return o},writeLock:function(b,c){var l=this,o=a(this._lastNumber);this._lastNumber=o;d(c,function(){if(0===Object.keys(this._readers).length&&0===Object.keys(this._waitingReaders).length&&!this._writer)return this._writer=o;var a;-1!=b&&(a=ia(function(){delete l._waitingWriters[o];c.timeout()},
b));this._waitingWriters[o]=function(){cb(a);this._writer=o;ia(function(){c.result(o)},0)};this._nextWriter||(this._nextWriter=o)},l);return o},unlock:function(b){var c;if(b==this._writer)this._writer=null;else{if(!this._readers[b])throw new o("There is no reader with ticket number "+b+".");delete this._readers[b]}if(this._nextWriter){if(!(0<Object.keys(this._readers).length))if(c=this._nextWriter,this._waitingWriters[c].call(this),delete this._waitingWriters[c],0===Object.keys(this._waitingWriters).length)this._nextWriter=
0;else{for(c=a(b);!this._waitingWriters[c];)c=a(c);this._nextWriter=c}}else{for(c=this._nextReader;0<Object.keys(this._waitingReaders).length;c=a(b))this._waitingReaders[c]&&(this._waitingReaders[c].call(this),delete this._waitingReaders[c]);this._nextReader=0}}})})();x.Class.mixin(a,{JSON_PARSE_ERROR:new a(0,b.FAIL,"Error parsing JSON."),JSON_ENCODE_ERROR:new a(1,b.FAIL,"Error encoding JSON."),ENVELOPE_HASH_MISMATCH:new a(2,b.FAIL,"Computed hash does not match envelope hash."),INVALID_PUBLIC_KEY:new a(3,
b.FAIL,"Invalid public key provided."),INVALID_PRIVATE_KEY:new a(4,b.FAIL,"Invalid private key provided."),PLAINTEXT_ILLEGAL_BLOCK_SIZE:new a(5,b.FAIL,"Plaintext is not a multiple of the block size."),PLAINTEXT_BAD_PADDING:new a(6,b.FAIL,"Plaintext contains incorrect padding."),CIPHERTEXT_ILLEGAL_BLOCK_SIZE:new a(7,b.FAIL,"Ciphertext is not a multiple of the block size."),CIPHERTEXT_BAD_PADDING:new a(8,b.FAIL,"Ciphertext contains incorrect padding."),ENCRYPT_NOT_SUPPORTED:new a(9,b.FAIL,"Encryption not supported."),
DECRYPT_NOT_SUPPORTED:new a(10,b.FAIL,"Decryption not supported."),ENVELOPE_KEY_ID_MISMATCH:new a(11,b.FAIL,"Encryption envelope key ID does not match crypto context key ID."),ENVELOPE_PARSE_ERROR:new a(12,b.FAIL,"Error parsing encryption envelope."),ENVELOPE_ENCODE_ERROR:new a(13,b.FAIL,"Error encoding encryption envelope."),SIGN_NOT_SUPPORTED:new a(14,b.FAIL,"Sign not supported."),VERIFY_NOT_SUPPORTED:new a(15,b.FAIL,"Verify not suppoprted."),SIGNATURE_ERROR:new a(16,b.FAIL,"Signature not initialized or unable to process data/signature."),
HMAC_ERROR:new a(17,b.FAIL,"Error computing HMAC."),ENCRYPT_ERROR:new a(18,b.FAIL,"Error encrypting plaintext."),DECRYPT_ERROR:new a(19,b.FAIL,"Error decrypting ciphertext."),INSUFFICIENT_CIPHERTEXT:new a(20,b.FAIL,"Insufficient ciphertext for decryption."),SESSION_KEY_CREATION_FAILURE:new a(21,b.FAIL,"Error when creating session keys."),ASN1_PARSE_ERROR:new a(22,b.FAIL,"Error parsing ASN.1."),ASN1_ENCODE_ERROR:new a(23,b.FAIL,"Error encoding ASN.1."),INVALID_SYMMETRIC_KEY:new a(24,b.FAIL,"Invalid symmetric key provided."),
INVALID_ENCRYPTION_KEY:new a(25,b.FAIL,"Invalid encryption key."),INVALID_HMAC_KEY:new a(26,b.FAIL,"Invalid HMAC key."),WRAP_NOT_SUPPORTED:new a(27,b.FAIL,"Wrap not supported."),UNWRAP_NOT_SUPPORTED:new a(28,b.FAIL,"Unwrap not supported."),UNIDENTIFIED_JWK_TYPE:new a(29,b.FAIL,"Unidentified JSON web key type."),UNIDENTIFIED_JWK_USAGE:new a(30,b.FAIL,"Unidentified JSON web key usage."),UNIDENTIFIED_JWK_ALGORITHM:new a(31,b.FAIL,"Unidentified JSON web key algorithm."),WRAP_ERROR:new a(32,b.FAIL,"Error wrapping plaintext."),
UNWRAP_ERROR:new a(33,b.FAIL,"Error unwrapping ciphertext."),INVALID_JWK:new a(34,b.FAIL,"Invalid JSON web key."),INVALID_JWK_KEYDATA:new a(35,b.FAIL,"Invalid JSON web key keydata."),UNSUPPORTED_JWK_ALGORITHM:new a(36,b.FAIL,"Unsupported JSON web key algorithm."),WRAP_KEY_CREATION_FAILURE:new a(37,b.FAIL,"Error when creating wrapping key."),INVALID_WRAP_CIPHERTEXT:new a(38,b.FAIL,"Invalid wrap ciphertext."),UNSUPPORTED_JWE_ALGORITHM:new a(39,b.FAIL,"Unsupported JSON web encryption algorithm."),JWE_ENCODE_ERROR:new a(40,
b.FAIL,"Error encoding JSON web encryption header."),JWE_PARSE_ERROR:new a(41,b.FAIL,"Error parsing JSON web encryption header."),INVALID_ALGORITHM_PARAMS:new a(42,b.FAIL,"Invalid algorithm parameters."),JWE_ALGORITHM_MISMATCH:new a(43,b.FAIL,"JSON web encryption header algorithms mismatch."),KEY_IMPORT_ERROR:new a(44,b.FAIL,"Error importing key."),KEY_EXPORT_ERROR:new a(45,b.FAIL,"Error exporting key."),DIGEST_ERROR:new a(46,b.FAIL,"Error in digest."),UNSUPPORTED_KEY:new a(47,b.FAIL,"Unsupported key type or algorithm."),
UNSUPPORTED_JWE_SERIALIZATION:new a(48,b.FAIL,"Unsupported JSON web encryption serialization."),XML_PARSE_ERROR:new a(49,b.FAIL,"Error parsing XML."),XML_ENCODE_ERROR:new a(50,b.FAIL,"Error encoding XML."),INVALID_WRAPPING_KEY:new a(51,b.FAIL,"Invalid wrapping key."),MASTERTOKEN_UNTRUSTED:new a(1E3,b.ENTITY_REAUTH,"Master token is not trusted."),MASTERTOKEN_KEY_CREATION_ERROR:new a(1001,b.ENTITY_REAUTH,"Unable to construct symmetric keys from master token."),MASTERTOKEN_EXPIRES_BEFORE_RENEWAL:new a(1002,
b.ENTITY_REAUTH,"Master token expiration timestamp is before the renewal window opens."),MASTERTOKEN_SESSIONDATA_MISSING:new a(1003,b.ENTITY_REAUTH,"No master token session data found."),MASTERTOKEN_SEQUENCE_NUMBER_OUT_OF_RANGE:new a(1004,b.ENTITY_REAUTH,"Master token sequence number is out of range."),MASTERTOKEN_SERIAL_NUMBER_OUT_OF_RANGE:new a(1005,b.ENTITY_REAUTH,"Master token serial number is out of range."),MASTERTOKEN_TOKENDATA_INVALID:new a(1006,b.ENTITY_REAUTH,"Invalid master token data."),
MASTERTOKEN_SIGNATURE_INVALID:new a(1007,b.ENTITY_REAUTH,"Invalid master token signature."),MASTERTOKEN_SESSIONDATA_INVALID:new a(1008,b.ENTITY_REAUTH,"Invalid master token session data."),MASTERTOKEN_SEQUENCE_NUMBER_OUT_OF_SYNC:new a(1009,b.ENTITY_REAUTH,"Master token sequence number does not have the expected value."),USERIDTOKEN_MASTERTOKEN_MISMATCH:new a(2E3,b.USER_REAUTH,"User ID token master token serial number does not match master token serial number."),USERIDTOKEN_NOT_DECRYPTED:new a(2001,
b.USER_REAUTH,"User ID token is not decrypted or verified."),USERIDTOKEN_MASTERTOKEN_NULL:new a(2002,b.USER_REAUTH,"User ID token requires a master token."),USERIDTOKEN_EXPIRES_BEFORE_RENEWAL:new a(2003,b.USER_REAUTH,"User ID token expiration timestamp is before the renewal window opens."),USERIDTOKEN_USERDATA_MISSING:new a(2004,b.USER_REAUTH,"No user ID token user data found."),USERIDTOKEN_MASTERTOKEN_NOT_FOUND:new a(2005,b.USER_REAUTH,"User ID token is bound to an unknown master token."),USERIDTOKEN_MASTERTOKEN_SERIAL_NUMBER_OUT_OF_RANGE:new a(2006,
b.USER_REAUTH,"User ID token master token serial number is out of range."),USERIDTOKEN_SERIAL_NUMBER_OUT_OF_RANGE:new a(2007,b.USER_REAUTH,"User ID token serial number is out of range."),USERIDTOKEN_TOKENDATA_INVALID:new a(2008,b.USER_REAUTH,"Invalid user ID token data."),USERIDTOKEN_SIGNATURE_INVALID:new a(2009,b.USER_REAUTH,"Invalid user ID token signature."),USERIDTOKEN_USERDATA_INVALID:new a(2010,b.USER_REAUTH,"Invalid user ID token user data."),USERIDTOKEN_IDENTITY_INVALID:new a(2011,b.USER_REAUTH,
"Invalid user ID token user identity."),USERIDTOKEN_IDENTITY_NOT_ASSOCIATED_WITH_ENTITY:new a(2012,b.USER_REAUTH,"The entity is not associated with the user."),USERIDTOKEN_IDENTITY_NOT_FOUND:new a(2013,b.USER_REAUTH,"The user identity was not found."),USERIDTOKEN_PASSWORD_VERSION_CHANGED:new a(2014,b.USER_REAUTH,"The user identity must be reauthenticated because the password version changed."),USERIDTOKEN_USERAUTH_DATA_MISMATCH:new a(2015,b.USER_REAUTH,"The user ID token and user authentication data user identities do not match."),
SERVICETOKEN_MASTERTOKEN_MISMATCH:new a(3E3,b.FAIL,"Service token master token serial number does not match master token serial number."),SERVICETOKEN_USERIDTOKEN_MISMATCH:new a(3001,b.FAIL,"Service token user ID token serial number does not match user ID token serial number."),SERVICETOKEN_SERVICEDATA_INVALID:new a(3002,b.FAIL,"Service token data invalid."),SERVICETOKEN_MASTERTOKEN_NOT_FOUND:new a(3003,b.FAIL,"Service token is bound to an unknown master token."),SERVICETOKEN_USERIDTOKEN_NOT_FOUND:new a(3004,
b.FAIL,"Service token is bound to an unknown user ID token."),SERVICETOKEN_MASTERTOKEN_SERIAL_NUMBER_OUT_OF_RANGE:new a(3005,b.FAIL,"Service token master token serial number is out of range."),SERVICETOKEN_USERIDTOKEN_SERIAL_NUMBER_OUT_OF_RANGE:new a(3006,b.FAIL,"Service token user ID token serial number is out of range."),SERVICETOKEN_TOKENDATA_INVALID:new a(3007,b.FAIL,"Invalid service token data."),SERVICETOKEN_SIGNATURE_INVALID:new a(3008,b.FAIL,"Invalid service token signature."),UNIDENTIFIED_ENTITYAUTH_SCHEME:new a(4E3,
b.FAIL,"Unable to identify entity authentication scheme."),ENTITYAUTH_FACTORY_NOT_FOUND:new a(4001,b.FAIL,"No factory registered for entity authentication scheme."),X509CERT_PARSE_ERROR:new a(4002,b.ENTITYDATA_REAUTH,"Error parsing X.509 certificate data."),X509CERT_ENCODE_ERROR:new a(4003,b.ENTITYDATA_REAUTH,"Error encoding X.509 certificate data."),X509CERT_VERIFICATION_FAILED:new a(4004,b.ENTITYDATA_REAUTH,"X.509 certificate verification failed."),ENTITY_NOT_FOUND:new a(4005,b.FAIL,"Entity not recognized."),
INCORRECT_ENTITYAUTH_DATA:new a(4006,b.FAIL,"Entity used incorrect entity authentication data type."),RSA_PUBLICKEY_NOT_FOUND:new a(4007,b.ENTITYDATA_REAUTH,"RSA public key not found."),NPTICKET_GRACE_PERIOD_EXCEEDED:new a(4008,b.ENTITYDATA_REAUTH,"Fake NP-Tickets cannot be used after the grace period when the Playstation Network is up."),NPTICKET_SERVICE_ID_MISSING:new a(4009,b.ENTITYDATA_REAUTH,"NP-Ticket service ID is missing."),NPTICKET_SERVICE_ID_DISALLOWED:new a(4010,b.ENTITYDATA_REAUTH,"NP-Ticket service ID is not allowed."),
NPTICKET_NOT_YET_VALID:new a(4011,b.ENTITYDATA_REAUTH,"NP-Ticket issuance date is in the future."),NPTICKET_EXPIRED:new a(4012,b.ENTITYDATA_REAUTH,"NP-Ticket has expired."),NPTICKET_PRIVATE_KEY_NOT_FOUND:new a(4013,b.ENTITYDATA_REAUTH,"No private key found for NP-Ticket GUID."),NPTICKET_COOKIE_VERIFICATION_FAILED:new a(4014,b.ENTITYDATA_REAUTH,"NP-Ticket cookie signature verification failed."),NPTICKET_INCORRECT_COOKIE_VERSION:new a(4015,b.ENTITYDATA_REAUTH,"Incorrect NP-Ticket cookie version."),
NPTICKET_BROKEN:new a(4016,b.ENTITYDATA_REAUTH,"NP-Ticket broken."),NPTICKET_VERIFICATION_FAILED:new a(4017,b.ENTITYDATA_REAUTH,"NP-Ticket signature verification failed."),NPTICKET_ERROR:new a(4018,b.ENTITYDATA_REAUTH,"Unknown NP-Ticket TCM error."),NPTICKET_CIPHER_INFO_NOT_FOUND:new a(4019,b.ENTITYDATA_REAUTH,"No cipher information found for NP-Ticket."),NPTICKET_INVALID_CIPHER_INFO:new a(4020,b.ENTITYDATA_REAUTH,"Cipher information for NP-Ticket is invalid."),NPTICKET_UNSUPPORTED_VERSION:new a(4021,
b.ENTITYDATA_REAUTH,"Unsupported NP-Ticket version."),NPTICKET_INCORRECT_KEY_LENGTH:new a(4022,b.ENTITYDATA_REAUTH,"Incorrect NP-Ticket public key length."),UNSUPPORTED_ENTITYAUTH_DATA:new a(4023,b.FAIL,"Unsupported entity authentication data."),CRYPTEX_RSA_KEY_SET_NOT_FOUND:new a(4024,b.FAIL,"Cryptex RSA key set not found."),FORCE_LOGIN:new a(5E3,b.USERDATA_REAUTH,"User must login again."),NETFLIXID_COOKIES_EXPIRED:new a(5001,b.USERDATA_REAUTH,"Netflix ID cookie identity has expired."),NETFLIXID_COOKIES_BLANK:new a(5002,
b.USERDATA_REAUTH,"Netflix ID or Secure Netflix ID cookie is blank."),UNIDENTIFIED_USERAUTH_SCHEME:new a(5003,b.FAIL,"Unable to identify user authentication scheme."),USERAUTH_FACTORY_NOT_FOUND:new a(5004,b.FAIL,"No factory registered for user authentication scheme."),EMAILPASSWORD_BLANK:new a(5005,b.USERDATA_REAUTH,"Email or password is blank."),AUTHMGR_COMMS_FAILURE:new a(5006,b.TRANSIENT_FAILURE,"Error communicating with authentication manager."),EMAILPASSWORD_INCORRECT:new a(5007,b.USERDATA_REAUTH,
"Email or password is incorrect."),UNSUPPORTED_USERAUTH_DATA:new a(5008,b.FAIL,"Unsupported user authentication data."),SSOTOKEN_BLANK:new a(5009,b.SSOTOKEN_REJECTED,"SSO token is blank."),SSOTOKEN_NOT_ASSOCIATED:new a(5010,b.USERDATA_REAUTH,"SSO token is not associated with a Netflix user."),USERAUTH_USERIDTOKEN_INVALID:new a(5011,b.USERDATA_REAUTH,"User authentication data user ID token is invalid."),PROFILEID_BLANK:new a(5012,b.USERDATA_REAUTH,"Profile ID is blank."),UNIDENTIFIED_USERAUTH_MECHANISM:new a(5013,
b.FAIL,"Unable to identify user authentication mechanism."),UNSUPPORTED_USERAUTH_MECHANISM:new a(5014,b.FAIL,"Unsupported user authentication mechanism."),SSOTOKEN_INVALID:new a(5015,b.SSOTOKEN_REJECTED,"SSO token invalid."),USERAUTH_MASTERTOKEN_MISSING:new a(5016,b.USERDATA_REAUTH,"User authentication required master token is missing."),ACCTMGR_COMMS_FAILURE:new a(5017,b.TRANSIENT_FAILURE,"Error communicating with the account manager."),SSO_ASSOCIATION_FAILURE:new a(5018,b.TRANSIENT_FAILURE,"SSO user association failed."),
SSO_DISASSOCIATION_FAILURE:new a(5019,b.TRANSIENT_FAILURE,"SSO user disassociation failed."),MDX_USERAUTH_VERIFICATION_FAILED:new a(5020,b.USERDATA_REAUTH,"MDX user authentication data verification failed."),USERAUTH_USERIDTOKEN_NOT_DECRYPTED:new a(5021,b.USERDATA_REAUTH,"User authentication data user ID token is not decrypted or verified."),MDX_USERAUTH_ACTION_INVALID:new a(5022,b.USERDATA_REAUTH,"MDX user authentication data action is invalid."),CTICKET_DECRYPT_ERROR:new a(5023,b.USERDATA_REAUTH,
"CTicket decryption failed."),USERAUTH_MASTERTOKEN_INVALID:new a(5024,b.USERDATA_REAUTH,"User authentication data master token is invalid."),USERAUTH_MASTERTOKEN_NOT_DECRYPTED:new a(5025,b.USERDATA_REAUTH,"User authentication data master token is not decrypted or verified."),CTICKET_CRYPTOCONTEXT_ERROR:new a(5026,b.USERDATA_REAUTH,"Error creating CTicket crypto context."),MDX_PIN_BLANK:new a(5027,b.USERDATA_REAUTH,"MDX controller or target PIN is blank."),MDX_PIN_MISMATCH:new a(5028,b.USERDATA_REAUTH,
"MDX controller and target PIN mismatch."),MDX_USER_UNKNOWN:new a(5029,b.USERDATA_REAUTH,"MDX controller user ID token or CTicket is not decrypted or verified."),USERAUTH_USERIDTOKEN_MISSING:new a(5030,b.USERDATA_REAUTH,"User authentication required user ID token is missing."),MDX_CONTROLLERDATA_INVALID:new a(5031,b.USERDATA_REAUTH,"MDX controller authentication data is invalid."),UNSUPPORTED_COMPRESSION:new a(6E3,b.FAIL,"Unsupported compression algorithm."),COMPRESSION_ERROR:new a(6001,b.FAIL,"Error compressing data."),
UNCOMPRESSION_ERROR:new a(6002,b.FAIL,"Error uncompressing data."),MESSAGE_ENTITY_NOT_FOUND:new a(6003,b.FAIL,"Message header entity authentication data or master token not found."),PAYLOAD_MESSAGE_ID_MISMATCH:new a(6004,b.FAIL,"Payload chunk message ID does not match header message ID ."),PAYLOAD_SEQUENCE_NUMBER_MISMATCH:new a(6005,b.FAIL,"Payload chunk sequence number does not match expected sequence number."),PAYLOAD_VERIFICATION_FAILED:new a(6006,b.FAIL,"Payload chunk payload signature verification failed."),
MESSAGE_DATA_MISSING:new a(6007,b.FAIL,"No message data found."),MESSAGE_FORMAT_ERROR:new a(6008,b.FAIL,"Malformed message data."),MESSAGE_VERIFICATION_FAILED:new a(6009,b.FAIL,"Message header/error data signature verification failed."),HEADER_DATA_MISSING:new a(6010,b.FAIL,"No header data found."),PAYLOAD_DATA_MISSING:new a(6011,b.FAIL,"No payload data found in non-EOM payload chunk."),PAYLOAD_DATA_CORRUPT:new a(6012,b.FAIL,"Corrupt payload data found in non-EOM payload chunk."),UNIDENTIFIED_COMPRESSION:new a(6013,
b.FAIL,"Unidentified compression algorithm."),MESSAGE_EXPIRED:new a(6014,b.EXPIRED,"Message expired and not renewable. Rejected."),MESSAGE_ID_OUT_OF_RANGE:new a(6015,b.FAIL,"Message ID is out of range."),INTERNAL_CODE_NEGATIVE:new a(6016,b.FAIL,"Error header internal code is negative."),UNEXPECTED_RESPONSE_MESSAGE_ID:new a(6017,b.FAIL,"Unexpected response message ID. Possible replay."),RESPONSE_REQUIRES_ENCRYPTION:new a(6018,b.KEYX_REQUIRED,"Message response requires encryption."),PAYLOAD_SEQUENCE_NUMBER_OUT_OF_RANGE:new a(6019,
b.FAIL,"Payload chunk sequence number is out of range."),PAYLOAD_MESSAGE_ID_OUT_OF_RANGE:new a(6020,b.FAIL,"Payload chunk message ID is out of range."),MESSAGE_REPLAYED:new a(6021,b.REPLAYED,"Non-replayable message sent with old master token."),INCOMPLETE_NONREPLAYABLE_MESSAGE:new a(6022,b.FAIL,"Non-replayable message sent non-renewable or without key request data or without a master token."),HEADER_SIGNATURE_INVALID:new a(6023,b.FAIL,"Invalid Header signature."),HEADER_DATA_INVALID:new a(6024,b.FAIL,
"Invalid header data."),PAYLOAD_INVALID:new a(6025,b.FAIL,"Invalid payload."),PAYLOAD_SIGNATURE_INVALID:new a(6026,b.FAIL,"Invalid payload signature."),RESPONSE_REQUIRES_MASTERTOKEN:new a(6027,b.KEYX_REQUIRED,"Message response requires a master token."),RESPONSE_REQUIRES_USERIDTOKEN:new a(6028,b.USER_REAUTH,"Message response requires a user ID token."),REQUEST_REQUIRES_USERAUTHDATA:new a(6029,b.FAIL,"User-associated message requires user authentication data."),UNEXPECTED_MESSAGE_SENDER:new a(6030,
b.FAIL,"Message sender is equal to the local entity or not the master token entiy."),UNIDENTIFIED_KEYX_SCHEME:new a(7E3,b.FAIL,"Unable to identify key exchange scheme."),KEYX_FACTORY_NOT_FOUND:new a(7001,b.FAIL,"No factory registered for key exchange scheme."),KEYX_REQUEST_NOT_FOUND:new a(7002,b.FAIL,"No key request found matching header key response data."),UNIDENTIFIED_KEYX_KEY_ID:new a(7003,b.FAIL,"Unable to identify key exchange key ID."),UNSUPPORTED_KEYX_KEY_ID:new a(7004,b.FAIL,"Unsupported key exchange key ID."),
UNIDENTIFIED_KEYX_MECHANISM:new a(7005,b.FAIL,"Unable to identify key exchange mechanism."),UNSUPPORTED_KEYX_MECHANISM:new a(7006,b.FAIL,"Unsupported key exchange mechanism."),KEYX_RESPONSE_REQUEST_MISMATCH:new a(7007,b.FAIL,"Key exchange response does not match request."),KEYX_PRIVATE_KEY_MISSING:new a(7008,b.FAIL,"Key exchange private key missing."),UNKNOWN_KEYX_PARAMETERS_ID:new a(7009,b.FAIL,"Key exchange parameters ID unknown or invalid."),KEYX_MASTER_TOKEN_MISSING:new a(7010,b.FAIL,"Master token required for key exchange is missing."),
KEYX_INVALID_PUBLIC_KEY:new a(7011,b.FAIL,"Key exchange public key is invalid."),KEYX_PUBLIC_KEY_MISSING:new a(7012,b.FAIL,"Key exchange public key missing."),KEYX_WRAPPING_KEY_MISSING:new a(7013,b.FAIL,"Key exchange wrapping key missing."),KEYX_WRAPPING_KEY_ID_MISSING:new a(7014,b.FAIL,"Key exchange wrapping key ID missing."),KEYX_INVALID_WRAPPING_KEY:new a(7015,b.FAIL,"Key exchange wrapping key is invalid."),CRYPTEX_ENCRYPTION_ERROR:new a(8E3,b.FAIL,"Error encrypting data with cryptex."),CRYPTEX_DECRYPTION_ERROR:new a(8001,
b.FAIL,"Error decrypting data with cryptex."),CRYPTEX_MAC_ERROR:new a(8002,b.FAIL,"Error computing MAC with cryptex."),CRYPTEX_VERIFY_ERROR:new a(8003,b.FAIL,"Error verifying MAC with cryptex."),CRYPTEX_CONTEXT_CREATION_FAILURE:new a(8004,b.FAIL,"Error creating cryptex cipher or MAC context."),DATAMODEL_DEVICE_ACCESS_ERROR:new a(8005,b.TRANSIENT_FAILURE,"Error accessing data model device."),DATAMODEL_DEVICETYPE_NOT_FOUND:new a(8006,b.FAIL,"Data model device type not found."),CRYPTEX_KEYSET_UNSUPPORTED:new a(8007,
b.FAIL,"Cryptex key set not supported."),CRYPTEX_PRIVILEGE_EXCEPTION:new a(8008,b.FAIL,"Insufficient privileges for cryptex operation."),CRYPTEX_WRAP_ERROR:new a(8009,b.FAIL,"Error wrapping data with cryptex."),CRYPTEX_UNWRAP_ERROR:new a(8010,b.FAIL,"Error unwrapping data with cryptex."),CRYPTEX_COMMS_FAILURE:new a(8011,b.TRANSIENT_FAILURE,"Error comunicating with cryptex."),CRYPTEX_SIGN_ERROR:new a(8012,b.FAIL,"Error computing signature with cryptex."),INTERNAL_EXCEPTION:new a(9E3,b.TRANSIENT_FAILURE,
"Internal exception."),MSL_COMMS_FAILURE:new a(9001,b.FAIL,"Error communicating with MSL entity."),NONE:new a(9999,b.FAIL,"Special unit test error.")});Object.freeze(a);var l;(function(){l=x.Class.create(Error());l.mixin({init:function(a,b,c){function d(){if(s)return s;if(this.cause&&this.cause instanceof l)return this.cause.messageId}Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor);var o=a.message;b&&(o+=" ["+b+"]");var s,x=this.stack;Object.defineProperties(this,{message:{value:o,
writable:!1,configurable:!0},error:{value:a,writable:!1,configurable:!0},cause:{value:c,writable:!1,configurable:!0},name:{value:"MslException",writable:!1,configurable:!0},messageId:{get:d,set:function(a){if(0>a||a>P)throw new RangeError("Message ID "+a+" is outside the valid range.");d()||(s=a)},configurable:!0},stack:{get:function(){var a=this.toString();x&&(a+="\n"+x);c&&c.stack&&(a+="\nCaused by "+c.stack);return a},configurable:!0}})},setMessageId:function(a){this.messageId=a;return this},toString:function(){return this.name+
": "+this.message}})})();var s=l.extend({init:function ld(a,b,c){ld.base.call(this,a,b,c);Object.defineProperties(this,{name:{value:"MslCryptoException",writable:!1,configurable:!0}})}}),A=l.extend({init:function md(a,b,c){md.base.call(this,a,b,c);Object.defineProperties(this,{name:{value:"MslEncodingException",writable:!1,configurable:!0}})}}),Ba=l.extend({init:function nd(a,b,c){nd.base.call(this,a,b,c);Object.defineProperties(this,{name:{value:"MslEntityAuthException",writable:!1,configurable:!0}})}}),
ra;(function(){ra=x.Class.create(Error());ra.mixin({init:function(a,b,c){Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor);var d=this.stack;Object.defineProperties(this,{message:{value:a,writable:!1,configurable:!1},cause:{value:b,writable:!1,configurable:!1},requestCause:{value:c,writable:!1,configurable:!1},name:{value:"MslErrorResponseException",writable:!1,configurable:!0},stack:{get:function(){var a=this.toString();d&&(a+="\n"+d);b&&b.stack&&(a+="\nCaused by "+b.stack);
return a},configurable:!0}})},toString:function(){return this.name+": "+this.message}})})();var Z;(function(){Z=x.Class.create(Error());Z.mixin({init:function(a,b){Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor);var c=this.stack;Object.defineProperties(this,{message:{value:a,writable:!1,configurable:!1},cause:{value:b,writable:!1,configurable:!1},name:{value:"MslIoException",writable:!1,configurable:!0},stack:{get:function(){var a=this.toString();c&&(a+="\n"+c);b&&b.stack&&
(a+="\nCaused by "+b.stack);return a},configurable:!0}})},toString:function(){return this.name+": "+this.message}})})();var o;(function(){o=x.Class.create(Error());o.mixin({init:function(a,b){Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor);var c=this.stack;Object.defineProperties(this,{message:{value:a,writable:!1,configurable:!1},cause:{value:b,writable:!1,configurable:!1},name:{value:"MslInternalException",writable:!1,configurable:!0},stack:{get:function(){var a=this.toString();
c&&(a+="\n"+c);b&&b.stack&&(a+="\nCaused by "+b.stack);return a},configurable:!0}})},toString:function(){return this.name+": "+this.message}})})();var X=l.extend({init:function od(a,b,c){od.base.call(this,a,b,c);Object.defineProperties(this,{name:{value:"MslKeyExchangeException",writable:!1,configurable:!0}})}}),Ca=l.extend({init:function pd(a,b){pd.base.call(this,a);Object.defineProperties(this,{masterToken:{value:b,writable:!1,configurable:!1},name:{value:"MslMasterTokenException",writable:!1,configurable:!0}})}}),
K=l.extend({init:function bb(a,b,c){bb.base.call(this,a,b,c);Object.defineProperties(this,{name:{value:"MslMessageException",writable:!1,configurable:!0}})}}),L=l.extend({init:function w(a,b,c){w.base.call(this,a,b,c);Object.defineProperties(this,{name:{value:"MslUserAuthException",writable:!1,configurable:!0}})}}),ma;(function(){ma=x.Class.create(Error());ma.mixin({init:function(a,b){Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor);var c=this.stack;Object.defineProperties(this,
{message:{value:a,writable:!1,configurable:!1},cause:{value:b,writable:!1,configurable:!1},name:{value:"MslInterruptedException",writable:!1,configurable:!0},stack:{get:function(){var a=this.toString();c&&(a+="\n"+c);b&&b.stack&&(a+="\nCaused by "+b.stack);return a},configurable:!0}})},toString:function(){return this.name+": "+this.message}})})();ab="AES-KW";za="AES-CBC";Aa={name:"HMAC",params:{hash:"SHA-256"}};Gb="RSASSA-PKCS1-v1_5";gc={name:"RSASSA-PKCS1-v1_5",params:{hash:"SHA-256"}};hc={name:"RSASSA-PKCS1-v1_5",
params:{hash:"SHA-1"}};var Lb,Ua,Ia;(function(){Lb=x.Class.create({init:function(b,d,D){function z(a){c(d,function(){var c=a?C(a):void 0;Object.defineProperties(q,{rawKey:{value:b,writable:!1,configurable:!1},keyData:{value:a,writable:!1,configurable:!1},keyDataB64:{value:c,writable:!1,configurable:!1}});return this},q)}var q=this;c(d,function(){if(!b||"object"!=typeof b)throw new s(a.INVALID_SYMMETRIC_KEY);if(!D&&b.extractable){var c=da.exportKey("raw",b);c.oncomplete=function(){z(new Uint8Array(c.result))};
c.onerror=function(){d.error(new s(a.KEY_EXPORT_ERROR,"raw"))}}else z(D)},q)},size:function(){return this.keyData.length},toByteArray:function(){return this.keyData},toBase64:function(){return this.keyDataB64}});Ua=function(a,b){new Lb(a,b)};Ia=function(b,d,D){c(D,function(){try{d="string"==typeof d?M(d):d}catch(c){throw new s(a.INVALID_SYMMETRIC_KEY,"keydata "+d,c);}var q=da.importKey("raw",d,b,!0);q.oncomplete=function(){new Lb(q.result,D,d)};q.onerror=function(){D.error(new s(a.INVALID_SYMMETRIC_KEY))}})}})();
var vb,Va,lc;(function(){vb=x.Class.create({init:function(b,d,D){function z(a){c(d,function(){Object.defineProperties(q,{rawKey:{value:b,writable:!1,configurable:!1},encoded:{value:a,writable:!1,configurable:!1}});return this},q)}var q=this;c(d,function(){if(!b||"object"!=typeof b||"public"!=b.type)throw new TypeError("Only original public crypto keys are supported.");if(!D&&b.extractable){var c=da.exportKey("spki",b);c.oncomplete=function(){z(new Uint8Array(c.result))};c.onerror=function(){d.error(new s(a.KEY_EXPORT_ERROR,
"spki"))}}else z(D)})},getEncoded:function(){return this.encoded}});Va=function(a,b){new vb(a,b)};lc=function(b,d,D){c(D,function(){try{d="string"==typeof d?M(d):d}catch(c){throw new s(a.INVALID_PUBLIC_KEY,"spki "+d,c);}var q=da.importKey("spki",d,{name:b},!0);q.oncomplete=function(){new vb(q.result,D,d)};q.onerror=function(){D.error(new s(a.INVALID_PUBLIC_KEY))}})}})();var mc,eb;(function(){mc=x.Class.create({init:function(b,d,D){function z(a){c(d,function(){Object.defineProperties(q,{rawKey:{value:b,
writable:!1,configurable:!1},encoded:{value:a,writable:!1,configurable:!1}});return this},q)}var q=this;c(d,function(){if(!b||"object"!=typeof b||"private"!=b.type)throw new TypeError("Only original private crypto keys are supported.");if(!D&&b.extractable){var c=da.exportKey("pkcs8",b);c.oncomplete=function(){z(new Uint8Array(c.result))};c.onerror=function(){d.error(new s(a.KEY_EXPORT_ERROR,"pkcs8"))}}else z(D)})},getEncoded:function(){return this.encoded}});eb=function(a,b){new mc(a,b)}})();var Mb,
Nb,Ob;(function(){Mb=x.Class.create({init:function(a,b,c,d,q){Object.defineProperties(this,{keyId:{value:a,writable:!1,configurable:!1},ciphertext:{value:c,writable:!1,configurable:!1},iv:{value:b,writable:!1,configurable:!1},sha256:{value:d,writable:!1,configurable:!1}});q.result(this)},toJSON:function(){var a={};a.keyid=this.keyId;this.iv&&(a.iv=C(this.iv));a.ciphertext=C(this.ciphertext);a.sha256=this.sha256?C(this.sha256):"AA==";return a}});Nb=function(a,b,c,d){new Mb(a,b,c,null,d)};Ob=function(b,
d){c(d,function(){var c=b.keyid,z=b.iv,q=b.ciphertext;if(!c||!q)throw new A(a.JSON_PARSE_ERROR,"encryption envelope "+JSON.stringify(b));try{z&&(z=M(z)),q=M(q)}catch(l){throw new s(a.ENVELOPE_PARSE_ERROR,"encryption envelope "+JSON.stringify(b),l);}new Mb(c,z,q,null,d)})}})();var Wa=x.Class.create({encrypt:function(){},decrypt:function(){},wrap:function(){},unwrap:function(){},sign:function(){},verify:function(){}}),Ka=Wa.extend({encrypt:function(a,b){b.result(a)},decrypt:function(a,b){b.result(a)},
wrap:function(a,b){b.result(a)},unwrap:function(a,b){b.result(a)},sign:function(a,b){b.result(new Uint8Array(0))},verify:function(a,b,c){c.result(!0)}}),nc,oc;(function(){var b=oc={ENCRYPT_DECRYPT:1,WRAP_UNWRAP:2,SIGN_VERIFY:3};nc=Wa.extend({init:function D(a,c,d,n,p){D.base.call(this);d&&(d=d.rawKey);n&&(n=n.rawKey);var a=p==b.ENCRYPT_DECRYPT?"RSAES-PKCS1-v1_5":"nullOp",i=p==b.SIGN_VERIFY?gc:"nullOp";if(p==b.WRAP_UNWRAP)throw new o("Wrap/unwrap unsupported.");Object.defineProperties(this,{id:{value:c,
writable:!1,enumerable:!1,configurable:!1},privateKey:{value:d,writable:!1,enumerable:!1,configurable:!1},publicKey:{value:n,writable:!1,enumerable:!1,configurable:!1},transform:{value:a,writable:!1,enumerable:!1,configurable:!1},algo:{value:i,writable:!1,enumerable:!1,configurable:!1}})},encrypt:function(b,d){var q=this;c(d,function(){if("nullOp"==this.transform)return b;if(!this.publicKey)throw new s(a.ENCRYPT_NOT_SUPPORTED,"no public key");if(0==b.length)return b;var c=da.encrypt(q.transform,q.publicKey,
b);c.oncomplete=function(){Nb(q.id,null,c.result,{result:function(b){try{var c=JSON.stringify(b);d.result(W(c,S))}catch(i){d.error(new s(a.ENCRYPT_ERROR,null,i))}},error:function(b){b instanceof l||(b=new s(a.ENCRYPT_ERROR,null,b));d.error(b)}})};c.onerror=function(){d.error(new s(a.ENCRYPT_ERROR))}},this)},decrypt:function(b,d){var q=this;c(d,function(){if("nullOp"==this.transform)return b;if(!this.privateKey)throw new s(a.DECRYPT_NOT_SUPPORTED,"no private key");if(0==b.length)return b;var c;try{var n=
aa(b,S);c=JSON.parse(n)}catch(p){if(p instanceof SyntaxError)throw new s(a.ENVELOPE_PARSE_ERROR,null,p);throw new s(a.DECRYPT_ERROR,null,p);}Ob(c,{result:function(b){try{if(b.keyId!=q.id)throw new s(a.ENVELOPE_KEY_ID_MISMATCH);var c=da.decrypt(q.transform,q.privateKey,b.ciphertext);c.oncomplete=function(){d.result(c.result)};c.onerror=function(){d.error(new s(a.DECRYPT_ERROR))}}catch(e){e instanceof l?d.error(e):d.error(new s(a.DECRYPT_ERROR,null,e))}},error:function(b){b instanceof A&&(b=new s(a.ENVELOPE_ENCODE_ERROR,
null,b));b instanceof l||(b=new s(a.DECRYPT_ERROR,null,b));d.error(b)}})},this)},wrap:function(b,c){c.error(new s(a.WRAP_NOT_SUPPORTED))},unwrap:function(b,c,q){q.error(new s(a.UNWRAP_NOT_SUPPORTED))},sign:function(b,d){c(d,function(){if("nullOp"==this.algo)return new Uint8Array(0);if(!this.privateKey)throw new s(a.SIGN_NOT_SUPPORTED,"no private key");var c=da.sign(this.algo,this.privateKey,b);c.oncomplete=function(){d.result(c.result)};c.onerror=function(){d.error(new s(a.SIGNATURE_ERROR))}},this)},
verify:function(b,d,q){c(q,function(){if("nullOp"==this.algo)return!0;if(!this.publicKey)throw new s(a.VERIFY_NOT_SUPPORTED,"no public key");var c=da.verify(this.algo,this.publicKey,d,b);c.oncomplete=function(){q.result(c.result)};c.onerror=function(){q.error(new s(a.SIGNATURE_ERROR))}},this)}})})();var fb;(function(){fb=Wa.extend({init:function ba(a,b,c,d,n){ba.base.call(this);c=c&&c.rawKey;d=d&&d.rawKey;n=n&&n.rawKey;Object.defineProperties(this,{ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},
id:{value:b,writable:!1,enumerable:!1,configurable:!1},encryptionKey:{value:c,writable:!1,enumerable:!1,configurable:!1},hmacKey:{value:d,writable:!1,enumerable:!1,configurable:!1},wrapKey:{value:n,writable:!1,enumerable:!1,configurable:!1}})},encrypt:function(b,d){var z=this;c(d,function(){if(!this.encryptionKey)throw new s(a.ENCRYPT_NOT_SUPPORTED,"no encryption/decryption key");if(0==b.length)return b;var c=new Uint8Array(16);this.ctx.getRandom().nextBytes(c);var o=da.encrypt({name:za,params:{iv:c}},
z.encryptionKey,b);o.oncomplete=function(){var b=new Uint8Array(o.result);Nb(z.id,c,b,{result:function(b){try{var c=JSON.stringify(b);d.result(W(c,S))}catch(j){d.error(new s(a.ENCRYPT_ERROR,null,j))}},error:function(b){b instanceof l||(b=new s(a.ENCRYPT_ERROR,null,b));d.error(b)}})};o.onerror=function(){d.error(new s(a.ENCRYPT_ERROR))}},this)},decrypt:function(b,d){var z=this;c(d,function(){if(!this.encryptionKey)throw new s(a.DECRYPT_NOT_SUPPORTED,"no encryption/decryption key");if(0==b.length)return b;
var c;try{var o=aa(b,S);c=JSON.parse(o)}catch(n){if(n instanceof SyntaxError)throw new s(a.ENVELOPE_PARSE_ERROR,null,n);throw new s(a.DECRYPT_ERROR,null,n);}Ob(c,{result:function(b){try{if(b.keyId!=z.id)throw new s(a.ENVELOPE_KEY_ID_MISMATCH);var c=da.decrypt({name:za,params:{iv:b.iv}},z.encryptionKey,b.ciphertext);c.oncomplete=function(){var a=new Uint8Array(c.result);d.result(a)};c.onerror=function(){d.error(new s(a.DECRYPT_ERROR))}}catch(j){j instanceof l?d.error(j):d.error(new s(a.DECRYPT_ERROR,
null,j))}},error:function(b){b instanceof A&&(b=new s(a.ENVELOPE_ENCODE_ERROR,null,b));b instanceof l||(b=new s(a.DECRYPT_ERROR,null,b));d.error(b)}})},this)},wrap:function(b,d){c(d,function(){if(!this.wrapKey)throw new s(a.WRAP_NOT_SUPPORTED,"no wrap/unwrap key");var c=da.wrapKey(b.rawKey,this.wrapKey);c.oncomplete=function(){d.result(c.result)};c.onerror=function(){d.error(new s(a.WRAP_ERROR))}},this)},unwrap:function(b,d,z){function q(b){c(z,function(){switch(b.type){case "secret":Ua(b,z);break;
case "public":Va(b,z);break;case "private":eb(b,z);break;default:throw new s(a.UNSUPPORTED_KEY,"type: "+b.type);}})}c(z,function(){if(!this.wrapKey)throw new s(a.UNWRAP_NOT_SUPPORTED,"no wrap/unwrap key");var c=da.unwrapKey(b,d,this.wrapKey,!1,[],"raw");c.oncomplete=function(){q(c.result)};c.onerror=function(){z.error(new s(a.UNWRAP_ERROR))}},this)},sign:function(b,d){c(d,function(){if(!this.hmacKey)throw new s(a.SIGN_NOT_SUPPORTED,"no HMAC key.");var c=da.sign(Aa,this.hmacKey,b);c.oncomplete=function(){var a=
new Uint8Array(c.result);d.result(a)};c.onerror=function(){d.error(new s(a.HMAC_ERROR))}},this)},verify:function(b,d,z){c(z,function(){if(!this.hmacKey)throw new s(a.VERIFY_NOT_SUPPORTED,"no HMAC key.");var c=da.verify(Aa,this.hmacKey,d,b);c.oncomplete=function(){z.result(c.result)};c.onerror=function(){z.error(new s(a.HMAC_ERROR))}},this)}})})();var oa=fb.extend({init:function ba(b,c,d,l,n){if(d||l||n)ba.base.call(this,b,d+"_"+c.sequenceNumber,l,n,null);else{if(!c.isDecrypted())throw new Ca(a.MASTERTOKEN_UNTRUSTED,
c);ba.base.call(this,b,c.identity+"_"+c.sequenceNumber,c.encryptionKey,c.hmacKey,null)}}}),pc;(function(){pc=Wa.extend({init:function D(a,b,c){D.base.call(this);Object.defineProperties(this,{id:{value:b,writable:!1,enumerable:!1,configurable:!1},privateKey:{value:c,writable:!1,enumerable:!1,configurable:!1}})},encrypt:function(a,b){b.result(a)},decrypt:function(a,b){b.result(a)},wrap:function(b,c){c.error(new s(a.WRAP_NOT_SUPPORTED))},unwrap:function(b,c,d){d.error(new s(a.UNWRAP_NOT_SUPPORTED))},
sign:function(b,d){c(d,function(){if(!this.privateKey)throw new s(a.SIGN_NOT_SUPPORTED,"no private key");var c=da.sign(hc,this.privateKey,b);c.oncomplete=function(){d.result(c.result)};c.onerror=function(){d.error(new s(a.SIGNATURE_ERROR))}},this)},verify:function(a,b,c){c.result(a)}})})();var td=Wa.extend({encrypt:function(a,b){b.result(a)},decrypt:function(a,b){b.result(a)},wrap:function(a,b){b.error(new o("Wrap is unsupported by the MSL token crypto context."))},unwrap:function(a,b){b.error(new o("Unwrap is unsupported by the MSL token crypto context."))},
sign:function(a,b){b.result(new Uint8Array(0))},verify:function(a,b,c){c.result(!1)}}),Da,Ea;(function(){var b=Ea={RSA_OAEP:"RSA-OAEP",A128KW:ab};ya="A128GCM";Da=x.Class.create({init:function(a,c,d,l,n){switch(c){case b.RSA_OAEP:n=n&&(n.rawKey||n);l=l&&(l.rawKey||l);break;case b.A128KW:n=l=l&&(l.rawKey||l);break;default:throw new o("Unsupported algorithm: "+c);}Object.defineProperties(this,{_ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},_algo:{value:c,writable:!1,enumerable:!1,configurable:!1},
_enc:{value:d,writable:!1,enumerable:!1,configurable:!1},_wrapKey:{value:n,writable:!1,enumerable:!1,configurable:!1},_unwrapKey:{value:l,writable:!1,enumerable:!1,configurable:!1}})},encrypt:function(b,c){c.error(new s(a.ENCRYPT_NOT_SUPPORTED))},decrypt:function(b,c){c.error(new s(a.DECRYPT_NOT_SUPPORTED))},wrap:function(b,d){c(d,function(){var c=da.wrapKey(b.rawKey,this._wrapKey,this._wrapKey.algorithm);c.oncomplete=function(){d.result(c.result)};c.onerror=function(){d.error(new s(a.WRAP_ERROR))}},
this)},unwrap:function(b,d,q){function l(b){c(q,function(){switch(b.type){case "secret":Ua(b,q);break;case "public":Va(b,q);break;case "private":eb(b,q);break;default:throw new s(a.UNSUPPORTED_KEY,"type: "+b.type);}})}c(q,function(){var c=da.unwrapKey(b,d,this._unwrapKey);c.oncomplete=function(){l(c.result)};c.onerror=function(){q.error(new s(a.UNWRAP_ERROR))}},this)},sign:function(b,c){c.error(new s(a.SIGN_NOT_SUPPORTED))},verify:function(b,c,d){d.error(new s(a.VERIFY_NOT_SUPPORTED))}})})();var R=
{PSK:"PSK",MGK:"MGK",X509:"X509",RSA:"RSA",NPTICKET:"NPTICKET",ECC:"ECC",NONE:"NONE"};Object.freeze(R);var La,qc;(function(){La=x.Class.create({init:function(a){Object.defineProperties(this,{scheme:{value:a,writable:!1,configurable:!1}})},getIdentity:function(){},getAuthData:function(){},equals:function(a){return this===a?!0:!(a instanceof La)?!1:this.scheme==a.scheme},toJSON:function(){var a={};a.scheme=this.scheme;a.authdata=this.getAuthData();return a}});qc=function(b,c){var d=c.scheme,q=c.authdata;
if(!d||!q)throw new A(a.JSON_PARSE_ERROR,"entityauthdata "+JSON.stringify(c));if(!R[d])throw new Ba(a.UNIDENTIFIED_ENTITYAUTH_SCHEME,d);var l=b.getEntityAuthenticationFactory(d);if(!l)throw new Ba(a.ENTITYAUTH_FACTORY_NOT_FOUND,d);return l.createData(b,q)}})();var Fa,rc;(function(){Fa=La.extend({init:function D(a){D.base.call(this,R.PSK);Object.defineProperties(this,{identity:{value:a,writable:!1}})},getIdentity:function(){return this.identity},getAuthData:function(){var a={};a.identity=this.identity;
return a},equals:function z(a){return this===a?!0:!(a instanceof Fa)?!1:z.base.call(this,this,a)&&this.identity==a.identity}});rc=function(b){var c=b.identity;if(!c)throw new A(a.JSON_PARSE_ERROR,"psk authdata"+JSON.stringify(b));return new Fa(c)}})();var Ga,sc;(function(){Ga=La.extend({init:function D(a){D.base.call(this,R.MGK);Object.defineProperties(this,{identity:{value:a,writable:!1,configurable:!1}})},getIdentity:function(){return this.identity},getAuthData:function(){var a={};a.identity=this.identity;
return a},equals:function z(a){return this===a?!0:!(a instanceof Ga)?!1:z.base.call(this,this,a)&&this.identity==a.identity}});sc=function(b){var c=b.identity;if(!c)throw new A(a.JSON_PARSE_ERROR,"mgk authdata"+JSON.stringify(b));return new Ga(c)}})();var Xa,tc;(function(){Xa=La.extend({init:function D(a,b){D.base.call(this,R.NPTICKET);var c=b.algorithm.npTicketExpiration,d=b.algorithm.npTicket,p=b.algorithm.npTicketIssue,i=b.algorithm.npTicketFake;if(c<p)throw new o("Cannot construct an NP-Ticket that expires before it was issued.");
Object.defineProperties(this,{identity:{value:a,writable:!1,configurable:!1},privateKey:{value:b,writable:!1,configurable:!1},npticket:{value:d,writable:!1,enumerable:!0,configuration:!1},issuance:{value:p,writable:!1,configurable:!1},expiration:{value:c,writable:!1,configurable:!1},fake:{value:i,writable:!1,configurable:!1}})},isNetflixGenerated:function(){return this.fake},isValid:function(a){return Date.now()+a>=1E3*this.issuance},isExpired:function(a){return Date.now()-a>1E3*this.expiration},
getIssuance:function(){return new Date(1E3*this.issuance)},getExpiration:function(){return new Date(1E3*this.expiration)},getAuthData:function(){var a={};a.npticket=this.npticket;return a},equals:function z(a){return this===a?!0:!(a instanceof Xa)?!1:z.base.call(this,this,a)&&ka(this.npticket,a.npticket)},getIdentity:function(){return this.identity}});tc=function(){throw new Ba(a.UNSUPPORTED_ENTITY_AUTH,"npticket");}})();var wb,uc;(function(){wb=La.extend({init:function D(a,b){D.base.call(this,R.RSA);
Object.defineProperties(this,{identity:{value:a,writable:!1,configurable:!1},publicKeyId:{value:b,writable:!1,configurable:!1}})},getIdentity:function(){return this.identity},getAuthData:function(){var a={};a.identity=this.identity;a.pubkeyid=this.publicKeyId;return a},equals:function z(a){return this===a?!0:!(a instanceof wb)?!1:z.base.call(this,this,a)&&this.identity==a.identity&&this.publicKeyId==a.publicKeyId}});uc=function(b){var c=b.identity,d=b.pubkeyid;if(!c||"string"!==typeof c||!d||"string"!==
typeof d)throw new A(a.JSON_PARSE_ERROR,"RSA authdata"+JSON.stringify(b));return new wb(c,d)}})();var gb,vc;(function(){gb=La.extend({init:function D(a){D.base.call(this,R.NONE);Object.defineProperties(this,{identity:{value:a,writable:!1}})},getIdentity:function(){return this.identity},getAuthData:function(){var a={};a.identity=this.identity;return a},equals:function z(a){return this===a?!0:!(a instanceof gb)?!1:z.base.call(this,this,a)&&this.identity==a.identity}});vc=function(b){var c=b.identity;
if(!c)throw new A(a.JSON_PARSE_ERROR,"Unauthenticated authdata"+JSON.stringify(b));return new gb(c)}})();var hb=x.Class.create({init:function(a){Object.defineProperties(this,{scheme:{value:a,writable:!1,configurable:!1}})},createData:function(){},getCryptoContext:function(){}}),wc;wc=hb.extend({init:function D(a){D.base.call(this,R.PSK);Object.defineProperties(this,{localIdentity:{value:a,writable:!1,enumerable:!1,configurable:!1}})},createData:function(a,b){return rc(b)},getCryptoContext:function(b,
c){if(!(c instanceof Fa))throw new o("Incorrect authentication data type "+JSON.stringify(c)+".");if(c.identity!=this.localIdentity)throw new Ba(a.ENTITY_NOT_FOUND,"psk "+c.identity);return new Ka}});var ud=hb.extend({init:function z(a){z.base.call(this,R.MGK);Object.defineProperties(this,{localIdentity:{value:a,writable:!1,enumerable:!1,configurable:!1}})},createData:function(a,b){return sc(b)},getCryptoContext:function(b,c){if(!(c instanceof Ga))throw new o("Incorrect authentication data type "+
JSON.stringify(c)+".");if(c.identity!=this.localIdentity)throw new Ba(a.ENTITY_NOT_FOUND,"mgk "+c.identity);return new Ka}}),vd=hb.extend({init:function q(){q.base.call(this,R.NPTICKET)},createData:function(a,b){return tc(b)},getCryptoContext:function(b,c){if(!(c instanceof Xa))throw new o("Incorrect authentication data type "+c+".");var d=c.identity,p=c.privateKey;if(!p)throw new Ba(a.RSA_PUBLICKEY_NOT_FOUND,p);return new pc(b,d,p)}}),wd=x.Class.create({init:function(){Object.defineProperties(this,
{rsaKeys:{value:{},writable:!1,enumerable:!1,configurable:!1}})},addPublicKey:function(a,b){if(!(b instanceof vb))throw new o("Incorrect key data type "+b+".");this.rsaKeys[a]=b},getIdentities:function(){return Object.keys(this.rsaKeys)},removePublicKey:function(a){delete this.rsaKeys[a]},getPublicKey:function(a){return this.rsaKeys[a]}}),xc=hb.extend({init:function F(a){F.base.call(this,R.RSA);Object.defineProperties(this,{store:{value:a,writable:!1,enumerable:!1,configurable:!1}})},createData:function(a,
b){return uc(b)},getCryptoContext:function(b,c){if(!(c instanceof wb))throw new o("Incorrect authentication data type "+c+".");var d=c.identity,i=c.publicKeyId,j=this.store.getPublicKey(i);if(!j)throw new Ba(a.RSA_PUBLICKEY_NOT_FOUND,i);return new nc(b,d,null,j,oc.SIGN_VERIFY)}}),xd=hb.extend({init:function n(){n.base.call(this,R.NONE)},createData:function(a,b){return vc(b)},getCryptoContext:function(a,b){if(!(b instanceof gb))throw new o("Incorrect authentication data type "+JSON.stringify(b)+".");
return new Ka}}),yc=x.Class.create({abort:function(){},close:function(){},mark:function(){},reset:function(){},markSupported:function(){},read:function(){}}),Pb=x.Class.create({abort:function(){},close:function(){},write:function(){},flush:function(){}}),yd=x.Class.create({init:function(a){Object.defineProperties(this,{_data:{value:a,writable:!1,enumerable:!1,configurable:!1},_closed:{value:!1,writable:!0,enumerable:!1,configurable:!1},_currentPosition:{value:0,writable:!0,enumerable:!1,configurable:!1},
_mark:{value:-1,writable:!0,enumerable:!1,configurable:!1}})},abort:function(){},close:function(){this._close=!0},mark:function(){this._mark=this._currentPosition},reset:function(){if(-1==this._mark)throw new Z("Stream has not been marked.");this._currentPosition=this._mark},markSupported:function(){return!0},read:function(a,b,c){d(c,function(){if(this._closed)throw new Z("Stream is already closed.");if(this._currentPosition==this._data.length)return null;-1==a&&(a=this._data.length-this._currentPosition);
var b=this._data.subarray(this._currentPosition,this._currentPosition+a);this._currentPosition+=b.length;return b},this)}}),zd=x.Class.create({init:function(){var a={_closed:{value:!1,writable:!0,enumerable:!1,configurable:!1},_result:{value:new Uint8Array(0),writable:!0,enuemrable:!1,configurable:!1},_buffered:{value:[],writable:!1,enumerable:!1,configurable:!1}};Object.defineProperties(this,a)},abort:function(){},close:function(a,b){this._closed=!0;b.result(!0)},write:function(a,b,c,j,e){d(e,function(){if(this._closed)throw new Z("Stream is already closed.");
if(0>b)throw new RangeError("Offset cannot be negative.");if(0>c)throw new RangeError("Length cannot be negative.");if(b+c>a.length)throw new RangeError("Offset plus length cannot be greater than the array length.");var g=a.subarray(b,c);this._buffered.push(g);return g.length},this)},flush:function(a,b){for(;0<this._buffered.length;){var c=this._buffered.shift();if(this._result){var d=new Uint8Array(this._result.length+c.length);d.set(this._result);d.set(c,this._result.length);this._result=d}else this._result=
new Uint8Array(c)}b.result(!0)},size:function(){this.flush(1,{result:function(){}});return this._result.length},toByteArray:function(){this.flush(1,{result:function(){}});return this._result}}),zc,Ad=x.Class.create({getResponse:function(){}});(function(){var a=Pb.extend({init:function(a,b){var c={_httpLocation:{value:a,writable:!1,enumerable:!1,configurable:!1},_timeout:{value:b,writable:!0,enumerable:!1,configurable:!1},_buffer:{value:new zd,writable:!1,enumerable:!1,configurable:!1},_response:{value:void 0,
writable:!0,enumerable:!1,configurable:!1},_abortToken:{value:void 0,writable:!0,enumerable:!1,configurable:!1},_responseQueue:{value:new db,writable:!0,enumerable:!1,configurable:!1}};Object.defineProperties(this,c)},setTimeout:function(a){this._timeout=a},getResponse:function(a,b){var c=this;this._responseQueue.poll(a,{result:function(a){d(b,function(){a&&this._responseQueue.add(a);return a},c)},timeout:function(){d(b,function(){this._response={isTimeout:!0};this._responseQueue.add(this._response);
this.abort();b.timeout()},c)},error:function(a){d(b,function(){this._response={isError:!0};this._responseQueue.add(this._response);throw a;},c)}})},abort:function(){this._abortToken&&this._abortToken.abort()},close:function(a,b){var c=this;d(b,function(){if(this._response)return!0;var a=this._buffer.toByteArray();0<a.length&&(this._abortToken=this._httpLocation.getResponse({body:a},this._timeout,{result:function(a){c._response={response:a};c._responseQueue.add(c._response)},timeout:function(){c._response=
{isTimeout:!0};c._responseQueue.add(c._response)},error:function(a){c._response={isError:!0,error:a};c._responseQueue.add(c._response)}}));return!0},this)},write:function(a,b,c,g,h){d(h,function(){if(this._response)throw new Z("HttpOutputStream already closed.");this._buffer.write(a,b,c,g,h)},this)},flush:function(a,b){d(b,function(){if(this._response)return!0;this._buffer.flush(a,b)},this)}}),b=yc.extend({init:function(a){Object.defineProperties(this,{_out:{value:a,writable:!1,enumerable:!1,configurable:!1},
_buffer:{value:void 0,writable:!0,enumerable:!1,configurable:!1},_exception:{value:void 0,writable:!0,enumerable:!1,configurable:!1},_timedout:{value:!1,writable:!0,enumerable:!1,configurable:!1},_aborted:{value:!1,writable:!0,enumerable:!1,configurable:!1}})},abort:function(){this._out.abort()},close:function(){this._buffer&&this._buffer.close()},mark:function(){this._buffer||this._buffer.mark()},reset:function(){this._buffer&&this._buffer.reset()},markSupported:function(){if(this._buffer)return this._buffer.markSupported()},
read:function(a,b,c){function g(g){d(c,function(){if(!g)return new Uint8Array(0);this._out.getResponse(b,{result:function(g){d(c,function(){var f;if(g.isTimeout)this._timedout=!0,c.timeout();else{if(g.isError)throw this._exception=g.error||new Z("Unknown HTTP exception."),this._exception;if(!g.response)throw this._exception=new Z("Missing HTTP response."),this._exception;f=g.response.content||Jb(g.response.body);this._buffer=new yd(f);this._buffer.read(a,b,c)}},h)},timeout:function(){c.timeout()},
error:function(a){c.error(a)}})},h)}var h=this;d(c,function(){if(this._exception)throw this._exception;if(this._timedout)c.timeout();else{if(this._aborted)return new Uint8Array(0);this._buffer?this._buffer.read(a,b,c):this._out.close(b,{result:function(a){g(a)},timeout:function(){c.timeout()},error:function(a){c.error(a)}})}},h)}});zc=x.Class.create({init:function(a,b){Object.defineProperties(this,{_httpLocation:{value:a,writable:!1,enumerable:!1,configurable:!1},_timeout:{value:b,writable:!0,enumerable:!1,
configurable:!1}})},setTimeout:function(a){this._timeout=a},openConnection:function(){var c=new a(this._httpLocation,this._timeout);return{input:new b(c),output:c}}})})();var sa={SYMMETRIC_WRAPPED:"SYMMETRIC_WRAPPED",ASYMMETRIC_WRAPPED:"ASYMMETRIC_WRAPPED",DIFFIE_HELLMAN:"DIFFIE_HELLMAN",JWE_LADDER:"JWE_LADDER"};Object.freeze(sa);var ib,Ac;(function(){ib=x.Class.create({init:function(a){Object.defineProperties(this,{keyExchangeScheme:{value:a,writable:!1,configurable:!1}})},getKeydata:function(){},
toJSON:function(){var a={};a.scheme=this.keyExchangeScheme;a.keydata=this.getKeydata();return a},equals:function(a){return this===a?!0:!(a instanceof ib)?!1:this.keyExchangeScheme==a.keyExchangeScheme},uniqueKey:function(){return this.keyExchangeScheme}});Ac=function(b,d,i){c(i,function(){var c=d.scheme,e=d.keydata;if(!c||!e||"object"!==typeof e)throw new A(a.JSON_PARSE_ERROR,"keyrequestdata "+JSON.stringify(d));if(!sa[c])throw new X(a.UNIDENTIFIED_KEYX_SCHEME,c);var g=b.getKeyExchangeFactory(c);
if(!g)throw new X(a.KEYX_FACTORY_NOT_FOUND,c);g.createRequestData(b,e,i)})}})();var jb,Bc;(function(){jb=x.Class.create({init:function(a,b){Object.defineProperties(this,{masterToken:{value:a,writable:!1,configurable:!1},keyExchangeScheme:{value:b,wrtiable:!1,configurable:!1}})},getKeydata:function(){},toJSON:function(){var a={};a.mastertoken=this.masterToken;a.scheme=this.keyExchangeScheme;a.keydata=this.getKeydata();return a},equals:function(a){return this===a?!0:!(a instanceof jb)?!1:this.masterToken.equals(a.masterToken)&&
this.keyExchangeScheme==a.keyExchangeScheme},uniqueKey:function(){return this.masterToken.uniqueKey()+":"+this.keyExchangeScheme}});Bc=function(b,d,i){c(i,function(){var j=d.mastertoken,e=d.scheme,g=d.keydata;if(!e||!j||"object"!==typeof j||!g||"object"!==typeof g)throw new A(a.JSON_PARSE_ERROR,"keyresponsedata "+JSON.stringify(d));if(!sa[e])throw new X(a.UNIDENTIFIED_KEYX_SCHEME,e);Ma(b,j,{result:function(d){c(i,function(){var c=b.getKeyExchangeFactory(e);if(!c)throw new X(a.KEYX_FACTORY_NOT_FOUND,
e);return c.createResponseData(b,d,g)})},error:function(a){i.error(a)}})})}})();var ua;(function(){var b=x.Class.create({init:function(a,b){Object.defineProperties(this,{keyResponseData:{value:a,writable:!1,configurable:!1},cryptoContext:{value:b,writable:!1,configurable:!1}})}});ua=x.Class.create({init:function(a){Object.defineProperties(this,{scheme:{value:a,writable:!1,configurable:!1}})},createRequestData:function(){},createResponseData:function(){},generateResponse:function(){},getCryptoContext:function(){},
generateSessionKeys:function(b,d){c(d,function(){var c=new Uint8Array(16),e=new Uint8Array(32);b.getRandom().nextBytes(c);b.getRandom().nextBytes(e);Ia(za,c,{result:function(b){Ia(Aa,e,{result:function(a){d.result({encryptionKey:b,hmacKey:a})},error:function(b){d.error(new s(a.SESSION_KEY_CREATION_FAILURE,null,b))}})},error:function(b){d.error(new s(a.SESSION_KEY_CREATION_FAILURE,null,b))}})})},importSessionKeys:function(a,b,c){Ia(za,a,{result:function(a){Ia(Aa,b,{result:function(b){c.result({encryptionKey:a,
hmacKey:b})},error:function(a){c.error(a)}})},error:function(a){c.error(a)}})}});ua.KeyExchangeData=b})();var Qb,Rb,xb,Cc;(function(){function b(g,c,e,k,f){switch(e){case d.JWE_RSA:case d.JWEJS_RSA:return new Da(g,Ea.RSA_OAEP,ya,k,f);default:throw new s(a.UNSUPPORTED_KEYX_MECHANISM,e.name());}}var d=Rb={RSA:"RSA",ECC:"ECC",JWE_RSA:"JWE_RSA",JWEJS_RSA:"JWEJS_RSA"},i=xb=ib.extend({init:function h(a,b,c,e){h.base.call(this,sa.ASYMMETRIC_WRAPPED);Object.defineProperties(this,{keyPairId:{value:a,writable:!1,
configurable:!1},mechanism:{value:b,writable:!1,configurable:!1},publicKey:{value:c,writable:!1,configurable:!1},privateKey:{value:e,writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.keypairid=this.keyPairId;a.mechanism=this.mechanism;a.publickey=C(this.publicKey.getEncoded());return a},equals:function y(a){if(a===this)return!0;if(!(a instanceof xb))return!1;var b=this.privateKey===a.privateKey||this.privateKey&&a.privateKey&&ka(this.privateKey.getEncoded(),a.privateKey.getEncoded());
return y.base.call(this,a)&&this.keyPairId==a.keyPairId&&this.mechanism==a.mechanism&&ka(this.publicKey.getEncoded(),a.publicKey.getEncoded())&&b},uniqueKey:function k(){var a=this.publicKey.getEncoded(),b=this.privateKey&&this.privateKey.getEncoded(),a=k.base.call(this)+":"+this.keyPairId+":"+this.mechanism+":"+ta(a);b&&(a+=":"+ta(b));return a}}),j=function(b,f){c(f,function(){var c=b.keypairid,e=b.mechanism,m=b.publickey;if(!c||"string"!==typeof c||!e||!m||"string"!==typeof m)throw new A(a.JSON_PARSE_ERROR,
"keydata "+JSON.stringify(b));if(!d[e])throw new X(a.UNIDENTIFIED_KEYX_MECHANISM,e);try{var I=M(m);switch(e){case d.JWE_RSA:case d.JWEJS_RSA:lc("RSA-OAEP",I,{result:function(a){f.result(new i(c,e,a,null))},error:function(a){f.error(a)}});break;default:throw new s(a.UNSUPPORTED_KEYX_MECHANISM,e);}}catch(t){if(!(t instanceof l))throw new s(a.INVALID_PUBLIC_KEY,"keydata "+JSON.stringify(b),t);throw t;}})},e=Cc=jb.extend({init:function f(a,b,c,e){f.base.call(this,a,sa.ASYMMETRIC_WRAPPED);Object.defineProperties(this,
{keyPairId:{value:b,writable:!1,configurable:!1},encryptionKey:{value:c,writable:!1,configurable:!1},hmacKey:{value:e,writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.keypairid=this.keyPairId;a.encryptionkey=C(this.encryptionKey);a.hmackey=C(this.hmacKey);return a},equals:function u(a){return this===a?!0:!(a instanceof Cc)?!1:u.base.call(this,a)&&this.keyPairId==a.keyPairId&&ka(this.encryptionKey,a.encryptionKey)&&ka(this.hmacKey,a.hmacKey)},uniqueKey:function G(){return G.base.call(this)+
":"+this.keyPairId+":"+ta(this.encryptionKey)+":"+ta(this.hmacKey)}});Qb=ua.extend({init:function m(){m.base.call(this,sa.ASYMMETRIC_WRAPPED)},createRequestData:function(a,b,c){j(b,c)},createResponseData:function(b,c,d){var b=d.keypairid,r=d.encryptionkey,i=d.hmackey;if(!b||"string"!==typeof b||!r||"string"!==typeof r||!i||"string"!==typeof i)throw new A(a.JSON_PARSE_ERROR,"keydata "+JSON.stringify(d));var p;try{p=M(r)}catch(j){throw new s(a.INVALID_ENCRYPTION_KEY,"keydata "+JSON.stringify(d),j);
}var n;try{n=M(i)}catch(E){throw new s(a.INVALID_HMAC_KEY,"keydata "+JSON.stringify(d),E);}return new e(c,b,p,n)},generateResponse:function(a,d,t,r){function p(e,t){c(r,function(){var v=d,i=b(a,v.keyPairId,v.mechanism,null,v.publicKey);i.wrap(e,{result:function(a){c(r,function(){i.wrap(t,{result:function(b){j(e,a,t,b)},error:function(a){r.error(a)}})},N)},error:function(a){r.error(a)}})},N)}function j(b,i,v,p){c(r,function(){var j=d,n=a.getTokenFactory();t instanceof wa?n.renewMasterToken(a,t,b,v,
{result:function(b){c(r,function(){var c=new oa(a,b),d=new e(b,j.keyPairId,i,p);return new ua.KeyExchangeData(d,c,r)},N)},error:function(a){r.error(a)}}):n.createMasterToken(a,t,b,v,{result:function(b){c(r,function(){var c=new oa(a,b),d=new e(b,j.keyPairId,i,p);return new ua.KeyExchangeData(d,c,r)},N)},error:function(a){r.error(a)}})},N)}var N=this;c(r,function(){if(!(d instanceof i))throw new o("Key request data "+JSON.stringify(d)+" was not created by this factory.");this.generateSessionKeys(a,
{result:function(a){p(a.encryptionKey,a.hmacKey)},error:function(a){r.error(a)}})},N)},getCryptoContext:function(d,p,t,r,j){var B=this;c(j,function(){if(!(p instanceof i))throw new o("Key request data "+JSON.stringify(p)+" was not created by this factory.");if(!(t instanceof e))throw new o("Key response data "+JSON.stringify(t)+" was not created by this factory.");var r=p.keyPairId,U=t.keyPairId;if(r!=U)throw new X(a.KEYX_RESPONSE_REQUEST_MISMATCH,"request "+r+"; response "+U);U=p.privateKey;if(!U)throw new X(a.KEYX_PRIVATE_KEY_MISSING,
"request Asymmetric private key");var E=b(d,r,p.mechanism,U,null);E.unwrap(t.encryptionKey,za,{result:function(a){E.unwrap(t.hmacKey,Aa,{result:function(b){d.getEntityAuthenticationData(!1,{result:function(e){c(j,function(){var c=e.getIdentity();return new oa(d,t.masterToken,c,a,b)},B)},error:function(a){j.error(a)}})},error:function(a){j.error(a)}})},error:function(a){j.error(a)}})},B)}})})();var Sb,yb,Dc;(function(){function b(e,g,h,i,k){c(k,function(){switch(g){case d.SESSION:if(!h)throw new X(a.KEYX_MASTER_TOKEN_MISSING,
g);var b=e.getMslStore().getCryptoContext(h);if(b)return b;if(!h.isDecrypted())throw new Ca(a.MASTERTOKEN_UNTRUSTED,h);return new oa(e,h);case d.PSK:var b=new Fa(i),c=e.getEntityAuthenticationFactory(R.PSK);if(!c)throw new X(a.UNSUPPORTED_KEYX_KEY_ID,g);return c.getCryptoContext(e,b);case d.MGK:b=new Ga(i);c=e.getEntityAuthenticationFactory(R.MGK);if(!c)throw new X(a.UNSUPPORTED_KEYX_KEY_ID,g);return c.getCryptoContext(e,b);default:throw new X(a.UNSUPPORTED_KEYX_KEY_ID,g);}})}var d={PSK:"PSK",MGK:"MGK",
SESSION:"SESSION"},i=yb=ib.extend({init:function g(a){g.base.call(this,sa.SYMMETRIC_WRAPPED);Object.defineProperties(this,{keyId:{value:a,writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.keyid=this.keyId;return a},equals:function h(a){return this===a?!0:!(a instanceof yb)?!1:h.base.call(this,a)&&this.keyId==a.keyId},uniqueKey:function y(){return y.base.call(this)+":"+this.keyId}}),j=Dc=jb.extend({init:function k(a,b,c,d){k.base.call(this,a,sa.SYMMETRIC_WRAPPED);Object.defineProperties(this,
{keyId:{value:b,writable:!1,configurable:!1},encryptionKey:{value:c,writable:!1,configurable:!1},hmacKey:{value:d,writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.keyid=this.keyId;a.encryptionkey=C(this.encryptionKey);a.hmackey=C(this.hmacKey);return a},equals:function f(a){return this===a?!0:!(a instanceof Dc)?!1:f.base.call(this,a)&&this.keyId==a.keyId&&ka(this.encryptionKey,a.encryptionKey)&&ka(this.hmacKey,a.hmacKey)},uniqueKey:function u(){return u.base.call(this)+":"+this.keyId+
":"+ta(this.encryptionKey)+":"+ta(this.hmacKey)}});Sb=ua.extend({init:function G(){G.base.call(this,sa.SYMMETRIC_WRAPPED)},createRequestData:function(b,m,j){c(j,function(){var b=m.keyid;if(!b||"string"!==typeof b)throw new A(a.JSON_PARSE_ERROR,"keydata "+JSON.stringify(m));if(!d[b])throw new X(a.UNIDENTIFIED_KEYX_KEY_ID,b);return new i(b)},this)},createResponseData:function(b,c,i){var b=i.keyid,t=i.encryptionkey,r=i.hmackey;if(!b||"string"!==typeof b||!t||"string"!==typeof t||!r||"string"!==typeof r)throw new A(a.JSON_PARSE_ERROR,
"keydata "+JSON.stringify(i));if(!d[b])throw new X(a.UNIDENTIFIED_KEYX_KEY_ID,b);var n;try{n=M(t)}catch(B){throw new s(a.INVALID_ENCRYPTION_KEY,"keydata "+JSON.stringify(i),B);}var N;try{N=M(r)}catch(U){throw new s(a.INVALID_HMAC_KEY,"keydata "+JSON.stringify(i),U);}return new j(c,b,n,N)},generateResponse:function(d,m,p,t){function r(r,i){c(t,function(){var c=m,v,j;if("string"!==typeof p){if(!p.isVerified())throw new Ca(a.MASTERTOKEN_UNTRUSTED,p);v=p;j=v.identity}else v=null,j=p;b(d,c.keyId,v,j,{result:function(a){a.wrap(r,
{result:function(b){a.wrap(i,{result:function(a){H(r,b,i,a)},error:function(a){t.error(a)}})},error:function(a){t.error(a)}})},error:function(a){t.error(a)}})},B)}function H(a,b,r,v){c(t,function(){var i=m,ja=d.getTokenFactory();p instanceof wa?ja.renewMasterToken(d,p,a,r,{result:function(a){c(t,function(){var c;try{c=new oa(d,a)}catch(m){if(m instanceof Ca)throw new o("Master token constructed by token factory is not trusted.",m);throw m;}var r=new j(a,i.keyId,b,v);return new ua.KeyExchangeData(r,
c)},B)},error:function(a){t.error(a)}}):ja.createMasterToken(d,p,a,r,{result:function(a){c(t,function(){var c;try{c=new oa(d,a)}catch(m){if(m instanceof Ca)throw new o("Master token constructed by token factory is not trusted.",m);throw m;}var r=new j(a,i.keyId,b,v);return new ua.KeyExchangeData(r,c)},B)},error:function(a){t.error(a)}})},B)}var B=this;c(t,function(){if(!(m instanceof i))throw new o("Key request data "+JSON.stringify(m)+" was not created by this factory.");this.generateSessionKeys(d,
{result:function(a){r(a.encryptionKey,a.hmacKey)},error:function(a){t.error(a)}})},B)},getCryptoContext:function(d,m,p,t,r){var H=this;c(r,function(){if(!(m instanceof i))throw new o("Key request data "+JSON.stringify(m)+" was not created by this factory.");if(!(p instanceof j))throw new o("Key response data "+JSON.stringify(p)+" was not created by this factory.");var B=m.keyId,N=p.keyId;if(B!=N)throw new X(a.KEYX_RESPONSE_REQUEST_MISMATCH,"request "+B+"; response "+N);d.getEntityAuthenticationData(!1,
{result:function(a){c(r,function(){var m=a.getIdentity();b(d,N,t,m,{result:function(a){a.unwrap(p.encryptionKey,za,{result:function(b){a.unwrap(p.hmacKey,Aa,{result:function(a){d.getEntityAuthenticationData(!1,{result:function(m){c(r,function(){var c=m.getIdentity();return new oa(d,p.masterToken,c,b,a)},H)},error:function(a){r.error(a)}})},error:function(a){r.error(a)}})},error:function(a){r.error(a)}})},error:function(a){r.error(a)}})},H)},error:function(a){r.error(a)}})},H)}})})();var Tb,zb,Ec,
Ub;(function(){function b(e,g,h,i,k){c(k,function(){switch(g){case d.PSK:var b=new Fa(i),j=e.getEntityAuthenticationFactory(R.PSK);if(!j)throw new X(a.UNSUPPORTED_KEYX_MECHANISM,g);b=j.getCryptoContext(e,b);return new Da(e,Ea.A128KW,ya,b.wrapKey);case d.MGK:b=new Ga(i);j=e.getEntityAuthenticationFactory(R.MGK);if(!j)throw new X(a.UNSUPPORTED_KEYX_MECHANISM,g);b=j.getCryptoContext(e,b);return new Da(e,Ea.A128KW,ya,b.wrapKey);case d.WRAP:b=e.getMslCryptoContext();b.unwrap(h,ab,{result:function(a){c(k,
function(){return new Da(e,Ea.A128KW,ya,a)})},error:k.error});break;default:throw new X(a.UNSUPPORTED_KEYX_MECHANISM,g);}})}var d={PSK:"PSK",MGK:"MGK",WRAP:"WRAP"},i=zb=ib.extend({init:function g(a,b){g.base.call(this,sa.JWE_LADDER);switch(a){case d.WRAP:if(!b)throw new o("Previous wrapping key based key exchange requires the previous wrapping key data and ID.");break;default:b=null}Object.defineProperties(this,{mechanism:{value:a,writable:!1,configurable:!1},wrapdata:{value:b,writable:!1,configurable:!1}})},
getKeydata:function(){var a={};a.mechanism=this.mechanism;this.wrapdata&&(a.wrapdata=C(this.wrapdata));return a},equals:function h(a){return a===this?!0:!(a instanceof zb)?!1:h.base.call(this,a)&&this.mechanism==a.mechanism&&ka(this.wrapdata,a.wrapdata)},uniqueKey:function y(){var a=y.base.call(this)+":"+this.mechanism;this.wrapdata&&(a+=":"+ta(this.wrapdata));return a}}),j=Ec=jb.extend({init:function k(a,b,c,d,i){k.base.call(this,a,sa.JWE_LADDER);Object.defineProperties(this,{wrapKey:{value:b,writable:!1,
configurable:!1},wrapdata:{value:c,writable:!1,configurable:!1},encryptionKey:{value:d,writable:!1,configurable:!1},hmacKey:{value:i,writable:!1,configurable:!1}})},getKeydata:function(){var a={};a.wrapkey=C(this.wrapKey);a.wrapdata=C(this.wrapdata);a.encryptionkey=C(this.encryptionKey);a.hmackey=C(this.hmacKey);return a},equals:function f(a){return this===a?!0:!(a instanceof Ec)?!1:f.base.call(this,a)&&ka(this.wrapKey,a.wrapKey)&&ka(this.wrapdata,a.wrapdata)&&ka(this.encryptionKey,a.encryptionKey)&&
ka(this.hmacKey,a.hmacKey)},uniqueKey:function u(){return u.base.call(this)+":"+ta(this.wrapKey)+":"+ta(this.wrapdata)+":"+ta(this.encryptionKey)+":"+ta(this.hmacKey)}});Ub=x.Class.create({addCryptoContext:function(){},getCryptoContext:function(){},removeCryptoContext:function(){}});Tb=ua.extend({init:function G(a){G.base.call(this,sa.JWE_LADDER);Object.defineProperties(this,{repository:{value:a,writable:!1,enumerable:!1,configurable:!1}})},createRequestData:function(b,m,j){c(j,function(){var b=m.mechanism,
c=m.wrapdata;if(!b||b==d.WRAP&&(!c||"string"!==typeof c))throw new A(a.JSON_PARSE_ERROR,"keydata "+JSON.stringify(m));if(!d[b])throw new X(a.UNIDENTIFIED_KEYX_MECHANISM,b);var j;switch(b){case d.WRAP:try{j=M(c)}catch(n){throw new X(a.KEYX_WRAPPING_KEY_MISSING,"keydata "+m.toString());}if(null==j||0==j.length)throw new X(a.KEYX_WRAPPING_KEY_MISSING,"keydata "+m.toString());break;default:j=null}return new i(b,j)})},createResponseData:function(b,c,d){var b=d.wrapkey,i=d.wrapdata,r=d.encryptionkey,p=
d.hmackey;if(!b||"string"!==typeof b||!i||"string"!==typeof i||!r||"string"!==typeof r||!p||"string"!==typeof p)throw new A(a.JSON_PARSE_ERROR,"keydata "+JSON.stringify(d));var n,N,l,E;try{n=M(b),N=M(i)}catch(v){throw new s(a.INVALID_SYMMETRIC_KEY,"keydata "+JSON.stringify(d),v);}try{l=M(r)}catch(Ta){throw new s(a.INVALID_ENCRYPTION_KEY,"keydata "+JSON.stringify(d),Ta);}try{E=M(p)}catch(ja){throw new s(a.INVALID_HMAC_KEY,"keydata "+JSON.stringify(d),ja);}return new j(c,n,N,l,E)},generateResponse:function(d,
m,p,t){function r(a,b,m){l.generateSessionKeys(d,{result:function(d){c(t,function(){H(a,b,m,d.encryptionKey,d.hmacKey)},l)},error:t.error})}function H(a,v,i,r,j){c(t,function(){var c=m;b(d,c.mechanism,c.wrapdata,a,{result:function(a){a.wrap(v,{result:function(a){B(v,i,r,j,a)},error:t.error})},error:t.error})},l)}function B(a,b,m,i,r){c(t,function(){var c=new Da(d,Ea.A128KW,ya,a);c.wrap(m,{result:function(a){c.wrap(i,{result:function(c){N(b,r,m,a,i,c)},error:t.error})},error:t.error})},l)}function N(a,
b,m,i,r,J){c(t,function(){var ga=d.getTokenFactory();p instanceof wa?ga.renewMasterToken(d,p,m,r,{result:function(m){c(t,function(){var c=new oa(d,m),r=new j(m,b,a,i,J);return new ua.KeyExchangeData(r,c,t)},l)},error:function(a){t.error(a)}}):ga.createMasterToken(d,p,m,r,{result:function(m){c(t,function(){var c=new oa(d,m),r=new j(m,b,a,i,J);return new ua.KeyExchangeData(r,c,t)},l)},error:function(a){t.error(a)}})},l)}var l=this;c(t,function(){if(!(m instanceof i))throw new o("Key request data "+
JSON.stringify(m)+" was not created by this factory.");var b=p;if(p instanceof wa){if(!p.isVerified())throw new Ca(a.MASTERTOKEN_UNTRUSTED,p);b=p.identity}var v=new Uint8Array(16);d.getRandom().nextBytes(v);Ia(ab,v,{result:function(a){c(t,function(){d.getMslCryptoContext().wrap(a,{result:function(c){r(b,a,c)},error:t.error})},l)},error:function(b){t.error(new s(a.WRAP_KEY_CREATION_FAILURE,null,b))}})},l)},getCryptoContext:function(b,m,n,t,r){function H(a,d,m,v){c(r,function(){var i=new Da(b,Ea.A128KW,
ya,v);i.unwrap(a.encryptionKey,za,{result:function(v){i.unwrap(a.hmacKey,Aa,{result:function(j){c(r,function(){this.repository.addCryptoContext(a.wrapdata,i);this.repository.removeCryptoContext(d);return new oa(b,a.masterToken,m,v,j)},B)},error:r.error})},error:r.error})},B)}var B=this;c(r,function(){if(!(m instanceof i))throw new o("Key request data "+JSON.stringify(m)+" was not created by this factory.");if(!(n instanceof j))throw new o("Key response data "+JSON.stringify(n)+" was not created by this factory.");
var t=m.mechanism,l=m.wrapdata;b.getEntityAuthenticationData(!1,{result:function(m){c(r,function(){var c=m.getIdentity(),i;switch(t){case d.PSK:i=new Fa(c);var j=b.getEntityAuthenticationFactory(R.PSK);if(!j)throw new X(a.UNSUPPORTED_KEYX_MECHANISM,t);i=j.getCryptoContext(b,i);i=new Da(b,Ea.A128KW,ya,i.wrapKey);break;case d.MGK:i=new Ga(c);j=b.getEntityAuthenticationFactory(R.MGK);if(!j)throw new X(a.UNSUPPORTED_KEYX_MECHANISM,t);i=j.getCryptoContext(b,i);i=new Da(b,Ea.A128KW,ya,i.wrapKey);break;
case d.WRAP:i=this.repository.getCryptoContext(l);if(!i)throw new X(a.KEYX_WRAPPING_KEY_MISSING,C(l));break;default:throw new X(a.UNSUPPORTED_KEYX_MECHANISM,t);}i.unwrap(n.wrapKey,ab,{result:function(a){H(n,l,c,a)},error:r.error})},B)},error:r.error})},B)}})})();var Fc=x.Class.create({init:function(a){var b=ha.parser(),c=[],d=[],e,g,h,y=0,k=!1;b.onerror=function(){k||(k=!0,b.end())};b.onopenobject=function(a){if(e)e[h]={},d.push(e),e=e[h];else if(g){var b={};d.push(g);g.push(b);e=b;g=void 0}else e=
{};h=a};b.oncloseobject=function(){var a=d.pop();a?"object"===typeof a?e=a:(e=void 0,g=a):(c.push(e),y=b.index,e=void 0)};b.onopenarray=function(){if(e)e[h]=[],d.push(e),g=e[h],e=void 0;else if(g){var a=[];d.push(g);g.push(a);g=a}else g=[]};b.onclosearray=function(){var a=d.pop();a?"object"===typeof a?(e=a,g=void 0):g=a:(c.push(g),y=b.index,g=void 0)};b.onkey=function(a){h=a};b.onvalue=function(a){e?e[h]=a:g?g.push(a):(c.push(a),y=b.index)};b.write(a).close();Object.defineProperties(this,{_values:{value:c,
writable:!1,enumerable:!1,configurable:!1},_lastIndex:{value:y,writable:!0,enumerable:!1,configurable:!1}})},more:function(){return 0<this._values.length},nextValue:function(){return 0==this._values.length?void 0:this._values.shift()},lastIndex:function(){return this._lastIndex}}),Gc,Vb,Hc,Ic,Jc,Wb;(function(){var b=Vb="entityauthdata",d=Hc="mastertoken",i=Ic="headerdata",j=Jc="errordata",e=Wb="signature";Gc=function(g,h,y,k){c(k,function(){var c=h[b],u=h[d],l=h[e];if(c&&"object"!==typeof c||u&&"object"!==
typeof u||"string"!==typeof l)throw new A(a.JSON_PARSE_ERROR,"header/errormsg "+JSON.stringify(h));var m;try{m=M(l)}catch(I){throw new K(a.HEADER_SIGNATURE_INVALID,"header/errormsg "+JSON.stringify(h),I);}var t=null;c&&(t=qc(g,c));var r=h[i];if(void 0!=r&&null!=r){if("string"!==typeof r)throw new A(a.JSON_PARSE_ERROR,"header/errormsg "+JSON.stringify(h));u?Ma(g,u,{result:function(a){Xb(g,r,t,a,m,y,k)},error:function(a){k.error(a)}}):Xb(g,r,t,null,m,y,k)}else if(c=h[j],void 0!=c&&null!=c){if("string"!==
typeof c)throw new A(a.JSON_PARSE_ERROR,"header/errormsg "+JSON.stringify(h));Kc(g,c,t,m,k)}else throw new A(a.JSON_PARSE_ERROR,JSON.stringify(h));})}})();var Na,Lc,Kc;(function(){function d(a,b){this.errordata=a;this.signature=b}Na=x.Class.create({init:function(b,d,j,e,g,h,y,k,f){var u=this;c(f,function(){0>g&&(g=-1);if(0>j||j>P)throw new o("Message ID "+j+" is out of range.");if(!d)throw new K(a.MESSAGE_ENTITY_NOT_FOUND);if(k)return Object.defineProperties(this,{entityAuthenticationData:{value:d,
writable:!1,configurable:!1},messageId:{value:j,writable:!1,configurable:!1},errorCode:{value:e,writable:!1,configurable:!1},internalCode:{value:g,writable:!1,configurable:!1},errorMessage:{value:h,writable:!1,configurable:!1},userMessage:{value:y,writable:!1,configurable:!1},errordata:{value:k.errordata,writable:!1,enumerable:!1,configurable:!1},signature:{value:k.signature,writable:!1,enumerable:!1,configurable:!1}}),this;var n={};n.messageid=j;n.errorcode=e;0<g&&(n.internalcode=g);h&&(n.errormsg=
h);y&&(n.usermsg=y);var m=b.getEntityAuthenticationFactory(d.scheme).getCryptoContext(b,d),n=W(JSON.stringify(n),S);m.encrypt(n,{result:function(a){c(f,function(){m.sign(a,{result:function(b){c(f,function(){Object.defineProperties(this,{entityAuthenticationData:{value:d,writable:!1,configurable:!1},messageId:{value:j,writable:!1,configurable:!1},errorCode:{value:e,writable:!1,configurable:!1},internalCode:{value:g,writable:!1,configurable:!1},errorMessage:{value:h,writable:!1,configurable:!1},userMessage:{value:y,
writable:!1,configurable:!1},errordata:{value:a,writable:!1,enumerable:!1,configurable:!1},signature:{value:b,writable:!1,enumerable:!1,configurable:!1}});return this},u)},error:function(a){f.error(a)}})},u)},error:function(a){f.error(a)}})},u)},toJSON:function(){var a={};a[Vb]=this.entityAuthenticationData;a[Jc]=C(this.errordata);a[Wb]=C(this.signature);return a}});Lc=function(a,b,c,d,g,h,n,k){new Na(a,b,c,d,g,h,n,null,k)};Kc=function(p,i,j,e,g){c(g,function(){if(!j)throw new K(a.MESSAGE_ENTITY_NOT_FOUND);
var h=j.scheme,y=p.getEntityAuthenticationFactory(h);if(!y)throw new Ba(a.ENTITYAUTH_FACTORY_NOT_FOUND,h);var k=y.getCryptoContext(p,j);try{i=M(i)}catch(f){throw new K(a.HEADER_DATA_INVALID,i,f);}if(!i||0==i.length)throw new K(a.HEADER_DATA_MISSING,i);k.verify(i,e,{result:function(f){c(g,function(){if(!f)throw new s(a.MESSAGE_VERIFICATION_FAILED);k.decrypt(i,{result:function(f){c(g,function(){var c=aa(f,S),h;try{h=JSON.parse(c)}catch(k){if(k instanceof SyntaxError)throw new A(a.JSON_PARSE_ERROR,"errordata "+
c,k);throw k;}var r=parseInt(h.messageid),u=parseInt(h.errorcode),y=parseInt(h.internalcode),l=h.errormsg,U=h.usermsg;if(!r||r!=r||!u||u!=u||h.internalcode&&y!=y||l&&"string"!==typeof l||U&&"string"!==typeof U)throw new A(a.JSON_PARSE_ERROR,"errordata "+c);if(0>r||r>P)throw new K(a.MESSAGE_ID_OUT_OF_RANGE,"errordata "+c);h=!1;for(var E in b)if(b[E]==u){h=!0;break}h||(u=b.FAIL);if(y){if(0>y)throw(new K(a.INTERNAL_CODE_NEGATIVE,"errordata "+c)).setMessageId(r);}else y=-1;c=new d(i,e);new Na(p,j,r,u,
y,l,U,c,g)})},error:function(a){g.error(a)}})})},error:function(a){g.error(a)}})})}})();var Bd=x.Class.create({getUserMessage:function(){}}),kb,Mc,Yb;(function(){Yb=function(a,b){if(!a||!b)return null;var c=a.compressionAlgorithms.filter(function(a){for(var c=0;c<b.compressionAlgorithms.length;++c)if(a==b.compressionAlgorithms[c])return!0;return!1}),d=a.languages.filter(function(a){for(var c=0;c<b.languages.length;++c)if(a==b.languages[c])return!0;return!1});return new kb(c,d)};kb=x.Class.create({init:function(a,
b){a||(a=[]);b||(b=[]);a.sort();Object.defineProperties(this,{compressionAlgorithms:{value:a,writable:!1,enumerable:!0,configurable:!1},languages:{value:b,writable:!1,enumerable:!0,configurable:!1}})},toJSON:function(){var a={};a.compressionalgos=this.compressionAlgorithms;a.languages=this.languages;return a},equals:function(a){return this===a?!0:!(a instanceof kb)?!1:tb(this.compressionAlgorithms,a.compressionAlgorithms)&&(this.compressionAlgorithms.length==a.compressionAlgorithms.length||tb(a.compressionAlgorithms,
this.compressionAlgorithms))&&tb(this.languages,a.languages)&&(this.languages.length==a.languages.length||tb(a.languages,this.languages))},uniqueKey:function(){return this.compressionAlgorithms.join(":")+"|"+this.languages.join(":")}});Mc=function(b){var c=b.compressionalgos,d=b.languages;if(c&&!(c instanceof Array)||d&&!(d instanceof Array))throw new A(a.JSON_PARSE_ERROR,"capabilities "+JSON.stringify(b));for(var b=[],j=0;c&&j<c.length;++j){var e=c[j];Ab[e]&&b.push(e)}return new kb(b,d)}})();var Ja,
Nc,Xb,Oc,Pc;(function(){function b(a,c,g,d,f){this.customer=a;this.sender=c;this.messageCryptoContext=g;this.headerdata=d;this.signature=f}function d(a,b,c,g,f,e,h,i,j,v,k,p,u,J,y,T,n,l,G){return{cryptoContext:{value:a,writable:!1,configurable:!1},customer:{value:b,writable:!1,configurable:!1},entityAuthenticationData:{value:c,writable:!1,configurable:!1},masterToken:{value:g,writable:!1,configurable:!1},sender:{value:f,writable:!1,configurable:!1},messageId:{value:e,writable:!1,configurable:!1},
keyRequestData:{value:h,writable:!1,configurable:!1},keyResponseData:{value:i,writable:!1,configurable:!1},userAuthenticationData:{value:j,writable:!1,configurable:!1},userIdToken:{value:v,writable:!1,configurable:!1},serviceTokens:{value:k,writable:!1,configurable:!1},peerMasterToken:{value:p,writable:!1,configurable:!1},peerUserIdToken:{value:u,writable:!1,configurable:!1},peerServiceTokens:{value:J,writable:!1,configurable:!1},messageCapabilities:{value:n,writable:!1,configurable:!1},nonReplayable:{value:y,
writable:!1,enumerable:!1,configurable:!1},renewable:{value:T,writable:!1,enumerable:!1,configurable:!1},headerdata:{value:l,writable:!1,enumerable:!1,configurable:!1},signature:{value:G,writable:!1,enumerable:!1,configurable:!1}}}function i(b,c,g){if(g){if(c=b.getMslStore().getCryptoContext(g))return c;if(!g.isVerified()||!g.isDecrypted())throw new Ca(a.MASTERTOKEN_UNTRUSTED,g);return new oa(b,g)}var g=c.scheme,d=b.getEntityAuthenticationFactory(g);if(!d)throw new Ba(a.ENTITYAUTH_FACTORY_NOT_FOUND,
g);return d.getCryptoContext(b,c)}function j(b,g,d,f,e){c(e,function(){g.verify(d,f,{result:function(b){c(e,function(){if(!b)throw new s(a.MESSAGE_VERIFICATION_FAILED);g.decrypt(d,{result:function(a){c(e,function(){return aa(a,S)})},error:function(a){e.error(a)}})})},error:function(a){e.error(a)}})})}function e(a,b,g){c(g,function(){if(b)Bc(a,b,g);else return null})}function g(a,b,g,d){c(d,function(){if(b)Ya(a,b,g,d);else return null})}function h(a,b,g,d){c(d,function(){if(g)Qc(a,b,g,d);else return null})}
function y(b,g,d,f,e,h){function i(b,m,h){if(m>=b.length){var k=[],p;for(p in j)k.push(j[p]);h.result(k)}else{k=b[m];if("object"!==typeof k)throw new A(a.JSON_PARSE_ERROR,"headerdata "+e);Zb(k,g,d,f,{result:function(a){c(h,function(){j[a.uniqueKey()]=a;i(b,m+1,h)})},error:function(a){h.error(a)}})}}var j={};c(h,function(){if(b){if(!(b instanceof Array))throw new A(a.JSON_PARSE_ERROR,"headerdata "+e);i(b,0,h)}else return[]})}function k(b,g,d,f,e,h){function i(b,g,d){c(d,function(){var c=g.peermastertoken;
if(c&&"object"!==typeof c)throw new A(a.JSON_PARSE_ERROR,"headerdata "+e);if(!c)return null;Ma(b,c,d)})}function j(b,g,d,f){c(f,function(){var c=g.peeruseridtoken;if(c&&"object"!==typeof c)throw new A(a.JSON_PARSE_ERROR,"headerdata "+e);if(!c)return null;Ya(b,c,d,f)})}c(h,function(){if(!b.isPeerToPeer())return{peerMasterToken:null,peerUserIdToken:null,peerServiceTokens:[]};i(b,g,{result:function(a){c(h,function(){var v=d?d.masterToken:a;j(b,g,v,{result:function(b){c(h,function(){y(g.peerservicetokens,
v,b,f,e,{result:function(g){c(h,function(){return{peerMasterToken:a,peerUserIdToken:b,peerServiceTokens:g}})},error:function(a){h.error(a)}})})},error:function(a){h.error(a)}})})},error:function(a){h.error(a)}})})}function f(b,g,d,f){function e(a,g){c(f,function(){if(g>=a.length)return h;Ac(b,a[g],{result:function(b){c(f,function(){h.push(b);e(a,g+1)})},error:function(a){f.error(a)}})})}var h=[];c(f,function(){var b=g.keyrequestdata;if(!b)return h;if(!(b instanceof Array))throw new A(a.JSON_PARSE_ERROR,
"headerdata "+d);e(b,0)})}var u=Oc=x.Class.create({init:function(a,b,c,g,d,f,e,h,i){Object.defineProperties(this,{messageId:{value:a,writable:!1,configurable:!1},nonReplayable:{value:b,writable:!1,configurable:!1},renewable:{value:c,writable:!1,configurable:!1},capabilities:{value:g,writable:!1,configurable:!1},keyRequestData:{value:d,writable:!1,configurable:!1},keyResponseData:{value:f,writable:!1,configurable:!1},userAuthData:{value:e,writable:!1,configurable:!1},userIdToken:{value:h,writable:!1,
configurable:!1},serviceTokens:{value:i,writable:!1,configurable:!1}})}}),G=Pc=x.Class.create({init:function(a,b,c){Object.defineProperties(this,{peerMasterToken:{value:a,writable:!1,configurable:!1},peerUserIdToken:{value:b,writable:!1,configurable:!1},peerServiceTokens:{value:c,writable:!1,configurable:!1}})}});Ja=x.Class.create({init:function(a,b,g,f,e,h,j){function k(v){c(j,function(){b=!g?b:null;var k=f.nonReplayable,y=f.renewable,n=f.capabilities,J=f.messageId,ga=f.keyRequestData?f.keyRequestData:
[],T=f.keyResponseData,pa=f.userAuthData,G=f.userIdToken,U=f.serviceTokens?f.serviceTokens:[],va,O,fa;a.isPeerToPeer()?(va=e.peerMasterToken,O=e.peerUserIdToken,fa=e.peerServiceTokens?e.peerServiceTokens:[]):(O=va=null,fa=[]);if(0>J||J>P)throw new o("Message ID "+J+" is out of range.");if(!b&&!g)throw new o("Message entity authentication data or master token must be provided.");var V,qa;T?a.isPeerToPeer()?(V=g,qa=T.masterToken):(V=T.masterToken,qa=va):(V=g,qa=va);if(G&&(!V||!G.isBoundTo(V)))throw new o("User ID token must be bound to a master token.");
if(O&&(!qa||!O.isBoundTo(qa)))throw new o("Peer user ID token must be bound to a peer master token.");U.forEach(function(a){if(a.isMasterTokenBound()&&(!V||!a.isBoundTo(V)))throw new o("Master token bound service tokens must be bound to the provided master token.");if(a.isUserIdTokenBound()&&(!G||!a.isBoundTo(G)))throw new o("User ID token bound service tokens must be bound to the provided user ID token.");},this);fa.forEach(function(a){if(a.isMasterTokenBound()&&(!qa||!a.isBoundTo(qa)))throw new o("Master token bound peer service tokens must be bound to the provided peer master token.");
if(a.isUserIdTokenBound()&&(!O||!a.isBoundTo(O)))throw new o("User ID token bound peer service tokens must be bound to the provided peer user ID token.");},this);if(h){var mb=h.customer,na=h.messageCryptoContext,ea=d(na,mb,b,g,v,J,ga,T,pa,G,U,va,O,fa,k,y,n,h.headerdata,h.signature);Object.defineProperties(this,ea);return this}var mb=G?G.customer:null,ea={};v&&(ea.sender=v);ea.messageid=J;ea.nonreplayable=k;ea.renewable=y;n&&(ea.capabilities=n);0<ga.length&&(ea.keyrequestdata=ga);T&&(ea.keyresponsedata=
T);pa&&(ea.userauthdata=pa);G&&(ea.useridtoken=G);0<U.length&&(ea.servicetokens=U);va&&(ea.peermastertoken=va);O&&(ea.peeruseridtoken=O);0<fa.length&&(ea.peerservicetokens=fa);var na=i(a,b,g),ea=W(JSON.stringify(ea),S);na.encrypt(ea,{result:function(a){c(j,function(){na.sign(a,{result:function(f){c(j,function(){var c=d(na,mb,b,g,v,J,ga,T,pa,G,U,va,O,fa,k,y,n,a,f);Object.defineProperties(this,c);return this},u)},error:function(a){a instanceof l&&a.setMessageId(J);j.error(a)}})},u)},error:function(a){a instanceof
l&&a.setMessageId(J);j.error(a)}})},u)}var u=this;c(j,function(){h?k(h.sender):g?a.getEntityAuthenticationData(!1,{result:function(a){a=a.getIdentity();k(a)},error:j.error}):k(null)},u)},isEncrypting:function(){return this.masterToken||Hb(this.entityAuthenticationData.scheme)},isNonReplayable:function(){return this.nonReplayable},isRenewable:function(){return this.renewable},toJSON:function(){var a={};this.masterToken?a[Hc]=this.masterToken:a[Vb]=this.entityAuthenticationData;a[Ic]=C(this.headerdata);
a[Wb]=C(this.signature);return a}});Nc=function(a,b,c,g,d,f){new Ja(a,b,c,g,d,null,f)};Xb=function(d,p,t,r,H,B,o){c(o,function(){t=!r?t:null;if(!t&&!r)throw new K(a.MESSAGE_ENTITY_NOT_FOUND);var U=p;try{p=M(U)}catch(E){throw new K(a.HEADER_DATA_INVALID,U,E);}if(!p||0==p.length)throw new K(a.HEADER_DATA_MISSING,U);var v=i(d,t,r);j(d,v,p,H,{result:function(i){c(o,function(){var j;try{j=JSON.parse(i)}catch(ca){if(ca instanceof SyntaxError)throw new A(a.JSON_PARSE_ERROR,"headerdata "+i,ca);throw ca;}var J=
parseInt(j.messageid);if(!J||J!=J)throw new A(a.JSON_PARSE_ERROR,"headerdata "+i);if(0>J||J>P)throw new K(a.MESSAGE_ID_OUT_OF_RANGE,"headerdata "+i);var ga=r?j.sender:null;r&&!ga&&(ga="");var T=j.keyresponsedata;if(T&&"object"!==typeof T)throw(new A(a.JSON_PARSE_ERROR,"headerdata "+i)).setMessageId(J);var pa=o;o={result:function(a){pa.result(a)},error:function(a){a instanceof l&&a.setMessageId(J);pa.error(a)}};e(d,T,{result:function(e){c(o,function(){var T=!d.isPeerToPeer()&&e?e.masterToken:r,ca=
j.useridtoken;if(ca&&"object"!==typeof ca)throw new A(a.JSON_PARSE_ERROR,"headerdata "+i);g(d,ca,T,{result:function(g){c(o,function(){var fa=j.userauthdata;if(fa&&"object"!==typeof fa)throw new A(a.JSON_PARSE_ERROR,"headerdata "+i);h(d,T,fa,{result:function(h){c(o,function(){var fa;if(h){var ca=h.scheme,na=d.getUserAuthenticationFactory(ca);if(!na)throw new L(a.USERAUTH_FACTORY_NOT_FOUND,ca);ca=r?r.identity:t.getIdentity();fa=na.authenticate(d,ca,h,g)}else fa=g?g.customer:null;y(j.servicetokens,T,
g,B,i,{result:function(y){c(o,function(){var T=j.nonreplayable,ca=j.renewable;if("boolean"!==typeof T||"boolean"!==typeof ca)throw new A(a.JSON_PARSE_ERROR,"headerdata "+i);var na=null,pa=j.capabilities;if(pa){if("object"!==typeof pa)throw new A(a.JSON_PARSE_ERROR,"headerdata "+i);na=Mc(pa)}f(d,j,i,{result:function(a){k(d,j,e,B,i,{result:function(f){c(o,function(){var c=f.peerMasterToken,i=f.peerUserIdToken,j=f.peerServiceTokens,k=new u(J,T,ca,na,a,e,h,g,y),c=new G(c,i,j),i=new b(fa,ga,v,p,H);new Ja(d,
t,r,k,c,i,o)})},error:function(a){a instanceof l&&a.setMessageId(J);o.error(a)}})},error:function(a){a instanceof l&&a.setMessageId(J);o.error(a)}})})},error:function(a){a instanceof l&&a.setMessageId(J);o.error(a)}})})},error:function(a){a instanceof l&&a.setMessageId(J);o.error(a)}})})},error:function(a){a instanceof l&&a.setMessageId(J);o.error(a)}})})},error:function(a){a instanceof l&&a.setMessageId(J);o.error(a)}})})},error:function(a){o.error(a)}})})}})();var cc,Rc,Sc,Ab,Tc;(function(){function b(c,
d){switch(c){case i.LZW:return ic(d);case i.GZIP:if(nrdp&&nrdp.compress)return nrdp.compress(d,"gzip",!0);default:throw new l(a.UNSUPPORTED_COMPRESSION,c);}}function d(a,b){this.payload=a;this.signature=b}var i=Ab={GZIP:"GZIP",LZW:"LZW"};Tc=function(a){for(var b=[i.GZIP,i.LZW],c=0;c<b.length&&0<a.length;++c)for(var d=b[c],p=0;p<a.length;++p)if(a[p]==d)return d;return null};cc=x.Class.create({init:function(a,d,g,h,i,k,f,p){var l=this;c(p,function(){if(0>a||a>P)throw new o("Sequence number "+a+" is outside the valid range.");
if(0>d||d>P)throw new o("Message ID "+d+" is outside the valid range.");if(f)return Object.defineProperties(this,{sequenceNumber:{value:a,writable:!1,configurable:!1},messageId:{value:d,writable:!1,configurable:!1},compressionAlgo:{value:h,writable:!1,configurable:!1},data:{value:i,writable:!1,configurable:!1},endofmsg:{value:g,writable:!1,enumerable:!1,configurable:!1},payload:{value:f.payload,writable:!1,enumerable:!1,configurable:!1},signature:{value:f.signature,writable:!1,enumerable:!1,configurable:!1}}),
this;var m;h?(m=b(h,i),m||(h=null,m=i)):(h=null,m=i);var I={};I.sequencenumber=a;I.messageid=d;g&&(I.endofmsg=g);h&&(I.compressionalgo=h);I.data=C(m);m=W(JSON.stringify(I),S);k.encrypt(m,{result:function(b){c(p,function(){k.sign(b,{result:function(f){c(p,function(){Object.defineProperties(this,{sequenceNumber:{value:a,writable:!1,configurable:!1},messageId:{value:d,writable:!1,configurable:!1},compressionAlgo:{value:h,writable:!1,configurable:!1},data:{value:i,writable:!1,configurable:!1},endofmsg:{value:g,
writable:!1,enumerable:!1,configurable:!1},payload:{value:b,writable:!1,enumerable:!1,configurable:!1},signature:{value:f,writable:!1,enumerable:!1,configurable:!1}});return this},l)},error:function(a){p.error(a)}})},l)},error:function(a){p.error(a)}})},l)},isEndOfMessage:function(){return this.endofmsg},toJSON:function(){var a={};a.payload=C(this.payload);a.signature=C(this.signature);return a}});Rc=function(a,b,c,d,i,k,f){new cc(a,b,c,d,i,k,null,f)};Sc=function(b,e,g){c(g,function(){var h=b.payload,
y=b.signature;if(!h||"string"!==typeof h||"string"!==typeof y)throw new A(a.JSON_PARSE_ERROR,"payload chunk "+JSON.stringify(b));var k,f;try{k=M(h)}catch(u){throw new K(a.PAYLOAD_INVALID,"payload chunk "+JSON.stringify(b),u);}try{f=M(y)}catch(n){throw new K(a.PAYLOAD_SIGNATURE_INVALID,"payload chunk "+JSON.stringify(b),n);}e.verify(k,f,{result:function(b){c(g,function(){if(!b)throw new s(a.PAYLOAD_VERIFICATION_FAILED);e.decrypt(k,{result:function(b){c(g,function(){var c=aa(b,S),h;try{h=JSON.parse(c)}catch(m){if(m instanceof
SyntaxError)throw new A(a.JSON_PARSE_ERROR,"payload chunk payload "+c,m);throw m;}var j=parseInt(h.sequencenumber),u=parseInt(h.messageid),y=h.endofmsg,n=h.compressionalgo;h=h.data;if(!j||j!=j||!u||u!=u||y&&"boolean"!==typeof y||n&&"string"!==typeof n||"string"!==typeof h)throw new A(a.JSON_PARSE_ERROR,"payload chunk payload "+c);if(0>j||j>P)throw new l(a.PAYLOAD_SEQUENCE_NUMBER_OUT_OF_RANGE,"payload chunk payload "+c);if(0>u||u>P)throw new l(a.PAYLOAD_MESSAGE_ID_OUT_OF_RANGE,"payload chunk payload "+
c);y||(y=!1);if(n&&!i[n])throw new K(a.UNIDENTIFIED_COMPRESSION,n);var v;try{v=M(h)}catch(Ta){throw new K(a.PAYLOAD_DATA_CORRUPT,h,Ta);}if(!v||0==v.length){if(0<h.length)throw new K(a.PAYLOAD_DATA_CORRUPT,h);if(y)c=new Uint8Array(0);else throw new K(a.PAYLOAD_DATA_MISSING,h);}else if(n)a:switch(c=v,n){case i.LZW:c=jc(c);break a;case i.GZIP:if(nrdp&&nrdp.uncompress){c=nrdp.uncompress(c,"gzip",!0);break a}default:throw new l(a.UNSUPPORTED_COMPRESSION,n.name());}else c=v;v=new d(k,f);new cc(j,u,y,n,
c,e,v,g)})},error:function(a){g.error(a)}})})},error:function(a){g.error(a)}})})}})();var Bb,Oa,Za,Pa,Uc,Vc;(function(){function b(g,d,e,i,f){function j(){c(f,function(){m>=d.length&&(m=0,++p);if(p>=n.length){if(t)throw t;throw new X(a.KEYX_FACTORY_NOT_FOUND,JSON.stringify(d));}var b=n[p],e=d[m];b.scheme!=e.keyExchangeScheme?(++m,j()):b.generateResponse(g,e,r,{result:function(a){f.result(a)},error:function(a){c(f,function(){if(!(a instanceof l))throw a;t=a;++m;j()})}})})}var p=0,m=0,n=g.getKeyExchangeFactories(),
t,r=e?e:i;j()}function d(a,e,i,j,f){c(f,function(){var d=e.keyRequestData;if(e.isRenewable()&&0<d.length)j?j.isRenewable()||j.isExpired()||e.isNonReplayable()?b(a,d,j,null,f):a.getTokenFactory().isNewestMasterToken(a,j,{result:function(e){c(f,function(){if(e)return null;b(a,d,j,null,f)})},error:f.error}):b(a,d,null,i.getIdentity(),f);else return null})}function i(b,d,e,i){c(i,function(){var c=d.userIdToken,j=d.userAuthenticationData;if(c&&c.isVerified()){if(c.isRenewable()&&d.isRenewable()||c.isExpired()||
!c.isBoundTo(e)){j=b.getTokenFactory();j.renewUserIdToken(b,c,e,i);return}}else if(d.isRenewable()&&e&&j){c=d.customer;if(!c){var c=j.scheme,p=b.getUserAuthenticationFactory(c);if(!p)throw new L(a.USERAUTH_FACTORY_NOT_FOUND,c);c=p.authenticate(b,e.identity,j,null)}j=b.getTokenFactory();j.createUserIdToken(b,c,e,i);return}return c})}var j=new Uint8Array(0),e=Oa=function(a){if(0>a||a>P)throw new o("Message ID "+a+" is outside the valid range.");return a==P?0:a+1};Za=function(a){if(0>a||a>P)throw new o("Message ID "+
a+" is outside the valid range.");return 0==a?P:a-1};Pa=function(a,b,d,e,f){c(f,function(){if(void 0==e||null==e){var i=a.getRandom();do e=i.nextLong();while(0>e||e>P)}else if(0>e||e>P)throw new o("Message ID "+e+" is outside the valid range.");a.getEntityAuthenticationData(!1,{result:function(i){c(f,function(){var c=a.getMessageCapabilities();return new Bb(a,e,c,i,b,d,null,null,null,null,null)})},error:function(a){f.error(a)}})})};Uc=function(a,b,j){c(j,function(){var k=b.masterToken,f=b.entityAuthenticationData,
u=b.messageId,n=e(u);d(a,b,f,k,{result:function(d){c(j,function(){var f=d?d.keyResponseData.masterToken:f=k;a.getEntityAuthenticationData(!1,{result:function(e){c(j,function(){i(a,b,f,{result:function(f){c(j,function(){var c=Yb(b.messageCapabilities,a.getMessageCapabilities()),i=b.keyResponseData,j=b.serviceTokens;return a.isPeerToPeer()?new Bb(a,n,c,e,i?i.masterToken:b.peerMasterToken,b.peerUserIdToken,b.peerServiceTokens,k,f,j,d):new Bb(a,n,c,e,i?i.masterToken:k,f,j,null,null,null,d)})},error:function(a){a instanceof
l&&a.setMessageId(u);j.error(a)}})})},error:function(a){a instanceof l&&a.setMessageId(u);j.error(a)}})})},error:function(a){a instanceof l&&a.setMessageId(u);j.error(a)}})})};Vc=function(a,b,d,i,f){c(f,function(){a.getEntityAuthenticationData(!1,{result:function(j){c(f,function(){var c;if(void 0!=b&&null!=b)c=e(b);else{var m=a.getRandom();do c=m.nextInt();while(0>c||c>P)}Lc(a,j,c,d.responseCode,d.internalCode,d.message,i,f)})},error:function(a){f.error(a)}})})};Bb=x.Class.create({init:function(a,
b,c,d,f,e,i,j,p,n,r){if(!a.isPeerToPeer()&&(j||p))throw new o("Cannot set peer master token or peer user ID token when not in peer-to-peer mode.");var l;l=r&&!a.isPeerToPeer()?r.keyResponseData.masterToken:f;var B={};a.getMslStore().getServiceTokens(l,e).forEach(function(a){B[a.name]=a},this);i&&i.forEach(function(a){B[a.name]=a},this);var N,U,E={};a.isPeerToPeer()&&(N=j,U=p,i=r?r.keyResponseData.masterToken:j,a.getMslStore().getServiceTokens(i,p).forEach(function(a){E[a.name]=a},this),n&&n.forEach(function(a){E[a.name]=
a},this));Object.defineProperties(this,{_ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},_entityAuthData:{value:d,writable:!1,enumerable:!1,configurable:!1},_masterToken:{value:f,writable:!0,enumerable:!1,configurable:!1},_messageId:{value:b,writable:!1,enumerable:!1,configurable:!1},_capabilities:{value:c,writable:!1,enumerable:!1,configurable:!1},_keyExchangeData:{value:r,writable:!1,enumerable:!1,configurable:!1},_nonReplayable:{value:!1,writable:!0,enumerable:!1,configurable:!1},_renewable:{value:!1,
writable:!0,enumerable:!1,configurable:!1},_keyRequestData:{value:{},writable:!1,enumerable:!1,configurable:!1},_userAuthData:{value:null,writable:!0,enumerable:!1,configurable:!1},_userIdToken:{value:e,writable:!0,enumerable:!1,configurable:!1},_serviceTokens:{value:B,writable:!1,enumerable:!1,configurable:!1},_peerMasterToken:{value:N,writable:!0,enumerable:!1,configurable:!1},_peerUserIdToken:{value:U,writable:!0,enumerable:!1,configurable:!1},_peerServiceTokens:{value:E,writable:!1,enumerable:!1,
configurable:!1}})},getMessageId:function(){return this._messageId},getMasterToken:function(){return this._masterToken},getUserIdToken:function(){return this._userIdToken},getKeyExchangeData:function(){return this._keyExchangeData},willEncryptHeader:function(){return this._masterToken||Hb(this._entityAuthData.scheme)},willEncryptPayloads:function(){return this._masterToken||!this._ctx.isPeerToPeer()&&this._keyExchangeData||Hb(this._entityAuthData.scheme)},getHeader:function(a){c(a,function(){var b=
this._keyExchangeData?this._keyExchangeData.keyResponseData:null,c=[],d;for(d in this._serviceTokens)c.push(this._serviceTokens[d]);var f=[],e;for(e in this._keyRequestData)f.push(this._keyRequestData[e]);b=new Oc(this._messageId,this._nonReplayable,this._renewable,this._capabilities,f,b,this._userAuthData,this._userIdToken,c);c=[];for(d in this._peerServiceTokens)c.push(this._peerServiceTokens[d]);d=new Pc(this._peerMasterToken,this._peerUserIdToken,c);Nc(this._ctx,this._entityAuthData,this._masterToken,
b,d,a)},this)},isNonReplayable:function(){return this._nonReplayable},setNonReplayable:function(a){(this._nonReplayable=a)&&this.setRenewable(!0);return this},isRenewable:function(){return this._renewable},setRenewable:function(a){(this._renewable=a)||this.setNonReplayable(!1);return this},setAuthTokens:function(a,b){if(b&&!b.isBoundTo(a))throw new o("User ID token must be bound to master token.");if(this._keyExchangeData&&!this._ctx.isPeerToPeer())throw new o("Attempt to set message builder master token when key exchange data exists as a trusted network server.");
var c;try{c=this._ctx.getMslStore().getServiceTokens(a,b)}catch(d){if(d instanceof l)throw new o("Invalid master token and user ID token combination despite checking above.",d);throw d;}var f=[],e;for(e in this._serviceTokens)f.push(this._serviceTokens[e]);f.forEach(function(c){(c.isUserIdTokenBound()&&!c.isBoundTo(b)||c.isMasterTokenBound()&&!c.isBoundTo(a))&&delete this._serviceTokens[c.name]},this);c.forEach(function(a){this._serviceTokens[a.name]=a},this);this._masterToken=a;this._userIdToken=
b},setUserAuthenticationData:function(a){this._userAuthData=a;return this},setCustomer:function(a,b){var d=this;c(b,function(){if(!this._ctx.isPeerToPeer()&&null!=this._userIdToken||this._ctx.isPeerToPeer()&&null!=this._peerUserIdToken)throw new o("User ID token or peer user ID token already exists for the remote user.");var e;e=this._keyExchangeData?this._keyExchangeData.keyResponseData.masterToken:!this._ctx.isPeerToPeer()?this._masterToken:this._peerMasterToken;if(!e)throw new o("User ID token or peer user ID token cannot be created because no corresponding master token exists.");
this._ctx.getTokenFactory().createUserIdToken(this._ctx,a,e,{result:function(a){c(b,function(){this._ctx.isPeerToPeer()?this._peerUserIdToken=a:(this._userIdToken=a,this._userAuthData=null);return!0},d)},error:function(a){b.error(a)}})},d)},addKeyRequestData:function(a){this._keyRequestData[a.uniqueKey()]=a;return this},removeKeyRequestData:function(a){delete this._keyRequestData[a.uniqueKey()];return this},addServiceToken:function(b){var c;c=this._keyExchangeData&&!this._ctx.isPeerToPeer()?this._keyExchangeData.keyResponseData.masterToken:
this._masterToken;if(b.isMasterTokenBound()&&!b.isBoundTo(c))throw new K(a.SERVICETOKEN_MASTERTOKEN_MISMATCH,"st "+JSON.stringify(b)+"; mt "+JSON.stringify(c));if(b.isUserIdTokenBound()&&!b.isBoundTo(this._userIdToken))throw new K(a.SERVICETOKEN_USERIDTOKEN_MISMATCH,"st "+JSON.stringify(b)+"; uit "+JSON.stringify(this._userIdToken));this._serviceTokens[b.name]=b;return this},addServiceTokenIfAbsent:function(a){this._serviceTokens[a.name]||this.addServiceToken(a);return this},excludeServiceToken:function(a){delete this._serviceTokens[a];
return this},deleteServiceToken:function(a,b){var d=this;c(b,function(){var e=this._serviceTokens[a];if(!e)return this;var f=e.isMasterTokenBound()?this._masterToken:null,e=e.isUserIdTokenBound()?this._userIdToken:null;Ha(a,j,f,e,!1,new Ka,{result:function(a){c(b,function(){return this.addServiceToken(a)},d)},error:function(a){a instanceof l&&(a=new o("Failed to create and add empty service token to message.",a));b.error(a)}})},d)},getServiceTokens:function(){var a=[],b;for(b in this._serviceTokens)a.push(this._serviceTokens[b]);
return a},getPeerMasterToken:function(){return this._peerMasterToken},getPeerUserIdToken:function(){return this._peerUserIdToken},setPeerAuthTokens:function(b,c){if(!this._ctx.isPeerToPeer())throw new o("Cannot set peer master token or peer user ID token when not in peer-to-peer mode.");if(c&&!b)throw new o("Peer master token cannot be null when setting peer user ID token.");if(c&&!c.isBoundTo(b))throw(new K(a.USERIDTOKEN_MASTERTOKEN_MISMATCH,"uit "+c+"; mt "+b)).setEntity(b).setUser(c);var d;try{d=
this._ctx.getMslStore().getServiceTokens(b,c)}catch(e){if(e instanceof l)throw new o("Invalid peer master token and user ID token combination despite proper check.",e);throw e;}Object.keys(this._peerServiceTokens).forEach(function(a){var d=this._peerServiceTokens[a];d.isUserIdTokenBound()&&!d.isBoundTo(c)?delete this._peerServiceTokens[a]:d.isMasterTokenBound()&&!d.isBoundTo(b)&&delete this._peerServiceTokens[a]},this);d.forEach(function(a){var b=a.name;this._peerServiceTokens[b]||(this._peerServiceTokens[b]=
a)},this);this._peerUserIdToken=c;this._peerMasterToken=b;return this},addPeerServiceToken:function(b){if(!this._ctx.isPeerToPeer())throw new o("Cannot set peer service tokens when not in peer-to-peer mode.");if(b.isMasterTokenBound()&&!b.isBoundTo(this._peerMasterToken))throw new K(a.SERVICETOKEN_MASTERTOKEN_MISMATCH,"st "+JSON.stringify(b)+"; mt "+JSON.stringify(this._peerMasterToken));if(b.isUserIdTokenBound()&&!b.isBoundTo(this._peerUserIdToken))throw new K(a.SERVICETOKEN_USERIDTOKEN_MISMATCH,
"st "+JSON.stringify(b)+"; uit "+JSON.stringify(this._peerUserIdToken));this._peerServiceTokens[b.name]=b;return this},addPeerServiceTokenIfAbsent:function(a){this._peerServiceTokens[a.name]||this.addPeerServiceToken(a);return this},excludePeerServiceToken:function(a){delete this._peerServiceTokens[a];return this},deletePeerServiceToken:function(a,b){var d=this;c(b,function(){var e=this._peerServiceTokens[a];if(!e)return this;var f=e.isMasterTokenBound()?this._peerMasterToken:null,e=e.isUserIdTokenBound()?
this._peerUserIdToken:null;Ha(a,j,f,e,!1,new Ka,{result:function(a){c(b,function(){return this.addPeerServiceToken(a)},d)},error:function(a){a instanceof l&&(a=new o("Failed to create and add empty peer service token to message.",a));b.error(a)}})},d)},getPeerServiceTokens:function(){var a=[],b;for(b in this._peerServiceTokens)a.push(this._peerServiceTokens[b]);return a}})})();var Wc;(function(){function a(b,c){return c[b]?c[b]:c[""]}function b(a){var c=a.builder.getKeyExchangeData();return c&&!a.ctx.isPeerToPeer()?
c.keyResponseData.masterToken:a.builder.getMasterToken()}Wc=x.Class.create({init:function(a,b,c){a={ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},cryptoContexts:{value:b.getCryptoContexts(),writable:!1,enumerable:!1,configurable:!1},builder:{value:c,writable:!1,enumerable:!1,configurable:!1}};Object.defineProperties(this,a)},isPrimaryMasterTokenAvailable:function(){return b(this)?!0:!1},isPrimaryUserIdTokenAvailable:function(){return this.builder.getUserIdToken()?!0:!1},isPeerMasterTokenAvailable:function(){return this.builder.getPeerMasterToken()?
!0:!1},isPeerUserIdTokenAvailable:function(){return this.builder.getPeerUserIdToken()?!0:!1},getPrimaryServiceTokens:function(){return this.builder.getServiceTokens()},getPeerServiceTokens:function(){return this.builder.getPeerServiceTokens()},addPrimaryServiceToken:function(a){try{return this.builder.addServiceToken(a),!0}catch(b){if(b instanceof K)return!1;throw b;}},addPeerServiceToken:function(a){try{return this.builder.addPeerServiceToken(a),!0}catch(b){if(b instanceof K)return!1;throw b;}},
addUnboundPrimaryServiceToken:function(b,d,e,g){var h=this;c(g,function(){var p=a(b,this.cryptoContexts);if(!p)return!1;Ha(b,d,null,null,e,p,{result:function(a){c(g,function(){try{this.builder.addServiceToken(a)}catch(b){if(b instanceof K)throw new o("Service token bound to incorrect authentication tokens despite being unbound.",b);throw b;}return!0},h)},error:function(a){g.error(a)}})},h)},addUnboundPeerServiceToken:function(b,d,e,g){var h=this;c(g,function(){var p=a(b,this.cryptoContexts);if(!p)return!1;
Ha(b,d,null,null,e,p,{result:function(a){c(g,function(){try{this.builder.addPeerServiceToken(a)}catch(b){if(b instanceof K)throw new o("Service token bound to incorrect authentication tokens despite being unbound.",b);throw b;}return!0},h)},error:function(a){g.error(a)}})},h)},addMasterBoundPrimaryServiceToken:function(d,j,e,g){var h=this;c(g,function(){var y=b(this);if(!y)return!1;var k=a(d,this.cryptoContexts);if(!k)return!1;Ha(d,j,y,null,e,k,{result:function(a){c(g,function(){try{this.builder.addServiceToken(a)}catch(b){if(b instanceof
K)throw new o("Service token bound to incorrect authentication tokens despite setting correct master token.",b);throw b;}return!0},h)},error:function(a){g.error(a)}})},h)},addMasterBoundPeerServiceToken:function(b,d,e,g){var h=this;c(g,function(){var p=this.builder.getPeerMasterToken();if(!p)return!1;var k=a(b,this.cryptoContexts);if(!k)return!1;Ha(b,d,p,null,e,k,{result:function(a){c(g,function(){try{this.builder.addPeerServiceToken(a)}catch(b){if(b instanceof K)throw new o("Service token bound to incorrect authentication tokens despite setting correct master token.",
b);throw b;}return!0},h)},error:function(a){g.error(a)}})},h)},addUserBoundPrimaryServiceToken:function(d,j,e,g){var h=this;c(g,function(){var y=b(this);if(!y)return!1;var k=this.builder.getUserIdToken();if(!k)return!1;var f=a(d,this.cryptoContexts);if(!f)return!1;Ha(d,j,y,k,e,f,{result:function(a){c(g,function(){try{this.builder.addServiceToken(a)}catch(b){if(b instanceof K)throw new o("Service token bound to incorrect authentication tokens despite setting correct master token and user ID token.",
b);throw b;}return!0},h)},error:function(a){g.error(a)}})},h)},addUserBoundPeerServiceToken:function(b,d,e,g){var h=this;c(g,function(){var p=this.builder.getPeerMasterToken();if(!p)return!1;var k=this.builder.getPeerUserIdToken();if(!k)return!1;var f=a(b,this.cryptoContexts);if(!f)return!1;Ha(b,d,p,k,e,f,{result:function(a){c(g,function(){try{this.builder.addPeerServiceToken(a)}catch(b){if(b instanceof K)throw new o("Service token bound to incorrect authentication tokens despite setting correct master token and user ID token.",
b);throw b;}return!0},h)},error:function(a){g.error(a)}})},h)},excludePrimaryServiceToken:function(a){for(var b=this.builder.getServiceTokens(),c=0;c<b.length;++c)if(b[c].name==a)return this.builder.excludeServiceToken(a),!0;return!1},excludePeerServiceToken:function(a){for(var b=this.builder.getPeerServiceTokens(),c=0;c<b.length;++c)if(b[c].name==a)return this.builder.excludePeerServiceToken(a),!0;return!1},deletePrimaryServiceToken:function(a,b){c(b,function(){for(var c=this.builder.getServiceTokens(),
d=0;d<c.length;++d)if(c[d].name==a){this.builder.deleteServiceToken(a,{result:function(){b.result(!0)},error:function(a){b.error(a)}});return}return!1},this)},deletePeerServiceToken:function(a,b){c(b,function(){for(var c=this.builder.getPeerServiceTokens(),d=0;d<c.length;++d)if(c[d].name==a){this.builder.deletePeerServiceToken(a,{result:function(){b.result(!0)},error:function(a){b.error(a)}});return}return!1},this)}})})();var Xc,Yc;(function(){function b(d,i,j,e){c(e,function(){function b(){c(e,function(){if(o>=
j.length){if(u)throw u;throw new X(a.KEYX_RESPONSE_REQUEST_MISMATCH,JSON.stringify(j));}var i=j[o];k!=i.keyExchangeScheme?(++o,b()):f.getCryptoContext(d,i,n,h,{result:function(a){e.result(a)},error:function(a){c(e,function(){if(!(a instanceof l))throw a;u=a;++o;b()})}})})}if(!(i instanceof Ja))return null;var h=i.masterToken,n=i.keyResponseData;if(!n)return null;var k=n.keyExchangeScheme,f=d.getKeyExchangeFactory(k);if(!f)throw new X(a.KEYX_FACTORY_NOT_FOUND,k);var u,o=0;b()})}Xc=yc.extend({init:function(c,
i,j,e,g,h,y){var k=this;d(y,function(){function d(){k._ready=!0;k._readyQueue.add(!0)}var u={_source:{value:i,writable:!1,enumerable:!1,configurable:!1},_parser:{value:void 0,writable:!0,enumerable:!1,configurable:!1},_charset:{value:j,writable:!1,enumerable:!1,configurable:!1},_remainingData:{value:"",writable:!0,enumerable:!1,configurable:!1},_timeout:{value:h,writable:!1,enumerable:!1,configurable:!1},_header:{value:void 0,writable:!0,enumerable:!1,configurable:!1},_cryptoContext:{value:void 0,
writable:!0,enumerable:!1,configurable:!1},_keyxCryptoContext:{value:void 0,writable:!0,enumerable:!1,configurable:!1},_payloadSequenceNumber:{value:1,writable:!0,enuemrable:!1,configurable:!1},_eom:{value:!1,writable:!0,enumerable:!1,configurable:!1},_closeSource:{value:!1,writable:!0,enumerable:!1,configurable:!1},_payloads:{value:[],writable:!0,enumerable:!1,configurable:!1},_payloadIndex:{value:-1,writable:!0,enumerable:!1,configurable:!1},_payloadOffset:{value:0,writable:!0,enuemrable:!1,configurable:!1},
_markOffset:{value:0,writable:!0,enumerable:!1,configurable:!1},_currentPayload:{value:null,writable:!0,enumerable:!1,configurable:!1},_readException:{value:null,writable:!0,enumerable:!1,configurable:!1},_ready:{value:!1,writable:!0,enumerable:!1,configurable:!1},_readyQueue:{value:new db,writable:!1,enumerable:!1,configurable:!1},_aborted:{value:!1,writable:!0,enumerable:!1,configurable:!1},_timedout:{value:!1,writable:!0,enumerable:!1,configurable:!1},_errored:{value:null,writable:!0,enumerable:!1,
configurable:!1}};Object.defineProperties(this,u);k.nextParser(h,{result:function(i){k._aborted?d():i?(k._parser=i,i=k._parser.nextValue(),"object"!==typeof i?(k._errored=new A(a.MESSAGE_FORMAT_ERROR),d()):Gc(c,i,g,{result:function(g){k._header=g;b(c,g,e,{result:function(b){try{if(k._keyxCryptoContext=b,k._cryptoContext=g instanceof Na?null:c.isPeerToPeer()||null==k._keyxCryptoContext?g.cryptoContext:k._keyxCryptoContext,g instanceof Ja){var e=g.masterToken;if(c.isPeerToPeer()||e&&e.isVerified())if(e&&
e.isExpired()&&(!g.isRenewable()||0==g.keyRequestData.length)){k._errored=(new K(a.MESSAGE_EXPIRED,JSON.stringify(g))).setMessageId(g.messageId);d();return}g.isNonReplayable()?!g.isRenewable()||0==g.keyRequestData.length||!e?(k._errored=(new K(a.INCOMPLETE_NONREPLAYABLE_MESSAGE,JSON.stringify(g))).setMessageId(g.messageId),d()):c.getTokenFactory().isNewestMasterToken(c,e,{result:function(b){b||(k._errored=(new K(a.MESSAGE_REPLAYED,JSON.stringify(g))).setMessageId(g.messageId));d()},error:function(a){a instanceof
l&&a.setMessageId(g.messageId);k._errored=a;d()}}):d()}else d()}catch(i){k._errored=i,d()}},error:function(a){a instanceof l&&a.setMessageId(g.messageId);k._errored=a;d()}})},error:function(a){k._errored=a;d()}})):(k._errored=new A(a.MESSAGE_DATA_MISSING),d())},timeout:function(){k._timedout=!0;d()},error:function(a){k._errored=a;d()}});return this},k)},nextParser:function(a,b){var d=this;this._source.read(-1,a,{result:function(e){c(b,function(){if(!e||!e.length)return null;var c=this._remainingData.concat(aa(e,
this._charset)),h=new Fc(c),n=h.lastIndex();if(0<n)return this._remainingData=c.substring(n),h;if(10485760<c.length)throw new Z("No JSON parsed after receiving "+c.length+" characters.");this._remainingData=c;ia(function(){d.nextParser(a,b)},10)},d)},timeout:function(a){c(b,function(){if(a&&0!=a.length){var c=this._remainingData.concat(aa(a,this._charset)),d=new Fc(c),j=d.lastIndex();if(0<j)return this._remainingData=c.substring(j),d;this._remainingData=c}b.timeout(this._remainingData)},d)},error:function(a){b.error(a)}})},
nextData:function(b,c){var j=this;d(c,function(){var b=this.getMessageHeader();if(!b)throw new o("Read attempted with error message.");if(-1!=this._payloadIndex&&this._payloadIndex<this._payloads.length)return this._payloads[this._payloadIndex++];if(this._eom)return null;(function(a){d(a,function(){var b=this._parser.nextValue();if(void 0!==b)return b;this.nextParser(this._timeout,{result:function(b){d(a,function(){if(this._aborted)return null;this._parser=b;return!this._parser?(this._eom=!0,null):
this._parser.nextValue()},j)},timeout:function(b){j._remainingData=b;a.timeout()},error:function(b){a.error(b)}})},j)})({result:function(g){d(c,function(){if(!g)return null;if("object"!==typeof g)throw new A(a.MESSAGE_FORMAT_ERROR);Sc(g,this._cryptoContext,{result:function(g){d(c,function(){if(g.messageId!=b.messageId)throw new K(a.PAYLOAD_MESSAGE_ID_MISMATCH,"payload mid "+g.messageId+" header mid "+b.messageId);if(g.sequenceNumber!=this._payloadSequenceNumber)throw new K(a.PAYLOAD_SEQUENCE_NUMBER_MISMATCH,
"payload seqno "+g.sequenceNumber+" expected seqno "+this._payloadSequenceNumber);++this._payloadSequenceNumber;g.isEndOfMessage()&&(this._eom=!0);var c=g.data;this._payloads.push(c);this._payloadIndex=-1;return c},j)},error:function(b){b instanceof SyntaxError&&(b=new A(a.JSON_PARSE_ERROR,"payloadchunk",b));c.error(b)}})},j)},timeout:function(){c.timeout()},error:function(a){c.error(a)}})},j)},isReady:function(a,b){function c(){d(b,function(){if(this._aborted)return!1;if(this._timedout)b.timeout();
else{if(this._errored)throw this._errored;return!0}},e)}var e=this;d(b,function(){this._ready?c():this._readyQueue.poll(a,{result:function(a){d(b,function(){if(void 0===a)return!1;c()},e)},timeout:function(){b.timeout()},error:function(a){b.error(a)}})},e)},getMessageHeader:function(){return this._header instanceof Ja?this._header:null},getErrorHeader:function(){return this._header instanceof Na?this._header:null},getIdentity:function(){var a=this.getMessageHeader();if(a){var b=a.masterToken;return b?
b.identity:a.entityAuthenticationData.getIdentity()}return this.getErrorHeader().entityAuthenticationData.getIdentity()},getCustomer:function(){var a=this.getMessageHeader();return!a?null:a.customer},getPayloadCryptoContext:function(){return this._cryptoContext},getKeyExchangeCryptoContext:function(){return this._keyxCryptoContext},closeSource:function(a){this._closeSource=a},abort:function(){this._aborted=!0;this._source.abort();this._readyQueue.cancelAll()},close:function(){this._closeSource&&this._source.close()},
mark:function(){if(this._currentPayload){for(;0<this._payloads.length&&this._payloads[0]!==this._currentPayload;)this._payloads.shift();this._payloadIndex=0;this._currentPayload=this._payloads[this._payloadIndex++];this._markOffset=this._payloadOffset}else this._payloadIndex=-1,this._payloads=[]},markSupported:function(){return!0},read:function(a,b,c){function e(){d(c,function(){function e(c){d(c,function(){if(k&&u>=k.length)return k.subarray(0,u);var j=-1;if(this._currentPayload){var n=this._currentPayload.length-
this._payloadOffset;if(!k){var t=n;if(-1!=this._payloadIndex)for(var r=this._payloadIndex;r<this._payloads.length;++r)t+=this._payloads[r].length;0<t&&(k=new Uint8Array(t))}n=Math.min(n,k?k.length-u:0);0<n&&(j=this._currentPayload.subarray(this._payloadOffset,this._payloadOffset+n),k.set(j,f),j=n,f+=n,this._payloadOffset+=n)}-1!=j?(u+=j,e(c)):this.nextData(b,{result:function(b){d(c,function(){if(this._aborted)return k?k.subarray(0,u):new Uint8Array(0);this._currentPayload=b;this._payloadOffset=0;
if(this._currentPayload)e(c);else return 0==u&&0!=a?null:k?k.subarray(0,u):new Uint8Array(0)},g)},timeout:function(){c.timeout(k?k.subarray(0,u):new Uint8Array(0))},error:function(a){d(c,function(){a instanceof l&&(a=new Z("Error reading the payload chunk.",a));if(0<u)return g._readException=a,k.subarray(0,u);throw a;},g)}})},g)}if(this._aborted)return new Uint8Array(0);if(this._timedout)c.timeout(new Uint8Array(0));else{if(this._errored)throw this._errored;if(null!=this._readException){var n=this._readException;
this._readException=null;throw n;}var k=-1!=a?new Uint8Array(a):void 0,f=0,u=0;e(c)}},g)}var g=this;d(c,function(){if(-1>a)throw new RangeError("read requested with illegal length "+a);this._ready?e():this._readyQueue.poll(b,{result:function(a){void 0===a?c.result(!1):e()},timeout:function(){c.timeout(new Uint8Array(0))},error:function(a){c.error(a)}})},g)},reset:function(){this._payloadIndex=0;0<this._payloads.length?(this._currentPayload=this._payloads[this._payloadIndex++],this._payloadOffset=
this._markOffset):this._currentPayload=null}});Yc=function(a,b,c,d,g,h,n){new Xc(a,b,c,d,g,h,n)}})();var Zc,Cb;(function(){Zc=Pb.extend({init:function(a,b,c,j,e,g,h){var l=this;d(h,function(){function d(){l._ready=!0;l._readyQueue.add(!0)}var f=Yb(a.getMessageCapabilities(),j.messageCapabilities),h=null;f&&(h=Tc(f.compressionAlgorithms));f={_destination:{value:b,writable:!1,enumerable:!1,configurable:!1},_charset:{value:c,writable:!1,enumerable:!1,configurable:!1},_capabilities:{value:f,writable:!1,
enumerable:!1,configurable:!1},_header:{value:j,writable:!1,enumerable:!1,configurable:!1},_compressionAlgo:{value:h,writable:!0,enumerable:!1,configurable:!1},_cryptoContext:{value:e,writable:!1,enumerable:!1,configurable:!1},_payloadSequenceNumber:{value:1,writable:!0,enumerable:!1,configurable:!1},_currentPayload:{value:[],writable:!0,enumerable:!1,configurable:!1},_closed:{value:!1,writable:!0,enumerable:!1,configurable:!1},_payloads:{value:[],writable:!1,enumerable:!1,configurable:!1},_ready:{value:!1,
writable:!0,enumerable:!1,configurable:!1},_readyQueue:{value:new db,writable:!1,enumerable:!1,configurable:!1},_aborted:{value:!1,writable:!0,enumerable:!1,configurable:!1},_timedout:{value:!1,writable:!0,enumerable:!1,configurable:!1},_errored:{value:null,writable:!0,enumerable:!1,configurable:!1}};Object.defineProperties(this,f);var o=W(JSON.stringify(j),c);b.write(o,0,o.length,g,{result:function(a){try{l._aborted?d():a<o.length?(l._timedout=!0,d()):b.flush(g,{result:function(a){l._aborted||(l._timedout=
!a);d()},timeout:function(){l._timedout=!0;d()},error:function(a){l._errored=a;d()}})}catch(c){l._errored=c,d()}},timeout:function(){l._timedout=!0;d()},error:function(a){l._errored=a;d()}});return this},l)},setCompressionAlgorithm:function(a,b,c){function j(){e.flush(b,{result:function(b){d(c,function(){if(!b)throw new Z("flush() aborted");this._compressionAlgo=a;return!0},e)},timeout:function(){c.timeout()},error:function(a){c.error(a)}})}var e=this;d(c,function(){if(!this.getMessageHeader())throw new o("Cannot write payload data for an error message.");
if(this._compressionAlgo==a)return!0;if(a){if(!this._capabilities)return!1;for(var b=this._capabilities.compressionAlgorithms,c=0;c<b.length;++c)if(b[c]==a){j();return}return!1}j()},e)},getMessageHeader:function(){return this._header instanceof Ja?this._header:null},getErrorMessage:function(){return this._header instanceof Na?this._header:null},getPayloads:function(){return this._payloads},abort:function(){this._aborted=!0;this._destination.abort();this._readyQueue.cancelAll()},close:function(a,b){var c=
this;d(b,function(){if(this._aborted)return!1;if(this._timedout)b.timeout();else{if(this._errored)throw this._errored;if(this._closed)return!0;this._closed=!0;this.flush(a,{result:function(a){d(b,function(){a&&(this._currentPayload=null);return a},c)},timeout:function(){b.timeout()},error:function(a){b.error(a)}})}},c)},flush:function(a,b){function c(){d(b,function(){if(this._aborted)return!1;if(this._timedout)b.timeout();else{if(this._errored)throw this._errored;if(!this._currentPayload||!this._closed&&
0==this._currentPayload.length)return!0;var c=this.getMessageHeader();if(!c)return!0;var g=0;this._currentPayload&&this._currentPayload.forEach(function(a){g+=a.length});for(var i=new Uint8Array(g),y=0,k=0;this._currentPayload&&k<this._currentPayload.length;++k){var f=this._currentPayload[k];i.set(f,y);y+=f.length}Rc(this._payloadSequenceNumber,c.messageId,this._closed,this._compressionAlgo,i,this._cryptoContext,{result:function(c){d(b,function(){this._payloads.push(c);var g=W(JSON.stringify(c),this._charset);
this._destination.write(g,0,g.length,a,{result:function(g){d(b,function(){if(this._aborted)return!1;g<c.length?b.timeout():this._destination.flush(a,{result:function(a){d(b,function(){if(this._aborted)return!1;if(a)return++this._payloadSequenceNumber,this._currentPayload=this._closed?null:[],!0;b.timeout()},j)},timeout:function(){b.timeout()},error:function(a){a instanceof l&&(a=new Z("Error encoding payload chunk [sequence number "+j._payloadSequenceNumber+"].",a));b.error(a)}})},j)},timeout:function(){b.timeout()},
error:function(a){a instanceof l&&(a=new Z("Error encoding payload chunk [sequence number "+j._payloadSequenceNumber+"].",a));b.error(a)}})},j)},error:function(a){a instanceof l&&(a=new Z("Error encoding payload chunk [sequence number "+j._payloadSequenceNumber+"].",a));b.error(a)}})}},j)}var j=this;d(b,function(){this._ready?c():this._readyQueue.poll(a,{result:function(a){void 0===a?b.result(!1):c()},timeout:function(){b.timeout()},error:function(a){b.error(a)}})},j)},write:function(a,b,c,j,e){d(e,
function(){if(this._aborted)return!1;if(this._timedout)e.timeout();else{if(this._errored)throw this._errored;if(this._closed)throw new Z("Message output stream already closed.");if(0>b)throw new RangeError("Offset cannot be negative.");if(0>c)throw new RangeError("Length cannot be negative.");if(b+c>a.length)throw new RangeError("Offset plus length cannot be greater than the array length.");if(!this.getMessageHeader())throw new o("Cannot write payload data for an error message.");var d=a.subarray(b,
b+c);this._currentPayload.push(d);return d.length}},this)}});Cb=function(a,b,c,d,e,g,h){new Zc(a,b,c,d,e,g,h)}})();Object.freeze({USERDATA_REAUTH:b.USERDATA_REAUTH,SSOTOKEN_REJECTED:b.SSOTOKEN_REJECTED});var Cd=x.Class.create({traceRequestHeader:function(){},traceResponseHeader:function(){}}),$c=x.Class.create({getCryptoContexts:function(){},isEncrypted:function(){},isNonReplayable:function(){},isRequestingTokens:function(){},getUserId:function(){},getUserAuthData:function(){},getCustomer:function(){},
getKeyRequestData:function(){},updateServiceTokens:function(){},write:function(){},getDebugContext:function(){}});x.Class.create({getInputStream:function(){},getOutputStream:function(){}});var ad;(function(){function n(a){return function(){a.abort()}}function p(a,b){Object.defineProperties(this,{masterToken:{value:a,writable:!1,configurable:!1},ticket:{value:b,writable:!1,configurable:!1}})}function i(a,b){Object.defineProperties(this,{builder:{value:a,writable:!1,configurable:!1},msgCtx:{value:b,
writable:!1,configurable:!1}})}function j(a,b,c){Object.defineProperties(this,{requestHeader:{value:a,writable:!1,configurable:!1},payloads:{value:b,writable:!1,configurable:!1},handshake:{value:c,writable:!1,configurable:!1}})}function e(a,b){Object.defineProperties(this,{requestHeader:{value:b.requestHeader,writable:!1,configurable:!1},payloads:{value:b.payloads,writable:!1,configurable:!1},handshake:{value:b.handshake,writable:!1,configurable:!1},response:{value:a,writable:!1,configurable:!1}})}
function g(a){for(;a;){if(a instanceof ma)return!0;a=a instanceof l?a.cause:void 0}return!1}function h(a,b,c,g,e,f,i,j){Vc(b,c,g,e,{result:function(c){Cb(b,f,S,c,null,null,i,{result:function(b){a.setAbort(function(){b.abort()});b.close(i,{result:function(a){d(j,function(){if(!a)throw new ma("sendError aborted.");return a})},timeout:function(){j.timeout()},error:function(a){j.error(a)}})},timeout:function(){},error:function(a){j.error(a)}})},error:function(a){j.error(a)}})}var y=Pb.extend({close:function(a,
b){b.result(!0)},write:function(a,b,d,g,e){c(e,function(){return Math.min(a.length-b,d)})},flush:function(a,b){b.result(!0)}}),k=Bd.extend({getUserMessage:function(){return null}}),f=$c.extend({init:function(a){Object.defineProperties(this,{_appCtx:{value:a,writable:!1,enumerable:!1,configurable:!1}})},getCryptoContexts:function(){return this._appCtx.getCryptoContexts()},isEncrypted:function(){return this._appCtx.isEncrypted()},isNonReplayable:function(){return this._appCtx.isNonReplayable()},isRequestingTokens:function(){return this._appCtx.isRequestingTokens()},
getUserId:function(){return this._appCtx.getUserId()},getUserAuthData:function(a,b,c,d){this._appCtx.getUserAuthData(a,b,c,d)},getCustomer:function(){return this._appCtx.getCustomer()},getKeyRequestData:function(a){this._appCtx.getKeyRequestData(a)},updateServiceTokens:function(a,b){this._appCtx.updateServiceTokens(a,b)},write:function(a,b,c){this._appCtx.write(a,b,c)},getDebugContext:function(){return this._appCtx.getDebugContext()}}),u=f.extend({init:function E(a,b,c,d){E.base.call(this,d);Object.defineProperties(this,
{_ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},_header:{value:b,writable:!1,enumerable:!1,configurable:!1},_payloads:{value:c,writable:!1,enumerable:!1,configurable:!1}})},updateServiceTokens:function(a,b){var d=this;c(b,function(){function c(b,f){if(b==e.length)f.call(d);else{var v=e[b];g[v.name]||a.addPrimaryServiceToken(v);c(b+1,f)}}var g=[];a.getPrimaryServiceTokens().forEach(function(a){g.push(a.name)});var e=this._header.serviceTokens;c(0,function(){function c(b,f){if(b==e.length)f.call(d);
else{var v=e[b];g[v.name]||a.addPeerServiceToken(v);c(b+1,f)}}if(d._ctx.isPeerToPeer()){var g=[];a.getPeerServiceTokens().forEach(function(a){g.push(a.name)});var e=d._header.peerServiceTokens;c(0,function(){b.result(!0)})}else b.result(!0)})},d)},write:function(a,b,c){function g(f,i){if(f==e._payloads.length)c.result(!0);else{var j=e._payloads[f];a.setCompressionAlgorithm(j.compressionAlgo,b,{result:function(){a.write(j.data,0,j.data.length,b,{result:function(){d(c,function(){j.isEndOfMessage()?
g(f+1,i):a.flush(b,{result:function(a){c.result(a)},timeout:function(){c.timeout()},error:function(a){c.error(a)}})},e)},timeout:function(a){c.timeout(a)},error:function(a){c.error(a)}})},timeout:function(){},error:function(a){c.error(a)}})}}var e=this;g(0)}}),G=f.extend({init:function v(a){v.base.call(this,a)},isEncrypted:function(){return!1},isNonReplayable:function(){return!1},write:function(a,b,c){c.result(!0)}}),m=32768,I={},t,r,H,B=x.Class.create({init:function(a){a||(a=new k);Object.defineProperties(this,
{_filterFactory:{value:null,writable:!0,enumerable:!1,configurable:!1},_renewingContexts:{value:[],writable:!1,enumerable:!1,configurable:!1},_masterTokenLocks:{value:{},writable:!1,enumerable:!1,configurable:!1},_messageRegistry:{value:a,writable:!1,enumerable:!1,configurable:!1}})},setFilterFactory:function(a){this._filterFactory=a},getNewestMasterToken:function(a,b,c,g){var e=this;d(g,function(){var f=b.getMslStore().getMasterToken();if(!f)return null;var i=f.uniqueKey(),j=this._masterTokenLocks[i];
j||(j=new Kb,this._masterTokenLocks[i]=j);var h=j.readLock(c,{result:function(a){d(g,function(){if(void 0===a)throw new ma("getNewestMasterToken aborted.");return new p(f,a)},e)},timeout:function(){g.timeout()},error:function(a){g.error(a)}});a.setAbort(function(){h&&(j.cancel(h),h=void 0)})},e)},deleteMasterToken:function(a,b){if(b){var c=this;ia(function(){var d=b.uniqueKey(),g=c._masterTokenLocks[d];g||(g=new Kb,c._masterTokenLocks[d]=g);g.writeLock(-1,{result:function(e){a.getMslStore().removeCryptoContext(b);
delete c._masterTokenLocks[d];g.unlock(e)},timeout:function(){throw new o("Unexpected timeout received.");},error:function(a){throw a;}})},0)}},releaseMasterToken:function(a){a&&a.masterToken&&this._masterTokenLocks[a.masterToken.uniqueKey()].unlock(a.ticket)},updateOutgoingCryptoContexts:function(a,b,c){var d=a.getMslStore();!a.isPeerToPeer()&&c&&(d.setCryptoContext(c.keyResponseData.masterToken,c.cryptoContext),this.deleteMasterToken(a,b.masterToken))},updateIncomingCryptoContexts:function(a,b,
c){var d=c.getMessageHeader();if(d){var g=a.getMslStore();if(d=d.keyResponseData)g.setCryptoContext(d.masterToken,c.getKeyExchangeCryptoContext()),this.deleteMasterToken(a,b.masterToken)}},storeServiceTokens:function(a,b,c,d){for(var a=a.getMslStore(),g=[],e=0;e<d.length;++e){var f=d[e];if(!f.isBoundTo(b)||!b.isVerified()){var j=f.data;j&&0==j.length?a.removeServiceTokens(f.name,f.isMasterTokenBound()?b:null,f.isUserIdTokenBound()?c:null):g.push(f)}}0<g.length&&a.addServiceTokens(g)},buildRequest:function(a,
b,d,g,e){var f=this;this.getNewestMasterToken(a,b,g,{result:function(a){c(e,function(){var g=b.getMslStore(),j=g.getMasterToken();if(j)var i=d.getUserId(),g=(g=i?g.getUserIdToken(i):null)&&g.isBoundTo(j)?g:null;else g=null;Pa(b,j,g,null,{result:function(b){c(e,function(){b.setNonReplayable(d.isNonReplayable());return{builder:b,tokenTicket:a}})},error:function(b){c(e,function(){this.releaseMasterToken(a);b instanceof l&&(b=new o("User ID token not bound to master token despite internal check.",b));
throw b;},f)}})},f)},timeout:function(){e.timeout()},error:function(a){e.error(a)}})},buildResponse:function(a,b,c,g,e,f){var j=this;Uc(b,g,{result:function(i){d(f,function(){i.setNonReplayable(c.isNonReplayable());if(!b.isPeerToPeer()&&!g.keyResponseData)return{builder:i,tokenTicket:null};this.getNewestMasterToken(a,b,e,{result:function(a){d(f,function(){var d=a&&a.masterToken,g;if(d){g=c.getUserId();var e=b.getMslStore();g=(g=g?e.getUserIdToken(g):null)&&g.isBoundTo(d)?g:null}else g=null;i.setAuthTokens(d,
g);return{builder:i,tokenTicket:a}},j)},timeout:function(){f.timeout()},error:function(a){f.error(a)}})},j)},error:function(a){f.error(a)}})},buildErrorResponse:function(a,c,g,e,f,j,h){function m(a,b){d(h,function(){var e=Oa(f.messageId),j=new u(c,a,b,g);Pa(c,null,null,e,{result:function(b){d(h,function(){c.isPeerToPeer()&&b.setPeerAuthTokens(a.peerMasterToken,a.peerUserIdToken);b.setNonReplayable(j.isNonReplayable());return{errorResult:new i(b,j),tokenTicket:null}},k)},error:function(a){h.error(a)}})},
k)}function r(b,e){k.getNewestMasterToken(a,c,j,{result:function(a){d(h,function(){var j=a&&a.masterToken,v=Oa(f.messageId),m=new u(c,b,e,g);Pa(c,j,null,v,{result:function(g){d(h,function(){c.isPeerToPeer()&&g.setPeerAuthTokens(b.peerMasterToken,b.peerUserIdToken);g.setNonReplayable(m.isNonReplayable());return{errorResult:new i(g,m),tokenTicket:a}},k)},error:function(a){h.error(a)}})},k)},timeout:function(){h.timeout()},error:function(a){h.error(a)}})}var k=this;d(h,function(){var p=e.requestHeader,
O=e.payloads,n=f.errorCode;switch(n){case b.ENTITYDATA_REAUTH:c.getEntityAuthenticationData(!0,{result:function(a){d(h,function(){if(!a)return null;m(p,O)},k)},error:function(a){h.error(a)}});break;case b.ENTITY_REAUTH:m(p,O);break;case b.USERDATA_REAUTH:case b.SSOTOKEN_REJECTED:g.getUserAuthData(n,!1,!0,{result:function(a){d(h,function(){if(!a)return null;r(p,O)},k)},error:function(a){h.error(a)}});break;case b.USER_REAUTH:r(p,O);break;case b.KEYX_REQUIRED:var n=Oa(f.messageId),t=new u(c,p,O,g);
Pa(c,null,null,n,{result:function(a){d(h,function(){c.isPeerToPeer()&&a.setPeerAuthTokens(p.peerMasterToken,p.peerUserIdToken);a.setRenewable(!0);a.setNonReplayable(t.isNonReplayable());return{errorResult:new i(a,t),tokenTicket:null}},k)},error:function(a){h.error(a)}});break;case b.EXPIRED:this.getNewestMasterToken(a,c,j,{result:function(a){d(h,function(){var b=a&&a.masterToken,e=p.userIdToken,j=Oa(f.messageId),v=new u(c,p,O,g);Pa(c,b,e,j,{result:function(g){d(h,function(){c.isPeerToPeer()&&g.setPeerAuthTokens(p.peerMasterToken,
p.peerUserIdToken);p.masterToken.equals(b)&&g.setRenewable(!0);g.setNonReplayable(v.isNonReplayable());return{errorResult:new i(g,v),tokenTicket:a}},k)},error:function(a){h.error(a)}},k)},k)},timeout:function(){h.timeout()},error:function(a){h.error(a)}});break;case b.REPLAYED:this.getNewestMasterToken(a,c,j,{result:function(a){d(h,function(){var b=a&&a.masterToken,e=p.userIdToken,j=Oa(f.messageId),v=new u(c,p,O,g);Pa(c,b,e,j,{result:function(g){d(h,function(){c.isPeerToPeer()&&g.setPeerAuthTokens(p.peerMasterToken,
p.peerUserIdToken);p.masterToken.equals(b)?(g.setRenewable(!0),g.setNonReplayable(!1)):g.setNonReplayable(v.isNonReplayable());return{errorResult:new i(g,v),tokenTicket:a}},k)},error:function(a){h.error(a)}})},k)},timeout:function(){h.timeout()},error:function(a){h.error(a)}});break;default:return null}},k)},cleanupContext:function(a,c,d){switch(d.errorCode){case b.ENTITY_REAUTH:this.deleteMasterToken(a,c.masterToken);break;case b.USER_REAUTH:d=c.userIdToken,c.masterToken&&d&&a.getMslStore().removeUserIdToken(d)}},
send:function(b,c,g,e,f,i,h){function m(a,b,e){d(h,function(){var j=f.getPeerUserIdToken();!c.isPeerToPeer()&&!b||c.isPeerToPeer()&&!j?(j=g.getCustomer())?f.setCustomer(j,{result:function(){d(h,function(){b=f.getUserIdToken();r(a,b,e)},n)},error:function(a){h.error(a)}}):r(a,b,e):r(a,b,e)},n)}function r(a,b,c){d(h,function(){var e=!c&&(!g.isEncrypted()||f.willEncryptPayloads())&&(!g.isNonReplayable()||f.isNonReplayable()&&a);e||f.setNonReplayable(!1);var j=[];f.isRenewable()&&(!a||a.isRenewable()||
g.isNonReplayable())?g.getKeyRequestData({result:function(c){d(h,function(){for(var d=0;d<c.length;++d){var g=c[d];j.push(g);f.addKeyRequestData(g)}k(a,b,e,j)},n)},error:function(a){h.error(a)}}):k(a,b,e,j)},n)}function k(a,j,m){d(h,function(){var r=new Wc(c,g,f);g.updateServiceTokens(r,{result:function(){f.getHeader({result:function(r){d(h,function(){var d=f.getKeyExchangeData();this.updateOutgoingCryptoContexts(c,r,d);this.storeServiceTokens(c,a,j,r.serviceTokens);d=!c.isPeerToPeer()&&d?d.cryptoContext:
r.cryptoContext;if(b.isAborted())throw new ma("send aborted.");var k=g.getDebugContext();k&&k.traceRequestHeader(r);k=null!=this._filterFactory?this._filterFactory.getOutputStream(e):e;Cb(c,k,S,r,d,i,{result:function(a){b.setAbort(function(){a.abort()});p(a,r,m)},timeout:function(){h.timeout()},error:function(a){h.error(a)}})},n)},timeout:function(){h.timeout()},error:function(a){h.error(a)}})},error:function(a){h.error(a)}})},n)}function p(a,e,f){if(f)g.write(a,i,{result:function(){d(h,function(){if(b.isAborted())throw new ma("MessageOutputStream write aborted.");
O(a,e,f)},n)},timeout:function(){h.timeout()},error:function(a){h.error(a)}});else{var j=new y,m=new Ka;Cb(c,j,S,e,m,i,{result:function(c){g.write(c,i,{result:function(){d(h,function(){if(b.isAborted())throw new ma("MessageOutputStream proxy write aborted.");c.close(i,{result:function(b){d(h,function(){if(!b)throw new ma("MessageOutputStream proxy close aborted.");var d=c.getPayloads();O(a,e,f,d)},n)},timeout:function(){h.timeout()},error:function(a){h.error(a)}})},n)},timeout:function(){h.timeout()},
error:function(a){h.error(a)}})},timeout:function(){h.timeout()},error:function(a){h.error(a)}})}}function O(a,b,c,g){a.close(i,{result:function(e){d(h,function(){if(!e)throw new ma("MessageOutputStream close aborted.");g||(g=a.getPayloads());return new j(b,g,!c)},n)},timeout:function(){h.timeout()},error:function(a){h.error(a)}})}var n=this;d(h,function(){var b=f.getMasterToken(),c=f.getUserIdToken(),e=!1;if(g.getUserId()){var j=!c;g.getUserAuthData(null,f.isRenewable(),j,{result:function(g){d(h,
function(){if(g)f.willEncryptHeader()?f.setUserAuthenticationData(g):e=!0;else if(j)throw new K(a.REQUEST_REQUIRES_USERAUTHDATA);m(b,c,e)},n)},error:function(a){h.error(a)}})}else m(b,c,e)},n)},receive:function(c,g,e,f,j,h,i){var m=this;d(i,function(){if(c.isAborted())throw new ma("receive aborted.");var r=[];j&&(r=j.keyRequestData.filter(function(){return!0}));var k=e.getCryptoContexts(),p=this._filterFactory?this._filterFactory.getInputStream(f):f;Yc(g,p,S,r,k,h,{result:function(f){c.setAbort(function(){f.abort()});
f.isReady(h,{result:function(c){d(i,function(){if(!c)throw new ma("MessageInputStream aborted.");var h=f.getMessageHeader();if(j){var r=f.getErrorHeader(),v=r?r.errorCode:null;if(h||v!=b.FAIL&&v!=b.TRANSIENT_FAILURE&&v!=b.ENTITY_REAUTH&&v!=b.ENTITYDATA_REAUTH){var v=h?h.messageId:r.messageId,k=Oa(j.messageId);if(v!=k)throw new K(a.UNEXPECTED_RESPONSE_MESSAGE_ID,"expected "+k+"; received "+v);}}g.getEntityAuthenticationData(!1,{result:function(b){d(i,function(){var c=b.getIdentity(),d;if(h){j&&this.updateIncomingCryptoContexts(g,
j,f);var c=h.keyResponseData,i;g.isPeerToPeer()?(c=c?c.masterToken:h.peerMasterToken,d=h.peerUserIdToken,i=h.peerServiceTokens):(c=c?c.masterToken:h.masterToken,d=h.userIdToken,i=h.serviceTokens);var m=e.getUserId();m&&d&&!d.isVerified()&&g.getMslStore().addUserIdToken(m,d);this.storeServiceTokens(g,c,d,i)}else if(d=r.entityAuthenticationData.getIdentity(),c==d)throw new K(a.UNEXPECTED_MESSAGE_SENDER,d);(c=e.getDebugContext())&&c.traceResponseHeader(h||f.getErrorHeader());return f},m)},error:i.error})},
m)},timeout:function(){i.timeout()},error:function(a){i.error(a)}})},timeout:function(){i.timeout()},error:function(a){i.error(a)}})},m)},sendReceive:function(a,b,c,g,f,h,j,i,m){function r(p,n){d(m,function(){h.setRenewable(n);this.send(a,b,c,f,h,j,{result:function(f){d(m,function(){var h=f.requestHeader.keyRequestData;i||f.handshake||!h.isEmpty()?this.receive(a,b,c,g,f.requestHeader,j,{result:function(a){d(m,function(){n&&this.releaseRenewalLock(b,p,a);return new e(a,f)},k)},timeout:function(){d(m,
function(){n&&this.releaseRenewalLock(b,p,null);m.timeout()},k)},error:function(a){d(m,function(){n&&this.releaseRenewalLock(b,p,null);throw a;},k)}}):d(m,function(){n&&this.releaseRenewalLock(b,p,null);return new e(null,f)},k)},k)},timeout:function(){d(m,function(){n&&this.releaseRenewalLock(b,p,null);m.timeout()},k)},error:function(a){d(m,function(){n&&this.releaseRenewalLock(b,p,null);throw a;},k)}})},k)}var k=this;d(m,function(){var d=new db;this.acquireRenewalLock(a,b,c,d,h,j,{result:function(a){r(d,
a)},timeout:function(){m.timeout()},error:function(a){a instanceof ma?m.result(null):m.error(a)}})},k)},acquireRenewalLock:function(a,b,c,g,e,f,h){function j(r,k){d(h,function(){if(a.isAborted())throw new ma("acquireRenewalLock aborted.");for(var p=null,n=0;n<this._renewingContexts.length;++n){var t=this._renewingContexts[n];if(t.ctx===b){p=t.queue;break}}if(!p)return this._renewingContexts.push({ctx:b,queue:g}),!0;var l=p.poll(f,{result:function(a){d(h,function(){if(void 0===a)throw new ma("acquireRenewalLock aborted.");
p.add(a);if(a===I||a.isExpired())j(a,k);else{if(userId&&!k||k&&!k.isBoundTo(a)){var d=b.getMslStore().getUserIdToken(userId);k=d&&d.isBoundTo(a)?d:null}e.setAuthTokens(a,k);c.isNonReplayable()?j(a,k):e.isRenewable()&&a.equals(r)?j(a,k):c.isRequestingTokens()&&!k?j(a,k):i(a,k)}},m)},timeout:function(){},error:function(){}});a.setAbort(function(){l&&(p.cancel(l),l=void 0)})},m)}function i(e,f){d(h,function(){if(a.isAborted())throw new ma("acquireRenewalLock aborted.");if(!e||e.isRenewable()||!f&&c.getUserId()||
f&&f.isRenewable()){for(var d=null,h=0;h<this._renewingContexts.length;++h){var j=this._renewingContexts[h];if(j.ctx===b){d=j.queue;break}}if(!d)return this._renewingContexts.push({ctx:b,queue:g}),!0}return!1},m)}var m=this;d(h,function(){var a=e.getMasterToken(),b=e.getUserIdToken(),d=c.getUserId();c.isEncrypted()&&!e.willEncryptPayloads()||e.isRenewable()||c.isNonReplayable()||a&&a.isExpired()||!b&&d&&!e.willEncryptHeader()||c.isRequestingTokens()&&(!a||d&&!b)?j(a,b):i(a,b)},m)},releaseRenewalLock:function(a,
b,c){for(var d,g,e=0;e<this._renewingContexts.length;++e){var f=this._renewingContexts[e];if(f.ctx===a){d=e;g=f.queue;break}}if(g!==b)throw new o("Attempt to release renewal lock that is not owned by this queue.");c?(c=c.messageHeader)?(g=c.keyResponseData)?b.add(g.masterToken):(a=a.isPeerToPeer()?c.peerMasterToken:c.masterToken)?b.add(a):b.add(I):b.add(I):b.add(I);this._renewingContexts.splice(d,1)}});ad=x.Class.create({init:function(){var a={_impl:{value:new B,writable:!1,enumerable:!1,configurable:!1},
_shutdown:{value:!1,writable:!1,enumerable:!1,configurable:!1}};Object.defineProperties(this,a)},setFilterFactory:function(a){this._impl.setFilterFactory(a)},shutdown:function(){this._shutdown=!0},receive:function(a,b,c,d,g,e){if(this._shutdown)throw new l("MslControl is shutdown.");var f=new t(this._impl,a,b,c,d,g);ia(function(){f.call(e)},0);return n(f)},respond:function(a,b,c,d,g,e,f){if(this._shutdown)throw new l("MslControl is shutdown.");var h=new r(this._impl,a,b,c,d,g,e);ia(function(){h.call(f)},
0);return n(h)},request:function(a,b){if(this._shutdown)throw new l("MslControl is shutdown.");var c,d,g,e,f;if(5==arguments.length){if(c=arguments[2],g=d=null,e=arguments[3],f=arguments[4],a.isPeerToPeer()){f.error(new o("This method cannot be used in peer-to-peer mode."));return}}else if(6==arguments.length&&(c=null,d=arguments[2],g=arguments[3],e=arguments[4],f=arguments[5],!a.isPeerToPeer())){f.error(new o("This method cannot be used in trusted network mode."));return}var h=new H(this._impl,a,
b,c,d,g,null,0,e);ia(function(){h.call(f)},0);return n(h)}});t=x.Class.create({init:function(a,b,c,d,g,e){Object.defineProperties(this,{_ctrl:{value:a,writable:!1,enumerable:!1,configurable:!1},_ctx:{value:b,writable:!1,enumerable:!1,configurable:!1},_msgCtx:{value:c,writable:!1,enumerable:!1,configurable:!1},_input:{value:d,writable:!1,enumerable:!1,configurable:!1},_output:{value:g,writable:!1,enumerable:!1,configurable:!1},_timeout:{value:e,writable:!1,enumerable:!1,configurable:!1},_aborted:{value:!1,
writable:!0,enumerable:!1,configurable:!1},_abortFunc:{value:void 0,writable:!0,enumerable:!1,configurable:!1}})},isAborted:function(){return this._aborted},abort:function(){this._aborted=!0;this._abortFunc&&this._abortFunc.call(this)},setAbort:function(a){this._abortFunc=a},call:function(b){function c(f){d(b,function(){var c=f.messageHeader;if(!c)return f;this.setAbort(function(){f.abort()});f.mark(Number.MAX_VALUE);f.read(1,j._timeout,{result:function(a){d(b,function(){if(a&&0==a.length)return null;
if(a)return f.reset(),f;e(f)},j)},timeout:function(){b.timeout()},error:function(e){d(b,function(){if(g(e))return null;var f=c?c.messageId:null,i,m;e instanceof Z?(i=a.MSL_COMMS_FAILURE,m=e):(i=a.INTERNAL_EXCEPTION,m=new o("Error peeking into the message payloads."));h(this,this._ctx,f,i,null,this._output,this._timeout,{result:function(){b.error(m)},timeout:function(){b.timeout()},error:function(a){d(b,function(){if(g(a))return null;throw new ra("Error peeking into the message payloads.",a,e);},j)}})},
j)}})},j)}function e(c){d(b,function(){c.close();this._ctrl.buildResponse(this,this._ctx,this._msgCtx,c.messageHeader,this._timeout,{result:function(a){d(b,function(){var d=a.builder,g=a.tokenTicket,e=c.messageHeader,j=new G(this._msgCtx);if(!this._ctx.isPeerToPeer()||e.isEncrypting()||e.keyResponseData)f(e,d,j,g);else{var h=new H(this._ctrl,this._ctx,j,null,this._input,this._output,a,1,this._timeout);this.setAbort(function(){h.abort()});h.call(b)}},j)},timeout:function(){b.timeout()},error:function(e){d(b,
function(){if(g(e))return null;var f,i,m,k;e instanceof l?(f=e.messageId,i=e.error,m=c.messageHeader.messageCapabilities,m=this._ctrl.messageRegistry.getUserMessage(i,m?m.languages:null),k=e):(f=requestHeader?requestHeader.messageId:null,i=a.INTERNAL_EXCEPTION,m=null,k=new o("Error creating an automatic handshake response.",e));h(this,this._ctx,f,i,m,this._output,this._timeout,{result:function(){b.error(k)},timeout:function(){b.timeout()},error:function(a){d(b,function(){if(g(a))return null;throw new ra("Error creating an automatic handshake response.",
a,e);},j)}})},j)}})},j)}function f(c,e,i,m){d(b,function(){e.setRenewable(!1);this._ctrl.send(this._ctx,i,this._output,e,this._timeout,{result:function(){d(b,function(){this._ctx.isPeerToPeer()&&this._ctrl.releaseMasterToken(m);return null},j)},timeout:function(){d(b,function(){this._ctx.isPeerToPeer()&&this._ctrl.releaseMasterToken(m);b.timeout()},j)},error:function(e){d(b,function(){this._ctx.isPeerToPeer()&&this._ctrl.releaseMasterToken(m);if(g(e))return null;var f,i,k,r;e instanceof l?(f=e.messageId,
i=e.error,k=c?c.messageCapabilities:null,k=this._ctrl.messageRegistry.getUserMessage(i,k?k.languages:null),r=e):e instanceof Z?(f=c?c.messageId:null,i=a.MSL_COMMS_FAILURE,k=null,r=e):(f=c?c.messageId:null,i=a.INTERNAL_EXCEPTION,k=null,r=new o("Error sending an automatic handshake response.",e));h(this,this._ctx,f,i,k,this._output,this._timeout,{result:function(){b.error(r)},timeout:function(){b.timeout()},error:function(a){d(b,function(){if(g(a))return null;throw new ra("Error sending an automatic handshake response.",
a,e);},j)}})},j)}})},j)}var j=this;d(b,function(){this._ctrl.receive(this,this._ctx,this._msgCtx,this._input,null,this._timeout,{result:function(a){c(a)},timeout:function(){b.timeout()},error:function(c){d(b,function(){if(g(c))return null;var e,f,i,m;c instanceof l?(e=c.messageId,f=c.error,i=this._ctrl.messageRegistry.getUserMessage(f,null),m=c):(e=null,f=a.INTERNAL_EXCEPTION,i=null,m=new o("Error receiving the message header.",c));h(this,this._ctx,e,f,i,this._output,this._timeout,{result:function(){b.error(m)},
timeout:function(){b.timeout()},error:function(a){d(b,function(){if(g(a))return null;throw new ra("Error receiving the message header.",a,c);},j)}})},j)}})},j)}});r=x.Class.create({init:function(a,b,c,d,g,e,f){Object.defineProperties(this,{_ctrl:{value:a,writable:!1,enumerable:!1,configurable:!1},_ctx:{value:b,writable:!1,enumerable:!1,configurable:!1},_msgCtx:{value:c,writable:!1,enumerable:!1,configurable:!1},_input:{value:d,writable:!1,enumerable:!1,configurable:!1},_output:{value:g,writable:!1,
enumerable:!1,configurable:!1},_request:{value:e,writable:!1,enumerable:!1,configurable:!1},_timeout:{value:f,writable:!1,enumerable:!1,configurable:!1},_aborted:{value:!1,writable:!0,enumerable:!1,configurable:!1},_abortFunc:{value:void 0,writable:!0,enumerable:!1,configurable:!1}})},isAborted:function(){return this._aborted},abort:function(){this._aborted=!0;this._abortFunc&&this._abortFunc.call(this)},setAbort:function(a){this._abortFunc=a},trustedNetworkExecute:function(b,c,e){var f=this;d(e,
function(){if(12<c+1)return!1;if(this._msgCtx.isEncrypted()&&!b.willEncryptPayloads()){var j=Za(b.getMessageId());h(this,this._ctx,j,a.RESPONSE_REQUIRES_ENCRYPTION,null,this._output,this._timeout,{result:function(){e.result(!1)},timeout:function(){e.timeout()},error:function(a){d(e,function(){if(g(a))return!1;throw new ra("Response requires encryption but cannot be encrypted.",a,null);},f)}})}else this._msgCtx.getCustomer()&&!b.getMasterToken()&&!b.getKeyExchangeData()?(j=Za(b.getMessageId()),h(this,
this._ctx,j,a.RESPONSE_REQUIRES_MASTERTOKEN,null,this._output,this._timeout,{result:function(){e.result(!1)},timeout:function(){e.timeout()},error:function(a){d(e,function(){if(g(a))return!1;throw new ra("Response wishes to attach a user ID token but there is no master token.",a,null);},f)}})):(b.setRenewable(!1),this._ctrl.send(this._ctx,this._msgCtx,this._output,b,this._timeout,{result:function(){e.result(!0)},timeout:function(){e.timeout()},error:function(a){e.error(a)}}))},f)},peerToPeerExecute:function(b,
c,e,f){function j(a){d(f,function(){var c=a.response;c.close();var g=c.getErrorHeader();this._ctrl.buildErrorResponse(this,this._ctx,b,a,g,{result:function(b){d(f,function(){if(!b)return!1;var c=b.errorResult,j=b.tokenTicket;this.peerToPeerExecute(c.msgCtx,c.builder,e,{result:function(b){d(f,function(){this._ctrl.releaseMasterToken(j);b&&this._ctrl.cleanupContext(this._ctx,a.requestHeader,g);return b},i)},timeout:function(){d(f,function(){this._ctrl.releaseMasterToken(j);f.timeout()},i)},error:function(a){d(f,
function(){this._ctrl.releaseMasterToken(j);throw a;},i)}})},i)}})},i)}var i=this;d(f,function(){if(12<e+2)return!1;if(null!=b.getCustomer()&&null==c.getPeerMasterToken()&&null==c.getKeyExchangeData()){var k=Za(c.getMessageId());h(this,this._ctx,k,a.RESPONSE_REQUIRES_MASTERTOKEN,null,this._output,this._timeout,{result:function(){f.result(!1)},timeout:function(){f.timeout()},error:function(a){d(f,function(){if(g(a))return!1;throw new ra("Response wishes to attach a user ID token but there is no master token.",
a,null);},i)}})}else this._ctrl.sendReceive(this._ctx,b,this._input,this._output,c,this._timeout,!1,{result:function(a){d(f,function(){function c(){h.read(m,i._timeout,{result:function(a){d(f,function(){a?c():g()},i)},timeout:function(){f.timeout()},error:function(a){f.error(a)}})}function g(){d(f,function(){var c=new u(this._ctx,a.requestHeader,a.payloads,b);this._ctrl.buildResponse(this,this._ctx,c,k,this._timeout,{result:function(a){d(f,function(){var b=a.tokenTicket;this.peerToPeerExecute(c,a.builder,
e,{result:function(a){d(f,function(){this._ctrl.releaseMasterToken(b);return a},i)},timeout:function(){d(f,function(){this._ctrl.releaseMasterToken(b);f.timeout()},i)},error:function(a){d(f,function(){this._ctrl.releaseMasterToken(b);throw a;},i)}})},i)},timeout:function(){f.timeout()},error:function(a){f.error(a)}})},i)}var h=a.response;e+=2;if(!h)return!0;var k=h.getMessageHeader();if(k){var r=a.payloads,r=0<r.length&&0<r[0].data.length;if(a.handshake&&r)c();else return!0}else j(a)},i)},timeout:function(){f.timeout()},
error:function(a){f.error(a)}})},i)},call:function(b){var c=this;this._ctrl.buildResponse(this,this._ctx,this._msgCtx,this._request,this._timeout,{result:function(e){d(b,function(){var f=e.builder,j=e.tokenTicket;this._ctx.isPeerToPeer()?this.peerToPeerExecute(this._msgCtx,f,3,{result:function(a){d(b,function(){this._ctx.isPeerToPeer()&&this.releaseMasterToken(j);return a},c)},timeout:function(){d(b,function(){this._ctx.isPeerToPeer()&&this.releaseMasterToken(j);b.timeout()},c)},error:function(e){d(b,
function(){this._ctx.isPeerToPeer()&&this.releaseMasterToken(j);if(g(e))return!1;var i=Za(f.getMessageId()),m,k,r;e instanceof l?(m=e.error,k=this._request.messageCapabilities,k=this._ctrl.messageRegistry.getUserMessage(m,k?k.languages:null),r=e):e instanceof Z?(m=a.MSL_COMMS_FAILURE,k=null,r=e):(m=a.INTERNAL_EXCEPTION,k=null,r=new o("Error sending the response.",e));h(this,this._ctx,i,m,k,this._output,this._timeout,{result:function(){b.error(r)},timeout:function(){b.timeout()},error:function(a){d(b,
function(){if(g(a))return!1;throw new ra("Error sending the response.",a,null);},c)}})},c)}}):this.trustedNetworkExecute(f,3,{result:function(a){d(b,function(){this._ctx.isPeerToPeer()&&this.releaseMasterToken(j);return a},c)},timeout:function(){d(b,function(){this._ctx.isPeerToPeer()&&this.releaseMasterToken(j);b.timeout()},c)},error:function(e){d(b,function(){this._ctx.isPeerToPeer()&&this.releaseMasterToken(j);if(g(e))return!1;var i=Za(f.getMessageId()),m,k,r;e instanceof l?(m=e.error,k=this._request.messageCapabilities,
k=this._ctrl.messageRegistry.getUserMessage(m,k?k.languages:null),r=e):e instanceof Z?(m=a.MSL_COMMS_FAILURE,k=null,r=e):(m=a.INTERNAL_EXCEPTION,k=null,r=new o("Error sending the response.",e));h(this,this._ctx,i,m,k,this._output,this._timeout,{result:function(){b.error(r)},timeout:function(){b.timeout()},error:function(a){d(b,function(){if(g(a))return!1;throw new ra("Error sending the response.",a,null);},c)}})},c)}})},c)},timeout:function(){b.timeout()},error:function(e){d(b,function(){if(g(e))return!1;
var f,j,i,m;e instanceof l?(f=e.messageId,j=e.error,i=this._request.messageCapabilities,i=this._ctrl.messageRegistry.getUserMessage(j,i?i.languages:null),m=e):(f=null,j=a.INTERNAL_EXCEPTION,i=null,m=new o("Error building the response.",e));h(this,this._ctx,f,j,i,this._output,this._timeout,{result:function(){b.error(m)},timeout:function(){b.timeout()},error:function(a){d(b,function(){if(g(a))return null;throw new ra("Error building the response.",a,e);},c)}})},c)}})}});var N={result:function(){},timeout:function(){},
error:function(){}};H=x.Class.create({init:function(a,b,c,d,g,e,f,j,i){var h;f?(h=f.builder,f=f.tokenTicket):f=h=null;Object.defineProperties(this,{_ctrl:{value:a,writable:!1,enumerable:!1,configurable:!1},_ctx:{value:b,writable:!1,enumerable:!1,configurable:!1},_msgCtx:{value:c,writable:!1,enumerable:!1,configurable:!1},_remoteEntity:{value:d,writable:!1,enumerable:!1,configurable:!1},_input:{value:g,writable:!0,enumerable:!1,configurable:!1},_output:{value:e,writable:!0,enumerable:!1,configurable:!1},
_openedStreams:{value:!1,writable:!0,enumerable:!1,configurable:!1},_builder:{value:h,writable:!0,enumerable:!1,configurable:!1},_tokenTicket:{value:f,writable:!0,enumerable:!1,configurable:!1},_timeout:{value:i,writable:!1,enumerable:!1,configurable:!1},_msgCount:{value:j,writable:!1,enumerable:!1,configurable:!1},_aborted:{value:!1,writable:!0,enumerable:!1,configurable:!1},_abortFunc:{value:void 0,writable:!0,enumerable:!1,configurable:!1}})},isAborted:function(){return this._aborted},abort:function(){this._aborted=
!0;this._abortFunc&&this._abortFunc.call(this)},setAbort:function(a){this._abortFunc=a},execute:function(a,b,c,g,e){function f(b){function j(a){d(e,function(){var c=b.response;if(!a)return c;a.getMessageHeader()&&(c=c.getErrorHeader(),this._ctrl.cleanupContext(this._ctx,b.requestHeader,c));return a},i)}d(e,function(){var f=b.response;f.close();var h=f.getErrorHeader();this._ctrl.buildErrorResponse(this,this._ctx,a,b,h,c,{result:function(a){d(e,function(){if(!a)return f;var b=a.errorResult,h=a.tokenTicket,
m=b.builder,b=b.msgCtx;if(this._ctx.isPeerToPeer())this.execute(b,m,this._timeout,g,{result:function(a){d(e,function(){this._ctrl.releaseMasterToken(h);j(a)},i)},timeout:function(){d(e,function(){this._ctrl.releaseMasterToken(h);e.timeout()},i)},error:function(a){d(e,function(){this._ctrl.releaseMasterToken(h);e.error(a)},i)}});else{this._openedStreams&&(this._input.close(),this._output.close(c,N));var k=new H(this._ctrl,this._ctx,b,this._remoteEntity,null,null,{builder:m,tokenTicket:h},g,this._timeout);
this.setAbort(function(){k.abort()});k.call({result:function(a){j(a)},timeout:function(){e.timeout()},error:function(a){e.error(a)}})}},i)},timeout:function(){e.timeout()},error:function(a){e.error(a)}})},i)}function j(b){d(e,function(){function f(){h.read(m,i._timeout,{result:function(a){a?f():j()},timeout:function(){e.timeout()},error:function(a){e.error(a)}})}function j(){d(e,function(){var f=new u(this._ctx,b.requestHeader,b.payloads,a);this._ctrl.buildResponse(this,this._ctx,a,k,c,{result:function(a){d(e,
function(){var b=a.tokenTicket;this.execute(f,a.builder,this._timeout,g,{result:function(a){d(e,function(){this._ctrl.releaseMasterToken(b);return a},i)},timeout:function(){d(e,function(){this._ctrl.releaseMasterToken(b);e.timeout()},i)},error:function(a){d(e,function(){this._ctrl.releaseMasterToken(b);throw a;},i)}})},i)},timeout:function(){e.timeout()},error:function(a){e.error(a)}})},i)}var h=b.response,k=h.getMessageHeader(),r=b.payloads,r=0<r.length&&0<r[0].data.length;if(this._ctx.isPeerToPeer())if(b.handshake&&
r)f();else{if(0<k.keyRequestData.length){var p=new G(a);this._ctrl.buildResponse(this,this._ctx,p,k,c,{result:function(a){d(e,function(){var b=a.builder,c=a.tokenTicket;h.mark();h.read(1,this._timeout,{result:function(a){d(e,function(){function f(){h.read(m,i._timeout,{result:function(a){a?f():j()},timeout:function(){e.timeout()},error:function(a){e.error(a)}})}function j(){i.execute(p,b,i._timeout,g,{result:function(a){d(e,function(){this._ctrl.releaseMasterToken(c);return a},i)},timeout:function(){d(e,
function(){this._ctrl.releaseMasterToken(c);e.timeout()},i)},error:function(a){d(e,function(){this._ctrl.releaseMasterToken(c);throw a;},i)}})}if(a)if(h.reset(),12>=g+1)b.setRenewable(!1),this._ctrl.send(this,this._ctx,p,this._output,b,this._timeout,{result:function(){d(e,function(){this.releaseMasterToken(c);return h},i)},timeout:function(){e.timeout()},error:function(a){e.error(a)}});else return this.releaseMasterToken(c),h;else f()},i)},timeout:function(){d(e,function(){this.releaseMasterToken(c);
e.timeout()},i)},error:function(a){d(e,function(){this.releaseMasterToken(c);throw a;},i)}})},i)},timeout:function(){e.timeout()},error:function(a){e.error(a)}})}}else{if(!b.handshake||!r)return h;this._openedStreams&&(this._input.close(),this._output.close(c,N));var n=new u(this._ctx,b.requestHeader,b.payloads,a);this._ctrl.buildResponse(this,this._ctx,a,k,c,{result:function(a){d(e,function(){var b=new H(this._ctrl,this._ctx,n,this._remoteEntity,null,null,a,g,this._timeout);this.setAbort(function(){b.abort()});
b.call(e)},i)},timeout:function(){e.timeout()},error:function(a){e.error(a)}})}},i)}var i=this;d(e,function(){if(12<g+2)return null;this._ctrl.sendReceive(this,this._ctx,a,this._input,this._output,b,c,!0,{result:function(a){d(e,function(){if(!a)return null;var b=a.response;g+=2;b.getMessageHeader()?j(a):f(a)},i)},timeout:function(){e.timeout()},error:function(a){e.error(a)}})},i)},call:function(a){function b(e,f,j){d(a,function(){this.execute(this._msgCtx,e,j,this._msgCount,{result:function(b){d(a,
function(){this._ctrl.releaseMasterToken(f);this._openedStreams&&this._output.close(j,N);b&&b.closeSource(this._openedStreams);return b},c)},timeout:function(){d(a,function(){this._ctrl.releaseMasterToken(f);this._openedStreams&&(this._output.close(j,N),this._input.close());a.timeout()},c)},error:function(b){d(a,function(){this._ctrl.releaseMasterToken(f);this._openedStreams&&(this._output.close(j,N),this._input.close());if(g(b))return null;throw b;},c)}})},c)}var c=this;d(a,function(){var e=this._timeout;
if(!this._input||!this._output)try{this._remoteEntity.setTimeout(this._timeout);var f=Date.now(),j=this._remoteEntity.openConnection();this._output=j.output;this._input=j.input;-1!=e&&(e=this._timeout-(Date.now()-f));this._openedStreams=!0}catch(i){this._builder&&this._ctrl.releaseMasterToken(this._builder.getMasterToken());this._output&&this._output.close(this._timeout,N);this._input&&this._input.close();if(g(i))return null;throw i;}this._builder?b(this._builder,this._tokenTicket,e):this._ctrl.buildRequest(this,
this._ctx,this._msgCtx,this._timeout,{result:function(g){d(a,function(){b(g.builder,g.tokenTicket,e)},c)},timeout:function(){d(a,function(){this._openedStreams&&(this._output.close(this._timeout,N),this._input.close());a.timeout()},c)},error:function(b){d(a,function(){this._openedStreams&&(this._output.close(this._timeout,N),this._input.close());if(g(b))return null;throw b;},c)}})},c)}})})();var dc,bd;(function(){dc=x.Class.create({init:function(a){Object.defineProperties(this,{id:{value:a,writable:!1,
configurable:!1}})},toJSON:function(){var a={};a.id=this.id;return a},equals:function(a){return this===a?!0:!(a instanceof dc)?!1:this.id==a.id},uniqueKey:function(){return this.id}});bd=function(b){var c=b.id;if(!c)throw new A(a.JSON_PARSE_ERROR,JSON.stringify(b));return new dc(c)}})();x.Class.create({isNewestMasterToken:function(){},createMasterToken:function(){},renewMasterToken:function(){},createUserIdToken:function(){},renewUserIdToken:function(){}});var wa,Ma;(function(){function b(a,c,d,e){this.sessiondata=
a;this.tokendata=c;this.signature=d;this.verified=e}wa=x.Class.create({init:function(a,b,d,e,g,h,n,k,f,l,G){var m=this;c(G,function(){if(d.getTime()<b.getTime())throw new o("Cannot construct a master token that expires before its renewal window opens.");if(0>e||e>P)throw new o("Sequence number "+e+" is outside the valid range.");if(0>g||g>P)throw new o("Serial number "+g+" is outside the valid range.");var I=Math.floor(b.getTime()/1E3),t=Math.floor(d.getTime()/1E3),r;if(l)r=l.sessiondata;else{var H=
{};h&&(H.issuerdata=h);H.identity=n;H.encryptionkey=C(k.toByteArray());H.hmackey=C(f.toByteArray());r=W(JSON.stringify(H),S)}if(l)return Object.defineProperties(this,{ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},renewalWindowSeconds:{value:I,writable:!1,enumerable:!1,configurable:!1},expirationSeconds:{value:t,writable:!1,enumerable:!1,configurable:!1},sequenceNumber:{value:e,writable:!1,configurable:!1},serialNumber:{value:g,writable:!1,configurable:!1},issuerData:{value:h,writable:!1,
configurable:!1},identity:{value:n,writable:!1,configurable:!1},encryptionKey:{value:k,writable:!1,configurable:!1},hmacKey:{value:f,writable:!1,configurable:!1},sessiondata:{value:r,writable:!1,enumerable:!1,configurable:!1},verified:{value:l.verified,writable:!1,enumerable:!1,configurable:!1},tokendata:{value:l.tokendata,writable:!1,enumerable:!1,configurable:!1},signature:{value:l.signature,writable:!1,enumerable:!1,configurable:!1}}),this;var B=a.getMslCryptoContext();B.encrypt(r,{result:function(b){c(G,
function(){var d={};d.renewalwindow=I;d.expiration=t;d.sequencenumber=e;d.serialnumber=g;d.sessiondata=C(b);var j=W(JSON.stringify(d),S);B.sign(j,{result:function(b){c(G,function(){Object.defineProperties(this,{ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},renewalWindowSeconds:{value:I,writable:!1,enumerable:!1,configurable:!1},expirationSeconds:{value:t,writable:!1,enumerable:!1,configurable:!1},sequenceNumber:{value:e,writable:!1,enumerable:!1,configurable:!1},serialNumber:{value:g,writable:!1,
enumerable:!1,configurable:!1},issuerData:{value:h,writable:!1,configurable:!1},identity:{value:n,writable:!1,configurable:!1},encryptionKey:{value:k,writable:!1,configurable:!1},hmacKey:{value:f,writable:!1,configurable:!1},sessiondata:{value:r,writable:!1,enumerable:!1,configurable:!1},verified:{value:!0,writable:!1,enumerable:!1,configurable:!1},tokendata:{value:j,writable:!1,enumerable:!1,configurable:!1},signature:{value:b,writable:!1,enumerable:!1,configurable:!1}});return this},m)},error:function(a){G.error(a)}})},
m)},error:function(a){G.error(a)}})},this)},get renewalWindow(){return new Date(1E3*this.renewalWindowSeconds)},get expiration(){return new Date(1E3*this.expirationSeconds)},isDecrypted:function(){return this.sessiondata?!0:!1},isVerified:function(){return this.verified},isRenewable:function(){return!this.isVerified()?!0:this.renewalWindow.getTime()<=this.ctx.getTime()},isExpired:function(){return!this.isVerified()?!1:this.expiration.getTime()<=this.ctx.getTime()},isNewerThan:function(a){if(this.sequenceNumber==
a.sequenceNumber)return this.expiration>a.expiration;if(this.sequenceNumber>a.sequenceNumber){var b=this.sequenceNumber-P+127;return a.sequenceNumber>=b}b=a.sequenceNumber-P+127;return this.sequenceNumber<b},toJSON:function(){var a={};a.tokendata=C(this.tokendata);a.signature=C(this.signature);return a},equals:function(a){return this===a?!0:!(a instanceof wa)?!1:this.serialNumber==a.serialNumber&&this.sequenceNumber==a.sequenceNumber&&this.expiration.getTime()==a.expiration.getTime()},uniqueKey:function(){return this.serialNumber+
":"+this.sequenceNumber+this.expiration.getTime()}});Ma=function(d,i,j){c(j,function(){var e=d.getMslCryptoContext(),g=i.tokendata,h=i.signature;if("string"!==typeof g||"string"!==typeof h)throw new A(a.JSON_PARSE_ERROR,"mastertoken "+JSON.stringify(i));var o,k;try{o=M(g)}catch(f){throw new l(a.MASTERTOKEN_TOKENDATA_INVALID,"mastertoken "+JSON.stringify(i),f);}try{k=M(h)}catch(u){throw new l(a.MASTERTOKEN_SIGNATURE_INVALID,"mastertoken "+JSON.stringify(i),u);}e.verify(o,k,{result:function(g){c(j,
function(){var f,i,h,r,u,B=aa(o,S);try{var N=JSON.parse(B);f=parseInt(N.renewalwindow);i=parseInt(N.expiration);h=parseInt(N.sequencenumber);r=parseInt(N.serialnumber);u=N.sessiondata}catch(U){if(U instanceof SyntaxError)throw new A(a.JSON_PARSE_ERROR,"mastertokendata "+B,U);throw U;}if(!f||f!=f||!i||i!=i||"number"!==typeof h||h!=h||"number"!==typeof r||r!=r||"string"!==typeof u)throw new A(a.JSON_PARSE_ERROR,"mastertokendata "+B);if(i<f)throw new l(a.MASTERTOKEN_EXPIRES_BEFORE_RENEWAL,"mastertokendata "+
B);if(0>h||h>P)throw new l(a.MASTERTOKEN_SEQUENCE_NUMBER_OUT_OF_RANGE,"mastertokendata "+B);if(0>r||r>P)throw new l(a.MASTERTOKEN_SERIAL_NUMBER_OUT_OF_RANGE,"mastertokendata "+B);var E=new Date(1E3*f),v=new Date(1E3*i),x;try{x=M(u)}catch(ja){throw new l(a.MASTERTOKEN_SESSIONDATA_INVALID,u,ja);}if(!x||0==x.length)throw new l(a.MASTERTOKEN_SESSIONDATA_MISSING,u);g?e.decrypt(x,{result:function(e){c(j,function(){var f,i,m,l,u=aa(e,S);try{var B=JSON.parse(u);f=B.issuerdata;i=B.identity;m=B.encryptionkey;
l=B.hmackey}catch(H){if(H instanceof SyntaxError)throw new A(a.JSON_PARSE_ERROR,"sessiondata "+u,H);throw H;}if(f&&"object"!==typeof f||!i||"string"!==typeof m||"string"!==typeof l)throw new A(a.JSON_PARSE_ERROR,"sessiondata "+u);Ia(za,m,{result:function(m){Ia(Aa,l,{result:function(a){c(j,function(){var c=new b(e,o,k,g);new wa(d,E,v,h,r,f,i,m,a,c,j)})},error:function(b){j.error(new s(a.MASTERTOKEN_KEY_CREATION_ERROR,b))}})},error:function(b){j.error(new s(a.MASTERTOKEN_KEY_CREATION_ERROR,b))}})})},
error:function(a){j.error(a)}}):(f=new b(null,o,k,g),new wa(d,E,v,h,r,null,null,null,null,f,j))})},error:function(a){j.error(a)}})})}})();var ob,Ya;(function(){function b(a,c,d){this.tokendata=a;this.signature=c;this.verified=d}ob=x.Class.create({init:function(a,b,d,e,g,h,n,k,f){var l=this;c(f,function(){if(d.getTime()<b.getTime())throw new o("Cannot construct a user ID token that expires before its renewal window opens.");if(!e)throw new o("Cannot construct a user ID token without a master token.");
if(0>g||g>P)throw new o("Serial number "+g+" is outside the valid range.");var G=Math.floor(b.getTime()/1E3),m=Math.floor(d.getTime()/1E3),I=e.serialNumber;if(k){var t=k.tokendata,r=k.signature,H=k.verified,I=e.serialNumber;Object.defineProperties(this,{ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},renewalWindowSeconds:{value:G,writable:!1,enumerable:!1,configurable:!1},expirationSeconds:{value:m,writable:!1,enumerable:!1,configurable:!1},mtSerialNumber:{value:I,writable:!1,configurable:!1},
serialNumber:{value:g,writable:!1,configurable:!1},issuerData:{value:h,writable:!1,configurable:!1},customer:{value:n,writable:!1,configurable:!1},verified:{value:H,writable:!1,enumerable:!1,configurable:!1},tokendata:{value:t,writable:!1,enumerable:!1,configurable:!1},signature:{value:r,writable:!1,enumerable:!1,configurable:!1}});return this}t={};h&&(t.issuerdata=h);t.identity=n;var t=W(JSON.stringify(t),S),B=a.getMslCryptoContext();B.encrypt(t,{result:function(b){c(f,function(){var d={};d.renewalwindow=
G;d.expiration=m;d.mtserialnumber=I;d.serialnumber=g;d.userdata=C(b);var j=W(JSON.stringify(d),S);B.sign(j,{result:function(b){c(f,function(){Object.defineProperties(this,{ctx:{value:a,writable:!1,enumerable:!1,configurable:!1},renewalWindowSeconds:{value:G,writable:!1,enumerable:!1,configurable:!1},expirationSeconds:{value:m,writable:!1,enumerable:!1,configurable:!1},mtSerialNumber:{value:e.serialNumber,writable:!1,configurable:!1},serialNumber:{value:g,writable:!1,configurable:!1},issuerData:{value:h,
writable:!1,configurable:!1},customer:{value:n,writable:!1,configurable:!1},verified:{value:!0,writable:!1,enumerable:!1,configurable:!1},tokendata:{value:j,writable:!1,enumerable:!1,configurable:!1},signature:{value:b,writable:!1,enumerable:!1,configurable:!1}});return this},l)},error:function(a){f.error(a)}})},l)},error:function(a){f.error(a)}})},this)},get renewalWindow(){return new Date(1E3*this.renewalWindowSeconds)},get expiration(){return new Date(1E3*this.expirationSeconds)},isVerified:function(){return this.verified},
isDecrypted:function(){return this.customer?!0:!1},isRenewable:function(){return this.renewalWindow.getTime()<=this.ctx.getTime()},isExpired:function(){return this.expiration.getTime()<=this.ctx.getTime()},isBoundTo:function(a){return a&&a.serialNumber==this.mtSerialNumber},toJSON:function(){var a={};a.tokendata=C(this.tokendata);a.signature=C(this.signature);return a},equals:function(a){return this===a?!0:!(a instanceof ob)?!1:this.serialNumber==a.serialNumber&&this.mtSerialNumber==a.mtSerialNumber},
uniqueKey:function(){return this.serialNumber+":"+this.mtSerialNumber}});Ya=function(d,i,j,e){c(e,function(){var g=d.getMslCryptoContext(),h=i.tokendata,o=i.signature;if(!h||"string"!==typeof h||"string"!==typeof o)throw new A(a.JSON_PARSE_ERROR,"useridtoken "+JSON.stringify(i));var k,f;try{k=M(h)}catch(u){throw new l(a.USERIDTOKEN_TOKENDATA_INVALID,"useridtoken "+JSON.stringify(i),u);}try{f=M(o)}catch(G){throw new l(a.USERIDTOKEN_TOKENDATA_INVALID,"useridtoken "+JSON.stringify(i),G);}g.verify(k,
f,{result:function(i){c(e,function(){var h,t,r,u,o,y=aa(k,S);try{var G=JSON.parse(y);h=parseInt(G.renewalwindow);t=parseInt(G.expiration);r=parseInt(G.mtserialnumber);u=parseInt(G.serialnumber);o=G.userdata}catch(s){if(s instanceof SyntaxError)throw new A(a.JSON_PARSE_ERROR,"usertokendata "+y,s);throw s;}if(!h||h!=h||!t||t!=t||"number"!==typeof r||r!=r||"number"!==typeof u||u!=u||"string"!==typeof o)throw new A(a.JSON_PARSE_ERROR,"usertokendata "+y);if(t<h)throw new l(a.USERIDTOKEN_EXPIRES_BEFORE_RENEWAL,
"mastertokendata "+y);if(0>r||r>P)throw new l(a.USERIDTOKEN_MASTERTOKEN_SERIAL_NUMBER_OUT_OF_RANGE,"usertokendata "+y);if(0>u||u>P)throw new l(a.USERIDTOKEN_SERIAL_NUMBER_OUT_OF_RANGE,"usertokendata "+y);var v=new Date(1E3*h),x=new Date(1E3*t);if(!j||r!=j.serialNumber)throw new l(a.USERIDTOKEN_MASTERTOKEN_MISMATCH,"uit mtserialnumber "+r+"; mt "+JSON.stringify(j));var ja;try{ja=M(o)}catch(ca){throw new l(a.USERIDTOKEN_USERDATA_INVALID,o,ca);}if(!ja||0==ja.length)throw new l(a.USERIDTOKEN_USERDATA_MISSING,
o);i?g.decrypt(ja,{result:function(g){c(e,function(){var c=aa(g,S),h=JSON.parse(c),r=h.issuerdata,h=h.identity;if(r&&"object"!==typeof r||"object"!==typeof h)throw new A(a.JSON_PARSE_ERROR,"userdata "+c);var t;try{t=bd(h)}catch(o){throw new l(a.USERIDTOKEN_IDENTITY_INVALID,"userdata "+c,o);}c=new b(k,f,i);new ob(d,v,x,j,u,r,t,c,e)})},error:function(a){e.error(a)}}):(h=new b(k,f,i),new ob(d,v,x,j,u,null,null,h,e))})},error:function(a){e.error(a)}})})}})();var Qa,Ha,Zb;(function(){function b(c,d){var e=
c.tokendata;if(!e)throw new A(a.JSON_PARSE_ERROR,"servicetoken "+JSON.stringify(c));var g;try{var h;try{h=M(e)}catch(n){throw new l(a.SERVICETOKEN_TOKENDATA_INVALID,"servicetoken "+JSON.stringify(c),n);}g=JSON.parse(aa(h,S)).name}catch(k){if(k instanceof SyntaxError)throw new A(a.JSON_PARSE_ERROR,"servicetoken "+JSON.stringify(c),k);throw k;}if(!g)throw new A(a.JSON_PARSE_ERROR,"servicetoken "+JSON.stringify(c));return d[g]?d[g]:d[""]}function d(a,b,c){this.tokendata=a;this.signature=b;this.verified=
c}Qa=x.Class.create({init:function(a,b,d,g,h,n,k,f){var l=this;c(f,function(){if(d&&g&&!g.isBoundTo(d))throw new o("Cannot construct a service token bound to a master token and user ID token where the user ID token is not bound to the same master token.");var p=d?d.serialNumber:-1,m=g?g.serialNumber:-1;if(k)return t=k.tokendata,Object.defineProperties(this,{name:{value:a,writable:!1,configurable:!1},mtSerialNumber:{value:p,writable:!1,configurable:!1},uitSerialNumber:{value:m,writable:!1,configurable:!1},
data:{value:b,writable:!1,configurable:!1},encrypted:{value:h,writable:!1,enumerable:!1,configurable:!1},verified:{value:k.verified,writable:!1,enumerable:!1,configurable:!1},tokendata:{value:t,writable:!1,enumerable:!1,configurable:!1},signature:{value:k.signature,writable:!1,enumerable:!1,configurable:!1}}),this;var I={};I.name=a;-1!=p&&(I.mtserialnumber=p);-1!=m&&(I.uitserialnumber=m);if((I.encrypted=h)&&0<b.length)n.encrypt(b,{result:function(d){c(f,function(){I.servicedata=C(d);var e=W(JSON.stringify(I),
S);n.sign(e,{result:function(d){c(f,function(){Object.defineProperties(this,{name:{value:a,writable:!1,configurable:!1},mtSerialNumber:{value:p,writable:!1,configurable:!1},uitSerialNumber:{value:m,writable:!1,configurable:!1},data:{value:b,writable:!1,configurable:!1},encrypted:{value:h,writable:!1,enumerable:!1,configurable:!1},verified:{value:!0,writable:!1,enumerable:!1,configurable:!1},tokendata:{value:e,writable:!1,enumerable:!1,configurable:!1},signature:{value:d,writable:!1,enumerable:!1,
configurable:!1}});return this},l)},error:function(a){f.error(a)}})},l)},error:function(a){f.error(a)}});else{I.servicedata=C(b);var t=W(JSON.stringify(I),S);n.sign(t,{result:function(d){c(f,function(){Object.defineProperties(this,{name:{value:a,writable:!1,configurable:!1},mtSerialNumber:{value:p,writable:!1,configurable:!1},uitSerialNumber:{value:m,writable:!1,configurable:!1},data:{value:b,writable:!1,configurable:!1},encrypted:{value:h,writable:!1,enumerable:!1,configurable:!1},verified:{value:!0,
writable:!1,enumerable:!1,configurable:!1},tokendata:{value:t,writable:!1,enumerable:!1,configurable:!1},signature:{value:d,writable:!1,enumerable:!1,configurable:!1}});return this},l)},error:function(a){f.error(a)}})}},this)},isEncrypted:function(){return this.encrypted},isVerified:function(){return this.verified},isDecrypted:function(){return this.data?!0:!1},isDeleted:function(){return this.data&&0==this.data.length},isMasterTokenBound:function(){return-1!=this.mtSerialNumber},isBoundTo:function(a){return!a?
!1:a instanceof wa?a.serialNumber==this.mtSerialNumber:a instanceof ob?a.serialNumber==this.uitSerialNumber:!1},isUserIdTokenBound:function(){return-1!=this.uitSerialNumber},isUnbound:function(){return-1==this.mtSerialNumber&&-1==this.uitSerialNumber},toJSON:function(){var a={};a.tokendata=C(this.tokendata);a.signature=C(this.signature);return a},equals:function(a){return this===a?!0:!(a instanceof Qa)?!1:this.name==a.name&&this.mtSerialNumber==a.mtSerialNumber&&this.uitSerialNumber==a.uitSerialNumber},
uniqueKey:function(){return this.name+":"+this.mtSerialNumber+":"+this.uitSerialNumber}});Ha=function(a,b,c,d,h,n,k){new Qa(a,b,c,d,h,n,null,k)};Zb=function(i,j,e,g,h){c(h,function(){g&&!(g instanceof Wa)&&(g=b(i,g));var o=i.tokendata,k=i.signature;if(!o||"string"!==typeof o||"string"!==typeof k)throw new A(a.JSON_PARSE_ERROR,"servicetoken "+JSON.stringify(i));var f,u;try{f=M(o)}catch(G){throw new l(a.SERVICETOKEN_TOKENDATA_INVALID,"servicetoken "+JSON.stringify(i),G);}try{u=M(k)}catch(m){throw new l(a.SERVICETOKEN_SIGNATURE_INVALID,
"servicetoken "+JSON.stringify(i),m);}var I,t,r,H,B,s=aa(f,S);try{var x=JSON.parse(s);I=x.name;t=x.mtserialnumber?parseInt(x.mtserialnumber):-1;r=x.uitserialnumber?parseInt(x.uitserialnumber):-1;H=x.encrypted;B=x.servicedata}catch(E){if(E instanceof SyntaxError)throw new A(a.JSON_PARSE_ERROR,"servicetokendata "+s,E);throw E;}if(!I||"number"!==typeof t||t!=t||"number"!==typeof r||r!=r||"boolean"!==typeof H||"string"!==typeof B)throw new A(a.JSON_PARSE_ERROR,"servicetokendata "+s);if(x.mtserialnumber&&
0>t||t>P)throw new l(a.SERVICETOKEN_MASTERTOKEN_SERIAL_NUMBER_OUT_OF_RANGE,"servicetokendata "+s);if(x.uitserialnumber&&0>r||r>P)throw new l(a.SERVICETOKEN_USERIDTOKEN_SERIAL_NUMBER_OUT_OF_RANGE,"servicetokendata "+s);if(-1!=t&&(!j||t!=j.serialNumber))throw new l(a.SERVICETOKEN_MASTERTOKEN_MISMATCH,"st mtserialnumber "+t+"; mt "+j);if(-1!=r&&(!e||r!=e.serialNumber))throw new l(a.SERVICETOKEN_USERIDTOKEN_MISMATCH,"st uitserialnumber "+r+"; uit "+e);H=!0===H;g?g.verify(f,u,{result:function(b){c(h,function(){if(b){var i;
try{i=M(B)}catch(m){throw new l(a.SERVICETOKEN_SERVICEDATA_INVALID,"servicetokendata "+s,m);}if(!i||0!=B.length&&0==i.length)throw new l(a.SERVICETOKEN_SERVICEDATA_INVALID,"servicetokendata "+s);if(H&&0<i.length)g.decrypt(i,{result:function(a){c(h,function(){var c=new d(f,u,b);new Qa(I,a,-1!=t?j:null,-1!=r?e:null,H,g,c,h)})},error:function(a){h.error(a)}});else{var k=new d(f,u,b);new Qa(I,i,-1!=t?j:null,-1!=r?e:null,H,g,k,h)}}else i=""==B?new Uint8Array(0):null,k=new d(f,u,b),new Qa(I,i,-1!=t?j:null,
-1!=r?e:null,H,g,k,h)})},error:function(a){throw a;}}):(o=""==B?new Uint8Array(0):null,k=new d(f,u,!1),new Qa(I,o,-1!=t?j:null,-1!=r?e:null,H,g,k,h))})}})();var xa={EMAIL_PASSWORD:"EMAIL_PASSWORD",NETFLIXID:"NETFLIXID",SSO:"SSO",SWITCH_PROFILE:"SWITCH_PROFILE",MDX:"MDX"};Object.freeze(xa);var $a,Qc;(function(){$a=x.Class.create({init:function(a){Object.defineProperties(this,{scheme:{value:a,writable:!1,configurable:!1}})},getAuthData:function(){},equals:function(a){return this===a?!0:!(a instanceof
$a)?!1:this.scheme==a.scheme},toJSON:function(){var a={};a.scheme=this.scheme;a.authdata=this.getAuthData();return a}});Qc=function(b,d,i,j){c(j,function(){var c=i.scheme,g=i.authdata;if(!c||!g)throw new A(a.JSON_PARSE_ERROR,"userauthdata "+JSON.stringify(i));if(!xa[c])throw new L(a.UNIDENTIFIED_USERAUTH_SCHEME,c);var h=b.getUserAuthenticationFactory(c);if(!h)throw new L(a.USERAUTH_FACTORY_NOT_FOUND,c);h.createData(b,d,g,j)})}})();var Db=x.Class.create({init:function(a){Object.defineProperties(this,
{scheme:{value:a,writable:!1,configurable:!1}})},createData:function(){},authenticate:function(){}}),pb,cd;(function(){pb=$a.extend({init:function p(a,b){p.base.call(this,xa.EMAIL_PASSWORD);Object.defineProperties(this,{email:{value:a,writable:!1,configurable:!1},password:{value:b,writable:!1,configurable:!1}})},getAuthData:function(){var a={};a.email=this.email;a.password=this.password;return a},equals:function i(a){return this===a?!0:!(a instanceof pb)?!1:i.base.call(this,this,a)&&this.email==a.email&&
this.password==a.password}});cd=function(b){var c=b.email,d=b.password;if(!c||!d)throw new A(a.JSON_PARSE_ERROR,"email/password authdata "+JSON.stringify(b));return new pb(c,d)}})();Db.extend({init:function p(){p.base.call(this,xa.EMAIL_PASSWORD)},createData:function(a,b,d,e){c(e,function(){return cd(d)})},authenticate:function(b,c,d){if(!(d instanceof pb))throw new o("Incorrect authentication data type "+d+".");b=d.password;if(!d.email||!b)throw new L(a.EMAILPASSWORD_BLANK);throw new L(a.UNSUPPORTED_USERAUTH_DATA,
this.scheme);}});var qb,dd,Eb,ec,Fb,fc;(function(){function b(a,c){return"<"+a+">"+c+"</"+a+">"}function d(a){return a.replace(/[<>&"']/g/*"*/,function(a){return k[a]})}function j(a){return encodeURIComponent(a).replace("%20","+").replace(/[!'()]/g/*'*/,escape).replace(/\*/g,"%2A")}var e=Eb={MSL:"MSL",NTBA:"NTBA",MSL_LEGACY:"MSL_LEGACY"},g=x.Class.create({getAction:function(){},getNonce:function(){},getPin:function(){},getSignature:function(){},getEncoding:function(){},equals:function(){}}),h=ec=g.extend({init:function(b,
d,e,g,f,h,j){function i(g){c(j,function(){var c;try{var h={};h.useridtoken=b;h.action=d;h.nonce=e;h.pin=C(g);c=W(JSON.stringify(h),S)}catch(i){throw new A(a.JSON_ENCODE_ERROR,"MSL-based MDX authdata",i);}f.sign(c,{result:function(a){k(c,a)},error:j.error})},l)}function k(a,f){c(j,function(){Object.defineProperties(this,{_userIdToken:{value:b,writable:!1,enumerable:!1,configurable:!1},_action:{value:d,writable:!1,enumerable:!1,configurable:!1},_nonce:{value:e,writable:!1,enumerable:!1,configurable:!1},
_pin:{value:g,writable:!1,enumerable:!1,configurable:!1},_encoding:{value:a,writable:!1,enumerable:!1,configurable:!1},_signature:{value:f,writable:!1,enumerable:!1,configurable:!1}});return this},l)}var l=this;c(j,function(){h?k(h.encoding,h.signature):f.encrypt(W(g,S),{result:function(a){i(a)},error:j.error})},l)},getUserIdToken:function(){return this._userIdToken},getAction:function(){return this._action},getNonce:function(){return this._nonce},getPin:function(){return this._pin},getSignature:function(){return this._signature},
getEncoding:function(){return this._encoding},equals:function(a){return this===a?!0:!(a instanceof h)?!1:this._action==a._action&&this._nonce==a._nonce&&this._pin==a._pin&&this._userIdToken.equals(a._userIdToken)}});ec.ACTION="userauth";var y=function(b,d,e,g,f){function j(g){c(f,function(){var h=aa(e,S),j,k,r,p;try{var u=JSON.parse(h);j=u.useridtoken;k=u.action;r=u.nonce;p=u.pin}catch(o){if(o instanceof SyntaxError)throw new A(a.JSON_PARSE_ERROR,"MDX authdata "+h,o);throw o;}if(!j||"object"!==typeof j||
!k||"string"!==typeof k||!r||"number"!==typeof r||!p||"string"!==typeof p)throw new A(a.JSON_PARSE_ERROR,"MDX authdata "+h);Ya(b,j,d,{result:function(b){c(f,function(){if(!b.isDecrypted())throw new L(a.USERAUTH_USERIDTOKEN_NOT_DECRYPTED,"MDX authdata "+h);i(g,b,k,r,p)})},error:function(b){c(f,function(){if(b instanceof l)throw new L(a.USERAUTH_USERIDTOKEN_INVALID,"MDX authdata "+h,b);throw b;})}})})}function i(a,b,d,j,k){c(f,function(){var i=M(k);a.decrypt(i,{result:function(a){c(f,function(){var c=
aa(a,S);new h(b,d,j,c,null,{encoding:e,signature:g},f)})},error:f.error})})}c(f,function(){var h;try{var i=b.getMslStore().getCryptoContext(d);h=i?i:new oa(b,d)}catch(k){if(k instanceof Ca)throw new L(a.USERAUTH_MASTERTOKEN_NOT_DECRYPTED,"MDX authdata "+C(e));throw k;}h.verify(e,g,{result:function(b){c(f,function(){if(!b)throw new s(a.MDX_USERAUTH_VERIFICATION_FAILED,"MDX authdata "+C(e));j(h)})},error:f.error})})},k={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&apos;"},f=Fb=g.extend({init:function(a,
c,e,g){var f=b("action",d(a)),h=b("nonce",c.toString()),e=b("pin",e),f=b("registerdata",f+h+e),f=W(f,"utf-8");Object.defineProperties(this,{_action:{value:a,writable:!1,enumerable:!1,configurable:!1},_nonce:{value:c,writable:!1,enumerable:!1,configurable:!1},_pin:{value:null,writable:!1,enumerable:!1,configurable:!1},_encoding:{value:f,writable:!1,enumerable:!1,configurable:!1},_signature:{value:g,writable:!1,enumerable:!1,configurable:!1}})},getAction:function(){return this._action},getNonce:function(){return this._nonce},
getPin:function(){return this._pin},getSignature:function(){return this._signature},getEncoding:function(){return this._encoding},equals:function(a){return this===a?!0:!(a instanceof f)?!1:this._action==a._action&&this._nonce==a._nonce&&this._pin==a._pin}});Fb.ACTION="regpairrequest";var u=fc=g.extend({init:function(a,e,g,f,h,k){function l(g){c(k,function(){var c=C(g),h=b("action",d(a)),l=b("nonce",e.toString()),t=b("pin",c),h=b("registerdata",h+l+t),o=W(h,"utf-8"),c="action="+j(a)+"&nonce="+j(e.toString())+
"&pin="+j(c);f.sign(W(c,"utf-8"),{result:function(a){u(o,a)},error:k.error})},o)}function u(b,d){c(k,function(){Object.defineProperties(this,{_action:{value:a,writable:!1,enumerable:!1,configurable:!1},_nonce:{value:e,writable:!1,enumerable:!1,configurable:!1},_pin:{value:g,writable:!1,enumerable:!1,configurable:!1},_encoding:{value:b,writable:!1,enumerable:!1,configurable:!1},_signature:{value:d,writable:!1,enumerable:!1,configurable:!1}});return this},o)}var o=this;c(k,function(){h?u(h.encoding,
h.signature):f.encrypt(W(g,"utf-8"),{result:function(a){l(a)},error:k.error})},o)},getAction:function(){return this._action},getNonce:function(){return this._nonce},getPin:function(){return this._pin},getSignature:function(){return this._signature},getEncoding:function(){return this._encoding},equals:function(a){return this===a?!0:!(a instanceof u)?!1:this._action==a._action&&this._nonce==a._nonce&&this._pin==a._pin}});fc.ACTION=Fb.ACTION;var G=function(b,d,e,g,f){c(f,function(){var h=b.getMslStore().getCryptoContext(d),
i=h?h:new oa(b,d),h=aa(e,"utf-8"),k=(new DOMParser).parseFromString(h,"application/xml"),h=k.getElementsByTagName("action"),l=k.getElementsByTagName("nonce"),k=k.getElementsByTagName("pin"),p=h&&1==h.length&&h[0].firstChild?h[0].firstChild.nodeValue:null,o=l&&1==l.length&&l[0].firstChild?parseInt(l[0].firstChild.nodeValue):null,y=k&&1==k.length&&k[0].firstChild?k[0].firstChild.nodeValue:null;if(!p||!o||!y)throw new A(a.XML_PARSE_ERROR,"MDX authdata "+C(e));h="action="+j(p)+"&nonce="+j(o.toString())+
"&pin="+j(y);i.verify(W(h,"utf-8"),g,{result:function(b){c(f,function(){if(!b)throw new s(a.MDX_USERAUTH_VERIFICATION_FAILED,"MDX authdata "+C(e));var d=M(y);i.decrypt(d,{result:function(a){c(f,function(){var b=aa(a,"utf-8");new u(p,o,b,null,{encoding:e,signature:g},f)})},error:f.error})})},error:f.error})})};qb=$a.extend({init:function I(a,b,c,d,g,f){I.base.call(this,xa.MDX);var j=null,i=null,k=null;if("string"===typeof c)a=e.MSL_LEGACY,k=c;else if(c instanceof Uint8Array)a=e.NTBA,i=c;else if(c instanceof
wa)a=e.MSL,j=c;else throw new TypeError("Controller token "+c+" is not a master token, encrypted CTicket, or MSL token construct.");var l=c=null,p=null,u=null;if(f){var o=f.controllerAuthData,c=o.getAction(),l=o.getPin(),p=f.userIdToken;o instanceof h?u=o.getUserIdToken().customer:p&&(u=p.customer)}Object.defineProperties(this,{mechanism:{value:a,writable:!1,configurable:!1},action:{value:c,writable:!1,configurable:!1},targetPin:{value:b,writable:!1,configurable:!1},controllerPin:{value:l,writable:!1,
configurable:!1},customer:{value:u,writable:!1,configurable:!1},_masterToken:{value:j,writable:!1,enumerable:!1,configurable:!1},_encryptedCTicket:{value:i,writable:!1,enumerable:!1,configurable:!1},_mslTokens:{value:k,writable:!1,enumerable:!1,configurable:!1},_controllerEncoding:{value:d,writable:!1,enumerable:!1,configurable:!1},_signature:{value:g,writable:!1,enumerable:!1,configurable:!1}})},getAuthData:function(){var a={};switch(this.mechanism){case e.MSL:var b=JSON.parse(JSON.stringify(this._masterToken));
a.mastertoken=b;break;case e.NTBA:b=aa(this._encryptedCTicket,"utf-8");a.cticket=b;break;case e.MSL_LEGACY:a.cticket=this._mslTokens;break;default:throw new o("Unsupported MDX mechanism.");}a.pin=this.targetPin;a.mdxauthdata=C(this._controllerEncoding);a.signature=C(this._signature);return a},equals:function t(a){return this===a?!0:!(a instanceof qb)?!1:t.base.call(this,a)&&(this._masterToken==a._masterToken||this._masterToken&&this._masterToken.equals(a._masterToken))&&(this._encryptedCTicket==a._encryptedCTicket||
this._encryptedCTicket&&ka(this._encryptedCTicket,a._encryptedCTicket))&&this._mslTokens==a._mslTokens&&ka(this._controllerEncoding,a._controllerEncoding)&&ka(this._signature,a._signature)}});dd=function(b,d,e){function g(f,h,j,i){Ma(b,h,{result:function(g){c(e,function(){if(!g.isDecrypted())throw new L(a.USERAUTH_MASTERTOKEN_NOT_DECRYPTED,"MDX authdata "+d.toString());y(b,g,j,i,{result:function(a){c(e,function(){var c=a.getEncoding(),d=a.getSignature();return new qb(b,f,g,c,d,{controllerAuthData:a,
userIdToken:null})})},error:e.error})})},error:function(b){c(e,function(){if(b instanceof l)throw new L(a.USERAUTH_MASTERTOKEN_INVALID,"MDX authdata "+JSON.stringify(d),b);throw b;})}})}function f(){c(e,function(){throw new L(a.UNSUPPORTED_USERAUTH_MECHANISM,"NtbaControllerData$parse");})}function h(g,f,j,i){function k(e,g){c(g,function(){var f;try{f=M(e)}catch(h){throw new L(a.USERAUTH_MASTERTOKEN_INVALID,"MDX authdata "+JSON.stringify(d),h);}if(!f||0==f.length)throw new L(a.USERAUTH_MASTERTOKEN_MISSING,
"MDX authdata "+JSON.stringify(d));try{var j=JSON.parse(aa(f,"utf-8"));Ma(b,j,{result:function(b){c(g,function(){if(!b.isDecrypted())throw new L(a.USERAUTH_MASTERTOKEN_NOT_DECRYPTED,"MDX authdata "+d.toString());return b})},error:function(b){c(g,function(){if(b instanceof l)throw new L(a.USERAUTH_MASTERTOKEN_INVALID,"MDX authdata "+JSON.stringify(d),b);throw b;})}})}catch(i){if(i instanceof SyntaxError)throw new A(a.JSON_PARSE_ERROR,"MDX authdata "+JSON.stringify(d),i);throw i;}})}function p(e,g,
f){c(f,function(){var h;try{h=M(e)}catch(j){throw new L(a.USERAUTH_USERIDTOKEN_INVALID,"MDX authdata "+JSON.stringify(d),j);}if(!h||0==h.length)throw new L(a.USERAUTH_USERIDTOKEN_MISSING,"MDX authdata "+JSON.stringify(d));try{var i=JSON.parse(aa(h,"utf-8"));Ya(b,i,g,{result:function(b){c(f,function(){if(!b.isDecrypted())throw new L(a.USERAUTH_USERIDTOKEN_NOT_DECRYPTED,"MDX authdata "+JSON.stringify(d));return b})},error:function(b){c(f,function(){if(b instanceof l)throw new L(a.USERAUTH_USERIDTOKEN_INVALID,
"MDX authdata "+JSON.stringify(d),b);throw b;})}})}catch(k){if(k instanceof SyntaxError)throw new A(a.JSON_PARSE_ERROR,"MDX authdata "+JSON.stringify(d),k);throw k;}})}c(e,function(){var h=f.split(",");if(3!=h.length||"1"!=h[0])throw new L(a.UNIDENTIFIED_USERAUTH_MECHANISM,"MDX authdata "+JSON.stringify(d));k(h[1],{result:function(k){p(h[2],k,{result:function(h){G(b,k,j,i,{result:function(a){c(e,function(){return new qb(b,g,f,j,i,{controllerAuthData:a,userIdToken:h})})},error:function(b){c(e,function(){if(b instanceof
Ca)throw new L(a.USERAUTH_MASTERTOKEN_NOT_DECRYPTED,"MDX authdata "+JSON.stringify(d),b);throw b;})}})},error:e.error})},error:e.error})})}c(e,function(){var b=d.pin,c=d.mdxauthdata,e=d.signature;if(!b||"string"!==typeof b||!c||"string"!==typeof c||!e||"string"!==typeof e)throw new A(a.JSON_PARSE_ERROR,"MDX authdata "+JSON.stringify(d));var j,i;try{j=M(c),i=M(e)}catch(k){throw new L(a.MDX_CONTROLLERDATA_INVALID,"MDX authdata "+JSON.stringify(d),k);}if(d.mastertoken){c=d.mastertoken;if(!c||"object"!==
typeof c)throw new A(a.JSON_PARSE_ERROR,"MDX authdata "+JSON.stringify(d));g(b,c,j,i)}else if(d.cticket){c=d.cticket;if(!c||"string"!==typeof c)throw new A(a.JSON_PARSE_ERROR,"MDX authdata "+JSON.stringify(d));-1==c.indexOf(",")?f(b,c,j,i):h(b,c,j,i)}else throw new L(a.UNIDENTIFIED_USERAUTH_MECHANISM,"MDX authdata "+JSON.stringify(d));})}})();(function(){var b=ec.ACTION,c=Fb.ACTION,d=fc.ACTION;Db.extend({init:function g(){g.base.call(this,xa.MDX)},createData:function(a,b,c,d){dd(a,c,d)},authenticate:function(g,
h,l,k){if(!(l instanceof qb))throw new o("Incorrect authentication data type "+l.getClass().getName()+".");g=l.action;switch(l.mechanism){case Eb.MSL:if(b!=g)throw new L(a.MDX_USERAUTH_ACTION_INVALID);break;case Eb.NTBA:if(c!=g)throw new L(a.MDX_USERAUTH_ACTION_INVALID);break;case Eb.MSL_LEGACY:if(d!=g)throw new L(a.MDX_USERAUTH_ACTION_INVALID);}g=l.controllerPin;h=l.targetPin;if(!g||!h)throw new L(a.MDX_PIN_BLANK);if(g!=h)throw new L(a.MDX_PIN_MISMATCH);l=l.customer;if(!l)throw new L(a.MDX_USER_UNKNOWN);
if(k&&(k=k.customer,!l.equals(k)))throw new L(a.USERIDTOKEN_USERAUTH_DATA_MISMATCH,"uad customer "+l+"; uit customer "+k);return l}})})();var rb,ed;(function(){rb=$a.extend({init:function i(a,b){i.base.call(this,xa.NETFLIXID);Object.defineProperties(this,{netflixId:{value:a,writable:!1,configurable:!1},secureNetflixId:{value:b,writable:!1,configurable:!1}})},getAuthData:function(){var a={};a.netflixid=this.netflixId;this.secureNetflixId&&(a.securenetflixid=this.secureNetflixId);return a},equals:function j(a){return this===
a?!0:!(a instanceof rb)?!1:j.base.call(this,a)&&this.netflixId==a.netflixId&&this.secureNetflixId==a.secureNetflixId}});ed=function(b){var c=b.netflixid,d=b.securenetflixid;if(!c)throw new A(a.JSON_PARSE_ERROR,"NetflixId authdata "+JSON.stringify(b));return new rb(c,d)}})();Db.extend({init:function i(){i.base.call(this,xa.NETFLIXID)},createData:function(a,b,d,g){c(g,function(){return ed(d)})},authenticate:function(b,c,d){if(!(d instanceof rb))throw new o("Incorrect authentication data type "+d+".");
b=d.secureNetflixId;if(!d.netflixId||!b)throw new L(a.NETFLIXID_COOKIES_BLANK);throw new L(a.UNSUPPORTED_USERAUTH_DATA,this.scheme);}});var sb,fd,gd,hd,id;(function(){var b=gd={MICROSOFT_SAML:"MICROSOFT_SAML",SAMSUNG:"SAMSUNG"},c=hd=x.Class.create({init:function(a,b){Object.defineProperties(this,{email:{value:a,writable:!1,enumerable:!0,configurable:!1},password:{value:b,writable:!1,enumerable:!0,configurable:!1}})}}),d=id=x.Class.create({init:function(a,b){Object.defineProperties(this,{netflixId:{value:a,
writable:!1,enumerable:!0,configurable:!1},secureNetflixId:{value:b,writable:!1,enumerable:!0,configurable:!1}})}});sb=$a.extend({init:function h(a,b,f){h.base.call(this,xa.SSO);var i=null,l=null,m=null,o=null;f instanceof c?(i=f.email,l=f.password):f instanceof d&&(m=f.netflixId,o=f.secureNetflixId);Object.defineProperties(this,{mechanism:{value:a,writable:!1,configurable:!1},token:{value:b,writable:!1,configurable:!1},email:{value:i,writable:!1,configurable:!1},password:{value:l,writable:!1,configurable:!1},
netflixId:{value:m,writable:!1,configurable:!1},secureNetflixId:{value:o,writable:!1,configurable:!1}})},getAuthData:function(){var a={};a.mechanism=this.mechanism;a.token=C(this.token);this.email&&this.password?(a.email=this.email,a.password=this.password):this.netflixId&&this.secureNetflixId&&(a.netflixid=this.netflixId,a.securenetflixid=this.secureNetflixId);return a},equals:function y(a){return this===a?!0:!(a instanceof sb)?!1:y.base.call(this,a)&&this.mechanism==a.mechanism&&ka(this.token,a.token)&&
this.email==a.email&&this.password==a.password&&this.netflixId==a.netflixId&&this.secureNetflixId==a.secureNetflixId}});fd=function(l){var k=l.mechanism,f=l.token;if(!k||!f||"string"!==typeof f)throw new A(a.JSON_PARSE_ERROR,"SSO authdata "+JSON.stringify(l));if(!b[k])throw new L(a.UNIDENTIFIED_USERAUTH_MECHANISM,"SSO authdata "+JSON.stringify(l));var o=l.email,s=l.password,m=l.netflixid,x=l.securenetflixid;if(o&&!s||!o&&s||m&&!x||!m&&x||o&&m)throw new A(a.JSON_PARSE_ERROR,"SSO authdata "+JSON.stringify(l));
var t;try{t=M(f)}catch(r){throw new L(a.SSOTOKEN_INVALID,"SSO authdata "+JSON.stringify(l),r);}var H;o&&s?H=new c(o,s):m&&x&&(H=new d(m,x));return new sb(k,t,H)}})();Db.extend({init:function j(){j.base.call(this,xa.SSO)},createData:function(a,b,d,h){c(h,function(){return fd(d)})},authenticate:function(b,c,d){if(!(d instanceof sb))throw new o("Incorrect authentication data type "+d+".");var b=d.token,c=d.email,h=d.password,l=d.netflixId,d=d.secureNetflixId;if(!b||0==b.length)throw new L(a.SSOTOKEN_BLANK);
if((null!==c||null!==h)&&(!c||!h))throw new L(a.EMAILPASSWORD_BLANK);if((null!==l||null!==d)&&(!l||!d))throw new L(a.NETFLIXID_COOKIES_BLANK);throw new L(a.UNSUPPORTED_USERAUTH_DATA,this.scheme);}});var Dd=x.Class.create({getTime:function(){},getRandom:function(){},isPeerToPeer:function(){},getMessageCapabilities:function(){},getEntityAuthenticationData:function(){},getMslCryptoContext:function(){},getEntityAuthenticationFactory:function(){},getUserAuthenticationFactory:function(){},getTokenFactory:function(){},
getKeyExchangeFactory:function(){},getKeyExchangeFactories:function(){},getMslStore:function(){}}),jd=x.Class.create({setCryptoContext:function(){},getMasterToken:function(){},getCryptoContext:function(){},removeCryptoContext:function(){},clearCryptoContexts:function(){},addUserIdToken:function(){},getUserIdToken:function(){},removeUserIdToken:function(){},clearUserIdTokens:function(){},addServiceTokens:function(){},getServiceTokens:function(){},removeServiceTokens:function(){},clearServiceTokens:function(){}});
jd.extend({setCryptoContext:function(){},getMasterToken:function(){return null},getCryptoContext:function(){return null},removeCryptoContext:function(){},clearCryptoContexts:function(){},addUserIdToken:function(){},getUserIdToken:function(){return null},removeUserIdToken:function(){},clearUserIdTokens:function(){},addServiceTokens:function(){},getServiceTokens:function(b,c){if(c){if(!b)throw new l(a.USERIDTOKEN_MASTERTOKEN_NULL);if(!c.isBoundTo(b))throw new l(a.USERIDTOKEN_MASTERTOKEN_MISMATCH,"uit mtserialnumber "+
c.mtSerialNumber+"; mt "+b.serialNumber);}return[]},removeServiceTokens:function(b,c,d){if(d&&c&&!d.isBoundTo(c))throw new l(a.USERIDTOKEN_MASTERTOKEN_MISMATCH,"uit mtserialnumber "+d.masterTokenSerialNumber+"; mt "+c.serialNumber);},clearServiceTokens:function(){}});var Ed=jd.extend({init:function e(){e.base.call(this);Object.defineProperties(this,{masterTokens:{value:{},writable:!1,enumerable:!1,configurable:!1},cryptoContexts:{value:{},writable:!1,enumerable:!1,configurable:!1},userIdTokens:{value:{},
writable:!1,enumerable:!1,configurable:!1},unboundServiceTokens:{value:{},writable:!1,enumerable:!1,configurable:!1},mtServiceTokens:{value:{},writable:!1,enumerable:!1,configurable:!1},uitServiceTokens:{value:{},writable:!1,enumerable:!1,configurable:!1}})},setCryptoContext:function(a,b){if(b){var c=a.uniqueKey();this.masterTokens[c]=a;this.cryptoContexts[c]=b}else this.removeCryptoContext(a)},getMasterToken:function(){var a=null,b;for(b in this.masterTokens){var c=this.masterTokens[b];if(!a||c.isNewerThan(a))a=
c}return a},getCryptoContext:function(a){return this.cryptoContexts[a.uniqueKey()]},removeCryptoContext:function(a){var b=a.uniqueKey();if(this.masterTokens[b]){delete this.masterTokens[b];delete this.cryptoContexts[b];for(var c in this.masterTokens)if(this.masterTokens[c].serialNumber==a.serialNumber)return;Object.keys(this.userIdTokens).forEach(function(b){b=this.userIdTokens[b];b.isBoundTo(a)&&this.removeUserIdToken(b)},this);try{this.removeServiceTokens(null,a,null)}catch(d){if(d instanceof l)throw new o("Unexpected exception while removing master token bound service tokens.",
d);throw d;}}},clearCryptoContexts:function(){[this.masterTokens,this.cryptoContexts,this.userIdTokens,this.uitServiceTokens,this.mtServiceTokens].forEach(function(a){for(var b in a)delete a[b]},this)},addUserIdToken:function(b,c){var d=!1,o;for(o in this.masterTokens)if(c.isBoundTo(this.masterTokens[o])){d=!0;break}if(!d)throw new l(a.USERIDTOKEN_MASTERTOKEN_NOT_FOUND,"uit mtserialnumber "+c.mtSerialNumber);this.userIdTokens[b]=c},getUserIdToken:function(a){return this.userIdTokens[a]},removeUserIdToken:function(a){var b=
null,c;for(c in this.masterTokens){var d=this.masterTokens[c];if(a.isBoundTo(d)){b=d;break}}Object.keys(this.userIdTokens).forEach(function(c){if(this.userIdTokens[c].equals(a)){delete this.userIdTokens[c];try{this.removeServiceTokens(null,b,a)}catch(d){if(d instanceof l)throw new o("Unexpected exception while removing user ID token bound service tokens.",d);throw d;}}},this)},clearUserIdTokens:function(){for(var a in this.userIdTokens){var b=this.userIdTokens[a];try{this.removeServiceTokens(null,
null,b)}catch(c){if(c instanceof l)throw new o("Unexpected exception while removing user ID token bound service tokens.",c);throw c;}delete this.userIdTokens[a]}},addServiceTokens:function(b){b.forEach(function(b){if(b.isUnbound())this.unboundServiceTokens[b.uniqueKey()]=b;else{if(b.isMasterTokenBound()){var c=!1,d;for(d in this.masterTokens)if(b.isBoundTo(this.masterTokens[d])){c=!0;break}if(!c)throw new l(a.SERVICETOKEN_MASTERTOKEN_NOT_FOUND,"st mtserialnumber "+b.mtSerialNumber);}if(b.isUserIdTokenBound()){var c=
!1,e;for(e in this.userIdTokens)if(b.isBoundTo(this.userIdTokens[e])){c=!0;break}if(!c)throw new l(a.SERVICETOKEN_USERIDTOKEN_NOT_FOUND,"st uitserialnumber "+b.uitSerialNumber);}b.isMasterTokenBound()&&((e=this.mtServiceTokens[b.mtSerialNumber])||(e={}),e[b.uniqueKey()]=b,this.mtServiceTokens[b.mtSerialNumber]=e);b.isUserIdTokenBound()&&((e=this.uitServiceTokens[b.uitSerialNumber])||(e={}),e[b.uniqueKey()]=b,this.uitServiceTokens[b.uitSerialNumber]=e)}},this)},getServiceTokens:function(b,c){if(c){if(!b)throw new l(a.USERIDTOKEN_MASTERTOKEN_NULL);
if(!c.isBoundTo(b))throw new l(a.USERIDTOKEN_MASTERTOKEN_MISMATCH,"uit mtserialnumber "+c.mtSerialNumber+"; mt "+b.serialNumber);}var d={},o;for(o in this.unboundServiceTokens){var k=this.unboundServiceTokens[o];d[k.uniqueKey()]=k}if(b&&(k=this.mtServiceTokens[b.serialNumber]))for(o in k){var f=k[o];f.isUserIdTokenBound()||(d[o]=f)}if(c&&(k=this.uitServiceTokens[c.serialNumber]))for(o in k)f=k[o],f.isBoundTo(b)&&(d[o]=f);k=[];for(o in d)k.push(d[o]);return k},removeServiceTokens:function(b,c,d){if(d&&
c&&!d.isBoundTo(c))throw new l(a.USERIDTOKEN_MASTERTOKEN_MISMATCH,"uit mtserialnumber "+d.mtSerialNumber+"; mt "+c.serialNumber);if(b&&!c&&!d){Object.keys(this.unboundServiceTokens).forEach(function(a){this.unboundServiceTokens[a].name==b&&delete this.unboundServiceTokens[a]},this);for(var o in this.mtServiceTokens){var k=this.mtServiceTokens[o],f=Object.keys(k);f.forEach(function(a){k[a].name==b&&delete k[a]},this);this.mtServiceTokens[o]=k}for(var u in this.uitServiceTokens)k=this.uitServiceTokens[u],
o=Object.keys(k),o.forEach(function(a){k[a].name==b&&delete k[a]},this),this.uitServiceTokens[u]=k}if(c&&!d){if(k=this.mtServiceTokens[c.serialNumber])f=Object.keys(k),f.forEach(function(a){var c=k[a];b&&c.name!=b||delete k[a]},this),this.mtServiceTokens[c.serialNumber]=k;for(u in this.uitServiceTokens){var s=this.uitServiceTokens[u];o=Object.keys(s);o.forEach(function(a){var d=s[a];!(b&&d.name!=b)&&d.isBoundTo(c)&&delete s[a]},this);this.uitServiceTokens[u]=s}}if(d&&(k=this.uitServiceTokens[d.serialNumber]))o=
Object.keys(k),o.forEach(function(a){var d=k[a];b&&d.name!=b||c&&!d.isBoundTo(c)||delete k[a]},this),this.uitServiceTokens[d.serialNumber]=k},clearServiceTokens:function(){[this.unboundServiceTokens,this.mtServiceTokens,this.uitServiceTokens].forEach(function(a){for(var b in a)delete a[b]},this)}});(function(a){"function"===typeof bootstrap?bootstrap("promise",a):"object"===typeof exports?module.exports=a():"function"===typeof define&&define.amd?define(a):"undefined"!==typeof ses?ses.ok()&&(ses.makeQ=
a):Q=a()})(function(){function a(b){return function(){return fa.apply(b,arguments)}}function b(a,d){if(T&&d.stack&&"object"===typeof a&&null!==a&&a.stack&&-1===a.stack.indexOf(aa)){for(var f=[],e=d;e;e=e.source)e.stack&&f.unshift(e.stack);f.unshift(a.stack);for(var f=f.join("\n"+aa+"\n").split("\n"),e=[],g=0;g<f.length;++g){var k=f[g],m;if(m=c(k)){var l=m[1];m=m[0]===R&&l>=P&&l<=ha}else m=!1;!m&&!(-1!==k.indexOf("(module.js:")||-1!==k.indexOf("(node.js:"))&&k&&e.push(k)}f=e.join("\n");a.stack=f}}
function c(a){var b=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(a);if(b||(b=/at ([^ ]+):(\d+):(?:\d+)$/.exec(a)))return[b[1],Number(b[2])];if(a=/.*@(.+):(\d+)$/.exec(a))return[a[1],Number(a[2])]}function d(){if(T)try{throw Error();}catch(a){var b=a.stack.split("\n"),b=0<b[0].indexOf("@")?b[1]:b[2];if(b=c(b))return R=b[0],b[1]}}function k(a,b,c){return function(){"undefined"!==typeof la&&"function"===typeof la.warn&&la.warn(b+" is deprecated, use "+c+" instead.",Error("").stack);return a.apply(a,arguments)}}
function f(a){return r(a)?a:x(a)?L(a):v(a)}function l(){function a(f){d=f;g.source=f;qa(b,function(a,b){O(function(){f.promiseDispatch.apply(f,b)})},void 0);c=b=void 0}var b=[],c=[],d,e=ea(l.prototype),g=ea(m.prototype);g.promiseDispatch=function(a,f,e){var g=V(arguments);b?(b.push(g),"when"===f&&e[1]&&c.push(e[1])):O(function(){d.promiseDispatch.apply(d,g)})};g.valueOf=k(function(){if(b)return g;var a=t(d);r(a)&&(d=a);return a},"valueOf","inspect");g.inspect=function(){return!d?{state:"pending"}:
d.inspect()};if(f.longStackSupport&&T)try{throw Error();}catch(h){g.stack=h.stack.substring(h.stack.indexOf("\n")+1)}e.promise=g;e.resolve=function(b){d||a(f(b))};e.fulfill=function(b){d||a(v(b))};e.reject=function(b){d||a(E(b))};e.notify=function(a){d||qa(c,function(b,c){O(function(){c(a)})},void 0)};return e}function o(a){if("function"!==typeof a)throw new TypeError("resolver must be a function.");var b=l();try{a(b.resolve,b.reject,b.notify)}catch(c){b.reject(c)}return b.promise}function m(a,b,
c){void 0===b&&(b=function(a){return E(Error("Promise does not support operation: "+a))});void 0===c&&(c=function(){return{state:"unknown"}});var d=ea(m.prototype);d.promiseDispatch=function(c,f,e){var g;try{g=a[f]?a[f].apply(d,e):b.call(d,f,e)}catch(h){g=E(h)}c&&c(g)};if(d.inspect=c){var f=c();"rejected"===f.state&&(d.exception=f.reason);d.valueOf=k(function(){var a=c();return"pending"===a.state||"rejected"===a.state?d:a.value})}return d}function s(a,b,c,d){return f(a).then(b,c,d)}function t(a){if(r(a)){var b=
a.inspect();if("fulfilled"===b.state)return b.value}return a}function r(a){return a===Object(a)&&"function"===typeof a.promiseDispatch&&"function"===typeof a.inspect}function x(a){return a===Object(a)&&"function"===typeof a.then}function B(){for(var a=0;a<W.length;a++)la.warn("Unhandled rejection reason:",W[a])}function A(){W.length=0;Y.length=0;da=!1;if(!$&&($=!0,"undefined"!==typeof process&&process.on))process.on("exit",B)}function C(a,b){$&&(Y.push(a),b&&"undefined"!==typeof b.stack?W.push(b.stack):
W.push("(no stack) "+b),!da&&"undefined"!==typeof window&&!window.Touch&&window.console&&la.warn("[Q] Unhandled rejection reasons (should be empty):",W),da=!0)}function E(a){var b=m({when:function(b){if(b&&$){var c=mb(Y,this);-1!==c&&(Y.splice(c,1),W.splice(c,1))}return b?b(a):this}},function(){return this},function(){return{state:"rejected",reason:a}});C(b,a);return b}function v(a){return m({when:function(){return a},get:function(b){return a[b]},set:function(b,c){a[b]=c},"delete":function(b){delete a[b]},
post:function(b,c){return null===b||void 0===b?a.apply(void 0,c):a[b].apply(a,c)},apply:function(b,c){return a.apply(b,c)},keys:function(){return X(a)}},void 0,function(){return{state:"fulfilled",value:a}})}function L(a){var b=l();O(function(){try{a.then(b.resolve,b.reject,b.notify)}catch(c){b.reject(c)}});return b.promise}function K(a,b,c){return f(a).spread(b,c)}function ca(a,b,c){return f(a).dispatch(b,c)}function J(a){return s(a,function(a){var b=0,c=l();qa(a,function(d,f,e){var g;r(f)&&"fulfilled"===
(g=f.inspect()).state?a[e]=g.value:(++b,s(f,function(d){a[e]=d;0===--b&&c.resolve(a)},c.reject,function(a){c.notify({index:e,value:a})}))},void 0);0===b&&c.resolve(a);return c.promise})}function ga(a){return s(a,function(a){a=na(a,f);return s(J(na(a,function(a){return s(a,S,S)})),function(){return a})})}var T=!1;try{throw Error();}catch(M){T=!!M.stack}var P=d(),R,S=function(){},O=function(){function a(){for(;b.next;){b=b.next;var c=b.task;b.task=void 0;var f=b.domain;f&&(b.domain=void 0,f.enter());
try{c()}catch(g){if(e)throw f&&f.exit(),ia(a,0),f&&f.enter(),g;ia(function(){throw g;},0)}f&&f.exit()}d=!1}var b={task:void 0,next:null},c=b,d=!1,f=void 0,e=!1;O=function(a){c=c.next={task:a,domain:e&&process.domain,next:null};d||(d=!0,f())};if("undefined"!==typeof process&&process.nextTick)e=!0,f=function(){process.nextTick(a)};else if("function"===typeof setImmediate)f="undefined"!==typeof window?setImmediate.bind(window,a):function(){setImmediate(a)};else if("undefined"!==typeof MessageChannel){var g=
new MessageChannel;g.port1.onmessage=function(){f=h;g.port1.onmessage=a;a()};var h=function(){g.port2.postMessage(0)},f=function(){ia(a,0);h()}}else f=function(){ia(a,0)};return O}(),fa=Function.call,V=a(Array.prototype.slice),qa=a(Array.prototype.reduce||function(a,b){var c=0,d=this.length;if(1===arguments.length){do{if(c in this){b=this[c++];break}if(++c>=d)throw new TypeError;}while(1)}for(;c<d;c++)c in this&&(b=a(b,this[c],c));return b}),mb=a(Array.prototype.indexOf||function(a){for(var b=0;b<
this.length;b++)if(this[b]===a)return b;return-1}),na=a(Array.prototype.map||function(a,b){var c=this,d=[];qa(c,function(f,e,g){d.push(a.call(b,e,g,c))},void 0);return d}),ea=Object.create||function(a){function b(){}b.prototype=a;return new b},lb=a(Object.prototype.hasOwnProperty),X=Object.keys||function(a){var b=[],c;for(c in a)lb(a,c)&&b.push(c);return b},nb=a(Object.prototype.toString),ac;ac="undefined"!==typeof ReturnValue?ReturnValue:function(a){this.value=a};var bc;try{new Function("(function* (){ yield 1; })"),
bc=!0}catch(Z){bc=!1}var aa="From previous event:";f.resolve=f;f.nextTick=O;f.longStackSupport=!1;f.defer=l;l.prototype.makeNodeResolver=function(){var a=this;return function(b,c){b?a.reject(b):2<arguments.length?a.resolve(V(arguments,1)):a.resolve(c)}};f.promise=o;f.passByCopy=function(a){return a};m.prototype.passByCopy=function(){return this};f.join=function(a,b){return f(a).join(b)};m.prototype.join=function(a){return f([this,a]).spread(function(a,b){if(a===b)return a;throw Error("Can't join: not the same: "+
a+" "+b);})};f.race=function(a){return o(function(b,c){for(var d=0,e=a.length;d<e;d++)f(a[d]).then(b,c)})};m.prototype.race=function(){return this.then(f.race)};f.makePromise=m;m.prototype.toString=function(){return"[object Promise]"};m.prototype.then=function(a,c,d){function e(b){try{return"function"===typeof a?a(b):b}catch(c){return E(c)}}function h(a){if("function"===typeof c){b(a,k);try{return c(a)}catch(d){return E(d)}}return E(a)}var k=this,m=l(),r=!1;O(function(){k.promiseDispatch(function(a){r||
(r=!0,m.resolve(e(a)))},"when",[function(a){r||(r=!0,m.resolve(h(a)))}])});k.promiseDispatch(void 0,"when",[void 0,function(a){var b,c=!1;try{b="function"===typeof d?d(a):a}catch(e){if(c=!0,f.onerror)f.onerror(e);else throw e;}c||m.notify(b)}]);return m.promise};f.when=s;m.prototype.thenResolve=function(a){return this.then(function(){return a})};f.thenResolve=function(a,b){return f(a).thenResolve(b)};m.prototype.thenReject=function(a){return this.then(function(){throw a;})};f.thenReject=function(a,
b){return f(a).thenReject(b)};f.nearer=t;f.isPromise=r;f.isPromiseAlike=x;f.isPending=function(a){return r(a)&&"pending"===a.inspect().state};m.prototype.isPending=function(){return"pending"===this.inspect().state};f.isFulfilled=function(a){return!r(a)||"fulfilled"===a.inspect().state};m.prototype.isFulfilled=function(){return"fulfilled"===this.inspect().state};f.isRejected=function(a){return r(a)&&"rejected"===a.inspect().state};m.prototype.isRejected=function(){return"rejected"===this.inspect().state};
var W=[],Y=[],da=!1,$=!0;f.resetUnhandledRejections=A;f.getUnhandledReasons=function(){return W.slice()};f.stopUnhandledRejectionTracking=function(){A();"undefined"!==typeof process&&process.on&&process.removeListener("exit",B);$=!1};A();f.reject=E;f.fulfill=v;f.master=function(a){return m({isDef:function(){}},function(b,c){return ca(a,b,c)},function(){return f(a).inspect()})};f.spread=K;m.prototype.spread=function(a,b){return this.all().then(function(b){return a.apply(void 0,b)},b)};f.async=function(a){return function(){function b(a,
e){var g;if(bc){try{g=c[a](e)}catch(h){return E(h)}return g.done?g.value:s(g.value,d,f)}try{g=c[a](e)}catch(k){return"[object StopIteration]"===nb(k)||k instanceof ac?k.value:E(k)}return s(g,d,f)}var c=a.apply(this,arguments),d=b.bind(b,"next"),f=b.bind(b,"throw");return d()}};f.spawn=function(a){f.done(f.async(a)())};f["return"]=function(a){throw new ac(a);};f.promised=function(a){return function(){return K([this,J(arguments)],function(b,c){return a.apply(b,c)})}};f.dispatch=ca;m.prototype.dispatch=
function(a,b){var c=this,d=l();O(function(){c.promiseDispatch(d.resolve,a,b)});return d.promise};f.get=function(a,b){return f(a).dispatch("get",[b])};m.prototype.get=function(a){return this.dispatch("get",[a])};f.set=function(a,b,c){return f(a).dispatch("set",[b,c])};m.prototype.set=function(a,b){return this.dispatch("set",[a,b])};f.del=f["delete"]=function(a,b){return f(a).dispatch("delete",[b])};m.prototype.del=m.prototype["delete"]=function(a){return this.dispatch("delete",[a])};f.mapply=f.post=
function(a,b,c){return f(a).dispatch("post",[b,c])};m.prototype.mapply=m.prototype.post=function(a,b){return this.dispatch("post",[a,b])};f.send=f.mcall=f.invoke=function(a,b){return f(a).dispatch("post",[b,V(arguments,2)])};m.prototype.send=m.prototype.mcall=m.prototype.invoke=function(a){return this.dispatch("post",[a,V(arguments,1)])};f.fapply=function(a,b){return f(a).dispatch("apply",[void 0,b])};m.prototype.fapply=function(a){return this.dispatch("apply",[void 0,a])};f["try"]=f.fcall=function(a){return f(a).dispatch("apply",
[void 0,V(arguments,1)])};m.prototype.fcall=function(){return this.dispatch("apply",[void 0,V(arguments)])};f.fbind=function(a){var b=f(a),c=V(arguments,1);return function(){return b.dispatch("apply",[this,c.concat(V(arguments))])}};m.prototype.fbind=function(){var a=this,b=V(arguments);return function(){return a.dispatch("apply",[this,b.concat(V(arguments))])}};f.keys=function(a){return f(a).dispatch("keys",[])};m.prototype.keys=function(){return this.dispatch("keys",[])};f.all=J;m.prototype.all=
function(){return J(this)};f.allResolved=k(ga,"allResolved","allSettled");m.prototype.allResolved=function(){return ga(this)};f.allSettled=function(a){return f(a).allSettled()};m.prototype.allSettled=function(){return this.then(function(a){return J(na(a,function(a){function b(){return a.inspect()}a=f(a);return a.then(b,b)}))})};f.fail=f["catch"]=function(a,b){return f(a).then(void 0,b)};m.prototype.fail=m.prototype["catch"]=function(a){return this.then(void 0,a)};f.progress=function(a,b){return f(a).then(void 0,
void 0,b)};m.prototype.progress=function(a){return this.then(void 0,void 0,a)};f.fin=f["finally"]=function(a,b){return f(a)["finally"](b)};m.prototype.fin=m.prototype["finally"]=function(a){a=f(a);return this.then(function(b){return a.fcall().then(function(){return b})},function(b){return a.fcall().then(function(){throw b;})})};f.done=function(a,b,c,d){return f(a).done(b,c,d)};m.prototype.done=function(a,c,d){var e=function(a){O(function(){b(a,h);if(f.onerror)f.onerror(a);else throw a;})},h=a||c||
d?this.then(a,c,d):this;"object"===typeof process&&process&&process.domain&&(e=process.domain.bind(e));h.then(void 0,e)};f.timeout=function(a,b,c){return f(a).timeout(b,c)};m.prototype.timeout=function(a,b){var c=l(),d=ia(function(){c.reject(Error(b||"Timed out after "+a+" ms"))},a);this.then(function(a){cb(d);c.resolve(a)},function(a){cb(d);c.reject(a)},c.notify);return c.promise};f.delay=function(a,b){void 0===b&&(b=a,a=void 0);return f(a).delay(b)};m.prototype.delay=function(a){return this.then(function(b){var c=
l();ia(function(){c.resolve(b)},a);return c.promise})};f.nfapply=function(a,b){return f(a).nfapply(b)};m.prototype.nfapply=function(a){var b=l(),a=V(a);a.push(b.makeNodeResolver());this.fapply(a).fail(b.reject);return b.promise};f.nfcall=function(a){var b=V(arguments,1);return f(a).nfapply(b)};m.prototype.nfcall=function(){var a=V(arguments),b=l();a.push(b.makeNodeResolver());this.fapply(a).fail(b.reject);return b.promise};f.nfbind=f.denodeify=function(a){var b=V(arguments,1);return function(){var c=
b.concat(V(arguments)),d=l();c.push(d.makeNodeResolver());f(a).fapply(c).fail(d.reject);return d.promise}};m.prototype.nfbind=m.prototype.denodeify=function(){var a=V(arguments);a.unshift(this);return f.denodeify.apply(void 0,a)};f.nbind=function(a,b){var c=V(arguments,2);return function(){var d=c.concat(V(arguments)),e=l();d.push(e.makeNodeResolver());f(function(){return a.apply(b,arguments)}).fapply(d).fail(e.reject);return e.promise}};m.prototype.nbind=function(){var a=V(arguments,0);a.unshift(this);
return f.nbind.apply(void 0,a)};f.nmapply=f.npost=function(a,b,c){return f(a).npost(b,c)};m.prototype.nmapply=m.prototype.npost=function(a,b){var c=V(b||[]),d=l();c.push(d.makeNodeResolver());this.dispatch("post",[a,c]).fail(d.reject);return d.promise};f.nsend=f.nmcall=f.ninvoke=function(a,b){var c=V(arguments,2),d=l();c.push(d.makeNodeResolver());f(a).dispatch("post",[b,c]).fail(d.reject);return d.promise};m.prototype.nsend=m.prototype.nmcall=m.prototype.ninvoke=function(a){var b=V(arguments,1),
c=l();b.push(c.makeNodeResolver());this.dispatch("post",[a,b]).fail(c.reject);return c.promise};f.nodeify=function(a,b){return f(a).nodeify(b)};m.prototype.nodeify=function(a){if(a)this.then(function(b){O(function(){a(null,b)})},function(b){O(function(){a(b)})});else return this};var ha=d();return f});(function(){function a(b){return b.map(function(a){var b=a[0],a=a[1],c=nrdp.mono();la.log('STARTING HOOK "'+b+'"');return Q(a()).then(function(){la.log('FINISHED HOOK "'+b+'" ('+(nrdp.mono()-c)+"ms)")},
function(a){la.log('HOOK "'+b+'"" FAILED : '+a+"\n"+a.stack);throw a;})})}function b(g){la.log("GOT INIT, WE HAS "+c.length+" HOOK(S) TO RUN");nrdp.js.options=nrdp.options.js_opts.split(",").reduce(function(a,b){var c=b.split("="),d=c.shift(),c=c.join("=")||!0;d.length&&("true"===c?c=!0:"false"===c&&(c=!1),a[d]=c);return a},{});Sa=nrdp.debug||nrdp.js.options.debug;Q(a(c)).all().then(function(b){la.log("EXECUTED "+b.length+" HOOK(S), FORWARDING INIT");nrdp.nrdjs&&la.warn("NRDJS version "+nrdp.nrdjs+
" loaded.");c=void 0;nrdp.js.init=function(a){a&&a()};g&&g();la.log("RUNNING POST INIT HOOKS");Q(a(d)).all().fin(function(){la.log("FINISHED RUNNING POST INIT HOOKS");d=void 0})},function(a){var b={ERROR_CATEGORY:"AppBoot",ERROR_FRAME_URL:nrdp.gibbon.location,ERROR_ACTIONID:"",ERROR_STAGE:2},c="http://localcontrol.netflix.com/js/error.js",d="?",e,g;for(e in b)g=b[e],"string"===typeof g&&(g=g.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/"/g,'\\"')),c+=d+e+"="+encodeURIComponent(g),d="&";la.error("Something went very wrong running NRDJS init hooks : "+
a.toString());nrdp.gibbon.location=c}).done()}var c=[],d=[];nrdp.js.init=b;nrdp.js.addInitHook=function(a,b){if(!c)throw Error("Cannot add init hooks after they have run");c.push([a,b]);la.log('ADDED HOOK "'+a+'", HAS '+c.length)};nrdp.js.addPostInitHook=function(a,b){if(!d)throw Error("Cannot run post init hooks after they have run");d.push([a,b]);la.log('ADDED POST INIT HOOK "'+a+'", HAS '+d.length)};nrdp.hookInit(b)})();Ra.prototype=Error();Ra.prototype.constructor=Ra;var kd;(function(){function c(a){var b=
Q.defer();a.oncomplete=b.resolve;a.onerror=function(a){b.reject(a.error)};return b.promise}function d(a){var b=Q.defer();return{result:void 0===a?b.resolve:function(c){b.resolve([c,a])},error:b.reject,timeout:function(){b.reject(new Ra)},deferred:b,promise:b.promise}}function h(a){return!a?"null":""+a.sequenceNumber+":"+a.serialNumber+":"+a.expiration.toISOString()+":"+a.renewalWindow.toISOString()}function o(a){return!a?"null":""+a.serialNumber+":"+a.mtSerialNumber+":"+a.expiration.toISOString()+
":"+a.renewalWindow.toISOString()}function k(b){function k(a,b,c,d,e){var g=[];c&&(g=c.slice(0));if(d&&(c=d.getMslStore(),d=c.getMasterToken()))if(g=g.concat(c.getServiceTokens(d,null)),e&&(e=e.getUserId()))(e=c.getUserIdToken(e))&&(g=g.concat(c.getServiceTokens(d,e)));0==g.length?f.trace("No "+a+" service tokens for request ("+b.n+")"):g.forEach(function(c,d){c?(f.trace(a+" service token "+d+" for request ("+b.n+") : "+c.name),f.dump(c.toJSON())):f.error("st is undefined, wtf.")})}var m=!1,s=!1,
t=!1,r=1,x=Ed.extend({init:function ja(a){ja.base.call(this);this._deviceIdentity=a},setCryptoContext:function ca(a,b){function c(a){return!a?"<null>":a.sequenceNumber+":"+a.serialNumber+":"+a.expiration.getTime()}var d=this.getMasterToken();ca.base.call(this,a,b);this.markDirty("setCryptoContext ["+c(d)+" TO "+c(a)+"]")},removeCryptoContext:function J(a){J.base.call(this,a);this.markDirty("removeCryptoContext")},clearCryptoContexts:function ga(){ga.base.call(this);this.markDirty("clearCryptoContexts")},
addUserIdToken:function T(a,b){T.base.call(this,a,b);this.markDirty("addUserIdToken")},removeUserIdToken:function pa(a){pa.base.call(this,a);this.markDirty("removeUserIdToken")},clearUserIdTokens:function sd(){sd.base.call(this);this.markDirty("clearUserIdTokens")},addServiceTokens:function rd(a){var b={"streaming.servicetokens.movie":!0,"streaming.servicetokens.license":!0},a=a.filter(function(a){return a&&!b[a.name]});0<a.length&&rd.base.call(this,a)},removeServiceTokens:function va(a,b,c){va.base.call(this,
a,b,c)},clearServiceTokens:function O(){O.base.call(this)},setNpTicket:function(a){if(a)this._npTicketWCKey=a;else{if(!this._npTicketWCKey)return;delete this._npTicketWCKey}this.markDirty("setNpTicket")},getNpTicket:function(){return this._npTicketWCKey},markDirty:function(a){this._loading||(f.log("MslStore dirty ("+a+")"),this._dirty=!0)},load:function(a){var b=this,h,k;return Q["try"](function(){h=nrdp.storage.getItem(nrdp.storage.NO_DEVICE_ACCOUNT,"mslstore");f.log("Attempting to load MslStore");
if(h)if(k=JSON.parse(h),f.log("Loaded MslStore"),t&&f.dump(k),k.di!==b._deviceIdentity)f.warn("MslStore is for a different device: "+k.di),nrdp.storage.removeItem(nrdp.storage.NO_DEVICE_ACCOUNT,"mslstore");else return Q["try"](function(){var c=k.mt,f;b._loading=!0;if(!c)throw Error("No master token found");f=d();Ma(a,c,f);return f.promise}).then(function(f){switch(k.cc){case "symmetric":return Q([k.ek,k.hk].map(function(a){return c(Y.getKeyInfo(a))})).all().then(function(a){return a.map(function(a){var b=
d();Ua(a.target.result,b);return b.promise})}).all().spread(function(c,d){var e=new oa(a,f,b._deviceIdentity,c,d);b.setCryptoContext(f,e)}).thenResolve(f);default:throw Error("Unable to load crypto context");}}).then(function(c){var e=k.uit;if(e)return f.log("Parsing user id tokens"),Q["try"](function(){return e.map(function(b){var f=d(b.id);Ya(a,b.t,c,f);return f.promise})}).all().then(function(a){a.forEach(function(a){b.addUserIdToken(a[1],a[0])})})}).then(function(){var a=k.npk;if(a)return f.log("Loading NP Ticket..."),
c(Y.getKeyInfo(a)).then(function(a){(a=a.target.result)&&b.setNpTicket(a)})}).then(function(){f.log("Finished loading MslStore");b._lastSaved||(b._lastSaved=h)}).fin(function(){delete b._dirty;delete b._loading});else f.warn("No MslStore to load")}).fail(function(a){f.warn("Failed to load MslStore : "+a);nrdp.storage.removeItem(nrdp.storage.NO_DEVICE_ACCOUNT,"mslstore")}).thenResolve()},save:function(a){var b=this,c=b.getMasterToken(),d,e=[],g,h=b._lastSaved;if(this._dirty){delete this._dirty;f.log("Saving MslStore..."+
(a?"("+a+")":""));if(c){g={};g.di=b._deviceIdentity;g.mt=c.toJSON();d=[];Object.keys(b.userIdTokens).forEach(function(a){var f=b.getUserIdToken(a);f.isBoundTo(c)&&d.push({id:a,t:f.toJSON()})});g.uit=d;if(a=b.getCryptoContext(c))a instanceof fb?([a.encryptionKey,a.hmacKey].forEach(function(a){a&&e.push(a)}),g.cc="symmetric",g.ek=a.encryptionKey.handle,g.hk=a.hmacKey.handle):f.error("NrdpMslStore does not know how to persist this kind of CryptoContext");this._npTicketWCKey&&(e.push(this._npTicketWCKey),
g.npk=this._npTicketWCKey.handle)}if(g){a=JSON.stringify(g);if(h&&h===a){f.log("Already saved this, skipping it");return}t&&(f.trace("This is what I will save:"),f.dump(g));nrdp.storage.setItem(nrdp.storage.NO_DEVICE_ACCOUNT,"mslstore",a);b._lastSaved=a;f.log("Finished saving MslStore")}else nrdp.storage.removeItem(nrdp.storage.NO_DEVICE_ACCOUNT,"mslstore"),delete b._lastSaved;nrdp.webcrypto.persistKeys(e,function(a){a.success?f.log("Finished persisting MslStore keys"):f.warn("Failed to persist MslStore keys")})}}}),
B=Dd.extend({init:function(a){this._client=a;this._entityAuthFactories={};this._keyRequestData=[];this._keyExchangeFactories=[];this._mslCryptoContext=new td;this._deviceIdentity=b.msl.unauth&&"string"===typeof b.msl.unauth?b.msl.unauth:nrdp.device.ESN;f.warn("ESN: "+this._deviceIdentity);this._store=new x(this._deviceIdentity);this._random=new kc},_generateNPTicket:function(){var a=this;f.log("Creating NP-Ticket");return c(Y.generateKey({name:"RSASSA-PKCS1-v1_5",params:{npticket:!0}},!0)).then(function(b){var c=
b.target.result.privateKey;f.log("Created NP-Ticket: "+JSON.stringify(b));if(c.algorithm.npTicketFake&&(b=a.getMslStore().getNpTicket())&&!b.algorithm.npTicketFake){var d=1E3*b.algorithm.npTicketExpiration,e=nrdp.now();if(d>e){f.log("Tried to get a new NP-Ticket, but got a fake one, and the old one was real and isn't expired yet, so I'm keeping it");a._entityAuthData||(a._entityAuthData=new Xa(a._deviceIdentity,b));return}}a.getMslStore().setNpTicket(c);a._entityAuthData=new Xa(a._deviceIdentity,
c)})},prepare:function(){var a=this;f.info("Preparing MslContext...");return Q(a._store.load(a)).then(function(){var c,e;f.info("Server entity auth keys...");if(b.msl.verifyServer){try{c=nrdp.storage.transientData.appboot.msltruststore.keys,e=Object.getOwnPropertyNames(c).map(function(a){return{identity:a,type:"downloaded",op:Y.importKey("spki",c[a],Gb,!1,["verify"])}})}catch(h){e=nrdp.js.options.appboot_key?[{identity:"APPBOOT",type:"overridden",op:Y.importKey("spki",nrdp.js.options.appboot_key,
Gb,!1,["verify"])}]:[{identity:"APPBOOT",type:"baked in",op:Y.getKeyByName("ABKP")}]}return Q.all(e.map(function(a){var b=a.op,c=Q.defer();f.info("Importing "+a.type+" key for "+a.identity);b.onerror=function(a){c.reject(a.error)};b.oncomplete=function(b){c.resolve({identity:a.identity,key:b.target.result})};return c.promise})).then(function(a){return Q.all(a.map(function(a){var b=d();f.info("Creating MSL PublicKey for "+a.identity);b.result=function(c){b.deferred.resolve({identity:a.identity,key:c})};
Va(a.key,b);return b.promise}))}).then(function(b){var c=new wd;b.forEach(function(a){f.info("Adding key to RSA store "+a.identity);c.addPublicKey(a.identity,a.key)});a._entityAuthFactories[R.RSA]=new xc(c)})["catch"](function(a){f.error("Failed to set-up server entity auth keys : "+a.toString())})}e=xc.extend({getCryptoContext:function(){this._cryptoContext||(this._cryptoContext=new Ka);return this._cryptoContext}});f.warn("Added NULL RSA auth factory because we are not verifying the server");a._entityAuthFactories[R.RSA]=
new e}).then(function(){switch(b.msl.unauth?"UNKNOWN":nrdp.webcrypto.authenticationType){case "PSK":return f.info("Device authentication using PSK"),Q["try"](function(){return["DKE","DKH","DKW"].map(function(a){return c(Y.getKeyByName(a))})}).all().then(function(a){return a.map(function(a){var b,a=a.target.result;if(null===a)throw Error("Failed to get device key by name");b=d();Ua(a,b);return b.promise})}).spread(function(b,c,d){var e=wc.extend({init:function lb(a,b,c,d){lb.base.call(this,a);Object.defineProperties(this,
{_kpe:{value:b,writable:!1,enumerable:!1,configurable:!1},_kph:{value:c,writable:!1,enumerable:!1,configurable:!1},_kpw:{value:d,writable:!1,enumerable:!1,configurable:!1}})},getCryptoContext:function $b(a,b){return b instanceof Fa&&this.localIdentity==b.identity?new fb(a,this.localIdentity,this._kpe,this._kph,this._kpw):$b.base.call(this,a,b)}});f.info("Created PSK auth factory");a._entityAuthFactories[R.PSK]=new e(a._deviceIdentity,b,c,d);a._entityAuthData=new Fa(a._deviceIdentity);nrdp.js.options.swex?
(f.info("Using symmetric wrapped exchange"),a._keyRequestData.push(new yb(R.PSK)),a._keyExchangeFactories.push(new Sb)):(f.info("Using JWE ladder exchange"),b=Ub.extend({init:function nb(){nb.base.call(this);Object.defineProperties(this,{_contextMap:{value:{},writable:!1,enumerable:!1,configurable:!1}})},addCryptoContext:function(a,b){b&&a&&a.length&&(this._contextMap[C(a)]=b)},getCryptoContext:function(a){return a&&a.length?this._contextMap[C(a)]||null:null},removeCryptoContext:function(a){a&&a.length&&
delete this._contextMap[C(a)]}}),a._keyExchangeFactories.push(new Tb(new b)),a._keyRequestData.push(new zb(R.PSK)))});case "MGK":return f.info("Device authentication using MGK"),Q["try"](function(){return["DKE","DKH","DKW"].map(function(a){return c(Y.getKeyByName(a))})}).all().then(function(a){return a.map(function(a){var b,a=a.target.result;if(null===a)throw Error("Failed to get device key by name");b=d();Ua(a,b);return b.promise})}).spread(function(b,c,d){var e=ud.extend({init:function lb(a,b,c,
d){lb.base.call(this,a);Object.defineProperties(this,{_kde:{value:b,writable:!1,enumerable:!1,configurable:!1},_kdh:{value:c,writable:!1,enumerable:!1,configurable:!1},_kdw:{value:d,writable:!1,enumerable:!1,configurable:!1}})},getCryptoContext:function $b(a,b){return b instanceof Ga&&this.localIdentity==b.identity?new fb(a,this.localIdentity,this._kde,this._kdh,this._kdw):$b.base.call(this,a,b)}});f.info("Created MGK auth factory");a._entityAuthFactories[R.MGK]=new e(a._deviceIdentity,b,c,d);a._entityAuthData=
new Ga(a._deviceIdentity);nrdp.js.options.swex?(f.info("Using symmetric wrapped exchange"),a._keyRequestData.push(new yb(R.MGK)),a._keyExchangeFactories.push(new Sb)):(f.info("Using JWE ladder exchange"),b=Ub.extend({init:function nb(){nb.base.call(this);Object.defineProperties(this,{_contextMap:{value:{},writable:!1,enumerable:!1,configurable:!1}})},addCryptoContext:function(a,b){b&&a&&a.length&&(this._contextMap[C(a)]=b)},getCryptoContext:function(a){return a&&a.length?this._contextMap[C(a)]||null:
null},removeCryptoContext:function(a){a&&a.length&&delete this._contextMap[C(a)]}}),a._keyExchangeFactories.push(new Tb(new b)),a._keyRequestData.push(new zb(R.MGK)))});case "npticket":return f.info("Device authentication using NP-Ticket"),Q["try"](function(){var b=a.getMslStore().getNpTicket(),c,d,e;if(b)if(f.info("Checking saved NP-Ticket"),e=nrdp.now(),c=1E3*b.algorithm.npTicketIssue,d=1E3*b.algorithm.npTicketExpiration,c+nrdp.js.options.npticket_interval<e)f.warn("NP-Ticket was issued more than 4 hours ago : issued="+
c+"ms, now="+e+"ms, expiration="+d+"ms");else if(d<=e)f.warn("NP-Ticket is expired : issued="+c+"ms, now="+e+"ms, expiration="+d+"ms");else{f.info("Saved NP-Ticket seems good");a._entityAuthData=new Xa(a._deviceIdentity,b);return}else f.info("No saved NP-Ticket, making a new one");return a._generateNPTicket()}).then(function(){a._entityAuthFactories[R.NPTICKET]=new vd;a._keyExchangeFactories.push(new Qb);f.info("Generating AsymmetricWrappedExchange keys for key request data");var b={name:"RSA-OAEP",
params:{modulusLength:1024,publicExponent:new Uint8Array([1,0,1])}};return c(Y.generateKey(b,!0))}).then(function(a){var b=d(),c=d();eb(a.target.result.privateKey,b);Va(a.target.result.publicKey,c);return[b.promise,c.promise]}).spread(function(b,c){a._keyRequestData.push(new xb("rsaKeypairId",Rb.JWE_RSA,c,b))});case "UNKNOWN":var h={name:"RSA-OAEP",params:{modulusLength:1024,publicExponent:new Uint8Array([1,0,1])}};f.warn("Using unauthenticated auth factory - NOT using device keys");a._entityAuthFactories[R.NONE]=
new xd;a._entityAuthData=new gb(a._deviceIdentity);a._keyExchangeFactories.push(new Qb);f.info("Generating AsymmetricWrappedExchange keys for key request data");return c(Y.generateKey(h,!0)).then(function(a){var b=d(),c=d();eb(a.target.result.privateKey,b);Va(a.target.result.publicKey,c);return[b.promise,c.promise]}).spread(function(b,c){a._keyRequestData.push(new xb("rsaKeypairId",Rb.JWE_RSA,c,b))});default:throw Error('Unrecognized authentication type "'+nrdp.webcrypto.authenticationType+'" from nrdp.webcrypto.authenticationType');
}})},getTime:function(){return clock$getTime()},getRandom:function(){return this._random},isPeerToPeer:function(){return!1},getMessageCapabilities:function(){var a=[],c=[];nrdp.registration&&(c=nrdp.registration.UILanguages);c=c.concat(nrdp.device.language);b.msl.useLzw&&a.push(Ab.LZW);b.msl.useGzip&&a.push(Ab.GZIP);return new kb(a,c)},getEntityAuthenticationData:function(a,b){var c=this;Q["try"](function(){if(a&&(f.log("Entity re-auth"),"npticket"==nrdp.webcrypto.authenticationType))return c._generateNPTicket()}).then(function(){b.result(c._entityAuthData)},
function(a){b.error(a)}).done()},getMslCryptoContext:function(){return this._mslCryptoContext},getEntityAuthenticationFactory:function(a){return this._entityAuthFactories[a]},getUserAuthenticationFactory:function(){return null},getTokenFactory:function(){return null},getKeyExchangeFactory:function(a){return this.getKeyExchangeFactories().filter(function(b){return b.scheme==a})[0]},getKeyExchangeFactories:function(){return this._keyExchangeFactories},getMslStore:function(){return this._store},getKeyRequestData:function(){return this._keyRequestData}}),
A=Cd.extend({init:function(a){this._requestInfo=a},traceRequestHeader:function(a){try{var b=a.masterToken,c=a.userIdToken,d,e,g,k="-> ["+this._requestInfo.n+"."+ ++this._requestInfo.r+"] "+this._requestInfo.url,k=k+(" mid="+a.messageId+" mt="+h(b)),k=k+(" nrp="+!!a.nonReplayable+" ren="+!!a.renewable),k=k+(" uit="+o(c));if(d=a.userAuthenticationData)k+=" uad="+d.scheme;if((e=a.serviceTokens)&&e.length)k+=" st=[",e.forEach(function(a,b){b&&(k+=",");k+=a.uniqueKey()}),k+="]";if((g=a.keyRequestData)&&
g.length)k+=" krd=[",g.forEach(function(a,b){b&&(k+=",");k+=a.keyExchangeScheme}),k+="]";f.log(k)}catch(l){}},traceResponseHeader:function(a){try{var b,c,d,e,g="<- ["+this._requestInfo.n+"."+this._requestInfo.r+"] "+this._requestInfo.url;if(a instanceof Na)g+=" mid="+a.messageId+" error="+a.internalCode+" ["+a.errorCode+"] "+a.errorMessage;else if(a instanceof Ja){b=a.masterToken;c=a.userIdToken;g+=" mid="+a.messageId+" mt="+h(b);g+=" nrp="+!!a.nonReplayable+" ren="+!!a.renewable;g+=" uit="+o(c);
if((d=a.serviceTokens)&&d.length)g+=" st=[",d.forEach(function(a,b){b&&(g+=",");g+=a.uniqueKey()}),g+="]";if(e=a.keyResponseData)b=e.masterToken,g+=" krd-mt="+h(b)}f.log(g)}catch(k){}}}),U=$c.extend({init:function(a,b,c,d,f,e,g,h){var k=null,l,m=nrdp.registration;f=void 0===f||null===f?!0:!!f;e=void 0===e||null==e?!0:!!e;g=!!g;if(m)if(void 0===c){if(l=m.activationTokens,m.registered||l&&(l.NetflixId&&l.SecureNetflixId||l.email&&l.password||l.ssoService&&l.ssoToken))k={id:m.currentDeviceAccount,tokens:l}}else l=
m.deviceAccounts.filter(function(a){return a.accountKey==c}).reduce(function(a,b){return b.tokens},void 0),k={id:c,tokens:l};Object.defineProperties(this,{_client:{value:a,writable:!1},_account:{value:k,writable:!1},_payload:{value:d,writable:!1},_encrypted:{value:f,writable:!1},_replayable:{value:e,writable:!1},_requestingTokens:{value:g,writable:!1},_serviceTokens:{value:h,writable:!1},_requestInfo:{value:b,writable:!1}})},getCryptoContexts:function(){this._cryptoContexts||(this._cryptoContexts=
{});return this._cryptoContexts},isEncrypted:function(){return this._encrypted},isNonReplayable:function(){return!this._replayable},isRequestingTokens:function(){return this._requestingTokens},getUserId:function(){if(this._account)return this._account.id;f.log("No account associated with this request");return null},getUserAuthData:function(a,b,c,d){var b=null,e=this._account,g,h;e?a?f.error("Asked to reauth user auth data, need to log in again"):!c&&this._client.getUserIdToken(e.id,!0)?f.log("Already have a user id token for "+
e.id+" and this is not a reauth - will not send auth data"):(a=e.tokens)?a.ssoService&&a.ssoToken?("xboxsaml"==a.ssoService.toLowerCase()&&(h=gd.MICROSOFT_SAML,f.log("Will use XBox SAML SSO user auth data")),h&&(a.email&&a.password?(f.log("Including SSO email/password user auth data for "+e.id),g=new hd(a.email,a.password)):a.NetflixId&&a.SecureNetflixId&&(f.log("Including SSO netflix id user auth data for "+e.id),g=new id(a.NetflixId,a.SecureNetflixId)),b=new sb(h,a.ssoToken,g))):a.email&&a.password?
(f.log("Including email/password user auth data for "+e.id),b=new pb(a.email,a.password)):a.NetflixId&&a.SecureNetflixId&&(f.log("Including netflix id user auth data for "+e.id),b=new rb(a.NetflixId,a.SecureNetflixId)):f.log("User id "+e.id+" does not have email/password or netflix"):f.log("No account associated with this request");d.result(b)},getCustomer:function(){return null},getKeyRequestData:function(a){a.result(this._client.getKeyRequestData())},updateServiceTokens:function(a,b){var c=!0;this._serviceTokens&&
this._serviceTokens.forEach(function(b){b?(f.log("Adding service token to outbound message : "+b.name),c=c&&a.addPrimaryServiceToken(b)):f.error(">>> MSL message has NULL service token <<<")});c?b.result(!0):b.result(Error("Failed to update all service tokens"))},write:function(a,c,e){Q["try"](function(){var e;if(!b.msl.useLzw&&!b.msl.useGzip)return e=d(),f.trace("Configuring output stream without compression"),a.setCompressionAlgorithm(null,c,e),e.promise}).thenResolve(this._payload).then(function(b){var f,
e=d();"object"==typeof b&&b.constructor==Uint8Array||(b=Jb(b));f=b.length;a.write(b,0,f,c,e);return e.promise.then(function(b){var e=d();if(b!==f)throw new Z("Message context did not write all bytes");a.close(c,e);return e.promise})}).then(function(){e.result(!0)}).fail(function(a){f.error("Exception writing : "+a);a instanceof Ra?e.timeout():e.error(a)}).done()},getDebugContext:function(){return Sa?new A(this._requestInfo):null}}),E=Z.extend({init:function fa(a,b){this.mesg=a;this.url=b.url;this.errorCode=
b.errorcode;this.errorGroup=b.errorgroup;this.finalUrl=b.finalURL;this.serverIp=b.serverIp;this.httpCode=b.statusCode;nrdp.log.trace("in Init: NrdpIoException "+JSON.stringify(b));fa.base.call(this,a)}}),v=Ad.extend({init:function(a,b){this._url=a;this._info=b},getResponse:function(a,b,c){var d=this,e=nrdp.gibbon,g=this._url,b={url:g,headers:{"X-Gibbon-Cache-Control":"no-cache","X-AllowCompression":"true"},body:a.body,async:!0,secure:!0,timeout:b||void 0,connectTimeout:b/2||void 0,stallTimeout:b||
void 0,format:"uint8array"},h,k=nrdp.mono(),l=a.body.length;f.log("  Making HTTP request ("+d._info.n+") request body is "+a.body.length+" bytes "+g);m&&f.dump(b);h=e.load(b,function(a){var b={};b.dt=a.dnsTime||0;b.ct=a.connectTime||0;b.tt=a.transactionTime||0;b.du=a.duration||0;b.serverIp=a.serverIp;d._info.networkTime=nrdp.mono()-k;d._info.netStats=b;m&&f.dump(a);f.log("  HTTP took "+d._info.networkTime+" ms ("+l+","+a.size+" bytes) ["+b.dt+","+b.ct+","+b.tt+"="+b.du+" ("+(d._info.networkTime-b.du)+
")] for request ("+d._info.n+") "+g);try{switch(a.reason){case e.SUCCESS:if(200==a.statusCode){b={};"object"===typeof a.data&&a.data.constructor==Uint8Array?b.content=a.data:b.body=a.data||"";c.result(b);break}throw new E("HTTP status code "+a.statusCode,a);case e.TIMEOUTERROR:throw new E("TIMED_OUT_ERROR",a);case e.NOTSECUREERROR:throw new E("NOT_SECURE_ERROR",a);case e.FILEACCESSERROR:throw new E("FILE_ACCESS_ERROR",a);case e.DATAURIERROR:throw new E("DATA_URI_ERROR",a);case e.DNS_ERROR:throw new E("DNS_ERROR",
a);case e.CONNECT_ERROR:throw new E("CONNECT_ERROR",a);case e.SSLHANDSHAKEERROR:throw new E("SSL_HANDSHAKE_ERROR",a);case e.SSLCACERTERROR:throw new E("SSL_CA_CERT_ERROR",a);case e.SSLCACERTFILEERROR:throw new E("SSL_CA_CERT_FILE_ERROR",a);case e.CERTSTATUSSSLERROR:throw new E("CERT_STATUS_ERROR",a);case e.CERTSTATUSREVOKED:throw new E("CERT_REVOKED_ERROR",a);case e.CERTSTATUSPEWREVOKED:throw new E("CERT_PEW_REVOKED_ERROR",a);case e.SENDERROR:throw new E("SEND_ERROR",a);case e.RECVERROR:throw new E("RECV_ERROR",
a);case e.COMPRESSIONERROR:throw new E("COMPRESSION_ERROR",a);case e.SECURITYERROR:throw new E("SECURITY_ERROR",a);case e.NETWORKERROR:throw new E("NETWORK_ERROR",a);default:throw new E(200<a.statusCode?"HTTP_ERROR":"UNKNOWN ["+a.reason+"]",a);}}catch(h){f.error("Request ("+d._info.n+") to "+g+" failed : "+h.mesg),c.error(h)}});return{abort:function(){f.warn("Aborting request ("+d._info.n+") : ID "+h);e.stopLoad(h)}}}});this._prepare=function(){m=!!nrdp.js.options.trace_msl_requests;s=!!nrdp.js.options.trace_msl_service_tokens;
t=!!nrdp.js.options.trace_msl_store;f.info("Creating MslControl...");this._mslControl=new ad;f.info("Creating MslContext...");this._mslContext=new B;return this._mslContext.prepare().thenResolve(this)};this.request=function(b,c,e,h,m,o,t,u){var B=this,x=nrdp.mono(),y={url:b,n:r++,r:0};f.log("Making MSL request ("+y.n+") payload is "+(e.byteLength||e.length)+" bytes "+b);return Q["try"](function(){var a=new U(B,y,c,e,m,o,t,u),f=d();s&&k("outbound",y,u,B._mslContext,a);B._mslControl.request(B._mslContext,
a,new zc(new v(b,y)),h||-1,f);return f.promise}).fail(function(a){f.log("<- ["+y.n+"."+y.r+"] "+y.url+" e="+a.toString());throw a;}).then(function(b){var c=b.getErrorHeader(),e=b.getMessageHeader();if(c)throw f.error("MSL response has error header : "+c.internalCode+" ["+c.errorCode+"] "+c.errorMessage),new l(new a(c.internalCode,c.errorCode,c.errorMessage));c=e.serviceTokens;s&&k("inbound",y,c);e=d();b.read(-1,h,e);return[e.promise,Q(c)]}).spread(function(a,b){return{body:a||new Uint8Array,serviceTokens:b,
requestInfo:y}}).fin(function(){B._mslContext.getMslStore().save("After a request");f.log("  MSL took "+(nrdp.mono()-x-(y.networkTime||0))+" ms for request ("+y.n+") "+b)})};this.send=function(a,b){Q.when(this,function(b){return b.request(a.url,a.userId,a.body,a.timeout,a.encrypted,a.replayable,a.requestingTokens,a.serviceTokens)}).then(function(a){try{f.trace("MSL networkstats:"+JSON.stringify(a.requestInfo.netStats)),b({success:!0,body:ub(a.body),serviceTokens:a.serviceTokens,requestInfo:a.requestInfo})}catch(c){f.error("Exception in MSL callback : "+
c.toString()+"\n"+c.stack)}}).fail(function(a){var c={mslError:a,errorActionId:nrdp.js.mslExceptionToActionId(a),errorSubCode:1300};f.error("MSL request failed : "+a.toString()+" : ACTION ID "+c.errorActionId);try{b(c)}catch(d){f.error("Exception in MSL error callback : "+d.toString()+"\n"+d.stack)}}).done()};this.getRandom=function(){return this._mslContext.getRandom()};this.getKeyRequestData=function(){return this._mslContext.getKeyRequestData()};this.getMslStore=function(){return this._mslContext.getMslStore()};
this.getUserIdToken=function(a,b){var c=this.getMslStore(),d=c.getUserIdToken(a);if(d&&b&&(c=c.getMasterToken(),!c||!d.isBoundTo(c)))d=null;return d};this.removeUserIdToken=function(a){var b=this.getMslStore();if(a=b.getUserIdToken(a))b.removeUserIdToken(a),b.save()};this.clearUserIdTokens=function(){var a=this.getMslStore();a.clearUserIdTokens();a.save()};this.parseServiceToken=function(a,b,c){var e=this;Q["try"](function(){var c=e.getMslStore(),f=c.getMasterToken(),c=c.getUserIdToken(a),h;if(b&&
f&&c)return h=d(),Zb(b,f,c,null,h),h.promise}).fail(function(a){f.warn("Failed to parse service token",a)}).then(function(b){b?f.trace("Parsed service token "+b.name+" for account "+a):f.trace("Did not parse the service token for account "+a);c(b)}).done()};this.getNpTicketCookie=function(){for(var a=["algorithm","npTicket"],b=this.getMslStore().getNpTicket(),c=0,d=a?a.length:0;void 0!==b&&c<d;)b=b[a[c++]];return void 0===b?void 0:b};this.generateNpTicket=function(a){var b=this;Q["try"](function(){if("npticket"!=
nrdp.webcrypto.authenticationType)throw Error("Not npticket authentication type");return b._mslContext._generateNPTicket()}).then(function(){a(b.getNpTicketCookie())},function(b){f.error("Failed to make new NP-Ticket",b);a()}).done()}}var f=new $("MSL");nrdp.js.mslExceptionToActionId=function(c){if(c instanceof Z)return 2;if(c instanceof l&&c.error)switch(c.error.responseCode){case b.TRANSIENT_FAILURE:return 2;case b.USERDATA_REAUTH:return c.error==a.NETFLIXID_COOKIES_EXPIRED?12:8}return 1};kd=function(a){return Q["try"](function(){return(new k(a))._prepare()})}})();
(function(){function a(){function o(a){var b=c||nrdp.options.appboot_url||m.appboot.url;"/"!=b[b.length-1]&&(b+="/");a&&(b+=escape(nrdp.device.ESNPrefix));return b}function k(b){b&&(c=b);d++;d<=m.appboot.maxRetries?nrdp.gibbon.setTimeout(a,1E3*d):(u.ERROR_DESCRIPTION||(u.ERROR_DESCRIPTION="Retry Count Exceeded"),u.ERROR_STAGE=0,f())}function f(){d=0;var a="error.js",b="?",c,e;e=nrdp.storage;var f;f=e.getItem(e.NO_DEVICE_ACCOUNT,"AppbootErrors")||[];f.push({description:u.ERROR_DESCRIPTION,stage:u.ERROR_STAGE,
appid:nrdp.log.appid,clienttime:Date().toString()});e.setItem(e.NO_DEVICE_ACCOUNT,"AppbootErrors",f);u.ERROR_DESCRIPTION="Error loading UI";for(c in u)e=u[c],"string"===typeof e&&(e=e.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(/"/g,'\\"').replace(/\n/g,"\\n")),a+=b+c+"="+encodeURIComponent(e),b="&";nrdp.gibbon.loadScript({url:a})}var u={ERROR_CATEGORY:"AppBoot",ERROR_FRAME_URL:"",ERROR_DESCRIPTION:"",ERROR_STATUS_CODE:"",ERROR_GROUP:"",ERROR_CODE:"",ERROR_URL:"",ERROR_ACTIONID:"",ERROR_TEXT:"",
ERROR_BCP47:"",ERROR_STAGE:""},s=new $("BOOT"),m={msl:{verifyServer:!0},appboot:{maxRetries:5}},x;Q["try"](function(){u.ERROR_STAGE=1;var a,b;if(!nrdp.isReady)return a=Q.defer(),b=function(){nrdp.removeEventListener("init",b);a.resolve()},nrdp.addEventListener("init",b),nrdp.init(),a.promise}).then(function(){var a=nrdp.js.options,b,c;u.ERROR_STAGE++;u.ERROR_FRAME_URL=nrdp.gibbon.location;a.hasOwnProperty("noverify")&&(m.msl.verifyServer=!a.noverify);m.msl.unauth=a.unauth;try{delete nrdp.storage.transientData.appboot.msltruststore,
s.trace("Deleted previous MSL trust store")}catch(d){s.trace("No previous MSL trust store")}b=Q.defer();c=function(a){x=a.data;s.trace("Got "+x.length+" critical messages");nrdp.log.removeEventListener("criticalMsgsReady",c);b.resolve()};nrdp.log.addEventListener("criticalMsgsReady",c);nrdp.log.getCriticalMessages();return[kd(m),b.promise]}).all().spread(function(a){u.ERROR_STAGE++;var b=nrdp.device,c=nrdp.options,e=nrdp.storage,f=e.transientData,g=o(!0),k=!!g.match(/^https:/),l,m=b.startupTags,A=
b.UILanguages,C={aid:nrdp.log.appid,client_info:{certification_version:""+b.certificationVersion,nrdlib_version:""+b.SDKVersion.components.nrdlib,nrdapp_version:""+b.SDKVersion.components.nrdapp,mdxlib_version:""+b.SDKVersion.components.mdxlib,sdk_version:""+b.SDKVersion.versionString,sw_version:""+b.softwareVersion,languages:0>A.indexOf(b.language)?A.concat(b.language):A},ui:{app:"gibbontvui",query_params:{dw:""+c.ui_width,dh:""+c.ui_height,dar:""+c.ui_aspect_ratio,q:""+c.ui_query_string}}};0<nrdp.gibbon.location.indexOf("?")&&
nrdp.gibbon.location.replace(/[^?]*\?/,"").split("&").forEach(function(a){a&&(a=a.split("="),C.ui.query_params[a[0]]=1<a.length?decodeURIComponent(a[1]):!0)});c.appboot_params.split(/[&,]/).forEach(function(a){a&&(a=a.split("="),C.ui.query_params[a[0]]=1<a.length?decodeURIComponent(a[1]):!0)});C.ui.cookies=nrdp.gibbon.cookie.split("; ").map(function(a){return a.split("=")}).reduce(function(a,b){a[b[0]]=b[1];return a},{});c=nrdp.trustStoreHash||"";C.ssltruststore=0===c.length?{}:{hash:c};C.msltruststore=
{};l=[];if(!f){f={level:"info",type:"startup",esn:b.ESN,appid:nrdp.log.appid,nrdlib_version:""+b.SDKVersion.components.nrdlib,nrdapp_version:""+b.SDKVersion.components.nrdapp,mdxlib_version:""+b.SDKVersion.components.mdxlib,sdk_version:""+b.SDKVersion.versionString};if("object"===typeof m)for(var J in m)m.hasOwnProperty(J)&&(f[J]=m[J]);l.push(f)}l.push({level:"info",type:"appboot",esn:b.ESN,appid:nrdp.log.appid,msg:"appboot request made "+(k?"with":"without")+" SSL",ssl:k,clienttime:Date().toString(),
app_uptime:""+(nrdp.mono()-nrdp.started),retrycount:d});(e.getItem(e.NO_DEVICE_ACCOUNT,"AppbootErrors")||[]).forEach(function(a){l.push({level:"error",type:"networkerror",esn:b.ESN,appid:a.appid,msg:"Appboot displayed BIEP",description:a.description,stage:a.stage,clienttime:a.clienttime})});x.forEach(function(a){l.push(a)});C.log=l;C.responseparams="loglevel,retrycontrol,loginterval,maxlogsize,testdriveripaddr,instrumentationparams".split(",");s.log("Sending AppBoot request to "+g+"\n"+JSON.stringify(C,
null," "));return a.request(g,null,JSON.stringify(C),2E4,!1)}).then(function(a){u.ERROR_STAGE++;var b;b=nrdp.storage;var c=b.transientData||{},a=JSON.parse(ub(a.body));s.log("AppBoot response is\n"+JSON.stringify(a,null," "));c.appboot=a;b.transientData=c;b.removeItem(b.NO_DEVICE_ACCOUNT,"AppbootErrors");nrdp.log.deleteCriticalMessages(x);x=[];if(b=a.error)switch(b.actionid){case 7:k(b.appbootendpoint);break;case 2:k();break;case 13:nrdp.device.factoryReset(function(){nrdp.gibbon.location=nrdp.bootURL});
break;default:throw u.ERROR_ACTIONID=b.actionid,b.usertextgroup&&(u.ERROR_TEXT=b.usertextgroup.text,u.ERROR_BCP47=b.usertextgroup.bcp47),Error("AID "+b.actionid);}else return Q["try"](function(){var b=a.servertime_seconds,c=Math.floor(nrdp.now()/1E3),d=Math.floor(Date.now()/1E3);"number"===typeof b&&(s.info("AppBoot server time "+b),s.info("nrdp.now            "+c+" : "+(c-b)),s.info("Date.now            "+d+" : "+(d-b)),nrdp.setServerTime(b))}).then(function(){var b=a.responseparams.loglevel,c=a.responseparams.testdriveripaddr,
d=a.responseparams.instrumentationparams;"number"===typeof b?nrdp.log.level=b:"string"===typeof b&&(nrdp.log.level=nrdp.log.levels[b]);c&&nrdp.setTestDriverIpAddress(c);d&&nrdp.instrumentation.setParams(d.enabled,d.events)}).then(function(){var b,c=a.ssltruststore;c&&((b=c.error)?s.error('AppBoot server returned an error for "ssltruststore" : '+JSON.stringify(b)):(s.info("Updating app trust store"),nrdp.setTrustStore(c.data)))}).then(function(){u.ERROR_STAGE++;var b;b=a.msltruststore;if(!b)throw Error('response is missing "msltruststore"');
if(b=b.error)throw s.error('AppBoot server returned an error for "msltruststore" : '+JSON.stringify(b)),Error(JSON.stringify(b));s.info("Updating MSL trust store")}).then(function(){u.ERROR_STAGE++;var b,c,e,f,g=nrdp.js.options.appboot_extra_params;c=a.ui;if(!c)throw Error('"ui" element is missing from AppBoot response');if(b=c.error){if(2==b){k();return}throw Error('"ui" response includes an error : '+JSON.stringify(b));}b=c.url;if(!b)throw Error('"ui" element is missing "url"');nrdp.options.ui_url?
b=nrdp.options.ui_url:(e=c.hashvalue||"",c=c.hashalgorithm||"",0!==e.length&&0!==c.length&&"xasfa43r23552"!=e&&(f={"X-Gibbon-Hash":c+"="+e}));g&&(b+=(0<b.indexOf("?")?"&":"?")+decodeURIComponent(g));s.info('Loading UI from "'+b+'"');d=0;nrdp.gibbon.location={url:b,headers:f}})})["catch"](function(a){var c,e=!1;s.fatal("App boot failed: "+a.toString(),a);u.ERROR_DESCRIPTION=a.toString();if(a instanceof Z)c=o(),/^http:/.test(c)?(s.warn("Retrying using SSL"),e=!0,c=c.replace(/^http:/,"https:")):/^https:/.test(c)&&
(s.warn("Retrying without SSL"),e=!0,c=c.replace(/^https:/,"http:"));else if(a instanceof A)e=!0;else if(a instanceof Ra)u.ERROR_STAGE=0,d||(e=!0);else if(a instanceof l&&a.error)switch(a.error.responseCode){case b.TRANSIENT_FAILURE:e=!0}e?(s.warn("Retrying this request"),k(c)):f()}).done()}var c,d=0;nrdp.makeAppbootRequest=a})()}})(this);
