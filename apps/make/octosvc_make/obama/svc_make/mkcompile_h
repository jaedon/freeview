TARGET=$1
PRODUCT=$2
CC=$3

# If compile.h exists already and we don't own autoconf.h
# (i.e. we're not the same user who did make *config), don't
# modify compile.h
# So "sudo make install" won't change the "compiled by <user>"
# do "compiled by root"

if [ -r $TARGET -a ! -O include/autoconf.h ]; then
  echo "  SKIPPED $TARGET"
  exit 0
fi

# Do not expand names
set -f

# Fix the language to get consistent output
LC_ALL=C
export LC_ALL

if [ -z "$KBUILD_BUILD_VERSION" ]; then
	if [ -r .version ]; then
		VERSION=`cat .version`
	else
		VERSION=0
		echo 0 > .version
	fi
else
	VERSION=$KBUILD_BUILD_VERSION
fi

if [ -z "$KBUILD_BUILD_TIMESTAMP" ]; then
	TIMESTAMP=`date`
else
	TIMESTAMP=$KBUILD_BUILD_TIMESTAMP
fi

HUMAXTV_BUILD="#$VERSION $TIMESTAMP"

# Truncate to maximum length

STR_LEN=64
STR_TRUNCATE="sed -e s/\(.\{1,$STR_LEN\}\).*/\1/"

# Generate a temporary compile.h

( echo /\* This file is auto generated, version $VERSION \*/

  echo \#define HUMAXTV_PRODUCT \"$PRODUCT\"
  echo \#define HUMAXTV_BUILD \"`echo $HUMAXTV_BUILD | $STR_TRUNCATE`\"
  
  echo \#define HUMAXTV_BUILD_DATE \"`date +%d\ %b.\ %Y`\"

  echo \#define HUMAXTV_COMPILE_TIME \"`date +%T`\"
  echo \#define HUMAXTV_COMPILE_BY \"`whoami`\"
  echo \#define HUMAXTV_COMPILE_HOST \"`hostname | $STR_TRUNCATE`\"

  if [ -x /bin/dnsdomainname ]; then
    echo \#define HUMAXTV_COMPILE_DOMAIN \"`dnsdomainname | $STR_TRUNCATE`\"
  elif [ -x /bin/domainname ]; then
    echo \#define HUMAXTV_COMPILE_DOMAIN \"`domainname | $STR_TRUNCATE`\"
  else
    echo \#define HUMAXTV_COMPILE_DOMAIN
  fi

  echo \#define HUMAXTV_COMPILER \"`$CC -v 2>&1 | tail -n 1`\"
) > .tmpcompile

# Only replace the real compile.h if the new one is different,
# in order to preserve the timestamp and avoid unnecessary
# recompilations.
# We don't consider the file changed if only the date/time changed.
# A kernel config change will increase the generation number, thus
# causing compile.h to be updated (including date/time) due to the 
# changed comment in the
# first line.

if [ -r $TARGET ] && \
      grep -v 'HUMAXTV_BUILD\|HUMAXTV_COMPILE_TIME' $TARGET > .tmpver.1 && \
      grep -v 'HUMAXTV_BUILD\|HUMAXTV_COMPILE_TIME' .tmpcompile > .tmpver.2 && \
      cmp -s .tmpver.1 .tmpver.2; then
   rm -f .tmpcompile
else
   echo "  UPD     $TARGET"
   mv -f .tmpcompile $TARGET
fi
rm -f .tmpver.1 .tmpver.2
