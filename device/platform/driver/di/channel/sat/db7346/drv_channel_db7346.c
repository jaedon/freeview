/* $Header: */
/*******************************************************************/
/************************* File Description ************************/
/*******************************************************************/
// File Name:		drv_channel_kraken.c
// Original Author: Full Name!!
// File Description:
// Module:
// Remarks:

/*******************************************************************/
/* Copyright (c) 2006 HUMAX Co., Ltd. 							   */
/* All rights reserved.											   */
/*******************************************************************/


/*******************************************************************/
/**************************** Header Files *************************/
/*******************************************************************/
// Start Including Headers

/* chip headers */
#include "string.h"
#include "htype.h"
#include "vkernel.h"

/* di headers */
#include "di_channel.h"
#include "di_channel_priv.h"
#include "di_channel_attr.h"

/* drv headers */
#include "drv_channel.h"
#include "drv_channel_lnb.h"

#include "drv_channel_db7346.h"

/* nexus headers */
#include "nexus_frontend.h"
#include "nexus_platform.h"
#include "nexus_frontend_7346.h"

// End Including Headers


/*******************************************************************/
/****************************** define *****************************/
/*******************************************************************/
// Start #define
#define MIN_WAIT_DELAY			(30)
#define RS_STUFF_BYTE			(16) // Normal
#define ODU_SETUP_TIME_DISEQC	(200) /* TODO : Must be optimized... Outdoor Unit setup time 200ms for DISEQC */
#define ODU_SETUP_TIME_LNB		(100) /* Outdoor Unit setup time 100ms for LNB */

#define MASTER_UNIT				(0)

#define CH_PRINT_LOW_LEVEL_ZAPPING_TIME

//#define DEBUG_SSI_SQI
// End #define

/*******************************************************************/
/****************************** Debug ****************************/
/*******************************************************************/


/*******************************************************************/
/************************ global variables *************************/
/*******************************************************************/
// Start global variablee
HINT32	g_nPrintBER;

extern HINT32 show_di_ch;

// End global variable


/*******************************************************************/
/************************ static variables *************************/
/*******************************************************************/
// Start static variablee

static NEXUS_FrontendHandle s_stFrontend[CONFIG_NUM_OF_SAT_CHANNEL];

static const NEXUS_FrontendSatelliteCodeRate
	g_cr_scan = {0,0,0},
	g_cr_1_4 = {1,4,0},
	g_cr_1_2 = {1,2,0},
	g_cr_2_3 = {2,3,0},
	g_cr_3_4 = {3,4,0},
	g_cr_5_6 = {5,6,0},
	g_cr_6_7 = {6,7,0},
	g_cr_7_8 = {7,8,0},
	g_cr_5_11 = {5,11,0},
	g_cr_3_5 = {3,5,0},
	g_cr_4_5 = {4,5,0},
	g_cr_9_10 = {9,10,0},
	g_cr_8_9 = {8,9,0};

static CH_SAT_LnbStatus_t	s_stLnbState[CONFIG_NUM_OF_SAT_CHANNEL];

//static HUINT8 ucStuffByte = RS_STUFF_BYTE;

#ifdef CH_PRINT_LOW_LEVEL_ZAPPING_TIME
HUINT32 g_ulRequestTune[CONFIG_NUM_OF_SAT_CHANNEL];
HUINT32 g_ulLowLevelLockedTime[CONFIG_NUM_OF_SAT_CHANNEL] , g_ulLowLevelUnlockedTime[CONFIG_NUM_OF_SAT_CHANNEL] ;
#endif


/****************** Function 시작점에 필히 기록 ********************/
/*******************************************************************/
/*********************** Function Description***********************/
/*******************************************************************/
// Function Name:
// Function Description:
// Parameter:
// Return Value:

#define __DB7346_PRIVATE_FUNCITONS__

/*********************** Static Function ***********************/


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//#define SATFE_USE_FLOATING_POINT
#define TUN0_CAL0	(3)
#define TUN0_CAL1	(2)
#define TUN0_CAL2	(4)
#define TUN0_CAL3	(6)
#define TUN0_CAL4	(7)

#define TUN1_CAL0	(-5)
#define TUN1_CAL1	(-3)
#define TUN1_CAL2	(-1)
#define TUN1_CAL3	(0)

#define NUM_FREQS 7
static uint32_t SATFE_bcm4506_freq_range[NUM_FREQS] =
{
   250000000UL,
   502000000UL,
   754000000UL,
   958000000UL,
   1350000000UL,
   1750000000UL,
   1970000000UL
};

/******************************************************************************
 BAST_MultU32U32()
******************************************************************************/
static void BAST_MultU32U32(uint32_t A, uint32_t B, uint32_t *P_hi, uint32_t *P_lo)
{
   uint32_t A_lo = A & 0xFFFF;
   uint32_t A_hi = (A >> 16) & 0xFFFF;
   uint32_t B_lo = B & 0xFFFF;
   uint32_t B_hi = (B >> 16) & 0xFFFF;
   uint32_t P, P0, P1, P2, P3, c;

   P = B_lo * A_lo;
   P0 = P & 0xFFFF;
   P1 = (P >> 16) & 0xFFFF;

   P = B_hi * A_hi;
   P2 = P & 0xFFFF;
   P3 = (P >> 16) & 0xFFFF;

   P = B_lo * A_hi;
   P1 += (P & 0xFFFF);
   P2 += ((P >> 16) & 0xFFFF);

   P = B_hi * A_lo;
   P1 += (P & 0xFFFF);
   P2 += ((P >> 16) & 0xFFFF);

   c = (P1 >> 16) & 0xFFFF;
   if (c)
   {
      P1 &= 0xFFFF;
      P2 += c;
   }

   c = (P2 >> 16) & 0xFFFF;
   if (c)
   {
      P2 &= 0xFFFF;
      P3 += c;
   }

   P3 &= 0xFFFF;
   *P_hi = P2 | (P3 << 16);
   *P_lo = P0 | (P1 << 16);
}


/******************************************************************************
 BAST_DivU64U32()
******************************************************************************/
static void BAST_DivU64U32(uint32_t A_hi, uint32_t A_lo, uint32_t B, uint32_t *Q_hi, uint32_t *Q_lo)
{
   uint32_t X;
   int i;

   X = *Q_hi = *Q_lo = 0;
   for (i = 63; i >= 0; i--)
   {
      X = (X << 1);
      if (i >= 32)
      {
         *Q_hi = *Q_hi << 1;
         X |= ((A_hi & (1 << (i - 32))) ? 1 : 0);
      }
      else
      {
         *Q_lo = *Q_lo << 1;
         X |= ((A_lo & (1 << i)) ? 1 : 0);
      }

      if (X >= B)
      {
         if (i >= 32)
            *Q_hi |= 1;
         else
            *Q_lo |= 1;
         X -= B;
      }
   }
}


/******************************************************************************
 SATFE_findmsb() - returns the position of most significant bit.
******************************************************************************/
uint32_t SATFE_findmsb(uint32_t i)
{
   uint32_t j=0;
   while (i>0)
   {
      i>>=1;
      j++;
   }
   return j;
}


/******************************************************************************
 SATFE_log10() - returns log10(x) in 4.28 format
 assumptions: i is an integer ,uses interpolation to find logtobase2 then
 find logtobase10 from it.
******************************************************************************/
uint32_t SATFE_log10(uint32_t i)
{
   uint32_t log10=0x34936000,log2,fixans;
   uint32_t diff,den;
   uint32_t divh,divl,j,ansl,mul1h,mul1l,mul2h,mul2l,logh,logl;
   log10=882073600;
   j=SATFE_findmsb(i);  /*the msb position is equal to log2base2*/
   diff =(i-(1<<(j-1)));
   den=(1<<j)-(1<<(j-1));
   BAST_DivU64U32(diff,0,den,&divh,&divl); /*the slope calculated for interpolation*/
   j--;
   log2=j+divh;/*found the log2base2*/
   BAST_DivU64U32(log2,divl,3321,&divh,&ansl);/*convert log2base2 to log2base10 3.321 is log10tobase2*/
   BAST_MultU32U32(divh,1000,&mul1h,&mul1l);
   BAST_MultU32U32(ansl,1000,&mul2h,&mul2l);
   logh=mul1h+mul2h;
   logl=mul1l+mul2l;
   fixans=(logh & 0xf)<<28;/*convert to 4.28 format*/
   fixans+=((logl >> 4));

   return fixans;
}


/******************************************************************************
 SATFE_log_x() - returns log(x) in 5.27 format
 assumptions: x < 1, x is scaled 2^16
******************************************************************************/
int32_t SATFE_log_x(uint32_t x)
{
   static int32_t log_table0[256] = {  /* 5.27 format */
      -1488522236   , /*   0   (   0   ) */
      -1488522236   , /*   1   (   1.52588E-05   ) */
      -1395489597   , /*   2   (   3.05176E-05   ) */
      -1341068991   , /*   3   (   4.57764E-05   ) */
      -1302456957   , /*   4   (   6.10352E-05   ) */
      -1272507136   , /*   5   (   7.62939E-05   ) */
      -1248036351   , /*   6   (   9.15527E-05   ) */
      -1227346597   , /*   7   (   0.000106812   ) */
      -1209424317   , /*   8   (   0.00012207   ) */
      -1193615746   , /*   9   (   0.000137329   ) */
      -1179474497   , /*   10   (   0.000152588   ) */
      -1166682181   , /*   11   (   0.000167847   ) */
      -1155003712   , /*   12   (   0.000183105   ) */
      -1144260561   , /*   13   (   0.000198364   ) */
      -1134313958   , /*   14   (   0.000213623   ) */
      -1125053891   , /*   15   (   0.000228882   ) */
      -1116391677   , /*   16   (   0.000244141   ) */
      -1108254778   , /*   17   (   0.000259399   ) */
      -1100583106   , /*   18   (   0.000274658   ) */
      -1093326326   , /*   19   (   0.000289917   ) */
      -1086441857   , /*   20   (   0.000305176   ) */
      -1079893352   , /*   21   (   0.000320435   ) */
      -1073649541   , /*   22   (   0.000335693   ) */
      -1067683327   , /*   23   (   0.000350952   ) */
      -1061971072   , /*   24   (   0.000366211   ) */
      -1056492036   , /*   25   (   0.00038147   ) */
      -1051227921   , /*   26   (   0.000396729   ) */
      -1046162500   , /*   27   (   0.000411987   ) */
      -1041281318   , /*   28   (   0.000427246   ) */
      -1036571441   , /*   29   (   0.000442505   ) */
      -1032021251   , /*   30   (   0.000457764   ) */
      -1027620276   , /*   31   (   0.000473022   ) */
      -1023359038   , /*   32   (   0.000488281   ) */
      -1019228936   , /*   33   (   0.00050354   ) */
      -1015222139   , /*   34   (   0.000518799   ) */
      -1011331497   , /*   35   (   0.000534058   ) */
      -1007550466   , /*   36   (   0.000549316   ) */
      -1003873038   , /*   37   (   0.000564575   ) */
      -1000293687   , /*   38   (   0.000579834   ) */
      -996807316   , /*   39   (   0.000595093   ) */
      -993409217   , /*   40   (   0.000610352   ) */
      -990095031   , /*   41   (   0.00062561   ) */
      -986860712   , /*   42   (   0.000640869   ) */
      -983702502   , /*   43   (   0.000656128   ) */
      -980616901   , /*   44   (   0.000671387   ) */
      -977600646   , /*   45   (   0.000686646   ) */
      -974650687   , /*   46   (   0.000701904   ) */
      -971764173   , /*   47   (   0.000717163   ) */
      -968938432   , /*   48   (   0.000732422   ) */
      -966170958   , /*   49   (   0.000747681   ) */
      -963459397   , /*   50   (   0.000762939   ) */
      -960801533   , /*   51   (   0.000778198   ) */
      -958195282   , /*   52   (   0.000793457   ) */
      -955638676   , /*   53   (   0.000808716   ) */
      -953129861   , /*   54   (   0.000823975   ) */
      -950667081   , /*   55   (   0.000839233   ) */
      -948248678   , /*   56   (   0.000854492   ) */
      -945873081   , /*   57   (   0.000869751   ) */
      -943538801   , /*   58   (   0.00088501   ) */
      -941244425   , /*   59   (   0.000900269   ) */
      -938988612   , /*   60   (   0.000915527   ) */
      -936770086   , /*   61   (   0.000930786   ) */
      -934587636   , /*   62   (   0.000946045   ) */
      -932440107   , /*   63   (   0.000961304   ) */
      -930326398   , /*   64   (   0.000976563   ) */
      -928245461   , /*   65   (   0.000991821   ) */
      -926196296   , /*   66   (   0.00100708   ) */
      -924177946   , /*   67   (   0.001022339   ) */
      -922189499   , /*   68   (   0.001037598   ) */
      -920230081   , /*   69   (   0.001052856   ) */
      -918298858   , /*   70   (   0.001068115   ) */
      -916395028   , /*   71   (   0.001083374   ) */
      -914517827   , /*   72   (   0.001098633   ) */
      -912666518   , /*   73   (   0.001113892   ) */
      -910840398   , /*   74   (   0.00112915   ) */
      -909038791   , /*   75   (   0.001144409   ) */
      -907261047   , /*   76   (   0.001159668   ) */
      -905506542   , /*   77   (   0.001174927   ) */
      -903774676   , /*   78   (   0.001190186   ) */
      -902064873   , /*   79   (   0.001205444   ) */
      -900376577   , /*   80   (   0.001220703   ) */
      -898709255   , /*   81   (   0.001235962   ) */
      -897062391   , /*   82   (   0.001251221   ) */
      -895435490   , /*   83   (   0.001266479   ) */
      -893828072   , /*   84   (   0.001281738   ) */
      -892239678   , /*   85   (   0.001296997   ) */
      -890669863   , /*   86   (   0.001312256   ) */
      -889118195   , /*   87   (   0.001327515   ) */
      -887584262   , /*   88   (   0.001342773   ) */
      -886067661   , /*   89   (   0.001358032   ) */
      -884568006   , /*   90   (   0.001373291   ) */
      -883084922   , /*   91   (   0.00138855   ) */
      -881618047   , /*   92   (   0.001403809   ) */
      -880167031   , /*   93   (   0.001419067   ) */
      -878731533   , /*   94   (   0.001434326   ) */
      -877311226   , /*   95   (   0.001449585   ) */
      -875905792   , /*   96   (   0.001464844   ) */
      -874514923   , /*   97   (   0.001480103   ) */
      -873138318   , /*   98   (   0.001495361   ) */
      -871775690   , /*   99   (   0.00151062   ) */
      -870426757   , /*   100   (   0.001525879   ) */
      -869091246   , /*   101   (   0.001541138   ) */
      -867768893   , /*   102   (   0.001556396   ) */
      -866459442   , /*   103   (   0.001571655   ) */
      -865162642   , /*   104   (   0.001586914   ) */
      -863878252   , /*   105   (   0.001602173   ) */
      -862606037   , /*   106   (   0.001617432   ) */
      -861345767   , /*   107   (   0.00163269   ) */
      -860097221   , /*   108   (   0.001647949   ) */
      -858860182   , /*   109   (   0.001663208   ) */
      -857634441   , /*   110   (   0.001678467   ) */
      -856419793   , /*   111   (   0.001693726   ) */
      -855216038   , /*   112   (   0.001708984   ) */
      -854022984   , /*   113   (   0.001724243   ) */
      -852840441   , /*   114   (   0.001739502   ) */
      -851668227   , /*   115   (   0.001754761   ) */
      -850506161   , /*   116   (   0.00177002   ) */
      -849354071   , /*   117   (   0.001785278   ) */
      -848211785   , /*   118   (   0.001800537   ) */
      -847079139   , /*   119   (   0.001815796   ) */
      -845955972   , /*   120   (   0.001831055   ) */
      -844842125   , /*   121   (   0.001846313   ) */
      -843737447   , /*   122   (   0.001861572   ) */
      -842641786   , /*   123   (   0.001876831   ) */
      -841554996   , /*   124   (   0.00189209   ) */
      -840476937   , /*   125   (   0.001907349   ) */
      -839407467   , /*   126   (   0.001922607   ) */
      -838346452   , /*   127   (   0.001937866   ) */
      -837293758   , /*   128   (   0.001953125   ) */
      -836249257   , /*   129   (   0.001968384   ) */
      -835212822   , /*   130   (   0.001983643   ) */
      -834184328   , /*   131   (   0.001998901   ) */
      -833163656   , /*   132   (   0.00201416   ) */
      -832150687   , /*   133   (   0.002029419   ) */
      -831145306   , /*   134   (   0.002044678   ) */
      -830147400   , /*   135   (   0.002059937   ) */
      -829156859   , /*   136   (   0.002075195   ) */
      -828173575   , /*   137   (   0.002090454   ) */
      -827197442   , /*   138   (   0.002105713   ) */
      -826228356   , /*   139   (   0.002120972   ) */
      -825266218   , /*   140   (   0.00213623   ) */
      -824310928   , /*   141   (   0.002151489   ) */
      -823362388   , /*   142   (   0.002166748   ) */
      -822420506   , /*   143   (   0.002182007   ) */
      -821485187   , /*   144   (   0.002197266   ) */
      -820556341   , /*   145   (   0.002212524   ) */
      -819633878   , /*   146   (   0.002227783   ) */
      -818717713   , /*   147   (   0.002243042   ) */
      -817807759   , /*   148   (   0.002258301   ) */
      -816903932   , /*   149   (   0.00227356   ) */
      -816006151   , /*   150   (   0.002288818   ) */
      -815114336   , /*   151   (   0.002304077   ) */
      -814228407   , /*   152   (   0.002319336   ) */
      -813348288   , /*   153   (   0.002334595   ) */
      -812473902   , /*   154   (   0.002349854   ) */
      -811605176   , /*   155   (   0.002365112   ) */
      -810742036   , /*   156   (   0.002380371   ) */
      -809884412   , /*   157   (   0.00239563   ) */
      -809032233   , /*   158   (   0.002410889   ) */
      -808185431   , /*   159   (   0.002426147   ) */
      -807343938   , /*   160   (   0.002441406   ) */
      -806507687   , /*   161   (   0.002456665   ) */
      -805676615   , /*   162   (   0.002471924   ) */
      -804850657   , /*   163   (   0.002487183   ) */
      -804029751   , /*   164   (   0.002502441   ) */
      -803213836   , /*   165   (   0.0025177   ) */
      -802402850   , /*   166   (   0.002532959   ) */
      -801596735   , /*   167   (   0.002548218   ) */
      -800795433   , /*   168   (   0.002563477   ) */
      -799998886   , /*   169   (   0.002578735   ) */
      -799207039   , /*   170   (   0.002593994   ) */
      -798419836   , /*   171   (   0.002609253   ) */
      -797637223   , /*   172   (   0.002624512   ) */
      -796859147   , /*   173   (   0.002639771   ) */
      -796085556   , /*   174   (   0.002655029   ) */
      -795316397   , /*   175   (   0.002670288   ) */
      -794551622   , /*   176   (   0.002685547   ) */
      -793791180   , /*   177   (   0.002700806   ) */
      -793035021   , /*   178   (   0.002716064   ) */
      -792283099   , /*   179   (   0.002731323   ) */
      -791535366   , /*   180   (   0.002746582   ) */
      -790791776   , /*   181   (   0.002761841   ) */
      -790052282   , /*   182   (   0.0027771   ) */
      -789316841   , /*   183   (   0.002792358   ) */
      -788585407   , /*   184   (   0.002807617   ) */
      -787857938   , /*   185   (   0.002822876   ) */
      -787134391   , /*   186   (   0.002838135   ) */
      -786414723   , /*   187   (   0.002853394   ) */
      -785698893   , /*   188   (   0.002868652   ) */
      -784986861   , /*   189   (   0.002883911   ) */
      -784278587   , /*   190   (   0.00289917   ) */
      -783574030   , /*   191   (   0.002914429   ) */
      -782873153   , /*   192   (   0.002929688   ) */
      -782175916   , /*   193   (   0.002944946   ) */
      -781482283   , /*   194   (   0.002960205   ) */
      -780792216   , /*   195   (   0.002975464   ) */
      -780105679   , /*   196   (   0.002990723   ) */
      -779422635   , /*   197   (   0.003005981   ) */
      -778743050   , /*   198   (   0.00302124   ) */
      -778066889   , /*   199   (   0.003036499   ) */
      -777394117   , /*   200   (   0.003051758   ) */
      -776724701   , /*   201   (   0.003067017   ) */
      -776058606   , /*   202   (   0.003082275   ) */
      -775395802   , /*   203   (   0.003097534   ) */
      -774736254   , /*   204   (   0.003112793   ) */
      -774079931   , /*   205   (   0.003128052   ) */
      -773426802   , /*   206   (   0.003143311   ) */
      -772776836   , /*   207   (   0.003158569   ) */
      -772130002   , /*   208   (   0.003173828   ) */
      -771486271   , /*   209   (   0.003189087   ) */
      -770845612   , /*   210   (   0.003204346   ) */
      -770207997   , /*   211   (   0.003219604   ) */
      -769573397   , /*   212   (   0.003234863   ) */
      -768941783   , /*   213   (   0.003250122   ) */
      -768313127   , /*   214   (   0.003265381   ) */
      -767687402   , /*   215   (   0.00328064   ) */
      -767064581   , /*   216   (   0.003295898   ) */
      -766444637   , /*   217   (   0.003311157   ) */
      -765827543   , /*   218   (   0.003326416   ) */
      -765213273   , /*   219   (   0.003341675   ) */
      -764601801   , /*   220   (   0.003356934   ) */
      -763993103   , /*   221   (   0.003372192   ) */
      -763387153   , /*   222   (   0.003387451   ) */
      -762783926   , /*   223   (   0.00340271   ) */
      -762183399   , /*   224   (   0.003417969   ) */
      -761585546   , /*   225   (   0.003433228   ) */
      -760990344   , /*   226   (   0.003448486   ) */
      -760397771   , /*   227   (   0.003463745   ) */
      -759807802   , /*   228   (   0.003479004   ) */
      -759220415   , /*   229   (   0.003494263   ) */
      -758635587   , /*   230   (   0.003509521   ) */
      -758053296   , /*   231   (   0.00352478   ) */
      -757473521   , /*   232   (   0.003540039   ) */
      -756896240   , /*   233   (   0.003555298   ) */
      -756321431   , /*   234   (   0.003570557   ) */
      -755749073   , /*   235   (   0.003585815   ) */
      -755179145   , /*   236   (   0.003601074   ) */
      -754611628   , /*   237   (   0.003616333   ) */
      -754046500   , /*   238   (   0.003631592   ) */
      -753483741   , /*   239   (   0.003646851   ) */
      -752923332   , /*   240   (   0.003662109   ) */
      -752365253   , /*   241   (   0.003677368   ) */
      -751809486   , /*   242   (   0.003692627   ) */
      -751256010   , /*   243   (   0.003707886   ) */
      -750704807   , /*   244   (   0.003723145   ) */
      -750155858   , /*   245   (   0.003738403   ) */
      -749609146   , /*   246   (   0.003753662   ) */
      -749064651   , /*   247   (   0.003768921   ) */
      -748522357   , /*   248   (   0.00378418   ) */
      -747982244   , /*   249   (   0.003799438   ) */
      -747444297   , /*   250   (   0.003814697   ) */
      -746908497   , /*   251   (   0.003829956   ) */
      -746374827   , /*   252   (   0.003845215   ) */
      -745843271   , /*   253   (   0.003860474   ) */
      -745313812   , /*   254   (   0.003875732   ) */
      -744786433     /*   255   (   0.003890991   ) */
   };

   static int32_t log_table1[256] = {   /* 5.27 format */
      -1488522236   , /*   0   (   1.52588E-05   ) */
      -744261118   , /*   1   (   0.00390625   ) */
      -651228479   , /*   2   (   0.0078125   ) */
      -596807873   , /*   3   (   0.01171875   ) */
      -558195839   , /*   4   (   0.015625   ) */
      -528246018   , /*   5   (   0.01953125   ) */
      -503775233   , /*   6   (   0.0234375   ) */
      -483085479   , /*   7   (   0.02734375   ) */
      -465163199   , /*   8   (   0.03125   ) */
      -449354628   , /*   9   (   0.03515625   ) */
      -435213379   , /*   10   (   0.0390625   ) */
      -422421063   , /*   11   (   0.04296875   ) */
      -410742594   , /*   12   (   0.046875   ) */
      -399999443   , /*   13   (   0.05078125   ) */
      -390052840   , /*   14   (   0.0546875   ) */
      -380792773   , /*   15   (   0.05859375   ) */
      -372130559   , /*   16   (   0.0625   ) */
      -363993660   , /*   17   (   0.06640625   ) */
      -356321988   , /*   18   (   0.0703125   ) */
      -349065208   , /*   19   (   0.07421875   ) */
      -342180739   , /*   20   (   0.078125   ) */
      -335632234   , /*   21   (   0.08203125   ) */
      -329388423   , /*   22   (   0.0859375   ) */
      -323422209   , /*   23   (   0.08984375   ) */
      -317709954   , /*   24   (   0.09375   ) */
      -312230919   , /*   25   (   0.09765625   ) */
      -306966804   , /*   26   (   0.1015625   ) */
      -301901382   , /*   27   (   0.10546875   ) */
      -297020200   , /*   28   (   0.109375   ) */
      -292310323   , /*   29   (   0.11328125   ) */
      -287760133   , /*   30   (   0.1171875   ) */
      -283359158   , /*   31   (   0.12109375   ) */
      -279097920   , /*   32   (   0.125   ) */
      -274967818   , /*   33   (   0.12890625   ) */
      -270961021   , /*   34   (   0.1328125   ) */
      -267070379   , /*   35   (   0.13671875   ) */
      -263289348   , /*   36   (   0.140625   ) */
      -259611920   , /*   37   (   0.14453125   ) */
      -256032569   , /*   38   (   0.1484375   ) */
      -252546198   , /*   39   (   0.15234375   ) */
      -249148099   , /*   40   (   0.15625   ) */
      -245833913   , /*   41   (   0.16015625   ) */
      -242599594   , /*   42   (   0.1640625   ) */
      -239441384   , /*   43   (   0.16796875   ) */
      -236355783   , /*   44   (   0.171875   ) */
      -233339528   , /*   45   (   0.17578125   ) */
      -230389569   , /*   46   (   0.1796875   ) */
      -227503055   , /*   47   (   0.18359375   ) */
      -224677314   , /*   48   (   0.1875   ) */
      -221909840   , /*   49   (   0.19140625   ) */
      -219198279   , /*   50   (   0.1953125   ) */
      -216540415   , /*   51   (   0.19921875   ) */
      -213934164   , /*   52   (   0.203125   ) */
      -211377558   , /*   53   (   0.20703125   ) */
      -208868743   , /*   54   (   0.2109375   ) */
      -206405963   , /*   55   (   0.21484375   ) */
      -203987560   , /*   56   (   0.21875   ) */
      -201611963   , /*   57   (   0.22265625   ) */
      -199277683   , /*   58   (   0.2265625   ) */
      -196983307   , /*   59   (   0.23046875   ) */
      -194727494   , /*   60   (   0.234375   ) */
      -192508968   , /*   61   (   0.23828125   ) */
      -190326518   , /*   62   (   0.2421875   ) */
      -188178989   , /*   63   (   0.24609375   ) */
      -186065280   , /*   64   (   0.25   ) */
      -183984343   , /*   65   (   0.25390625   ) */
      -181935178   , /*   66   (   0.2578125   ) */
      -179916828   , /*   67   (   0.26171875   ) */
      -177928381   , /*   68   (   0.265625   ) */
      -175968963   , /*   69   (   0.26953125   ) */
      -174037740   , /*   70   (   0.2734375   ) */
      -172133910   , /*   71   (   0.27734375   ) */
      -170256709   , /*   72   (   0.28125   ) */
      -168405400   , /*   73   (   0.28515625   ) */
      -166579280   , /*   74   (   0.2890625   ) */
      -164777673   , /*   75   (   0.29296875   ) */
      -162999929   , /*   76   (   0.296875   ) */
      -161245424   , /*   77   (   0.30078125   ) */
      -159513558   , /*   78   (   0.3046875   ) */
      -157803755   , /*   79   (   0.30859375   ) */
      -156115460   , /*   80   (   0.3125   ) */
      -154448137   , /*   81   (   0.31640625   ) */
      -152801273   , /*   82   (   0.3203125   ) */
      -151174372   , /*   83   (   0.32421875   ) */
      -149566955   , /*   84   (   0.328125   ) */
      -147978561   , /*   85   (   0.33203125   ) */
      -146408745   , /*   86   (   0.3359375   ) */
      -144857077   , /*   87   (   0.33984375   ) */
      -143323144   , /*   88   (   0.34375   ) */
      -141806543   , /*   89   (   0.34765625   ) */
      -140306888   , /*   90   (   0.3515625   ) */
      -138823804   , /*   91   (   0.35546875   ) */
      -137356929   , /*   92   (   0.359375   ) */
      -135905913   , /*   93   (   0.36328125   ) */
      -134470415   , /*   94   (   0.3671875   ) */
      -133050108   , /*   95   (   0.37109375   ) */
      -131644674   , /*   96   (   0.375   ) */
      -130253805   , /*   97   (   0.37890625   ) */
      -128877201   , /*   98   (   0.3828125   ) */
      -127514572   , /*   99   (   0.38671875   ) */
      -126165639   , /*   100   (   0.390625   ) */
      -124830128   , /*   101   (   0.39453125   ) */
      -123507775   , /*   102   (   0.3984375   ) */
      -122198324   , /*   103   (   0.40234375   ) */
      -120901524   , /*   104   (   0.40625   ) */
      -119617134   , /*   105   (   0.41015625   ) */
      -118344919   , /*   106   (   0.4140625   ) */
      -117084649   , /*   107   (   0.41796875   ) */
      -115836103   , /*   108   (   0.421875   ) */
      -114599064   , /*   109   (   0.42578125   ) */
      -113373323   , /*   110   (   0.4296875   ) */
      -112158675   , /*   111   (   0.43359375   ) */
      -110954920   , /*   112   (   0.4375   ) */
      -109761866   , /*   113   (   0.44140625   ) */
      -108579323   , /*   114   (   0.4453125   ) */
      -107407109   , /*   115   (   0.44921875   ) */
      -106245043   , /*   116   (   0.453125   ) */
      -105092953   , /*   117   (   0.45703125   ) */
      -103950667   , /*   118   (   0.4609375   ) */
      -102818021   , /*   119   (   0.46484375   ) */
      -101694854   , /*   120   (   0.46875   ) */
      -100581007   , /*   121   (   0.47265625   ) */
      -99476329   , /*   122   (   0.4765625   ) */
      -98380668   , /*   123   (   0.48046875   ) */
      -97293878   , /*   124   (   0.484375   ) */
      -96215819   , /*   125   (   0.48828125   ) */
      -95146349   , /*   126   (   0.4921875   ) */
      -94085334   , /*   127   (   0.49609375   ) */
      -93032640   , /*   128   (   0.5   ) */
      -91988139   , /*   129   (   0.50390625   ) */
      -90951704   , /*   130   (   0.5078125   ) */
      -89923210   , /*   131   (   0.51171875   ) */
      -88902538   , /*   132   (   0.515625   ) */
      -87889569   , /*   133   (   0.51953125   ) */
      -86884188   , /*   134   (   0.5234375   ) */
      -85886282   , /*   135   (   0.52734375   ) */
      -84895741   , /*   136   (   0.53125   ) */
      -83912457   , /*   137   (   0.53515625   ) */
      -82936324   , /*   138   (   0.5390625   ) */
      -81967238   , /*   139   (   0.54296875   ) */
      -81005100   , /*   140   (   0.546875   ) */
      -80049810   , /*   141   (   0.55078125   ) */
      -79101270   , /*   142   (   0.5546875   ) */
      -78159388   , /*   143   (   0.55859375   ) */
      -77224069   , /*   144   (   0.5625   ) */
      -76295223   , /*   145   (   0.56640625   ) */
      -75372760   , /*   146   (   0.5703125   ) */
      -74456595   , /*   147   (   0.57421875   ) */
      -73546641   , /*   148   (   0.578125   ) */
      -72642814   , /*   149   (   0.58203125   ) */
      -71745033   , /*   150   (   0.5859375   ) */
      -70853218   , /*   151   (   0.58984375   ) */
      -69967289   , /*   152   (   0.59375   ) */
      -69087170   , /*   153   (   0.59765625   ) */
      -68212784   , /*   154   (   0.6015625   ) */
      -67344058   , /*   155   (   0.60546875   ) */
      -66480918   , /*   156   (   0.609375   ) */
      -65623294   , /*   157   (   0.61328125   ) */
      -64771115   , /*   158   (   0.6171875   ) */
      -63924313   , /*   159   (   0.62109375   ) */
      -63082820   , /*   160   (   0.625   ) */
      -62246570   , /*   161   (   0.62890625   ) */
      -61415497   , /*   162   (   0.6328125   ) */
      -60589540   , /*   163   (   0.63671875   ) */
      -59768633   , /*   164   (   0.640625   ) */
      -58952718   , /*   165   (   0.64453125   ) */
      -58141732   , /*   166   (   0.6484375   ) */
      -57335617   , /*   167   (   0.65234375   ) */
      -56534315   , /*   168   (   0.65625   ) */
      -55737768   , /*   169   (   0.66015625   ) */
      -54945921   , /*   170   (   0.6640625   ) */
      -54158718   , /*   171   (   0.66796875   ) */
      -53376105   , /*   172   (   0.671875   ) */
      -52598029   , /*   173   (   0.67578125   ) */
      -51824438   , /*   174   (   0.6796875   ) */
      -51055279   , /*   175   (   0.68359375   ) */
      -50290504   , /*   176   (   0.6875   ) */
      -49530062   , /*   177   (   0.69140625   ) */
      -48773903   , /*   178   (   0.6953125   ) */
      -48021981   , /*   179   (   0.69921875   ) */
      -47274248   , /*   180   (   0.703125   ) */
      -46530658   , /*   181   (   0.70703125   ) */
      -45791164   , /*   182   (   0.7109375   ) */
      -45055723   , /*   183   (   0.71484375   ) */
      -44324289   , /*   184   (   0.71875   ) */
      -43596820   , /*   185   (   0.72265625   ) */
      -42873273   , /*   186   (   0.7265625   ) */
      -42153605   , /*   187   (   0.73046875   ) */
      -41437775   , /*   188   (   0.734375   ) */
      -40725743   , /*   189   (   0.73828125   ) */
      -40017469   , /*   190   (   0.7421875   ) */
      -39312912   , /*   191   (   0.74609375   ) */
      -38612035   , /*   192   (   0.75   ) */
      -37914798   , /*   193   (   0.75390625   ) */
      -37221165   , /*   194   (   0.7578125   ) */
      -36531098   , /*   195   (   0.76171875   ) */
      -35844561   , /*   196   (   0.765625   ) */
      -35161517   , /*   197   (   0.76953125   ) */
      -34481933   , /*   198   (   0.7734375   ) */
      -33805771   , /*   199   (   0.77734375   ) */
      -33132999   , /*   200   (   0.78125   ) */
      -32463583   , /*   201   (   0.78515625   ) */
      -31797488   , /*   202   (   0.7890625   ) */
      -31134684   , /*   203   (   0.79296875   ) */
      -30475136   , /*   204   (   0.796875   ) */
      -29818813   , /*   205   (   0.80078125   ) */
      -29165684   , /*   206   (   0.8046875   ) */
      -28515718   , /*   207   (   0.80859375   ) */
      -27868884   , /*   208   (   0.8125   ) */
      -27225153   , /*   209   (   0.81640625   ) */
      -26584494   , /*   210   (   0.8203125   ) */
      -25946879   , /*   211   (   0.82421875   ) */
      -25312279   , /*   212   (   0.828125   ) */
      -24680665   , /*   213   (   0.83203125   ) */
      -24052009   , /*   214   (   0.8359375   ) */
      -23426284   , /*   215   (   0.83984375   ) */
      -22803463   , /*   216   (   0.84375   ) */
      -22183519   , /*   217   (   0.84765625   ) */
      -21566425   , /*   218   (   0.8515625   ) */
      -20952155   , /*   219   (   0.85546875   ) */
      -20340684   , /*   220   (   0.859375   ) */
      -19731985   , /*   221   (   0.86328125   ) */
      -19126035   , /*   222   (   0.8671875   ) */
      -18522808   , /*   223   (   0.87109375   ) */
      -17922281   , /*   224   (   0.875   ) */
      -17324428   , /*   225   (   0.87890625   ) */
      -16729226   , /*   226   (   0.8828125   ) */
      -16136653   , /*   227   (   0.88671875   ) */
      -15546684   , /*   228   (   0.890625   ) */
      -14959297   , /*   229   (   0.89453125   ) */
      -14374469   , /*   230   (   0.8984375   ) */
      -13792179   , /*   231   (   0.90234375   ) */
      -13212403   , /*   232   (   0.90625   ) */
      -12635122   , /*   233   (   0.91015625   ) */
      -12060313   , /*   234   (   0.9140625   ) */
      -11487955   , /*   235   (   0.91796875   ) */
      -10918027   , /*   236   (   0.921875   ) */
      -10350510   , /*   237   (   0.92578125   ) */
      -9785382   , /*   238   (   0.9296875   ) */
      -9222623   , /*   239   (   0.93359375   ) */
      -8662214   , /*   240   (   0.9375   ) */
      -8104136   , /*   241   (   0.94140625   ) */
      -7548368   , /*   242   (   0.9453125   ) */
      -6994892   , /*   243   (   0.94921875   ) */
      -6443689   , /*   244   (   0.953125   ) */
      -5894740   , /*   245   (   0.95703125   ) */
      -5348028   , /*   246   (   0.9609375   ) */
      -4803533   , /*   247   (   0.96484375   ) */
      -4261239   , /*   248   (   0.96875   ) */
      -3721126   , /*   249   (   0.97265625   ) */
      -3183179   , /*   250   (   0.9765625   ) */
      -2647379   , /*   251   (   0.98046875   ) */
      -2113709   , /*   252   (   0.984375   ) */
      -1582153   , /*   253   (   0.98828125   ) */
      -1052694   , /*   254   (   0.9921875   ) */
      -525315   , /*   255   (   0.99609375   ) */
   };

   uint32_t idx, x0, x1, P_hi, P_lo, Q_hi, Q_lo;
   int32_t y0, y1, val;

   idx = (x >> 8) & 0xFF; /* idx is index into log table */
   if (idx == 0)
      val = log_table0[x & 0xFF];
   else
   {
      y0 = log_table1[idx];
      if (idx < 0xFF)
         y1 = log_table1[idx+1];
      else
         y1 = 0;
      x0 = x & 0xFF00;
      x1 = x & 0xFFFF;

      BAST_MultU32U32(x1 - x0, y1 - y0, &P_hi, &P_lo);
      BAST_DivU64U32(P_hi, P_lo, 256, &Q_hi, &Q_lo);
      val = y0 + (int32_t)Q_lo;
   }

   return val;
}


/******************************************************************************
 SATFE_interpolate_freq() - fixed point linear interpolation used in power estimation
******************************************************************************/
int32_t SATFE_interpolate_freq(uint32_t freq, uint32_t *F, int32_t *Y, int n)
{
   int32_t i, val;
   uint32_t P_hi, P_lo, Q_hi, Q_lo, diff;

   for (i = 1; i < n; i++)
      if (freq < F[i])
         break;

   if (i < n)
   {
      if (Y[i] >= Y[i-1])
         diff = Y[i] - Y[i-1];
      else
         diff = Y[i-1] - Y[i];
      BAST_MultU32U32(freq - F[i-1], diff, &P_hi, &P_lo);
      BAST_DivU64U32(P_hi, P_lo, F[i] - F[i-1], &Q_hi, &Q_lo);
      val = Q_lo;
      if (Y[i] < Y[i-1])
         val = -val;
      val += Y[i-1];
   }
   else
   {
      if (Y[n-1] >= Y[n-2])
         diff = Y[n-1] - Y[n-2];
      else
         diff = Y[n-2] - Y[n-1];
      BAST_MultU32U32(diff, freq - F[n-1], &P_hi, &P_lo);
      BAST_DivU64U32(P_hi, P_lo, F[n-1] - F[n-2], &Q_hi, &Q_lo);
      val = Q_lo;
      if (Y[n-1] < Y[n-2])
         val = -val;
      val += Y[n-1];
   }
   return val;
}

/**********************************************************************
 SATFE_bcm3445_get_input_power() - calculates gain from 3445 in 2^-24 dBm
**********************************************************************/
void SATFE_bcm3445_get_input_power(uint32_t tuner_freq, uint32_t bcm3445_agc, int32_t *pPower)
{
   static int32_t p2_all_fixed[3][NUM_FREQS] = { /* parabolic interpolation for LNA, signed 7.25 */
      {
         -1406299800,
         1097947991,
         901647853,
         850339771,
         1096243426,
         716927349,
         1153346358
      },
      {
         2132122430,
         -163755694,
         17817403,
         61095909,
         -188827566,
         239957809,
         -202950626
      },
      {
         568542940,
         17069139,
         -19780337,
         -50918850,
         37379637,
         -88982998,
         12139993
      }
   };

   int i;
   int32_t p2[3], Pin_lna;
   uint32_t P_hi, P_lo, Q_hi, Q_lo, lna_gain, val, val2;

   for (i = 0; i < 3; i++)
      p2[i] = SATFE_interpolate_freq(tuner_freq, SATFE_bcm4506_freq_range, p2_all_fixed[i], NUM_FREQS);

   /* get input power from LNA in 8.24 */
   lna_gain = ((bcm3445_agc * 2048) + 1) >> 1;
   if (bcm3445_agc)
   {
      /* val*(p2[0]*val + p2[1]) + p2[2] */
      if (lna_gain <= 4096)  /* 4/64 * 2^16 = 4096 */
         val = 4096;
      else
         val = lna_gain;
      if (p2[0] >= 0)
         val2 = p2[0];
      else
         val2 = ~p2[0] + 1;
      BAST_MultU32U32(val, val2, &P_hi, &P_lo); /* 23.41 */
      BAST_DivU64U32(P_hi, P_lo, 65536, &Q_hi, &Q_lo); /* 7.25 */
      if (p2[0] >= 0)
         Pin_lna = (int32_t)Q_lo + p2[1];
      else
         Pin_lna = p2[1] - (int32_t)Q_lo;
      if (Pin_lna >= 0)
         val2 = Pin_lna;
      else
         val2 = ~Pin_lna + 1;
      BAST_MultU32U32(val, val2, &P_hi, &P_lo); /* 23.41 */
      BAST_DivU64U32(P_hi, P_lo, 65536, &Q_hi, &Q_lo); /* 7.25 */
      if (Pin_lna >= 0)
         Pin_lna = (int32_t)Q_lo + p2[2];
      else
         Pin_lna = p2[2] - (int32_t)Q_lo;
      Pin_lna = Pin_lna / 2; /* 8.24 */
      if (lna_gain <= 4096)
      {
         if (Pin_lna >= 0)
            val2 = Pin_lna;
         else
            val2 = ~Pin_lna + 1;
         BAST_MultU32U32(lna_gain << 4, val2, &P_hi, &P_lo); /* 24.40 */
         BAST_DivU64U32(P_hi, P_lo, 65536, &Q_hi, &Q_lo); /* 8.24 */
         if (Pin_lna >= 0)
            Pin_lna = Q_lo;
         else
            Pin_lna = ~Q_lo + 1;
      }
   }
   else
      Pin_lna = 0;

   *pPower = Pin_lna;
}

/******************************************************************************
 SATFE_Platform_GetInputPower()
******************************************************************************/
#if 0
void SATFE_Platform_GetInputPower(SATFE_Chip *pChip, uint32_t rfagc,
                                         uint32_t ifagc, uint32_t agf, uint32_t tuner_freq,
                                         float *pPower)
#else
void SATFE_Platform_GetInputPower(int nUnitId, //uint32_t rfagc,
                                         uint32_t ifagc, uint32_t agf, uint32_t tuner_freq,
                                         float *pPower)
#endif
{

#if 0
	SATFE_Chip *pSocChip;
	BERR_Code retCode;
	BAST_TunerLnaStatus lnaStatus;
	BAST_Bcm3445Status bcm3445Status;
	NEXUS_3445LnaStatus  st3445Status;
	uint32_t bcm3445_agc;
#else
	NEXUS_Error 	etNErrorCode = NEXUS_SUCCESS;
	NEXUS_7346LnaStatus stLnaStatus;
#endif

#ifdef SATFE_USE_FLOATING_POINT
	float G_lna, G_rfpga, G_fga, G_ifpga, G_aif, G_agt, P_adj, P_ndfctl, P_freq;
#else
	int32_t G_lna, G_rfpga, G_ifpga, G_fga, G_aif, G_agt, P_ndfctl, P_freq, P_adj, b;
	uint32_t P_hi, P_lo, Q_hi, Q_lo, a, c, d;
#endif

	int32_t r1, r2, r3, P_3445 = 0;
	uint32_t val;

	*pPower = 0;

#if 0
	/* get the internal LNA status */
	pSocChip = SATFE_GetChipByIndex(0);
	SATFE_MUTEX(retCode = BAST_GetTunerLnaStatus(pSocChip->hAstChannel[0], &lnaStatus));
	SATFE_GOTO_DONE_ON_ERROR("BAST_GetTunerLnaStatus()", retCode);
	r1 = (lnaStatus.lnaAgc >> 26) & 0x3F;
	r2 = (lnaStatus.bbAgc >> 26) & 0x3F;
#else
	etNErrorCode = NEXUS_Frontend_Get7346LnaStatus(s_stFrontend[nUnitId],&stLnaStatus);
	if( etNErrorCode != NEXUS_SUCCESS )
	{
		CH_DI_Print(0, ( "Error!!! [NEXUS_Frontend_Get7346LnaStatus] nUnitId[%d] etNErrorCode = (%d)\n", nUnitId, etNErrorCode));
	}
	else
	{
		CH_DI_Print(7, ( "[NEXUS_Frontend_Get7346LnaStatus] nUnitId[%d] stLnaStatus.agc = (%x):(%x) = stLnaStatus.baseBandAgc \n", nUnitId, stLnaStatus.agc, stLnaStatus.baseBandAgc));
	}

	r1 = (stLnaStatus.agc >> 26) & 0x3F;
	r2 = (stLnaStatus.baseBandAgc >> 26) & 0x3F;

#endif

#ifdef SATFE_USE_FLOATING_POINT
	G_lna = (0.5 * (float)(63 - r1)) - 16.0;
	G_rfpga = (0.3 * (float)(63 - r2)) - 1.0;
	/* CH_DI_Print(7, ("G_lna=%f, G_rfpga=%f, G_lna+G_rfpga=%f\n", G_lna, G_rfpga, G_lna+G_rfpga)); */
#else
	G_lna = ((63-r1) << 23) - (16 << 24); /* scaled 2^24 */
	G_rfpga = 300312166 - (r2*5033165);   /* scaled 2^24 */
#endif

	CH_DI_Print(7, ( "nUnitId[%d] r1 = (%x):(%x) = r2 \n", nUnitId, r1, r2));
	CH_DI_Print(7, ( "nUnitId[%d] G_lna=%x, G_rfpga=%x, G_lna+G_rfpga=%x\n", G_lna, G_rfpga, G_lna+G_rfpga));

#if 0
	/* get the BCM3445 IN2 AGC value */
	SATFE_MUTEX(retCode = BAST_GetBcm3445Status(pSocChip->hAstChannel[0], &bcm3445Status));
	if ((bcm3445Status.version != 0) && (bcm3445Status.tuner_input != BAST_Bcm3445OutputChannel_eNone) && (bcm3445Status.out_cfg != BAST_Bcm3445OutputConfig_eOff))
	{
		/* BCM3445 was detected and it is controlled by BCM4506 */
		bcm3445_agc = bcm3445Status.agc;
	}
	else
	bcm3445_agc = 0;
	SATFE_bcm3445_get_input_power(tuner_freq, bcm3445_agc, &P_3445);
	/* CH_DI_Print(7,("r1=%d, r2=%d, BCM3445_AGC=%d(%f)\n", r1, r2, bcm3445_agc, (float)P_3445/16777216.0)); */
//#else
	//P_3445 = 0;
	etNErrorCode = NEXUS_Frontend_Get3445LnaStatus(s_stFrontend[nUnitId], &st3445Status);
	if( etNErrorCode != NEXUS_SUCCESS )
	{
		CH_DI_Print(0, ( "Error!!! [NEXUS_Frontend_Get3445LnaStatus] nUnitId[%d] etNErrorCode = (%d)\n", nUnitId, etNErrorCode));
	}
	CH_DI_Print(7, ( "[NEXUS_Frontend_Get3445LnaStatus] nUnitId[%d] st3445Status.lnaInput = (%x):(%x) = st3445Status.lnaOutput \n", nUnitId, st3445Status.lnaInput, st3445Status.lnaOutput));
	CH_DI_Print(7, ( "[NEXUS_Frontend_Get3445LnaStatus] nUnitId[%d] st3445Status.version = (%x):(%x) = st3445Status.agc \n", nUnitId, st3445Status.version, st3445Status.agc));

	if ((st3445Status.version != 0) && (st3445Status.lnaInput != NEXUS_3445LnaInput_eNone) && (st3445Status.lnaOutput != NEXUS_3445LnaOutput_eNone))
	{
		/* BCM3445 was detected and it is controlled by BCM4506 */
		bcm3445_agc = st3445Status.agc;
	}
	else
	{
		bcm3445_agc = 0;
	}

	SATFE_bcm3445_get_input_power(tuner_freq, bcm3445_agc, &P_3445);
#endif

#if 0
	if (pChip->idx == 0)
#else
	//if (nUnitId == 0)
#endif
	{
		/* internal SDS0/SDS1 in 7346 */
		r3 = (ifagc >> 26) & 0x3F;
		if (r3>=54)
			r3=54;

		G_agt = 0;
#ifdef SATFE_USE_FLOATING_POINT
		G_ifpga = 3.0 - (0.5 * (float)r3);
		G_fga = -15.0;
		G_aif = -20.0 * log10(agf & 0xFFFFFF00);
#else
		G_ifpga = (3<<24) - (r3*(1<<23)); /* scaled 2^24 */
		G_fga = -251658240; /* scaled 2^24 */
		G_aif = -20 * ((SATFE_log10(agf & 0xFFFFFF00) + 8) >> 4); /* scaled 2^24 */
#endif

		if ((agf & 0x0F) != 0x0A)
		{
#ifdef SATFE_USE_FLOATING_POINT
			G_agt = 6.8124;
#else
			G_agt = 114293106;
#endif
		}

		/* non-decimating filter adjustment */
		switch (agf & 0xC0)
		{
			case 0x00: /* quarterband */
				P_ndfctl = 0; /* no adjustment */
				break;
			case 0x40: /* thirdband */
				#ifdef SATFE_USE_FLOATING_POINT
				P_ndfctl = 2.5; /* adjust by 20log10(.75) */
				#else
				P_ndfctl = 41943040; /* adjust by 20log10(.75)*2^24 */
				#endif
				break;
			case 0x80: /* halfband */
				#ifdef SATFE_USE_FLOATING_POINT
				P_ndfctl = 6; /* adjust by 20log10(.5) */
				#else
				P_ndfctl = 6<<24; /* adjust by 20log10(.5)*2^24 */
				#endif
				break;
			default: /* sharpened halfband */
				#ifdef SATFE_USE_FLOATING_POINT
				P_ndfctl = 12; /* adjust by 20log10(.25) */
				#else
				P_ndfctl = 12<<24; /* adjust by 20log10(.25)*2^24 */
				#endif
				break;
		}

		/* tuner_freq adjustment */
#if 0
		if (pChip->currChannel == 0)
#else
		if (nUnitId == 0)
#endif
		{
			/* BCM7346 channel 0 */
#ifdef SATFE_USE_FLOATING_POINT
			if (tuner_freq < 950000000UL)
			P_freq = 34.0;
			else if (tuner_freq < 1060000000UL)
			P_freq = 34.0 + 1.5*(tuner_freq-950000000)/110000000.0;
			else if (tuner_freq < 1200000000UL)
			P_freq = 35.5 - 2.0*(tuner_freq-1060000000UL)/140000000.0;
			else if (tuner_freq < 1400000000UL)
			P_freq = 33.5 + 2.5*(tuner_freq-1200000000UL)/200000000.0;
			else if (tuner_freq < 1570000000UL)
			P_freq = 36.0;
			else if (tuner_freq < 1800000000UL)
			P_freq = 36.0 + 5.0*(tuner_freq-1570000000UL)/230000000.0;
			else if (tuner_freq < 1975000000UL)
			P_freq = 41.0;
			else if (tuner_freq < 2150000000UL)
			P_freq = 41.0 + 3.8*(tuner_freq-1975000000UL)/175000000.0;
			else
			P_freq = 44.8;
			P_freq -= 38.0;
#else
			b = 0;
			c = 0;
			d = 1;
			if (tuner_freq < 950000000UL)
			{
				a = 34<<24;
			}
			else if (tuner_freq < 1060000000UL)
			{
				a = 34<<24;
				b = 25165824; /* 1.5*2^24 */
				c = 950000000;
				d = 110000000;
			}
			else if (tuner_freq < 1200000000UL)
			{
				a = 595591168; /* 35.5*2^24 */
				b = -2 * 16777216;
				c = 1060000000UL;
				d = 140000000;
			}
			else if (tuner_freq < 1400000000UL)
			{
				a = 562036736; /* 33.5*2^24 */
				b = 41943040; /* 2.5*2^24 */
				c = 1200000000UL;
				d = 200000000;
			}
			else if (tuner_freq < 1570000000UL)
			{
				a = 36<<24;
			}
			else if (tuner_freq < 1800000000UL)
			{
				a = 36<<24;
				b = 5<<24;
				c = 1570000000UL;
				d = 230000000;
			}
			else if (tuner_freq < 1975000000UL)
			{
				a = 41<<24;
			}
			else if (tuner_freq < 2150000000UL)
			{
				a = 41<<24;
				b = 63753421; /* 3.8*2^24 */
				c = 1975000000UL;
				d = 175000000;
			}
			else
			{
				a = 751619277; /* 44.8*2^24 */
			}
			/* P_freq = a + (b*(tuner_freq-c)/d); */
			if (b < 0)
				val = -b;
			else
				val = b;
			BAST_MultU32U32(val, tuner_freq - c, &P_hi, &P_lo);
			BAST_DivU64U32(P_hi, P_lo, d, &Q_hi, &Q_lo);
			if (b < 0)
				P_freq = (int32_t)(a - Q_lo);
			else
				P_freq = (int32_t)(a + Q_lo);
			P_freq -= (38<<24);
			#endif
		}
		else
		{
			/* BCM7346 channel 1 */
#ifdef SATFE_USE_FLOATING_POINT
			if (tuner_freq <= 1200000000UL)
			P_freq = 44.0;
			else if (tuner_freq < 1710000000UL)
			P_freq = 44.0 + 2.5*(tuner_freq-1200000000UL)/510000000.0;
			else if (tuner_freq < 1880000000UL)
			P_freq = 46.5 - 11.5*(tuner_freq-1710000000UL)/170000000.0;
			else if (tuner_freq < 1940000000UL)
			P_freq = 35.0 + 3.0*(tuner_freq-1880000000UL)/60000000.0;
			else if (tuner_freq < 2030000000UL)
			P_freq = 38.0 + 11.0*(tuner_freq-1940000000UL)/90000000.0;
			else if (tuner_freq < 2150000000UL)
			P_freq = 49.0 + 3.0*(tuner_freq-2030000000UL)/120000000.0;
			else
			P_freq = 52.0
			P_freq -= 40.5;
#else
			b = 0;
			c = 0;
			d = 1;
			if (tuner_freq <= 1200000000UL)
			{
				a = 44<<24;
			}
			else if (tuner_freq < 1710000000UL)
			{
				a = 44<<24;
				b = 41943040; /* 2.5*2^24 */
				c = 1200000000UL;
				d = 510000000;
			}
			else if (tuner_freq < 1880000000UL)
			{
				a = 780140544; /* 46.5*2^24 */
				b = -192937984; /* -11.5*2^24 */
				c = 1710000000UL;
				d = 170000000;
			}
			else if (tuner_freq < 1940000000UL)
			{
				a = 35<<24;
				b = 3<<24;
				c = 1880000000UL;
				d = 60000000;
			}
			else if (tuner_freq < 2030000000UL)
			{
				a = 38<<24;
				b = 11<<24;
				c = 1940000000UL;
				d = 90000000;
			}
			else if (tuner_freq < 2150000000UL)
			{
				a = 49<<24;
				b = 3<<24;
				c = 2030000000UL;
				d = 120000000;
			}
			else
			{
				a = 52<<24;
			}
			/* P_freq = a + (b*(tuner_freq-c)/d); */
			if (b < 0)
				val = -b;
			else
				val = b;
			BAST_MultU32U32(val, tuner_freq - c, &P_hi, &P_lo);
			BAST_DivU64U32(P_hi, P_lo, d, &Q_hi, &Q_lo);
			if (b < 0)
				P_freq = (int32_t)(a - Q_lo);
			else
				P_freq = (int32_t)(a + Q_lo);
			P_freq -= 679477248; /* 40.5*2^24 */
#endif
		}

		/* adjustment */
#ifdef SATFE_USE_FLOATING_POINT
		P_adj = 135.0;
#else
		P_adj = 135<<24;
#endif

#ifdef SATFE_USE_FLOATING_POINT
		*pPower = G_lna + G_rfpga + G_ifpga + G_fga + G_aif + G_agt + P_ndfctl + ((float)P_3445/16777216.0) + P_freq + P_adj;
#else
		//CH_DI_Print(7, ("P_freq=%f\n", (float)P_freq/16777216.0));
		*pPower = (float)(G_lna + G_rfpga + G_ifpga + G_fga + G_aif + G_agt + P_ndfctl + P_3445 + P_freq + P_adj) / 16777216.0;
#endif
	}

	if(nUnitId == 0)
	{
		if(*pPower > -30)*pPower += TUN0_CAL0;
		else if(*pPower > -40)*pPower += TUN0_CAL1;
		else if(*pPower > -50)*pPower += TUN0_CAL2;
		else if(*pPower > -65)*pPower += TUN0_CAL3;
		else *pPower += TUN0_CAL4;
	}
	else
	{
		if(*pPower > -40)*pPower += TUN1_CAL0;
		else if(*pPower > -50)*pPower += TUN1_CAL1;
		else if(*pPower > -65)*pPower += TUN1_CAL2;
		else *pPower += TUN1_CAL3;
	}

	return;
}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

static HUINT32 GetFreqSearchRange( HUINT32 ulSymbolRate )
{
	HUINT32 ulFreqSearchrange = 0;
	/*************************************
	        Normal Search range                                     Support CI+ Certi
		[Symbolrate]          [Search range]
		45 ~ 20Ms/s =	+/- (10MHz)                            45 ~ 22Ms/s    =	+/- (8MHz)
		20 ~ 18Ms/s =	+/- (8MHz)                              22 ~ 18Ms/s    =	+/- (6MHz)
		18 ~ 11Ms/s =	+/- (6MHz)                              18 ~ 11Ms/s    =	+/- (6MHz)
		11 ~ 8Ms/s	=	+/- (5MHz)                      11 ~ 8Ms/s	=	+/- (5MHz)
		8 ~ 4Ms/s	=	+/- (4MHz)                       8 ~ 4Ms/s	=	+/- (4MHz)
		4 ~ 1Ms/s	=	+/- (3.8MHz)                    4 ~ 1Ms/s	=	+/- (3.8MHz)
	**************************************/

	if(( ulSymbolRate >= 1000) && (ulSymbolRate <= 4000))
	{
		ulFreqSearchrange = 3800000;
	}
	else if(( ulSymbolRate > 4000) && (ulSymbolRate <= 8000))
	{
		ulFreqSearchrange = 4000000;
	}
	else if(( ulSymbolRate > 8000) && (ulSymbolRate <= 11000))
	{
		ulFreqSearchrange = 5000000;
	}
	else if(( ulSymbolRate > 11000) && (ulSymbolRate <= 18000))
	{
		ulFreqSearchrange = 6000000;
	}
#if defined( CONFIG_SUPPORT_CI_PLUS_CERTI )
       else if(( ulSymbolRate > 18000) && (ulSymbolRate <= 22000))
	{
		ulFreqSearchrange = 6000000;
	}
	else if(( ulSymbolRate > 22000) && (ulSymbolRate <= 45000))
	{
		ulFreqSearchrange = 8000000;
	}
	else
	{
		ulFreqSearchrange = 8000000;
	}
#else
	else if(( ulSymbolRate > 18000) && (ulSymbolRate <= 20000))
	{
		ulFreqSearchrange = 8000000;
	}
	else if(( ulSymbolRate > 20000) && (ulSymbolRate <= 45000))
	{
		ulFreqSearchrange = 10000000;
	}
	else
	{
		ulFreqSearchrange = 10000000;
	}
#endif

	return ulFreqSearchrange;
}



static NEXUS_FrontendSatelliteCodeRate GetNexusCodeRate(
	CH_SAT_CodeRate_e		etFecCodeRate
	)
{
	NEXUS_FrontendSatelliteCodeRate etCodeRate = g_cr_scan;

	switch(etFecCodeRate)
	{
		case DI_CH_SCODERATE_AUTO:
			etCodeRate = g_cr_scan;
			break;

		case DI_CH_SCODERATE_1_2:
			etCodeRate = g_cr_1_2;
			break;

		case DI_CH_SCODERATE_2_3:
			etCodeRate = g_cr_2_3;
			break;

		case DI_CH_SCODERATE_3_4:
			etCodeRate = g_cr_3_4;
			break;

		case DI_CH_SCODERATE_5_6:
			etCodeRate = g_cr_5_6;
			break;

		case DI_CH_SCODERATE_7_8:
			etCodeRate = g_cr_7_8;
			break;

		case DI_CH_S2CODERATE_3_5: /** DVB-S2:QPSK DVB-S2:8PSK */
			etCodeRate = g_cr_3_5;
			break;

		case DI_CH_S2CODERATE_4_5:  /** DVB-S2:QPSK */
			etCodeRate = g_cr_4_5;
			break;

		case DI_CH_SCODERATE_5_11:
			etCodeRate = g_cr_5_11;
			break;

		case DI_CH_SCODERATE_6_7:
			etCodeRate = g_cr_6_7;
			break;

		case DI_CH_S2CODERATE_8_9: /** DVB-S2:QPSK 	DVB-S2:8PSK */
			etCodeRate = g_cr_8_9;
			break;

		case DI_CH_S2CODERATE_9_10:  /** DVB-S2:QPSK 	DVB-S2:8PSK */
			etCodeRate = g_cr_9_10;
			break;

		default:
			CH_DI_Print(4, ("[GetNexusCodeRate] default: etCodeRate(%d)!\n", etFecCodeRate));
			break;
	}

	CH_DI_Print(4, ("[GetNexusCodeRate] etFecCodeRate (%d) ->  etCodeRate (%d/%d) \n", etFecCodeRate, etCodeRate.numerator, etCodeRate.denominator));

	return etCodeRate;
}


static NEXUS_FrontendSatelliteMode GetNexusMode(
				CH_SAT_TransportSpec_e	etTransSpec,
				CH_SAT_Modulation_e 	etModulation
)
{
	NEXUS_FrontendSatelliteMode etSatMode = NEXUS_FrontendSatelliteMode_eMax;

	if( etTransSpec == DI_CH_TRANS_DVBS )
	{
		if( etModulation == DI_CH_PSK_QPSK )
		{
			etSatMode = NEXUS_FrontendSatelliteMode_eDvb;
			CH_DI_Print(4, (" NEXUS_FrontendSatelliteMode_eDvb'.. (DVB-S)\n"));
		}
		else
		{
			etSatMode = NEXUS_FrontendSatelliteMode_eDvb;//NEXUS_FrontendSatelliteMode_eDvbScan;
			CH_DI_Print(4, (" NEXUS_FrontendSatelliteMode_eDvbScan'.. (DVB-S, AUTO)\n"));
		}
	}
	else if( etTransSpec == DI_CH_TRANS_DVBS2 )
	{
		if( etModulation == DI_CH_PSK_QPSK )
		{
			etSatMode = NEXUS_FrontendSatelliteMode_eQpskLdpc;
			CH_DI_Print(4, (" NEXUS_FrontendSatelliteMode_eQpskLdpc'.. (DVB-S2, QPSK)\n"));
		}
		else if(etModulation == DI_CH_PSK_8PSK )
		{
			etSatMode = NEXUS_FrontendSatelliteMode_e8pskLdpc;
			CH_DI_Print(4, (" NEXUS_FrontendSatelliteMode_e8pskLdpc'.. (DVB-S2, 8PSK)\n"));
		}
		else
		{
			etSatMode = NEXUS_FrontendSatelliteMode_eBlindAcquisition;//NEXUS_FrontendSatelliteMode_eLdpcScan;
			CH_DI_Print(4, (" NEXUS_FrontendSatelliteMode_eLdpcScan'.. (DVB-S2, AUTO)\n"));
		}
	}
	else
	{
		CH_DI_Print(1, ("[GetNexusMode] ERR! etTransSpec (%d)!\n", etTransSpec));
	}

	return etSatMode;
}

static void ConvertNexusToDiParam( NEXUS_FrontendSatelliteMode etSatMode, NEXUS_FrontendSatelliteCodeRate etCodeRate, CH_SAT_TuneParam_t * pstTuneParam )
{
	if(etSatMode == NEXUS_FrontendSatelliteMode_eDvb)
	{
		pstTuneParam->etTransSpec = DI_CH_TRANS_DVBS;
		pstTuneParam->etModulation	= DI_CH_PSK_QPSK;
		CH_DI_Print(4, ("[DB7346_NexusUpdateInfo] %x : DVBS, QPSK \n", etSatMode));
	}
	else if(etSatMode == NEXUS_FrontendSatelliteMode_eQpskLdpc)
	{
		pstTuneParam->etTransSpec = DI_CH_TRANS_DVBS2;
		pstTuneParam->etModulation	= DI_CH_PSK_QPSK;
		CH_DI_Print(4, ("[DB7346_NexusUpdateInfo] %x : DVBS2, QPSK \n", etSatMode));
	}
	else if(etSatMode == NEXUS_FrontendSatelliteMode_e8pskLdpc)
	{
		pstTuneParam->etTransSpec = DI_CH_TRANS_DVBS2;
		pstTuneParam->etModulation	= DI_CH_PSK_8PSK;
		CH_DI_Print(4, ("[DB7346_NexusUpdateInfo] %x : DVBS2, 8PSK \n", etSatMode));
	}
	else
	{
		pstTuneParam->etModulation	= DI_CH_PSK_AUTO;
	}

	CH_DI_Print(4, ("[DB7346_NexusUpdateInfo] etTransSpec [%d] , etModulation [%d]  \n", pstTuneParam->etTransSpec, pstTuneParam->etModulation ));

	if(etCodeRate.numerator == 1 && etCodeRate.denominator == 2)
		pstTuneParam->etFecCodeRate = DI_CH_SCODERATE_1_2;
	else if(etCodeRate.numerator == 2 && etCodeRate.denominator == 3)
		pstTuneParam->etFecCodeRate = DI_CH_SCODERATE_2_3;
	else if(etCodeRate.numerator == 3 && etCodeRate.denominator == 4)
		pstTuneParam->etFecCodeRate = DI_CH_SCODERATE_3_4;
	else if(etCodeRate.numerator == 5 && etCodeRate.denominator == 6)
		pstTuneParam->etFecCodeRate = DI_CH_SCODERATE_5_6;
	else if(etCodeRate.numerator == 7 && etCodeRate.denominator == 8)
		pstTuneParam->etFecCodeRate = DI_CH_SCODERATE_7_8;
	else if(etCodeRate.numerator == 3 && etCodeRate.denominator == 5)
		pstTuneParam->etFecCodeRate = DI_CH_S2CODERATE_3_5;
	else if(etCodeRate.numerator == 4 && etCodeRate.denominator == 5)
		pstTuneParam->etFecCodeRate = DI_CH_S2CODERATE_4_5;
	else if(etCodeRate.numerator == 8 && etCodeRate.denominator == 9)
		pstTuneParam->etFecCodeRate = DI_CH_S2CODERATE_8_9;
	else if(etCodeRate.numerator == 9 && etCodeRate.denominator == 10)
		pstTuneParam->etFecCodeRate = DI_CH_S2CODERATE_9_10;
	else
	{
		pstTuneParam->etFecCodeRate = DI_CH_SCODERATE_AUTO;
		CH_DI_Print(4, ("DI_CH_SCODERATE_AUTO \n"));
	}

	CH_DI_Print(4, (" etFecCodeRate [%d] \n",  pstTuneParam->etFecCodeRate));

	return;
}

static void ConvertDiToNexusParam( CH_SAT_TuneParam_t *pstSatTuneParam, NEXUS_FrontendSatelliteSettings *pstNexusTuneParam )
{

	if( pstSatTuneParam->etAntennaType == DI_CH_ANT_TYPE_SCD )
	{
		pstNexusTuneParam->frequency = pstSatTuneParam->ulScdUserBandFreq * MHZ_TO_HZ;
	}
	else
	{
		pstNexusTuneParam->frequency = pstSatTuneParam->ulFrequency * MHZ_TO_HZ;//KHZ_TO_HZ;
	}

	pstNexusTuneParam->symbolRate = pstSatTuneParam->ulSymbolRate * KHZ_TO_HZ;

	pstNexusTuneParam->mode = GetNexusMode( pstSatTuneParam->etTransSpec, pstSatTuneParam->etModulation );

	pstNexusTuneParam->codeRate = GetNexusCodeRate(pstSatTuneParam->etFecCodeRate);

	pstNexusTuneParam->searchRange = GetFreqSearchRange(pstSatTuneParam->ulSymbolRate);

	pstNexusTuneParam ->ldpcPilotScan = true;
	pstNexusTuneParam ->ldpcPilot = false;
	pstNexusTuneParam ->ldpcPilotPll = false;

	pstNexusTuneParam->carrierOffset = 0;

	return;
}


static HUINT32 ConvertStrengthLevel(
	NEXUS_FrontendSatelliteMode etSatMode,
	HINT32  nInputPower
)
{
	HUINT32 ulStrength = 0;

	CH_UNUSED(etSatMode);

	CH_DI_Print(4, ("[ConvertStrengthLevel] nInputPower: %d \n", nInputPower));

		if(nInputPower >= -3100)  // < -22dBm
			ulStrength = 100;
		else if( nInputPower >= -3300)  // -26dBm
			ulStrength = 90;
		else if( nInputPower >= -4100)  // -30dBm
			ulStrength = 85;
		else if( nInputPower >= -4600)  // -30dBm
			ulStrength = 80;
		else if( nInputPower >= -5100)  // -34dBm
			ulStrength = 75;
		else if( nInputPower >= -5600)  // -34dBm
			ulStrength = 70;
		else if( nInputPower >= -6000)  // -38dBm
			ulStrength = 60;
		else if( nInputPower >= -6600)  // -42dBm
			ulStrength = 50;
		else if( nInputPower >= -7100)  // -46dBm
			ulStrength = 40;
		else if( nInputPower >= -7300)  // -50dBm
			ulStrength = 30;
		else if( nInputPower >= -7800)  // -54dBm
			ulStrength = 20;
		else
			ulStrength = 10;

	CH_DI_Print(4, ("[ConvertStrengthLevel] => ulStrength: (%d)  \n", ulStrength ));

	return ulStrength;
}



static HUINT32 ConvertQualityLevel(
	NEXUS_FrontendSatelliteMode etSatMode,
	HUINT32 ulInSnr
)
{
	HUINT32 ulQuality = 0;

	CH_DI_Print(4, ("[ConvertQualityLevel] ulInSnr: %d \n", ulInSnr));

	if( etSatMode == NEXUS_FrontendSatelliteMode_eDvb )
	{
		if( ulInSnr > 1100) 		//15 dB
			ulQuality = 100;
		else if( ulInSnr > 1000) 	//14dB
			ulQuality = 90;
		else if( ulInSnr > 900) 	//13dB
			ulQuality = 80;
		else if( ulInSnr > 800) 	//12dB
			ulQuality = 70;
		else if( ulInSnr > 700) 	//11dB
			ulQuality = 60;
		else if( ulInSnr > 600) 	//10dB
			ulQuality = 50;
		else if( ulInSnr > 500)		//9dB
			ulQuality = 40;
		else if( ulInSnr > 400)		//8dB
			ulQuality = 30;
		else if( ulInSnr > 300) 	//7dB
			ulQuality = 20;
		else
			ulQuality = 10;

	}
	else if( etSatMode == NEXUS_FrontendSatelliteMode_eQpskLdpc )
	{
		if( ulInSnr > 1100)
			ulQuality = 100;
		else if( ulInSnr > 1000)
			ulQuality = 90;
		else if( ulInSnr > 900)
			ulQuality = 80;
		else if( ulInSnr > 800)
			ulQuality = 70;
		else if( ulInSnr > 700)
			ulQuality = 60;
		else if( ulInSnr > 600)
			ulQuality = 50;
		else if( ulInSnr > 500)
			ulQuality = 40;
		else if( ulInSnr > 400)
			ulQuality = 30;
		else if( ulInSnr > 300)
			ulQuality = 20;
		else
			ulQuality = 10;

	}
	else //NEXUS_FrontendSatelliteMode_e8pskLdpc
	{
		if( ulInSnr > 1100)
			ulQuality = 100;
		else if( ulInSnr > 1000)
			ulQuality = 90;
		else if( ulInSnr > 900)
			ulQuality = 80;
		else if( ulInSnr > 800)
			ulQuality = 70;
		else if( ulInSnr > 700)
			ulQuality = 60;
		else if( ulInSnr > 600)
			ulQuality = 50;
		else if( ulInSnr > 500)
			ulQuality = 40;
		else if( ulInSnr > 400)
			ulQuality = 30;
		else if( ulInSnr > 300)
			ulQuality = 20;
		else
			ulQuality = 10;

	}

	CH_DI_Print(4, ("[ConvertQualityLevel] => ulQuality: (%d)	\n", ulQuality ));

	return ulQuality;


}

#if defined(SUPPORT_DTG_SIGNAL_DISPLAY)
static HUINT32 ConvertDtgStrengthLevel(
	NEXUS_FrontendSatelliteMode etSatMode,
	HINT32  nInputPower
)
{
	HUINT32 ulStrength = 0;

	CH_UNUSED(etSatMode);

	CH_DI_Print(4, ("[ConvertDtgStrengthLevel] nInputPower: %d \n", nInputPower));

		if(nInputPower >= -2155)  // < -22dBm
			ulStrength = 100;
		else if( nInputPower >= -2569)  // -26dBm
			ulStrength = 90;
		else if( nInputPower >= -3050)  // -30dBm
			ulStrength = 80;
		else if( nInputPower >= -3317)  // -34dBm
			ulStrength = 70;
		else if( nInputPower >= -3785)  // -38dBm
			ulStrength = 60;
		else if( nInputPower >= -4200)  // -42dBm
			ulStrength = 50;
		else if( nInputPower >= -4530)  // -46dBm
			ulStrength = 40;
		else if( nInputPower >= -4995)  // -50dBm
			ulStrength = 30;
		else if( nInputPower >= -5400)  // -54dBm
			ulStrength = 20;
		else if( nInputPower >= -5800)  // -58dBm
			ulStrength = 10;
		else
			ulStrength = 0;

	CH_DI_Print(4, ("[ConvertDtgStrengthLevel] => ulStrength: (%d)  \n", ulStrength ));

	return ulStrength;
}



static HUINT32 ConvertDtgQualityLevel(
	NEXUS_FrontendSatelliteMode etSatMode,
	HUINT32 ulInSnr
)
{
	HUINT32 ulQuality = 0;

	CH_DI_Print(4, ("[ConvertDtgQualityLevel] ulInSnr: %d \n", ulInSnr));

	if( etSatMode == NEXUS_FrontendSatelliteMode_eDvb )
	{
		if( ulInSnr > 1458) 		//15 dB
			ulQuality = 100;
		else if( ulInSnr > 1373) 	//14dB
			ulQuality = 90;
		else if( ulInSnr > 1285) 	//13dB
			ulQuality = 80;
		else if( ulInSnr > 1193) 	//12dB
			ulQuality = 70;
		else if( ulInSnr > 1097) 	//11dB
			ulQuality = 60;
		else if( ulInSnr > 1005) 	//10dB
			ulQuality = 50;
		else if( ulInSnr > 907)		//9dB
			ulQuality = 40;
		else if( ulInSnr > 810)		//8dB
			ulQuality = 30;
		else if( ulInSnr > 712) 	//7dB
			ulQuality = 20;
		else if( ulInSnr > 618) 	//6dB
			ulQuality = 10;
		else 						// <5dB
			ulQuality = 0;
	}
	else if( etSatMode == NEXUS_FrontendSatelliteMode_eQpskLdpc )
	{
		if( ulInSnr > 1520)
			ulQuality = 100;
		else if( ulInSnr > 1420)
			ulQuality = 90;
		else if( ulInSnr > 1335)
			ulQuality = 80;
		else if( ulInSnr > 1236)
			ulQuality = 70;
		else if( ulInSnr > 1144)
			ulQuality = 60;
		else if( ulInSnr > 1045)
			ulQuality = 50;
		else if( ulInSnr > 950)
			ulQuality = 40;
		else if( ulInSnr > 844)
			ulQuality = 30;
		else if( ulInSnr > 760)
			ulQuality = 20;
		else if( ulInSnr > 650)
			ulQuality = 10;
		else
			ulQuality = 0;
	}
	else //NEXUS_FrontendSatelliteMode_e8pskLdpc
	{
		if( ulInSnr > 1691)
			ulQuality = 100;
		else if( ulInSnr > 1590)
			ulQuality = 90;
		else if( ulInSnr > 1500)
			ulQuality = 80;
		else if( ulInSnr > 1410)
			ulQuality = 70;
		else if( ulInSnr > 1310)
			ulQuality = 60;
		else if( ulInSnr > 1220)
			ulQuality = 50;
		else if( ulInSnr > 1125)
			ulQuality = 40;
		else if( ulInSnr > 1020)
			ulQuality = 30;
		else if( ulInSnr > 930)
			ulQuality = 20;
		else if( ulInSnr > 830)
			ulQuality = 10;
		else
			ulQuality = 7;
	}

	CH_DI_Print(4, ("[ConvertDtgQualityLevel] => ulQuality: (%d)	\n", ulQuality ));

	return ulQuality;

}
#endif

static int GetSignalStatus( int nUnitId, DI_CH_SignalQuality_t *pstSignalInfo )
{
	NEXUS_Error 	etNErrorCode = NEXUS_SUCCESS;
	NEXUS_FrontendSatelliteStatus stFrontendStatus;

	float fInputPower;

	HUINT32 ulQuality = 0;
	HUINT32 ulStrength = 0;

	etNErrorCode = NEXUS_Frontend_GetSatelliteStatus(s_stFrontend[nUnitId], &stFrontendStatus);
	if(etNErrorCode != NEXUS_SUCCESS)
	{
		CH_DI_Print(0, ( "[GetSignalStatus] [%d] ERR! NEXUS_Frontend_GetSatelliteStatus (0x%x)",nUnitId, etNErrorCode ));
		return DI_CH_ERR;
	}

	CH_DI_Print(5, ("----------------------------------------------------------------------------------------\n"));
	CH_DI_Print(5, ("frequency            =(%u)Hz\n", stFrontendStatus.frequency                        ));
	CH_DI_Print(5, ("demodLocked          =(%d)\n", stFrontendStatus.demodLocked                      ));
	CH_DI_Print(5, ("bertLocked           =(%d)\n", stFrontendStatus.bertLocked                       ));
	CH_DI_Print(5, ("symbolRate           =(%u)\n", stFrontendStatus.symbolRate                       ));
	CH_DI_Print(5, ("symbolRateError      =(%d)\n", stFrontendStatus.symbolRateError                  ));
	CH_DI_Print(5, ("carrierOffset        =(%d)\n", stFrontendStatus.carrierOffset                    ));
	//CH_DI_Print(5, ("carrierError         =(%d)\n", stFrontendStatus.carrierError                     ));
	CH_DI_Print(5, ("outputBitRate        =(%u)\n", stFrontendStatus.outputBitRate                    ));
	CH_DI_Print(5, ("ifAgcLevel           =(%u)\n", stFrontendStatus.ifAgcLevel                       ));
	CH_DI_Print(5, ("rfAgcLevel           =(%u)\n", stFrontendStatus.rfAgcLevel                       ));
	CH_DI_Print(5, ("intAgcLevel          =(%u)\n", stFrontendStatus.intAgcLevel                      ));
	CH_DI_Print(5, ("snrEstimate          =(%u)(1/100 dB)\n", stFrontendStatus.snrEstimate                      ));
	CH_DI_Print(5, ("berEstimate          =(%u)\n", stFrontendStatus.berEstimate                      ));
	CH_DI_Print(5, ("fecCorrected         =(%u)\n", stFrontendStatus.fecCorrected                     ));
	CH_DI_Print(5, ("fecUncorrected       =(%u)\n", stFrontendStatus.fecUncorrected                   ));
	CH_DI_Print(5, ("fecClean             =(%u)\n", stFrontendStatus.fecClean                         ));
	CH_DI_Print(5, ("bitErrCorrected      =(%u)\n", stFrontendStatus.bitErrCorrected                  ));
	CH_DI_Print(5, ("reacquireCount       =(%u)\n", stFrontendStatus.reacquireCount                   ));
#if (NEXUS_VERSION >= 1290)
	CH_DI_Print(5, ("berErrors            =(%u)\n", stFrontendStatus.berErrorCount                    ));
#else
	CH_DI_Print(5, ("berErrors            =(%u)\n", stFrontendStatus.berErrors                        ));
#endif
	CH_DI_Print(5, ("preViterbiErrorCount =(%u)\n", stFrontendStatus.preViterbiErrorCount             ));
	CH_DI_Print(5, ("mpegErrors           =(%u)\n", stFrontendStatus.mpegErrors                       ));
	CH_DI_Print(5, ("mpegCount            =(%u)\n", stFrontendStatus.mpegCount                        ));
	CH_DI_Print(5, ("----------------------------------------------------------------------------------------\n"));
	CH_DI_Print(5, ("ifAgc                =(0x%x):(%u)\n", stFrontendStatus.ifAgc, stFrontendStatus.ifAgc ));
	CH_DI_Print(5, ("rfAgc                =(0x%x):(%u)\n", stFrontendStatus.rfAgc, stFrontendStatus.rfAgc ));
	CH_DI_Print(5, ("agf                  =(0x%x):(%d)\n", stFrontendStatus.agf, stFrontendStatus.agf     ));
	CH_DI_Print(5, ("----------------------------------------------------------------------------------------\n"));
#if 0
	CH_DI_Print(5, ("agc0                 =(0x%x):(%u)\n", stFrontendStatus.lnaStatus.agc0, stFrontendStatus.lnaStatus.agc0 ));
	CH_DI_Print(5, ("agc1                 =(0x%x):(%u)\n", stFrontendStatus.lnaStatus.agc1, stFrontendStatus.lnaStatus.agc1 ));
	CH_DI_Print(5, ("intConfig            =(0x%x):(%u)\n", stFrontendStatus.lnaStatus.intConfig, stFrontendStatus.lnaStatus.intConfig));
	CH_DI_Print(5, ("extConfig            =(0x%x):(%u)\n", stFrontendStatus.lnaStatus.extConfig, stFrontendStatus.lnaStatus.extConfig));
	CH_DI_Print(5, ("version              =(0x%x):(%u)\n", stFrontendStatus.lnaStatus.version, stFrontendStatus.lnaStatus.version));
	CH_DI_Print(5, ("----------------------------------------------------------------------------------------\n"));
#endif
	CH_DI_Print(5, ("chipId               =(%x)\n", stFrontendStatus.version.chipId                   ));
	CH_DI_Print(5, ("chipVersion          =(%x)\n", stFrontendStatus.version.chipVersion              ));
	CH_DI_Print(5, ("bondingOption        =(%x)\n", stFrontendStatus.version.bondingOption            ));
	CH_DI_Print(5, ("MajVer               =(%x)\n", stFrontendStatus.version.apMicrocodeVersion       ));
	CH_DI_Print(5, ("MinVer               =(%x)\n", stFrontendStatus.version.hostConfigurationVersion ));
	CH_DI_Print(5, ("----------------------------------------------------------------------------------------\n"));

	SATFE_Platform_GetInputPower( nUnitId, stFrontendStatus.ifAgc, stFrontendStatus.agf, stFrontendStatus.frequency, &fInputPower);
	CH_DI_Print(5, ( "[GetSignalStatus] nUnitId[%d]Frontend.mode = (%d) \n", nUnitId, stFrontendStatus.mode));
	CH_DI_Print(5, ( "[GetSignalStatus] nUnitId[%d] fInputPower  = (%f) \n", nUnitId, fInputPower));
	CH_DI_Print(5, ("----------------------------------------------------------------------------------------\n"));

	//ulStrength = ConvertDtgStrengthLevel(stFrontendStatus.mode, (HINT32)(fInputPower*100));
	ulStrength = ConvertStrengthLevel(stFrontendStatus.mode, (HINT32)(fInputPower*100));

	if( stFrontendStatus.demodLocked == true)
	{
		//ulQuality = ConvertDtgQualityLevel(stFrontendStatus.mode, stFrontendStatus.snrEstimate);
		ulQuality = ConvertQualityLevel(stFrontendStatus.mode, stFrontendStatus.snrEstimate);

		pstSignalInfo->fSnr = ((float)(stFrontendStatus.snrEstimate))/100;
		pstSignalInfo->ulAgc = 0;
		pstSignalInfo->ulRfAgc = (HUINT32)stFrontendStatus.rfAgc;
		pstSignalInfo->ulIfAgc = (HUINT32)stFrontendStatus.ifAgc;
		pstSignalInfo->ulUnCorrectedNo = stFrontendStatus.fecUncorrected;
		pstSignalInfo->fSignalInputPower = fInputPower;
		pstSignalInfo->fBer = stFrontendStatus.berEstimate;
		pstSignalInfo->ulQuality = ulQuality;
		pstSignalInfo->ulStrength = ulStrength;
	}
	else
	{
		/* demod unlock */
		pstSignalInfo->fSnr = 0;
		pstSignalInfo->ulAgc = 0;
		pstSignalInfo->ulRfAgc = 0;
		pstSignalInfo->ulIfAgc = 0;
		pstSignalInfo->ulUnCorrectedNo = 0;
		pstSignalInfo->fSignalInputPower = 0;
		pstSignalInfo->fBer = 0;
		pstSignalInfo->ulQuality = 0;
		pstSignalInfo->ulStrength = ulStrength;

		CH_DI_Print(1, ( "[GetSignalStatus] [%d] Demod UnLocked \n", nUnitId));
	}
	return DI_CH_OK;
}


static void DiseqcCompleteCallback(void *data, int unused)
{
	BSTD_UNUSED(data);
	BSTD_UNUSED(unused);
}



static HUINT32 GetOduSetupTime( int nChannelId, CH_SAT_TuneParam_t *pstSatTuneParam )
{
	HUINT32 ulSetupTime = 0;
	CH_SAT_TuneParam_t * pstPreviousLockedaram;

	pstPreviousLockedaram	= (CH_SAT_TuneParam_t *)GetPreviousLockedTuneInfo(nChannelId);

	if((pstPreviousLockedaram->ulFrequency == pstSatTuneParam->ulFrequency)
		&&(pstPreviousLockedaram->ulSymbolRate == pstSatTuneParam->ulSymbolRate))
	{
		if(pstSatTuneParam->etAntennaType == DI_CH_ANT_TYPE_DISEQC)
		{
			if((pstPreviousLockedaram->etDiseqcInput != pstSatTuneParam->etDiseqcInput)
				||(pstPreviousLockedaram->etPolarization != pstSatTuneParam->etPolarization)
				||(pstPreviousLockedaram->b22kTone != pstSatTuneParam->b22kTone))
			{
				ulSetupTime = ODU_SETUP_TIME_DISEQC;
			}
			else
			{
				CH_DI_Print(3, (">>>>> Same TP in DISEQC!!! \n"));
			}
		}
		else if(pstSatTuneParam->etAntennaType == DI_CH_ANT_TYPE_LNB)
		{
			if((pstPreviousLockedaram->etPolarization != pstSatTuneParam->etPolarization)
				||(pstPreviousLockedaram->b22kTone != pstSatTuneParam->b22kTone))
			{
				ulSetupTime = ODU_SETUP_TIME_LNB;
			}
			else
			{
				CH_DI_Print(3, (">>>>> Same TP in LNB!!! \n"));
			}
		}
		else // SCD
		{
			ulSetupTime = ODU_SETUP_TIME_DISEQC;
		}
	}
	else
	{
		CH_DI_Print(3, (">>>>> Skip : ODU_SETUP_TIME \n"));
	}

	CH_DI_Print(3, ("<<<<< ODU_SETUP_TIME (%d) \n", ulSetupTime));
	return ulSetupTime;

}



#define __DB7346_PUBLIC_FUNCITONS__

/*********************** External Function ***********************/
void DRV_S_InstallApi( void )
{
	NIM_InitDevice 			= &DB7346_InitDevice;
	NIM_SetTune 			= &DB7346_SetTune;
	NIM_CheckTuneState 		= &DB7346_CheckTuneState;
	NIM_CheckLock 			= &DB7346_CheckLock;
	NIM_GetSignalInfo 		= &DB7346_GetSignalInfo;
	NIM_SetPowerState 		= &DB7346_SetPowerState;
	NIM_EnableTsOutput 		= &DB7346_EnableTsOutput;
	NIM_DisableTsOutput 	= &DB7346_DisableTsOutput;
	NIM_SendDiseqcMsg 		= &DB7346_SendDiseqcMsg;
	NIM_UpdateTunedParam	= &DB7346_UpdateTunedParam;
	NIM_SetInputMode		= &DB7346_SetInputMode;
	NIM_SetInputSource		= &DB7346_SetInputSource;

	NIM_SetToneBurst		= &DB7346_SetToneBurst;

	LNB_Get22KhzTone		= &DB7346_LnbGet22KhzTone;
	LNB_Set22KhzTone		= &DB7346_LnbSet22KhzTone;

	LNB_InitDevice 			= &DRV_CH_LNB_Init;
	LNB_SetOutput			= &DRV_CH_LNB_SetOutput;
	LNB_SetPolarisation 	= &DRV_CH_LNB_SetPolar;
	LNB_CheckAntState		= &DRV_CH_LNB_CheckAntState;
	return;
}



int DB7346_InitDevice( int nChannelId )
{
	int				 nUnitId;
	NEXUS_Error 	etNErrorCode = NEXUS_SUCCESS;
	NEXUS_PlatformConfiguration platformConfig;

	nUnitId = GetDeviceUnitId( nChannelId );

	NEXUS_Platform_GetConfiguration(&platformConfig);

	s_stFrontend[nUnitId] = platformConfig.frontend[nUnitId];

	if( NULL == s_stFrontend[nUnitId] )
	{
		CH_DI_Print(0, ("[DB7346_InitDevice] ERR! Unable to find Satellite-capable frontend\n"));
		return DI_CH_ERR;
	}

	//CH_DI_Print(4,("CH[%d] s_stFrontend (%x), frontend(0x%x) \n", nUnitId, s_stFrontend[nUnitId], platformConfig.frontend[nUnitId] ));

	/* PKT_CLK runs continuously.*//* false=CLK runs continuously, true=CLK is suppressed when VALID not active */
	etNErrorCode = NEXUS_Frontend_SetXportCtrl(s_stFrontend[nUnitId], FALSE);
	if(etNErrorCode != NEXUS_SUCCESS)
	{
		CH_DI_Print(0, ( "[DB7346_InitDevice] [%d] ERR! NEXUS_Frontend_SetXportCtrl() Error Code(0x%x)",nUnitId, etNErrorCode ));
		return DI_CH_ERR;
	}

	return DI_CH_OK;
}



int DB7346_SetTune( int nChannelId, CH_SAT_TuneParam_t *pstSatTuneParam )
{
	NEXUS_Error 	etNErrorCode = NEXUS_SUCCESS;
	NEXUS_FrontendSatelliteSettings satSettings;
	int nUnitId = 0;
	HUINT32 ulOduSetupTime = 0;

	nUnitId = GetDeviceUnitId( nChannelId );

	/* Reset(Untune) Before Settune  */
	NEXUS_Frontend_Untune(s_stFrontend[nUnitId]);

	//CH_DI_Print("4, (nUnitId(%d), frontend(%x) \n", nUnitId , frontend));

	NEXUS_Frontend_GetDefaultSatelliteSettings(&satSettings);

	ConvertDiToNexusParam( pstSatTuneParam, &satSettings);

	#if 0 // TODO:
	/* RS Stuff byte*/
	etNErrorCode = NEXUS_Frontend_SetStuffBytes(s_stFrontend[nUnitId], &ucStuffByte);// (16byte)
	if(etNErrorCode != NEXUS_SUCCESS)
	{
		CH_DI_Print(0, ( "[DB7346_SetTune] [%d] ERR! NEXUS_Frontend_SetStuffBytes() Error Code(0x%x)",nUnitId, etNErrorCode ));
		return DI_CH_ERR;
	}
	#endif

	ulOduSetupTime = GetOduSetupTime(nChannelId, pstSatTuneParam);
	if(ulOduSetupTime != 0)
	{
		VK_TASK_Sleep( ulOduSetupTime );
	}

	//satSettings.lockCallback.callback = lock_callback;
	//satSettings.lockCallback.context = frontend;

	CH_DI_Print(2, ("\n ############	Tuning NEXUS_Frontend_Satellite ############ \n"));

	#ifdef CH_PRINT_LOW_LEVEL_ZAPPING_TIME
	g_ulRequestTune[nUnitId] = VK_TIMER_GetSystemTick();
	#endif
	etNErrorCode = NEXUS_Frontend_TuneSatellite(s_stFrontend[nUnitId], &satSettings);
	if(etNErrorCode != NEXUS_SUCCESS)
	{
		CH_DI_Print(0, ( "[DB7346_SetTune] [%d] ERR! NEXUS_Frontend_TuneSatellite() Error Code(0x%x)",nUnitId, etNErrorCode ));
		return DI_CH_ERR;
	}

	return DI_CH_OK;
}



int DB7346_CheckTuneState( int nChannelId, CH_SAT_TransportSpec_e etSatSystem, HUINT32 ulSymbolRate )
{
	HBOOL	 bLockStatus = FALSE;
	int i;
	int nDelay = 0;
	int nRetryCount = 0;
	int nUnitId;
	CH_Status_e etCurrentState;

	nUnitId = GetDeviceUnitId( nChannelId );

	if( etSatSystem == DI_CH_TRANS_DVBS )
	{
		if( (ulSymbolRate < LOW_SYMBOL_RATE_LIMIT) ||
		(ulSymbolRate > HIGH_SYMBOL_RATE_LIMIT) )
		{
			//100*35 = 3500ms
			nDelay = 100;
			nRetryCount = 35;
		}
		else
		{
			//100*20 = 2000ms
			nDelay = 100;
			nRetryCount = 20;
		}
	}
	else //DI_CH_TRANS_DVBS2
	{
		if( (ulSymbolRate < LOW_SYMBOL_RATE_LIMIT) ||
		(ulSymbolRate > HIGH_SYMBOL_RATE_LIMIT) )
		{
			//100*40 = 4000ms
			nDelay = 100;
			nRetryCount = 40;
		}
		else
		{
			//100*30 = 3000ms
			nDelay = 100;
			nRetryCount = 30;
		}
	}

	CH_DI_Print(3, ("nDelay [%d]:[%d] nRetryCount\n", nDelay, nRetryCount));
	VK_TASK_Sleep(MIN_WAIT_DELAY);

	for( i=0; i<nRetryCount; i++ )
	{
		etCurrentState =	GetTuneStatus(nChannelId);
		if( ( etCurrentState == CH_STATUS_IDLE) || (etCurrentState == CH_STATUS_CANCLE) )
		{
			CH_DI_Print(1, ("Cancel locking status...\n"));
			return DI_CH_CANCEL_TUNE;
		}

		bLockStatus = DB7346_CheckLock( nChannelId );
		CH_DI_Print(3, ("[%d] bLockStatus : %d [%d]\n", nChannelId, bLockStatus, i));

		if( bLockStatus == TRUE )
		{
			#ifdef CH_PRINT_LOW_LEVEL_ZAPPING_TIME
			g_ulLowLevelLockedTime[nChannelId] = VK_TIMER_GetSystemTick();
			CH_DI_Print(0, ("[DB7346_CheckTuneState] [%d] Lock Time( %d )ms  \n" ,nChannelId, g_ulLowLevelLockedTime[nChannelId] - g_ulRequestTune[nChannelId] ));
			#endif
			CH_DI_Print(1, (">>>>>>>>>>>>>>>>>ACQ_LOCKED_AND_TRACKING [%d ms] \n", (i * nDelay)));
			return DI_CH_OK;
		}
		else
		{
			VK_TASK_Sleep(nDelay);
		}
	}

	#ifdef CH_PRINT_LOW_LEVEL_ZAPPING_TIME
	g_ulLowLevelUnlockedTime[nChannelId] = VK_TIMER_GetSystemTick();
	CH_DI_Print(0, ("[DB7346_CheckTuneState] [%d] UnLock Time( %d )ms  \n", nChannelId, g_ulLowLevelUnlockedTime[nChannelId] - g_ulRequestTune[nChannelId] ));
	#endif

	return DI_CH_ERR;

}



HBOOL DB7346_CheckLock( int nChannelId )
{
	int nRet =FALSE ;
	HUINT8 nUnitId;
	NEXUS_Error etNErrorCode = NEXUS_SUCCESS;
	NEXUS_FrontendSatelliteStatus status;
#if defined(DEBUG_SSI_SQI)
	DI_CH_SignalQuality_t stSignalInfo;
#endif
	nUnitId = GetDeviceUnitId( nChannelId );

	etNErrorCode = NEXUS_Frontend_GetSatelliteStatus(s_stFrontend[nUnitId], &status);
	if(etNErrorCode != NEXUS_SUCCESS)
	{
		CH_DI_Print(0, ( "[DB7346_CheckLock] [%d] ERR! NEXUS_Frontend_GetSatelliteStatus() Error Code(0x%x)",nUnitId, etNErrorCode ));
	}
	else
	{
		CH_DI_Print(6, ("----------------------------------------------------------------------------------------\n"));
		CH_DI_Print(6, ( " chipId : chipVersion = [0x%x]:[0x%x] \n", status.version.chipId, status.version.chipVersion));
		CH_DI_Print(6, ("----------------------------------------------------------------------------------------\n"));
		CH_DI_Print(6, ("----------------------------------------------------------------------------------------\n"));
		CH_DI_Print(6, ( " apMicrocodeVersion = [Major:Minor][0x%x:0x%x]\n", status.version.apMicrocodeVersion, status.version.hostConfigurationVersion));
		CH_DI_Print(6, ("----------------------------------------------------------------------------------------\n"));

		CH_DI_Print(6, ("[DB7346_CheckLock] (%d) status.tunerLocked (%d)\n",nUnitId ,status.tunerLocked));
		CH_DI_Print(6, ("[DB7346_CheckLock] (%d) status.demodLocked (%d)\n",nUnitId , status.demodLocked));
		CH_DI_Print(6, ("[DB7346_CheckLock] (%d) status.bertLocked (%d)\n",nUnitId, status.bertLocked));

		if ( status.demodLocked == TRUE )
		{
			//LOCK
			nRet = TRUE;
			CH_DI_Print(6, (">>>>> LOCK [%d] <<<<<	\n", nUnitId));
		}
		else
		{
			//unlock
			nRet = FALSE;
			CH_DI_Print(6, (">>>>> UNLOCK [%d]<<<<<  \n",nUnitId));
		}
	}
#if defined(DEBUG_SSI_SQI)
	GetSignalStatus( nUnitId, &stSignalInfo );
#endif
	return(nRet);
}



int DB7346_GetSignalInfo( int nChannelId, DI_CH_SignalQuality_t *pstSignalInfo )
{
	int nResult = DI_CH_OK;
	int nUnitId;

	nUnitId = GetDeviceUnitId( nChannelId );

	nResult = GetSignalStatus( nUnitId, pstSignalInfo);

	return nResult;
}



int DB7346_SetPowerState( int nChannelId, CH_Power_e etPower )
{
	int nResult = DI_CH_OK;
	int nUnitId;
	//	BERR_Code etNErrorCode = BERR_SUCCESS;
	//	BAST_P_ChannelHandle *pstChannelHandle;

	nUnitId = GetDeviceUnitId( nChannelId );

	if( etPower == CH_POWER_OFF ) // set standby
	{
		CH_DI_Print(2, (">>>>>NEXUS_PowerDown <<<<< \n"));
		/*
		//DEV_TUNER_LOCK();
		//etBErrorCode = BAST_PowerDown(s_stBastChannelHandle[nUnitId], BAST_CORE_SDS);
		//DEV_TUNER_UNLOCK();
		if(etBErrorCode != BERR_SUCCESS)
		{
		CH_DI_Print(0, ( "nUnitId(%d): etBErrorCode(0x%x)", nUnitId, etBErrorCode ));
		nResult = DI_CH_ERR;
		}
		*/
	}
	else // unset standby
	{
		CH_DI_Print(2, (">>>>>NEXUS_PowerUp <<<<<< \n"));
		/*
		//DEV_TUNER_LOCK();
		//etBErrorCode = BAST_PowerUp(s_stBastChannelHandle[nUnitId], BAST_CORE_SDS);
		//DEV_TUNER_UNLOCK();
		if(etNErrorCode != BERR_SUCCESS)
		{
		CH_DI_Print(0, ( "nUnitId(%d): etBErrorCode(0x%x)", nUnitId, etBErrorCode) );
		nResult = DI_CH_ERR;
		}
		*/
	}

	return nResult;
}



int DB7346_EnableTsOutput( int nChannelId )
{
	//NEXUS_Error 	etNErrorCode = NEXUS_SUCCESS;
	int nUnitId;

	nUnitId = GetDeviceUnitId( nChannelId );

	CH_DI_Print(2, ("[%d] Enable TS Output ===== \n", nUnitId));
	#if 0
	etNErrorCode = NEXUS_Frontend_SetTsOutput(s_stFrontend[nUnitId], true);
	if(etNErrorCode != NEXUS_SUCCESS)
	{
		CH_DI_Print(0, ( "[DB7346_EnableTsOutput] [%d] ERR! NEXUS_Frontend_SetTsOutput()  Error Code(0x%x)", nUnitId, etNErrorCode));
		return DI_CH_ERR;
	}
	#endif
	return DI_CH_OK;
}



int DB7346_DisableTsOutput( int nChannelId )
{
	NEXUS_Error 	etNErrorCode = NEXUS_SUCCESS;
	int nUnitId;

	nUnitId = GetDeviceUnitId( nChannelId );

	CH_DI_Print(2, ("[%d] Disable TS Output ===== \n", nUnitId));

	etNErrorCode = NEXUS_Frontend_SetTsOutput(s_stFrontend[nUnitId], false);
	if(etNErrorCode != NEXUS_SUCCESS)
	{
		CH_DI_Print(0, ( "[DB7346_DisableTsOutput] [%d] ERR! NEXUS_Frontend_SetTsOutput()  Error Code(0x%x)", nUnitId, etNErrorCode));
		return DI_CH_ERR;
	}

	return DI_CH_OK;

}


int DB7346_SetToneBurst(int nChannelId, HBOOL b22kTone, CH_SAT_DiseqcInput_e etInput, CH_SAT_AntennaType_e etAntennaType, CH_SAT_DiseqcVer_e etDiseqcVer )
{
	int nResult	= DI_CH_OK;
	int nRfInputId;

	NEXUS_Error 	etNErrorCode = NEXUS_SUCCESS;

	nRfInputId = GetRfInputId( nChannelId );

	CH_UNUSED(etAntennaType);
	CH_UNUSED(etDiseqcVer);

	NEXUS_FrontendDiseqcSettings diseqcSettings;

	NEXUS_Frontend_GetDiseqcSettings(s_stFrontend[nRfInputId], &diseqcSettings);

	diseqcSettings.toneEnabled = b22kTone;
	diseqcSettings.toneMode = NEXUS_FrontendDiseqcToneMode_eEnvelope;
	diseqcSettings.replyDisabled = TRUE;

	switch( etInput )
	{
		case DI_CH_DISEQC_INPUT_A:
		case DI_CH_DISEQC_INPUT_C:
		case DI_CH_DISEQC_INPUT_TB_A:
			diseqcSettings.toneBurst = NEXUS_FrontendDiseqcToneBurst_eUnmodulated;
			break;

		case DI_CH_DISEQC_INPUT_B:
		case DI_CH_DISEQC_INPUT_D:
		case DI_CH_DISEQC_INPUT_TB_B:
			diseqcSettings.toneBurst = NEXUS_FrontendDiseqcToneBurst_eNominal;
			break;

		case DI_CH_DISEQC_INPUT_SCD_A:
		case DI_CH_DISEQC_INPUT_SCD_B:
		case DI_CH_DISEQC_INPUT_NONE:
			diseqcSettings.toneBurst = NEXUS_FrontendDiseqcToneBurst_eNone;
		default:
			break;
	}

	etNErrorCode = NEXUS_Frontend_SetDiseqcSettings(s_stFrontend[nRfInputId], &diseqcSettings);
	if(etNErrorCode != NEXUS_SUCCESS)
	{
		CH_DI_Print(0, ( "[DB7346_SetToneBurst] [%d] ERR! NEXUS_Frontend_SetDiseqcSettings() ErrorCode(0x%x), etInput(%d) \n",nRfInputId, etNErrorCode, etInput ));
		nResult = DI_CH_ERR;
	}

	return nResult;
}


int DB7346_SendDiseqcMsg(
int nChannelId,
HUINT8 *pucSendBuf,
HUINT8 ucNumOfBuf,
CH_SAT_DiseqcInput_e etDiseqcInput
)
{
	NEXUS_Error 	etNErrorCode = NEXUS_SUCCESS;
	NEXUS_CallbackDesc 	callback;
	int i;
	int 			nRfInputId;

	nRfInputId = GetRfInputId( nChannelId );

	VK_memset(&callback, 0, sizeof(NEXUS_CallbackDesc));

	callback.callback = DiseqcCompleteCallback;
	callback.context = s_stFrontend[nRfInputId];

	CH_UNUSED(etDiseqcInput);

	etNErrorCode = NEXUS_Frontend_ResetDiseqc(s_stFrontend[nRfInputId],0);
	if(etNErrorCode != NEXUS_SUCCESS)
	{
		CH_DI_Print(0, ( "[DB7346_SendDiseqcCommand] [%d] NEXUS_Frontend_ResetDiseqc() Error Code(0x%x)", nRfInputId, etNErrorCode));
		return DI_CH_ERR;
	}

#if 0 //TODO_ILEE
	VK_TASK_Sleep(10 );//Delay for Diseqc Msg Initial Reset Timing
	CH_DI_Print(0, ("===== DiseqcMessage ChannelId[%d]:[%d]nUnitId =====\n", nChannelId, nUnitId));
#endif
	CH_DI_Print(3, ("[%d] ===== DiseqcMessage Length(%d) =====\n", nChannelId, ucNumOfBuf));

	if(show_di_ch > 2)
	{
		for( i=0; i<ucNumOfBuf; i++)
		{
			DI_UART_Print("[%02x] ", pucSendBuf[i]);
		}
	}
	CH_DI_Print(3, ("\n===== DiseqcMessage End =======\n"));

	etNErrorCode = NEXUS_Frontend_SendDiseqcMessage(s_stFrontend[nRfInputId], pucSendBuf, ucNumOfBuf, &callback);
	if(etNErrorCode != NEXUS_SUCCESS)
	{
		CH_DI_Print(0, ( "[DB7346_SendDiseqcCommand] [%d] NEXUS_Frontend_SendDiseqcMessage() Error Code(0x%x)", nRfInputId, etNErrorCode));
		return DI_CH_ERR;
	}

return DI_CH_OK;
}



int DB7346_UpdateTunedParam( int nChannelId, CH_SAT_TuneParam_t * pstTuneParam )
{
	int   nResult = DI_CH_OK;
	int 	nUnitId;

	NEXUS_Error 	etNErrorCode = NEXUS_SUCCESS;
	NEXUS_FrontendSatelliteStatus stStatus;

	nUnitId = GetDeviceUnitId( nChannelId );

	if( (pstTuneParam->etFecCodeRate == DI_CH_SCODERATE_AUTO)
	|| (pstTuneParam->etModulation == DI_CH_PSK_AUTO) )
	{

		CH_DI_Print(4, ("[DB7346_UpdateTunedParam] ============================ \n"));

		etNErrorCode = NEXUS_Frontend_GetSatelliteStatus(s_stFrontend[nUnitId], &stStatus);
		if(etNErrorCode == NEXUS_SUCCESS)
		{
			ConvertNexusToDiParam(stStatus.mode, stStatus.codeRate, pstTuneParam );
		}
		else
		{
			CH_DI_Print(0, ("[DB7346_UpdateTunedParam] [%d] ERR! NEXUS_Frontend_GetSatelliteStatus() Error Code(0x%x) \n ", nUnitId, etNErrorCode));
			nResult = DI_CH_ERR;
		}
	}

	return nResult;

}



int DB7346_SetInputMode( int nChannelId, CH_SAT_InputMode_e etInputMode )
{
	int 			nUnitId;
	NEXUS_Error 	etNErrorCode = NEXUS_SUCCESS;
	NEXUS_7346LnaSettings stLnaSettings;

	nUnitId = GetDeviceUnitId( nChannelId );

	if(etInputMode == DI_CH_INPUT_ONE_SAME)
	{
		stLnaSettings.out0  = NEXUS_7346LnaOutput_eOut0;
		stLnaSettings.out1  = NEXUS_7346LnaOutput_eOut0;
		stLnaSettings.daisy = NEXUS_7346LnaOutput_eNone;
	}
	else if(etInputMode == DI_CH_INPUT_TWO_DIFF)
	{
		stLnaSettings.out0  = NEXUS_7346LnaOutput_eOut0;
		stLnaSettings.out1  = NEXUS_7346LnaOutput_eOut1;
		stLnaSettings.daisy = NEXUS_7346LnaOutput_eNone;
	}
	else
	{
		CH_DI_Print(0, ( "[DB7346_SetInputMode] [%d] ERR! etInputMode(%d) \n",nUnitId, etInputMode ));
		return DI_CH_NOT_SUPPORTED;
	}

	etNErrorCode = NEXUS_Frontend_Set7346LnaSettings(s_stFrontend[nUnitId], &stLnaSettings);
	if(etNErrorCode != NEXUS_SUCCESS)
	{
		CH_DI_Print(0, ( "[DB7346_SetInputMode] [%d] ERR! NEXUS_Frontend_Set7346LnaSettings() ErrorCode(0x%x), etInputMode(%d) \n",nUnitId, etNErrorCode, etInputMode ));
	}

	return etNErrorCode;
}



int DB7346_SetInputSource( int nChannelId, DI_CH_InputSource_e etInputSource )
{
	int 			nUnitId;
	NEXUS_Error 	etNErrorCode = NEXUS_SUCCESS;
	NEXUS_7346LnaSettings stLnaSettings;

	nUnitId = GetDeviceUnitId( nChannelId );

	if(etInputSource >= DI_CH_RF_INPUTMAX)
	{
		return DI_CH_PARAM_ERR;
	}

	CH_DI_Print(0, ( "[DB7346_SetInputSource] nUnitId[%d] : etInputSource(%d) \n",nUnitId, etInputSource ));

	if((nUnitId == MASTER_UNIT)&&(etInputSource == DI_CH_RF_INPUT2))
	{
		return DI_CH_HW_RESTRICTION;
	}

	if(nUnitId != MASTER_UNIT)
	{
		if(etInputSource == DI_CH_RF_INPUT1)
		{
			stLnaSettings.out0  = NEXUS_7346LnaOutput_eOut0;
			stLnaSettings.out1  = NEXUS_7346LnaOutput_eOut0;
			stLnaSettings.daisy = NEXUS_7346LnaOutput_eNone;
		}
		else if((etInputSource == DI_CH_RF_INPUT2) || (etInputSource == DI_CH_RF_INPUTLT))
		{
			stLnaSettings.out0  = NEXUS_7346LnaOutput_eOut0;
			stLnaSettings.out1  = NEXUS_7346LnaOutput_eOut1;
			stLnaSettings.daisy = NEXUS_7346LnaOutput_eNone;
		}
		else
		{
			CH_DI_Print(0, ( "[DB7346_SetInputSource] [%d] ERR! etInputSource(%d) \n",nUnitId, etInputSource ));
			return DI_CH_NOT_SUPPORTED;
		}

		etNErrorCode = NEXUS_Frontend_Set7346LnaSettings(s_stFrontend[nUnitId], &stLnaSettings);
		if(etNErrorCode != NEXUS_SUCCESS)
		{
			CH_DI_Print(0, ( "[DB7346_SetInputSource] [%d] ERR! NEXUS_Frontend_Set7346LnaSettings() ErrorCode(0x%x), etInputMode(%d) \n",nUnitId, etNErrorCode, etInputSource ));
		}
		else
		{
			SetRfInputId(nChannelId, etInputSource);
		}

	}

	return etNErrorCode;
}



HBOOL DB7346_LnbGet22KhzTone( int nChannelId )
{
	int 			nRfInputId;

	nRfInputId = GetRfInputId( nChannelId );

	return s_stLnbState[nRfInputId].bToneEnabled;

}



int DB7346_LnbSet22KhzTone( int nChannelId, HBOOL b22kTone )
{
	int nResult = DI_CH_OK;
	int nRfInputId;
	NEXUS_Error 	etNErrorCode = NEXUS_SUCCESS;

	nRfInputId = GetRfInputId( nChannelId );

	NEXUS_FrontendDiseqcSettings diseqcSettings;

	NEXUS_Frontend_GetDiseqcSettings(s_stFrontend[nRfInputId], &diseqcSettings);

	diseqcSettings.toneMode = NEXUS_FrontendDiseqcToneMode_eEnvelope;
	diseqcSettings.toneEnabled = (bool)b22kTone;
	//CH_DI_Print( "s_stFrontend (0x%x), frontend(0x%x) \n", s_stFrontend, frontend );

	etNErrorCode = NEXUS_Frontend_SetDiseqcSettings(s_stFrontend[nRfInputId], &diseqcSettings);
	if(etNErrorCode != NEXUS_SUCCESS)
	{
		CH_DI_Print(0, ( "[DB7346_LnbSet22KhzTone] [%d] ERR! NEXUS_Frontend_SetDiseqcSettings() ErrorCode(0x%x), bDiseqcTone(%d) \n",nRfInputId, etNErrorCode, diseqcSettings.toneEnabled ));
		return DI_CH_ERR;
	}

	s_stLnbState[nRfInputId].bToneEnabled = b22kTone;

	return nResult;
} // end of drv_channel_LNB22KHzTone


/*********************** End of File ******************************/

