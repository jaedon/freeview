/***************************************************************************
 *     Copyright (c) 2004-2008, Broadcom Corporation
 *     All Rights Reserved
 *     Confidential Property of Broadcom Corporation
 *
 *  THIS SOFTWARE MAY ONLY BE USED SUBJECT TO AN EXECUTED SOFTWARE LICENSE
 *  AGREEMENT  BETWEEN THE USER AND BROADCOM.  YOU HAVE NO RIGHT TO USE OR
 *  EXPLOIT THIS MATERIAL EXCEPT SUBJECT TO THE TERMS OF SUCH AN AGREEMENT.
 *
 * $brcm_Workfile: bvdc_pepcms_priv.c $
 * $brcm_Revision: Hydra_Software_Devel/14 $
 * $brcm_Date: 7/30/08 11:36a $
 *
 * [File Description:]
 *
 * Revision History:
 *
 * $brcm_Log: /magnum/portinginterface/vdc/7038/bvdc_pepcms_priv.c $
 * 
 * Hydra_Software_Devel/14   7/30/08 11:36a tdo
 * PR45181: Implement New Dynamic Contrast Algorithm
 *
 * Hydra_Software_Devel/13   2/14/08 4:33p tdo
 * PR39331, PR39332: Regroup PEP block to add support for 3548
 *
 * Hydra_Software_Devel/12   2/8/08 4:48p tdo
 * PR39420: use uint16_t instead of uint32_t to reduce
 * bvdc_pepcmstable_priv module size
 *
 * Hydra_Software_Devel/11   12/5/07 9:07p tdo
 * PR37550: Fix STACK_USE coverity issue
 *
 * Hydra_Software_Devel/10   11/19/07 2:00p tdo
 * PR37046: changing the large memory block allocation method from stack
 * to heap
 *
 * Hydra_Software_Devel/9   9/20/07 1:19a albertl
 * PR35135:  Cleaned up color space matrices and changed them to use same
 * macro system.  Added color space conversion functionality to graphics
 * windows.
 *
 * Hydra_Software_Devel/8   7/13/07 9:17a tdo
 * PR32853: Extending precisions for fix point math due to adjusting the
 * cms input ranges
 *
 * Hydra_Software_Devel/7   7/10/07 11:16p tdo
 * PR32853: Use existing macro defines in bvdc_common_priv.h for MIN and
 * MAX
 *
 * Hydra_Software_Devel/6   7/10/07 10:11p tdo
 * PR32853: More change to CMS gain calculation to match BBS tool
 *
 * Hydra_Software_Devel/5   7/10/07 6:12p tdo
 * PR32853: Extending the range of CMS saturation and hue gains to match
 * BBS3.0 tool
 *
 * Hydra_Software_Devel/4   6/6/07 11:39a tdo
 * PR28978: Fix range for hue gain
 *
 * Hydra_Software_Devel/3   6/1/07 7:04p tdo
 * PR28978: Fix for adjusting sat and hue for each color independently
 *
 * Hydra_Software_Devel/2   5/31/07 8:37p tdo
 * PR28978: Fix some initialization problem
 *
 * Hydra_Software_Devel/1   5/31/07 3:21p tdo
 * PR28978: C0: Provide API to realize CMS function
 *
 ***************************************************************************/
#include "bvdc_compositor_priv.h"
#include "bvdc_pep_priv.h"

BDBG_MODULE(BVDC_PEP);

#if (BVDC_P_SUPPORT_PEP && BVDC_P_SUPPORT_PEP_VER <= BVDC_P_SUPPORT_PEP_VER_3)

#define ANGLE_INT_BIT      5
#define ANGLE_FRA_BIT      10
#define PI                 BMTH_FIX_SIGNED_GET_PI(ANGLE_INT_BIT, ANGLE_FRA_BIT)
#define F_50               0x00003200     /* 50 in 7.8 format */

typedef enum
{
	BVDC_P_Cms_ColorBar_eGreen = 0,
	BVDC_P_Cms_ColorBar_eYellow,
	BVDC_P_Cms_ColorBar_eRed,
	BVDC_P_Cms_ColorBar_eMagnenta,
	BVDC_P_Cms_ColorBar_eBlue,
	BVDC_P_Cms_ColorBar_eCyan
} BVDC_P_Cms_ColorBar;


/* (21+1).10 format */
static const int32_t SIN_LUT[] =
{
 0xFFFFFD2C,0xFFFFFD44,0xFFFFFD5E,0xFFFFFD7A,0xFFFFFD9A,0xFFFFFDBC,0xFFFFFDE1,0xFFFFFE0A,
 0xFFFFFE36,0xFFFFFE66,0xFFFFFE98,0xFFFFFECF,0xFFFFFF08,0xFFFFFF43,0xFFFFFF81,0xFFFFFFC0,
 0x00000000,0x00000040,0x0000007F,0x000000BD,0x000000F8,0x00000131,0x00000168,0x0000019A,
 0x000001CA,0x000001F6,0x0000021F,0x00000244,0x00000266,0x00000286,0x000002A2,0x000002BC,
 0xFFFFFD15,0xFFFFFD2C,0xFFFFFD45,0xFFFFFD61,0xFFFFFD80,0xFFFFFDA2,0xFFFFFDC8,0xFFFFFDF1,
 0xFFFFFE1E,0xFFFFFE4F,0xFFFFFE84,0xFFFFFEBC,0xFFFFFEF8,0xFFFFFF37,0xFFFFFF79,0xFFFFFFBC,
 0x00000000,0x00000044,0x00000087,0x000000C9,0x00000108,0x00000144,0x0000017C,0x000001B1,
 0x000001E2,0x0000020F,0x00000238,0x0000025E,0x00000280,0x0000029F,0x000002BB,0x000002D4,
 0xFFFFFCFD,0xFFFFFD13,0xFFFFFD2C,0xFFFFFD47,0xFFFFFD66,0xFFFFFD87,0xFFFFFDAD,0xFFFFFDD6,
 0xFFFFFE04,0xFFFFFE36,0xFFFFFE6D,0xFFFFFEA8,0xFFFFFEE7,0xFFFFFF29,0xFFFFFF6F,0xFFFFFFB7,
 0x00000000,0x00000049,0x00000091,0x000000D7,0x00000119,0x00000158,0x00000193,0x000001CA,
 0x000001FC,0x0000022A,0x00000253,0x00000279,0x0000029A,0x000002B9,0x000002D4,0x000002ED,
 0xFFFFFCE5,0xFFFFFCFA,0xFFFFFD12,0xFFFFFD2C,0xFFFFFD49,0xFFFFFD6B,0xFFFFFD90,0xFFFFFDB9,
 0xFFFFFDE7,0xFFFFFE1B,0xFFFFFE53,0xFFFFFE90,0xFFFFFED3,0xFFFFFF1A,0xFFFFFF64,0xFFFFFFB1,
 0x00000000,0x0000004F,0x0000009C,0x000000E6,0x0000012D,0x00000170,0x000001AD,0x000001E5,
 0x00000219,0x00000247,0x00000270,0x00000295,0x000002B7,0x000002D4,0x000002EE,0x00000306,
 0xFFFFFCCD,0xFFFFFCE0,0xFFFFFCF7,0xFFFFFD10,0xFFFFFD2C,0xFFFFFD4C,0xFFFFFD70,0xFFFFFD9A,
 0xFFFFFDC8,0xFFFFFDFC,0xFFFFFE36,0xFFFFFE76,0xFFFFFEBC,0xFFFFFF08,0xFFFFFF58,0xFFFFFFAB,
 0x00000000,0x00000055,0x000000A8,0x000000F8,0x00000144,0x0000018A,0x000001CA,0x00000204,
 0x00000238,0x00000266,0x00000290,0x000002B4,0x000002D4,0x000002F0,0x00000309,0x00000320,
 0xFFFFFCB4,0xFFFFFCC6,0xFFFFFCDB,0xFFFFFCF2,0xFFFFFD0D,0xFFFFFD2C,0xFFFFFD4F,0xFFFFFD78,
 0xFFFFFDA6,0xFFFFFDDA,0xFFFFFE16,0xFFFFFE58,0xFFFFFEA2,0xFFFFFEF3,0xFFFFFF49,0xFFFFFFA3,
 0x00000000,0x0000005D,0x000000B7,0x0000010D,0x0000015E,0x000001A8,0x000001EA,0x00000226,
 0x0000025A,0x00000288,0x000002B1,0x000002D4,0x000002F3,0x0000030E,0x00000325,0x0000033A,
 0xFFFFFC9C,0xFFFFFCAC,0xFFFFFCBF,0xFFFFFCD4,0xFFFFFCED,0xFFFFFD0A,0xFFFFFD2C,0xFFFFFD53,
 0xFFFFFD80,0xFFFFFDB5,0xFFFFFDF1,0xFFFFFE36,0xFFFFFE84,0xFFFFFEDA,0xFFFFFF37,0xFFFFFF9A,
 0x00000000,0x00000066,0x000000C9,0x00000126,0x0000017C,0x000001CA,0x0000020F,0x0000024B,
 0x00000280,0x000002AD,0x000002D4,0x000002F6,0x00000313,0x0000032C,0x00000341,0x00000354,
 0xFFFFFC84,0xFFFFFC92,0xFFFFFCA3,0xFFFFFCB6,0xFFFFFCCD,0xFFFFFCE7,0xFFFFFD07,0xFFFFFD2C,
 0xFFFFFD58,0xFFFFFD8B,0xFFFFFDC8,0xFFFFFE0F,0xFFFFFE60,0xFFFFFEBC,0xFFFFFF22,0xFFFFFF8F,
 0x00000000,0x00000071,0x000000DE,0x00000144,0x000001A0,0x000001F1,0x00000238,0x00000275,
 0x000002A8,0x000002D4,0x000002F9,0x00000319,0x00000333,0x0000034A,0x0000035D,0x0000036E,
 0xFFFFFC6C,0xFFFFFC78,0xFFFFFC87,0xFFFFFC98,0xFFFFFCAC,0xFFFFFCC4,0xFFFFFCE0,0xFFFFFD03,
 0xFFFFFD2C,0xFFFFFD5E,0xFFFFFD9A,0xFFFFFDE1,0xFFFFFE36,0xFFFFFE98,0xFFFFFF08,0xFFFFFF81,
 0x00000000,0x0000007F,0x000000F8,0x00000168,0x000001CA,0x0000021F,0x00000266,0x000002A2,
 0x000002D4,0x000002FD,0x00000320,0x0000033C,0x00000354,0x00000368,0x00000379,0x00000388,
 0xFFFFFC56,0xFFFFFC60,0xFFFFFC6C,0xFFFFFC7A,0xFFFFFC8B,0xFFFFFCA0,0xFFFFFCB9,0xFFFFFCD8,
 0xFFFFFCFD,0xFFFFFD2C,0xFFFFFD66,0xFFFFFDAD,0xFFFFFE04,0xFFFFFE6D,0xFFFFFEE7,0xFFFFFF6F,
 0x00000000,0x00000091,0x00000119,0x00000193,0x000001FC,0x00000253,0x0000029A,0x000002D4,
 0x00000303,0x00000328,0x00000347,0x00000360,0x00000375,0x00000386,0x00000394,0x000003A0,
 0xFFFFFC41,0xFFFFFC49,0xFFFFFC53,0xFFFFFC5E,0xFFFFFC6C,0xFFFFFC7D,0xFFFFFC92,0xFFFFFCAC,
 0xFFFFFCCD,0xFFFFFCF7,0xFFFFFD2C,0xFFFFFD70,0xFFFFFDC8,0xFFFFFE36,0xFFFFFEBC,0xFFFFFF58,
 0x00000000,0x000000A8,0x00000144,0x000001CA,0x00000238,0x00000290,0x000002D4,0x00000309,
 0x00000333,0x00000354,0x0000036E,0x00000383,0x00000394,0x000003A2,0x000003AD,0x000003B7,
 0xFFFFFC2F,0xFFFFFC35,0xFFFFFC3C,0xFFFFFC44,0xFFFFFC4F,0xFFFFFC5C,0xFFFFFC6C,0xFFFFFC81,
 0xFFFFFC9C,0xFFFFFCBF,0xFFFFFCED,0xFFFFFD2C,0xFFFFFD80,0xFFFFFDF1,0xFFFFFE84,0xFFFFFF37,
 0x00000000,0x000000C9,0x0000017C,0x0000020F,0x00000280,0x000002D4,0x00000313,0x00000341,
 0x00000364,0x0000037F,0x00000394,0x000003A4,0x000003B1,0x000003BC,0x000003C4,0x000003CB,
 0xFFFFFC1F,0xFFFFFC23,0xFFFFFC27,0xFFFFFC2D,0xFFFFFC35,0xFFFFFC3E,0xFFFFFC49,0xFFFFFC58,
 0xFFFFFC6C,0xFFFFFC87,0xFFFFFCAC,0xFFFFFCE0,0xFFFFFD2C,0xFFFFFD9A,0xFFFFFE36,0xFFFFFF08,
 0x00000000,0x000000F8,0x000001CA,0x00000266,0x000002D4,0x00000320,0x00000354,0x00000379,
 0x00000394,0x000003A8,0x000003B7,0x000003C2,0x000003CB,0x000003D3,0x000003D9,0x000003DD,
 0xFFFFFC12,0xFFFFFC14,0xFFFFFC17,0xFFFFFC1A,0xFFFFFC1F,0xFFFFFC24,0xFFFFFC2B,0xFFFFFC35,
 0xFFFFFC41,0xFFFFFC53,0xFFFFFC6C,0xFFFFFC92,0xFFFFFCCD,0xFFFFFD2C,0xFFFFFDC8,0xFFFFFEBC,
 0x00000000,0x00000144,0x00000238,0x000002D4,0x00000333,0x0000036E,0x00000394,0x000003AD,
 0x000003BF,0x000003CB,0x000003D5,0x000003DC,0x000003E1,0x000003E6,0x000003E9,0x000003EC,
 0xFFFFFC08,0xFFFFFC09,0xFFFFFC0A,0xFFFFFC0C,0xFFFFFC0E,0xFFFFFC11,0xFFFFFC14,0xFFFFFC18,
 0xFFFFFC1F,0xFFFFFC27,0xFFFFFC35,0xFFFFFC49,0xFFFFFC6C,0xFFFFFCAC,0xFFFFFD2C,0xFFFFFE36,
 0x00000000,0x000001CA,0x000002D4,0x00000354,0x00000394,0x000003B7,0x000003CB,0x000003D9,
 0x000003E1,0x000003E8,0x000003EC,0x000003EF,0x000003F2,0x000003F4,0x000003F6,0x000003F7,
 0xFFFFFC02,0xFFFFFC02,0xFFFFFC03,0xFFFFFC03,0xFFFFFC04,0xFFFFFC04,0xFFFFFC05,0xFFFFFC06,
 0xFFFFFC08,0xFFFFFC0A,0xFFFFFC0E,0xFFFFFC14,0xFFFFFC1F,0xFFFFFC35,0xFFFFFC6C,0xFFFFFD2C,
 0x00000000,0x000002D4,0x00000394,0x000003CB,0x000003E1,0x000003EC,0x000003F2,0x000003F6,
 0x000003F8,0x000003FA,0x000003FB,0x000003FC,0x000003FC,0x000003FD,0x000003FD,0x000003FE,
 0xFFFFFC00,0xFFFFFC00,0xFFFFFC00,0xFFFFFC00,0xFFFFFC00,0xFFFFFC00,0xFFFFFC00,0xFFFFFC00,
 0xFFFFFC00,0xFFFFFC00,0xFFFFFC00,0xFFFFFC00,0xFFFFFC00,0xFFFFFC00,0xFFFFFC00,0xFFFFFC00,
 0x00000000,0x00000400,0x00000400,0x00000400,0x00000400,0x00000400,0x00000400,0x00000400,
 0x00000400,0x00000400,0x00000400,0x00000400,0x00000400,0x00000400,0x00000400,0x00000400,
 0xFFFFFC02,0xFFFFFC02,0xFFFFFC03,0xFFFFFC03,0xFFFFFC04,0xFFFFFC04,0xFFFFFC05,0xFFFFFC06,
 0xFFFFFC08,0xFFFFFC0A,0xFFFFFC0E,0xFFFFFC14,0xFFFFFC1F,0xFFFFFC35,0xFFFFFC6C,0xFFFFFD2C,
 0x00000000,0x000002D4,0x00000394,0x000003CB,0x000003E1,0x000003EC,0x000003F2,0x000003F6,
 0x000003F8,0x000003FA,0x000003FB,0x000003FC,0x000003FC,0x000003FD,0x000003FD,0x000003FE,
 0xFFFFFC08,0xFFFFFC09,0xFFFFFC0A,0xFFFFFC0C,0xFFFFFC0E,0xFFFFFC11,0xFFFFFC14,0xFFFFFC18,
 0xFFFFFC1F,0xFFFFFC27,0xFFFFFC35,0xFFFFFC49,0xFFFFFC6C,0xFFFFFCAC,0xFFFFFD2C,0xFFFFFE36,
 0x00000000,0x000001CA,0x000002D4,0x00000354,0x00000394,0x000003B7,0x000003CB,0x000003D9,
 0x000003E1,0x000003E8,0x000003EC,0x000003EF,0x000003F2,0x000003F4,0x000003F6,0x000003F7,
 0xFFFFFC12,0xFFFFFC14,0xFFFFFC17,0xFFFFFC1A,0xFFFFFC1F,0xFFFFFC24,0xFFFFFC2B,0xFFFFFC35,
 0xFFFFFC41,0xFFFFFC53,0xFFFFFC6C,0xFFFFFC92,0xFFFFFCCD,0xFFFFFD2C,0xFFFFFDC8,0xFFFFFEBC,
 0x00000000,0x00000144,0x00000238,0x000002D4,0x00000333,0x0000036E,0x00000394,0x000003AD,
 0x000003BF,0x000003CB,0x000003D5,0x000003DC,0x000003E1,0x000003E6,0x000003E9,0x000003EC,
 0xFFFFFC1F,0xFFFFFC23,0xFFFFFC27,0xFFFFFC2D,0xFFFFFC35,0xFFFFFC3E,0xFFFFFC49,0xFFFFFC58,
 0xFFFFFC6C,0xFFFFFC87,0xFFFFFCAC,0xFFFFFCE0,0xFFFFFD2C,0xFFFFFD9A,0xFFFFFE36,0xFFFFFF08,
 0x00000000,0x000000F8,0x000001CA,0x00000266,0x000002D4,0x00000320,0x00000354,0x00000379,
 0x00000394,0x000003A8,0x000003B7,0x000003C2,0x000003CB,0x000003D3,0x000003D9,0x000003DD,
 0xFFFFFC2F,0xFFFFFC35,0xFFFFFC3C,0xFFFFFC44,0xFFFFFC4F,0xFFFFFC5C,0xFFFFFC6C,0xFFFFFC81,
 0xFFFFFC9C,0xFFFFFCBF,0xFFFFFCED,0xFFFFFD2C,0xFFFFFD80,0xFFFFFDF1,0xFFFFFE84,0xFFFFFF37,
 0x00000000,0x000000C9,0x0000017C,0x0000020F,0x00000280,0x000002D4,0x00000313,0x00000341,
 0x00000364,0x0000037F,0x00000394,0x000003A4,0x000003B1,0x000003BC,0x000003C4,0x000003CB,
 0xFFFFFC41,0xFFFFFC49,0xFFFFFC53,0xFFFFFC5E,0xFFFFFC6C,0xFFFFFC7D,0xFFFFFC92,0xFFFFFCAC,
 0xFFFFFCCD,0xFFFFFCF7,0xFFFFFD2C,0xFFFFFD70,0xFFFFFDC8,0xFFFFFE36,0xFFFFFEBC,0xFFFFFF58,
 0x00000000,0x000000A8,0x00000144,0x000001CA,0x00000238,0x00000290,0x000002D4,0x00000309,
 0x00000333,0x00000354,0x0000036E,0x00000383,0x00000394,0x000003A2,0x000003AD,0x000003B7,
 0xFFFFFC56,0xFFFFFC60,0xFFFFFC6C,0xFFFFFC7A,0xFFFFFC8B,0xFFFFFCA0,0xFFFFFCB9,0xFFFFFCD8,
 0xFFFFFCFD,0xFFFFFD2C,0xFFFFFD66,0xFFFFFDAD,0xFFFFFE04,0xFFFFFE6D,0xFFFFFEE7,0xFFFFFF6F,
 0x00000000,0x00000091,0x00000119,0x00000193,0x000001FC,0x00000253,0x0000029A,0x000002D4,
 0x00000303,0x00000328,0x00000347,0x00000360,0x00000375,0x00000386,0x00000394,0x000003A0,
 0xFFFFFC6C,0xFFFFFC78,0xFFFFFC87,0xFFFFFC98,0xFFFFFCAC,0xFFFFFCC4,0xFFFFFCE0,0xFFFFFD03,
 0xFFFFFD2C,0xFFFFFD5E,0xFFFFFD9A,0xFFFFFDE1,0xFFFFFE36,0xFFFFFE98,0xFFFFFF08,0xFFFFFF81,
 0x00000000,0x0000007F,0x000000F8,0x00000168,0x000001CA,0x0000021F,0x00000266,0x000002A2,
 0x000002D4,0x000002FD,0x00000320,0x0000033C,0x00000354,0x00000368,0x00000379,0x00000388,
 0xFFFFFC84,0xFFFFFC92,0xFFFFFCA3,0xFFFFFCB6,0xFFFFFCCD,0xFFFFFCE7,0xFFFFFD07,0xFFFFFD2C,
 0xFFFFFD58,0xFFFFFD8B,0xFFFFFDC8,0xFFFFFE0F,0xFFFFFE60,0xFFFFFEBC,0xFFFFFF22,0xFFFFFF8F,
 0x00000000,0x00000071,0x000000DE,0x00000144,0x000001A0,0x000001F1,0x00000238,0x00000275,
 0x000002A8,0x000002D4,0x000002F9,0x00000319,0x00000333,0x0000034A,0x0000035D,0x0000036E,
 0xFFFFFC9C,0xFFFFFCAC,0xFFFFFCBF,0xFFFFFCD4,0xFFFFFCED,0xFFFFFD0A,0xFFFFFD2C,0xFFFFFD53,
 0xFFFFFD80,0xFFFFFDB5,0xFFFFFDF1,0xFFFFFE36,0xFFFFFE84,0xFFFFFEDA,0xFFFFFF37,0xFFFFFF9A,
 0x00000000,0x00000066,0x000000C9,0x00000126,0x0000017C,0x000001CA,0x0000020F,0x0000024B,
 0x00000280,0x000002AD,0x000002D4,0x000002F6,0x00000313,0x0000032C,0x00000341,0x00000354,
 0xFFFFFCB4,0xFFFFFCC6,0xFFFFFCDB,0xFFFFFCF2,0xFFFFFD0D,0xFFFFFD2C,0xFFFFFD4F,0xFFFFFD78,
 0xFFFFFDA6,0xFFFFFDDA,0xFFFFFE16,0xFFFFFE58,0xFFFFFEA2,0xFFFFFEF3,0xFFFFFF49,0xFFFFFFA3,
 0x00000000,0x0000005D,0x000000B7,0x0000010D,0x0000015E,0x000001A8,0x000001EA,0x00000226,
 0x0000025A,0x00000288,0x000002B1,0x000002D4,0x000002F3,0x0000030E,0x00000325,0x0000033A,
 0xFFFFFCCD,0xFFFFFCE0,0xFFFFFCF7,0xFFFFFD10,0xFFFFFD2C,0xFFFFFD4C,0xFFFFFD70,0xFFFFFD9A,
 0xFFFFFDC8,0xFFFFFDFC,0xFFFFFE36,0xFFFFFE76,0xFFFFFEBC,0xFFFFFF08,0xFFFFFF58,0xFFFFFFAB,
 0x00000000,0x00000055,0x000000A8,0x000000F8,0x00000144,0x0000018A,0x000001CA,0x00000204,
 0x00000238,0x00000266,0x00000290,0x000002B4,0x000002D4,0x000002F0,0x00000309,0x00000320,
 0xFFFFFCE5,0xFFFFFCFA,0xFFFFFD12,0xFFFFFD2C,0xFFFFFD49,0xFFFFFD6B,0xFFFFFD90,0xFFFFFDB9,
 0xFFFFFDE7,0xFFFFFE1B,0xFFFFFE53,0xFFFFFE90,0xFFFFFED3,0xFFFFFF1A,0xFFFFFF64,0xFFFFFFB1,
 0x00000000,0x0000004F,0x0000009C,0x000000E6,0x0000012D,0x00000170,0x000001AD,0x000001E5,
 0x00000219,0x00000247,0x00000270,0x00000295,0x000002B7,0x000002D4,0x000002EE,0x00000306,
 0xFFFFFCFD,0xFFFFFD13,0xFFFFFD2C,0xFFFFFD47,0xFFFFFD66,0xFFFFFD87,0xFFFFFDAD,0xFFFFFDD6,
 0xFFFFFE04,0xFFFFFE36,0xFFFFFE6D,0xFFFFFEA8,0xFFFFFEE7,0xFFFFFF29,0xFFFFFF6F,0xFFFFFFB7,
 0x00000000,0x00000049,0x00000091,0x000000D7,0x00000119,0x00000158,0x00000193,0x000001CA,
 0x000001FC,0x0000022A,0x00000253,0x00000279,0x0000029A,0x000002B9,0x000002D4,0x000002ED,
 0xFFFFFD15,0xFFFFFD2C,0xFFFFFD45,0xFFFFFD61,0xFFFFFD80,0xFFFFFDA2,0xFFFFFDC8,0xFFFFFDF1,
 0xFFFFFE1E,0xFFFFFE4F,0xFFFFFE84,0xFFFFFEBC,0xFFFFFEF8,0xFFFFFF37,0xFFFFFF79,0xFFFFFFBC,
 0x00000000,0x00000044,0x00000087,0x000000C9,0x00000108,0x00000144,0x0000017C,0x000001B1,
 0x000001E2,0x0000020F,0x00000238,0x0000025E,0x00000280,0x0000029F,0x000002BB,0x000002D4
};

/* (21+1).10 format */
static const int32_t COS_LUT[] =
{
 0xFFFFFD2C,0xFFFFFD15,0xFFFFFCFD,0xFFFFFCE5,0xFFFFFCCD,0xFFFFFCB4,0xFFFFFC9C,0xFFFFFC84,
 0xFFFFFC6C,0xFFFFFC56,0xFFFFFC41,0xFFFFFC2F,0xFFFFFC1F,0xFFFFFC12,0xFFFFFC08,0xFFFFFC02,
 0xFFFFFC00,0xFFFFFC02,0xFFFFFC08,0xFFFFFC12,0xFFFFFC1F,0xFFFFFC2F,0xFFFFFC41,0xFFFFFC56,
 0xFFFFFC6C,0xFFFFFC84,0xFFFFFC9C,0xFFFFFCB4,0xFFFFFCCD,0xFFFFFCE5,0xFFFFFCFD,0xFFFFFD15,
 0xFFFFFD44,0xFFFFFD2C,0xFFFFFD13,0xFFFFFCFA,0xFFFFFCE0,0xFFFFFCC6,0xFFFFFCAC,0xFFFFFC92,
 0xFFFFFC78,0xFFFFFC60,0xFFFFFC49,0xFFFFFC35,0xFFFFFC23,0xFFFFFC14,0xFFFFFC09,0xFFFFFC02,
 0xFFFFFC00,0xFFFFFC02,0xFFFFFC09,0xFFFFFC14,0xFFFFFC23,0xFFFFFC35,0xFFFFFC49,0xFFFFFC60,
 0xFFFFFC78,0xFFFFFC92,0xFFFFFCAC,0xFFFFFCC6,0xFFFFFCE0,0xFFFFFCFA,0xFFFFFD13,0xFFFFFD2C,
 0xFFFFFD5E,0xFFFFFD45,0xFFFFFD2C,0xFFFFFD12,0xFFFFFCF7,0xFFFFFCDB,0xFFFFFCBF,0xFFFFFCA3,
 0xFFFFFC87,0xFFFFFC6C,0xFFFFFC53,0xFFFFFC3C,0xFFFFFC27,0xFFFFFC17,0xFFFFFC0A,0xFFFFFC03,
 0xFFFFFC00,0xFFFFFC03,0xFFFFFC0A,0xFFFFFC17,0xFFFFFC27,0xFFFFFC3C,0xFFFFFC53,0xFFFFFC6C,
 0xFFFFFC87,0xFFFFFCA3,0xFFFFFCBF,0xFFFFFCDB,0xFFFFFCF7,0xFFFFFD12,0xFFFFFD2C,0xFFFFFD45,
 0xFFFFFD7A,0xFFFFFD61,0xFFFFFD47,0xFFFFFD2C,0xFFFFFD10,0xFFFFFCF2,0xFFFFFCD4,0xFFFFFCB6,
 0xFFFFFC98,0xFFFFFC7A,0xFFFFFC5E,0xFFFFFC44,0xFFFFFC2D,0xFFFFFC1A,0xFFFFFC0C,0xFFFFFC03,
 0xFFFFFC00,0xFFFFFC03,0xFFFFFC0C,0xFFFFFC1A,0xFFFFFC2D,0xFFFFFC44,0xFFFFFC5E,0xFFFFFC7A,
 0xFFFFFC98,0xFFFFFCB6,0xFFFFFCD4,0xFFFFFCF2,0xFFFFFD10,0xFFFFFD2C,0xFFFFFD47,0xFFFFFD61,
 0xFFFFFD9A,0xFFFFFD80,0xFFFFFD66,0xFFFFFD49,0xFFFFFD2C,0xFFFFFD0D,0xFFFFFCED,0xFFFFFCCD,
 0xFFFFFCAC,0xFFFFFC8B,0xFFFFFC6C,0xFFFFFC4F,0xFFFFFC35,0xFFFFFC1F,0xFFFFFC0E,0xFFFFFC04,
 0xFFFFFC00,0xFFFFFC04,0xFFFFFC0E,0xFFFFFC1F,0xFFFFFC35,0xFFFFFC4F,0xFFFFFC6C,0xFFFFFC8B,
 0xFFFFFCAC,0xFFFFFCCD,0xFFFFFCED,0xFFFFFD0D,0xFFFFFD2C,0xFFFFFD49,0xFFFFFD66,0xFFFFFD80,
 0xFFFFFDBC,0xFFFFFDA2,0xFFFFFD87,0xFFFFFD6B,0xFFFFFD4C,0xFFFFFD2C,0xFFFFFD0A,0xFFFFFCE7,
 0xFFFFFCC4,0xFFFFFCA0,0xFFFFFC7D,0xFFFFFC5C,0xFFFFFC3E,0xFFFFFC24,0xFFFFFC11,0xFFFFFC04,
 0xFFFFFC00,0xFFFFFC04,0xFFFFFC11,0xFFFFFC24,0xFFFFFC3E,0xFFFFFC5C,0xFFFFFC7D,0xFFFFFCA0,
 0xFFFFFCC4,0xFFFFFCE7,0xFFFFFD0A,0xFFFFFD2C,0xFFFFFD4C,0xFFFFFD6B,0xFFFFFD87,0xFFFFFDA2,
 0xFFFFFDE1,0xFFFFFDC8,0xFFFFFDAD,0xFFFFFD90,0xFFFFFD70,0xFFFFFD4F,0xFFFFFD2C,0xFFFFFD07,
 0xFFFFFCE0,0xFFFFFCB9,0xFFFFFC92,0xFFFFFC6C,0xFFFFFC49,0xFFFFFC2B,0xFFFFFC14,0xFFFFFC05,
 0xFFFFFC00,0xFFFFFC05,0xFFFFFC14,0xFFFFFC2B,0xFFFFFC49,0xFFFFFC6C,0xFFFFFC92,0xFFFFFCB9,
 0xFFFFFCE0,0xFFFFFD07,0xFFFFFD2C,0xFFFFFD4F,0xFFFFFD70,0xFFFFFD90,0xFFFFFDAD,0xFFFFFDC8,
 0xFFFFFE0A,0xFFFFFDF1,0xFFFFFDD6,0xFFFFFDB9,0xFFFFFD9A,0xFFFFFD78,0xFFFFFD53,0xFFFFFD2C,
 0xFFFFFD03,0xFFFFFCD8,0xFFFFFCAC,0xFFFFFC81,0xFFFFFC58,0xFFFFFC35,0xFFFFFC18,0xFFFFFC06,
 0xFFFFFC00,0xFFFFFC06,0xFFFFFC18,0xFFFFFC35,0xFFFFFC58,0xFFFFFC81,0xFFFFFCAC,0xFFFFFCD8,
 0xFFFFFD03,0xFFFFFD2C,0xFFFFFD53,0xFFFFFD78,0xFFFFFD9A,0xFFFFFDB9,0xFFFFFDD6,0xFFFFFDF1,
 0xFFFFFE36,0xFFFFFE1E,0xFFFFFE04,0xFFFFFDE7,0xFFFFFDC8,0xFFFFFDA6,0xFFFFFD80,0xFFFFFD58,
 0xFFFFFD2C,0xFFFFFCFD,0xFFFFFCCD,0xFFFFFC9C,0xFFFFFC6C,0xFFFFFC41,0xFFFFFC1F,0xFFFFFC08,
 0xFFFFFC00,0xFFFFFC08,0xFFFFFC1F,0xFFFFFC41,0xFFFFFC6C,0xFFFFFC9C,0xFFFFFCCD,0xFFFFFCFD,
 0xFFFFFD2C,0xFFFFFD58,0xFFFFFD80,0xFFFFFDA6,0xFFFFFDC8,0xFFFFFDE7,0xFFFFFE04,0xFFFFFE1E,
 0xFFFFFE66,0xFFFFFE4F,0xFFFFFE36,0xFFFFFE1B,0xFFFFFDFC,0xFFFFFDDA,0xFFFFFDB5,0xFFFFFD8B,
 0xFFFFFD5E,0xFFFFFD2C,0xFFFFFCF7,0xFFFFFCBF,0xFFFFFC87,0xFFFFFC53,0xFFFFFC27,0xFFFFFC0A,
 0xFFFFFC00,0xFFFFFC0A,0xFFFFFC27,0xFFFFFC53,0xFFFFFC87,0xFFFFFCBF,0xFFFFFCF7,0xFFFFFD2C,
 0xFFFFFD5E,0xFFFFFD8B,0xFFFFFDB5,0xFFFFFDDA,0xFFFFFDFC,0xFFFFFE1B,0xFFFFFE36,0xFFFFFE4F,
 0xFFFFFE98,0xFFFFFE84,0xFFFFFE6D,0xFFFFFE53,0xFFFFFE36,0xFFFFFE16,0xFFFFFDF1,0xFFFFFDC8,
 0xFFFFFD9A,0xFFFFFD66,0xFFFFFD2C,0xFFFFFCED,0xFFFFFCAC,0xFFFFFC6C,0xFFFFFC35,0xFFFFFC0E,
 0xFFFFFC00,0xFFFFFC0E,0xFFFFFC35,0xFFFFFC6C,0xFFFFFCAC,0xFFFFFCED,0xFFFFFD2C,0xFFFFFD66,
 0xFFFFFD9A,0xFFFFFDC8,0xFFFFFDF1,0xFFFFFE16,0xFFFFFE36,0xFFFFFE53,0xFFFFFE6D,0xFFFFFE84,
 0xFFFFFECF,0xFFFFFEBC,0xFFFFFEA8,0xFFFFFE90,0xFFFFFE76,0xFFFFFE58,0xFFFFFE36,0xFFFFFE0F,
 0xFFFFFDE1,0xFFFFFDAD,0xFFFFFD70,0xFFFFFD2C,0xFFFFFCE0,0xFFFFFC92,0xFFFFFC49,0xFFFFFC14,
 0xFFFFFC00,0xFFFFFC14,0xFFFFFC49,0xFFFFFC92,0xFFFFFCE0,0xFFFFFD2C,0xFFFFFD70,0xFFFFFDAD,
 0xFFFFFDE1,0xFFFFFE0F,0xFFFFFE36,0xFFFFFE58,0xFFFFFE76,0xFFFFFE90,0xFFFFFEA8,0xFFFFFEBC,
 0xFFFFFF08,0xFFFFFEF8,0xFFFFFEE7,0xFFFFFED3,0xFFFFFEBC,0xFFFFFEA2,0xFFFFFE84,0xFFFFFE60,
 0xFFFFFE36,0xFFFFFE04,0xFFFFFDC8,0xFFFFFD80,0xFFFFFD2C,0xFFFFFCCD,0xFFFFFC6C,0xFFFFFC1F,
 0xFFFFFC00,0xFFFFFC1F,0xFFFFFC6C,0xFFFFFCCD,0xFFFFFD2C,0xFFFFFD80,0xFFFFFDC8,0xFFFFFE04,
 0xFFFFFE36,0xFFFFFE60,0xFFFFFE84,0xFFFFFEA2,0xFFFFFEBC,0xFFFFFED3,0xFFFFFEE7,0xFFFFFEF8,
 0xFFFFFF43,0xFFFFFF37,0xFFFFFF29,0xFFFFFF1A,0xFFFFFF08,0xFFFFFEF3,0xFFFFFEDA,0xFFFFFEBC,
 0xFFFFFE98,0xFFFFFE6D,0xFFFFFE36,0xFFFFFDF1,0xFFFFFD9A,0xFFFFFD2C,0xFFFFFCAC,0xFFFFFC35,
 0xFFFFFC00,0xFFFFFC35,0xFFFFFCAC,0xFFFFFD2C,0xFFFFFD9A,0xFFFFFDF1,0xFFFFFE36,0xFFFFFE6D,
 0xFFFFFE98,0xFFFFFEBC,0xFFFFFEDA,0xFFFFFEF3,0xFFFFFF08,0xFFFFFF1A,0xFFFFFF29,0xFFFFFF37,
 0xFFFFFF81,0xFFFFFF79,0xFFFFFF6F,0xFFFFFF64,0xFFFFFF58,0xFFFFFF49,0xFFFFFF37,0xFFFFFF22,
 0xFFFFFF08,0xFFFFFEE7,0xFFFFFEBC,0xFFFFFE84,0xFFFFFE36,0xFFFFFDC8,0xFFFFFD2C,0xFFFFFC6C,
 0xFFFFFC00,0xFFFFFC6C,0xFFFFFD2C,0xFFFFFDC8,0xFFFFFE36,0xFFFFFE84,0xFFFFFEBC,0xFFFFFEE7,
 0xFFFFFF08,0xFFFFFF22,0xFFFFFF37,0xFFFFFF49,0xFFFFFF58,0xFFFFFF64,0xFFFFFF6F,0xFFFFFF79,
 0xFFFFFFC0,0xFFFFFFBC,0xFFFFFFB7,0xFFFFFFB1,0xFFFFFFAB,0xFFFFFFA3,0xFFFFFF9A,0xFFFFFF8F,
 0xFFFFFF81,0xFFFFFF6F,0xFFFFFF58,0xFFFFFF37,0xFFFFFF08,0xFFFFFEBC,0xFFFFFE36,0xFFFFFD2C,
 0xFFFFFC00,0xFFFFFD2C,0xFFFFFE36,0xFFFFFEBC,0xFFFFFF08,0xFFFFFF37,0xFFFFFF58,0xFFFFFF6F,
 0xFFFFFF81,0xFFFFFF8F,0xFFFFFF9A,0xFFFFFFA3,0xFFFFFFAB,0xFFFFFFB1,0xFFFFFFB7,0xFFFFFFBC,
 0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
 0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
 0x00000400,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
 0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
 0x00000040,0x00000044,0x00000049,0x0000004F,0x00000055,0x0000005D,0x00000066,0x00000071,
 0x0000007F,0x00000091,0x000000A8,0x000000C9,0x000000F8,0x00000144,0x000001CA,0x000002D4,
 0x00000400,0x000002D4,0x000001CA,0x00000144,0x000000F8,0x000000C9,0x000000A8,0x00000091,
 0x0000007F,0x00000071,0x00000066,0x0000005D,0x00000055,0x0000004F,0x00000049,0x00000044,
 0x0000007F,0x00000087,0x00000091,0x0000009C,0x000000A8,0x000000B7,0x000000C9,0x000000DE,
 0x000000F8,0x00000119,0x00000144,0x0000017C,0x000001CA,0x00000238,0x000002D4,0x00000394,
 0x00000400,0x00000394,0x000002D4,0x00000238,0x000001CA,0x0000017C,0x00000144,0x00000119,
 0x000000F8,0x000000DE,0x000000C9,0x000000B7,0x000000A8,0x0000009C,0x00000091,0x00000087,
 0x000000BD,0x000000C9,0x000000D7,0x000000E6,0x000000F8,0x0000010D,0x00000126,0x00000144,
 0x00000168,0x00000193,0x000001CA,0x0000020F,0x00000266,0x000002D4,0x00000354,0x000003CB,
 0x00000400,0x000003CB,0x00000354,0x000002D4,0x00000266,0x0000020F,0x000001CA,0x00000193,
 0x00000168,0x00000144,0x00000126,0x0000010D,0x000000F8,0x000000E6,0x000000D7,0x000000C9,
 0x000000F8,0x00000108,0x00000119,0x0000012D,0x00000144,0x0000015E,0x0000017C,0x000001A0,
 0x000001CA,0x000001FC,0x00000238,0x00000280,0x000002D4,0x00000333,0x00000394,0x000003E1,
 0x00000400,0x000003E1,0x00000394,0x00000333,0x000002D4,0x00000280,0x00000238,0x000001FC,
 0x000001CA,0x000001A0,0x0000017C,0x0000015E,0x00000144,0x0000012D,0x00000119,0x00000108,
 0x00000131,0x00000144,0x00000158,0x00000170,0x0000018A,0x000001A8,0x000001CA,0x000001F1,
 0x0000021F,0x00000253,0x00000290,0x000002D4,0x00000320,0x0000036E,0x000003B7,0x000003EC,
 0x00000400,0x000003EC,0x000003B7,0x0000036E,0x00000320,0x000002D4,0x00000290,0x00000253,
 0x0000021F,0x000001F1,0x000001CA,0x000001A8,0x0000018A,0x00000170,0x00000158,0x00000144,
 0x00000168,0x0000017C,0x00000193,0x000001AD,0x000001CA,0x000001EA,0x0000020F,0x00000238,
 0x00000266,0x0000029A,0x000002D4,0x00000313,0x00000354,0x00000394,0x000003CB,0x000003F2,
 0x00000400,0x000003F2,0x000003CB,0x00000394,0x00000354,0x00000313,0x000002D4,0x0000029A,
 0x00000266,0x00000238,0x0000020F,0x000001EA,0x000001CA,0x000001AD,0x00000193,0x0000017C,
 0x0000019A,0x000001B1,0x000001CA,0x000001E5,0x00000204,0x00000226,0x0000024B,0x00000275,
 0x000002A2,0x000002D4,0x00000309,0x00000341,0x00000379,0x000003AD,0x000003D9,0x000003F6,
 0x00000400,0x000003F6,0x000003D9,0x000003AD,0x00000379,0x00000341,0x00000309,0x000002D4,
 0x000002A2,0x00000275,0x0000024B,0x00000226,0x00000204,0x000001E5,0x000001CA,0x000001B1,
 0x000001CA,0x000001E2,0x000001FC,0x00000219,0x00000238,0x0000025A,0x00000280,0x000002A8,
 0x000002D4,0x00000303,0x00000333,0x00000364,0x00000394,0x000003BF,0x000003E1,0x000003F8,
 0x00000400,0x000003F8,0x000003E1,0x000003BF,0x00000394,0x00000364,0x00000333,0x00000303,
 0x000002D4,0x000002A8,0x00000280,0x0000025A,0x00000238,0x00000219,0x000001FC,0x000001E2,
 0x000001F6,0x0000020F,0x0000022A,0x00000247,0x00000266,0x00000288,0x000002AD,0x000002D4,
 0x000002FD,0x00000328,0x00000354,0x0000037F,0x000003A8,0x000003CB,0x000003E8,0x000003FA,
 0x00000400,0x000003FA,0x000003E8,0x000003CB,0x000003A8,0x0000037F,0x00000354,0x00000328,
 0x000002FD,0x000002D4,0x000002AD,0x00000288,0x00000266,0x00000247,0x0000022A,0x0000020F,
 0x0000021F,0x00000238,0x00000253,0x00000270,0x00000290,0x000002B1,0x000002D4,0x000002F9,
 0x00000320,0x00000347,0x0000036E,0x00000394,0x000003B7,0x000003D5,0x000003EC,0x000003FB,
 0x00000400,0x000003FB,0x000003EC,0x000003D5,0x000003B7,0x00000394,0x0000036E,0x00000347,
 0x00000320,0x000002F9,0x000002D4,0x000002B1,0x00000290,0x00000270,0x00000253,0x00000238,
 0x00000244,0x0000025E,0x00000279,0x00000295,0x000002B4,0x000002D4,0x000002F6,0x00000319,
 0x0000033C,0x00000360,0x00000383,0x000003A4,0x000003C2,0x000003DC,0x000003EF,0x000003FC,
 0x00000400,0x000003FC,0x000003EF,0x000003DC,0x000003C2,0x000003A4,0x00000383,0x00000360,
 0x0000033C,0x00000319,0x000002F6,0x000002D4,0x000002B4,0x00000295,0x00000279,0x0000025E,
 0x00000266,0x00000280,0x0000029A,0x000002B7,0x000002D4,0x000002F3,0x00000313,0x00000333,
 0x00000354,0x00000375,0x00000394,0x000003B1,0x000003CB,0x000003E1,0x000003F2,0x000003FC,
 0x00000400,0x000003FC,0x000003F2,0x000003E1,0x000003CB,0x000003B1,0x00000394,0x00000375,
 0x00000354,0x00000333,0x00000313,0x000002F3,0x000002D4,0x000002B7,0x0000029A,0x00000280,
 0x00000286,0x0000029F,0x000002B9,0x000002D4,0x000002F0,0x0000030E,0x0000032C,0x0000034A,
 0x00000368,0x00000386,0x000003A2,0x000003BC,0x000003D3,0x000003E6,0x000003F4,0x000003FD,
 0x00000400,0x000003FD,0x000003F4,0x000003E6,0x000003D3,0x000003BC,0x000003A2,0x00000386,
 0x00000368,0x0000034A,0x0000032C,0x0000030E,0x000002F0,0x000002D4,0x000002B9,0x0000029F,
 0x000002A2,0x000002BB,0x000002D4,0x000002EE,0x00000309,0x00000325,0x00000341,0x0000035D,
 0x00000379,0x00000394,0x000003AD,0x000003C4,0x000003D9,0x000003E9,0x000003F6,0x000003FD,
 0x00000400,0x000003FD,0x000003F6,0x000003E9,0x000003D9,0x000003C4,0x000003AD,0x00000394,
 0x00000379,0x0000035D,0x00000341,0x00000325,0x00000309,0x000002EE,0x000002D4,0x000002BB,
 0x000002BC,0x000002D4,0x000002ED,0x00000306,0x00000320,0x0000033A,0x00000354,0x0000036E,
 0x00000388,0x000003A0,0x000003B7,0x000003CB,0x000003DD,0x000003EC,0x000003F7,0x000003FE,
 0x00000400,0x000003FE,0x000003F7,0x000003EC,0x000003DD,0x000003CB,0x000003B7,0x000003A0,
 0x00000388,0x0000036E,0x00000354,0x0000033A,0x00000320,0x00000306,0x000002ED,0x000002D4
};

static int32_t BMTH_FIX_SIGNED_DIV2(int32_t x, int32_t y, int32_t xint, int32_t xfract, int32_t yint, int32_t yfract, int32_t outint, int32_t outfract)
{
	int32_t t1 = (BMTH_FIX_SIGNED_CONVERT(x, xint, xfract, BMTH_P_FIX_SIGNED_MAX_BITS - (xfract), xfract) << (outfract - (xfract - yfract)));
	int32_t t2 = (BMTH_FIX_SIGNED_CONVERT(x, xint, xfract, BMTH_P_FIX_SIGNED_MAX_BITS - (xfract), xfract) >> ((xfract - yfract) - outfract));
	int32_t t3 = (outfract > ((xfract) - (yfract))) ? t1 : t2;
	int32_t t4 = BMTH_FIX_SIGNED_CONVERT(y, yint, yfract, BMTH_P_FIX_SIGNED_MAX_BITS - yfract, yfract);
	int32_t t5 = t3 / t4;
	BSTD_UNUSED(outint);
	return t5;
}

static int32_t BMTH_FIX_SIGNED_MUL2(int32_t x, int32_t y, int32_t xint, int32_t xfract, int32_t yint, int32_t yfract, int32_t outint, int32_t outfract)
{
	int32_t t1 = BMTH_FIX_SIGNED_CONVERT(x, xint, xfract, BMTH_P_FIX_SIGNED_MAX_BITS - (xfract), xfract);
	int32_t t2 = BMTH_FIX_SIGNED_CONVERT(y, yint, yfract, BMTH_P_FIX_SIGNED_MAX_BITS - (yfract), yfract);

	int32_t t3 = (outfract > ((xfract) + (yfract))) ?
	    (t1 * t2) << ((outfract) - ((xfract) + (yfract))) :
	    (int32_t)((t1 * t2) >> (((xfract) + (yfract)) - (outfract)) & BMTH_P_FIX_SIGNED_MASK(outint, outfract));
	return t3;
}


static void GainAccumulate
	( BVDC_P_PepContext         *pPep,
	  bool                       bIsHd,
	  int32_t                   *plCr,
	  int32_t                   *plCb )
{
	int32_t i, k;
	int32_t deltaCr, deltaCb;
	int32_t Cr_t, Cb_t;
	int32_t Cr_new, Cb_new;
	int32_t tempGain;
	int32_t ratio;
	bool    bClipped;
	const uint16_t *alSatGainRadial = NULL;
	const uint16_t *alSatGainAngle = NULL;

	for(k = 0; k < BVDC_P_PEP_CMS_COLOR_REGION_NUM; k++)
	{
		if(pPep->alSatGain[k] != 0)
		{
			BVDC_P_Pep_GetRadialTable(k, bIsHd, &alSatGainRadial);
			BVDC_P_Pep_GetAngleTable(k, bIsHd, &alSatGainAngle);

			/* update the pixelwise gain */
			for(i = 0; i < BVDC_P_CAB_TABLE_SIZE; i++)
			{
				if(alSatGainRadial[i] != 0 && alSatGainAngle[i] != 0)
				{
					tempGain = BMTH_FIX_SIGNED_MUL(alSatGainRadial[i], pPep->alSatGain[k], 5, 10, 23, 8, 23, 8);
					tempGain = BMTH_FIX_SIGNED_MUL(tempGain, alSatGainAngle[i], 23, 8, 5, 10, 23, 8);
					deltaCr = BMTH_FIX_SIGNED_MUL(tempGain, COS_LUT[i], 23, 8, 5, 10, 23, 8);
					deltaCb = BMTH_FIX_SIGNED_MUL(tempGain, SIN_LUT[i], 23, 8, 5, 10, 23, 8);
					*(plCr + i) = BMTH_FIX_SIGNED_CONVERT(*(plCr + i) + deltaCr, 8, 8, 23, 8);
					*(plCb + i) = BMTH_FIX_SIGNED_CONVERT(*(plCb + i) + deltaCb, 8, 8, 23, 8);
				}
			}
		}
	}

	/* convert it to the standard format, result is 10bits integer from 0~1023 */
	for(i = 0; i < BVDC_P_CAB_TABLE_SIZE; i++)
	{
		Cr_t = ((int32_t)(i / 32)) * 32;
		Cb_t = ((int32_t)(i % 32)) * 32;
		deltaCr = (int32_t)(*(plCr + i) / 256);
		deltaCb = (int32_t)(*(plCb + i) / 256);

		bClipped = false;
		if(i / 32 > 16)
		{
			Cr_new = BVDC_P_MIN(BVDC_P_MAX(Cr_t + deltaCr, 512), 1023);
			if(Cr_new != (Cr_t + deltaCr))
			{
				ratio =((Cr_new - Cr_t) << 11) / deltaCr;
				deltaCr = (ratio * deltaCr) >> 11;
				deltaCb = (ratio * deltaCb) >> 11;
				bClipped = true;
			}
			if(Cr_new < 0)
				Cr_new = 0;
		}
		else
		{
			Cr_new = BVDC_P_MIN(BVDC_P_MAX(Cr_t + deltaCr, 0), 512);
			if(Cr_new != (Cr_t + deltaCr))
			{
				ratio =((Cr_new - Cr_t) << 11) / deltaCr;
				deltaCr = (ratio * deltaCr) >> 11;
				deltaCb = (ratio * deltaCb) >> 11;
				bClipped = true;
			}
			if(Cr_new < 0)
				Cr_new =0;
		}

		if(i % 32 > 16)
		{
			Cb_new = BVDC_P_MIN(BVDC_P_MAX(Cb_t + deltaCb, 512), 1023);
			if(Cb_new != (Cb_t + deltaCb))
			{
				ratio =((Cb_new - Cb_t) << 11) / deltaCb;
				deltaCr = (ratio * deltaCr) >> 11;
				deltaCb = (ratio * deltaCb) >> 11;
				bClipped = true;
			}
			if(Cb_new < 0)
				Cb_new = 0;
		}
		else
		{
			Cb_new = BVDC_P_MIN(BVDC_P_MAX(Cb_t + deltaCb, 0), 512);
			if(Cb_new != (Cb_t + deltaCb))
			{
				ratio =((Cb_new - Cb_t) << 11) / deltaCb;
				deltaCr = (ratio * deltaCr) >> 11;
				deltaCb = (ratio * deltaCb) >> 11;
				bClipped = true;
			}
			if(Cb_new < 0)
				Cb_new =0;
		}

		if(bClipped)
		{
			if(i / 32 > 16)
			{
				Cr_new = BVDC_P_MIN(BVDC_P_MAX(Cr_t + deltaCr, 512), 1023);
				if(Cr_new < 0)
					Cr_new = 0;
			}
			else
			{
				Cr_new = BVDC_P_MIN(BVDC_P_MAX(Cr_t + deltaCr, 0), 512);
				if(Cr_new < 0)
					Cr_new = 0;
			}

			if(i % 32 > 16)
			{
				Cb_new = BVDC_P_MIN(BVDC_P_MAX(Cb_t + deltaCb, 512), 1023);
				if(Cb_new < 0)
					Cb_new = 0;
			}
			else
			{
				Cb_new = BVDC_P_MIN(BVDC_P_MAX(Cb_t + deltaCb, 0), 512);
				if (Cb_new < 0)
					Cb_new = 0;
			}
		}

		*(plCb + i) = Cb_new;
		*(plCr + i) = Cr_new;
	}
}


static void HueGainAccumulate
	( BVDC_P_PepContext         *pPep,
	  bool                       bIsHd,
	  int32_t                   *plCr,
	  int32_t                   *plCb )
{
	int32_t i, k;
	int32_t fCb, fCr;
	int32_t tempGain;
	int32_t sin_t, cos_t;
	int32_t nCb, nCr;
	int32_t Crtemp1, Crtemp2;
	int32_t Cbtemp1, Cbtemp2;
	const uint16_t *alHueGainAngle = NULL;

	for(i = 0; i < BVDC_P_CAB_TABLE_SIZE; i++)
	{
		pPep->tempCr[i] = *(plCr + i);
		pPep->tempCb[i] = *(plCb + i);
	}

	for(k = 0; k < BVDC_P_PEP_CMS_COLOR_REGION_NUM; k++)
	{
		if(pPep->alHueGain[k] != 0)
		{
			BVDC_P_Pep_GetHueAngleTable(k, bIsHd, &alHueGainAngle);

			/* update the pixelwise gain */
			for(i = 0; i < BVDC_P_CAB_TABLE_SIZE; i++)
			{
				if(alHueGainAngle[i] != 0)
				{
					tempGain = BMTH_FIX_SIGNED_MUL2(alHueGainAngle[i], pPep->alHueGain[k], 5, 10, 23, 8, 20, 11);
/*					sin_t = BVDC_P_WIN_FIX_SIN(tempGain);
					cos_t = BVDC_P_WIN_FIX_COS(tempGain);
*/					sin_t = BMTH_FIX_SIGNED_SIN(tempGain, 20, 11, 20, 11);
					cos_t = BMTH_FIX_SIGNED_COS(tempGain, 20, 11, 20, 11);
					fCb = *(plCb + i) - 512;
					fCr = *(plCr + i) - 512;

					/* according to the triangular formula */
					/* nCb = A * sin(a + delta_a) */
					/*     = A * sin(a) * cos(delta_a) + A * cos(a) * sin(delta_a) */
					/*     = fCb * cos(delta_a) + fCr * sin(delta_a) */
					/* nCr = A * cos(a + delta_a) */
					/*     = A * cos(a) * cos(delta_a) - A * sin(a) * sin(delta_a) */
					/*     = fCr * cos(delta_a) - fCb * sin(delta_a) */
					/* where nCb, nCr is the new Cb, Cr and */
					/* fCb, fCr are obtained from last step */
					Cbtemp1 = BMTH_FIX_SIGNED_MUL2(fCb, cos_t, 10, 5, 5, 11, 26, 5);
					Cbtemp2 = BMTH_FIX_SIGNED_MUL2(fCr, sin_t, 10, 5, 5, 11, 26, 5);
					nCb = Cbtemp1 + Cbtemp2;

					Crtemp1 = BMTH_FIX_SIGNED_MUL2(fCr, cos_t, 10, 5, 5, 11, 26, 5);
					Crtemp2 = BMTH_FIX_SIGNED_MUL2(fCb, sin_t, 10, 5, 5, 11, 26, 5);
					nCr = Crtemp1 - Crtemp2;

					pPep->tempCr[i] = nCr + 512;
					pPep->tempCb[i] = nCb + 512;
				}
			}
		}
	}

	/* convert it to the standard format, result is 10bits integer from 0~1023 */
	for(i = 0; i < BVDC_P_CAB_TABLE_SIZE; i++)
	{
		if(pPep->tempCr[i] > 1023)
			*(plCr + i) = 1023;
		else if(pPep->tempCr[i] < 0)
			*(plCr + i) = 0;
		else
			*(plCr + i) = pPep->tempCr[i];

		if(pPep->tempCb[i] > 1023)
			*(plCb + i) = 1023;
		else if(pPep->tempCb[i] < 0)
			*(plCb + i) = 0;
		else
			*(plCb + i) = pPep->tempCb[i];
	}
}


void BVDC_P_Pep_Cms
	( BVDC_P_PepContext           *pPep,
	  const BVDC_ColorBar         *pSatGain,
	  const BVDC_ColorBar         *pHueGain,
	  bool                         bIsHd,
	  uint32_t                    *pulCabTable )
{
	int32_t i;

	BDBG_ENTER(BVDC_P_Pep_Cms);

	pPep->alSatGain[BVDC_P_Cms_ColorBar_eGreen]    = pSatGain->lGreen;
	pPep->alSatGain[BVDC_P_Cms_ColorBar_eYellow]   = pSatGain->lYellow;
	pPep->alSatGain[BVDC_P_Cms_ColorBar_eRed]      = pSatGain->lRed;
	pPep->alSatGain[BVDC_P_Cms_ColorBar_eMagnenta] = pSatGain->lMagenta;
	pPep->alSatGain[BVDC_P_Cms_ColorBar_eBlue]     = pSatGain->lBlue;
	pPep->alSatGain[BVDC_P_Cms_ColorBar_eCyan]     = pSatGain->lCyan;
	pPep->alHueGain[BVDC_P_Cms_ColorBar_eGreen]    = pHueGain->lGreen;
	pPep->alHueGain[BVDC_P_Cms_ColorBar_eYellow]   = pHueGain->lYellow;
	pPep->alHueGain[BVDC_P_Cms_ColorBar_eRed]      = pHueGain->lRed;
	pPep->alHueGain[BVDC_P_Cms_ColorBar_eMagnenta] = pHueGain->lMagenta;
	pPep->alHueGain[BVDC_P_Cms_ColorBar_eBlue]     = pHueGain->lBlue;
	pPep->alHueGain[BVDC_P_Cms_ColorBar_eCyan]     = pHueGain->lCyan;

	BDBG_MSG(("Sat level: %4d %4d %4d %4d %4d %4d",
		pPep->alSatGain[0], pPep->alSatGain[1], pPep->alSatGain[2],
		pPep->alSatGain[3], pPep->alSatGain[4], pPep->alSatGain[5]));
	BDBG_MSG(("Hue level: %4d %4d %4d %4d %4d %4d",
		pPep->alHueGain[0], pPep->alHueGain[1], pPep->alHueGain[2],
		pPep->alHueGain[3], pPep->alHueGain[4], pPep->alHueGain[5]));
	BDBG_MSG(("isHdSd = %s", (bIsHd) ? "true" : "false"));

	/* Convert alSatGain and alHueGain to FIX POINT format used by the algo */
	for(i = 0; i < BVDC_P_PEP_CMS_COLOR_REGION_NUM; i++)
	{
		pPep->alSatGain[i] = BMTH_FIX_SIGNED_ITOFIX(pPep->alSatGain[i], 23, 8);

		pPep->alHueGain[i] = BMTH_FIX_SIGNED_ITOFIX(pPep->alHueGain[i], 23, 8);
		pPep->alHueGain[i] = BMTH_FIX_SIGNED_DIV2(pPep->alHueGain[i], F_50, 23, 8, 7, 8, 23, 8);
		pPep->alHueGain[i] = BMTH_FIX_SIGNED_MUL2(pPep->alHueGain[i], 0x00000086, 23, 8, 7, 8, 23, 8);
	}

	/* Init alCb[] and alCr[] */
	BKNI_Memset((int32_t *)&pPep->alCr[0], 0x0, BVDC_P_CAB_TABLE_SIZE*sizeof(int32_t));
	BKNI_Memset((int32_t *)&pPep->alCb[0], 0x0, BVDC_P_CAB_TABLE_SIZE*sizeof(int32_t));

	GainAccumulate(pPep, bIsHd, &pPep->alCr[0], &pPep->alCb[0]);
	HueGainAccumulate(pPep, bIsHd, &pPep->alCr[0], &pPep->alCb[0]);

	/* Combine alCr[] and alCb[] into pulCabTable[] */
	for(i = 0; i < BVDC_P_CAB_TABLE_SIZE; i++)
	{
		*(pulCabTable + i ) =
			BCHP_FIELD_DATA(PEP_CMP_0_V0_CAB_LUT_DATA_i, BYPASS, 0) |
			BCHP_FIELD_DATA(PEP_CMP_0_V0_CAB_LUT_DATA_i, CR_DATA, pPep->alCr[i]) |
			BCHP_FIELD_DATA(PEP_CMP_0_V0_CAB_LUT_DATA_i, CB_DATA, pPep->alCb[i]);

		/* printf("%d		%d		%d\n", i, alCr[i], alCb[i]); */
		/* BDBG_MSG(("CMS: CabTable[%d] = 0x%x", i, *(pulCabTable + i))); */
	}

	BDBG_LEAVE(BVDC_P_Pep_Cms);
	return;
}

#endif /* (BVDC_P_SUPPORT_PEP) */

/* End of File */
