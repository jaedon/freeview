#########################################################################
#     Copyright (c) 2003-2012, Broadcom Corporation
#     All Rights Reserved
#     Confidential Property of Broadcom Corporation
#
#  THIS SOFTWARE MAY ONLY BE USED SUBJECT TO AN EXECUTED SOFTWARE LICENSE
#  AGREEMENT  BETWEEN THE USER AND BROADCOM.  YOU HAVE NO RIGHT TO USE OR
#  EXPLOIT THIS MATERIAL EXCEPT SUBJECT TO THE TERMS OF SUCH AN AGREEMENT.
#
# $brcm_Workfile: mux_tests.cfg $
# $brcm_Revision: Hydra_Software_Devel/16 $
# $brcm_Date: 9/10/12 6:11p $
#
# [File Description:]
# Test Suite Configuration: Common Mux Tests
#
# Revision History:
#
# $brcm_Log: /rockford/unittests/syslib/muxlib/tests/mux_tests.cfg $
# 
# Hydra_Software_Devel/16   9/10/12 6:11p delkert
# SW7425-3912: Add argument to specify configuration file. Use platform
# from environment to select configuration file. Remove platform
# specific information from common config file
#
# Hydra_Software_Devel/15   7/3/12 8:50p delkert
# SW7425-3216: Temporary modifications to get system data test to run
#
# Hydra_Software_Devel/14   6/19/12 10:20a delkert
# SW7425-3256: Add B-frame testing to userdata tests. Add 60 and 75ms
# intervals to pcr tests to verify intervals > MSP
#
# Hydra_Software_Devel/13   6/13/12 11:43a delkert
# SW7425-3214: Fix up userdata test specifications to eliminate PIDs that
# don't contain data, and fix audio codec types.
#
# Hydra_Software_Devel/12   6/11/12 6:07p delkert
# SW7425-2567: Add source file existence verification to avoid segfaults
# in app and subsequent board reboots
#
# Hydra_Software_Devel/11   6/11/12 3:46p delkert
# SW7425-3214: Changed verification command to use common results
# directory argument
#
# Hydra_Software_Devel/10   6/8/12 10:46a delkert
# SW7425-2567: enhance userdata tests to also vary encode frame-rate.
# Expand range of PCR insertion intervals tested.
#
# Hydra_Software_Devel/9   5/9/12 3:47p delkert
# SW7425-2567: Make source paths explicit since userdata not rsync to
# /data/videos
#
# Hydra_Software_Devel/8   5/9/12 11:25a delkert
# SW7425-2567: Add all build options required for the tests
#
# Hydra_Software_Devel/7   5/4/12 4:25p delkert
# SW7425-2567: Add 'test_out_path' reserved keyword.  Fix up verification
# paths. Change 'server_command' to 'verify_command'
#
# Hydra_Software_Devel/6   5/4/12 12:03p delkert
# SW7425-2567: Fix up output filename from vdc_test.  Add additional
# userdata tests.
#
# Hydra_Software_Devel/5   5/3/12 5:48p delkert
# SW7425-2567: Add a "no clean" option. Simplify build command to be list
# of options (make is implied).  Explicitly clean nexus/bin for nexus
# apps. Copy perms when copying files
#
# Hydra_Software_Devel/4   4/25/12 6:13p delkert
# SW7425-2567: Change server_path to gen_path.
#
# Hydra_Software_Devel/3   4/23/12 10:27a delkert
# SW7425-2567: Add force to remove command.  Add timeout to transcode_ts
# command.
#
# Hydra_Software_Devel/2   4/18/12 2:58p delkert
# SW7425-2567: Improved error handling. Add support for multiline
# configuration values. Add target input file generation
#
# Hydra_Software_Devel/1   4/18/12 9:09a delkert
# SW7425-2567: Initial mux testing configuration file
#
#########################################################################
#
# Each block defines a test
# Each test block must have the "testname" key as the first entry
# => the testname key defines the start of a test
# Test parameters defined using "key : value" syntax
# Whitespace around the ":" separator is ignored. Only first separator significant
# (":" chars in the value field are literal)
# Blank lines can be used to separate tests, and are ignored
# Any lines beginning with # are ignored
#
# Reserved Keywords:
# - {server_path} is used to indicate the path of the NFS mount
#   to the server directory that is passed into the runner script
#   as an argument.  It can be used in any of the target commands, etc.
# - {view_path} is used to indicate the path of the clearcase view,
#   and is derived from the location of this file. It should only be
#   used in commands that refer to applications, or by server_command
# - {gen_path} is used to indicate the path of the generated
#   artifacts indicated by any generate commands. It is generally
#   only required when specifying generated inputs to the target_command
# - {test_out_path} is used to indicate the path of the output
#   directory for the test, for use in verification

# the following build options apply to all mux tests
build_opts      : BMUXLIB_TEST_MODE=y SUPPORT_VCE=y SUPPORT_MUX=y
#BHDM_CEC_SUPPORT=n HLS_PROTOCOL_SUPPORT=n LIVEMEDIA_SUPPORT=n LIVE_STREAMING_SUPPORT=y MEDIA_AVI_SUPPORT=y NETACCEL_SUPPORT=n NEXUS_POWER_MANAGEMENT=n NEXUS_POWER_STANDBY=n PLAYBACK_IP_SUPPORT=y VIDEO_ENCODER_SUPPORT=y BDSP_AC3_SUPPORT=y BDSP_DDP_SUPPORT=y BDSP_MS11_SUPPORT=y BDSP_MPEG_SUPPORT=y BDSP_WMA_SUPPORT=y BDSP_WMAPRO_SUPPORT=y BDSP_DSOLA_SUPPORT=y BDSP_LPCMDVD_SUPPORT=y BDSP_DRA_SUPPORT=y BDSP_AC3ENC_SUPPORT=y BDSP_MS10_SUPPORT=y BDSP_SRC_SUPPORT=y BDSP_AACSBR_SUPPORT=y BDSP_DTSENC_SUPPORT=y BDSP_DTSHD_SUPPORT=y BDSP_DTSBROADCAST_SUPPORT=y MEDIA_ASF_SUPPORT=y NEXUS_USE_7425_SV_BOARD=y

#########################################
test_name : TS_userdata
#########################################

app_name        : transcode_ts
app_path        : {view_path}/rockford/unittests/nexus/encoder

iterate         : group param_set
# Test each input with different encode frame rates to verify userdata timing
# Frame Rate:
# FIXME: need to add support for 10, 15 and 20Hz frame rates (transcode_ts will need to be updated)
# (1) 23.976
# (2) 24
# (3) 25
# (4) 29.97Hz
# (5) 30 Hz
# (6) 50 Hz
# (7) 59.94
# (8) 60
iterate         : frame_rate range(1,9)
# verify behaviour for all tests with and without b-frames
iterate         : bframes [0,2]

# FIXME: if desired, these could be augmented to test every program within each file
# that contains userdata.
group_start : param_set
infile          : USERDATATEST.TRP
# <str_type> <vid codec> <video_pid> <pcr_pid> <audio?> <audio_pid> <audio codec>
infile_data     : 2 2 49 49 1 52 7
# <pmt pid> <specify pids> <num pids>
userdata_ctrl   : 48 0 2
userdata_pids   : 55 56
duration        : 25
group_end   : param_set

group_start : param_set
infile          : TELETEXT_SAMPLE.TRP
infile_data     : 2 2 49 49 1 52 1
userdata_ctrl   : 48 0 3
userdata_pids   : 55 56 57
duration        : 25
group_end   : param_set

group_start : param_set
# NOTES: PID 2501 in this file has the PTS high-bit missing problem, and so this PID
# is not used.  Also, PID 2515 has no data in the source (even though its listed in
# the PMT).  So only PID 2514 can be tested.  This is from Program 11102
infile          : TS.111.GenAcceptTest.Teletext.Subtitles.mpg
infile_data     : 2 2 2301 2301 1 2311 1
userdata_ctrl   : 2300 0 1
userdata_pids   : 2514
duration        : 60
group_end   : param_set

group_start : param_set
infile          : TS.002.GenAcceptTest.DualMono.mpg
infile_data     : 2 2 301 301 1 310 1
userdata_ctrl   : 300 0 1
# NOTE: pids 501, 212, 214 and 216 are specified in the PMT,
# but pids 212, 214 and 216 contain no data. This is from Program 2001
userdata_pids   : 501
duration        : 60
group_end   : param_set

group_start : param_set
infile          : TS.009.GenAcceptTest.Teletext.VPS.Line.16.mpg
infile_data     : 2 2 2001 2001 1 2013 1
userdata_ctrl   : 2000 0 1
userdata_pids   : 2201
duration        : 50
group_end   : param_set

target_verify   : /data/muxlib/userdata/{infile}
target_requires : {app_name}

target_command  : ./nexus {app_name} -tsud < {target_input1}

# NOTE following is multiline to preserve the newline on the end
# (required for the 'q' (quit) to be recognized)
target_input1   : multiline
   0 /data/muxlib/userdata/{infile} {infile_data} {test_name}.ts 0 38 {frame_rate} 2000000 23 {bframes} 5 3 10 1 5 0 0 {userdata_ctrl} {userdata_pids} 0 100 {duration} q

target_produces : {test_name}.ts
target_produces : BMUXlib_INPUT_DESC_VIDEO_00_00.csv
target_produces : BMUXlib_TS_Userdata_00.csv

verify_command  : ./ts_verify.py -results={test_out_path} userdata /projects/bsema/muxlib/userdata/{infile} {test_name}.ts -vid BMUXlib_INPUT_DESC_VIDEO_00_00.csv -ud BMUXlib_TS_Userdata_00.csv {userdata_pids}

#########################################
test_name : TS_system_data_basic
#########################################
app_name        : vdc_test
app_path        : {view_path}/rockford/unittests/portinginterface/vdc

target_verify   : /data/videos/cnnticker.mpg
target_requires : {app_name}

target_command  : {app_name} < {target_input1}

# FIXME: can we make this a common variable, and then supply test-specific vars
# for substitution into the string, which then gets written into the input file
target_input1   : multiline
        custom c3 ovc 3 5 0 0 x1 m2 os 0 0 ow
        pb de /data/videos/cnnticker.mpg 0x21 0x21 0 1
        cf 11
        sleep
        inite
        sae 0 0
        oe
        oech 99 multi:0 end:0
        om 0 0 99
        cfgm 0 system_data_bitrate:2000000 end:0
        mux 0 1 enable_pat_pmt:0 pcr_pid:23 pcr_interval:100 end:0
        fm 0
        enc 107 end:0
        break 10
        xenc 0
        se
        fm 0
        xmux 0 0
        cm 0
        cech
        ce
        inite
        q

target_produces : encode_output_[00]_000.ts
target_produces : BMUXlib_INPUT_DESC_VIDEO_00_00.csv
#target_produces : BMUXlib_TS_SystemData_00.csv
#target_produces : BMUXlib_TS_SystemData_00.dat

verify_command  : ./ts_verify.py sysdata {test_out_path}/encode_output_[00]_000.ts 0x1000 50 0x1000

# system data tests required:
# vary system data bitrate
# vary system data insertion interval (0 - some maximum)
# system data contents is irrelevant (size/type)
# verify PAT/PMT?
# specify: data to insert, length of data, PID and interval.  If data is user-supplied (i.e. from file)
# then it must include the PID (data is pre-formatted as TS packets) and it must match the PID specified
# if data is generated, then PID must be specified
# system data must verify: correct insertion period based on settings. Need to verify behaviour when PCR
# present in the insertion interval (system data must shift)
# Test with system data of 1 packet, multiple packets, and with varying system data bit rates

#########################################
test_name : TS_pcr_test
#########################################

# 1ms tests the minimum possible PCR spacing
# 16, 27 and 45 test non-integral pcr spacing relative to mux service period (default is 50ms)
# 50ms verifies pcr insertion when this is once per sevice period
# 60, 75ms verify pcr insertion when this is more than the msp
# 100ms tests the maximum allowed PCR spacing per ISO/IEC-13818-1
# 120ms tests an out of spec PCR spacing (which is permitted by our code)
iterate         : pcr_interval [1, 10, 16, 27, 45, 50, 60, 75, 100, 120]
# If it works for one PID, it should work for all
pcr_pid         : 23

app_name        : vdc_test
app_path        : {view_path}/rockford/unittests/portinginterface/vdc

target_verify   : /data/videos/cnnticker.mpg
target_requires : {app_name}
target_command  : {app_name} < {target_input1}
target_produces : encode_output_[00]_000.ts

# NOTE: vdc_test only inserts PAT/PMT once at the start,
# so its not useful to enable PAT/PMT insertion
target_input1   : multiline
        custom c3 ovc 3 5 0 0 x1 m2 os 0 0 ow
        pb de /data/videos/cnnticker.mpg 0x21 0x21 0 1
        cf 11
        sleep
        inite
        sae 0 0
        oe
        oech 99 multi:0 end:0
        om 0 0 99
        cfgm 0 system_data_bitrate:2000000 end:0
        mux 0 1 enable_pat_pmt:0 pcr_pid:{pcr_pid} pcr_interval:{pcr_interval} end:0
        fm 0
        enc 107 end:0
        break 10
        xenc 0
        se
        fm 0
        xmux 0 0
        cm 0
        cech
        ce
        inite
        q

verify_command  : ./ts_verify.py pcr {test_out_path}/encode_output_[00]_000.ts {pcr_pid} {pcr_interval}

#########################################
#   END   Common Mux Tests
#########################################
